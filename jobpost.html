<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Openings - Dreamex DataLab HSE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                    },
                }
            }
        }
    </script>
    <style>
        html {
            scroll-behavior: smooth;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
        }
        
        .nav-link {
            position: relative;
        }
        
        .nav-link::after {
            content: "";
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -4px;
            left: 0;
            background-color: #0ea5e9;
            transition: width 0.3s;
        }
        
        .nav-link:hover::after {
            width: 100%;
        }
        
        .job-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .job-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .modal-overlay {
            backdrop-filter: blur(5px);
        }
        
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .back-to-top.visible {
            opacity: 1;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .upload-progress {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
        }

        .upload-progress.active {
            display: block !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2196f3, #21cbf3);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .upload-progress small {
            color: #1976d2;
            font-size: 0.8rem;
            margin: 0;
        }
        
        .pdf-processing {
            display: none;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            color: #1976d2;
            font-size: 0.85rem;
        }

        .pdf-processing.active {
            display: block;
        }

        .pdf-processing i {
            animation: spin 1s linear infinite;
        }

        .pdf-success {
            display: none;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 4px;
            color: #2e7d32;
            font-size: 0.85rem;
        }

        .pdf-success.active {
            display: block;
        }

        .pdf-error {
            display: none;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 4px;
            color: #c62828;
            font-size: 0.85rem;
        }

        .pdf-error.active {
            display: block;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- GitHub Pages Fix Script -->
    <script src="github-pages-fix.js"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <div class="text-primary-600 mr-3">
                        <i class="fas fa-chart-line text-3xl"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-primary-700">Dreamex DataLab</h1>
                </div>
                <nav class="hidden md:flex space-x-8 items-center">
                    <a href="index.html" class="nav-link text-gray-700 hover:text-primary-600 font-medium">Home</a>
                    <a href="index.html#features" class="nav-link text-gray-700 hover:text-primary-600 font-medium">Features</a>
                    <a href="pricing.html" class="nav-link text-gray-700 hover:text-primary-600 font-medium">Pricing</a>
                    <a href="index.html#about" class="nav-link text-gray-700 hover:text-primary-600 font-medium">About Us</a>
                    <a href="index.html#contact" class="nav-link text-gray-700 hover:text-primary-600 font-medium">Contact</a>
                    <div class="flex items-center">
                        <div id="userStatus" class="hidden items-center mr-4">
                            <i class="fas fa-user-circle text-primary-600 mr-2"></i>
                            <span id="username" class="text-gray-700 font-medium"></span>
                        </div>
                        <button id="loginButton" class="px-6 py-2 bg-primary-600 text-white font-medium rounded-full hover:bg-primary-700 transition duration-300">Login</button>
                        <button id="logoutButton" class="hidden px-6 py-2 bg-gray-600 text-white font-medium rounded-full hover:bg-gray-700 transition duration-300 ml-2">Logout</button>
                    </div>
                </nav>
                <button class="md:hidden text-gray-700">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="gradient-bg text-white py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <h2 class="text-4xl md:text-5xl font-bold mb-6">Current Job Openings</h2>
            <p class="text-xl md:text-2xl mb-8 text-blue-100">Join our team and be part of something great</p>
            
            <!-- Company Indicator (shown when user is logged in) -->
            <div class="company-indicator bg-white bg-opacity-10 backdrop-blur-md rounded-lg p-4 mb-6 hidden" id="companyIndicator">
                <div class="company-name text-white font-semibold text-lg mb-2" id="companyName">Your Company</div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- Filters Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="filter-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                    <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="departmentFilter">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Employment Type</label>
                    <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="employmentTypeFilter">
                        <option value="">All Employment Types</option>
                        <option value="full-time">Full Time</option>
                        <option value="part-time">Part Time</option>
                        <option value="contract">Contract</option>
                        <option value="casual">Casual</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                    <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500" id="sortBy">
                        <option value="date">Latest First</option>
                        <option value="urgency">Urgency</option>
                        <option value="title">Job Title</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Job Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="jobGrid">
            <!-- Jobs will be dynamically inserted here -->
        </div>

        <!-- Loading State -->
        <div class="text-center py-12" id="loadingState">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"></div>
            <p class="mt-4 text-gray-600">Loading job openings...</p>
        </div>

        <!-- Empty State -->
        <div class="text-center py-12" id="noJobs" style="display: none;">
            <i class="fas fa-briefcase text-6xl text-gray-400 mb-4"></i>
            <h3 class="text-2xl font-semibold text-gray-700 mb-2">No Job Openings</h3>
            <p class="text-gray-600">There are currently no job openings available. Please check back later.</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center mb-4">
                        <i class="fas fa-chart-line text-primary-500 text-2xl mr-2"></i>
                        <h3 class="text-xl font-bold">Dreamex DataLab</h3>
                    </div>
                    <p class="text-gray-400 mb-4">Comprehensive HSE management solutions for modern organizations.</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-primary-500 transition duration-300">
                            <i class="fab fa-linkedin text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary-500 transition duration-300">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="text-gray-400 hover:text-primary-500 transition duration-300">
                            <i class="fab fa-facebook text-xl"></i>
                        </a>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Solutions</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Risk Management</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Compliance Tracking</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Safety Analytics</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Training Management</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Resources</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Documentation</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Support Center</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Training Materials</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">API Reference</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Company</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">About Us</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Careers</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Privacy Policy</a></li>
                        <li><a href="#" class="hover:text-primary-500 transition duration-300">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2024 Dreamex DataLab. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Job Details Modal -->
    <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="jobModal" style="display: none;">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="modal-header p-6 border-b border-gray-200">
                <div class="flex justify-between items-start">
                    <h2 id="modalJobTitle" class="text-2xl font-bold text-gray-800">Job Title</h2>
                    <button class="modal-close text-gray-400 hover:text-gray-600 text-3xl leading-none" onclick="closeJobModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body p-6">
                <div class="grid grid-cols-1 gap-6">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-info-circle text-primary-600 mr-2"></i>
                            Job Information
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Position:</span>
                                <span id="modalPosition" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Department:</span>
                                <span id="modalDepartment" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Employment Type:</span>
                                <span id="modalEmploymentType" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Work Location:</span>
                                <span id="modalWorkLocation" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Urgency:</span>
                                <span id="modalUrgency" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span id="modalStatus" class="font-medium text-gray-800"></span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-dollar-sign text-primary-600 mr-2"></i>
                            Compensation
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Salary Range:</span>
                                <span id="modalSalary" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Benefits:</span>
                                <span id="modalBenefits" class="font-medium text-gray-800"></span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-clipboard-list text-primary-600 mr-2"></i>
                            Job Description
                        </h3>
                        <div id="modalDescription" class="text-gray-700 leading-relaxed"></div>
                    </div>

                    <div>
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-user-graduate text-primary-600 mr-2"></i>
                            Requirements
                        </h3>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-graduation-cap text-primary-600 mr-2"></i>
                                    Required Education
                                </h4>
                                <div id="modalRequiredEducation" class="text-gray-600 text-sm">Not specified</div>
                            </div>
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-briefcase text-primary-600 mr-2"></i>
                                    Required Experience
                                </h4>
                                <div id="modalRequiredExperience" class="text-gray-600 text-sm">Not specified</div>
                            </div>
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-tools text-primary-600 mr-2"></i>
                                    Required Skills
                                </h4>
                                <div id="modalRequiredSkills" class="text-gray-600 text-sm">Not specified</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-star text-primary-600 mr-2"></i>
                            Preferred Qualifications
                        </h3>
                        <div id="modalPreferredQualifications" class="text-gray-700 leading-relaxed"></div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-calendar-alt text-primary-600 mr-2"></i>
                            Timeline
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Posted:</span>
                                <span id="modalPostedDate" class="font-medium text-gray-800"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Advertising Closing Date:</span>
                                <span id="modalAdvertisingClosingDate" class="font-medium text-gray-800"></span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-users text-primary-600 mr-2"></i>
                            Team & Reporting
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Reports To:</span>
                                <span id="modalReportsTo" class="font-medium text-gray-800"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer p-6 border-t border-gray-200">
                <div class="flex justify-end">
                    <button class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200" onclick="closeJobModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Application Modal -->
    <div id="applicationModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="modal-header p-6 border-b border-gray-200">
                <div class="flex justify-between items-start">
                    <h2 id="applicationModalTitle" class="text-2xl font-bold text-gray-800">Apply for Position</h2>
                    <button class="modal-close text-gray-400 hover:text-gray-600 text-3xl leading-none" onclick="closeApplicationModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body p-6">
                <form id="applicationForm" enctype="multipart/form-data">
                    <!-- Personal Information Section -->
                    <div class="mb-8 bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-user text-primary-600 mr-2"></i>
                            Personal Information
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="applicantFirstName" class="block text-sm font-medium text-gray-700 mb-1">First Name *</label>
                                <input type="text" id="applicantFirstName" name="firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="applicantLastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name *</label>
                                <input type="text" id="applicantLastName" name="lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="applicantEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
                                <input type="email" id="applicantEmail" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="applicantPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
                                <input type="tel" id="applicantPhone" name="phone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="applicantAddress" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                                <textarea id="applicantAddress" name="address" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Professional Information Section -->
                    <div class="mb-8 bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-briefcase text-primary-600 mr-2"></i>
                            Professional Information
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="currentPosition" class="block text-sm font-medium text-gray-700 mb-1">Current Position</label>
                                <input type="text" id="currentPosition" name="currentPosition" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="currentCompany" class="block text-sm font-medium text-gray-700 mb-1">Current Company</label>
                                <input type="text" id="currentCompany" name="currentCompany" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="yearsExperience" class="block text-sm font-medium text-gray-700 mb-1">Years of Experience</label>
                                <select id="yearsExperience" name="yearsExperience" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select...</option>
                                    <option value="0-1">0-1 years</option>
                                    <option value="2-3">2-3 years</option>
                                    <option value="4-5">4-5 years</option>
                                    <option value="6-10">6-10 years</option>
                                    <option value="10+">10+ years</option>
                                </select>
                            </div>
                            <div>
                                <label for="expectedSalary" class="block text-sm font-medium text-gray-700 mb-1">Expected Salary</label>
                                <input type="number" id="expectedSalary" name="expectedSalary" placeholder="Enter amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="availabilityDate" class="block text-sm font-medium text-gray-700 mb-1">Available Start Date</label>
                                <input type="date" id="availabilityDate" name="availabilityDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                            </div>
                            <div>
                                <label for="noticePeriod" class="block text-sm font-medium text-gray-700 mb-1">Notice Period</label>
                                <select id="noticePeriod" name="noticePeriod" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                                    <option value="">Select...</option>
                                    <option value="immediate">Immediate</option>
                                    <option value="1-week">1 Week</option>
                                    <option value="2-weeks">2 Weeks</option>
                                    <option value="1-month">1 Month</option>
                                    <option value="2-months">2 Months</option>
                                    <option value="3-months">3 Months</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Document Upload Section -->
                    <div class="mb-8 bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-file-upload text-primary-600 mr-2"></i>
                            Documents
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="resumeFile" class="block text-sm font-medium text-gray-700 mb-1">Resume/CV *</label>
                                <input type="file" id="resumeFile" name="resume" accept=".pdf,.doc,.docx" required onchange="handleResumeUpload(this)" class="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-400 transition-colors">
                                <small class="text-gray-500 text-xs">Accepted formats: PDF, DOC, DOCX (Max 5MB)</small>
                                <div class="pdf-processing" id="resumeProcessing">
                                    <i class="fas fa-spinner"></i> Extracting text from PDF...
                                </div>
                                <div class="pdf-success" id="resumeSuccess">
                                    <i class="fas fa-check"></i> Text extracted successfully
                                </div>
                                <div class="pdf-error" id="resumeError">
                                    <i class="fas fa-exclamation-triangle"></i> Could not extract text from PDF
                                </div>
                                <div class="upload-progress" id="resumeUploadProgress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="resumeProgress"></div>
                                    </div>
                                    <small>Uploading to cloud storage...</small>
                                </div>
                            </div>
                            <div>
                                <label for="coverLetterFile" class="block text-sm font-medium text-gray-700 mb-1">Cover Letter</label>
                                <input type="file" id="coverLetterFile" name="coverLetter" accept=".pdf,.doc,.docx" onchange="handleCoverLetterUpload(this)" class="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-400 transition-colors">
                                <small class="text-gray-500 text-xs">Accepted formats: PDF, DOC, DOCX (Max 5MB)</small>
                                <div class="pdf-processing" id="coverLetterProcessing">
                                    <i class="fas fa-spinner"></i> Extracting text from PDF...
                                </div>
                                <div class="pdf-success" id="coverLetterSuccess">
                                    <i class="fas fa-check"></i> Text extracted successfully
                                </div>
                                <div class="pdf-error" id="coverLetterError">
                                    <i class="fas fa-exclamation-triangle"></i> Could not extract text from PDF
                                </div>
                                <div class="upload-progress" id="coverLetterUploadProgress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="cover_letterProgress"></div>
                                    </div>
                                    <small>Uploading to cloud storage...</small>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label for="portfolioFile" class="block text-sm font-medium text-gray-700 mb-1">Portfolio/Additional Documents</label>
                                <input type="file" id="portfolioFile" name="portfolio" accept=".pdf,.doc,.docx,.zip,.rar" multiple class="w-full px-3 py-2 border-2 border-dashed border-gray-300 rounded-lg hover:border-primary-400 transition-colors">
                                <small class="text-gray-500 text-xs">Accepted formats: PDF, DOC, DOCX, ZIP, RAR (Max 10MB each)</small>
                                <div class="upload-progress" id="portfolioUploadProgress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="portfolioProgress"></div>
                                    </div>
                                    <small>Uploading portfolio files to cloud storage...</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="mb-8 bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-comment text-primary-600 mr-2"></i>
                            Additional Information
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label for="whyInterested" class="block text-sm font-medium text-gray-700 mb-1">Why are you interested in this position?</label>
                                <textarea id="whyInterested" name="whyInterested" rows="4" placeholder="Tell us what attracts you to this role..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"></textarea>
                            </div>
                            <div>
                                <label for="additionalInfo" class="block text-sm font-medium text-gray-700 mb-1">Additional Comments</label>
                                <textarea id="additionalInfo" name="additionalInfo" rows="3" placeholder="Any additional information you'd like to share..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Consent and Agreement Section -->
                    <div class="mb-8 bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-shield-alt text-primary-600 mr-2"></i>
                            Consent & Agreement
                        </h3>
                        <div class="space-y-4">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="dataConsent" name="dataConsent" required class="mt-1">
                                <span class="text-sm text-gray-700">I consent to the processing of my personal data for recruitment purposes *</span>
                            </label>
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="termsAccept" name="termsAccept" required class="mt-1">
                                <span class="text-sm text-gray-700">I confirm that all information provided is accurate and complete *</span>
                            </label>
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="marketingConsent" name="marketingConsent" class="mt-1">
                                <span class="text-sm text-gray-700">I would like to receive updates about future job opportunities</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer p-6 border-t border-gray-200">
                <div class="flex justify-end gap-3">
                    <button type="button" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors duration-200 flex items-center gap-2" onclick="closeApplicationModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" id="submitApplicationBtn" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 flex items-center gap-2" onclick="submitApplication();">
                        <i class="fas fa-paper-plane"></i> Submit Application
                    </button>
                </div>
            </div>
        </div>
    </div>    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- Company Data Service -->
    <script type="module" src="js/company-data-service.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }        // Global variables
        let jobsData = [];
        const database = firebase.database();
        const storage = firebase.storage();
        
        // Global variables for extracted text
        let extractedResumeText = '';
        let extractedCoverLetterText = '';

        // Helper function to get company ID consistently
        function getCompanyId() {
            let companyId = null;
            
            // Check if user is authenticated
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                console.log('User is logged in:', currentUser.uid);
                
                // Try to get company ID from company data service first
                if (window.companyDataService && typeof window.companyDataService.getCurrentCompanyId === 'function') {
                    try {
                        companyId = window.companyDataService.getCurrentCompanyId();
                        console.log('Company ID from companyDataService:', companyId);
                    } catch (error) {
                        console.log('Error getting company ID from companyDataService:', error);
                    }
                }
                
                // Fallback to localStorage
                if (!companyId) {
                    try {
                        const storedUser = localStorage.getItem('currentUser');
                        if (storedUser) {
                            const userData = JSON.parse(storedUser);
                            if (userData.companyId) {
                                companyId = userData.companyId;
                                console.log('Company ID from localStorage:', companyId);
                            }
                        }
                    } catch (error) {
                        console.log('Error getting company ID from localStorage:', error);
                    }
                }
                
                // Final fallback to user's own company
                if (!companyId) {
                    companyId = currentUser.uid;
                    console.log('Using user ID as company ID:', companyId);
                }
            } else {
                // For public access (no user logged in), use specific company ID
                companyId = '-OUuYJ2TBZebiL0ciPq-';
                console.log('No user logged in, using default company ID:', companyId);
            }
            
            return companyId;
        }

        // Load jobs from Firebase Realtime Database in real-time
        function loadJobsRealTime() {
            try {
                // Show loading state
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('jobGrid').style.display = 'none';
                document.getElementById('noJobs').style.display = 'none';

                jobsData = [];

                // Function to process job data
                function processJobData(snapshot, isGlobal = false) {
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const job = childSnapshot.val();
                            console.log('Processing job:', childSnapshot.key, job, isGlobal ? '(global)' : '(company-scoped)');
                            
                            // Only include jobs that are published or active
                            if (job && (job.status === 'published' || job.status === 'active' || job.status === 'Published')) {
                                jobsData.push({
                                    id: childSnapshot.key,
                                    source: isGlobal ? 'global' : 'company',
                                    ...job
                                });
                                console.log('Job added to display:', childSnapshot.key, job.jobTitle || job.position);
                            } else {
                                console.log('Job skipped (not published):', childSnapshot.key, job?.status);
                            }
                        });
                    } else {
                        console.log('No jobs found in snapshot');
                    }
                }

                // Function to finalize job loading
                function finalizeJobLoading() {
                    console.log('Total jobs loaded:', jobsData.length);
                    
                    // Update page header based on authentication state
                    updatePageHeader(isUserLoggedIn, companyId);

                    // Update departments filter
                    updateDepartmentFilter();

                    // Sort and render jobs
                    sortAndFilterJobs();

                    // Hide loading, show content
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('jobGrid').style.display = 'grid';

                    if (jobsData.length === 0) {
                        document.getElementById('noJobs').style.display = 'block';
                        document.getElementById('jobGrid').style.display = 'none';
                    }
                }

                // Get company ID based on authentication state
                const companyId = getCompanyId();
                const isUserLoggedIn = firebase.auth().currentUser !== null;

                let loadedSources = 0;
                let totalSources = 1; // Start with company jobs as primary source

                // Load from company-scoped jobs first (primary source)
                const companyJobsRef = database.ref(`companies/${companyId}/jobs`);
                console.log('Loading jobs from company path:', `companies/${companyId}/jobs`);
                
                companyJobsRef.on('value', (snapshot) => {
                    console.log('Company jobs data received:', snapshot.exists());
                    processJobData(snapshot, false);
                    
                    loadedSources++;
                    if (loadedSources === totalSources) {
                        finalizeJobLoading();
                    }
                }, (error) => {
                    console.error('Error loading company jobs:', error);
                    loadedSources++;
                    if (loadedSources === totalSources) {
                        finalizeJobLoading();
                    }
                });

                // Note: Removed global jobs loading to focus only on company-scoped jobs
                // If you need global jobs as backup, they can be added back later

            } catch (error) {
                console.error('Error setting up real-time listener:', error);
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('noJobs').style.display = 'block';
            }
        }        // Update department filter options
        function updateDepartmentFilter() {
            const departments = [...new Set(jobsData
                .map(job => job.department)
                .filter(dept => dept && dept.trim() !== '')
            )];
            
            const departmentFilter = document.getElementById('departmentFilter');
            // Clear existing options except the first one
            departmentFilter.innerHTML = '<option value="">All Departments</option>';
            
            departments.sort().forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentFilter.appendChild(option);
            });
        }        // Sort and filter jobs based on current filters
        function sortAndFilterJobs() {
            const department = document.getElementById('departmentFilter').value;
            const employmentType = document.getElementById('employmentTypeFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filteredJobs = [...jobsData];

            // Apply filters
            if (department) {
                filteredJobs = filteredJobs.filter(job => job.department === department);
            }
            if (employmentType) {
                filteredJobs = filteredJobs.filter(job => 
                    job.employmentType && job.employmentType.toLowerCase().includes(employmentType)
                );
            }

            // Apply sorting
            filteredJobs.sort((a, b) => {
                switch (sortBy) {
                    case 'date':
                        const dateA = new Date(a.createdDate || a.publishedDate || 0);
                        const dateB = new Date(b.createdDate || b.publishedDate || 0);
                        return dateB - dateA;
                    case 'urgency':
                        const urgencyOrder = { high: 3, medium: 2, low: 1, critical: 4 };
                        const urgencyA = urgencyOrder[a.urgency?.toLowerCase()] || 1;
                        const urgencyB = urgencyOrder[b.urgency?.toLowerCase()] || 1;
                        return urgencyB - urgencyA;
                    case 'title':
                        const titleA = a.jobTitle || a.title || '';
                        const titleB = b.jobTitle || b.title || '';
                        return titleA.localeCompare(titleB);
                    default:
                        return 0;
                }
            });

            renderJobs(filteredJobs);
        }

        // Function to update page header based on authentication state
        function updatePageHeader(isLoggedIn, companyId) {
            const jobHeader = document.querySelector('.gradient-bg h2');
            const headerSubtitle = document.querySelector('.gradient-bg p');
            const companyIndicator = document.getElementById('companyIndicator');
            const companyNameElement = document.getElementById('companyName');
            
            if (isLoggedIn) {
                // Get company name from various sources
                let companyName = 'Your Company';
                
                // Try to get company name from localStorage
                try {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        const userData = JSON.parse(storedUser);
                        if (userData.companyName) {
                            companyName = userData.companyName;
                        }
                    }
                } catch (error) {
                    console.log('Error getting company name from localStorage:', error);
                }
                
                // Try to get company name from company data service
                if (window.companyDataService && typeof window.companyDataService.getCompanyName === 'function') {
                    try {
                        const serviceCompanyName = window.companyDataService.getCompanyName();
                        if (serviceCompanyName) {
                            companyName = serviceCompanyName;
                        }
                    } catch (error) {
                        console.log('Error getting company name from service:', error);
                    }
                }
                
                // Update header for logged-in user
                jobHeader.textContent = `${companyName} - Job Openings`;
                
                // Show company indicator
                companyIndicator.classList.remove('hidden');
                companyNameElement.textContent = companyName;
                
                console.log('Updated header for company:', companyName);
            } else {
                // Default header for public access
                jobHeader.textContent = 'Current Job Openings';
                headerSubtitle.textContent = 'Join our team and be part of something great';
                
                // Hide company indicator
                companyIndicator.classList.add('hidden');
                
                console.log('Using default public header');
            }
        }

        // Render jobs to the grid
        function renderJobs(jobs) {
            const jobGrid = document.getElementById('jobGrid');
            jobGrid.innerHTML = '';

            if (jobs.length === 0) {
                document.getElementById('noJobs').style.display = 'block';
                document.getElementById('jobGrid').style.display = 'none';
                return;
            }

            document.getElementById('noJobs').style.display = 'none';
            document.getElementById('jobGrid').style.display = 'grid';

            jobs.forEach(job => {
                const jobCard = document.createElement('div');
                jobCard.className = 'job-card bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-all duration-300';
                
                // Handle multiple possible field names for job data
                const jobTitle = job.jobTitle || job.title || 'Job Opening';
                const department = job.department || 'Department';
                const location = job.workLocation || job.location || 'On-site';
                const description = job.jobDescription || job.description || 'No description available.';
                const urgency = job.urgency || 'medium';
                const employmentType = job.employmentType || 'full-time';
                const createdDate = job.createdDate || job.publishedDate || new Date().toISOString();
                const salaryRange = formatSalaryRange(job.salaryMin, job.salaryMax);
                
                // Get urgency badge classes
                const urgencyClasses = getUrgencyClasses(urgency);
                
                jobCard.innerHTML = `
                    <div class="mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-bold text-gray-800">${jobTitle}</h3>
                            <span class="px-3 py-1 rounded-full text-sm font-medium ${urgencyClasses}">${formatUrgency(urgency)}</span>
                        </div>
                        <p class="text-gray-600 mb-4 line-clamp-3">${description}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4 text-sm text-gray-600">
                        <div class="flex items-center">
                            <i class="fas fa-building text-primary-600 mr-2"></i>
                            <span>${department}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-briefcase text-primary-600 mr-2"></i>
                            <span>${formatEmploymentType(employmentType)}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt text-primary-600 mr-2"></i>
                            <span>${location}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-clock text-primary-600 mr-2"></i>
                            <span>${formatDate(createdDate)}</span>
                        </div>
                        ${salaryRange ? `
                        <div class="flex items-center col-span-2">
                            <i class="fas fa-dollar-sign text-primary-600 mr-2"></i>
                            <span>${salaryRange}</span>
                        </div>` : ''}
                    </div>
                    
                    <div class="flex gap-2 mt-4">
                        <button class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200 flex items-center justify-center gap-2" onclick="viewJobDetails('${job.id}')">
                            <i class="fas fa-eye"></i>
                            View Details
                        </button>
                        <button class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 flex items-center justify-center gap-2" onclick="openApplicationModal('${job.id}')">
                            <i class="fas fa-paper-plane"></i>
                            Apply Now
                        </button>
                    </div>
                `;
                jobGrid.appendChild(jobCard);
            });
        }

        // Helper function to get urgency badge classes
        function getUrgencyClasses(urgency) {
            const urgencyMap = {
                high: 'bg-red-100 text-red-800',
                medium: 'bg-yellow-100 text-yellow-800',
                low: 'bg-green-100 text-green-800',
                critical: 'bg-red-600 text-white animate-pulse'
            };
            return urgencyMap[urgency?.toLowerCase()] || 'bg-gray-100 text-gray-800';
        }        // Helper functions
        function formatUrgency(urgency) {
            const urgencyMap = {
                high: 'Urgent',
                medium: 'Standard',
                low: 'Regular',
                critical: 'Critical'
            };
            return urgencyMap[urgency?.toLowerCase()] || 'Standard';
        }

        function formatEmploymentType(type) {
            const types = {
                'full-time': 'Full Time',
                'part-time': 'Part Time',
                'contract': 'Contract',
                'casual': 'Casual',
                'permanent': 'Permanent',
                'temporary': 'Temporary'
            };
            return types[type?.toLowerCase()] || type || 'Full Time';
        }

        function formatSalaryRange(min, max) {
            if (!min && !max) return null;
            if (min && max && min !== max) {
                return `$${min.toLocaleString()} - $${max.toLocaleString()}`;
            }
            if (min) {
                return `$${min.toLocaleString()}+`;
            }
            if (max) {
                return `Up to $${max.toLocaleString()}`;
            }
            return null;
        }

        function formatDate(date) {
            if (!date) return 'Recently';
            const d = new Date(date);
            if (isNaN(d.getTime())) return 'Recently';
            
            const now = new Date();
            const diff = now - d;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return days + ' days ago';
            if (days < 30) return Math.floor(days / 7) + ' weeks ago';
            return d.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });        }        // Modal Functions
        function viewJobDetails(jobId) {
            console.log('Opening modal for job ID:', jobId);
            
            // Find the job data
            const job = jobsData.find(j => j.id === jobId);
            if (!job) {
                console.error('Job not found:', jobId);
                alert('Job details not found. Please try again.');
                return;
            }
            
            // Populate modal with job data
            populateJobModal(job);
            
            // Show modal
            const modal = document.getElementById('jobModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        // Function to populate Reports To field with line manager's job title
        async function populateReportsToField(lineManagerName) {
            if (!lineManagerName || lineManagerName === 'N/A') {
                document.getElementById('modalReportsTo').textContent = 'N/A';
                return;
            }

            // First, check if the lineManagerName already contains parentheses with job title
            const parenthesesMatch = lineManagerName.match(/\(([^)]+)\)/);
            if (parenthesesMatch) {
                // Extract and display the content inside parentheses
                document.getElementById('modalReportsTo').textContent = parenthesesMatch[1];
                return;
            }

            try {
                // Get company ID to look up staff data
                const companyId = getCompanyId();
                if (!companyId) {
                    document.getElementById('modalReportsTo').textContent = lineManagerName;
                    return;
                }

                // Look up staff data from Firebase
                const staffRef = database.ref(`companies/${companyId}/staff`);
                const snapshot = await staffRef.once('value');
                
                if (snapshot.exists()) {
                    const staffData = snapshot.val();
                    let lineManagerJobTitle = null;

                    // Search for the line manager by name
                    Object.values(staffData).forEach(staffMember => {
                        const fullName = `${staffMember.firstName || ''} ${staffMember.lastName || ''}`.trim();
                        if (fullName === lineManagerName || 
                            staffMember.fullName === lineManagerName ||
                            staffMember.name === lineManagerName) {
                            lineManagerJobTitle = staffMember.jobTitle || staffMember.position;
                        }
                    });

                    // Display job title if found, otherwise display the original name
                    if (lineManagerJobTitle) {
                        document.getElementById('modalReportsTo').textContent = lineManagerJobTitle;
                    } else {
                        // Fallback to displaying the name if job title not found
                        document.getElementById('modalReportsTo').textContent = lineManagerName;
                    }
                } else {
                    // No staff data found, display the name
                    document.getElementById('modalReportsTo').textContent = lineManagerName;
                }
            } catch (error) {
                console.error('Error looking up line manager job title:', error);
                // Fallback to displaying the name
                document.getElementById('modalReportsTo').textContent = lineManagerName;
            }
        }

        function populateJobModal(job) {
            console.log('Populating modal with job data:', job);
            
            // Basic job information
            document.getElementById('modalJobTitle').textContent = job.position || job.jobTitle || 'Job Title';
            document.getElementById('modalPosition').textContent = job.position || job.jobTitle || 'N/A';
            document.getElementById('modalDepartment').textContent = job.department || 'N/A';
            document.getElementById('modalEmploymentType').textContent = job.employmentType || job.jobType || 'N/A';
            document.getElementById('modalWorkLocation').textContent = job.workLocation || job.location || 'N/A';
            
            // Urgency with styling
            const urgencyElement = document.getElementById('modalUrgency');
            const urgency = job.urgency || 'Normal';
            urgencyElement.textContent = urgency;
            urgencyElement.className = `urgency-${urgency.toLowerCase()}`;
            
            // Status
            document.getElementById('modalStatus').textContent = job.status || 'Available';
            
            // Compensation
            const salaryMin = job.salaryMin || job.minSalary || '';
            const salaryMax = job.salaryMax || job.maxSalary || '';
            let salaryRange = 'Not specified';
            if (salaryMin && salaryMax) {
                salaryRange = `$${parseInt(salaryMin).toLocaleString()} - $${parseInt(salaryMax).toLocaleString()}`;
            } else if (salaryMin) {
                salaryRange = `From $${parseInt(salaryMin).toLocaleString()}`;
            } else if (salaryMax) {
                salaryRange = `Up to $${parseInt(salaryMax).toLocaleString()}`;
            }
            document.getElementById('modalSalary').textContent = salaryRange;
            
            // Benefits
            document.getElementById('modalBenefits').textContent = job.benefits || 'Standard benefits package';
              // Descriptions and content
            document.getElementById('modalDescription').innerHTML = formatTextContent(job.jobDescription || job.description || 'No description available');
            
            // Individual requirement fields
            document.getElementById('modalRequiredEducation').innerHTML = formatTextContent(job.requiredEducation || job.education || 'Not specified');
            document.getElementById('modalRequiredExperience').innerHTML = formatTextContent(job.requiredExperience || job.experience || 'Not specified');
            document.getElementById('modalRequiredSkills').innerHTML = formatTextContent(job.requiredSkills || job.skills || 'Not specified');
            
            document.getElementById('modalPreferredQualifications').innerHTML = formatTextContent(job.preferredQualifications || job.qualifications || 'No preferred qualifications specified');            // Timeline - show job publishing date in the Posted field
            const publishingDate = job.publishingDate || job.datePublished || job.publishedDate || job.createdDate;
            if (publishingDate) {
                const date = new Date(publishingDate);
                if (!isNaN(date.getTime())) {
                    document.getElementById('modalPostedDate').textContent = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    document.getElementById('modalPostedDate').textContent = 'N/A';
                }
            } else {
                document.getElementById('modalPostedDate').textContent = 'N/A';
            }
            
            const advertisingClosingDate = job.advertisingClosingDate;
            if (advertisingClosingDate) {
                const date = new Date(advertisingClosingDate);
                if (!isNaN(date.getTime())) {
                    document.getElementById('modalAdvertisingClosingDate').textContent = date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } else {
                    document.getElementById('modalAdvertisingClosingDate').textContent = 'N/A';
                }
            } else {
                document.getElementById('modalAdvertisingClosingDate').textContent = 'N/A';
            }
            
            // Team and reporting - lookup line manager's job title
            populateReportsToField(job.reportsTo || job.supervisor || job.lineManager);
            
            // Store job ID for apply function
            window.currentJobId = job.id;
        }

        function formatTextContent(text) {
            if (!text) return 'Not specified';
            
            // Convert line breaks to HTML
            return text.replace(/\n/g, '<br>').replace(/\r/g, '');
        }

        function closeJobModal() {
            const modal = document.getElementById('jobModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
            window.currentJobId = null;
        }

        function applyForJob() {
            if (!window.currentJobId) {
                alert('No job selected. Please try again.');
                return;
            }
            
            // You can implement the application logic here
            // For now, we'll redirect to the job details page for application
            window.location.href = `jobdetails.html?jobId=${window.currentJobId}&action=apply`;
        }

        // Close modal when clicking outside of it
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('jobModal');
            if (event.target === modal) {
                closeJobModal();
            }
        });        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const jobModal = document.getElementById('jobModal');
                const applicationModal = document.getElementById('applicationModal');
                if (jobModal.style.display === 'flex') {
                    closeJobModal();
                }
                if (applicationModal.style.display === 'flex') {
                    closeApplicationModal();
                }
            }
        });

        // Application Modal Functions
        function openApplicationModal(jobId) {
            console.log('Opening application modal for job ID:', jobId);
            
            // Find the job data
            const job = jobsData.find(j => j.id === jobId);
            if (!job) {
                console.error('Job not found:', jobId);
                alert('Job details not found. Please try again.');
                return;
            }
            
            // Set the modal title
            const jobTitle = job.position || job.jobTitle || 'Job Position';
            document.getElementById('applicationModalTitle').textContent = `Apply for ${jobTitle}`;
            
            // Store job ID for application submission
            window.currentApplicationJobId = jobId;
            
            // Show application modal
            const modal = document.getElementById('applicationModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Reset form
            document.getElementById('applicationForm').reset();
        }

        function closeApplicationModal() {
            const modal = document.getElementById('applicationModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            window.currentApplicationJobId = null;
            
            // Reset form and extracted text
            document.getElementById('applicationForm').reset();
            extractedResumeText = '';
            extractedCoverLetterText = '';
            resetResumeStatus();
            resetCoverLetterStatus();
        }        async function submitApplicationToFirebase(formData) {
            try {
                console.log('Starting application submission...');
                
                // Convert FormData to object for Firebase
                const applicationData = {};
                
                // Add text fields
                for (let [key, value] of formData.entries()) {
                    if (typeof value === 'string') {
                        applicationData[key] = value;
                    }
                }
                
                console.log('Form data processed:', applicationData);
                
                // Get applicant email for file organization
                const applicantEmail = applicationData.email || 'unknown@email.com';
                
                // Handle file uploads to Firebase Storage
                console.log('Starting file uploads...');
                const files = {
                    resume: null,
                    coverLetter: null,
                    portfolio: []
                };
                
                // Get file references
                const resumeFile = document.getElementById('resumeFile').files[0];
                const coverLetterFile = document.getElementById('coverLetterFile').files[0];
                const portfolioFiles = document.getElementById('portfolioFile').files;
                
                // Upload resume file if present
                if (resumeFile) {
                    console.log('Uploading resume file...');
                    try {
                        const resumeFileInfo = await uploadFileToFirebaseStorage(
                            resumeFile, 
                            window.currentApplicationJobId, 
                            applicantEmail, 
                            'resume'
                        );
                        
                        files.resume = {
                            ...resumeFileInfo,
                            extractedText: extractedResumeText || null,
                            textExtracted: !!extractedResumeText
                        };
                        
                        console.log('Resume uploaded successfully:', files.resume);
                    } catch (error) {
                        console.error('Error uploading resume:', error);
                        // Store file metadata even if upload fails
                        files.resume = {
                            name: resumeFile.name,
                            size: resumeFile.size,
                            type: resumeFile.type,
                            uploadError: error.message,
                            extractedText: extractedResumeText || null,
                            textExtracted: !!extractedResumeText
                        };
                    }
                }
                
                // Upload cover letter file if present
                if (coverLetterFile) {
                    console.log('Uploading cover letter file...');
                    try {
                        const coverLetterFileInfo = await uploadFileToFirebaseStorage(
                            coverLetterFile, 
                            window.currentApplicationJobId, 
                            applicantEmail, 
                            'cover_letter'
                        );
                        
                        files.coverLetter = {
                            ...coverLetterFileInfo,
                            extractedText: extractedCoverLetterText || null,
                            textExtracted: !!extractedCoverLetterText
                        };
                        
                        console.log('Cover letter uploaded successfully:', files.coverLetter);
                    } catch (error) {
                        console.error('Error uploading cover letter:', error);
                        // Store file metadata even if upload fails
                        files.coverLetter = {
                            name: coverLetterFile.name,
                            size: coverLetterFile.size,
                            type: coverLetterFile.type,
                            uploadError: error.message,
                            extractedText: extractedCoverLetterText || null,
                            textExtracted: !!extractedCoverLetterText
                        };
                    }
                }
                
                // Upload portfolio files if present
                if (portfolioFiles.length > 0) {
                    console.log(`Uploading ${portfolioFiles.length} portfolio files...`);
                    try {
                        const portfolioFileInfos = await uploadPortfolioFiles(
                            portfolioFiles, 
                            window.currentApplicationJobId, 
                            applicantEmail
                        );
                        files.portfolio = portfolioFileInfos;
                        console.log('Portfolio files uploaded successfully:', files.portfolio);
                    } catch (error) {
                        console.error('Error uploading portfolio files:', error);
                        // Store file metadata even if upload fails
                        for (let file of portfolioFiles) {
                            files.portfolio.push({
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                uploadError: error.message
                            });
                        }
                    }
                }
                
                // Add application metadata
                applicationData.files = files;
                applicationData.applicationDate = new Date().toISOString();
                applicationData.status = 'pending';
                applicationData.jobId = window.currentApplicationJobId;
                applicationData.applicantIP = 'N/A';
                applicationData.browserInfo = navigator.userAgent;
                applicationData.applicantEmail = applicantEmail;
                
                // Add extracted text for searchability and analysis
                if (extractedResumeText) {
                    applicationData.resumeTextContent = extractedResumeText;
                    applicationData.resumeWordCount = extractedResumeText.split(' ').length;
                    
                    // Extract potential skills and keywords from resume
                    applicationData.extractedSkills = extractSkillsFromText(extractedResumeText);
                    applicationData.extractedKeywords = extractKeywordsFromText(extractedResumeText);
                    console.log('Resume text analysis completed');
                }
                
                if (extractedCoverLetterText) {
                    applicationData.coverLetterTextContent = extractedCoverLetterText;
                    applicationData.coverLetterWordCount = extractedCoverLetterText.split(' ').length;
                    console.log('Cover letter text processed');
                }
                
                console.log('Fetching job data for:', window.currentApplicationJobId);
                
                // Get company ID for scoped storage
                const companyId = getCompanyId();
                console.log('Using company ID for application storage:', companyId);
                
                // Get job information for context and matching from company scope
                const jobSnapshot = await database.ref(`companies/${companyId}/jobs/${window.currentApplicationJobId}`).once('value');
                const jobData = jobSnapshot.val();
                
                if (jobData) {
                    applicationData.jobTitle = jobData.jobTitle || jobData.position || 'Unknown Position';
                    applicationData.department = jobData.department || 'Unknown Department';
                    applicationData.companyId = companyId; // Store company ID in application
                    console.log('Job data retrieved:', applicationData.jobTitle);
                    
                    // Calculate skill matching if both job requirements and resume text are available
                    if (extractedResumeText && jobData.requiredSkills) {
                        applicationData.skillMatchScore = calculateSkillMatch(
                            extractedResumeText, 
                            jobData.requiredSkills
                        );
                        console.log('Skill matching completed:', applicationData.skillMatchScore);
                    }
                } else {
                    console.warn('Job data not found for ID:', window.currentApplicationJobId);
                    applicationData.jobTitle = 'Unknown Position';
                    applicationData.department = 'Unknown Department';
                    applicationData.companyId = companyId; // Store company ID even if job not found
                }
                
                // Generate unique application ID
                const applicationId = 'app_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                console.log('Generated application ID:', applicationId);
                
                // Store application under the company-scoped job's applications subsection
                const jobApplicationPath = `companies/${companyId}/jobs/${window.currentApplicationJobId}/applications/${applicationId}`;
                console.log('Storing application at path:', jobApplicationPath);
                
                await database.ref(jobApplicationPath).set(applicationData);
                console.log('Application stored under company job successfully');
                
                // Also store in a company-scoped applications collection for easier management
                const companyApplicationPath = `companies/${companyId}/applications/${applicationId}`;
                console.log('Storing company application at path:', companyApplicationPath);
                
                await database.ref(companyApplicationPath).set({
                    ...applicationData,
                    applicationId: applicationId
                });
                console.log('Company application stored successfully');
                
                // Update the job's application count and statistics
                if (jobData) {
                    const currentApplicationCount = jobData.applicationCount || 0;
                    const updates = {
                        applicationCount: currentApplicationCount + 1,
                        lastApplicationDate: new Date().toISOString(),
                        totalApplications: (jobData.totalApplications || 0) + 1
                    };
                    
                    console.log('Updating job statistics:', updates);
                    await database.ref(`companies/${companyId}/jobs/${window.currentApplicationJobId}`).update(updates);
                    console.log('Job statistics updated successfully');
                }
                
                console.log('Application submitted successfully with file uploads:', applicationId);
                return { success: true, applicationId: applicationId };
                
            } catch (error) {
                console.error('Detailed error in submitApplicationToFirebase:', error);
                console.error('Error stack:', error.stack);
                console.error('Error message:', error.message);
                
                // Check if it's a Firebase-specific error
                if (error.code) {
                    console.error('Firebase error code:', error.code);
                }
                
                throw error;
            }
        }

        // Helper functions
        function extractSkillsFromText(text) {
            const commonSkills = [
                'JavaScript', 'Python', 'Java', 'C++', 'C#', 'HTML', 'CSS', 'React', 'Angular', 'Vue',
                'Node.js', 'Express', 'MongoDB', 'MySQL', 'PostgreSQL', 'AWS', 'Azure', 'Docker',
                'Kubernetes', 'Git', 'Agile', 'Scrum', 'Project Management', 'Leadership', 'Communication',
                'Problem Solving', 'Teamwork', 'Analysis', 'Design', 'Testing', 'DevOps', 'CI/CD',
                'Machine Learning', 'Data Science', 'Analytics', 'Excel', 'PowerBI', 'Tableau',
                'Photoshop', 'Illustrator', 'Figma', 'UX', 'UI', 'Marketing', 'SEO', 'Sales'
            ];
            
            const foundSkills = [];
            const lowerText = text.toLowerCase();
            
            commonSkills.forEach(skill => {
                if (lowerText.includes(skill.toLowerCase())) {
                    foundSkills.push(skill);
                }
            });
            
            return foundSkills;
        }

        function extractKeywordsFromText(text) {
            // Simple keyword extraction - remove common words and get frequent terms
            const commonWords = ['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'];
            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(word => word.length > 3 && !commonWords.includes(word));
            
            const wordCount = {};
            words.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });
            
            return Object.entries(wordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20)
                .map(([word]) => word);
        }

        function calculateSkillMatch(resumeText, jobSkills) {
            const resumeSkills = extractSkillsFromText(resumeText);
            const jobSkillsList = typeof jobSkills === 'string' ? 
                jobSkills.split(',').map(s => s.trim()) : 
                Array.isArray(jobSkills) ? jobSkills : [];
            
            const matchedSkills = resumeSkills.filter(skill => 
                jobSkillsList.some(jobSkill => 
                    jobSkill.toLowerCase().includes(skill.toLowerCase()) ||
                    skill.toLowerCase().includes(jobSkill.toLowerCase())
                )
            );
            
            return {
                totalJobSkills: jobSkillsList.length,
                matchedSkills: matchedSkills,
                matchedCount: matchedSkills.length,
                matchPercentage: jobSkillsList.length > 0 ? 
                    Math.round((matchedSkills.length / jobSkillsList.length) * 100) : 0
            };
        }

        // PDF Text Extraction Functions
        async function extractTextFromPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let extractedText = '';

                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    extractedText += pageText + '\n';
                }

                return extractedText.trim();
            } catch (error) {
                console.error('Error extracting text from PDF:', error);
                throw error;
            }
        }

        // Firebase Storage File Upload Functions
        async function uploadFileToFirebaseStorage(file, jobId, applicantEmail, fileType) {
            try {
                console.log(`Starting upload for ${fileType}:`, file.name);
                
                // Get company ID for scoped storage
                const companyId = getCompanyId();
                
                // Generate unique filename with timestamp
                const timestamp = Date.now();
                const sanitizedEmail = applicantEmail.replace(/[^a-zA-Z0-9]/g, '_');
                const fileExtension = file.name.split('.').pop();
                const fileName = `${fileType}_${sanitizedEmail}_${timestamp}.${fileExtension}`;
                
                // Create storage reference with company-scoped organized path structure
                const storageRef = storage.ref(`companies/${companyId}/applications/${jobId}/${sanitizedEmail}/${fileName}`);
                
                // Set metadata for better organization and security
                const metadata = {
                    contentType: file.type,
                    customMetadata: {
                        'applicantEmail': applicantEmail,
                        'jobId': jobId,
                        'companyId': companyId,
                        'fileType': fileType,
                        'uploadDate': new Date().toISOString(),
                        'originalFileName': file.name,
                        'fileSize': file.size.toString()
                    }
                };
                
                // Upload file with progress tracking
                const uploadTask = storageRef.put(file, metadata);
                
                return new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            // Track upload progress
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log(`${fileType} upload progress: ${progress}%`);
                            
                            // Update UI with progress if needed
                            updateUploadProgress(fileType, progress);
                        },
                        (error) => {
                            console.error(`Error uploading ${fileType}:`, error);
                            reject(error);
                        },
                        async () => {
                            try {
                                // Get download URL
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                console.log(`${fileType} uploaded successfully:`, downloadURL);
                                
                                const fileInfo = {
                                    fileName: fileName,
                                    originalFileName: file.name,
                                    downloadURL: downloadURL,
                                    size: file.size,
                                    type: file.type,
                                    uploadDate: new Date().toISOString(),
                                    storagePath: `applications/${jobId}/${sanitizedEmail}/${fileName}`
                                };
                                
                                resolve(fileInfo);
                            } catch (error) {
                                console.error(`Error getting download URL for ${fileType}:`, error);
                                reject(error);
                            }
                        }
                    );
                });
                
            } catch (error) {
                console.error(`Error in uploadFileToFirebaseStorage for ${fileType}:`, error);
                throw error;
            }
        }
        function updateUploadProgress(fileType, progress) {
            const progressContainer = document.getElementById(`${fileType}UploadProgress`);
            const progressElement = document.getElementById(`${fileType}Progress`);
            
            if (progressContainer && progressElement) {
                // Show progress container
                progressContainer.style.display = 'block';
                progressContainer.classList.add('active');
                
                // Update progress bar
                progressElement.style.width = `${progress}%`;
                progressElement.textContent = `${Math.round(progress)}%`;
                
                // Hide progress when complete
                if (progress >= 100) {
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        progressContainer.classList.remove('active');
                    }, 2000);
                }
            }
        }

        // Show upload progress for file types
        function showUploadProgress(fileType) {
            const progressContainer = document.getElementById(`${fileType}UploadProgress`);
            if (progressContainer) {
                progressContainer.style.display = 'block';
                progressContainer.classList.add('active');
            }
        }

        // Hide upload progress for file types
        function hideUploadProgress(fileType) {
            const progressContainer = document.getElementById(`${fileType}UploadProgress`);
            if (progressContainer) {
                progressContainer.style.display = 'none';
                progressContainer.classList.remove('active');
            }
        }

        // Upload multiple portfolio files
        async function uploadPortfolioFiles(files, jobId, applicantEmail) {
            const portfolioUrls = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    console.log(`Uploading portfolio file ${i + 1}/${files.length}:`, file.name);
                    const fileInfo = await uploadFileToFirebaseStorage(file, jobId, applicantEmail, `portfolio_${i + 1}`);
                    portfolioUrls.push(fileInfo);
                } catch (error) {
                    console.error(`Error uploading portfolio file ${file.name}:`, error);
                    // Continue with other files even if one fails
                }
            }
            
            return portfolioUrls;
        }

        // Handle resume upload and text extraction
        async function handleResumeUpload(input) {
            const file = input.files[0];
            if (!file) {
                resetResumeStatus();
                return;
            }

            // Reset status indicators
            resetResumeStatus();

            // Check if it's a PDF file
            if (file.type === 'application/pdf') {
                showResumeProcessing();
                
                try {
                    extractedResumeText = await extractTextFromPDF(file);
                    console.log('Resume text extracted:', extractedResumeText.substring(0, 200) + '...');
                    showResumeSuccess();
                } catch (error) {
                    console.error('Error extracting text from resume:', error);
                    extractedResumeText = '';
                    showResumeError();
                }
            } else {
                // For non-PDF files, we'll store metadata only
                extractedResumeText = '';
                console.log('Non-PDF resume uploaded:', file.name);
            }
        }

        // Handle cover letter upload and text extraction
        async function handleCoverLetterUpload(input) {
            const file = input.files[0];
            if (!file) {
                resetCoverLetterStatus();
                return;
            }

            // Reset status indicators
            resetCoverLetterStatus();

            // Check if it's a PDF file
            if (file.type === 'application/pdf') {
                showCoverLetterProcessing();
                
                try {
                    extractedCoverLetterText = await extractTextFromPDF(file);
                    console.log('Cover letter text extracted:', extractedCoverLetterText.substring(0, 200) + '...');
                    showCoverLetterSuccess();
                } catch (error) {
                    console.error('Error extracting text from cover letter:', error);
                    extractedCoverLetterText = '';
                    showCoverLetterError();
                }
            } else {
                // For non-PDF files, we'll store metadata only
                extractedCoverLetterText = '';
                console.log('Non-PDF cover letter uploaded:', file.name);
            }
        }

        // Status indicator functions for resume
        function resetResumeStatus() {
            document.getElementById('resumeProcessing').classList.remove('active');
            document.getElementById('resumeSuccess').classList.remove('active');
            document.getElementById('resumeError').classList.remove('active');
            hideUploadProgress('resume');
            extractedResumeText = '';
        }

        function showResumeProcessing() {
            document.getElementById('resumeProcessing').classList.add('active');
            document.getElementById('resumeSuccess').classList.remove('active');
            document.getElementById('resumeError').classList.remove('active');
        }

        function showResumeSuccess() {
            document.getElementById('resumeProcessing').classList.remove('active');
            document.getElementById('resumeSuccess').classList.add('active');
            document.getElementById('resumeError').classList.remove('active');
        }

        function showResumeError() {
            document.getElementById('resumeProcessing').classList.remove('active');
            document.getElementById('resumeSuccess').classList.remove('active');
            document.getElementById('resumeError').classList.add('active');
        }

        // Status indicator functions for cover letter
        function resetCoverLetterStatus() {
            document.getElementById('coverLetterProcessing').classList.remove('active');
            document.getElementById('coverLetterSuccess').classList.remove('active');
            document.getElementById('coverLetterError').classList.remove('active');
            hideUploadProgress('cover_letter');
            extractedCoverLetterText = '';
        }

        function showCoverLetterProcessing() {
            document.getElementById('coverLetterProcessing').classList.add('active');
            document.getElementById('coverLetterSuccess').classList.remove('active');
            document.getElementById('coverLetterError').classList.remove('active');
        }

        function showCoverLetterSuccess() {
            document.getElementById('coverLetterProcessing').classList.remove('active');
            document.getElementById('coverLetterSuccess').classList.add('active');
            document.getElementById('coverLetterError').classList.remove('active');
        }

        function showCoverLetterError() {
            document.getElementById('coverLetterProcessing').classList.remove('active');
            document.getElementById('coverLetterSuccess').classList.remove('active');
            document.getElementById('coverLetterError').classList.add('active');
        }

        // Close application modal when clicking outside
        document.addEventListener('click', function(event) {
            const jobModal = document.getElementById('jobModal');
            const applicationModal = document.getElementById('applicationModal');
            
            if (event.target === jobModal) {
                closeJobModal();
            }
            if (event.target === applicationModal) {
                closeApplicationModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const jobModal = document.getElementById('jobModal');
                const applicationModal = document.getElementById('applicationModal');
                if (jobModal.style.display === 'flex') {
                    closeJobModal();
                }
                if (applicationModal.style.display === 'flex') {
                    closeApplicationModal();
                }
            }
        });

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase Auth and load jobs based on authentication state
            firebase.auth().onAuthStateChanged((user) => {
                console.log('Auth state changed:', user ? 'logged in' : 'logged out');
                loadJobsRealTime();
            });

            // Add filter change listeners
            document.getElementById('departmentFilter').addEventListener('change', sortAndFilterJobs);
            document.getElementById('employmentTypeFilter').addEventListener('change', sortAndFilterJobs);
            document.getElementById('sortBy').addEventListener('change', sortAndFilterJobs);
        });        function submitApplication() {
            console.log('=== Submit Application Function Called ===');
            
            const form = document.getElementById('applicationForm');
            
            console.log('Submit application called');
            console.log('Form element found:', form);
            
            // Check if form exists
            if (!form) {
                console.error('Application form not found!');
                alert('Application form not found. Please refresh the page and try again.');
                return;
            }
            
            // Check if job ID is set
            console.log('Current application job ID:', window.currentApplicationJobId);
            if (!window.currentApplicationJobId) {
                console.error('No job ID found!');
                alert('No job selected. Please try again.');
                return;
            }
            
            // Validate required fields
            console.log('Validating form...');
            if (!form.checkValidity()) {
                console.log('Form validation failed');
                form.reportValidity();
                return;
            }
            
            console.log('Submitting application for job ID:', window.currentApplicationJobId);
            
            // Validate file sizes
            console.log('Validating file uploads...');
            if (!validateFileUploads()) {
                console.log('File validation failed');
                return;
            }
            
            // Collect form data
            const formData = new FormData(form);
            console.log('Form data collected from container:', form.id);
            console.log('Form data entries:', [...formData.entries()]);
            
            // Log form fields to verify they're all being captured
            const formFields = form.querySelectorAll('input, select, textarea');
            console.log('Total form fields found:', formFields.length);
            formFields.forEach(field => {
                if (field.name) {
                    console.log(`Field: ${field.name} = ${field.value || '[empty]'}`);
                }
            });
            
            // Show loading state
            console.log('Looking for submit button...');
            
            // Add a small delay to ensure modal is fully rendered
            setTimeout(() => {
                const submitBtn = document.getElementById('submitApplicationBtn');
                console.log('Submit button found:', submitBtn);
                
                if (!submitBtn) {
                    console.error('Submit button not found!');
                    // Let's also check what buttons exist in the modal
                    const modalButtons = document.querySelectorAll('#applicationModal button');
                    console.log('All buttons in modal:', modalButtons);
                    modalButtons.forEach((btn, index) => {
                        console.log(`Button ${index}:`, btn, 'ID:', btn.id, 'onclick:', btn.onclick);
                    });
                    alert('Submit button not found. Please refresh the page and try again.');
                    return;
                }
                
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting Application & Uploading Files...';
                submitBtn.disabled = true;
                
                console.log('Starting application submission...');
                
                // Submit application
                submitApplicationToFirebase(formData)
                    .then(result => {
                        console.log('Application submitted successfully:', result);
                        
                        // Show success message
                        alert('Application submitted successfully! Your CV and documents have been uploaded to our secure cloud storage. You will receive a confirmation email shortly.');
                        
                        // Close modal and reset
                        closeApplicationModal();
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error submitting application:', error);
                        
                        // Show error message
                        let errorMessage = 'Error submitting application. ';
                        if (error.message.includes('storage')) {
                            errorMessage += 'There was an issue uploading your files. Please check your internet connection and try again.';
                        } else if (error.message.includes('database')) {
                            errorMessage += 'There was an issue saving your application data. Please try again.';
                        } else {
                            errorMessage += 'Please try again. If the problem persists, contact support.';
                        }
                        
                        alert(errorMessage);
                        
                        // Reset button
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            }, 100); // Small delay to ensure modal is rendered
        }

        function validateFileUploads() {
            const resumeFile = document.getElementById('resumeFile').files[0];
            const coverLetterFile = document.getElementById('coverLetterFile').files[0];
            const portfolioFiles = document.getElementById('portfolioFile').files;
            
            // Validate resume (required)
            if (!resumeFile) {
                alert('Please upload your Resume/CV before submitting.');
                return false;
            }
            
            if (resumeFile.size > 5 * 1024 * 1024) { // 5MB
                alert('Resume file size must be less than 5MB.');
                return false;
            }
            
            // Validate cover letter (optional)
            if (coverLetterFile && coverLetterFile.size > 5 * 1024 * 1024) {
                alert('Cover letter file size must be less than 5MB.');
                return false;
            }
            
            // Validate portfolio files (optional)
            for (let file of portfolioFiles) {
                if (file.size > 10 * 1024 * 1024) { // 10MB
                    alert(`Portfolio file "${file.name}" is too large. Maximum size is 10MB per file.`);
                    return false;
                }
            }
            
            return true;
        }
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }
});
</script>
</body>
</html>

