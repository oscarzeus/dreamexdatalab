<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KPI Management - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Embedded CSS Dependencies -->
    <style>
        /* CSS Variables and Base Styles from styles.css */
        :root {
            /* Light Theme Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-light: #adb5bd;
            --border-color: #dee2e6;
            --accent-color: #3498db;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            
            /* Semantic Colors */
            --green: #2ecc71;
            --blue: #3498db;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --yellow: #f1c40f;
            --gray: #95a5a6;

            /* Staff.html specific variables */
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --sidebar-width: 250px;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-xxl: 3rem;
            
            /* Typography */
            --font-family-base: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-family-display: 'Nunito', var(--font-family-base);
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-xxl: 1.5rem;
            --font-size-xxxl: 1.875rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
            
            /* Border Radius */
            --border-radius-sm: 0.25rem;
            --border-radius-md: 0.375rem;
            --border-radius-lg: 0.5rem;
            --border-radius-xl: 0.75rem;
            --border-radius-xxl: 1rem;
            
            /* Transitions */
            --transition-fast: 0.15s ease-in-out;
            --transition-base: 0.2s ease-in-out;
            --transition-slow: 0.3s ease-in-out;
            
            /* Z-Index Scale */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }

        /* Dark theme overrides */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --text-light: #888888;
            --border-color: #404040;
        }

        /* High contrast theme */
        [data-contrast="high"] {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #ffffff;
            --accent-color: #00ff00;
        }

        /* Base Styles */
        * {
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family-base);
            line-height: 1.6;
            color: var(--text-primary);
            background: #f8f9fa;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background-color 0.2s, color 0.2s;
        }

        /* Header and Navigation Styles - Updated to match staff.html */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            color: var(--text-primary);
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin: 0;
            color: white;
        }

        .logo img {
            height: 40px;
            width: auto;
        }

        .logo .company-name {
            font-family: var(--font-family-display);
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--accent-color);
        }

        /* Top Navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            left: calc(280px + 0.5rem);
            z-index: 100;
            transition: left 0.3s ease;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: var(--bg-secondary);
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-left: auto;
        }

        /* Company Logo and Name in Header */
        .header-company-logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f8f9fa;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 0.5rem;
            padding-top: 5rem;
            width: calc(100% - 280px);
            box-sizing: border-box;
        }

        .sidebar {
            width: 280px;
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* Main content adjustments when sidebar is collapsed */
        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .main-content.sidebar-collapsed .top-nav {
            left: 0.5rem;
        }

        .content-area {
            flex: 1;
            padding: 2rem;
            background: var(--bg-primary);
            overflow-y: auto;
            width: 100%;
            max-width: none;
        }

        /* Sidebar Navigation */
        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
            text-align: left;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        .nav-menu {
            padding: 1rem 0;
        }

        .nav-item {
            margin: 0.25rem 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--border-radius-md);
            transition: all var(--transition-base);
            font-weight: 500;
        }

        .nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-link.active {
            background: var(--accent-color);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .nav-link i {
            width: 20px;
            text-align: left;
            font-size: 1.1rem;
        }

        /* Form Container Styles */
        .form-container {
            max-width: none;
            width: 100%;
            margin: 0;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .kpi-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* KPI Sections Container */
        #kpiSectionsContainer {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Individual KPI Section */
        .kpi-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
        }

        .kpi-section:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .kpi-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .kpi-section-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kpi-section-header h3 i {
            color: var(--accent-color);
        }

        .remove-kpi-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .remove-kpi-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .form-section {
            background: transparent;
            border-radius: 8px;
            padding: 0;
            border: none;
            margin-bottom: 0;
        }

        .form-section h4 {
            margin: 0 0 1.5rem 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section h4 i {
            color: var(--accent-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            align-items: start;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--red);
        }

        .form-control {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-control.error {
            border-color: var(--red);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .form-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .error-message {
            color: var(--red);
            font-size: 0.8rem;
            display: none;
            margin-top: 0.25rem;
        }

        /* Button Styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: color-mix(in srgb, var(--accent-color) 85%, black);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: color-mix(in srgb, var(--text-secondary) 85%, black);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            color: var(--accent-color);
            border: 2px solid var(--accent-color);
        }

        .btn-outline:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-danger:hover {
            background: color-mix(in srgb, var(--red) 85%, black);
            transform: translateY(-1px);
        }

        .btn.success {
            background: var(--green);
            color: white;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            margin: auto;
        }

        .modal-content.modal-large {
            max-width: 900px;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            border-radius: 12px 12px 0 0;
        }

        .modal-header.success {
            background: linear-gradient(135deg, var(--green), color-mix(in srgb, var(--green) 85%, black));
            color: white;
            border-bottom-color: transparent;
        }

        .modal-header.error {
            background: linear-gradient(135deg, var(--red), color-mix(in srgb, var(--red) 85%, black));
            color: white;
            border-bottom-color: transparent;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-header.success h3,
        .modal-header.error h3 {
            color: white;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        .modal-header.success .modal-close,
        .modal-header.error .modal-close {
            color: rgba(255, 255, 255, 0.8);
        }

        .modal-header.success .modal-close:hover,
        .modal-header.error .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body p {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .modal-body p:last-child {
            margin-bottom: 0;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .user-info {
                display: none;
            }
            
            .profile-btn {
                padding: 4px;
                gap: 0;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .top-nav {
                left: 0.5rem;
                padding: 0.75rem 1rem;
                border-radius: 0;
            }
            
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 48px;
                height: 48px;
            }

            .form-container {
                padding: 1rem;
                margin: 1rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal {
                padding: 0.5rem;
                align-items: flex-start;
                padding-top: 2rem;
            }
            
            .modal-content {
                width: 100%;
                max-width: none;
                margin: 0;
                border-radius: 12px 12px 0 0;
                max-height: calc(100vh - 2rem);
            }
            
            .modal-content.modal-large {
                max-width: none;
            }
            
            .modal-header,
            .modal-body {
                padding: 1rem;
            }
            
            .modal-actions {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .modal-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .modal {
                padding: 0;
                align-items: stretch;
            }
            
            .modal-content {
                border-radius: 0;
                height: 100vh;
                max-height: none;
            }
            
            .modal-header {
                border-radius: 0;
                position: sticky;
                top: 0;
                z-index: 1;
            }
            
            .modal-body {
                flex: 1;
                overflow-y: auto;
            }
        }

        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Show menu items by default until permissions are loaded */
        .menu-loading [data-feature] {
            display: block !important;
        }

        .menu-loading .menu-dropdown {
            display: block !important;
        }
    </style>
    <style>
        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li {
            padding: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Avatar Initials */
        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            min-width: 0;
        }

        #userFullName {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        /* Schedule Period Indicator Styles */
        .schedule-indicator {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
        }

        .schedule-indicator.current-period {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .schedule-indicator.upcoming-period {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .schedule-indicator.past-period {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .schedule-indicator.outside-period {
            background: #e2e3e5;
            border-color: #ced4da;
            color: #6c757d;
        }

        .schedule-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .schedule-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .schedule-indicator.current-period .schedule-icon {
            background: #28a745;
            color: white;
        }

        .schedule-indicator.upcoming-period .schedule-icon {
            background: #ffc107;
            color: #212529;
        }

        .schedule-indicator.past-period .schedule-icon {
            background: #dc3545;
            color: white;
        }

        .schedule-indicator.outside-period .schedule-icon {
            background: #6c757d;
            color: white;
        }

        .schedule-text {
            flex-grow: 1;
        }

        .schedule-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .schedule-dates {
            font-size: 12px;
            opacity: 0.8;
        }

        .schedule-status {
            font-size: 12px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            white-space: nowrap;
        }

        .schedule-indicator.current-period .schedule-status {
            background: rgba(40, 167, 69, 0.2);
            color: #155724;
        }

        .schedule-indicator.upcoming-period .schedule-status {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
        }

        .schedule-indicator.past-period .schedule-status {
            background: rgba(220, 53, 69, 0.2);
            color: #721c24;
        }

        .schedule-indicator.outside-period .schedule-status {
            background: rgba(108, 117, 125, 0.2);
            color: #495057;
        }

        .no-schedule-indicator {
            background: #e9ecef;
            border: 1px dashed #adb5bd;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            color: #6c757d;
            margin-bottom: 20px;
        }

        /* Team Member Comments Section Styles */
        .team-comments-section {
            margin: 24px 0;
        }

        .comments-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .comments-header {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-bottom: 1px solid #dee2e6;
            padding: 16px 20px;
        }

        .comments-header h4 {
            margin: 0 0 6px 0;
            color: #1976d2;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comments-header h4 i {
            color: #1976d2;
        }

        .comments-header p {
            margin: 0;
            color: #555;
            font-size: 14px;
            line-height: 1.4;
        }

        .comments-body {
            padding: 20px;
        }

        .comments-body .form-group {
            margin-bottom: 20px;
        }

        .comments-body .form-group:last-of-type {
            margin-bottom: 16px;
        }

        .comments-body label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .comments-body textarea {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            background: white;
        }

        .comments-body textarea:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .comments-body textarea::placeholder {
            color: #6c757d;
            font-style: italic;
        }

        .comments-actions {
            display: flex;
            gap: 12px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
            margin-top: 16px;
            padding-top: 16px;
        }

        .comments-actions .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        /* Disabled state for team member comments when viewing others' evaluations */
        .comments-disabled {
            opacity: 0.7;
        }

        .comments-disabled textarea {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .comments-disabled .comments-actions {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Schedule Configuration Modal Enhanced Styles */
        .schedule-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .schedule-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .schedule-meta {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.75rem;
            flex-wrap: wrap;
        }

        .schedule-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.95;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .schedule-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border-left: 4px solid var(--secondary-color);
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 1.5rem;
        }

        .schedule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .schedule-card-title {
            color: var(--secondary-color);
            font-weight: 700;
            margin-bottom: 0.8rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .schedule-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.6rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.8rem;
        }

        .schedule-detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .schedule-detail-label {
            font-weight: 600;
            color: #495057;
            flex: 0 0 40%;
            font-size: 0.8rem;
        }

        .schedule-detail-value {
            color: #212529;
            flex: 1;
            text-align: left;
            font-size: 0.8rem;
        }

        .schedule-description-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e9ecef;
            width: 100%;
        }

        /* Notification schedule specific styling */
        .notification-settings-card {
            background: #f0f8ff;
            border-left-color: var(--blue);
        }

        .period-schedule-card {
            background: #f0fff0;
            border-left-color: var(--green);
        }

        .settings-card {
            background: #fff8f0;
            border-left-color: var(--orange);
        }

        /* Per-KPI Team Comments Styles */
        .kpi-team-comments {
            margin-top: 16px;
            border-top: 1px solid #e9ecef;
            padding-top: 16px;
            background: #fafbfc;
            border-radius: 0 0 8px 8px;
            margin: 16px -16px -16px -16px;
            padding: 16px;
        }

        .kpi-team-comments .comments-header {
            background: none;
            border: none;
            padding: 0 0 12px 0;
        }

        .kpi-team-comments .comments-header h6 {
            margin: 0 0 4px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .kpi-team-comments .comments-header h6 i {
            color: #6f42c1;
            font-size: 12px;
        }

        .kpi-team-comments .comment-subtitle {
            margin: 0;
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
        }

        .kpi-team-comments .comments-body {
            padding: 0;
        }

        .kpi-team-comments .feedback-group {
            margin-bottom: 12px;
        }

        .kpi-team-comments .feedback-group label {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        /* Enhanced Evaluation Feedback Section Styling */
        .eval-feedback {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .eval-feedback-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #dee2e6;
        }

        .eval-feedback-header h5 {
            margin: 0;
            color: #495057;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .eval-feedback-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .feedback-section {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .feedback-section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #f1f3f4;
        }

        .feedback-section-header h6 {
            margin: 0;
            color: #6c757d;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .feedback-section-header .section-badge {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: auto;
        }

        .feedback-group {
            margin-bottom: 1rem;
        }

        .feedback-group:last-child {
            margin-bottom: 0;
        }

        .feedback-group label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .feedback-group textarea {
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 0.9rem;
            line-height: 1.4;
            resize: vertical;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: inherit;
        }

        .feedback-group textarea:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
        }

        .feedback-group textarea::placeholder {
            color: #adb5bd;
            font-style: italic;
        }

        /* Action Plan Specific Styling */
        .action-plan-section {
            border-left: 4px solid #28a745;
            background-color: #f8fff9;
        }

        .action-plan-section .feedback-section-header h6 {
            color: #28a745;
        }

        .action-plan-section .section-badge {
            background-color: #d4edda;
            color: #155724;
        }

        /* Mid-Year Feedback Specific Styling */
        .midyear-feedback-section {
            border-left: 4px solid #007bff;
            background-color: #f7f9ff;
        }

        .midyear-feedback-section .feedback-section-header h6 {
            color: #007bff;
        }

        /* Self-evaluation restriction styling */
        .eval-restriction-notice {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .eval-restriction-notice i {
            color: #f39c12;
        }

        /* Responsive design for evaluation sections */
        @media (max-width: 576px) {
            .eval-feedback {
                padding: 1rem;
            }
            
            .feedback-section {
                padding: 1rem;
            }
            
            .eval-feedback-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }

        .kpi-team-comments textarea {
            font-size: 13px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            padding: 8px 10px;
            resize: vertical;
            min-height: 60px;
        }

        .kpi-team-comments .comment-actions {
            margin-top: 8px;
            text-align: right;
        }

        .kpi-team-comments .btn-xs {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
        }

        /* Responsive adjustments for comments section */
        @media (max-width: 768px) {
            .comments-body {
                padding: 16px;
            }
            
            .comments-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .comments-actions .btn-sm {
                width: 100%;
            }
        }

        /* Enhanced Schedule Modal Styles */
        .modal-large {
            max-width: 1200px;
            width: 98%;
            max-height: 95vh;
            overflow: hidden;
        }

        .modal-body {
            max-height: calc(95vh - 120px);
            overflow-y: auto;
            padding: 0;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Enhanced Form Section Styles */
        .form-section {
            padding: 24px;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h4 {
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section h4 i {
            font-size: 16px;
            color: #3498db;
        }

        /* Form subsection styling for grouped content within periods */
        .form-subsection {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .form-subsection h5 {
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-subsection h5 i {
            font-size: 14px;
            color: #6c757d;
        }

        /* Enhanced Notification Scheduling Styles */
        .notification-group {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e9ecef;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .notification-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #f39c12, #e74c3c);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification-group:hover {
            border-color: #3498db;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
            transform: translateY(-2px);
        }

        .notification-group:hover::before {
            opacity: 1;
        }

        .notification-group.disabled {
            opacity: 0.6;
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .notification-group h5 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .notification-group h5 i {
            color: #3498db;
            font-size: 16px;
            padding: 8px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 50%;
        }

        /* Enhanced Time Input Groups */
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            background: rgba(52, 152, 219, 0.05);
            padding: 16px;
            border-radius: 12px;
            border: 1px solid rgba(52, 152, 219, 0.1);
            transition: all 0.3s ease;
        }

        .time-input-group:hover {
            background: rgba(52, 152, 219, 0.08);
            border-color: rgba(52, 152, 219, 0.2);
        }

        .time-input-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 80px;
        }

        .time-input {
            width: 70px !important;
            min-width: 70px;
            height: 45px;
            text-align: center;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 8px 4px;
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .time-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1), 0 4px 12px rgba(52, 152, 219, 0.15);
            transform: translateY(-1px);
        }

        .time-input:hover {
            border-color: #3498db;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .time-unit {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Enhanced DateTime Input Groups for horizontal alignment */
        .datetime-input-group {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            flex-wrap: wrap;
            background: rgba(52, 152, 219, 0.03);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(52, 152, 219, 0.1);
            transition: all 0.3s ease;
        }

        .datetime-input-group:hover {
            background: rgba(52, 152, 219, 0.06);
            border-color: rgba(52, 152, 219, 0.2);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
        }

        .datetime-input-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 150px;
            flex: 1;
        }

        .datetime-label {
            font-size: 13px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .datetime-input {
            height: 45px;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .datetime-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1), 0 4px 12px rgba(52, 152, 219, 0.15);
            transform: translateY(-1px);
        }

        .datetime-input:hover {
            border-color: #3498db;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Auto-updated deadline reminder feedback */
        .datetime-input.auto-updated {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1), 0 4px 12px rgba(40, 167, 69, 0.15);
            background-color: rgba(40, 167, 69, 0.02);
            transition: all 0.3s ease;
        }

        .deadline-reminder-indicator {
            display: inline-block;
            animation: fadeInSlideUp 0.3s ease;
        }

        @keyframes fadeInSlideUp {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Multiple Notification Schedules */
        .multiple-notifications-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 24px;
            margin-top: 16px;
            width: 100%;
            grid-column: 1 / -1; /* Span all columns in grid layout */
            box-sizing: border-box;
            position: relative;
        }

        .notification-schedule-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            position: relative;
            transition: all 0.3s ease;
        }

        .notification-schedule-item:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
        }

        .notification-schedule-item:last-child {
            margin-bottom: 0;
        }

        .notification-item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 12px;
            gap: 12px;
        }

        .notification-item-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            flex: 1;
        }

        .notification-item-remove {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-item-remove:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .add-notification-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            width: 100%;
            justify-content: center;
        }

        .add-notification-btn:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }

        .notification-schedules-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }

        .notification-schedules-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-count-badge {
            background: #3498db;
            color: white;
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        /* Enhanced Checkbox Styles */
        .notification-group .checkbox-group {
            margin-bottom: 20px;
            position: relative;
        }

        .notification-group .checkbox-group input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .notification-group .checkbox-group label {
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding-left: 35px;
            position: relative;
            user-select: none;
            transition: color 0.3s ease;
        }

        .notification-group .checkbox-group label:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 20px;
            width: 20px;
            background-color: white;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification-group .checkbox-group label:after {
            content: '✓';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .notification-group .checkbox-group input[type="checkbox"]:checked + label:before {
            background-color: #3498db;
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .notification-group .checkbox-group input[type="checkbox"]:checked + label:after {
            opacity: 1;
        }

        .notification-group .checkbox-group input[type="checkbox"]:checked + label {
            color: #3498db;
        }

        .notification-group .form-hint {
            font-size: 12px;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 8px;
            line-height: 1.5;
            padding: 8px 12px;
            background: rgba(127, 140, 141, 0.1);
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        /* Quick Preset Buttons */
        .quick-presets {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 6px 12px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 20px;
            font-size: 11px;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .preset-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        /* Enhanced Modal Actions */
        .modal-actions {
            padding: 20px 24px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .modal-actions .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .modal-actions .btn-info {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .modal-actions .btn-primary {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        /* Responsive adjustments for notification scheduling */
        @media (max-width: 768px) {
            .time-input-group, .datetime-input-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
                padding: 16px;
            }

            .time-input {
                width: 100px !important;
            }

            .datetime-input-container {
                min-width: 100%;
                flex: none;
            }

            .datetime-input {
                width: 100%;
                height: 50px;
            }

            .notification-group {
                padding: 16px;
            }

            .reminder-schedule-options {
                padding: 16px;
            }

            .interval-input-group, .specific-dates-group {
                margin-left: 12px;
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .modal-large {
                max-width: 100%;
                width: 100%;
                margin: 0;
                max-height: 100vh;
            }

            .modal-body {
                max-height: calc(100vh - 120px);
            }

            .form-section {
                padding: 16px;
            }

            .notification-group {
                padding: 16px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .time-input-group, .datetime-input-group {
                flex-direction: column;
                gap: 12px;
                padding: 12px;
            }

            .datetime-input-group {
                gap: 16px;
            }

            .datetime-input-container {
                min-width: 100%;
            }

            .datetime-input {
                height: 48px;
                font-size: 16px;
            }

            .time-input {
                width: 120px !important;
                min-width: 120px;
            }

            .datetime-input-container {
                min-width: 100%;
            }

            .quick-presets {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
            }

            .preset-btn {
                font-size: 11px;
                padding: 6px 12px;
            }
        }

        /* KPI Form Styles from forms.css */
        .form-container {
            max-width: none;
            margin: 0;
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .kpi-form {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* KPI Sections Container */
        #kpiSectionsContainer {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Individual KPI Section */
        .kpi-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
        }

        .kpi-section:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .kpi-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .kpi-section-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kpi-section-header h3 i {
            color: var(--accent-color);
        }

        .remove-kpi-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .remove-kpi-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .form-section {
            background: transparent;
            border-radius: 8px;
            padding: 0;
            border: none;
            margin-bottom: 0;
        }

        .form-section h4 {
            margin: 0 0 1.5rem 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section h4 i {
            color: var(--accent-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            align-items: start;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-label.required::after {
            content: ' *';
            color: var(--red);
        }

        .form-control {
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-control.error {
            border-color: var(--red);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }

        .form-hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .error-message {
            color: var(--red);
            font-size: 0.8rem;
            display: none;
            margin-top: 0.25rem;
        }

        .threshold-info {
            margin-bottom: 1rem;
        }

        .info-text {
            background: rgba(52, 152, 219, 0.1);
            color: var(--blue);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        /* Getting Started Section */
        .getting-started-section {
            background: var(--bg-primary);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem 2rem;
            margin: 2rem 0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .getting-started-content {
            max-width: 500px;
            margin: 0 auto;
        }

        .getting-started-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--blue), var(--purple));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
        }

        .getting-started-section h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .getting-started-section p {
            margin: 0 0 2rem 0;
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .getting-started-steps {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            text-align: left;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: var(--blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .step-text {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            flex-direction: row;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .tab-navigation::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        .tab-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            flex: 1;
            min-height: 60px;
            z-index: 2;
        }

        .tab-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--blue);
        }

        .tab-item.active {
            background: linear-gradient(135deg, var(--blue), color-mix(in srgb, var(--blue) 85%, white));
            color: white;
            border-color: var(--blue);
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            border-bottom: 2px solid white;
        }

        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: -0.75rem;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--blue);
            border-radius: 1px;
            z-index: 3;
        }

        .tab-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .tab-item:not(.active) .tab-icon {
            background: var(--bg-secondary);
            color: var(--blue);
        }

        .tab-content h4 {
            margin: 0 0 0.2rem 0;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .tab-item:not(.active) .tab-content h4 {
            color: var(--text-primary);
        }

        .tab-content p {
            margin: 0;
            font-size: 0.75rem;
            opacity: 0.9;
            line-height: 1.2;
        }

        .tab-item:not(.active) .tab-content p {
            color: var(--text-secondary);
        }

        /* Tab Schedule Information */
        .tab-schedule-info {
            margin-top: 0.4rem;
            padding-top: 0.4rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-item:not(.active) .tab-schedule-info {
            border-top: 1px solid var(--border-color);
        }

        .schedule-period-text {
            font-size: 0.7rem;
            font-weight: 500;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .tab-item:not(.active) .schedule-period-text {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .schedule-period-text.current {
            color: #28a745;
        }

        .schedule-period-text.upcoming {
            color: #ffc107;
        }

        .schedule-period-text.past {
            color: #dc3545;
        }

        .schedule-period-text.outside {
            color: #6c757d;
        }

        .tab-item.active .schedule-period-text.current {
            color: rgba(255, 255, 255, 0.9);
        }

        .tab-item.active .schedule-period-text.upcoming {
            color: rgba(255, 255, 255, 0.8);
        }

        .tab-item.active .schedule-period-text.past {
            color: rgba(255, 255, 255, 0.7);
        }

        .tab-item.active .schedule-period-text.outside {
            color: rgba(255, 255, 255, 0.6);
        }

        .schedule-period-text i {
            font-size: 0.65rem;
        }

        /* Tab Status Indicators */
        .tab-item.tab-current {
            border-left: 4px solid #28a745;
        }

        .tab-item.tab-upcoming {
            border-left: 4px solid #ffc107;
        }

        .tab-item.tab-past {
            border-left: 4px solid #dc3545;
        }

        .tab-item.tab-outside {
            border-left: 4px solid #6c757d;
        }

        .tab-item.active.tab-current {
            border-left: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .tab-item.active.tab-upcoming {
            border-left: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        }

        .tab-item.active.tab-past {
            border-left: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
        }

        .tab-item.active.tab-outside {
            border-left: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }

        /* Tab Accessibility States */
        .tab-item.tab-disabled {
            opacity: 0.6;
            pointer-events: none;
            cursor: not-allowed;
        }

        .tab-item.tab-disabled .tab-content {
            color: #6c757d;
        }

        .tab-item.tab-disabled .tab-icon {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Enhanced Schedule Period Text with Badges */
        .schedule-period-text.current::before {
            content: '●';
            color: #28a745;
            margin-right: 4px;
            font-weight: bold;
        }

        .schedule-period-text.upcoming::before {
            content: '○';
            color: #ffc107;
            margin-right: 4px;
            font-weight: bold;
        }

        .schedule-period-text.past::before {
            content: '✓';
            color: #dc3545;
            margin-right: 4px;
            font-weight: bold;
        }

        .schedule-period-text.outside::before {
            content: '—';
            color: #6c757d;
            margin-right: 4px;
            font-weight: bold;
        }

        /* Tab Content Sections */
        .tab-content-section {
            display: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            width: 100%;
        }

        .tab-content-section.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: fadeInUp 0.4s ease;
            width: 100%;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-spinner {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            color: var(--text-primary);
        }

        .loading-spinner i {
            font-size: 2rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
        }

        .loading-spinner p {
            margin: 0;
            font-size: 1rem;
        }

        /* Priority and Status Badges */
        .priority, .status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority.critical {
            background: rgba(231, 76, 60, 0.1);
            color: var(--red);
        }

        .priority.high {
            background: rgba(230, 126, 34, 0.1);
            color: var(--orange);
        }

        .priority.medium {
            background: rgba(241, 196, 15, 0.1);
            color: #f39c12;
        }

        .priority.low {
            background: rgba(46, 204, 113, 0.1);
            color: var(--green);
        }

        .status.active {
            background: rgba(46, 204, 113, 0.1);
            color: var(--green);
        }

        .status.inactive {
            background: rgba(149, 165, 166, 0.1);
            color: var(--text-secondary);
        }

        .status.draft {
            background: rgba(52, 152, 219, 0.1);
            color: var(--blue);
        }

        /* Field Restrictions and Period Expiry Styles */
        .field-disabled {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
            opacity: 0.75 !important;
            cursor: not-allowed !important;
            border-color: #dee2e6 !important;
            position: relative;
        }

        .field-disabled:hover,
        .field-disabled:focus {
            background-color: #f8f9fa !important;
            border-color: #dee2e6 !important;
            box-shadow: none !important;
            outline: none !important;
        }

        .field-disabled::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            border-radius: inherit;
        }

        /* Add KPI Button Locked State */
        .btn-locked {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: white !important;
            opacity: 0.75 !important;
            cursor: not-allowed !important;
            position: relative;
            pointer-events: none !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-locked:hover,
        .btn-locked:focus,
        .btn-locked:active {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: white !important;
            opacity: 0.75 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-locked::before {
            content: '\f023';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .btn-locked .fas.fa-plus {
            opacity: 0.5;
        }

        /* Team Member Field Frozen State */
        .field-disabled.form-control {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
            opacity: 0.75 !important;
            cursor: not-allowed !important;
            border-color: #dee2e6 !important;
            position: relative;
            pointer-events: none !important; /* Completely prevent all interactions */
        }

        .field-disabled.form-control:hover,
        .field-disabled.form-control:focus {
            background-color: #f8f9fa !important;
            border-color: #dee2e6 !important;
            box-shadow: none !important;
            outline: none !important;
        }

        /* Remove dropdown arrow when field is frozen */
        .field-disabled.form-control {
            background-image: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
        }

        .field-disabled.form-control::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            pointer-events: none;
            border-radius: inherit;
        }

        /* Frozen field indicator */
        .frozen-indicator {
            animation: pulse-freeze 2s infinite;
        }

        @keyframes pulse-freeze {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* Assignment tab comprehensive frozen message */
        .frozen-message {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8e9 100%);
            border: 2px solid #2196f3;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .frozen-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #2196f3, transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .frozen-message-content {
            text-align: center;
        }
        
        .frozen-icon {
            font-size: 2rem;
            color: #2196f3;
            margin-bottom: 10px;
            animation: pulse-freeze 2s ease-in-out infinite;
        }
        
        .frozen-message strong {
            color: #1565c0;
            font-size: 1.2rem;
            display: block;
            margin-bottom: 8px;
        }
        
        .frozen-message p {
            margin: 5px 0;
            color: #424242;
            line-height: 1.4;
        }
        
        /* Assignment tab specific frozen message */
        .assignment-tab-frozen {
            background: linear-gradient(135deg, #fff3e0 0%, #f3e5f5 100%);
            border-color: #ff9800;
        }
        
        .assignment-tab-frozen::before {
            background: linear-gradient(90deg, transparent, #ff9800, transparent);
        }
        
        .assignment-tab-frozen .frozen-icon {
            color: #ff9800;
        }
        
        .assignment-tab-frozen strong {
            color: #e65100;
        }
        
        /* KPI section frozen indicator */
        .kpi-frozen-indicator {
            animation: pulse-freeze 2s ease-in-out infinite;
        }

        /* Period expired notice */
        .period-expired-notice {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(255, 193, 7, 0.2);
            animation: slideInNotice 0.3s ease-out;
        }

        @keyframes slideInNotice {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .expired-notice-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #856404;
            font-weight: 500;
        }

        .expired-notice-content i {
            color: #ffc107;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .expired-notice-content span {
            font-size: 0.95em;
            line-height: 1.4;
        }

        /* Schedule Notification Banner */
        .schedule-notification {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 0.9rem;
        }

        .schedule-notification.info {
            background: rgba(52, 152, 219, 0.1);
            border-left-color: var(--blue);
            color: var(--blue);
        }

        .schedule-notification.warning {
            background: rgba(243, 156, 18, 0.1);
            border-left-color: #f39c12;
            color: #f39c12;
        }

        .schedule-notification.success {
            background: rgba(46, 204, 113, 0.1);
            border-left-color: var(--green);
            color: var(--green);
        }

        .schedule-notification.neutral {
            background: rgba(149, 165, 166, 0.1);
            border-left-color: #95a5a6;
            color: #95a5a6;
        }

        .schedule-notification i {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-content strong {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        .notification-content p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- Permission-based menu visibility relies on JavaScript only -->
    <style>
        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Show menu items by default until permissions are loaded */
        .menu-loading [data-feature] {
            display: block !important;
        }

        .menu-loading .menu-dropdown {
            display: block !important;
        }

        /* Missing CSS Classes for KPI Pages */
        .content {
            padding: 2rem;
            background-color: var(--bg-secondary);
            min-height: calc(100vh - 80px);
            width: 100%;
        }

        .kpi-container {
            max-width: none;
            width: 100%;
            margin: 0;
            background-color: var(--bg-primary);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .kpi-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .kpi-title h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kpi-title p {
            margin: 0;
            opacity: 0.9;
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .header-actions .btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .header-actions .btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tab-navigation {
            display: flex;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab-item {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-item:hover {
            background-color: var(--bg-primary);
        }

        .tab-item.active {
            background-color: var(--bg-primary);
            border-bottom-color: var(--secondary-color);
        }

        .tab-icon {
            margin-right: 1rem;
            font-size: 1.5rem;
            color: var(--text-secondary);
        }

        .tab-item.active .tab-icon {
            color: var(--secondary-color);
        }

        .tab-content h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .tab-content p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .tab-content-section {
            display: none;
            padding: 2rem;
        }

        .tab-content-section.active {
            display: block;
        }

        .global-employee-section {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        .getting-started-section {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            margin: 2rem 0;
        }

        .getting-started-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .getting-started-icon {
            font-size: 4rem;
            color: var(--secondary-color);
            margin-bottom: 1.5rem;
        }

        .getting-started-content h3 {
            font-size: 1.8rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .getting-started-content p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .getting-started-steps {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            text-align: left;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .step-text {
            font-size: 1rem;
            color: var(--text-primary);
        }

        .no-schedule-indicator {
            background-color: #fff8e1;
            border: 1px solid #ffcc02;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
            color: #f57c00;
        }

        .no-schedule-indicator i {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        /* Evaluation Section Styles */
        .kpi-evaluation-section {
            background-color: var(--bg-primary);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .overall-performance-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .mid-year-summary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .year-end-summary {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        .overall-performance-summary h3 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .metric-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            display: block;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .metric-value.large {
            font-size: 2.5rem;
        }

        .overall-performance-summary .metric-value {
            color: white;
            font-size: 2.2rem;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .evaluation-card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .evaluation-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .evaluation-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .evaluation-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .evaluation-status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background-color: #d1edff;
            color: #0c5460;
        }

        .status-overdue {
            background-color: #f8d7da;
            color: #721c24;
        }

        .evaluation-progress {
            margin-top: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        /* Text Color Utilities */
        .text-success {
            color: #28a745 !important;
        }

        .text-warning {
            color: #ffc107 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .text-info {
            color: #17a2b8 !important;
        }

        .text-primary {
            color: var(--primary-color) !important;
        }

        .text-secondary {
            color: var(--text-secondary) !important;
        }

        /* Responsive Design for KPI Pages */
        @media (max-width: 768px) {
            .content {
                padding: 1rem;
            }

            .kpi-header {
                flex-direction: column;
                text-align: center;
            }

            .tab-navigation {
                flex-direction: column;
            }

            .tab-item {
                text-align: center;
            }

            .header-actions {
                justify-content: center;
            }

            .getting-started-steps {
                gap: 0.5rem;
            }

            .step {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }

            /* Evaluation section responsive styles */
            .performance-metrics {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .overall-performance-summary {
                padding: 1.5rem;
            }

            .metric-value {
                font-size: 1.8rem;
            }

            .metric-value.large {
                font-size: 2rem;
            }

            .overall-performance-summary .metric-value {
                font-size: 1.9rem;
            }

            .evaluation-card {
                padding: 1rem;
            }

            .evaluation-card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .kpi-evaluation-section {
                padding: 1rem;
            }
        }
    </style>
    
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                        <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                        <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                        <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo">
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHR4dCB4PSIyMCIgeT0iMjUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IndoaXRlIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iNjAwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiPlU8L3R4dD4KPHN2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <!-- KPI Management Container -->
                <div class="kpi-container">
                <div class="kpi-header">
                    <div class="kpi-title">
                        <h2><i class="fas fa-plus-circle"></i> Create New KPIs</h2>
                        <p>Define and configure Key Performance Indicators for your organization</p>
                    </div>
                    <div class="header-actions">
                        <button type="button" class="btn btn-success" onclick="addKPISection()" id="addKPIBtn">
                            <i class="fas fa-plus"></i> Add KPI
                        </button>
                        <button type="button" class="btn btn-info" onclick="openScheduleModal()">
                            <i class="fas fa-calendar-alt"></i> Schedule
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="loadDraft()" id="loadDraftBtn" style="display: none;">
                            <i class="fas fa-file-alt"></i> Load Draft
                        </button>
                        <button type="button" class="btn btn-outline" onclick="resetForm()" id="resetBtn" style="display: none;">
                            <i class="fas fa-undo"></i> Reset Form
                        </button>
                    </div>
                </div>

                <!-- Period Expiry Notification Banner -->
                <div id="periodExpiryBanner" class="schedule-notification warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="notification-content">
                        <strong>KPI Creation Locked</strong>
                        <p id="periodExpiryMessage">One or more evaluation periods have ended.</p>
                    </div>
                </div>

                <div class="form-container">
                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <div class="tab-item active" onclick="switchTab('assignment')" id="assignmentTab">
                            <div class="tab-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="tab-content">
                                <h4>Assignment</h4>
                                <p>Create and assign KPIs to employees</p>
                                <div class="tab-schedule-info" id="assignmentTabSchedule">
                                    <small class="schedule-period-text" id="assignmentTabPeriod">No schedule configured</small>
                                </div>
                            </div>
                            <div class="change-indicator"></div>
                        </div>
                        <div class="tab-item" onclick="switchTab('evaluation')" id="evaluationTab">
                            <div class="tab-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="tab-content">
                                <h4>Mid Year Evaluation</h4>
                                <p>Review and evaluate KPI performance</p>
                                <div class="tab-schedule-info" id="evaluationTabSchedule">
                                    <small class="schedule-period-text" id="evaluationTabPeriod">No schedule configured</small>
                                </div>
                            </div>
                            <div class="change-indicator"></div>
                        </div>
                        <div class="tab-item" onclick="switchTab('yearEnd')" id="yearEndTab">
                            <div class="tab-icon">
                                <i class="fas fa-trophy"></i>
                            </div>
                            <div class="tab-content">
                                <h4>End of Year Evaluation</h4>
                                <p>Complete annual KPI review and assessment</p>
                                <div class="tab-schedule-info" id="yearEndTabSchedule">
                                    <small class="schedule-period-text" id="yearEndTabPeriod">No schedule configured</small>
                                </div>
                            </div>
                            <div class="change-indicator"></div>
                        </div>
                    </div>

                    <!-- Assignment Tab Content -->
                    <div id="assignmentContent" class="tab-content-section active">
                        <!-- Schedule Indicator for Assignment Period -->
                        <div id="assignmentScheduleIndicator" class="schedule-indicator" style="display: none;">
                            <div class="schedule-info">
                                <div class="schedule-icon">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                                <div class="schedule-text">
                                    <div class="schedule-title">KPI Assignment Period</div>
                                    <div class="schedule-dates" id="assignmentPeriodDates">-</div>
                                </div>
                            </div>
                            <div class="schedule-status" id="assignmentPeriodStatus">-</div>
                        </div>

                        <!-- No Schedule Set Indicator -->
                        <div id="noScheduleIndicatorAssignment" class="no-schedule-indicator">
                            <i class="fas fa-calendar-times"></i>
                            <div><strong>No Schedule Set</strong></div>
                            <div>Click the Schedule button to configure KPI periods</div>
                        </div>

                        <form id="kpiForm" class="kpi-form">
                        <!-- Global Employee Selection -->
                        <div class="form-section global-employee-section">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="globalEmployee" class="form-label required">
                                        <i class="fas fa-users"></i> Select Team Member
                                        <span class="required-asterisk">*</span>
                                    </label>
                                    <select id="globalEmployee" name="globalEmployee" class="form-control" required>
                                        <option value="">Select Team Member</option>
                                        <!-- Options will be populated from Firebase - only direct reports -->
                                    </select>
                                    <div class="error-message" id="globalEmployeeError"></div>
                                </div>
                            </div>
                        </div>

                        <!-- KPI Sections Container -->
                        <div id="kpiSectionsContainer" style="display: none;">
                            <!-- Initial KPI Section -->
                            <div class="kpi-section" data-kpi-index="0">
                                <div class="kpi-section-header">
                                    <h3><i class="fas fa-chart-line"></i> KPI #1</h3>
                                    <button type="button" class="btn btn-danger btn-sm remove-kpi-btn" onclick="removeKPISection(0)" style="display: none;">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                                
                                <div class="form-section">
                                    <h4><i class="fas fa-info-circle"></i> KPI Information</h4>
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="kpiName_0" class="form-label required">KPI Name</label>
                                            <input type="text" id="kpiName_0" name="kpiName_0" class="form-control" required 
                                                   placeholder="Enter KPI name">
                                            <div class="error-message" id="kpiNameError_0"></div>
                                        </div>

                                        <div class="form-group">
                                            <label for="category_0" class="form-label required">Category</label>
                                            <select id="category_0" name="category_0" class="form-control" required>
                                                <option value="">Select Category</option>
                                                <option value="Financial">Financial</option>
                                                <option value="Operational">Operational</option>
                                                <option value="Customer">Customer</option>
                                                <option value="Employee">Employee</option>
                                                <option value="Quality">Quality</option>
                                                <option value="Safety">Safety</option>
                                                <option value="Compliance">Compliance</option>
                                                <option value="Innovation">Innovation</option>
                                                <option value="Environmental">Environmental</option>
                                                <option value="Other">Other</option>
                                            </select>
                                            <div class="error-message" id="categoryError_0"></div>
                                        </div>

                                        <div class="form-group">
                                            <label for="metricType_0" class="form-label required">Metric Type</label>
                                            <select id="metricType_0" name="metricType_0" class="form-control" required>
                                                <option value="">Select Metric Type</option>
                                                <option value="Percentage">Percentage (%)</option>
                                                <option value="Number">Number</option>
                                                <option value="Currency">Currency ($)</option>
                                                <option value="Time">Time</option>
                                                <option value="Ratio">Ratio</option>
                                                <option value="Score">Score</option>
                                            </select>
                                            <div class="error-message" id="metricTypeError_0"></div>
                                        </div>

                                        <div class="form-group">
                                            <label for="frequency_0" class="form-label required">Reporting Frequency</label>
                                            <select id="frequency_0" name="frequency_0" class="form-control" required>
                                                <option value="">Select Frequency</option>
                                                <option value="Daily">Daily</option>
                                                <option value="Weekly">Weekly</option>
                                                <option value="Monthly">Monthly</option>
                                                <option value="Quarterly">Quarterly</option>
                                                <option value="Annually">Annually</option>
                                            </select>
                                            <div class="error-message" id="frequencyError_0"></div>
                                        </div>

                                        <div class="form-group">
                                            <label for="target_0" class="form-label required">Target Value</label>
                                            <input type="number" id="target_0" name="target_0" class="form-control" required
                                                   step="0.01" placeholder="Target value">
                                            <div class="error-message" id="targetError_0"></div>
                                        </div>

                                        <div class="form-group full-width">
                                            <label for="description_0" class="form-label">Description</label>
                                            <textarea id="description_0" name="description_0" class="form-control" rows="3"
                                                      placeholder="Brief description of the KPI"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions" id="formActions">
                            <button type="button" class="btn btn-outline" onclick="saveDraft()">
                                <i class="fas fa-save"></i> Save Draft
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle"></i> Create All KPIs
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="previewKPIs()">
                                <i class="fas fa-eye"></i> Preview All
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Mid Year Evaluation Tab Content -->
                <div id="evaluationContent" class="tab-content-section">
                    <div class="evaluation-container">
                        <!-- Schedule Indicator for Mid Year Evaluation Period -->
                        <div id="evaluationScheduleIndicator" class="schedule-indicator" style="display: none;">
                            <div class="schedule-info">
                                <div class="schedule-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="schedule-text">
                                    <div class="schedule-title">Mid Year Evaluation Period</div>
                                    <div class="schedule-dates" id="evaluationPeriodDates">-</div>
                                </div>
                            </div>
                            <div class="schedule-status" id="evaluationPeriodStatus">-</div>
                        </div>

                        <!-- No Schedule Set Indicator -->
                        <div id="noScheduleIndicatorEvaluation" class="no-schedule-indicator">
                            <i class="fas fa-calendar-times"></i>
                            <div><strong>No Schedule Set</strong></div>
                            <div>Click the Schedule button to configure KPI periods</div>
                        </div>

                        <!-- No Employee Available Message -->
                        <div id="noEmployeeSelectedMessage" class="form-section" style="display: block;">
                            <div class="info-card">
                                <div class="info-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="info-content">
                                    <h4>Select a Team Member First</h4>
                                    <p>To view the mid-year evaluation, please select a team member in the Assignment tab first.</p>
                                    <button type="button" class="btn btn-primary" onclick="switchTab('assignment')">
                                        <i class="fas fa-user-plus"></i> Go to Assignment Tab
                                    </button>
                                </div>
                            </div>
                        </div>

        <!-- Current Employee Info (shown when employee is selected) -->
        <div id="currentEmployeeInfo" class="form-section" style="display: none;">
            <div class="employee-info-card">
                <h4><i class="fas fa-user"></i> Evaluating KPIs for: <span id="currentEmployeeName">-</span></h4>
            </div>
        </div>                        <!-- KPI Evaluation List -->
                        <div id="kpiEvaluationList" class="kpi-evaluation-section" style="display: none;">
                            <div id="employeeKPIsList">
                                <!-- KPI evaluation cards will be loaded here -->
                            </div>

                            <!-- Mid-Year Performance Summary -->
                            <div id="overallPerformanceSummaryMidYear" class="overall-performance-summary mid-year-summary" style="display: none;">
                                <div class="simple-summary-container">
                                    <h3><i class="fas fa-chart-bar"></i> Mid-Year Performance Summary</h3>
                                    <div class="summary-metrics">
                                        <div class="summary-metric">
                                            <span class="metric-label">Overall Score:</span>
                                            <span class="metric-value" id="overallPerformanceScoreMidYear">-</span>
                                        </div>
                                        <div class="summary-metric">
                                            <span class="metric-label">KPIs Above Target:</span>
                                            <span class="metric-value" id="kpisAboveTargetMidYear">-</span>
                                        </div>
                                        <div class="summary-metric">
                                            <span class="metric-label">Progress Rate:</span>
                                            <span class="metric-value" id="progressRateMidYear">-</span>
                                        </div>
                                        <div class="summary-metric">
                                            <span class="metric-label">On Track to Meet Targets:</span>
                                            <span class="metric-value" id="onTrackKPIsMidYear">-</span>
                                        </div>
                                    </div>
                                    <div class="achievement-summary" id="achievementSummaryMidYear">
                                        <!-- Achievement statistics will be displayed here -->
                                    </div>
                                    <div class="performance-insights" id="performanceInsightsMidYear">
                                        <!-- Performance insights and recommendations will be displayed here -->
                                    </div>
                                </div>
                            </div>

                            <div class="evaluation-actions" style="display: none;" id="evaluationActions">
                                <button type="button" class="btn btn-outline" onclick="saveEvaluationDraft()">
                                    <i class="fas fa-save"></i> Save Draft
                                </button>
                                <button type="button" class="btn btn-primary" onclick="submitEvaluation()">
                                    <i class="fas fa-check-circle"></i> Submit Evaluation
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="previewEvaluation()">
                                    <i class="fas fa-eye"></i> Preview Report
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- End of Year Evaluation Tab Content -->
                <div id="yearEndContent" class="tab-content-section">
                    <div class="evaluation-container">
                        <!-- Schedule Indicator for Year End Evaluation Period -->
                        <div id="yearEndScheduleIndicator" class="schedule-indicator" style="display: none;">
                            <div class="schedule-info">
                                <div class="schedule-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="schedule-text">
                                    <div class="schedule-title">End of Year Evaluation Period</div>
                                    <div class="schedule-dates" id="yearEndPeriodDates">-</div>
                                </div>
                            </div>
                            <div class="schedule-status" id="yearEndPeriodStatus">-</div>
                        </div>

                        <!-- No Schedule Set Indicator -->
                        <div id="noScheduleIndicatorYearEnd" class="no-schedule-indicator">
                            <i class="fas fa-calendar-times"></i>
                            <div><strong>No Schedule Set</strong></div>
                            <div>Click the Schedule button to configure KPI periods</div>
                        </div>

                        <div class="evaluation-header">
                        </div>

                        <!-- No Employee Available Message -->
                        <div id="noEmployeeSelectedMessageYearEnd" class="form-section" style="display: block;">
                            <div class="info-card">
                                <div class="info-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <div class="info-content">
                                    <h4>Select a Team Member First</h4>
                                    <p>To view the end of year evaluation, please select a team member in the Assignment tab first.</p>
                                    <button type="button" class="btn btn-primary" onclick="switchTab('assignment')">
                                        <i class="fas fa-user-plus"></i> Go to Assignment Tab
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Current Employee Info (shown when employee is selected) -->
                        <div id="currentEmployeeInfoYearEnd" class="form-section" style="display: none;">
                            <div class="employee-info-card">
                                <h4><i class="fas fa-user"></i> Annual Evaluation for: <span id="currentEmployeeNameYearEnd">-</span></h4>
                                <p>This is the final evaluation for the selected employee's KPIs for the current year.</p>
                            </div>
                        </div>

                        <!-- KPI Evaluation List -->
                        <div id="kpiEvaluationListYearEnd" class="kpi-evaluation-section" style="display: none;">
                            <div id="employeeKPIsListYearEnd">
                                <!-- KPI evaluation cards will be loaded here -->
                            </div>

                            <div class="evaluation-actions" style="display: none;" id="evaluationActionsYearEnd">
                                <button type="button" class="btn btn-outline" onclick="saveYearEndEvaluationDraft()">
                                    <i class="fas fa-save"></i> Save Draft
                                </button>
                                <button type="button" class="btn btn-primary" onclick="submitYearEndEvaluation()">
                                    <i class="fas fa-check-circle"></i> Submit Final Evaluation
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="previewYearEndEvaluation()">
                                    <i class="fas fa-eye"></i> Preview Annual Report
                                </button>
                                <button type="button" class="btn btn-warning" onclick="testOverallPerformanceSummary()" style="margin-left: 10px;">
                                    <i class="fas fa-bug"></i> Test Summary (Debug)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> KPI Schedule Configuration</h3>
                <button type="button" class="modal-close" onclick="closeModal('scheduleModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Professional Schedule Header -->
                <div class="schedule-header">
                    <div class="schedule-title">
                        <i class="fas fa-calendar-alt"></i>
                        KPI Schedule Configuration
                    </div>
                    <div class="schedule-meta">
                        <div class="schedule-meta-item">
                            <i class="fas fa-building"></i>
                            <span id="scheduleCompanyName">Company-Scoped Schedule</span>
                        </div>
                        <div class="schedule-meta-item">
                            <i class="fas fa-bell"></i>
                            Automated Notifications
                        </div>
                        <div class="schedule-meta-item">
                            <i class="fas fa-users"></i>
                            Organization-wide Application
                        </div>
                    </div>
                </div>

                <!-- Schedule Description -->
                <div class="schedule-description-section">
                    <p style="margin: 0; color: #6c757d; line-height: 1.5;">
                        <i class="fas fa-info-circle" style="color: var(--blue); margin-right: 0.5rem;"></i>
                        Configure the global schedule for KPI assignments and evaluations. These settings will be applied across the entire KPI management system and control when employees can create, evaluate, and finalize their Key Performance Indicators.
                    </p>
                </div>
                
                <form id="kpiScheduleForm">
                    <div class="schedule-grid">
                        <!-- KPI Assignment Period Card -->
                        <div class="schedule-card period-schedule-card">
                            <div class="schedule-card-title">
                                <i class="fas fa-user-plus"></i> KPI Assignment Period
                            </div>
                            
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Purpose:</span>
                                <span class="schedule-detail-value">Define when KPIs can be created and assigned to employees</span>
                            </div>
                            
                            <!-- Assignment Schedule Details -->
                            <div style="margin-top: 1rem;">
                                <h6 style="color: var(--green); font-weight: 600; margin-bottom: 0.8rem; font-size: 0.85rem;">
                                    <i class="fas fa-calendar-alt"></i> Schedule Details
                                </h6>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="assignmentStartDate" class="form-label required">Assignment Start Date</label>
                                        <input type="date" id="assignmentStartDate" name="assignmentStartDate" 
                                               class="form-control" required>
                                        <small class="form-hint">When KPI assignment period begins</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="assignmentEndDate" class="form-label required">Assignment End Date</label>
                                        <input type="date" id="assignmentEndDate" name="assignmentEndDate" 
                                               class="form-control" required>
                                        <small class="form-hint">When KPI assignment period ends</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assignment Notifications Card -->
                        <div class="schedule-card notification-settings-card">
                            <div class="schedule-card-title">
                                <i class="fas fa-bell"></i> Assignment Notifications
                            </div>
                            
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Target Audience:</span>
                                <span class="schedule-detail-value">Line managers and supervisors</span>
                            </div>
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Notification Type:</span>
                                <span class="schedule-detail-value">Assignment period announcements and reminders</span>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="enableAssignmentNotifications" name="enableAssignmentNotifications" checked>
                                        <label for="enableAssignmentNotifications">Enable assignment period notifications</label>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <div class="multiple-notifications-container">
                                        <div class="notification-schedules-header">
                                            <div class="notification-schedules-title">
                                                <i class="fas fa-clock"></i>
                                                Notification Schedules
                                                <span class="notification-count-badge" id="assignmentNotificationCount">1</span>
                                            </div>
                                        </div>
                                        <div id="assignmentNotificationSchedules">
                                            <div class="notification-schedule-item" data-index="0">
                                                <div class="notification-item-header">
                                                    <span class="notification-item-title">Notification #1</span>
                                                    <button type="button" class="notification-item-remove" onclick="removeNotificationSchedule('assignment', 0)" style="display: none;">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="datetime-input-group">
                                                    <div class="datetime-input-container">
                                                        <label for="assignmentNotificationDate_0" class="datetime-label">Date</label>
                                                        <input type="date" id="assignmentNotificationDate_0" name="assignmentNotificationDate_0" 
                                                               class="form-control datetime-input" required>
                                                    </div>
                                                    <div class="datetime-input-container">
                                                        <label for="assignmentNotificationTime_0" class="datetime-label">Time</label>
                                                        <input type="time" id="assignmentNotificationTime_0" name="assignmentNotificationTime_0" 
                                                               class="form-control datetime-input" value="09:00" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" class="add-notification-btn" onclick="addNotificationSchedule('assignment')">
                                            <i class="fas fa-plus"></i>
                                            Add Another Notification Schedule
                                        </button>
                                    </div>
                                    <small class="form-hint">You can schedule multiple notifications at different dates and times. Each notification will be sent to line managers.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Mid Year Evaluation Period Card -->
                        <div class="schedule-card period-schedule-card">
                            <div class="schedule-card-title">
                                <i class="fas fa-chart-bar"></i> Mid Year Evaluation Period
                            </div>
                            
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Purpose:</span>
                                <span class="schedule-detail-value">Define the mid-year evaluation window for KPI reviews</span>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <h6 style="color: var(--green); font-weight: 600; margin-bottom: 0.8rem; font-size: 0.85rem;">
                                    <i class="fas fa-calendar-alt"></i> Schedule Details
                                </h6>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="midYearStartDate" class="form-label required">Mid Year Start Date</label>
                                        <input type="date" id="midYearStartDate" name="midYearStartDate" 
                                               class="form-control" required>
                                        <small class="form-hint">When mid-year evaluation period begins</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="midYearEndDate" class="form-label required">Mid Year End Date</label>
                                        <input type="date" id="midYearEndDate" name="midYearEndDate" 
                                               class="form-control" required>
                                        <small class="form-hint">When mid-year evaluation period ends</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mid Year Notifications Card -->
                        <div class="schedule-card notification-settings-card">
                            <div class="schedule-card-title">
                                <i class="fas fa-bell"></i> Mid Year Notifications
                            </div>
                            
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Target Audience:</span>
                                <span class="schedule-detail-value">All employees with assigned KPIs</span>
                            </div>
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Notification Type:</span>
                                <span class="schedule-detail-value">Evaluation reminders and deadline alerts</span>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="enableMidYearNotifications" name="enableMidYearNotifications" checked>
                                        <label for="enableMidYearNotifications">Enable mid-year evaluation notifications</label>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <div class="multiple-notifications-container">
                                        <div class="notification-schedules-header">
                                            <div class="notification-schedules-title">
                                                <i class="fas fa-clock"></i>
                                                Notification Schedules
                                                <span class="notification-count-badge" id="midYearNotificationCount">1</span>
                                            </div>
                                        </div>
                                        <div id="midYearNotificationSchedules">
                                            <div class="notification-schedule-item" data-index="0">
                                                <div class="notification-item-header">
                                                    <span class="notification-item-title">Notification #1</span>
                                                    <button type="button" class="notification-item-remove" onclick="removeNotificationSchedule('midYear', 0)" style="display: none;">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="datetime-input-group">
                                                    <div class="datetime-input-container">
                                                        <label for="midYearNotificationDate_0" class="datetime-label">Date</label>
                                                        <input type="date" id="midYearNotificationDate_0" name="midYearNotificationDate_0" 
                                                               class="form-control datetime-input" required>
                                                    </div>
                                                    <div class="datetime-input-container">
                                                        <label for="midYearNotificationTime_0" class="datetime-label">Time</label>
                                                        <input type="time" id="midYearNotificationTime_0" name="midYearNotificationTime_0" 
                                                               class="form-control datetime-input" value="09:00" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" class="add-notification-btn" onclick="addNotificationSchedule('midYear')">
                                            <i class="fas fa-plus"></i>
                                            Add Another Notification Schedule
                                        </button>
                                    </div>
                                    <small class="form-hint">You can schedule multiple notifications at different dates and times. Each notification will be sent to employees.</small>
                                </div>
                            </div>
                        </div>

                        <!-- End of Year Evaluation Period Card -->
                        <div class="schedule-card period-schedule-card">
                            <div class="schedule-card-title">
                                <i class="fas fa-trophy"></i> End of Year Evaluation Period
                            </div>
                            
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Purpose:</span>
                                <span class="schedule-detail-value">Define the year-end evaluation window for final KPI assessments</span>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <h6 style="color: var(--green); font-weight: 600; margin-bottom: 0.8rem; font-size: 0.85rem;">
                                    <i class="fas fa-calendar-alt"></i> Schedule Details
                                </h6>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="yearEndStartDate" class="form-label required">Year End Start Date</label>
                                        <input type="date" id="yearEndStartDate" name="yearEndStartDate" 
                                               class="form-control" required>
                                        <small class="form-hint">When year-end evaluation period begins</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="yearEndEndDate" class="form-label required">Year End End Date</label>
                                        <input type="date" id="yearEndEndDate" name="yearEndEndDate" 
                                               class="form-control" required>
                                        <small class="form-hint">When year-end evaluation period ends</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Year End Notifications Card -->
                        <div class="schedule-card notification-settings-card">
                            <div class="schedule-card-title">
                                <i class="fas fa-bell"></i> Year End Notifications
                            </div>
                            
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Target Audience:</span>
                                <span class="schedule-detail-value">All employees with assigned KPIs</span>
                            </div>
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Notification Type:</span>
                                <span class="schedule-detail-value">Final evaluation reminders and completion alerts</span>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="enableYearEndNotifications" name="enableYearEndNotifications" checked>
                                        <label for="enableYearEndNotifications">Enable year-end evaluation notifications</label>
                                    </div>
                                </div>
                                <div class="form-group full-width">
                                    <div class="multiple-notifications-container">
                                        <div class="notification-schedules-header">
                                            <div class="notification-schedules-title">
                                                <i class="fas fa-clock"></i>
                                                Notification Schedules
                                                <span class="notification-count-badge" id="yearEndNotificationCount">1</span>
                                            </div>
                                        </div>
                                        <div id="yearEndNotificationSchedules">
                                            <div class="notification-schedule-item" data-index="0">
                                                <div class="notification-item-header">
                                                    <span class="notification-item-title">Notification #1</span>
                                                    <button type="button" class="notification-item-remove" onclick="removeNotificationSchedule('yearEnd', 0)" style="display: none;">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                <div class="datetime-input-group">
                                                    <div class="datetime-input-container">
                                                        <label for="yearEndNotificationDate_0" class="datetime-label">Date</label>
                                                        <input type="date" id="yearEndNotificationDate_0" name="yearEndNotificationDate_0" 
                                                               class="form-control datetime-input" required>
                                                    </div>
                                                    <div class="datetime-input-container">
                                                        <label for="yearEndNotificationTime_0" class="datetime-label">Time</label>
                                                        <input type="time" id="yearEndNotificationTime_0" name="yearEndNotificationTime_0" 
                                                               class="form-control datetime-input" value="09:00" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="button" class="add-notification-btn" onclick="addNotificationSchedule('yearEnd')">
                                            <i class="fas fa-plus"></i>
                                            Add Another Notification Schedule
                                        </button>
                                    </div>
                                    <small class="form-hint">You can schedule multiple notifications at different dates and times. Each notification will be sent to employees.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Settings Card -->
                        <div class="schedule-card settings-card">
                            <div class="schedule-card-title">
                                <i class="fas fa-cogs"></i> Global Schedule Settings
                            </div>
                            
                            <div class="schedule-detail-item">
                                <span class="schedule-detail-label">Configuration:</span>
                                <span class="schedule-detail-value">System-wide preferences and automation options</span>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="fiscalYearStart" class="form-label">Fiscal Year Start</label>
                                        <select id="fiscalYearStart" name="fiscalYearStart" class="form-control">
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                        <small class="form-hint">Month when fiscal year begins</small>
                                    </div>

                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="enableNotifications" name="enableNotifications" checked>
                                            <label for="enableNotifications">Enable automatic notifications for schedule milestones</label>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="autoLockPeriods" name="autoLockPeriods">
                                            <label for="autoLockPeriods">Automatically lock previous periods when new period begins</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="resetScheduleToDefaults()">
                            <i class="fas fa-undo"></i> Reset to Defaults
                        </button>
                        <button type="button" class="btn btn-info" onclick="showNotificationScheduleSummary()">
                            <i class="fas fa-bell"></i> Preview Notifications
                        </button>
                        <button type="button" class="btn btn-outline" onclick="showSchedulerStatus()">
                            <i class="fas fa-cogs"></i> Scheduler Status
                        </button>
                        <button type="button" class="btn btn-warning" onclick="testKPINotifications()">
                            <i class="fas fa-envelope-open-text"></i> Test Email Notifications
                        </button>
                        <button type="button" class="btn btn-success" onclick="startNotificationScheduler()">
                            <i class="fas fa-play"></i> Start Auto-Scheduler
                        </button>
                        <button type="button" class="btn btn-danger" onclick="stopNotificationScheduler()">
                            <i class="fas fa-stop"></i> Stop Auto-Scheduler
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('scheduleModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Schedule
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header success">
                <h3><i class="fas fa-check-circle"></i> KPIs Created Successfully!</h3>
            </div>
            <div class="modal-body">
                <p>Your KPIs have been created and saved to the database.</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal('successModal')">Continue</button>
                    <button type="button" class="btn btn-secondary" onclick="viewKPIBoard()">View KPI Dashboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header error">
                <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
            </div>
            <div class="modal-body">
                <p id="errorMessage">An error occurred while creating the KPIs.</p>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" onclick="closeModal('errorModal')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> KPI Preview</h3>
                <button type="button" class="modal-close" onclick="closeModal('previewModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('previewModal')">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitKPIFromPreview()">Create All KPIs</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Creating KPI...</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Creating KPI...</p>
        </div>
    </div>

    <!-- Embedded JavaScript Dependencies -->
    <script type="module">
        // Embedded Firebase Configuration and KPI Form Logic
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Global variables
        let currentUser = null;
        let isDraftSaving = false;
        // kpiCounter will be declared in the global script section

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            setupEventListeners();
            loadUserSession();
            enableAutoSave();
            checkForEditMode();
            loadKPISchedule();
            
            // Set up initial global employee listener
            setTimeout(() => {
                const globalEmployee = document.getElementById('globalEmployee');
                if (globalEmployee && !globalEmployee.hasAttribute('data-listener-added')) {
                    globalEmployee.addEventListener('change', () => {
                        if (typeof window.handleGlobalEmployeeChange === 'function') {
                            window.handleGlobalEmployeeChange();
                        }
                    });
                    globalEmployee.setAttribute('data-listener-added', 'true');
                    console.log('Added initial global employee listener');
                }
            }, 100);
        });

        // Core KPI Form Functions
        function initializeForm() {
            loadEmployees();
            console.log('KPI form initialized');
        }

        function setupEventListeners() {
            const form = document.getElementById('kpiForm');
            if (form) {
                form.addEventListener('submit', handleFormSubmit);
            }
            setupKPIEventListeners(0);

            // Setup sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebarToggle && sidebar && mainContent) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                });
            }

            // Setup profile dropdown
            const profileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!profileBtn.contains(e.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
            }

            // Setup notification dropdown
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    notificationDropdown.classList.remove('show');
                });
            }

            // Setup logout functionality
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('Are you sure you want to logout?')) {
                        // Clear any stored user data
                        localStorage.removeItem('currentUser');
                        sessionStorage.clear();
                        
                        // Sign out from Firebase if available
                        if (typeof firebase !== 'undefined' && firebase.auth) {
                            firebase.auth().signOut().then(() => {
                                window.location.href = 'login.html';
                            }).catch(() => {
                                window.location.href = 'login.html';
                            });
                        } else {
                            window.location.href = 'login.html';
                        }
                    }
                });
            }
        }

        function setupKPIEventListeners(index) {
            const requiredFields = ['kpiName', 'category', 'metricType', 'frequency', 'target'];
            requiredFields.forEach(fieldName => {
                const fieldId = index === 0 ? `${fieldName}_${index}` : `${fieldName}_${index}`;
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', () => validateField(fieldId));
                    field.addEventListener('input', () => clearError(fieldId));
                }
            });
            
            if (index === 0) {
                const globalEmployee = document.getElementById('globalEmployee');
                if (globalEmployee) {
                    globalEmployee.addEventListener('blur', () => validateField('globalEmployee'));
                    globalEmployee.addEventListener('input', () => clearError('globalEmployee'));
                    
                    if (!globalEmployee.hasAttribute('data-listener-added')) {
                        globalEmployee.addEventListener('change', () => {
                            if (typeof window.handleGlobalEmployeeChange === 'function') {
                                window.handleGlobalEmployeeChange();
                            }
                        });
                        globalEmployee.setAttribute('data-listener-added', 'true');
                        console.log('Added global employee change listener from kpi-form.js');
                    }
                }
            }
        }

        function loadUserSession() {
            console.log('🔍 Loading user session...');
            
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    console.log('✅ User session loaded from localStorage:', {
                        name: currentUser.name || currentUser.displayName,
                        email: currentUser.email,
                        id: currentUser.id || currentUser.uid
                    });
                    updateUIForAuthenticatedUser();
                    return;
                } catch (error) {
                    console.error('❌ Error parsing user data from localStorage:', error);
                }
            }
            
            if (window.authManager && window.authManager.isAuthenticated()) {
                currentUser = window.authManager.getUser();
                console.log('✅ User session loaded from auth manager:', {
                    name: currentUser.name || currentUser.displayName,
                    email: currentUser.email,
                    id: currentUser.id || currentUser.uid
                });
                updateUIForAuthenticatedUser();
                return;
            }
            
            if (sessionStorage.getItem('currentUserSession')) {
                try {
                    currentUser = JSON.parse(sessionStorage.getItem('currentUserSession'));
                    console.log('✅ User session loaded from sessionStorage:', currentUser);
                    updateUIForAuthenticatedUser();
                    return;
                } catch (error) {
                    console.error('❌ Error parsing user data from sessionStorage:', error);
                }
            }
            
            console.warn('⚠️ No user session found - user may need to log in again');
            // Show basic menu if no user is found
            showBasicMenu();
        }

        // Update UI for authenticated user
        async function updateUIForAuthenticatedUser() {
            const profileBtn = document.querySelector('.profile-btn');
            const profileDropdown = document.querySelector('.profile-dropdown ul');
            
            if (profileBtn && profileDropdown && currentUser) {
                // Use centralized display methods
                const initials = getUserInitials();
                const displayName = getUserDisplayName();
                const email = getUserEmail();
                
                // Preload avatar URL to avoid showing initials first
                const avatarUrl = await getUserAvatarUrl();
                
                // Update profile image - now show the correct image immediately
                const profileImg = profileBtn.querySelector('img');
                if (profileImg) {
                    if (avatarUrl) {
                        profileImg.src = avatarUrl;
                        profileImg.alt = displayName + ' Avatar';
                    } else {
                        // Generate initials avatar
                        generateInitialsAvatar(displayName, profileImg);
                    }
                }
                
                // Create avatar for dropdown (either real avatar or initials)
                let dropdownAvatarHtml;
                if (avatarUrl) {
                    dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                } else {
                    dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                }
                
                // Update profile dropdown with user info
                const userInfoHtml = `
                    <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${dropdownAvatarHtml}
                            <div>
                                <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                    ${displayName}
                                </div>
                                <div style="color: #666; font-size: 12px;">
                                    ${email}
                                </div>
                            </div>
                        </div>
                    </li>
                `;
                
                // Insert user info at the beginning of dropdown
                profileDropdown.innerHTML = userInfoHtml + profileDropdown.innerHTML;
            }
            
            // Load and display company information
            loadCompanyInfo();
            
            // Load user role and initialize feature-based menu authorization
            console.log('🔄 Loading user role and initializing menu system...');
            await loadUserRole(currentUser);
            
            // Initialize feature-based menu authorization with delay
            setTimeout(async () => {
                try {
                    await updateMenuWithFeatureAuthorization();
                    console.log('✅ Menu visibility system initialized');
                } catch (menuError) {
                    console.warn('⚠️ Could not initialize menu visibility:', menuError);
                    showBasicMenu();
                }
            }, 500);
        }

        // Get user initials
        function getUserInitials() {
            if (!currentUser) return 'U';
            
            const name = currentUser.displayName || currentUser.name || currentUser.email;
            if (!name) return 'U';
            
            return name.split(' ')
                .map(part => part.charAt(0).toUpperCase())
                .slice(0, 2)
                .join('');
        }

        // Get user display name
        function getUserDisplayName() {
            if (!currentUser) return 'User';
            return currentUser.displayName || currentUser.name || currentUser.email?.split('@')[0] || 'User';
        }

        // Get user email
        function getUserEmail() {
            return currentUser?.email || '';
        }

        // Generate initials avatar
        function generateInitialsAvatar(name, imgElement) {
            if (!imgElement || !name) return;
            
            const initials = getUserInitials();
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const backgroundColor = colors[name.length % colors.length];
            
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                </svg>
            `;
            
            imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
            imgElement.alt = name + ' Avatar';
        }

        // Get user avatar URL or null if not available
        async function getUserAvatarUrl() {
            if (!currentUser) return null;
            
            try {
                const userUid = currentUser.uid || currentUser.id;
                if (!userUid) return null;
                
                const avatarPath = `avatars/${userUid}/profile.jpg`;
                const avatarStorageRef = storageRef(storage, avatarPath);
                
                return await getDownloadURL(avatarStorageRef);
            } catch (error) {
                console.log('No avatar found for user, using initials');
                return null;
            }
        }

        // Load and display company information
        async function loadCompanyInfo() {
            if (!currentUser) return;
            
            try {
                console.log('🏢 Loading company information...');
                
                // Default company data
                let companyData = {
                    companyName: 'Dreamex Datalab',
                    logo: null,
                    logoUrl: null
                };
                
                // Try to load company data from Firebase
                if (currentUser.companyId) {
                    try {
                        const companyRef = ref(db, `companies/${currentUser.companyId}`);
                        const companySnapshot = await get(companyRef);
                        
                        if (companySnapshot.exists()) {
                            const company = companySnapshot.val();
                            companyData = {
                                companyName: company.companyName || 'Dreamex Datalab',
                                logo: company.logo,
                                logoUrl: company.logoUrl
                            };
                            console.log('✅ Company data loaded from Firebase:', companyData.companyName);
                        }
                    } catch (error) {
                        console.log('⚠️ Could not load company data from Firebase, using defaults:', error);
                    }
                }
                
                // Update header with company information
                updateCompanyBranding(companyData);
                
            } catch (error) {
                console.error('❌ Error loading company info:', error);
                // Fallback to default
                updateCompanyBranding({
                    companyName: 'Dreamex Datalab',
                    logo: null,
                    logoUrl: null
                });
            }
        }

        // Update company branding in header
        function updateCompanyBranding(companyData) {
            if (!companyData) return;
            
            console.log('🏢 Updating company branding for:', companyData.companyName);
            
            // Update page title
            const title = document.title;
            if (title.includes('KPI Management - Dreamex Datalab HSE')) {
                document.title = title.replace('Dreamex Datalab HSE', `${companyData.companyName} HSE`);
            }
            
            // Update header elements
            const headerLogo = document.getElementById('headerCompanyLogo');
            const headerName = document.getElementById('headerCompanyName');
            
            console.log('🎯 Header elements found:');
            console.log('- headerLogo:', headerLogo ? '✅' : '❌');
            console.log('- headerName:', headerName ? '✅' : '❌');
            
            // Update company name
            if (headerName && companyData.companyName) {
                headerName.textContent = companyData.companyName;
                console.log('✅ Company name updated in header:', companyData.companyName);
            }
            
            // Update logo
            const logoUrl = companyData.logo || companyData.logoUrl;
            if (logoUrl && logoUrl.trim() !== '') {
                console.log('🖼️ Company has logo URL:', logoUrl);
                if (headerLogo) {
                    // Add error handler for logo loading
                    headerLogo.onerror = function() {
                        console.log('❌ Error loading company logo, hiding it');
                        headerLogo.style.display = 'none';
                        headerLogo.classList.remove('visible');
                    };
                    
                    headerLogo.onload = function() {
                        console.log('✅ Company logo loaded successfully');
                        headerLogo.style.display = 'block';
                        headerLogo.classList.add('visible');
                    };
                    
                    headerLogo.src = logoUrl;
                    console.log('✅ Company logo loading...');
                }
            } else {
                console.log('🏢 No logo URL available');
                if (headerLogo) {
                    headerLogo.style.display = 'none';
                    headerLogo.classList.remove('visible');
                    console.log('✅ Company logo hidden (no URL)');
                }
            }
        }

        // Menu visibility methods
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        async function updateMenuVisibility() {
            console.log('🔧 Starting menu visibility update...');
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            try {
                if (!currentUser) {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // Get user's company ID and role
                const companyId = currentUser.companyId;
                const userRole = currentUser.role;
                
                if (!companyId || !userRole) {
                    console.log('❌ Missing company ID or user role');
                    resetMenuVisibility();
                    return;
                }
                
                console.log(`👤 User: role=${userRole}, companyId=${companyId}`);
                
                // Get company role permissions
                const permissionsRef = ref(db, `companies/${companyId}/roles/${userRole}/permissions`);
                console.log(`🔍 Checking permissions at: companies/${companyId}/roles/${userRole}/permissions`);
                
                const permissionsSnapshot = await get(permissionsRef);
                
                if (!permissionsSnapshot.exists()) {
                    console.log(`❌ No permissions found for role ${userRole} in company ${companyId}`);
                    
                    // Try to get all roles to see what's available
                    const allRolesRef = ref(db, `companies/${companyId}/roles`);
                    const allRolesSnapshot = await get(allRolesRef);
                    
                    if (allRolesSnapshot.exists()) {
                        const allRoles = allRolesSnapshot.val();
                        console.log('🔍 Available roles in company:', Object.keys(allRoles));
                        
                        // Check if the role exists with different casing or format
                        const roleKeys = Object.keys(allRoles);
                        const matchingRole = roleKeys.find(key => 
                            key.toLowerCase() === userRole.toLowerCase() ||
                            key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                        );
                        
                        if (matchingRole && allRoles[matchingRole].permissions) {
                            console.log(`✅ Found matching role: ${matchingRole}`);
                            const permissions = allRoles[matchingRole].permissions;
                            updateMenuWithPermissions(permissions);
                            return;
                        }
                    }
                    
                    console.log('❌ No valid permissions found - hiding all menu items');
                    resetMenuVisibility();
                    return;
                }
                
                const permissions = permissionsSnapshot.val();
                console.log('✅ Loaded permissions:', permissions);
                updateMenuWithPermissions(permissions);
                
            } catch (error) {
                console.error('❌ Error updating menu visibility:', error);
                resetMenuVisibility();
            }
        }

        function updateMenuWithPermissions(permissions) {
            console.log('🎯 Updating menu with permissions...');
            console.log('🎯 Permissions object:', permissions);
            
            // Reset menu visibility first
            resetMenuVisibility();
            
            if (!permissions) {
                console.log('⚠️ No permissions object provided');
                return;
            }
            
            // Update menu visibility based on permissions
            const menuItems = document.querySelectorAll('[data-feature]');
            console.log(`🎯 Found ${menuItems.length} menu items to check`);
            let visibleCount = 0;
            
            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                const isSubmenuItem = item.closest('.submenu') !== null;
                const isDropdownContainer = item.classList.contains('menu-dropdown');
                const parentDropdown = item.closest('.menu-dropdown');
                const parentFeature = parentDropdown ? parentDropdown.getAttribute('data-feature') : 'none';
                
                console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission}) [Submenu: ${isSubmenuItem}, Dropdown: ${isDropdownContainer}, Parent: ${parentFeature}]`);
                
                // Skip dropdown containers - they will be handled separately
                if (isDropdownContainer) {
                    console.log(`⏭️ Skipping dropdown container: ${feature} (will be handled by dropdown logic)`);
                    return;
                }
                
                // If item doesn't require permission, show it based on feature permission
                if (!requiresPermission) {
                    // Check if user has permission for this feature
                    if (feature && permissions[feature]) {
                        const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature}`);
                        } else {
                            console.log(`❌ No view permission for: ${feature}`);
                        }
                    } else {
                        console.log(`⚪ Feature not found in permissions: ${feature}`);
                    }
                    return;
                }
                
                // If item requires permission, check if user has it
                if (feature && permissions[feature]) {
                    const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                    
                    if (hasViewPermission) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${feature}`);
                    } else {
                        console.log(`❌ No view permission for: ${feature}`);
                    }
                } else {
                    console.log(`⚪ Feature not found in permissions: ${feature}`);
                }
            });
            
            // Handle parent dropdowns - show only if they have visible children
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const hasVisibleChildren = visibleSubmenuItems.length > 0;
                
                console.log(`🔍 Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
                
                if (hasVisibleChildren) {
                    dropdown.classList.add('menu-visible');
                    console.log(`✅ Showing parent dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children)`);
                } else {
                    console.log(`❌ Hiding parent dropdown ${dropdownFeature} (no visible children)`);
                }
            });
            
            console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
            
            // If no items are visible, show at least home (only if user has home permission)
            if (visibleCount === 0) {
                const homeItem = document.querySelector('[data-feature="home_view"]');
                if (homeItem && permissions && permissions.home_view && 
                    (permissions.home_view.view === true || permissions.home_view === true)) {
                    homeItem.classList.add('menu-visible');
                    console.log('⚠️ No permissions found - showing home as fallback');
                }
            }
        }

        // Emergency fallback: Show basic menu
        function showBasicMenu() {
            console.log('🔧 Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            
            // Remove loading class
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
            
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Feature-based authorization system that takes priority over role permissions
        async function updateMenuWithFeatureAuthorization() {
            console.log('🎯 Starting feature-based menu authorization for kpi.html...');
            
            try {
                if (!currentUser) {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }

                let companyId = currentUser.companyId;
                
                // If no company ID, search companies collection
                if (!companyId && currentUser.uid) {
                    console.log('🔍 Searching for user company...');
                    const companiesRef = ref(db, 'companies');
                    const companiesSnapshot = await get(companiesRef);
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found, cannot determine authorized features');
                    showBasicMenu();
                    return;
                }
                
                // Apply feature-based authorization
                await applyFeatureBasedMenuVisibility(companyId);
                
            } catch (error) {
                console.error('❌ Error in feature-based menu authorization:', error);
                showBasicMenu();
            }
        }

        // Apply feature-based menu visibility
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const featuresRef = ref(db, '/platformFeatures');
                const featuresSnapshot = await get(featuresRef);
                
                if (!featuresSnapshot.exists()) {
                    console.log('⚠️ No platform features found');
                    showBasicMenu();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companyRef = ref(db, `/companies/${companyId}`);
                const companySnapshot = await get(companyRef);
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('❌ Company data not found');
                    showBasicMenu();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('🏢 Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('⚠️ Company has no subscribed features');
                    showBasicMenu();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`⚠️ Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('🔐 All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log('🎯 Authorized features for kpi.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`🎯 Feature-based menu authorization completed for kpi.html - ${visibleCount} items visible`);
                
                // Remove loading class after successful authorization
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
            } catch (error) {
                console.error('❌ Error applying feature-based menu visibility:', error);
                showBasicMenu();
            }
        }

        async function loadUserRole(userData) {
            // Load user role from Firebase if not available
            if (!userData.role && userData.uid) {
                try {
                    const userRef = ref(db, `users/${userData.uid}`);
                    const userSnapshot = await get(userRef);
                    if (userSnapshot.exists()) {
                        const userRole = userSnapshot.val().role || 'user';
                        userData.role = userRole;
                        currentUser = userData;
                    }
                } catch (error) {
                    console.error('Error loading user role:', error);
                }
            }
        }

        function checkForEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const employeeId = urlParams.get('employee');
            const kpiId = urlParams.get('edit');
            
            // Handle old edit mode format
            if (mode === 'edit' && employeeId) {
                console.log('Edit mode detected for employee:', employeeId);
                
                const editDataString = sessionStorage.getItem('kpiEditData');
                if (editDataString) {
                    try {
                        const editData = JSON.parse(editDataString);
                        setTimeout(() => {
                            populateFormForEdit(editData);
                        }, 100);
                        sessionStorage.removeItem('kpiEditData');
                    } catch (error) {
                        console.error('Error parsing edit data:', error);
                        showErrorModal('Error loading KPI data for editing');
                    }
                } else {
                    showErrorModal('No KPI data found for editing');
                }
            }
            // Handle new edit mode format with KPI ID
            else if (kpiId) {
                console.log('Edit mode detected for KPI ID:', kpiId);
                loadKPIForEdit(kpiId);
            }
        }

        async function loadKPIForEdit(kpiId) {
            try {
                console.log('🔄 Loading KPI for edit:', kpiId);
                showLoading(true);
                
                // Get current user and company ID
                const currentUser = window.authManager?.getUser() || 
                                   JSON.parse(localStorage.getItem('currentUser') || '{}') ||
                                   { uid: 'test_user_123', companyId: '-OVdOmV_CnbwZ0d7JrkB' };
                
                let companyId = currentUser.companyId || '-OVdOmV_CnbwZ0d7JrkB';
                
                // Load KPI data from Firebase
                const kpiRef = ref(db, `companies/${companyId}/kpis/${kpiId}`);
                const kpiSnapshot = await get(kpiRef);
                
                if (!kpiSnapshot.exists()) {
                    throw new Error('KPI not found');
                }
                
                const kpiData = kpiSnapshot.val();
                console.log('✅ KPI data loaded:', kpiData);
                
                // Load employee data to get employee details
                const employeeRef = ref(db, `companies/${companyId}/users/${kpiData.employee}`);
                const employeeSnapshot = await get(employeeRef);
                
                let employeeName = 'Unknown Employee';
                if (employeeSnapshot.exists()) {
                    const employeeData = employeeSnapshot.val();
                    employeeName = employeeData.name || 
                                 `${employeeData.firstName || ''} ${employeeData.lastName || ''}`.trim() ||
                                 employeeData.displayName ||
                                 employeeData.email ||
                                 'Unknown Employee';
                }
                
                // Format data for the form
                const editData = {
                    employeeId: kpiData.employee,
                    employeeName: employeeName,
                    kpis: [{
                        id: kpiId,
                        kpiName: kpiData.kpiName,
                        category: kpiData.category,
                        metricType: kpiData.metricType,
                        frequency: kpiData.frequency,
                        target: kpiData.target,
                        current: kpiData.current || 0,
                        description: kpiData.description || '',
                        createdAt: kpiData.createdAt,
                        updatedAt: kpiData.updatedAt
                    }]
                };
                
                console.log('📝 Formatted edit data:', editData);
                
                // Wait for the form to be ready, then populate it
                setTimeout(() => {
                    populateFormForEdit(editData);
                    showLoading(false);
                }, 500);
                
            } catch (error) {
                console.error('❌ Error loading KPI for edit:', error);
                showLoading(false);
                showErrorModal('Failed to load KPI data for editing. Please try again.');
            }
        }

        async function loadEmployees() {
            try {
                console.log('Loading direct reports from Firebase...');
                
                const globalEmployeeSelect = document.getElementById('globalEmployee');
                if (!globalEmployeeSelect) {
                    console.error('Global employee select element not found');
                    return;
                }
                
                globalEmployeeSelect.innerHTML = '<option value="">Loading team members...</option>';
                globalEmployeeSelect.disabled = true;
                
                const currentUser = window.authManager?.getUser();
                console.log('🔍 Current user from authManager:', currentUser);
                
                // Fallback: Try to get user from localStorage if authManager fails
                let fallbackUser = null;
                if (!currentUser) {
                    try {
                        const storedUser = localStorage.getItem('currentUser');
                        if (storedUser) {
                            fallbackUser = JSON.parse(storedUser);
                            console.log('🔍 Fallback user from localStorage:', fallbackUser);
                        }
                    } catch (e) {
                        console.log('⚠️ Could not parse stored user data');
                    }
                }
                
                // Create a test user if no authentication is available (for testing purposes)
                const testUser = fallbackUser || currentUser || {
                    uid: 'test_user_123',
                    email: 'test@dreamexdatalab.com',
                    companyId: '-OVdOmV_CnbwZ0d7JrkB'
                };
                
                console.log('🎯 Final user being used:', testUser);
                
                if (!testUser || !testUser.uid) {
                    console.error('No authenticated user found');
                    globalEmployeeSelect.innerHTML = '<option value="">No authenticated user</option>';
                    globalEmployeeSelect.disabled = false;
                    return;
                }
                
                // Get company ID for scoped data access
                let companyId = testUser.companyId;
                console.log('🏢 Using company ID from user:', companyId);
                
                // If no company ID from user object, try your specific company ID first
                if (!companyId) {
                    companyId = '-OVdOmV_CnbwZ0d7JrkB'; // Your specific company ID
                    console.log('🏢 Using hardcoded company ID:', companyId);
                }
                
                // If still no company ID, try to find it by searching companies
                if (!companyId || companyId === 'default_company') {
                    console.log('🔍 Company ID not found, searching companies...');
                    const companiesRef = ref(db, 'companies');
                    const companiesSnapshot = await get(companiesRef);
                    
                    if (companiesSnapshot.exists()) {
                        const companiesData = companiesSnapshot.val();
                        for (const [cId, company] of Object.entries(companiesData)) {
                            if (company.users && company.users[testUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId} (${company.name || 'Unknown'})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found for current user');
                    globalEmployeeSelect.innerHTML = '<option value="">No company found</option>';
                    globalEmployeeSelect.disabled = false;
                    return;
                }
                
                console.log(`🔥 Final company ID being used: ${companyId}`);
                
                // Test Firebase access before proceeding
                try {
                    const testRef = ref(db, `companies/${companyId}/users`);
                    const testSnapshot = await get(testRef);
                    
                    if (!testSnapshot.exists()) {
                        console.error(`❌ No data found at companies/${companyId}/users`);
                        globalEmployeeSelect.innerHTML = '<option value="">No users found in company</option>';
                        globalEmployeeSelect.disabled = false;
                        return;
                    }
                    
                    const testData = testSnapshot.val();
                    console.log(`✅ Found ${Object.keys(testData).length} users in Firebase company path`);
                } catch (testError) {
                    console.error('❌ Error accessing Firebase company data:', testError);
                    globalEmployeeSelect.innerHTML = '<option value="">Error accessing company data</option>';
                    globalEmployeeSelect.disabled = false;
                    return;
                }
                
                // Get current user's details from company-scoped data to find their name/ID for matching
                const currentUserRef = ref(db, `companies/${companyId}/users/${testUser.uid}`);
                const currentUserSnapshot = await get(currentUserRef);
                let currentUserName = null;
                let currentUserEmail = testUser.email;
                
                if (currentUserSnapshot.exists()) {
                    const userData = currentUserSnapshot.val();
                    currentUserName = userData.name || `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                    if (!currentUserName) {
                        currentUserName = userData.displayName || userData.email;
                    }
                }
                
                console.log('👤 Current user name for matching:', currentUserName);
                console.log('📧 Current user email for matching:', currentUserEmail);
                
                // Load all company users from company-scoped users
                const usersRef = ref(db, `companies/${companyId}/users`);
                console.log(`🔍 Loading users from: companies/${companyId}/users`);
                
                onValue(usersRef, (snapshot) => {
                    console.log('🔥 Firebase onValue callback triggered');
                    const data = snapshot.val();
                    const allCompanyUsers = [];
                    
                    if (data) {
                        console.log(`📊 Raw Firebase data received:`, data);
                        console.log(`👥 Number of users in data: ${Object.keys(data).length}`);
                        
                        Object.entries(data).forEach(([uid, userData]) => {
                            if (userData) {
                                // Debug: Log all available fields for this user
                                console.log(`🔍 Debug user data for ${uid}:`, userData);
                                
                                // Check if this user reports to the current user (is a direct report)
                                // Can match by lineManagerId (UID), lineManager (name), or email
                                const isDirectReport = 
                                    userData.lineManagerId === testUser.uid ||
                                    userData.lineManager === currentUserName ||
                                    userData.lineManager === currentUserEmail ||
                                    userData.lineManagerEmail === currentUserEmail;
                                
                                console.log(`🔍 Checking if ${uid} is direct report:`, {
                                    lineManagerId: userData.lineManagerId,
                                    lineManager: userData.lineManager,
                                    lineManagerEmail: userData.lineManagerEmail,
                                    currentUserId: testUser.uid,
                                    currentUserName: currentUserName,
                                    currentUserEmail: currentUserEmail,
                                    isDirectReport: isDirectReport
                                });
                                
                                if (isDirectReport) {
                                    // Extract user's full name
                                    let fullName = null;
                                    
                                    // Try multiple possible name field combinations
                                    if (userData.name && userData.name.trim()) {
                                        fullName = userData.name.trim();
                                    } else if (userData.firstName && userData.lastName) {
                                        fullName = `${userData.firstName} ${userData.lastName}`.trim();
                                    } else if (userData.firstName) {
                                        fullName = userData.firstName.trim();
                                    } else if (userData.lastName) {
                                        fullName = userData.lastName.trim();
                                    } else if (userData.displayName && userData.displayName.trim()) {
                                        fullName = userData.displayName.trim();
                                    } else if (userData.fullName && userData.fullName.trim()) {
                                        fullName = userData.fullName.trim();
                                    } else if (userData['first-name'] && userData['last-name']) {
                                        fullName = `${userData['first-name']} ${userData['last-name']}`.trim();
                                    } else if (userData['first-name']) {
                                        fullName = userData['first-name'].trim();
                                    } else if (userData['last-name']) {
                                        fullName = userData['last-name'].trim();
                                    } else if (userData.email) {
                                        // Extract name from email as last resort
                                        const emailName = userData.email.split('@')[0];
                                        fullName = emailName.replace(/[._-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    } else {
                                        fullName = 'Unknown User';
                                    }
                                    
                                    fullName = cleanupName(fullName);
                                    
                                    allCompanyUsers.push({
                                        uid: uid,
                                        name: fullName,
                                        email: userData.email || '',
                                        department: userData.department || '',
                                        position: userData.position || '',
                                        jobTitle: userData.jobTitle || '',
                                        employeeId: userData.employeeId || ''
                                    });
                                    
                                    console.log(`✅ Found direct report: ${fullName} (Email: ${userData.email || 'N/A'}, UID: ${uid})`);
                                } else {
                                    console.log(`⏭️ Skipping non-direct report: ${userData.name || userData.email || uid}`);
                                }
                            }
                        });
                    }
                    
                    allCompanyUsers.sort((a, b) => a.name.localeCompare(b.name));
                    
                    let optionsHTML = '<option value="">Select Team Member</option>';
                    
                    if (allCompanyUsers.length === 0) {
                        optionsHTML += '<option value="" disabled>No direct reports found</option>';
                        console.log('⚠️ No direct reports found for current user');
                    } else {
                        console.log(`✅ Found ${allCompanyUsers.length} direct reports`);
                        console.log('📋 Direct reports to be added to dropdown:', allCompanyUsers.map(u => `${u.name} (${u.email})`));
                        
                        allCompanyUsers.forEach(employee => {
                            const displayText = employee.jobTitle ? 
                                `${employee.name} (${employee.jobTitle})` : 
                                employee.name;
                            
                            console.log(`➕ Adding user to dropdown: "${displayText}" with value: ${employee.uid}`);
                            
                            optionsHTML += `<option value="${employee.uid}" data-email="${employee.email}" data-department="${employee.department}" data-position="${employee.position}" data-job-title="${employee.jobTitle}" data-full-name="${employee.name}" data-employee-id="${employee.employeeId}">${displayText}</option>`;
                        });
                    }
                    
                    console.log('🎯 Final dropdown HTML being set:', optionsHTML);
                    globalEmployeeSelect.innerHTML = optionsHTML;
                    globalEmployeeSelect.disabled = false;
                    
                    console.log('✅ Employee dropdown populated successfully with direct reports');
                    console.log(`📊 Dropdown now has ${globalEmployeeSelect.options.length} options`);
                }, (error) => {
                    console.error('❌ Error loading direct reports:', error);
                    globalEmployeeSelect.innerHTML = '<option value="">Error loading direct reports</option>';
                    globalEmployeeSelect.disabled = false;
                });
            } catch (error) {
                console.error('❌ Error in loadEmployees:', error);
                const globalEmployeeSelect = document.getElementById('globalEmployee');
                if (globalEmployeeSelect) {
                    globalEmployeeSelect.innerHTML = '<option value="">Error loading direct reports</option>';
                    globalEmployeeSelect.disabled = false;
                }
            }
        }

        // Debug function to test company users loading
        window.testCompanyUsersLoading = function() {
            console.log('🧪 Testing company users loading...');
            console.log('👤 Current user:', window.authManager?.getUser());
            
            const dropdown = document.getElementById('globalEmployee');
            if (dropdown) {
                console.log('✅ Dropdown found');
                console.log('📋 Current options:', dropdown.innerHTML);
                console.log('📊 Options count:', dropdown.options.length);
                
                // Show current options in a more readable format
                for (let i = 0; i < dropdown.options.length; i++) {
                    const option = dropdown.options[i];
                    console.log(`  ${i}: "${option.text}" (value: ${option.value})`);
                }
            } else {
                console.error('❌ Dropdown not found');
            }
            
            // Reload employees
            console.log('🔄 Reloading employees...');
            loadEmployees();
        };

        // Debug function to directly test Firebase data
        window.testFirebaseUserData = async function() {
            console.log('🔥 Testing Firebase connection and user data structure...');
            
            try {
                const currentUser = window.authManager?.getUser();
                if (!currentUser) {
                    console.error('❌ No current user found');
                    return;
                }
                
                // Test the specific company ID from your Firebase URL
                const companyId = '-OVdOmV_CnbwZ0d7JrkB'; // From your provided URL
                console.log(`🏢 Testing with company ID: ${companyId}`);
                
                const usersRef = ref(db, `companies/${companyId}/users`);
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    console.log('✅ Successfully retrieved Firebase data:');
                    console.log('📊 Raw data structure:', data);
                    console.log(`👥 Found ${Object.keys(data).length} users in company`);
                    
                    // Analyze each user's data structure
                    Object.entries(data).forEach(([uid, userData], index) => {
                        console.log(`\n👤 User ${index + 1} (${uid}):`);
                        console.log('  Available fields:', Object.keys(userData));
                        console.log('  Full data:', userData);
                        
                        // Test name extraction
                        let testName = 'Unknown';
                        if (userData.name) testName = userData.name;
                        else if (userData.firstName && userData.lastName) testName = `${userData.firstName} ${userData.lastName}`;
                        else if (userData.firstName) testName = userData.firstName;
                        else if (userData.displayName) testName = userData.displayName;
                        else if (userData.email) testName = userData.email.split('@')[0];
                        
                        console.log(`  Extracted name: "${testName}"`);
                    });
                } else {
                    console.error('❌ No data found at the specified path');
                    console.log('🔍 Trying to find user in any company...');
                    
                    // Search all companies for the user
                    const companiesRef = ref(db, 'companies');
                    const companiesSnapshot = await get(companiesRef);
                    
                    if (companiesSnapshot.exists()) {
                        const companiesData = companiesSnapshot.val();
                        console.log('🏢 Available companies:', Object.keys(companiesData));
                        
                        for (const [cId, company] of Object.entries(companiesData)) {
                            if (company.users && company.users[currentUser.uid]) {
                                console.log(`✅ Found user in company: ${cId}`);
                                console.log('👤 User data in this company:', company.users[currentUser.uid]);
                                break;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('❌ Error testing Firebase:', error);
            }
        };

        // Simple test function to check dropdown state
        window.checkDropdownState = function() {
            console.log('🔍 Checking dropdown state...');
            const dropdown = document.getElementById('globalEmployee');
            
            if (!dropdown) {
                console.error('❌ Dropdown element not found!');
                return;
            }
            
            console.log('✅ Dropdown element found');
            console.log('📊 Number of options:', dropdown.options.length);
            console.log('🔒 Dropdown disabled:', dropdown.disabled);
            console.log('📋 Current innerHTML:', dropdown.innerHTML);
            
            // Show each option
            for (let i = 0; i < dropdown.options.length; i++) {
                const option = dropdown.options[i];
                console.log(`  Option ${i}: "${option.text}" (value: "${option.value}")`);
            }
            
            // Force reload
            console.log('🔄 Force reloading employees...');
            loadEmployees();
        };

        // Function to reload employees manually
        window.reloadEmployees = function() {
            console.log('🔄 Manually reloading employees...');
            loadEmployees();
        };

        function cleanupName(name) {
            if (!name || name.toString().trim() === '') return 'Unknown User';
            
            let cleanName = name.toString().trim().replace(/\s+/g, ' ');
            
            // Handle email-like strings
            if (cleanName.includes('@') && !cleanName.includes(' ')) {
                const emailName = cleanName.split('@')[0];
                cleanName = emailName.replace(/[._-]/g, ' ')
                    .split(' ')
                    .map(word => {
                        if (word.length === 0) return '';
                        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                    })
                    .filter(word => word.length > 0)
                    .join(' ');
            } else {
                // Handle regular names
                cleanName = cleanName.split(' ')
                    .map(word => {
                        if (word.length === 0) return '';
                        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                    })
                    .filter(word => word.length > 0)
                    .join(' ');
            }
            
            // Final validation
            return cleanName && cleanName.trim() !== '' ? cleanName : 'Unknown User';
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!validateAllKPIs()) {
                showErrorModal('Please fix the errors in the form before submitting.');
                return;
            }
            
            showLoading(true);
            
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('mode') === 'edit' || urlParams.get('edit');
            const editKpiId = urlParams.get('edit');
            
            try {
                const allKPIData = collectAllKPIData();
                
                if (isEditMode) {
                    if (editKpiId && allKPIData.length === 1) {
                        // Single KPI edit mode
                        const kpiData = allKPIData[0];
                        kpiData.id = editKpiId; // Ensure the ID is preserved
                        await updateKPI(kpiData);
                        showSuccessModal('Successfully updated KPI!');
                    } else {
                        // Multiple KPI edit mode (legacy)
                        for (const kpiData of allKPIData) {
                            await updateKPI(kpiData);
                        }
                        showSuccessModal(`Successfully updated ${allKPIData.length} KPI${allKPIData.length > 1 ? 's' : ''}!`);
                    }
                } else {
                    for (const kpiData of allKPIData) {
                        await saveKPI(kpiData);
                    }
                    showSuccessModal(`Successfully created ${allKPIData.length} KPI${allKPIData.length > 1 ? 's' : ''}!`);
                }
                
                clearDraft();
                
                setTimeout(() => {
                    window.location.href = 'kpiboard.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving KPIs:', error);
                showErrorModal(isEditMode ? 'Failed to update KPI. Please try again.' : 'Failed to create KPIs. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        function collectAllKPIData() {
            const kpiSections = document.querySelectorAll('.kpi-section');
            const allKPIData = [];
            
            kpiSections.forEach((section, index) => {
                const kpiData = collectFormDataFromSection(index);
                allKPIData.push(kpiData);
            });
            
            return allKPIData;
        }

        // Helper function to get company ID
        function getCurrentCompanyId() {
            if (currentUser && currentUser.companyId) {
                return currentUser.companyId;
            }
            
            // Fallback to default company if no companyId is found
            console.warn('⚠️ No company ID found for user, using default company');
            return 'default_company';
        }

        function collectFormDataFromSection(index) {
            const suffix = `_${index}`;
            const fields = ['kpiName', 'category', 'metricType', 'frequency', 'target', 'description'];
            const kpiData = {};
            
            // Add company ID to KPI data for company-scoped storage
            kpiData.companyId = getCurrentCompanyId();
            
            const globalEmployee = document.getElementById('globalEmployee');
            if (globalEmployee && globalEmployee.value) {
                kpiData.employee = globalEmployee.value;
                
                const selectedOption = globalEmployee.options[globalEmployee.selectedIndex];
                if (selectedOption) {
                    kpiData.employeeName = selectedOption.getAttribute('data-full-name') || 
                                           selectedOption.textContent.split(' (')[0];
                    kpiData.employeeEmail = selectedOption.getAttribute('data-email') || '';
                    kpiData.employeeDepartment = selectedOption.getAttribute('data-department') || '';
                    kpiData.employeePosition = selectedOption.getAttribute('data-position') || '';
                }
            }
            
            fields.forEach(fieldName => {
                const fieldId = `${fieldName}${suffix}`;
                const field = document.getElementById(fieldId);
                if (field) {
                    kpiData[fieldName] = field.value;
                }
            });
            
            const currentField = document.getElementById(`current${suffix}`);
            if (currentField) {
                kpiData.current = parseFloat(currentField.value) || 0;
            }
            
            kpiData.target = parseFloat(kpiData.target) || 0;
            
            const section = document.querySelector(`[data-kpi-index="${index}"]`);
            const existingKPIId = section ? section.getAttribute('data-kpi-id') : null;
            
            if (existingKPIId) {
                kpiData.id = existingKPIId;
                kpiData.updatedAt = new Date().toISOString();
                
                if (window.isEditingSelfKPIs) {
                    const originalKPIs = JSON.parse(localStorage.getItem('kpis') || '[]');
                    const originalKPI = originalKPIs.find(kpi => kpi.id === existingKPIId);
                    
                    if (originalKPI) {
                        Object.keys(originalKPI).forEach(key => {
                            if (key !== 'current' && key !== 'updatedAt') {
                                kpiData[key] = originalKPI[key];
                            }
                        });
                    }
                }
            } else {
                kpiData.id = generateKPIId();
                kpiData.createdAt = new Date().toISOString();
                if (currentUser) {
                    kpiData.createdBy = currentUser.email || currentUser.id || 'Unknown';
                    kpiData.createdByName = currentUser.name || currentUser.displayName || 'Unknown User';
                }
                kpiData.updatedAt = new Date().toISOString();
            }
            
            return kpiData;
        }

        function validateAllKPIs() {
            let isValid = true;
            
            if (!validateField('globalEmployee')) {
                isValid = false;
            }
            
            const kpiSections = document.querySelectorAll('.kpi-section');
            kpiSections.forEach((section, index) => {
                if (!validateKPISection(index)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }

        function validateKPISection(index) {
            let isValid = true;
            const requiredFields = ['kpiName', 'category', 'metricType', 'frequency', 'target'];
            
            requiredFields.forEach(fieldName => {
                const fieldId = `${fieldName}_${index}`;
                if (!validateField(fieldId)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }

        function validateField(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return false;
            
            const isCurrentValueField = fieldId.includes('current_');
            if (window.isEditingSelfKPIs && field.disabled && !isCurrentValueField) {
                return true;
            }
            
            const value = field.value.trim();
            let isValid = true;
            let errorMessage = '';
            
            if (field.hasAttribute('required') && !value) {
                isValid = false;
                errorMessage = 'This field is required.';
            } else {
                const baseFieldName = fieldId.replace(/_\d+$/, '');
                switch (baseFieldName) {
                    case 'kpiName':
                        if (value.length < 3) {
                            isValid = false;
                            errorMessage = 'KPI name must be at least 3 characters long.';
                        }
                        break;
                    case 'target':
                        if (isNaN(value) || value === '') {
                            isValid = false;
                            errorMessage = 'Please enter a valid number.';
                        }
                        break;
                }
            }
            
            if (!isValid) {
                showFieldError(fieldId, errorMessage);
            } else {
                clearError(fieldId);
            }
            
            return isValid;
        }

        function showFieldError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.add('error');
            }
        }

        function clearError(fieldId) {
            const errorElement = document.getElementById(fieldId + 'Error');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
            
            const field = document.getElementById(fieldId);
            if (field) {
                field.classList.remove('error');
            }
        }

        async function saveKPI(kpiData) {
            try {
                // Ensure company ID is included in KPI data
                if (!kpiData.companyId) {
                    kpiData.companyId = getCurrentCompanyId();
                }
                
                // Use company-scoped path: companies/{companyId}/kpis/{kpiId}
                const companyKpiRef = ref(db, `companies/${kpiData.companyId}/kpis/${kpiData.id}`);
                await set(companyKpiRef, kpiData);
                console.log('✅ KPI saved to company-scoped Firebase path:', `companies/${kpiData.companyId}/kpis/${kpiData.id}`);
            } catch (error) {
                console.warn('Firebase save failed, using localStorage fallback:', error);
                const existingKPIs = JSON.parse(localStorage.getItem('kpis') || '[]');
                existingKPIs.push(kpiData);
                localStorage.setItem('kpis', JSON.stringify(existingKPIs));
                console.log('KPI saved to localStorage');
            }
        }

        async function updateKPI(kpiData) {
            try {
                // Ensure company ID is included in KPI data
                if (!kpiData.companyId) {
                    kpiData.companyId = getCurrentCompanyId();
                }
                
                // Use company-scoped path: companies/{companyId}/kpis/{kpiId}
                const companyKpiRef = ref(db, `companies/${kpiData.companyId}/kpis/${kpiData.id}`);
                await set(companyKpiRef, kpiData);
                console.log('✅ KPI updated in company-scoped Firebase path:', `companies/${kpiData.companyId}/kpis/${kpiData.id}`);
            } catch (error) {
                console.warn('Firebase update failed, using localStorage fallback:', error);
                const existingKPIs = JSON.parse(localStorage.getItem('kpis') || '[]');
                const kpiIndex = existingKPIs.findIndex(kpi => kpi.id === kpiData.id);
                
                if (kpiIndex !== -1) {
                    existingKPIs[kpiIndex] = kpiData;
                } else {
                    existingKPIs.push(kpiData);
                }
                
                localStorage.setItem('kpis', JSON.stringify(existingKPIs));
                console.log('KPI updated in localStorage');
            }
        }

        function generateKPIId() {
            return 'kpi_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function populateFormForEdit(editData) {
            console.log('Populating form for edit:', editData);
            
            // Update page title and header for edit mode
            document.title = 'Edit KPI - Dreamex Datalab HSE';
            const headerTitle = document.querySelector('.kpi-title h2');
            if (headerTitle) {
                headerTitle.innerHTML = '<i class="fas fa-edit"></i> Edit KPI';
            }
            const headerDescription = document.querySelector('.kpi-title p');
            if (headerDescription) {
                headerDescription.textContent = 'Modify the Key Performance Indicator details';
            }
            
            // Hide the Add KPI button in edit mode
            const addKPIBtn = document.getElementById('addKPIBtn');
            if (addKPIBtn) {
                addKPIBtn.style.display = 'none';
            }
            
            // Handle both old format (with employeeId and kpis array) and new format (single KPI object)
            if (editData && editData.employeeId && editData.kpis && Array.isArray(editData.kpis)) {
                // Old format - multiple KPIs edit mode
                handleOldFormatEdit(editData);
            } else if (editData && editData.id) {
                // New format - single KPI edit mode
                handleSingleKPIEdit(editData);
            } else {
                console.error('Invalid edit data structure:', editData);
                showErrorModal('Invalid KPI data for editing');
                return;
            }
        }

        function handleSingleKPIEdit(kpiData) {
            console.log('Handling single KPI edit:', kpiData);
            
            // Set up the form for single KPI editing
            const gettingStartedSection = document.getElementById('gettingStarted');
            const kpiSectionsContainer = document.getElementById('kpiSectionsContainer');
            
            if (gettingStartedSection) {
                gettingStartedSection.style.display = 'none';
            }
            
            if (kpiSectionsContainer) {
                kpiSectionsContainer.style.display = 'block';
            }
            
            const addKPIButton = document.getElementById('addKPIBtn');
            const kpiForm = document.getElementById('kpiForm');
            const formActions = document.getElementById('formActions');
            
            if (addKPIButton) {
                addKPIButton.style.display = 'none'; // Hide in single edit mode
            }
            
            if (kpiForm) {
                kpiForm.style.display = 'block';
            }
            
            if (formActions) {
                formActions.style.display = 'flex';
            }
            
            // Set the employee dropdown if available
            const globalEmployeeSelect = document.getElementById('globalEmployee');
            if (globalEmployeeSelect && kpiData.employeeId) {
                // Check if option exists
                let optionExists = false;
                for (let i = 0; i < globalEmployeeSelect.options.length; i++) {
                    if (globalEmployeeSelect.options[i].value === kpiData.employeeId) {
                        optionExists = true;
                        break;
                    }
                }
                
                // Add option if it doesn't exist
                if (!optionExists && kpiData.employeeName) {
                    const option = document.createElement('option');
                    option.value = kpiData.employeeId;
                    option.textContent = kpiData.employeeName;
                    option.setAttribute('data-full-name', kpiData.employeeName);
                    globalEmployeeSelect.appendChild(option);
                }
                
                globalEmployeeSelect.value = kpiData.employeeId;
                globalEmployeeSelect.disabled = true;
                globalEmployeeSelect.style.backgroundColor = '#f8f9fa';
                globalEmployeeSelect.style.cursor = 'not-allowed';
                globalEmployeeSelect.title = 'Team member cannot be changed in edit mode';
                
                const changeEvent = new Event('change', { bubbles: true });
                globalEmployeeSelect.dispatchEvent(changeEvent);
            }
            
            clearExistingKPISections();
            
            // Populate the single KPI section
            setTimeout(() => {
                populateKPISection(kpiData, 0);
            }, 100);
        }

        function handleOldFormatEdit(editData) {
            console.log('Handling old format edit with multiple KPIs:', editData);
            
            const setEmployeeAndContinue = (attempts = 0) => {
                const globalEmployeeSelect = document.getElementById('globalEmployee');
                
                if (globalEmployeeSelect && globalEmployeeSelect.options.length > 1) {
                    let optionExists = false;
                    for (let i = 0; i < globalEmployeeSelect.options.length; i++) {
                        if (globalEmployeeSelect.options[i].value === editData.employeeId) {
                            optionExists = true;
                            break;
                        }
                    }
                    
                    if (!optionExists && editData.employeeName) {
                        const option = document.createElement('option');
                        option.value = editData.employeeId;
                        option.textContent = editData.employeeName;
                        option.setAttribute('data-full-name', editData.employeeName);
                        globalEmployeeSelect.insertBefore(option, globalEmployeeSelect.options[1] || null);
                    }
                    
                    globalEmployeeSelect.value = editData.employeeId;
                    globalEmployeeSelect.disabled = true;
                    globalEmployeeSelect.style.backgroundColor = '#f8f9fa';
                    globalEmployeeSelect.style.cursor = 'not-allowed';
                    globalEmployeeSelect.title = 'Team member cannot be changed in edit mode';
                    
                    const changeEvent = new Event('change', { bubbles: true });
                    globalEmployeeSelect.dispatchEvent(changeEvent);
                    
                    setTimeout(() => {
                        continueFormPopulation(editData);
                    }, 100);
                    
                } else if (attempts < 50) {
                    setTimeout(() => setEmployeeAndContinue(attempts + 1), 100);
                } else {
                    console.error('Employee dropdown failed to load after 5 seconds');
                    continueFormPopulation(editData);
                }
            };
            
            setEmployeeAndContinue();
        }

        function continueFormPopulation(editData) {
            console.log('=== Starting continueFormPopulation ===');
            
            const gettingStartedSection = document.getElementById('gettingStarted');
            const kpiSectionsContainer = document.getElementById('kpiSectionsContainer');
            
            if (gettingStartedSection) {
                gettingStartedSection.style.display = 'none';
            }
            
            if (kpiSectionsContainer) {
                kpiSectionsContainer.style.display = 'block';
            }
            
            const addKPIButton = document.getElementById('addKPIBtn');
            const kpiForm = document.getElementById('kpiForm');
            const formActions = document.getElementById('formActions');
            
            if (addKPIButton) {
                addKPIButton.style.display = 'block';
                addKPIButton.innerHTML = '<i class="fas fa-plus"></i> Add Another KPI';
                
                if (window.isEditingSelfKPIs) {
                    addKPIButton.disabled = true;
                    addKPIButton.style.opacity = '0.5';
                    addKPIButton.title = 'Cannot add KPIs to your own evaluation';
                }
            }
            
            if (kpiForm) {
                kpiForm.style.display = 'block';
            }
            
            if (formActions) {
                formActions.style.display = 'flex';
            }
            
            clearExistingKPISections();
            
            if (editData.kpis && editData.kpis.length > 0) {
                editData.kpis.forEach((kpi, index) => {
                    if (index === 0) {
                        setTimeout(() => {
                            populateKPISection(kpi, 0);
                        }, 20);
                    } else {
                        if (typeof window.addKPISection === 'function') {
                            window.addKPISection();
                            setTimeout(() => {
                                populateKPISection(kpi, index);
                            }, 50);
                        }
                    }
                });
                
                setTimeout(() => {
                    if (typeof window.updateKPINumbers === 'function') {
                        window.updateKPINumbers();
                    }
                }, 100);
                
                const formTitle = document.querySelector('.kpi-title h2');
                if (formTitle) {
                    formTitle.innerHTML = `<i class="fas fa-edit"></i> Edit KPIs for ${editData.employeeName}`;
                }
                
                const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
                const isEditingSelf = currentUser && (
                    currentUser.uid === editData.employeeId || 
                    currentUser.id === editData.employeeId ||
                    currentUser.email === editData.employeeEmail
                );
                
                window.isEditingSelfKPIs = isEditingSelf;
                
                const submitButton = document.querySelector('button[type="submit"]');
                if (submitButton) {
                    if (window.isEditingSelfKPIs) {
                        submitButton.innerHTML = '<i class="fas fa-save"></i> Update Current Values Only';
                        submitButton.title = 'You can only update current values, not KPI details';
                    } else {
                        submitButton.innerHTML = '<i class="fas fa-save"></i> Update All KPIs';
                    }
                }
            }
        }

        function populateKPISection(data, index) {
            const suffix = `_${index}`;
            
            if (!data) {
                console.error(`No KPI data provided for section ${index}`);
                return;
            }
            
            const fieldMappings = {
                'kpiName': data.name || data.kpiName,
                'category': data.category,
                'metricType': data.metricType,
                'frequency': data.frequency,
                'target': data.target,
                'current': data.current,
                'description': data.description
            };
            
            Object.entries(fieldMappings).forEach(([fieldName, value]) => {
                const fieldId = `${fieldName}${suffix}`;
                const field = document.getElementById(fieldId);
                
                if (field && value !== undefined && value !== null) {
                    field.value = value;
                    
                    if (window.isEditingSelfKPIs && fieldName !== 'current') {
                        field.disabled = true;
                        field.style.backgroundColor = '#f8f9fa';
                        field.style.cursor = 'not-allowed';
                        field.title = 'Cannot edit your own KPI details';
                    }
                }
            });
            
            if (data.id) {
                const section = document.querySelector(`[data-kpi-index="${index}"]`);
                if (section) {
                    section.setAttribute('data-kpi-id', data.id);
                }
            }
        }

        function clearExistingKPISections() {
            const kpiSectionsContainer = document.querySelector('#kpiSectionsContainer');
            if (kpiSectionsContainer) {
                const sections = kpiSectionsContainer.querySelectorAll('.kpi-section');
                
                for (let i = 1; i < sections.length; i++) {
                    sections[i].remove();
                }
                
                if (sections.length > 0) {
                    const firstSection = sections[0];
                    firstSection.style.display = 'block';
                    
                    const inputs = firstSection.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    });
                    
                    const errorMessages = firstSection.querySelectorAll('.error-message');
                    errorMessages.forEach(error => error.textContent = '');
                }
            }
            
            if (typeof window.kpiCounter !== 'undefined') {
                window.kpiCounter = 0;
            }
        }

        function enableAutoSave() {
            const form = document.getElementById('kpiForm');
            if (!form) return;
            
            let autoSaveTimeout;
            
            form.addEventListener('input', () => {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    if (!isDraftSaving) {
                        saveDraft();
                    }
                }, 30000);
            });
        }

        function saveDraft() {
            if (isDraftSaving) return;
            
            isDraftSaving = true;
            const allKPIData = collectAllKPIData();
            const globalEmployee = document.getElementById('globalEmployee');
            
            const draftData = {
                globalEmployee: globalEmployee ? globalEmployee.value : '',
                kpis: allKPIData
            };
            
            localStorage.setItem('kpiDraft', JSON.stringify(draftData));
            
            setTimeout(() => {
                isDraftSaving = false;
            }, 2000);
        }

        function clearDraft() {
            localStorage.removeItem('kpiDraft');
        }

        function loadKPISchedule() {
            try {
                const savedSchedule = localStorage.getItem('kpiSchedule');
                const sessionSchedule = sessionStorage.getItem('currentKPISchedule');
                
                let schedule = null;
                
                if (sessionSchedule) {
                    schedule = JSON.parse(sessionSchedule);
                } else if (savedSchedule) {
                    schedule = JSON.parse(savedSchedule);
                }
                
                if (schedule) {
                    console.log('KPI schedule loaded:', schedule);
                }
            } catch (error) {
                console.error('Error loading KPI schedule:', error);
            }
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function showSuccessModal(message = 'KPI created successfully!') {
            const modal = document.getElementById('successModal');
            if (modal) {
                const messageElement = modal.querySelector('.modal-body p');
                if (messageElement) {
                    messageElement.textContent = message;
                }
                openModal('successModal');
            }
        }

        function showErrorModal(message) {
            const modal = document.getElementById('errorModal');
            if (modal) {
                const messageElement = document.getElementById('errorMessage');
                if (messageElement) {
                    messageElement.textContent = message;
                }
                openModal('errorModal');
            }
        }

        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
        }

        function viewKPIBoard() {
            closeModal('successModal');
            window.location.href = 'kpiboard.html';
        }

        function resetForm() {
            const form = document.getElementById('kpiForm');
            if (form) {
                form.reset();
            }
            clearExistingKPISections();
            clearDraft();
        }

        // Global functions for HTML onclick events
        window.closeModal = closeModal;
        window.showSuccessModal = showSuccessModal;
        window.showErrorModal = showErrorModal;
        window.viewKPIBoard = viewKPIBoard;
        window.resetForm = resetForm;
        window.saveDraft = saveDraft;
        window.validateField = validateField;
        window.clearError = clearError;

        // Export for use in other modules
        window.saveKPI = saveKPI;
        window.generateKPIId = generateKPIId;
        window.collectAllKPIData = collectAllKPIData;
        window.validateAllKPIs = validateAllKPIs;
        window.setupKPIEventListeners = setupKPIEventListeners;
        window.loadKPISchedule = loadKPISchedule;

        // Make menu visibility functions available globally
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;
        window.showBasicMenu = showBasicMenu;
        window.resetMenuVisibility = resetMenuVisibility;

        console.log('✅ KPI form application initialized successfully');
    </script>
    <script type="module">
        // Import Firebase functions
        import { db, saveKPIEvaluation, subscribeToKPIEvaluation } from './js/firebase-config.js';
        import { ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        
        // Make Firebase functions available globally
        window.firebaseDb = db;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseOnValue = onValue;
        window.firebaseUpdate = update;
        window.firebaseGet = get;
        window.saveKPIEvaluation = saveKPIEvaluation;
        window.subscribeToKPIEvaluation = subscribeToKPIEvaluation;
        
        // Test Firebase connection
        console.log('Firebase initialized:', !!db);
    </script>
    <script>
        // Global variables for managing KPI sections
        let kpiCounter = 0;
        let employeeOptions = '';
        let currentTab = 'assignment';
        let employeeKPIs = [];

        // Tab switching functionality
        function switchTab(tabName) {
            // Clean up any existing Firebase listeners when switching away from evaluation tabs
            if (currentTab === 'evaluation' && tabName !== 'evaluation') {
                if (window.currentEvaluationListener) {
                    console.log('Cleaning up Firebase listener for evaluation tab');
                    window.currentEvaluationListener();
                    window.currentEvaluationListener = null;
                }
            }
            
            if (currentTab === 'yearEnd' && tabName !== 'yearEnd') {
                if (window.currentYearEndEvaluationListener) {
                    console.log('Cleaning up Firebase listener for year-end evaluation tab');
                    window.currentYearEndEvaluationListener();
                    window.currentYearEndEvaluationListener = null;
                }
            }
            
            // Update tab buttons with smooth transition
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Small delay for visual feedback
            setTimeout(() => {
                document.getElementById(tabName + 'Tab').classList.add('active');
            }, 50);
            
            // Update tab content
            document.querySelectorAll('.tab-content-section').forEach(content => {
                content.classList.remove('active');
            });
            
            // Delay content switch for smoother transition
            setTimeout(() => {
                document.getElementById(tabName + 'Content').classList.add('active');
            }, 100);
            
            currentTab = tabName;
            
            // Handle evaluation tab logic with slight delay
            if (tabName === 'evaluation') {
                setTimeout(() => {
                    handleEvaluationTabSwitch();
                }, 150);
            } else if (tabName === 'yearEnd') {
                setTimeout(() => {
                    handleYearEndTabSwitch();
                }, 150);
            }
            
            // Reapply field restrictions based on schedule after tab switch
            setTimeout(() => {
                if (typeof reapplyAssignmentFieldRestrictions === 'function') {
                    reapplyAssignmentFieldRestrictions();
                }
            }, 200);
            
            // Track user interaction with tabs for schedule logic
            sessionStorage.setItem('userInteractedWithTabs', 'true');
        }

        // Handle evaluation tab switch - check if team member is selected in assignment tab
        function handleEvaluationTabSwitch() {
            const globalEmployee = document.getElementById('globalEmployee');
            const noEmployeeMessage = document.getElementById('noEmployeeSelectedMessage');
            const currentEmployeeInfo = document.getElementById('currentEmployeeInfo');
            const evaluationList = document.getElementById('kpiEvaluationList');
            
            if (globalEmployee && globalEmployee.value) {
                // Team member is selected, show evaluation
                const selectedOption = globalEmployee.options[globalEmployee.selectedIndex];
                const employeeName = selectedOption.textContent;
                
                // Hide no employee message, show current employee info
                noEmployeeMessage.style.display = 'none';
                currentEmployeeInfo.style.display = 'block';
                
                // Update employee name
                document.getElementById('currentEmployeeName').textContent = employeeName;
                
                // Load KPIs for this team member - always try to load regardless of period restrictions
                loadEmployeeKPIsForEvaluation(globalEmployee.value);
            } else {
                // No team member selected, show message
                noEmployeeMessage.style.display = 'block';
                currentEmployeeInfo.style.display = 'none';
                evaluationList.style.display = 'none';
                
                // Hide mid-year performance summary when no employee is selected
                const midYearSummarySection = document.getElementById('overallPerformanceSummaryMidYear');
                if (midYearSummarySection) {
                    midYearSummarySection.style.display = 'none';
                }
                
                // Hide team member comments section when no employee is selected
                // Note: Now using per-KPI comments instead of global section
            }
        }

        // Load KPIs for selected employee evaluation (updated to use real data)
        function loadEmployeeKPIsForEvaluation(employeeId) {
            const kpiList = document.getElementById('employeeKPIsList');
            const evaluationList = document.getElementById('kpiEvaluationList');
            const evaluationActions = document.getElementById('evaluationActions');
            
            if (!employeeId) {
                evaluationList.style.display = 'none';
                
                // Hide mid-year performance summary when no employee ID
                const midYearSummarySection = document.getElementById('overallPerformanceSummaryMidYear');
                if (midYearSummarySection) {
                    midYearSummarySection.style.display = 'none';
                }
                
                // Remove any existing Firebase listener
                if (window.currentEvaluationListener) {
                    window.currentEvaluationListener();
                    window.currentEvaluationListener = null;
                }
                // Hide team member comments section when no employee ID
                // Note: Now using per-KPI comments instead of global section
                return;
            }
            
            evaluationList.style.display = 'block';
            
            // Set up Firebase real-time listener for mid-year evaluation
            setupFirebaseEvaluationListener(employeeId);
            
            // Always try to get KPIs from the current form (Assignment tab) first, even if assignment period is overdue
            const currentFormKPIs = getCurrentFormKPIsForTeamMember(employeeId);
            
            if (currentFormKPIs && currentFormKPIs.length > 0) {
                // Use KPIs from current form - this works even when assignment period is overdue
                console.log('Using KPIs from current form for mid-year evaluation:', currentFormKPIs);
                employeeKPIs = currentFormKPIs;
                renderKPIEvaluationCards(currentFormKPIs);
                evaluationActions.style.display = 'flex';
                
                // Show team member comments section
                // Note: Now using per-KPI comments instead of global section
                
                return; // Successfully loaded from current form
            }
            
            // If no KPIs in current form, try to load from Firebase/localStorage
            loadKPIsFromDatabase(employeeId);
        }

        // Get KPIs from the current form for the specified team member
        function getCurrentFormKPIsForTeamMember(employeeId) {
            const globalEmployee = document.getElementById('globalEmployee');
            
            // Check if the current form employee matches the requested employee
            if (!globalEmployee || globalEmployee.value !== employeeId) {
                return [];
            }
            
            // Collect KPI data from all visible sections, regardless of whether fields are disabled
            const kpiSections = document.querySelectorAll('.kpi-section');
            const formKPIs = [];
            
            kpiSections.forEach((section, index) => {
                // Check if section has data by looking at the KPI name field
                const kpiNameField = document.getElementById(`kpiName_${index}`);
                if (kpiNameField && kpiNameField.value.trim()) {
                    const kpiData = {
                        id: `form_${index}`,
                        name: kpiNameField.value,
                        category: document.getElementById(`category_${index}`)?.value || '',
                        target: parseFloat(document.getElementById(`target_${index}`)?.value) || 0,
                        current: parseFloat(document.getElementById(`current_${index}`)?.value) || 0,
                        frequency: document.getElementById(`frequency_${index}`)?.value || '',
                        description: document.getElementById(`description_${index}`)?.value || '',
                        metricType: document.getElementById(`metricType_${index}`)?.value || ''
                    };
                    
                    // Add KPI if it has a name and category (basic validation)
                    if (kpiData.name && kpiData.category) {
                        formKPIs.push(kpiData);
                    }
                }
            });
            
            console.log(`Found ${formKPIs.length} KPIs for team member ${employeeId} in current form`);
            return formKPIs;
        }

        // Load KPIs from database (Firebase/localStorage fallback)
        function loadKPIsFromDatabase(employeeId) {
            console.log('Loading KPIs from database for employee:', employeeId);
            
            // Try Firebase first, then localStorage
            try {
                // Firebase implementation would go here
                // For now, check localStorage
                const storedKPIs = JSON.parse(localStorage.getItem('kpis') || '[]');
                const employeeKPIs = storedKPIs.filter(kpi => kpi.employee === employeeId);
                
                if (employeeKPIs.length > 0) {
                    console.log('Found KPIs in localStorage:', employeeKPIs);
                    window.employeeKPIs = employeeKPIs;
                    renderKPIEvaluationCards(employeeKPIs);
                    document.getElementById('evaluationActions').style.display = 'flex';
                    
                    // Show team member comments section
                    // Note: Now using per-KPI comments instead of global section
                } else {
                    // No KPIs found, show message
                    showNoKPIsMessage();
                }
            } catch (error) {
                console.error('Error loading KPIs from database:', error);
                showNoKPIsMessage();
            }
        }

        // Show message when no KPIs are found
        function showNoKPIsMessage() {
            const kpiList = document.getElementById('employeeKPIsList');
            
            // Check if assignment period is overdue by looking for schedule info
            const isAssignmentOverdue = window.kpiScheduleInfo && 
                window.kpiScheduleInfo.today > window.kpiScheduleInfo.schedule?.assignmentEndDate;
            
            let messageContent;
            if (isAssignmentOverdue) {
                messageContent = `
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="info-content">
                            <h4>Assignment Period Ended</h4>
                            <p>The KPI assignment period has ended. No KPIs were created for this team member during the assignment period. To evaluate this team member, KPIs must be assigned in the Assignment tab first.</p>
                            <button type="button" class="btn btn-secondary" onclick="switchTab('assignment')">
                                <i class="fas fa-eye"></i> View Assignment Tab
                            </button>
                        </div>
                    </div>
                `;
            } else {
                messageContent = `
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="info-content">
                            <h4>No KPIs Found</h4>
                            <p>No KPIs have been created for this team member yet. Create KPIs in the Assignment tab first.</p>
                            <button type="button" class="btn btn-primary" onclick="switchTab('assignment')">
                                <i class="fas fa-plus"></i> Create KPIs
                            </button>
                        </div>
                    </div>
                `;
            }
            
            kpiList.innerHTML = `<div class="no-kpis-message">${messageContent}</div>`;
            document.getElementById('evaluationActions').style.display = 'none';
            
            // Hide mid-year performance summary when no KPIs are found
            const midYearSummarySection = document.getElementById('overallPerformanceSummaryMidYear');
            if (midYearSummarySection) {
                midYearSummarySection.style.display = 'none';
            }
            
            // Hide team member comments section when no KPIs
            // Note: Now using per-KPI comments instead of global section
        }

        // Render KPI evaluation cards
        function renderKPIEvaluationCards(kpis) {
            const container = document.getElementById('employeeKPIsList');
            
            // Check if user is evaluating their own KPIs
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            const globalEmployee = document.getElementById('globalEmployee');
            const selectedEmployeeId = globalEmployee ? globalEmployee.value : null;
            
            const isEvaluatingSelf = currentUser && selectedEmployeeId && (
                currentUser.uid === selectedEmployeeId || 
                currentUser.id === selectedEmployeeId
            );
            
            container.innerHTML = kpis.map(kpi => {
                const performance = calculateKPIPerformance(kpi);
                
                // Determine if fields should be disabled for self-evaluation
                const disabledAttr = isEvaluatingSelf ? 'disabled' : '';
                const disabledStyle = isEvaluatingSelf ? 'style="background-color: #f8f9fa; cursor: not-allowed; opacity: 0.7;"' : '';
                const disabledTitle = isEvaluatingSelf ? 'title="You cannot edit your own evaluation fields"' : '';
                
                return `
                    <div class="kpi-evaluation-card" data-kpi-id="${kpi.id}">
                        <div class="kpi-eval-header">
                            <div class="kpi-eval-info">
                                <h5>${kpi.name}</h5>
                                <p>${kpi.description}</p>
                            </div>
                        </div>
                        
                        <div class="kpi-eval-body">
                            <!-- Current Value Section -->
                            <div class="eval-feedback">
                                <div class="eval-feedback-header">
                                    <h5><i class="fas fa-chart-bar"></i> Current Performance</h5>
                                </div>
                                <div class="feedback-group">
                                    <label for="currentValue_${kpi.id}">
                                        Current Value ${isEvaluatingSelf ? '' : '<span style="color: #dc3545;">*</span>'}
                                    </label>
                                    <input type="number" id="currentValue_${kpi.id}" class="form-control" 
                                           step="0.01" 
                                           placeholder="Enter current value achieved (e.g., ${kpi.target || '100'})"
                                           ${isEvaluatingSelf ? 'disabled' : ''} 
                                           ${isEvaluatingSelf ? 'style="background-color: #f8f9fa; cursor: not-allowed; opacity: 0.7;"' : ''}
                                           ${isEvaluatingSelf ? 'title="You cannot edit evaluation fields"' : ''}
                                           onchange="saveCurrentValue('${kpi.id}', this.value, 'midyear')" />
                                    <small class="form-hint">Target: ${kpi.target || 'Not set'} ${kpi.metricType ? '(' + kpi.metricType + ')' : ''}</small>
                                </div>
                            </div>

                            <div class="eval-feedback">
                                <div class="eval-feedback-header">
                                    <h5><i class="fas fa-clipboard-check"></i> Mid-Year Evaluation</h5>
                                </div>

                                ${isEvaluatingSelf ? `
                                    <div class="eval-restriction-notice">
                                        <i class="fas fa-lock"></i>
                                        <div>
                                            <strong>Self-Evaluation Restricted:</strong> You cannot edit your own mid-year evaluation fields.
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="eval-feedback-grid">
                                    <!-- Mid-Year Feedback Section -->
                                    <div class="feedback-section midyear-feedback-section">
                                        <div class="feedback-section-header">
                                            <h6><i class="fas fa-comment-dots"></i> Performance Feedback</h6>
                                            <span class="section-badge">Mid-Year</span>
                                        </div>
                                        <div class="feedback-group">
                                            <label for="feedback_${kpi.id}">
                                                Supervisor Feedback ${isEvaluatingSelf ? '<i class="fas fa-lock" style="margin-left: 4px; color: #6c757d;"></i>' : ''}
                                            </label>
                                            <textarea id="feedback_${kpi.id}" rows="4" 
                                                      placeholder="${isEvaluatingSelf ? 'Self-evaluation not allowed' : 'Provide detailed feedback on performance, achievements, challenges, and observations for this KPI...'}"
                                                      ${disabledAttr} ${disabledStyle} ${disabledTitle}></textarea>
                                        </div>
                                    </div>

                                    <!-- Action Plan Section -->
                                    <div class="feedback-section action-plan-section">
                                        <div class="feedback-section-header">
                                            <h6><i class="fas fa-tasks"></i> Improvement Plan</h6>
                                            <span class="section-badge">Action Items</span>
                                        </div>
                                        <div class="feedback-group">
                                            <label for="actionPlan_${kpi.id}">
                                                Development Action Plan ${isEvaluatingSelf ? '<i class="fas fa-lock" style="margin-left: 4px; color: #6c757d;"></i>' : ''}
                                            </label>
                                            <textarea id="actionPlan_${kpi.id}" rows="3" 
                                                      placeholder="${isEvaluatingSelf ? 'Self-evaluation not allowed' : 'Outline specific actions, training needs, resources, or support required to improve performance on this KPI...'}"
                                                      ${disabledAttr} ${disabledStyle} ${disabledTitle}></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Team Member Comments for this KPI -->
                            <div class="kpi-team-comments" id="kpiComments_${kpi.id}">
                                <div class="comments-header">
                                </div>
                                <div class="comments-body">
                                    <div class="feedback-group">
                                        <label for="kpiComment_${kpi.id}">Your Comments & Self-Assessment</label>
                                        <textarea id="kpiComment_${kpi.id}" rows="3" 
                                                  placeholder="${isEvaluatingSelf ? 'Share your thoughts on this KPI performance, challenges, achievements, or context...' : 'Team member comments (view only)'}"
                                                  ${!isEvaluatingSelf ? 'disabled' : ''}
                                                  ${!isEvaluatingSelf ? 'style="background-color: #f8f9fa; cursor: not-allowed; opacity: 0.7;"' : ''}
                                                  ${!isEvaluatingSelf ? 'title="You can only view team member comments"' : ''}
                                                  onchange="saveKPIComment('${kpi.id}', this.value)"></textarea>
                                    </div>
                                    ${isEvaluatingSelf ? `
                                        <div class="comment-actions">
                                            <button type="button" class="btn btn-outline btn-xs" onclick="clearKPIComment('${kpi.id}')">
                                                <i class="fas fa-eraser"></i> Clear
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Load KPI-specific comments after rendering
            setTimeout(() => {
                kpis.forEach(kpi => {
                    loadKPIComment(kpi.id);
                });
            }, 100);
            
            // Make employeeKPIs available globally for other functions
            window.employeeKPIs = kpis;
            
            // Ensure all autofill fields are properly initialized
            setTimeout(() => {
                kpis.forEach(kpi => {
                    // Trigger a refresh of all metric fields for each KPI (always update, even if current is 0)
                    const currentValue = kpi.current || 0;
                    updateKPIValue(kpi.id, currentValue);
                });
            }, 100);
            
            // Calculate and display mid-year performance summary
            setTimeout(() => {
                calculateAndDisplayMidYearPerformance(kpis);
            }, 150);
            
            // If evaluating self, update the action buttons for self-evaluation
            if (isEvaluatingSelf) {
                setTimeout(() => {
                    const evaluationActions = document.getElementById('evaluationActions');
                    if (evaluationActions) {
                        const buttons = evaluationActions.querySelectorAll('button');
                        buttons.forEach(button => {
                            if (button.onclick && 
                                (button.onclick.toString().includes('submitEvaluation') || 
                                 button.onclick.toString().includes('saveEvaluationDraft'))) {
                                
                                // For submit button, allow team members to submit their comments
                                if (button.innerHTML.includes('Submit')) {
                                    button.disabled = false;
                                    button.style.opacity = '1';
                                    button.style.cursor = 'pointer';
                                    button.title = 'Submit your team member comments for evaluation';
                                    button.innerHTML = '<i class="fas fa-comment"></i> Submit My Comments';
                                    button.classList.remove('btn-primary');
                                    button.classList.add('btn-success');
                                } else if (button.innerHTML.includes('Save Draft')) {
                                    // Disable save draft for self-evaluation (comments auto-save)
                                    button.disabled = true;
                                    button.style.opacity = '0.5';
                                    button.style.cursor = 'not-allowed';
                                    button.title = 'Comments are automatically saved as you type';
                                    button.innerHTML = '<i class="fas fa-info-circle"></i> Auto-Saved';
                                }
                            }
                        });
                    }
                }, 100);
            }
            
            // Load saved current values after rendering
            setTimeout(() => {
                if (selectedEmployeeId) {
                    loadSavedCurrentValues(selectedEmployeeId);
                }
            }, 200);
        }

        // Calculate KPI performance
        function calculateKPIPerformance(kpi) {
            // Handle edge cases
            if (!kpi || (!kpi.current && kpi.current !== 0) || !kpi.target || kpi.target === 0) {
                return { score: 0, label: 'No Target', class: 'poor' };
            }
            
            const score = Math.round((kpi.current / kpi.target) * 100);
            
            if (score >= 100) {
                return { score, label: 'Excellent', class: 'excellent' };
            } else if (score >= 80) {
                return { score, label: 'Good', class: 'good' };
            } else if (score >= 60) {
                return { score, label: 'Average', class: 'average' };
            } else {
                return { score, label: 'Poor', class: 'poor' };
            }
        }

        // Format KPI value based on metric type
        function formatKPIValue(value, metricType) {
            if (!value && value !== 0) return 'N/A';
            
            switch (metricType) {
                case 'Percentage':
                    return value + '%';
                case 'Currency':
                    return '$' + value.toLocaleString();
                case 'Time':
                    return value + ' hrs';
                default:
                    return value.toLocaleString();
            }
        }

        // Update KPI value and recalculate performance
        function updateKPIValue(kpiId, newValue) {
            // Check if user is evaluating their own KPIs
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            const globalEmployee = document.getElementById('globalEmployee');
            const selectedEmployeeId = globalEmployee ? globalEmployee.value : null;
            
            const isEvaluatingSelf = currentUser && selectedEmployeeId && (
                currentUser.uid === selectedEmployeeId || 
                currentUser.id === selectedEmployeeId
            );
            
            // Prevent self-evaluation
            if (isEvaluatingSelf) {
                console.log('Preventing self-evaluation: User cannot update their own KPI values');
                return;
            }
            
            const kpi = employeeKPIs.find(k => k.id === kpiId);
            if (kpi) {
                kpi.current = parseFloat(newValue);
                const performance = calculateKPIPerformance(kpi);
                
                // Update the performance display
                const card = document.querySelector(`[data-kpi-id="${kpiId}"]`);
                const scoreElement = card.querySelector('.performance-score');
                scoreElement.textContent = performance.score + '%';
                scoreElement.className = 'performance-score ' + performance.class;
                scoreElement.nextElementSibling.textContent = performance.label;
                
                // Update metrics
                const currentValueSpan = card.querySelector('.metric-row:nth-child(2) .metric-value');
                currentValueSpan.textContent = formatKPIValue(kpi.current, kpi.metricType);
                
                const varianceSpan = card.querySelector('.metric-row:nth-child(3) .metric-value');
                const variance = kpi.target && kpi.target !== 0 ? 
                    ((kpi.current - kpi.target) / kpi.target * 100).toFixed(1) : '0.0';
                varianceSpan.textContent = (kpi.current >= kpi.target ? '+' : '') + variance + '%';
                varianceSpan.className = 'metric-value ' + (kpi.current >= kpi.target ? 'text-success' : 'text-danger');
                
                const progressSpan = card.querySelector('.metric-row:nth-child(4) .metric-value');
                progressSpan.textContent = kpi.target && kpi.target !== 0 ? 
                    ((kpi.current / kpi.target) * 100).toFixed(1) + '%' : '0.0%';
                
                // Update mid-year performance summary in real-time
                if (window.employeeKPIs) {
                    setTimeout(() => {
                        calculateAndDisplayMidYearPerformance(window.employeeKPIs);
                    }, 100);
                }
            }
        }

        // Debounced version of updateKPIValue for real-time input updates
        let midYearDebounceTimeout;
        function updateKPIValueDebounced(kpiId, newValue) {
            clearTimeout(midYearDebounceTimeout);
            midYearDebounceTimeout = setTimeout(() => {
                updateKPIValue(kpiId, newValue);
            }, 300); // 300ms delay for smoother input experience
        }

        // Evaluation action functions
        function saveEvaluationDraft() {
            console.log('Saving evaluation draft...');
            
            // Get current team member info
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                showErrorMessage('Please select a team member before saving draft.');
                return;
            }
            
            const employeeId = globalEmployee.value;
            const employeeName = globalEmployee.options[globalEmployee.selectedIndex].textContent;
            
            // Check if user is evaluating their own KPIs
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            const isEvaluatingSelf = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            // Prevent self-evaluation
            if (isEvaluatingSelf) {
                showErrorMessage('You cannot save a draft for your own evaluation.');
                return;
            }
            
            // Collect current evaluation data
            const draftData = {
                employeeId: employeeId,
                employeeName: employeeName,
                evaluationType: 'midYear',
                lastSaved: new Date().toISOString(),
                isDraft: true,
                evaluations: []
            };
            
            // Get all KPI evaluation cards
            const kpiCards = document.querySelectorAll('#employeeKPIsList .kpi-evaluation-card');
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                const kpiName = card.querySelector('.kpi-eval-info h5').textContent.trim();
                
                // Get current value
                const currentValueInput = card.querySelector(`#currentValue_${kpiId}`);
                const currentValue = currentValueInput ? parseFloat(currentValueInput.value) || 0 : 0;
                
                // Get feedback
                const feedbackTextarea = card.querySelector(`#feedback_${kpiId}`);
                const feedback = feedbackTextarea ? feedbackTextarea.value.trim() : '';
                
                // Get action plan
                const actionPlanTextarea = card.querySelector(`#actionPlan_${kpiId}`);
                const actionPlan = actionPlanTextarea ? actionPlanTextarea.value.trim() : '';
                
                // Find the original KPI data
                const originalKPI = employeeKPIs.find(k => k.id === kpiId);
                
                if (originalKPI) {
                    draftData.evaluations.push({
                        kpiId: kpiId,
                        kpiName: kpiName,
                        originalTarget: originalKPI.target,
                        updatedCurrentValue: currentValue,
                        feedback: feedback,
                        actionPlan: actionPlan
                    });
                }
            });
            
            if (draftData.evaluations.length === 0) {
                showErrorMessage('No KPI data found to save.');
                return;
            }
            
            // Save draft to localStorage
            try {
                const existingDrafts = JSON.parse(localStorage.getItem('kpiEvaluationDrafts') || '[]');
                
                // Remove existing draft for this employee and type
                const filteredDrafts = existingDrafts.filter(
                    draft => !(draft.employeeId === employeeId && draft.evaluationType === 'midYear')
                );
                
                // Add new draft
                filteredDrafts.push(draftData);
                localStorage.setItem('kpiEvaluationDrafts', JSON.stringify(filteredDrafts));
                
                // Show success feedback
                const saveButton = document.querySelector('button[onclick="saveEvaluationDraft()"]');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="fas fa-check"></i> Saved!';
                saveButton.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.backgroundColor = '';
                }, 2000);
                
                console.log('Draft saved:', draftData);
                
            } catch (error) {
                console.error('Error saving draft:', error);
                showErrorMessage('Failed to save draft. Please try again.');
            }
        }

        function submitEvaluation() {
            console.log('Submitting evaluation...');
            
            // Get current team member info
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                showErrorMessage('Please select a team member before submitting evaluation.');
                return;
            }
            
            const employeeId = globalEmployee.value;
            const employeeName = globalEmployee.options[globalEmployee.selectedIndex].textContent;
            
            // Check if user is evaluating their own KPIs
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            const isEvaluatingSelf = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            // Handle self-evaluation differently - allow submitting own comments
            if (isEvaluatingSelf) {
                submitSelfEvaluation(employeeId, employeeName);
                return;
            }
            
            // Collect evaluation data from all KPI cards
            const evaluationData = {
                employeeId: employeeId,
                employeeName: employeeName,
                evaluationType: 'midYear',
                submissionDate: new Date().toISOString(),
                evaluations: []
            };
            
            // Get all KPI evaluation cards
            const kpiCards = document.querySelectorAll('#employeeKPIsList .kpi-evaluation-card');
            let hasValidData = false;
            let missingFeedback = [];
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                const kpiName = card.querySelector('.kpi-eval-info h5').textContent.trim();
                
                // Get current value
                const currentValueInput = card.querySelector(`#currentValue_${kpiId}`);
                const currentValue = currentValueInput ? parseFloat(currentValueInput.value) || 0 : 0;
                
                // Get feedback
                const feedbackTextarea = card.querySelector(`#feedback_${kpiId}`);
                const feedback = feedbackTextarea ? feedbackTextarea.value.trim() : '';
                
                // Get action plan
                const actionPlanTextarea = card.querySelector(`#actionPlan_${kpiId}`);
                const actionPlan = actionPlanTextarea ? actionPlanTextarea.value.trim() : '';
                
                // Find the original KPI data
                const originalKPI = employeeKPIs.find(k => k.id === kpiId);
                
                if (originalKPI) {
                    const evaluationEntry = {
                        kpiId: kpiId,
                        kpiName: kpiName,
                        originalTarget: originalKPI.target,
                        updatedCurrentValue: currentValue,
                        feedback: feedback,
                        actionPlan: actionPlan,
                        performance: calculateKPIPerformance({
                            current: currentValue,
                            target: originalKPI.target
                        })
                    };
                    
                    evaluationData.evaluations.push(evaluationEntry);
                    
                    // Check if feedback is provided (optional but recommended)
                    if (!feedback) {
                        missingFeedback.push(kpiName);
                    } else {
                        hasValidData = true;
                    }
                }
            });
            
            // Validation
            if (evaluationData.evaluations.length === 0) {
                showErrorMessage('No KPI data found to submit. Please ensure KPIs are loaded properly.');
                return;
            }
            
            // Show warning about missing feedback but allow submission
            if (missingFeedback.length > 0) {
                const continueSubmission = confirm(
                    `The following KPIs are missing feedback:\n${missingFeedback.join(', ')}\n\nDo you want to continue with the submission anyway?`
                );
                if (!continueSubmission) {
                    return;
                }
            }
            
            // Show loading state
            const submitButton = document.querySelector('button[onclick="submitEvaluation()"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            // Simulate submission process - now with Firebase
            setTimeout(async () => {
                try {
                    // Save to Firebase
                    const evaluationRef = window.firebaseRef(window.firebaseDb, `kpiEvaluations/${employeeId}/midYear`);
                    await window.firebaseSet(evaluationRef, evaluationData);
                    
                    console.log('Mid-year evaluation saved to Firebase');
                    
                    // Also save to localStorage for offline access
                    const existingEvaluations = JSON.parse(localStorage.getItem('kpiEvaluations') || '[]');
                    
                    // Check if evaluation already exists for this employee and type
                    const existingIndex = existingEvaluations.findIndex(
                        evaluation => evaluation.employeeId === employeeId && evaluation.evaluationType === 'midYear'
                    );
                    
                    if (existingIndex !== -1) {
                        // Update existing evaluation
                        existingEvaluations[existingIndex] = evaluationData;
                        console.log('Updated existing mid-year evaluation in localStorage');
                    } else {
                        // Add new evaluation
                        existingEvaluations.push(evaluationData);
                        console.log('Added new mid-year evaluation to localStorage');
                    }
                    
                    localStorage.setItem('kpiEvaluations', JSON.stringify(existingEvaluations));
                    
                    // Also update the current values in the original KPIs
                    employeeKPIs.forEach(kpi => {
                        const evaluation = evaluationData.evaluations.find(evaluation => evaluation.kpiId === kpi.id);
                        if (evaluation) {
                            kpi.current = evaluation.updatedCurrentValue;
                            kpi.midYearFeedback = evaluation.feedback;
                            kpi.midYearActionPlan = evaluation.actionPlan;
                        }
                    });
                    
                    // Show success message
                    showSuccessMessage(
                        `Mid-year evaluation for ${employeeName} has been submitted successfully!\n\n` +
                        `Evaluated ${evaluationData.evaluations.length} KPI(s)\n` +
                        `Submission Date: ${new Date().toLocaleDateString()}`
                    );
                    
                    // Optionally disable the form or mark as submitted
                    markEvaluationAsSubmitted();
                    
                    console.log('Evaluation submitted:', evaluationData);
                    
                } catch (error) {
                    console.error('Error submitting evaluation:', error);
                    showErrorMessage('Failed to submit evaluation. Please try again.');
                } finally {
                    // Restore button state
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            }, 1500); // Simulate network delay
        }

        // Setup Firebase real-time listener for mid-year evaluation
        function setupFirebaseEvaluationListener(employeeId) {
            // Remove any existing listener
            if (window.currentEvaluationListener) {
                window.currentEvaluationListener();
                window.currentEvaluationListener = null;
            }
            
            // Set up new listener for this employee's mid-year evaluation
            const evaluationRef = window.firebaseRef(window.firebaseDb, `kpiEvaluations/${employeeId}/midYear`);
            
            const unsubscribe = window.firebaseOnValue(evaluationRef, (snapshot) => {
                const evaluationData = snapshot.val();
                
                if (evaluationData) {
                    console.log('Mid-year evaluation data received from Firebase:', evaluationData);
                    
                    // Update the UI in real-time with the latest evaluation data
                    updateEvaluationDisplay(evaluationData);
                } else {
                    console.log('No mid-year evaluation data found in Firebase for employee:', employeeId);
                }
            }, (error) => {
                console.error('Error listening to evaluation data:', error);
            });
            
            // Store the unsubscribe function to clean up later
            window.currentEvaluationListener = unsubscribe;
        }

        // Update the evaluation display with real-time data from Firebase
        function updateEvaluationDisplay(evaluationData) {
            // Update the evaluation cards with submitted evaluation data
            const kpiCards = document.querySelectorAll('#employeeKPIsList .kpi-evaluation-card');
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                
                // Find corresponding evaluation data
                const evalData = evaluationData.evaluations?.find(evaluation => evaluation.kpiId === kpiId);
                
                if (evalData) {
                    // Update current value input if it exists
                    const currentValueInput = card.querySelector(`#currentValue_${kpiId}`);
                    if (currentValueInput) {
                        currentValueInput.value = evalData.updatedCurrentValue || 0;
                    }
                    
                    // Update feedback textarea if it exists
                    const feedbackTextarea = card.querySelector(`#feedback_${kpiId}`);
                    if (feedbackTextarea) {
                        feedbackTextarea.value = evalData.feedback || '';
                    }
                    
                    // Update action plan textarea if it exists
                    const actionPlanTextarea = card.querySelector(`#actionPlan_${kpiId}`);
                    if (actionPlanTextarea) {
                        actionPlanTextarea.value = evalData.actionPlan || '';
                    }
                    
                    // Update performance display
                    const performance = evalData.performance || calculateKPIPerformance({
                        current: evalData.updatedCurrentValue || 0,
                        target: evalData.originalTarget || 1
                    });
                    
                    const scoreElement = card.querySelector('.performance-score');
                    if (scoreElement) {
                        scoreElement.textContent = performance.score + '%';
                        scoreElement.className = 'performance-score ' + performance.class;
                        const labelElement = scoreElement.nextElementSibling;
                        if (labelElement) {
                            labelElement.textContent = performance.label;
                        }
                    }
                    
                    // Update metrics display
                    const currentValueSpan = card.querySelector('.metric-row:nth-child(2) .metric-value');
                    if (currentValueSpan) {
                        // Find the original KPI to get metric type
                        const originalKPI = employeeKPIs.find(k => k.id === kpiId);
                        const metricType = originalKPI ? originalKPI.metricType : 'Number';
                        currentValueSpan.textContent = formatKPIValue(evalData.updatedCurrentValue || 0, metricType);
                    }
                    
                    // Update variance and progress if target exists
                    if (evalData.originalTarget && evalData.originalTarget > 0) {
                        const variance = ((evalData.updatedCurrentValue - evalData.originalTarget) / evalData.originalTarget * 100).toFixed(1);
                        const varianceSpan = card.querySelector('.metric-row:nth-child(3) .metric-value');
                        if (varianceSpan) {
                            varianceSpan.textContent = (evalData.updatedCurrentValue >= evalData.originalTarget ? '+' : '') + variance + '%';
                            varianceSpan.className = 'metric-value ' + (evalData.updatedCurrentValue >= evalData.originalTarget ? 'text-success' : 'text-danger');
                        }
                        
                        const progressSpan = card.querySelector('.metric-row:nth-child(4) .metric-value');
                        if (progressSpan) {
                            progressSpan.textContent = ((evalData.updatedCurrentValue / evalData.originalTarget) * 100).toFixed(1) + '%';
                        }
                    }
                }
            });
            
            // Add visual indicator that this is real-time data
            const evaluationList = document.getElementById('kpiEvaluationList');
            if (evaluationList && evaluationData.submissionDate) {
                // Add a small banner or indicator
                let realtimeBanner = evaluationList.querySelector('.realtime-banner');
                if (!realtimeBanner) {
                    realtimeBanner = document.createElement('div');
                    realtimeBanner.className = 'realtime-banner';
                    realtimeBanner.style.cssText = `
                        background: linear-gradient(135deg, #28a745, #20c997);
                        color: white;
                        padding: 8px 16px;
                        border-radius: 6px;
                        margin-bottom: 16px;
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        animation: fadeIn 0.3s ease-in;
                    `;
                    
                    // Insert at the beginning of the evaluation list
                    const firstChild = evaluationList.firstChild;
                    evaluationList.insertBefore(realtimeBanner, firstChild);
                }
                
                realtimeBanner.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <span>Latest evaluation data loaded (submitted: ${new Date(evaluationData.submissionDate).toLocaleString()})</span>
                    <i class="fas fa-sync-alt" style="margin-left: auto; opacity: 0.8;"></i>
                `;
            }
            
            console.log('Evaluation display updated with real-time data');
        }

        function submitSelfEvaluation(employeeId, employeeName) {
            console.log('Submitting self-evaluation (team member comments only)...');
            
            // Collect only the team member comments for self-evaluation
            const selfEvaluationData = {
                employeeId: employeeId,
                employeeName: employeeName,
                evaluationType: 'selfComments',
                submissionDate: new Date().toISOString(),
                kpiComments: {}
            };
            
            // Get all KPI evaluation cards and collect only the team member comments
            const kpiCards = document.querySelectorAll('#employeeKPIsList .kpi-evaluation-card');
            let hasComments = false;
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                const kpiName = card.querySelector('.kpi-eval-info h5').textContent.trim();
                
                // Get the team member comment for this KPI
                const commentTextarea = card.querySelector(`#kpiComment_${kpiId}`);
                const comment = commentTextarea ? commentTextarea.value.trim() : '';
                
                if (comment) {
                    selfEvaluationData.kpiComments[kpiId] = {
                        kpiName: kpiName,
                        comment: comment,
                        submissionDate: new Date().toISOString()
                    };
                    hasComments = true;
                }
            });
            
            // Check if there are any comments to submit
            if (!hasComments) {
                showErrorMessage('Please add at least one comment before submitting your self-evaluation.');
                return;
            }
            
            // Show confirmation dialog
            const commentCount = Object.keys(selfEvaluationData.kpiComments).length;
            const confirmMessage = `You are about to submit your self-evaluation with comments for ${commentCount} KPI${commentCount > 1 ? 's' : ''}.\n\nOnce submitted, these comments will be visible to your manager during the evaluation process.\n\nDo you want to continue?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Show loading state
            const submitButton = document.querySelector('button[onclick="submitEvaluation()"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting Comments...';
            
            // Submit the self-evaluation
            setTimeout(async () => {
                try {
                    // Save to Firebase
                    const selfEvaluationRef = window.firebaseRef(window.firebaseDb, `kpiSelfEvaluations/${employeeId}`);
                    await window.firebaseSet(selfEvaluationRef, selfEvaluationData);
                    
                    console.log('Self-evaluation comments saved to Firebase');
                    
                    // Also save to localStorage for offline access
                    let existingSelfEvaluations = {};
                    
                    try {
                        const storedData = localStorage.getItem('kpiSelfEvaluations');
                        if (storedData) {
                            const parsedData = JSON.parse(storedData);
                            // Ensure it's an object
                            existingSelfEvaluations = (parsedData && typeof parsedData === 'object' && !Array.isArray(parsedData)) ? parsedData : {};
                        }
                    } catch (parseError) {
                        console.warn('Error parsing existing self-evaluations from localStorage, starting fresh:', parseError);
                        existingSelfEvaluations = {};
                    }
                    
                    existingSelfEvaluations[employeeId] = selfEvaluationData;
                    localStorage.setItem('kpiSelfEvaluations', JSON.stringify(existingSelfEvaluations));
                    
                    // Show success message
                    showSuccessMessage('Self-evaluation comments submitted successfully! Your comments have been saved and will be available to your manager during the evaluation process.');
                    
                    // Update button state to show submitted
                    submitButton.innerHTML = '<i class="fas fa-check-circle"></i> Comments Submitted';
                    submitButton.classList.remove('btn-primary');
                    submitButton.classList.add('btn-success');
                    
                    // Add visual indicator that comments have been submitted
                    const evaluationList = document.getElementById('kpiEvaluationList');
                    if (evaluationList) {
                        let submittedBanner = evaluationList.querySelector('.self-eval-submitted-banner');
                        if (!submittedBanner) {
                            submittedBanner = document.createElement('div');
                            submittedBanner.className = 'self-eval-submitted-banner';
                            submittedBanner.style.cssText = `
                                background: linear-gradient(135deg, #28a745, #20c997);
                                color: white;
                                padding: 12px 16px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                font-size: 14px;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                                animation: fadeIn 0.5s ease-in;
                                box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
                            `;
                            
                            // Insert at the beginning of the evaluation list
                            const firstChild = evaluationList.firstChild;
                            evaluationList.insertBefore(submittedBanner, firstChild);
                        }
                        
                        submittedBanner.innerHTML = `
                            <i class="fas fa-check-circle" style="font-size: 16px;"></i>
                            <div>
                                <div style="font-weight: 600;">Self-Evaluation Comments Submitted</div>
                                <div style="font-size: 12px; opacity: 0.9;">Submitted on ${new Date().toLocaleString()} • Your manager can now view your comments</div>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Error submitting self-evaluation:', error);
                    
                    // Restore button state
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                    
                    showErrorMessage('Failed to submit self-evaluation. Please try again.');
                }
            }, 1000); // Brief delay for better UX
        }

        function previewEvaluation() {
            console.log('Previewing evaluation...');
            
            // Get current team member info
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                showErrorMessage('Please select a team member before previewing evaluation.');
                return;
            }
            
            const employeeName = globalEmployee.options[globalEmployee.selectedIndex].textContent;
            
            // Collect current evaluation data for preview
            const kpiCards = document.querySelectorAll('#employeeKPIsList .kpi-evaluation-card');
            let previewContent = '';
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                const kpiName = card.querySelector('.kpi-eval-info h5').textContent.trim();
                
                // Get current values
                const currentValueInput = card.querySelector(`#currentValue_${kpiId}`);
                const currentValue = currentValueInput ? parseFloat(currentValueInput.value) || 0 : 0;
                
                const feedbackTextarea = card.querySelector(`#feedback_${kpiId}`);
                const feedback = feedbackTextarea ? feedbackTextarea.value.trim() : 'No feedback provided';
                
                const actionPlanTextarea = card.querySelector(`#actionPlan_${kpiId}`);
                const actionPlan = actionPlanTextarea ? actionPlanTextarea.value.trim() : 'No action plan provided';
                
                // Get KPI-specific comment
                const kpiCommentTextarea = card.querySelector(`#kpiComment_${kpiId}`);
                const kpiComment = kpiCommentTextarea ? kpiCommentTextarea.value.trim() : '';
                
                // Find original KPI data
                const originalKPI = employeeKPIs.find(k => k.id === kpiId);
                const performance = originalKPI ? calculateKPIPerformance({
                    current: currentValue,
                    target: originalKPI.target
                }) : { score: 0, label: 'N/A', class: 'no-data' };
                
                previewContent += `
                    <div style="border: 1px solid #dee2e6; margin-bottom: 1rem; padding: 1rem; border-radius: 8px;">
                        <h4 style="color: #333; margin-bottom: 0.5rem;">${kpiName}</h4>
                        <div style="margin-bottom: 1rem;">
                            <strong>Performance:</strong> 
                            <span style="color: ${performance.class === 'excellent' ? '#28a745' : 
                                                  performance.class === 'good' ? '#007bff' : 
                                                  performance.class === 'average' ? '#ffc107' : '#dc3545'};">
                                ${performance.score}% (${performance.label})
                            </span>
                        </div>
                        <div style="margin-bottom: 0.5rem;"><strong>Target:</strong> ${originalKPI ? formatKPIValue(originalKPI.target, originalKPI.metricType) : 'N/A'}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Current Value:</strong> ${originalKPI ? formatKPIValue(currentValue, originalKPI.metricType) : 'N/A'}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Feedback:</strong></div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem; font-style: italic;">${feedback}</div>
                        <div style="margin-bottom: 0.5rem;"><strong>Action Plan:</strong></div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-bottom: ${kpiComment ? '0.5rem' : '0'}; font-style: italic;">${actionPlan}</div>
                        ${kpiComment ? `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f0f8ff; border-left: 3px solid #6f42c1; border-radius: 4px;">
                                <strong style="color: #6f42c1; font-size: 13px;">Team Member Comment:</strong>
                                <div style="margin-top: 0.25rem; font-style: italic; color: #555;">${kpiComment}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            if (!previewContent) {
                showErrorMessage('No evaluation data to preview.');
                return;
            }
            
            // Create preview modal
            const existingModal = document.getElementById('previewModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'previewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: flex-start;
                z-index: 10000;
                padding: 2rem;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    max-width: 800px;
                    width: 100%;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #dee2e6; padding-bottom: 1rem;">
                        <h2 style="color: #333; margin: 0;">Mid-Year Evaluation Preview</h2>
                        <button onclick="document.getElementById('previewModal').remove()" 
                                style="
                                    background: #dc3545;
                                    color: white;
                                    border: none;
                                    padding: 0.5rem 1rem;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 2rem; padding: 1rem; background: #e3f2fd; border-radius: 8px;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #1976d2;">Team Member Information</h3>
                        <p style="margin: 0; color: #333;"><strong>Name:</strong> ${employeeName}</p>
                        <p style="margin: 0; color: #333;"><strong>Evaluation Date:</strong> ${new Date().toLocaleDateString()}</p>
                        <p style="margin: 0; color: #333;"><strong>Evaluation Type:</strong> Mid-Year Review</p>
                    </div>
                    
                    <h3 style="color: #333; margin-bottom: 1rem;">KPI Evaluations</h3>
                    ${previewContent}
                    
                    <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                        <button onclick="document.getElementById('previewModal').remove()" 
                                style="
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 2rem;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                    margin-right: 1rem;
                                ">
                            Close Preview
                        </button>
                        <button onclick="window.print()" 
                                style="
                                    background: #007bff;
                                    color: white;
                                    border: none;
                                    padding: 0.75rem 2rem;
                                    border-radius: 6px;
                                    cursor: pointer;
                                    font-size: 1rem;
                                ">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Team Member Comments Section Functions
        function showTeamMemberCommentsSection(employeeId) {
            const commentsSection = document.getElementById('teamMemberCommentsSection');
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (!commentsSection) return;
            
            // Show the section
            commentsSection.style.display = 'block';
            
            // Check if the current user is the same as the selected employee (self-evaluation)
            const isOwnEvaluation = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            // Enable/disable the section based on whether it's own evaluation
            const textareas = commentsSection.querySelectorAll('textarea');
            const buttons = commentsSection.querySelectorAll('button');
            
            if (isOwnEvaluation) {
                // Enable for own evaluation
                commentsSection.classList.remove('comments-disabled');
                textareas.forEach(textarea => {
                    textarea.disabled = false;
                    textarea.style.backgroundColor = 'white';
                    textarea.style.cursor = 'text';
                });
                buttons.forEach(button => {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                });
                
                // Load saved comments for this employee
                loadTeamMemberComments(employeeId);
            } else {
                // Disable for others' evaluations (read-only mode)
                commentsSection.classList.add('comments-disabled');
                textareas.forEach(textarea => {
                    textarea.disabled = true;
                    textarea.style.backgroundColor = '#f8f9fa';
                    textarea.style.cursor = 'not-allowed';
                    textarea.title = 'You can only edit your own comments';
                });
                buttons.forEach(button => {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                    button.title = 'You can only edit your own comments';
                });
                
                // Load saved comments for this employee (read-only)
                loadTeamMemberComments(employeeId);
            }
        }

        function hideTeamMemberCommentsSection() {
            const commentsSection = document.getElementById('teamMemberCommentsSection');
            if (commentsSection) {
                commentsSection.style.display = 'none';
            }
        }

        function loadTeamMemberComments(employeeId) {
            try {
                const storedComments = JSON.parse(localStorage.getItem('teamMemberComments') || '{}');
                const employeeComments = storedComments[employeeId] || {};
                
                // Populate the comment fields
                const generalComments = document.getElementById('teamMemberGeneralComments');
                const challenges = document.getElementById('teamMemberChallenges');
                const achievements = document.getElementById('teamMemberAchievements');
                const supportNeeded = document.getElementById('teamMemberSupportNeeded');
                
                if (generalComments) generalComments.value = employeeComments.generalComments || '';
                if (challenges) challenges.value = employeeComments.challenges || '';
                if (achievements) achievements.value = employeeComments.achievements || '';
                if (supportNeeded) supportNeeded.value = employeeComments.supportNeeded || '';
                
                console.log('Loaded team member comments for employee:', employeeId);
            } catch (error) {
                console.error('Error loading team member comments:', error);
            }
        }

        function saveTeamMemberComments() {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                showErrorMessage('No team member selected.');
                return;
            }
            
            const employeeId = globalEmployee.value;
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if user is saving their own comments
            const isOwnEvaluation = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            if (!isOwnEvaluation) {
                showErrorMessage('You can only save your own comments.');
                return;
            }
            
            // Collect comment data
            const generalComments = document.getElementById('teamMemberGeneralComments')?.value.trim() || '';
            const challenges = document.getElementById('teamMemberChallenges')?.value.trim() || '';
            const achievements = document.getElementById('teamMemberAchievements')?.value.trim() || '';
            const supportNeeded = document.getElementById('teamMemberSupportNeeded')?.value.trim() || '';
            
            const commentsData = {
                generalComments,
                challenges,
                achievements,
                supportNeeded,
                lastSaved: new Date().toISOString(),
                employeeId: employeeId
            };
            
            try {
                // Get existing comments
                const storedComments = JSON.parse(localStorage.getItem('teamMemberComments') || '{}');
                
                // Save comments for this employee
                storedComments[employeeId] = commentsData;
                localStorage.setItem('teamMemberComments', JSON.stringify(storedComments));
                
                // Show success feedback
                const saveButton = document.querySelector('button[onclick="saveTeamMemberComments()"]');
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="fas fa-check"></i> Saved!';
                saveButton.style.backgroundColor = '#28a745';
                
                setTimeout(() => {
                    saveButton.innerHTML = originalText;
                    saveButton.style.backgroundColor = '';
                }, 2000);
                
                console.log('Team member comments saved successfully:', commentsData);
                
            } catch (error) {
                console.error('Error saving team member comments:', error);
                showErrorMessage('Failed to save comments. Please try again.');
            }
        }

        function clearTeamMemberComments() {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                showErrorMessage('No team member selected.');
                return;
            }
            
            const employeeId = globalEmployee.value;
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if user is clearing their own comments
            const isOwnEvaluation = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            if (!isOwnEvaluation) {
                showErrorMessage('You can only clear your own comments.');
                return;
            }
            
            // Confirm before clearing
            if (!confirm('Are you sure you want to clear all comments? This action cannot be undone.')) {
                return;
            }
            
            // Clear all comment fields
            const generalComments = document.getElementById('teamMemberGeneralComments');
            const challenges = document.getElementById('teamMemberChallenges');
            const achievements = document.getElementById('teamMemberAchievements');
            const supportNeeded = document.getElementById('teamMemberSupportNeeded');
            
            if (generalComments) generalComments.value = '';
            if (challenges) challenges.value = '';
            if (achievements) achievements.value = '';
            if (supportNeeded) supportNeeded.value = '';
            
            console.log('Team member comments cleared');
        }

        function getTeamMemberCommentsForPreview() {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return '';
            }
            
            const employeeId = globalEmployee.value;
            
            try {
                const storedComments = JSON.parse(localStorage.getItem('teamMemberComments') || '{}');
                const employeeComments = storedComments[employeeId] || {};
                
                const generalComments = employeeComments.generalComments || '';
                const challenges = employeeComments.challenges || '';
                const achievements = employeeComments.achievements || '';
                const supportNeeded = employeeComments.supportNeeded || '';
                
                // Only show comments section if there are any comments
                if (!generalComments && !challenges && !achievements && !supportNeeded) {
                    return '';
                }
                
                return `
                    <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <h3 style="color: #333; margin: 0 0 1rem 0;">Team Member Comments</h3>
                        ${generalComments ? `
                            <div style="margin-bottom: 1rem;">
                                <strong style="color: #555;">General Comments & Self-Assessment:</strong>
                                <div style="background: white; padding: 0.75rem; border-radius: 4px; margin-top: 0.25rem; border: 1px solid #e9ecef;">${generalComments}</div>
                            </div>
                        ` : ''}
                        ${challenges ? `
                            <div style="margin-bottom: 1rem;">
                                <strong style="color: #555;">Key Challenges Encountered:</strong>
                                <div style="background: white; padding: 0.75rem; border-radius: 4px; margin-top: 0.25rem; border: 1px solid #e9ecef;">${challenges}</div>
                            </div>
                        ` : ''}
                        ${achievements ? `
                            <div style="margin-bottom: 1rem;">
                                <strong style="color: #555;">Notable Achievements & Successes:</strong>
                                <div style="background: white; padding: 0.75rem; border-radius: 4px; margin-top: 0.25rem; border: 1px solid #e9ecef;">${achievements}</div>
                            </div>
                        ` : ''}
                        ${supportNeeded ? `
                            <div style="margin-bottom: 0;">
                                <strong style="color: #555;">Support Needed:</strong>
                                <div style="background: white; padding: 0.75rem; border-radius: 4px; margin-top: 0.25rem; border: 1px solid #e9ecef;">${supportNeeded}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('Error getting team member comments for preview:', error);
                return '';
            }
        }

        // Per-KPI Team Member Comments Functions
        function saveKPIComment(kpiId, commentValue) {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return;
            }
            
            const employeeId = globalEmployee.value;
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if user is saving their own comments
            const isOwnEvaluation = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            if (!isOwnEvaluation) {
                return; // Silently return if not own evaluation
            }
            
            try {
                // Get existing KPI comments
                const storedKPIComments = JSON.parse(localStorage.getItem('kpiComments') || '{}');
                
                // Initialize employee comments if not exists
                if (!storedKPIComments[employeeId]) {
                    storedKPIComments[employeeId] = {};
                }
                
                // Save the comment for this specific KPI
                storedKPIComments[employeeId][kpiId] = {
                    comment: commentValue.trim(),
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('kpiComments', JSON.stringify(storedKPIComments));
                console.log(`KPI comment saved for KPI ${kpiId}, employee ${employeeId}`);
            } catch (error) {
                console.error('Error saving KPI comment:', error);
            }
        }

        // Function to save current value for KPI evaluation
        function saveCurrentValue(kpiId, currentValue, evaluationType) {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return;
            }
            
            const employeeId = globalEmployee.value;
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Only supervisors can edit current values (not employees evaluating themselves)
            const isOwnEvaluation = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            if (isOwnEvaluation) {
                return; // Employees cannot edit their own current values
            }
            
            try {
                // Get existing current values
                const storedCurrentValues = JSON.parse(localStorage.getItem('kpiCurrentValues') || '{}');
                
                // Initialize employee current values if not exists
                if (!storedCurrentValues[employeeId]) {
                    storedCurrentValues[employeeId] = {};
                }
                
                // Initialize KPI current values if not exists
                if (!storedCurrentValues[employeeId][kpiId]) {
                    storedCurrentValues[employeeId][kpiId] = {};
                }
                
                // Save the current value for this specific KPI and evaluation type
                storedCurrentValues[employeeId][kpiId][evaluationType] = {
                    value: parseFloat(currentValue) || 0,
                    lastSaved: new Date().toISOString(),
                    savedBy: currentUser.uid || currentUser.id
                };
                
                localStorage.setItem('kpiCurrentValues', JSON.stringify(storedCurrentValues));
                console.log(`Current value saved for KPI ${kpiId}, employee ${employeeId}, type ${evaluationType}: ${currentValue}`);
                
                // Update performance indicators if visible
                updatePerformanceIndicators(kpiId, currentValue, evaluationType);
                
            } catch (error) {
                console.error('Error saving current value:', error);
            }
        }

        // Function to update performance indicators
        function updatePerformanceIndicators(kpiId, currentValue, evaluationType) {
            // This function can be expanded to show performance badges, progress bars, etc.
            // For now, it just logs the performance
            console.log(`Performance updated for KPI ${kpiId}: ${currentValue} (${evaluationType})`);
        }

        // Function to load saved current values
        function loadSavedCurrentValues(employeeId) {
            try {
                const storedCurrentValues = JSON.parse(localStorage.getItem('kpiCurrentValues') || '{}');
                const employeeValues = storedCurrentValues[employeeId] || {};
                
                // Load values for each KPI
                Object.keys(employeeValues).forEach(kpiId => {
                    const kpiValues = employeeValues[kpiId];
                    
                    // Load mid-year value
                    if (kpiValues.midyear) {
                        const midYearInput = document.getElementById(`currentValue_${kpiId}`);
                        if (midYearInput) {
                            midYearInput.value = kpiValues.midyear.value;
                        }
                    }
                    
                    // Load year-end value
                    if (kpiValues.yearend) {
                        const yearEndInput = document.getElementById(`currentValueYearEnd_${kpiId}`);
                        if (yearEndInput) {
                            yearEndInput.value = kpiValues.yearend.value;
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error loading saved current values:', error);
            }
        }

        function loadKPIComment(kpiId) {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return;
            }
            
            const employeeId = globalEmployee.value;
            
            try {
                const storedKPIComments = JSON.parse(localStorage.getItem('kpiComments') || '{}');
                const employeeComments = storedKPIComments[employeeId] || {};
                const kpiComment = employeeComments[kpiId] || {};
                
                const commentTextarea = document.getElementById(`kpiComment_${kpiId}`);
                if (commentTextarea) {
                    commentTextarea.value = kpiComment.comment || '';
                }
            } catch (error) {
                console.error('Error loading KPI comment:', error);
            }
        }

        function clearKPIComment(kpiId) {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return;
            }
            
            const employeeId = globalEmployee.value;
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if user is clearing their own comments
            const isOwnEvaluation = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            if (!isOwnEvaluation) {
                showErrorMessage('You can only clear your own comments.');
                return;
            }
            
            // Clear the comment
            const commentTextarea = document.getElementById(`kpiComment_${kpiId}`);
            if (commentTextarea) {
                commentTextarea.value = '';
                saveKPIComment(kpiId, ''); // Save the empty comment
            }
        }

        function getAllKPICommentsForPreview() {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return '';
            }
            
            const employeeId = globalEmployee.value;
            
            try {
                const storedKPIComments = JSON.parse(localStorage.getItem('kpiComments') || '{}');
                const employeeComments = storedKPIComments[employeeId] || {};
                
                // Check if there are any KPI comments
                const hasComments = Object.values(employeeComments).some(kpiComment => 
                    kpiComment.comment && kpiComment.comment.trim()
                );
                
                if (!hasComments) {
                    return '';
                }
                
                // Build HTML for KPI comments
                let kpiCommentsHtml = `
                    <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <h3 style="color: #333; margin: 0 0 1rem 0;">Team Member Comments by KPI</h3>
                `;
                
                // Get KPI names for display
                Object.keys(employeeComments).forEach(kpiId => {
                    const kpiComment = employeeComments[kpiId];
                    if (kpiComment.comment && kpiComment.comment.trim()) {
                        // Find KPI name from employeeKPIs
                        const kpi = window.employeeKPIs?.find(k => k.id === kpiId);
                        const kpiName = kpi ? kpi.name : `KPI ${kpiId}`;
                        
                        kpiCommentsHtml += `
                            <div style="margin-bottom: 1rem; border-left: 3px solid #6f42c1; padding-left: 1rem;">
                                <strong style="color: #6f42c1;">${kpiName}:</strong>
                                <div style="background: white; padding: 0.75rem; border-radius: 4px; margin-top: 0.25rem; border: 1px solid #e9ecef;">${kpiComment.comment}</div>
                            </div>
                        `;
                    }
                });
                
                kpiCommentsHtml += '</div>';
                return kpiCommentsHtml;
            } catch (error) {
                console.error('Error getting KPI comments for preview:', error);
                return '';
            }
        }

        // Per-KPI Year-End Team Member Comments Functions
        function saveKPICommentYearEnd(kpiId, commentValue) {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return;
            }
            
            const employeeId = globalEmployee.value;
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if user is commenting on their own evaluation
            const isOwnEvaluation = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            if (!isOwnEvaluation) {
                console.log('Non-owner cannot save year-end comments');
                return;
            }
            
            try {
                // Get existing KPI year-end comments
                const storedKPICommentsYearEnd = JSON.parse(localStorage.getItem('kpiCommentsYearEnd') || '{}');
                
                // Initialize structure if needed
                if (!storedKPICommentsYearEnd[employeeId]) {
                    storedKPICommentsYearEnd[employeeId] = {};
                }
                
                // Save the comment for this specific KPI
                storedKPICommentsYearEnd[employeeId][kpiId] = {
                    comment: commentValue,
                    lastUpdated: new Date().toISOString(),
                    employeeId: employeeId,
                    kpiId: kpiId
                };
                
                // Save back to localStorage
                localStorage.setItem('kpiCommentsYearEnd', JSON.stringify(storedKPICommentsYearEnd));
                
                // Also save to Firebase if available
                if (window.firebaseDb && window.firebaseRef && window.firebaseSet) {
                    const commentsRef = window.firebaseRef(window.firebaseDb, `kpiCommentsYearEnd/${employeeId}/${kpiId}`);
                    window.firebaseSet(commentsRef, storedKPICommentsYearEnd[employeeId][kpiId]).catch(error => {
                        console.error('Error saving year-end KPI comment to Firebase:', error);
                    });
                }
                
                console.log('Year-end KPI comment saved for KPI:', kpiId);
            } catch (error) {
                console.error('Error saving year-end KPI comment:', error);
            }
        }

        function loadKPICommentYearEnd(kpiId) {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return;
            }
            
            const employeeId = globalEmployee.value;
            
            try {
                const storedKPICommentsYearEnd = JSON.parse(localStorage.getItem('kpiCommentsYearEnd') || '{}');
                const employeeComments = storedKPICommentsYearEnd[employeeId] || {};
                const kpiComment = employeeComments[kpiId] || {};
                
                const commentTextarea = document.getElementById(`kpiComment_${kpiId}`);
                if (commentTextarea) {
                    commentTextarea.value = kpiComment.comment || '';
                }
            } catch (error) {
                console.error('Error loading year-end KPI comment:', error);
            }
        }

        function clearKPICommentYearEnd(kpiId) {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return;
            }
            
            const employeeId = globalEmployee.value;
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            // Check if user is clearing their own comments
            const isOwnEvaluation = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            if (!isOwnEvaluation) {
                showErrorMessage('You can only clear your own year-end comments.');
                return;
            }
            
            // Clear the comment
            const commentTextarea = document.getElementById(`kpiComment_${kpiId}`);
            if (commentTextarea) {
                commentTextarea.value = '';
                saveKPICommentYearEnd(kpiId, ''); // Save the empty comment
            }
        }

        function getAllKPICommentsYearEndForPreview() {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                return '';
            }
            
            const employeeId = globalEmployee.value;
            
            try {
                const storedKPICommentsYearEnd = JSON.parse(localStorage.getItem('kpiCommentsYearEnd') || '{}');
                const employeeComments = storedKPICommentsYearEnd[employeeId] || {};
                
                // Check if there are any year-end KPI comments
                const hasComments = Object.values(employeeComments).some(kpiComment => 
                    kpiComment.comment && kpiComment.comment.trim()
                );
                
                if (!hasComments) {
                    return '';
                }
                
                // Build HTML for year-end KPI comments
                let kpiCommentsHtml = `
                    <div style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                        <h3 style="color: #333; margin: 0 0 1rem 0;">Team Member Year-End Comments by KPI</h3>
                `;
                
                // Get KPI names for display
                Object.keys(employeeComments).forEach(kpiId => {
                    const kpiComment = employeeComments[kpiId];
                    if (kpiComment.comment && kpiComment.comment.trim()) {
                        // Find KPI name from employeeKPIs
                        const kpi = window.employeeKPIs?.find(k => k.id === kpiId || `kpi-yearend-${window.employeeKPIs.indexOf(k)}` === kpiId);
                        const kpiName = kpi ? (kpi.name || kpi.kpiName) : `KPI ${kpiId}`;
                        
                        kpiCommentsHtml += `
                            <div style="margin-bottom: 1rem; border-left: 3px solid #28a745; padding-left: 1rem;">
                                <strong style="color: #28a745;">${kpiName}:</strong>
                                <div style="background: white; padding: 0.75rem; border-radius: 4px; margin-top: 0.25rem; border: 1px solid #e9ecef;">${kpiComment.comment}</div>
                            </div>
                        `;
                    }
                });
                
                kpiCommentsHtml += '</div>';
                return kpiCommentsHtml;
            } catch (error) {
                console.error('Error getting year-end KPI comments for preview:', error);
                return '';
            }
        }

        // Handle year-end evaluation tab switch - check if team member is selected in assignment tab
        function handleYearEndTabSwitch() {
            const globalEmployee = document.getElementById('globalEmployee');
            const noEmployeeMessage = document.getElementById('noEmployeeSelectedMessageYearEnd');
            const currentEmployeeInfo = document.getElementById('currentEmployeeInfoYearEnd');
            const evaluationList = document.getElementById('kpiEvaluationListYearEnd');
            
            if (globalEmployee && globalEmployee.value) {
                // Team member is selected, show evaluation
                const selectedOption = globalEmployee.options[globalEmployee.selectedIndex];
                const employeeName = selectedOption.textContent;
                
                // Hide no employee message, show current employee info
                noEmployeeMessage.style.display = 'none';
                currentEmployeeInfo.style.display = 'block';
                
                // Update employee name
                document.getElementById('currentEmployeeNameYearEnd').textContent = employeeName;
                
                // Load KPIs for this team member - always try to load regardless of period restrictions
                loadEmployeeKPIsForYearEndEvaluation(globalEmployee.value);
            } else {
                // No team member selected, show message
                noEmployeeMessage.style.display = 'block';
                currentEmployeeInfo.style.display = 'none';
                evaluationList.style.display = 'none';
            }
        }

        // Load KPIs for selected employee year-end evaluation
        function loadEmployeeKPIsForYearEndEvaluation(employeeId) {
            const kpiList = document.getElementById('employeeKPIsListYearEnd');
            const evaluationList = document.getElementById('kpiEvaluationListYearEnd');
            const evaluationActions = document.getElementById('evaluationActionsYearEnd');
            
            if (!employeeId) {
                evaluationList.style.display = 'none';
                
                // Hide overall performance summary when no employee is selected
                const summarySection = document.getElementById('overallPerformanceSummaryYearEnd');
                if (summarySection) {
                    summarySection.style.display = 'none';
                }
                return;
            }
            
            evaluationList.style.display = 'block';
            
            // Set up Firebase real-time listener for year-end evaluation
            setupFirebaseYearEndEvaluationListener(employeeId);
            
            // Always try to get KPIs from the current form (Assignment tab) first, even if assignment period is overdue
            const currentFormKPIs = getCurrentFormKPIsForTeamMember(employeeId);
            
            if (currentFormKPIs && currentFormKPIs.length > 0) {
                // Use KPIs from current form for year-end evaluation - this works even when assignment period is overdue
                console.log('Using KPIs from current form for year-end evaluation:', currentFormKPIs);
                employeeKPIs = currentFormKPIs;
                renderYearEndKPIEvaluationCards(currentFormKPIs);
                evaluationActions.style.display = 'flex';
                return; // Successfully loaded from current form
            }
            
            // If no KPIs in current form, try to load from Firebase/localStorage
            loadKPIsFromDatabaseYearEnd(employeeId);
        }

        // Load KPIs from database for year-end evaluation
        function loadKPIsFromDatabaseYearEnd(employeeId) {
            console.log('Loading KPIs from database for year-end evaluation:', employeeId);
            
            // Try Firebase first, then localStorage
            try {
                // Firebase implementation would go here
                // For now, check localStorage
                const storedKPIs = JSON.parse(localStorage.getItem('kpis') || '[]');
                const employeeKPIs = storedKPIs.filter(kpi => kpi.employee === employeeId);
                
                if (employeeKPIs.length > 0) {
                    renderYearEndKPIEvaluationCards(employeeKPIs);
                    document.getElementById('evaluationActionsYearEnd').style.display = 'flex';
                } else {
                    showNoKPIsMessageYearEnd();
                }
            } catch (error) {
                console.error('Error loading KPIs from database for year-end:', error);
                showNoKPIsMessageYearEnd();
            }
        }

        // Show message when no KPIs are found for year-end
        function showNoKPIsMessageYearEnd() {
            const kpiList = document.getElementById('employeeKPIsListYearEnd');
            
            // Check if assignment period is overdue by looking for schedule info
            const isAssignmentOverdue = window.kpiScheduleInfo && 
                window.kpiScheduleInfo.today > window.kpiScheduleInfo.schedule?.assignmentEndDate;
            
            let messageContent;
            if (isAssignmentOverdue) {
                messageContent = `
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="info-content">
                            <h4>Assignment Period Ended</h4>
                            <p>The KPI assignment period has ended. No KPIs were assigned to this employee during the assignment period. To conduct year-end evaluation, KPIs must be assigned in the Assignment tab first.</p>
                            <button type="button" class="btn btn-secondary" onclick="switchTab('assignment')">
                                <i class="fas fa-eye"></i> View Assignment Tab
                            </button>
                        </div>
                    </div>
                `;
            } else {
                messageContent = `
                    <div class="info-card">
                        <div class="info-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="info-content">
                            <h4>No KPIs Found</h4>
                            <p>No KPIs have been assigned to this employee yet. Please create KPIs in the Assignment tab first.</p>
                            <button type="button" class="btn btn-primary" onclick="switchTab('assignment')">
                                <i class="fas fa-plus"></i> Create KPIs
                            </button>
                        </div>
                    </div>
                `;
            }
            
            kpiList.innerHTML = `<div class="no-kpis-message">${messageContent}</div>`;
            document.getElementById('evaluationActionsYearEnd').style.display = 'none';
            
            // Hide overall performance summary when no KPIs are found
            const summarySection = document.getElementById('overallPerformanceSummaryYearEnd');
            if (summarySection) {
                summarySection.style.display = 'none';
            }
        }

        // Render KPI evaluation cards for year-end
        function renderYearEndKPIEvaluationCards(kpis) {
            console.log('renderYearEndKPIEvaluationCards called with:', kpis);
            const container = document.getElementById('employeeKPIsListYearEnd');
            
            // Check if user is evaluating their own KPIs
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            const globalEmployee = document.getElementById('globalEmployee');
            const selectedEmployeeId = globalEmployee ? globalEmployee.value : null;
            
            const isEvaluatingSelf = currentUser && selectedEmployeeId && (
                currentUser.uid === selectedEmployeeId || 
                currentUser.id === selectedEmployeeId
            );
            
            container.innerHTML = kpis.map((kpi, index) => {
                const performance = calculateKPIPerformance(kpi);
                const kpiId = kpi.id || `kpi-yearend-${index}`;
                
                // Determine if fields should be disabled for self-evaluation
                const disabledAttr = isEvaluatingSelf ? 'disabled' : '';
                const disabledStyle = isEvaluatingSelf ? 'style="background-color: #f8f9fa; cursor: not-allowed; opacity: 0.7;"' : '';
                const disabledTitle = isEvaluatingSelf ? 'title="You cannot edit your own evaluation fields"' : '';
                
                return `
                    <div class="kpi-evaluation-card" data-kpi-id="${kpiId}">
                        <div class="kpi-eval-header">
                            <div class="kpi-eval-info">
                                <h5>${kpi.name || kpi.kpiName || 'Unnamed KPI'}</h5>
                                <div class="kpi-eval-meta">
                                    <span><i class="fas fa-tag"></i> ${kpi.category || 'General'}</span>
                                    <span><i class="fas fa-clock"></i> ${kpi.frequency || 'Annual'}</span>
                                    <span><i class="fas fa-chart-line"></i> ${kpi.metricType || 'Number'}</span>
                                </div>
                                <p>${kpi.description || 'No description provided'}</p>
                            </div>
                        </div>
                        
                        <div class="kpi-eval-body">
                            <!-- Current Value Section -->
                            <div class="eval-feedback">
                                <div class="eval-feedback-header">
                                    <h5><i class="fas fa-chart-bar"></i> Final Performance</h5>
                                </div>
                                <div class="feedback-group">
                                    <label for="currentValueYearEnd_${kpiId}">
                                        Final Achievement Value ${isEvaluatingSelf ? '' : '<span style="color: #dc3545;">*</span>'}
                                    </label>
                                    <input type="number" id="currentValueYearEnd_${kpiId}" class="form-control" 
                                           step="0.01" 
                                           placeholder="Enter final value achieved for the year (e.g., ${kpi.target || originalKPI.target || '100'})"
                                           ${disabledAttr} ${disabledStyle} ${disabledTitle}
                                           onchange="saveCurrentValue('${kpiId}', this.value, 'yearend')" />
                                    <small class="form-hint">Target: ${kpi.target || originalKPI.target || 'Not set'} ${kpi.metricType || originalKPI.metricType ? '(' + (kpi.metricType || originalKPI.metricType) + ')' : ''}</small>
                                </div>
                            </div>

                            <div class="eval-feedback">
                                <div class="eval-feedback-header">
                                    <h5><i class="fas fa-trophy"></i> Year-End Evaluation</h5>
                                </div>

                                ${isEvaluatingSelf ? `
                                    <div class="eval-restriction-notice">
                                        <i class="fas fa-lock"></i>
                                        <div>
                                            <strong>Self-Evaluation Restricted:</strong> You cannot edit your own year-end evaluation fields.
                                        </div>
                                    </div>
                                ` : ''}

                                <div class="eval-feedback-grid">
                                    <!-- Year-End Feedback Section -->
                                    <div class="feedback-section midyear-feedback-section">
                                        <div class="feedback-section-header">
                                            <h6><i class="fas fa-chart-line"></i> Annual Performance Review</h6>
                                            <span class="section-badge">Year-End</span>
                                        </div>
                                        <div class="feedback-group">
                                            <label for="yearEndComments_${kpiId}">
                                                Comprehensive Assessment ${isEvaluatingSelf ? '<i class="fas fa-lock" style="margin-left: 4px; color: #6c757d;"></i>' : ''}
                                            </label>
                                            <textarea id="yearEndComments_${kpiId}" rows="4" 
                                                      placeholder="${isEvaluatingSelf ? 'Self-evaluation not allowed' : 'Provide comprehensive year-end assessment including achievements, challenges faced, growth demonstrated, and overall performance for this KPI...'}"
                                                      ${disabledAttr} ${disabledStyle} ${disabledTitle}></textarea>
                                        </div>
                                    </div>

                                    <!-- Next Year Goals Section -->
                                    <div class="feedback-section action-plan-section">
                                        <div class="feedback-section-header">
                                            <h6><i class="fas fa-rocket"></i> Future Development</h6>
                                            <span class="section-badge">Next Year</span>
                                        </div>
                                        <div class="feedback-group">
                                            <label for="actionPlan_${kpiId}">
                                                Goals & Development Plan ${isEvaluatingSelf ? '<i class="fas fa-lock" style="margin-left: 4px; color: #6c757d;"></i>' : ''}
                                            </label>
                                            <textarea id="actionPlan_${kpiId}" rows="3" 
                                                      placeholder="${isEvaluatingSelf ? 'Self-evaluation not allowed' : 'Outline specific goals, targets, and development opportunities for next year. Include training needs, skill development areas, and strategic objectives...'}"
                                                      ${disabledAttr} ${disabledStyle} ${disabledTitle}></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Team Member Comments for this KPI -->
                            <div class="kpi-team-comments" id="kpiComments_${kpiId}">
                                <div class="comments-header">
                                </div>
                                <div class="comments-body">
                                    <div class="feedback-group">
                                        <label for="kpiComment_${kpiId}">Your Year-End Comments & Self-Assessment</label>
                                        <textarea id="kpiComment_${kpiId}" rows="3" 
                                                  placeholder="${isEvaluatingSelf ? 'Share your year-end thoughts on this KPI performance, achievements, challenges, lessons learned, or recommendations for next year...' : 'Team member year-end comments (view only)'}"
                                                  ${!isEvaluatingSelf ? 'disabled' : ''}
                                                  ${!isEvaluatingSelf ? 'style="background-color: #f8f9fa; cursor: not-allowed; opacity: 0.7;"' : ''}
                                                  ${!isEvaluatingSelf ? 'title="You can only view team member comments"' : ''}
                                                  onchange="saveKPICommentYearEnd('${kpiId}', this.value)"></textarea>
                                    </div>
                                    ${isEvaluatingSelf ? `
                                        <div class="comment-actions">
                                            <button type="button" class="btn btn-outline btn-xs" onclick="clearKPICommentYearEnd('${kpiId}')">
                                                <i class="fas fa-eraser"></i> Clear
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Load KPI-specific year-end comments after rendering
            setTimeout(() => {
                kpis.forEach((kpi, index) => {
                    const kpiId = kpi.id || `kpi-yearend-${index}`;
                    loadKPICommentYearEnd(kpiId);
                });
            }, 100);
            
            // Make employeeKPIs available globally for other functions
            window.employeeKPIs = kpis;
            
            // Calculate and display overall performance summary
            setTimeout(() => {
                calculateAndDisplayOverallPerformance(kpis);
            }, 150);
            
            // If evaluating self, update the action buttons for self-evaluation
            if (isEvaluatingSelf) {
                setTimeout(() => {
                    const evaluationActions = document.getElementById('evaluationActionsYearEnd');
                    if (evaluationActions) {
                        const buttons = evaluationActions.querySelectorAll('button');
                        buttons.forEach(button => {
                            if (button.onclick && 
                                (button.onclick.toString().includes('submitYearEndEvaluation') || 
                                 button.onclick.toString().includes('saveYearEndEvaluationDraft'))) {
                                
                                // For submit button, allow team members to submit their comments
                                if (button.innerHTML.includes('Submit')) {
                                    button.disabled = false;
                                    button.style.opacity = '1';
                                    button.style.cursor = 'pointer';
                                    button.title = 'Submit your year-end team member comments for evaluation';
                                    button.innerHTML = '<i class="fas fa-comment"></i> Submit My Year-End Comments';
                                    button.classList.remove('btn-primary');
                                    button.classList.add('btn-success');
                                } else if (button.innerHTML.includes('Save Draft')) {
                                    // Disable save draft for self-evaluation (comments auto-save)
                                    button.disabled = true;
                                    button.style.opacity = '0.5';
                                    button.style.cursor = 'not-allowed';
                                    button.title = 'Comments are automatically saved as you type';
                                    button.innerHTML = '<i class="fas fa-info-circle"></i> Auto-Saved';
                                }
                            }
                        });
                    }
                }, 100);
            }
            
            // Load saved current values after rendering
            setTimeout(() => {
                const globalEmployee = document.getElementById('globalEmployee');
                if (globalEmployee && globalEmployee.value) {
                    loadSavedCurrentValues(globalEmployee.value);
                }
            }, 200);
            
            // Ensure overall performance summary is displayed
            calculateAndDisplayOverallPerformance(kpis);
        }

        // Calculate and display overall performance summary for year-end evaluation
        function calculateAndDisplayOverallPerformance(kpis) {
            const summarySection = document.getElementById('overallPerformanceSummaryYearEnd');
            
            if (!summarySection) {
                return;
            }
            
            if (!kpis || kpis.length === 0) {
                summarySection.style.display = 'none';
                return;
            }
            
            console.log('Processing KPIs for overall performance calculation');
            
            // Calculate performance scores for each KPI
            const performanceScores = kpis.map(kpi => {
                const performance = calculateKPIPerformance(kpi);
                return {
                    kpi: kpi,
                    score: performance.score,
                    performance: performance
                };
            });
            
            // Calculate overall performance as percentage average
            const totalScore = performanceScores.reduce((sum, item) => sum + item.score, 0);
            const averageScore = kpis.length > 0 ? Math.round(totalScore / kpis.length) : 0;
            
            console.log('Calculated average score:', averageScore);
            
            // Determine CSS class for score display
            let ratingClass = '';
            if (averageScore >= 90) {
                ratingClass = 'excellent';
            } else if (averageScore >= 80) {
                ratingClass = 'good';
            } else if (averageScore >= 70) {
                ratingClass = 'average';
            } else if (averageScore >= 60) {
                ratingClass = 'poor';
            } else {
                ratingClass = 'poor';
            }
            
            // Count KPIs above target (>=100%)
            const kpisAboveTarget = performanceScores.filter(item => item.score >= 100).length;
            
            // Calculate performance distribution
            const performanceDistribution = {
                outstanding: performanceScores.filter(item => item.score >= 90).length,
                exceedsExpectations: performanceScores.filter(item => item.score >= 80 && item.score < 90).length,
                meetsExpectations: performanceScores.filter(item => item.score >= 70 && item.score < 80).length,
                belowExpectations: performanceScores.filter(item => item.score >= 60 && item.score < 70).length,
                unsatisfactory: performanceScores.filter(item => item.score < 60).length
            };
            
            // Update the summary display
            const scoreElement = document.getElementById('overallPerformanceScoreYearEnd');
            const targetElement = document.getElementById('kpisAboveTargetYearEnd');
            
            if (scoreElement) {
                scoreElement.textContent = `${averageScore}%`;
                scoreElement.className = `metric-value large ${ratingClass}`;
            }
            
            if (targetElement) {
                targetElement.textContent = `${kpisAboveTarget} of ${kpis.length}`;
            }
            
            // Update progress rate and final achievement rate
            const progressElement = document.getElementById('progressRateYearEnd');
            const finalAchievementElement = document.getElementById('finalAchievementRateYearEnd');
            
            if (progressElement) {
                progressElement.textContent = `${averageScore}%`;
            }
            
            if (finalAchievementElement) {
                finalAchievementElement.textContent = `${averageScore}%`;
            }
            
            // Generate achievement summary
            const achievementSummary = document.getElementById('achievementSummaryYearEnd');
            if (achievementSummary) {
                const achievementItems = [
                    { label: 'Average Performance', value: `${averageScore}%`, class: ratingClass },
                    { label: 'Top Performing KPIs', value: `${performanceDistribution.outstanding}`, class: 'excellent' },
                    { label: 'KPIs Meeting Targets', value: `${kpisAboveTarget}`, class: kpisAboveTarget > 0 ? 'good' : 'average' },
                    { label: 'Total Evaluation Score', value: `${totalScore} pts`, class: ratingClass }
                ];
                
                achievementSummary.innerHTML = achievementItems.map(item => `
                    <div class="achievement-item">
                        <span class="achievement-label">${item.label}</span>
                        <span class="achievement-value ${item.class}">${item.value}</span>
                    </div>
                `).join('');
            }
            
            // Generate performance breakdown chart
            const breakdownChart = document.getElementById('performanceBreakdownChart');
            if (breakdownChart) {
                const breakdownItems = performanceScores.map(item => {
                    const performance = item.performance;
                    return `
                        <div class="breakdown-item">
                            <div class="breakdown-kpi">
                                <div class="breakdown-kpi-name">${item.kpi.name || item.kpi.kpiName || 'Unnamed KPI'}</div>
                                <div class="breakdown-kpi-category">${item.kpi.category || 'General'} • ${item.kpi.frequency || 'Annual'}</div>
                            </div>
                            <div class="breakdown-performance">
                                <span class="breakdown-score ${performance.class}">${item.score}%</span>
                                <div class="breakdown-indicator ${performance.class}"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                breakdownChart.innerHTML = breakdownItems;
            }
            
            // Update timestamp
            const timestampElement = document.getElementById('lastUpdated');
            if (timestampElement) {
                timestampElement.textContent = new Date().toLocaleDateString() + ' at ' + new Date().toLocaleTimeString();
            }
            
            // Show the summary section
            console.log('Showing overall performance summary section');
            summarySection.style.display = 'block';
        }

        // Update KPI value for year-end evaluation


        // Update overall performance summary when any KPI data changes
        function updateOverallPerformanceSummary() {
            if (window.employeeKPIs) {
                setTimeout(() => {
                    calculateAndDisplayOverallPerformance(window.employeeKPIs);
                }, 100);
            }
        }

        // Year-End evaluation action functions
        function saveYearEndEvaluationDraft() {
            console.log('Saving year-end evaluation draft...');
            
            // Get current team member info
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                showErrorMessage('Please select a team member before saving draft.');
                return;
            }
            
            const employeeId = globalEmployee.value;
            const employeeName = globalEmployee.options[globalEmployee.selectedIndex].textContent;
            
            // Collect current evaluation data
            const draftData = {
                employeeId: employeeId,
                employeeName: employeeName,
                evaluationType: 'yearEnd',
                isDraft: true,
                lastSaved: new Date().toISOString(),
                evaluations: []
            };
            
            // Get all KPI evaluation cards
            const kpiCards = document.querySelectorAll('#employeeKPIsListYearEnd .kpi-evaluation-card');
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                const kpiName = card.querySelector('.kpi-eval-info h5').textContent.trim();
                
                // Get current value
                const currentValueInput = card.querySelector(`#currentValue_${kpiId}`);
                const currentValue = currentValueInput ? parseFloat(currentValueInput.value) || 0 : 0;
                
                // Get feedback
                const feedbackTextarea = card.querySelector(`#yearEndComments_${kpiId}`);
                const feedback = feedbackTextarea ? feedbackTextarea.value.trim() : '';
                
                // Find the original KPI data
                const originalKPI = employeeKPIs.find(k => (k.id || `kpi-yearend-${employeeKPIs.indexOf(k)}`) === kpiId);
                
                if (originalKPI) {
                    const evaluationEntry = {
                        kpiId: kpiId,
                        kpiName: kpiName,
                        originalTarget: originalKPI.target,
                        updatedCurrentValue: currentValue,
                        feedback: feedback,
                        performance: calculateKPIPerformance({
                            current: currentValue,
                            target: originalKPI.target
                        })
                    };
                    
                    draftData.evaluations.push(evaluationEntry);
                }
            });
            
            if (draftData.evaluations.length === 0) {
                showErrorMessage('No KPI data found to save. Please ensure KPIs are loaded properly.');
                return;
            }
            
            // Save draft to Firebase and localStorage
            try {
                // Save to Firebase
                const draftRef = window.firebaseRef(window.firebaseDb, `kpiEvaluations/${employeeId}/yearEndDraft`);
                window.firebaseSet(draftRef, draftData);
                
                // Save to localStorage for offline access
                const existingDrafts = JSON.parse(localStorage.getItem('kpiEvaluationDrafts') || '[]');
                const existingIndex = existingDrafts.findIndex(
                    draft => draft.employeeId === employeeId && draft.evaluationType === 'yearEnd'
                );
                
                if (existingIndex !== -1) {
                    existingDrafts[existingIndex] = draftData;
                } else {
                    existingDrafts.push(draftData);
                }
                
                localStorage.setItem('kpiEvaluationDrafts', JSON.stringify(existingDrafts));
                
                showSuccessMessage('Year-end evaluation draft saved successfully!');
                console.log('Year-end draft saved:', draftData);
                
            } catch (error) {
                console.error('Error saving year-end draft:', error);
                showErrorMessage('Failed to save draft. Please try again.');
            }
        }

        function submitYearEndEvaluation() {
            console.log('Submitting year-end evaluation...');
            
            // Get current team member info
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                showErrorMessage('Please select a team member before submitting evaluation.');
                return;
            }
            
            const employeeId = globalEmployee.value;
            const employeeName = globalEmployee.options[globalEmployee.selectedIndex].textContent;
            
            // Check if user is evaluating their own KPIs
            const currentUser = window.authManager?.getUser() || JSON.parse(localStorage.getItem('currentUser') || '{}');
            const isEvaluatingSelf = currentUser && (
                currentUser.uid === employeeId || 
                currentUser.id === employeeId
            );
            
            // Handle self-evaluation differently - allow submitting own comments
            if (isEvaluatingSelf) {
                submitSelfEvaluationYearEnd(employeeId, employeeName);
                return;
            }
            
            // Collect evaluation data from all KPI cards
            const evaluationData = {
                employeeId: employeeId,
                employeeName: employeeName,
                evaluationType: 'yearEnd',
                submissionDate: new Date().toISOString(),
                evaluations: [],
                teamMemberComments: {} // Add team member comments collection
            };
            
            // Get all KPI evaluation cards
            const kpiCards = document.querySelectorAll('#employeeKPIsListYearEnd .kpi-evaluation-card');
            let hasValidData = false;
            let missingFeedback = [];
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                const kpiName = card.querySelector('.kpi-eval-info h5').textContent.trim();
                
                // Get current value
                const currentValueInput = card.querySelector(`#currentValue_${kpiId}`);
                const currentValue = currentValueInput ? parseFloat(currentValueInput.value) || 0 : 0;
                
                // Get feedback
                const feedbackTextarea = card.querySelector(`#yearEndComments_${kpiId}`);
                const feedback = feedbackTextarea ? feedbackTextarea.value.trim() : '';
                
                // Find the original KPI data
                const originalKPI = employeeKPIs.find(k => (k.id || `kpi-yearend-${employeeKPIs.indexOf(k)}`) === kpiId);
                
                if (originalKPI) {
                    try {
                        // Calculate comprehensive performance metrics
                        const performanceData = calculateKPIPerformance({
                            current: currentValue,
                            target: originalKPI.target
                        });
                        
                        // Calculate additional metrics with error handling
                        const variance = originalKPI.target && originalKPI.target !== 0 ? 
                            ((currentValue - originalKPI.target) / originalKPI.target * 100) : 0;
                        const progressPercentage = originalKPI.target && originalKPI.target !== 0 ? 
                            ((currentValue / originalKPI.target) * 100) : 0;
                        
                        // Safely format values
                        let formattedCurrentValue, formattedTarget;
                        try {
                            formattedCurrentValue = formatKPIValue(currentValue, originalKPI.metricType);
                            formattedTarget = formatKPIValue(originalKPI.target, originalKPI.metricType);
                        } catch (formatError) {
                            console.warn('Error formatting KPI values:', formatError);
                            formattedCurrentValue = currentValue.toString();
                            formattedTarget = originalKPI.target.toString();
                        }
                        
                        const evaluationEntry = {
                            kpiId: kpiId,
                            kpiName: kpiName,
                            originalTarget: originalKPI.target,
                            updatedCurrentValue: currentValue,
                            feedback: feedback,
                            performance: performanceData,
                            metrics: {
                                variance: isFinite(variance) ? parseFloat(variance.toFixed(1)) : 0,
                                progressPercentage: isFinite(progressPercentage) ? parseFloat(progressPercentage.toFixed(1)) : 0,
                                metricType: originalKPI.metricType || 'number',
                                formattedCurrentValue: formattedCurrentValue,
                                formattedTarget: formattedTarget
                            },
                            submissionTimestamp: new Date().toISOString()
                        };
                        
                        evaluationData.evaluations.push(evaluationEntry);
                        
                        console.log(`Successfully processed KPI ${kpiId} for submission:`, {
                            kpiName: kpiName,
                            currentValue: currentValue,
                            target: originalKPI.target,
                            performance: performanceData.label,
                            variance: evaluationEntry.metrics.variance,
                            progressPercentage: evaluationEntry.metrics.progressPercentage
                        });
                        
                    } catch (kpiProcessingError) {
                        console.error(`Error processing KPI ${kpiId} for submission:`, kpiProcessingError);
                        // Still add basic evaluation data even if metrics calculation fails
                        const basicEvaluationEntry = {
                            kpiId: kpiId,
                            kpiName: kpiName,
                            originalTarget: originalKPI.target,
                            updatedCurrentValue: currentValue,
                            feedback: feedback,
                            performance: { score: 0, label: 'Calculation Error', class: 'poor' },
                            metrics: {
                                variance: 0,
                                progressPercentage: 0,
                                metricType: originalKPI.metricType || 'number',
                                formattedCurrentValue: currentValue.toString(),
                                formattedTarget: originalKPI.target.toString()
                            },
                            submissionTimestamp: new Date().toISOString(),
                            processingError: kpiProcessingError.message
                        };
                        evaluationData.evaluations.push(basicEvaluationEntry);
                    }
                    
                    // Check if feedback is provided (optional but recommended)
                    if (!feedback) {
                        missingFeedback.push(kpiName);
                    } else {
                        hasValidData = true;
                    }
                }
            });
            
            // Validation
            if (evaluationData.evaluations.length === 0) {
                showErrorMessage('No KPI data found to submit. Please ensure KPIs are loaded properly.');
                return;
            }
            
            // Show warning about missing feedback but allow submission
            if (missingFeedback.length > 0) {
                const continueSubmission = confirm(
                    `The following KPIs are missing feedback:\n${missingFeedback.join(', ')}\n\nDo you want to continue with the submission anyway?`
                );
                if (!continueSubmission) {
                    return;
                }
            }
            
            // Show loading state
            const submitButton = document.querySelector('button[onclick="submitYearEndEvaluation()"]');
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            // Simulate submission process - now with Firebase
            setTimeout(async () => {
                try {
                    // Final validation of evaluation data
                    const validationErrors = [];
                    
                    // Check that all evaluations have required fields
                    evaluationData.evaluations.forEach((evaluation, index) => {
                        if (!evaluation.kpiId) validationErrors.push(`Evaluation ${index + 1}: Missing KPI ID`);
                        if (!evaluation.kpiName) validationErrors.push(`Evaluation ${index + 1}: Missing KPI Name`);
                        if (evaluation.updatedCurrentValue === undefined || evaluation.updatedCurrentValue === null) {
                            validationErrors.push(`Evaluation ${index + 1}: Missing current value`);
                        }
                        if (!evaluation.performance) validationErrors.push(`Evaluation ${index + 1}: Missing performance data`);
                        if (!evaluation.metrics) validationErrors.push(`Evaluation ${index + 1}: Missing metrics data`);
                    });
                    
                    if (validationErrors.length > 0) {
                        console.error('Validation errors found:', validationErrors);
                        showErrorMessage('Data validation failed:\n' + validationErrors.join('\n'));
                        return;
                    }
                    
                    // Log the complete evaluation data before submission
                    console.log('Year-end evaluation data to be submitted:', {
                        employeeId: evaluationData.employeeId,
                        employeeName: evaluationData.employeeName,
                        evaluationType: evaluationData.evaluationType,
                        totalEvaluations: evaluationData.evaluations.length,
                        evaluationDetails: evaluationData.evaluations.map(evaluation => ({
                            kpiId: evaluation.kpiId,
                            kpiName: evaluation.kpiName,
                            originalTarget: evaluation.originalTarget,
                            updatedCurrentValue: evaluation.updatedCurrentValue,
                            performance: evaluation.performance,
                            metrics: evaluation.metrics,
                            hasFeedback: !!evaluation.feedback
                        }))
                    });
                    
                    // Save to Firebase
                    const evaluationRef = window.firebaseRef(window.firebaseDb, `kpiEvaluations/${employeeId}/yearEnd`);
                    await window.firebaseSet(evaluationRef, evaluationData);
                    
                    console.log('Year-end evaluation saved to Firebase successfully');
                    
                    // Also save to localStorage for offline access
                    const existingEvaluations = JSON.parse(localStorage.getItem('kpiEvaluations') || '[]');
                    
                    // Check if evaluation already exists for this employee and type
                    const existingIndex = existingEvaluations.findIndex(
                        evaluation => evaluation.employeeId === employeeId && evaluation.evaluationType === 'yearEnd'
                    );
                    
                    if (existingIndex !== -1) {
                        // Update existing evaluation
                        existingEvaluations[existingIndex] = evaluationData;
                        console.log('Updated existing year-end evaluation in localStorage');
                    } else {
                        // Add new evaluation
                        existingEvaluations.push(evaluationData);
                        console.log('Added new year-end evaluation to localStorage');
                    }
                    
                    localStorage.setItem('kpiEvaluations', JSON.stringify(existingEvaluations));
                    
                    // Also update the current values in the original KPIs with comprehensive data
                    employeeKPIs.forEach(kpi => {
                        const evaluation = evaluationData.evaluations.find(evaluation => evaluation.kpiId === (kpi.id || `kpi-yearend-${employeeKPIs.indexOf(kpi)}`));
                        if (evaluation) {
                            kpi.current = evaluation.updatedCurrentValue;
                            kpi.yearEndFeedback = evaluation.feedback;
                            kpi.yearEndPerformance = evaluation.performance;
                            kpi.yearEndMetrics = evaluation.metrics;
                            kpi.lastEvaluationDate = evaluation.submissionTimestamp;
                        }
                    });
                    
                    // Remove any draft for this employee since final evaluation is submitted
                    try {
                        const draftRef = window.firebaseRef(window.firebaseDb, `kpiEvaluations/${employeeId}/yearEndDraft`);
                        await window.firebaseSet(draftRef, null);
                        
                        // Also remove from localStorage
                        const existingDrafts = JSON.parse(localStorage.getItem('kpiEvaluationDrafts') || '[]');
                        const filteredDrafts = existingDrafts.filter(
                            draft => !(draft.employeeId === employeeId && draft.evaluationType === 'yearEnd')
                        );
                        localStorage.setItem('kpiEvaluationDrafts', JSON.stringify(filteredDrafts));
                    } catch (draftError) {
                        console.warn('Could not remove draft:', draftError);
                    }
                    
                    // Show success message
                    showSuccessMessage(
                        `Year-end evaluation for ${employeeName} has been submitted successfully!\n\n` +
                        `Evaluated ${evaluationData.evaluations.length} KPI(s)\n` +
                        `Submission Date: ${new Date().toLocaleDateString()}`
                    );
                    
                    // Mark as submitted and disable form
                    markYearEndEvaluationAsSubmitted();
                    
                    console.log('Year-end evaluation submitted:', evaluationData);
                    
                } catch (error) {
                    console.error('Error submitting year-end evaluation:', error);
                    showErrorMessage('Failed to submit year-end evaluation. Please try again.');
                } finally {
                    // Restore button state
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            }, 1500); // Simulate network delay
        }

        function submitSelfEvaluationYearEnd(employeeId, employeeName) {
            console.log('Submitting year-end self-evaluation (team member comments only)...');
            
            // Collect only the team member year-end comments for self-evaluation
            const selfEvaluationData = {
                employeeId: employeeId,
                employeeName: employeeName,
                evaluationType: 'selfCommentsYearEnd',
                submissionDate: new Date().toISOString(),
                kpiComments: {}
            };
            
            // Get all KPI evaluation cards and collect only the team member comments
            const kpiCards = document.querySelectorAll('#employeeKPIsListYearEnd .kpi-evaluation-card');
            console.log('Found KPI cards for year-end submission:', kpiCards.length);
            
            let hasComments = false;
            
            kpiCards.forEach((card, index) => {
                try {
                    const kpiId = card.getAttribute('data-kpi-id');
                    console.log(`Processing KPI card ${index + 1} with ID:`, kpiId);
                    
                    // Get KPI name - with fallback if h5 doesn't exist
                    let kpiName = 'Unknown KPI';
                    const kpiNameElement = card.querySelector('.kpi-eval-info h5');
                    if (kpiNameElement) {
                        kpiName = kpiNameElement.textContent.trim();
                    } else {
                        console.warn(`KPI name element not found for card ${index + 1}, using fallback`);
                        kpiName = `KPI ${index + 1}`;
                    }
                    
                    // Get the team member comment for this KPI
                    const commentTextarea = card.querySelector(`#kpiCommentYearEnd_${kpiId}`);
                    const comment = commentTextarea ? commentTextarea.value.trim() : '';
                    
                    console.log(`KPI ${kpiId} comment:`, comment ? `"${comment}"` : '(empty)');
                    
                    if (comment) {
                        selfEvaluationData.kpiComments[kpiId] = {
                            kpiName: kpiName,
                            comment: comment,
                            lastUpdated: new Date().toISOString()
                        };
                        hasComments = true;
                    }
                } catch (error) {
                    console.error(`Error processing KPI card ${index + 1}:`, error);
                }
            });
            
            console.log('Self-evaluation data collected:', selfEvaluationData);
            console.log('Has comments:', hasComments);
            
            // Check if there are any comments to submit
            if (!hasComments) {
                showErrorMessage('Please add at least one year-end comment before submitting your self-evaluation.');
                return;
            }
            
            // Show confirmation dialog
            const commentCount = Object.keys(selfEvaluationData.kpiComments).length;
            const confirmMessage = `You are about to submit your year-end self-evaluation with comments for ${commentCount} KPI${commentCount > 1 ? 's' : ''}.\n\nOnce submitted, these comments will be visible to your manager during the year-end evaluation process.\n\nDo you want to continue?`;
            
            if (!confirm(confirmMessage)) {
                console.log('User cancelled submission');
                return;
            }
            
            // Show loading state
            const submitButton = document.querySelector('button[onclick="submitYearEndEvaluation()"]');
            if (!submitButton) {
                console.error('Submit button not found!');
                showErrorMessage('Submit button not found. Please refresh the page and try again.');
                return;
            }
            
            const originalButtonText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting Comments...';
            
            // Submit the year-end self-evaluation
            setTimeout(async () => {
                try {
                    console.log('Starting submission process...');
                    
                    // Save to Firebase
                    if (window.firebaseDb && window.firebaseRef && window.firebaseSet) {
                        console.log('Saving to Firebase...');
                        const selfEvalRef = window.firebaseRef(window.firebaseDb, `kpiSelfEvaluations/${employeeId}/yearEnd`);
                        await window.firebaseSet(selfEvalRef, selfEvaluationData);
                        console.log('Year-end self-evaluation saved to Firebase');
                    } else {
                        console.log('Firebase not available, skipping Firebase save');
                    }
                    
                    // Also save to localStorage
                    console.log('Saving to localStorage...');
                    let existingSelfEvals = [];
                    
                    try {
                        const storedData = localStorage.getItem('kpiSelfEvaluations');
                        if (storedData) {
                            const parsedData = JSON.parse(storedData);
                            // Ensure it's an array
                            existingSelfEvals = Array.isArray(parsedData) ? parsedData : [];
                        }
                    } catch (parseError) {
                        console.warn('Error parsing existing self-evaluations from localStorage, starting fresh:', parseError);
                        existingSelfEvals = [];
                    }
                    
                    const existingIndex = existingSelfEvals.findIndex(
                        selfEval => selfEval && selfEval.employeeId === employeeId && selfEval.evaluationType === 'selfCommentsYearEnd'
                    );
                    
                    if (existingIndex !== -1) {
                        console.log('Updating existing self-evaluation');
                        existingSelfEvals[existingIndex] = selfEvaluationData;
                    } else {
                        console.log('Adding new self-evaluation');
                        existingSelfEvals.push(selfEvaluationData);
                    }
                    
                    localStorage.setItem('kpiSelfEvaluations', JSON.stringify(existingSelfEvals));
                    console.log('Saved to localStorage successfully');
                    
                    // Show success message
                    showSuccessMessage(
                        `Your year-end comments have been submitted successfully!\n\n` +
                        `Comments submitted for ${commentCount} KPI${commentCount > 1 ? 's' : ''}\n` +
                        `Submission Date: ${new Date().toLocaleDateString()}\n\n` +
                        `Your manager will review these comments during the year-end evaluation process.`
                    );
                    
                    console.log('Year-end self-evaluation submitted successfully:', selfEvaluationData);
                    
                } catch (error) {
                    console.error('Error submitting year-end self-evaluation:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack,
                        employeeId: employeeId,
                        employeeName: employeeName,
                        hasFirebase: !!(window.firebaseDb && window.firebaseRef && window.firebaseSet),
                        dataToSubmit: selfEvaluationData
                    });
                    showErrorMessage(`Failed to submit year-end comments. Error: ${error.message || 'Unknown error'}. Please try again.`);
                } finally {
                    // Restore button state
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                    }
                }
            }, 1000); // Brief delay for better UX
        }

        function previewYearEndEvaluation() {
            console.log('Previewing year-end evaluation...');
            
            // Get current employee info
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee || !globalEmployee.value) {
                showErrorMessage('Please select a team member before previewing year-end evaluation.');
                return;
            }
            
            // Ensure saved values are loaded before generating preview
            loadSavedCurrentValues(globalEmployee.value);
            
            const employeeName = globalEmployee.options[globalEmployee.selectedIndex].textContent;
            
            // Collect current evaluation data for preview
            const kpiCards = document.querySelectorAll('#employeeKPIsListYearEnd .kpi-evaluation-card');
            let previewContent = '';
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                const kpiName = card.querySelector('.kpi-eval-info h5').textContent.trim();
                
                // Get current values - check for year-end specific input field
                const currentValueInput = card.querySelector(`#currentValueYearEnd_${kpiId}`) || card.querySelector(`#currentValue_${kpiId}`);
                const currentValue = currentValueInput ? parseFloat(currentValueInput.value) || 0 : 0;
                
                const feedbackTextarea = card.querySelector(`#yearEndComments_${kpiId}`);
                const feedback = feedbackTextarea ? feedbackTextarea.value.trim() : 'No feedback provided';
                
                // Find original KPI data
                const originalKPI = employeeKPIs.find(k => (k.id || `kpi-yearend-${employeeKPIs.indexOf(k)}`) === kpiId);
                const performance = originalKPI ? calculateKPIPerformance({
                    current: currentValue,
                    target: originalKPI.target
                }) : { score: 0, label: 'N/A', class: 'no-data' };
                
                previewContent += `
                    <div style="background: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: #333; margin: 0;">${kpiName}</h4>
                            <span class="performance-badge ${performance.class}" style="background: var(--${performance.class}-bg, #e9ecef); color: var(--${performance.class}-color, #333); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: bold;">
                                ${performance.score}% - ${performance.label}
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div style="padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #6c757d;">
                                <strong style="color: #495057;">Target:</strong><br>
                                <span style="font-size: 1.1rem; font-weight: 600; color: #343a40;">${originalKPI ? formatKPIValue(originalKPI.target, originalKPI.metricType) : 'N/A'}</span>
                            </div>
                            <div style="padding: 0.75rem; background: ${currentValue > 0 ? '#e8f5e8' : '#fff3cd'}; border-radius: 6px; border-left: 3px solid ${currentValue > 0 ? '#28a745' : '#ffc107'};">
                                <strong style="color: ${currentValue > 0 ? '#155724' : '#856404'};">Final Achievement:</strong><br>
                                <span style="font-size: 1.2rem; font-weight: 700; color: ${currentValue > 0 ? '#28a745' : '#856404'};">
                                    ${currentValue > 0 ? formatKPIValue(currentValue, originalKPI?.metricType) : 'Not entered yet'}
                                </span>
                            </div>
                            <div style="padding: 0.75rem; background: ${currentValue >= (originalKPI?.target || 0) ? '#e8f5e8' : '#fff3cd'}; border-radius: 6px; border-left: 3px solid ${currentValue >= (originalKPI?.target || 0) ? '#28a745' : '#ffc107'};">
                                <strong style="color: ${currentValue >= (originalKPI?.target || 0) ? '#155724' : '#856404'};">Variance:</strong><br>
                                <span style="font-size: 1.1rem; font-weight: 600; color: ${currentValue >= (originalKPI?.target || 0) ? '#28a745' : '#856404'};">${originalKPI && originalKPI.target && originalKPI.target !== 0 ? 
                                    ((currentValue >= originalKPI.target ? '+' : '') + ((currentValue - originalKPI.target) / originalKPI.target * 100).toFixed(1) + '%') : 'N/A'}</span>
                            </div>
                        </div>
                        
                        <div>
                            <strong>Year-End Summary:</strong>
                            <p style="margin: 0.5rem 0; padding: 0.75rem; background: #f8f9fa; border-radius: 4px; color: #495057;">${feedback}</p>
                        </div>
                        
                        <!-- Team Member Year-End Comment for this KPI -->
                        ${(() => {
                            const commentTextarea = card.querySelector(`#kpiComment_${kpiId}`) || card.querySelector(`#kpiCommentYearEnd_${kpiId}`);
                            const comment = commentTextarea ? commentTextarea.value.trim() : '';
                            if (comment) {
                                return `
                                    <div style="margin-top: 1rem; border-top: 1px solid #dee2e6; padding-top: 1rem;">
                                        <strong style="color: #28a745;">Team Member Year-End Comment:</strong>
                                        <p style="margin: 0.5rem 0; padding: 0.75rem; background: #d4edda; border-radius: 4px; color: #155724; border-left: 4px solid #28a745;">${comment}</p>
                                    </div>
                                `;
                            }
                            return '';
                        })()}
                    </div>
                `;
            });
            
            if (!previewContent) {
                showErrorMessage('No year-end evaluation data to preview.');
                return;
            }
            
            // Create preview modal
            const existingModal = document.getElementById('previewModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'previewModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: flex-start;
                z-index: 10000;
                padding: 2rem;
                overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    width: 100%;
                    max-width: 900px;
                    max-height: 90vh;
                    overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #dee2e6; padding: 2rem 2rem 1rem;">
                        <h2 style="color: #333; margin: 0;">Year-End Evaluation Preview</h2>
                        <button onclick="document.getElementById('previewModal').remove()" 
                                style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">✕</button>
                    </div>
                    
                    <div style="padding: 0 2rem;">
                        <div style="margin-bottom: 2rem; padding: 1rem; background: #e8f5e8; border-radius: 8px;">
                            <h4 style="color: #2d5a2d; margin: 0 0 0.5rem;">Employee: ${employeeName}</h4>
                            <p style="color: #4a6741; margin: 0; font-size: 0.9rem;">Year-End Performance Evaluation • Generated on ${new Date().toLocaleDateString()}</p>
                        </div>
                        
                        <h3 style="color: #333; margin-bottom: 1rem;">Year-End KPI Performance Summary</h3>
                        ${previewContent}
                        
                        ${getAllKPICommentsYearEndForPreview()}
                        
                        <div style="text-align: center; margin: 2rem 0; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                            <button onclick="document.getElementById('previewModal').remove()" 
                                    style="background: #007bff; color: white; border: none; padding: 0.75rem 2rem; border-radius: 6px; cursor: pointer; font-size: 1rem;">
                                Close Preview
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Mark year-end evaluation as submitted
        function markYearEndEvaluationAsSubmitted() {
            const evaluationActions = document.getElementById('evaluationActionsYearEnd');
            if (evaluationActions) {
                // Add a "submitted" indicator
                const existingIndicator = evaluationActions.querySelector('.submitted-indicator');
                if (!existingIndicator) {
                    const indicator = document.createElement('div');
                    indicator.className = 'submitted-indicator';
                    indicator.style.cssText = `
                        background: #d4edda;
                        color: #155724;
                        padding: 0.75rem 1rem;
                        border-radius: 6px;
                        font-weight: bold;
                        text-align: center;
                        margin-bottom: 1rem;
                        border: 1px solid #c3e6cb;
                    `;
                    indicator.innerHTML = '<i class="fas fa-check-circle"></i> Year-End Evaluation Submitted';
                    evaluationActions.insertBefore(indicator, evaluationActions.firstChild);
                }
            }
            
            // Optionally disable all input fields in the year-end evaluation
            const evaluationInputs = document.querySelectorAll('#employeeKPIsListYearEnd input, #employeeKPIsListYearEnd textarea, #employeeKPIsListYearEnd select');
            evaluationInputs.forEach(input => {
                input.style.backgroundColor = '#f8f9fa';
                input.style.borderColor = '#dee2e6';
                // Don't disable them completely so users can still view/copy the data
            });
        }

        // Setup Firebase real-time listener for year-end evaluation
        function setupFirebaseYearEndEvaluationListener(employeeId) {
            // Remove any existing listener
            if (window.currentYearEndEvaluationListener) {
                window.currentYearEndEvaluationListener();
                window.currentYearEndEvaluationListener = null;
            }
            
            // Set up new listener for this employee's year-end evaluation
            const evaluationRef = window.firebaseRef(window.firebaseDb, `kpiEvaluations/${employeeId}/yearEnd`);
            
            const unsubscribe = window.firebaseOnValue(evaluationRef, (snapshot) => {
                const evaluationData = snapshot.val();
                
                if (evaluationData) {
                    updateYearEndEvaluationDisplay(evaluationData);
                } else {
                    console.log('No year-end evaluation data found for this employee');
                }
            }, (error) => {
                console.error('Error listening to year-end evaluation data:', error);
            });
            
            // Store the unsubscribe function to clean up later
            window.currentYearEndEvaluationListener = unsubscribe;
        }

        // Update the year-end evaluation display with real-time data from Firebase
        function updateYearEndEvaluationDisplay(evaluationData) {
            // Update the evaluation cards with submitted evaluation data
            const kpiCards = document.querySelectorAll('#employeeKPIsListYearEnd .kpi-evaluation-card');
            
            kpiCards.forEach((card, index) => {
                const kpiId = card.getAttribute('data-kpi-id');
                
                // Find corresponding evaluation data
                const evalData = evaluationData.evaluations?.find(evaluation => evaluation.kpiId === kpiId);
                
                if (evalData) {
                    // Update current value
                    const currentValueInput = card.querySelector(`#currentValue_${kpiId}`);
                    if (currentValueInput) {
                        currentValueInput.value = evalData.updatedCurrentValue || 0;
                    }
                    
                    // Update feedback
                    const feedbackTextarea = card.querySelector(`#yearEndComments_${kpiId}`);
                    if (feedbackTextarea) {
                        feedbackTextarea.value = evalData.feedback || '';
                    }
                    
                    // Update performance display
                    const performance = evalData.performance;
                    if (performance) {
                        const scoreElement = card.querySelector('.performance-score');
                        const indicatorElement = card.querySelector('.performance-indicator');
                        const labelElement = card.querySelector('.performance-label');
                        
                        if (scoreElement) scoreElement.textContent = performance.score + '%';
                        if (indicatorElement) {
                            indicatorElement.className = `performance-indicator ${performance.class}`;
                        }
                        if (labelElement) labelElement.textContent = performance.label;
                    }
                }
            });
            
            // Add visual indicator that this is real-time data
            const evaluationList = document.getElementById('kpiEvaluationListYearEnd');
            if (evaluationList && evaluationData.submissionDate) {
                // Add a small banner or indicator
                let realtimeBanner = evaluationList.querySelector('.realtime-banner');
                if (!realtimeBanner) {
                    realtimeBanner = document.createElement('div');
                    realtimeBanner.className = 'realtime-banner';
                    realtimeBanner.style.cssText = `
                        background: #d1ecf1;
                        color: #0c5460;
                        padding: 0.5rem 1rem;
                        border-radius: 4px;
                        font-size: 0.875rem;
                        margin-bottom: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    `;
                    evaluationList.insertBefore(realtimeBanner, evaluationList.firstChild);
                }
                
                realtimeBanner.innerHTML = `
                    <i class="fas fa-sync-alt" style="color: #0c5460;"></i>
                    <span>Real-time data • Submitted: ${new Date(evaluationData.submissionDate).toLocaleString()}</span>
                    <i class="fas fa-sync-alt" style="margin-left: auto; opacity: 0.8;"></i>
                `;
                
                // Mark as submitted
                markYearEndEvaluationAsSubmitted();
            }
            
            console.log('Year-end evaluation display updated with real-time data');
        }

        // Helper function to show success messages
        function showSuccessMessage(message) {
            // Create a more sophisticated modal/toast notification
            const existingModal = document.getElementById('successModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'successModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    max-width: 500px;
                    text-align: center;
                    position: relative;
                ">
                    <div style="
                        width: 60px;
                        height: 60px;
                        background: #28a745;
                        border-radius: 50%;
                        margin: 0 auto 1rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 24px;
                    ">
                        <i class="fas fa-check"></i>
                    </div>
                    <h3 style="color: #333; margin-bottom: 1rem;">Success!</h3>
                    <p style="color: #666; line-height: 1.5; white-space: pre-line;">${message}</p>
                    <button onclick="document.getElementById('successModal').remove()" 
                            style="
                                background: #28a745;
                                color: white;
                                border: none;
                                padding: 0.75rem 2rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 1rem;
                                margin-top: 1rem;
                            ">
                        OK
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                if (document.getElementById('successModal')) {
                    modal.remove();
                }
            }, 5000);
        }

        // Helper function to show error messages
        function showErrorMessage(message) {
            const existingModal = document.getElementById('errorModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'errorModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: 12px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    max-width: 500px;
                    text-align: center;
                    position: relative;
                ">
                    <div style="
                        width: 60px;
                        height: 60px;
                        background: #dc3545;
                        border-radius: 50%;
                        margin: 0 auto 1rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 24px;
                    ">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 style="color: #333; margin-bottom: 1rem;">Error</h3>
                    <p style="color: #666; line-height: 1.5;">${message}</p>
                    <button onclick="document.getElementById('errorModal').remove()" 
                            style="
                                background: #dc3545;
                                color: white;
                                border: none;
                                padding: 0.75rem 2rem;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 1rem;
                                margin-top: 1rem;
                            ">
                        OK
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Mark evaluation as submitted
        function markEvaluationAsSubmitted() {
            const evaluationActions = document.getElementById('evaluationActions');
            if (evaluationActions) {
                // Add a "submitted" indicator
                const existingIndicator = evaluationActions.querySelector('.submitted-indicator');
                if (!existingIndicator) {
                    const indicator = document.createElement('div');
                    indicator.className = 'submitted-indicator';
                    indicator.style.cssText = `
                        background: #d4edda;
                        color: #155724;
                        padding: 0.75rem 1rem;
                        border-radius: 6px;
                        border: 1px solid #c3e6cb;
                        margin-bottom: 1rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        font-weight: 500;
                    `;
                    indicator.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        Mid-year evaluation submitted successfully on ${new Date().toLocaleDateString()}
                    `;
                    evaluationActions.insertBefore(indicator, evaluationActions.firstChild);
                }
            }
            
            // Optionally disable all input fields in the evaluation
            const evaluationInputs = document.querySelectorAll('#employeeKPIsList input, #employeeKPIsList textarea');
            evaluationInputs.forEach(input => {
                input.style.backgroundColor = '#f8f9fa';
                input.style.borderColor = '#dee2e6';
                // Don't disable them completely so users can still view/copy the data
            });
        }

        // Function to add a new KPI section
        function addKPISection() {
            const addKPIBtn = document.getElementById('addKPIBtn');
            
            // Check if the button is locked due to period expiry
            if (addKPIBtn && addKPIBtn.classList.contains('btn-locked')) {
                showErrorMessage('KPI creation is currently locked because one or more evaluation periods have ended. Please contact your administrator to extend the period if needed.');
                console.log('🔒 Attempted to add KPI but button is locked due to expired periods');
                return;
            }
            
            const container = document.getElementById('kpiSectionsContainer');
            const gettingStarted = document.getElementById('gettingStarted');
            const loadDraftBtn = document.getElementById('loadDraftBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            // Show the container if it's hidden (first KPI)
            if (container.style.display === 'none') {
                container.style.display = 'block';
                gettingStarted.style.display = 'none';
                loadDraftBtn.style.display = 'inline-flex';
                resetBtn.style.display = 'inline-flex';
                // Update button text after first KPI is added
                addKPIBtn.innerHTML = '<i class="fas fa-plus"></i> Add Another KPI';
                
                // Show the first KPI section that was already in the HTML
                const firstSection = container.querySelector('.kpi-section[data-kpi-index="0"]');
                if (firstSection) {
                    firstSection.style.display = 'block';
                    toggleRemoveButtons();
                    setupKPIEventListeners(0);
                    addKPIDataChangeListeners();
                    return; // Don't create a new section, just show the existing one
                }
            }
            
            kpiCounter++;
            const kpiSection = document.createElement('div');
            kpiSection.className = 'kpi-section';
            kpiSection.setAttribute('data-kpi-index', kpiCounter);
            
            kpiSection.innerHTML = `
                <div class="kpi-section-header">
                    <h3><i class="fas fa-chart-line"></i> KPI #${kpiCounter + 1}</h3>
                    <button type="button" class="btn btn-danger btn-sm remove-kpi-btn" onclick="removeKPISection(${kpiCounter})">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                
                <div class="form-section">
                    <h4><i class="fas fa-info-circle"></i> KPI Information</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="kpiName_${kpiCounter}" class="form-label required">KPI Name</label>
                            <input type="text" id="kpiName_${kpiCounter}" name="kpiName_${kpiCounter}" class="form-control" required 
                                   placeholder="Enter KPI name">
                            <div class="error-message" id="kpiNameError_${kpiCounter}"></div>
                        </div>

                        <div class="form-group">
                            <label for="category_${kpiCounter}" class="form-label required">Category</label>
                            <select id="category_${kpiCounter}" name="category_${kpiCounter}" class="form-control" required>
                                <option value="">Select Category</option>
                                <option value="Financial">Financial</option>
                                <option value="Operational">Operational</option>
                                <option value="Customer">Customer</option>
                                <option value="Employee">Employee</option>
                                <option value="Quality">Quality</option>
                                <option value="Safety">Safety</option>
                                <option value="Compliance">Compliance</option>
                                <option value="Innovation">Innovation</option>
                                <option value="Environmental">Environmental</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="error-message" id="categoryError_${kpiCounter}"></div>
                        </div>

                        <div class="form-group">
                            <label for="metricType_${kpiCounter}" class="form-label required">Metric Type</label>
                            <select id="metricType_${kpiCounter}" name="metricType_${kpiCounter}" class="form-control" required>
                                <option value="">Select Metric Type</option>
                                <option value="Percentage">Percentage (%)</option>
                                <option value="Number">Number</option>
                                <option value="Currency">Currency ($)</option>
                                <option value="Time">Time</option>
                                <option value="Ratio">Ratio</option>
                                <option value="Score">Score</option>
                            </select>
                            <div class="error-message" id="metricTypeError_${kpiCounter}"></div>
                        </div>

                        <div class="form-group">
                            <label for="frequency_${kpiCounter}" class="form-label required">Reporting Frequency</label>
                            <select id="frequency_${kpiCounter}" name="frequency_${kpiCounter}" class="form-control" required>
                                <option value="">Select Frequency</option>
                                <option value="Daily">Daily</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Annually">Annually</option>
                            </select>
                            <div class="error-message" id="frequencyError_${kpiCounter}"></div>
                        </div>

                        <div class="form-group">
                            <label for="target_${kpiCounter}" class="form-label required">Target Value</label>
                            <input type="number" id="target_${kpiCounter}" name="target_${kpiCounter}" class="form-control" required
                                   step="0.01" placeholder="Target value">
                            <div class="error-message" id="targetError_${kpiCounter}"></div>
                        </div>

                        <div class="form-group full-width">
                            <label for="description_${kpiCounter}" class="form-label">Description</label>
                            <textarea id="description_${kpiCounter}" name="description_${kpiCounter}" class="form-control" rows="3"
                                      placeholder="Brief description of the KPI"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(kpiSection);
            
            // Show remove buttons for all sections if there's more than one
            toggleRemoveButtons();
            
            // Add smooth animation
            kpiSection.style.opacity = '0';
            kpiSection.style.transform = 'translateY(20px)';
            setTimeout(() => {
                kpiSection.style.transition = 'all 0.3s ease';
                kpiSection.style.opacity = '1';
                kpiSection.style.transform = 'translateY(0)';
            }, 10);
            
            // Setup event listeners for the new section
            setupKPIEventListeners(kpiCounter);
            
            // Notify that a new KPI section has been added
            onKPISectionAdded();
            
            // Reapply field restrictions to the new section
            setTimeout(() => {
                reapplyAssignmentFieldRestrictions();
            }, 100);
        }

        // Function to remove a KPI section
        function removeKPISection(index) {
            const section = document.querySelector(`[data-kpi-index="${index}"]`);
            if (section) {
                // Animate removal
                section.style.transition = 'all 0.3s ease';
                section.style.opacity = '0';
                section.style.transform = 'translateY(-20px)';
                
                setTimeout(() => {
                    section.remove();
                    toggleRemoveButtons();
                    updateKPINumbers();
                }, 300);
            }
        }

        // Function to toggle remove button visibility
        function toggleRemoveButtons() {
            const sections = document.querySelectorAll('.kpi-section');
            const removeButtons = document.querySelectorAll('.remove-kpi-btn');
            
            if (sections.length > 1) {
                removeButtons.forEach(btn => btn.style.display = 'inline-flex');
            } else {
                removeButtons.forEach(btn => btn.style.display = 'none');
            }
        }

        // Function to update KPI numbers in headers
        function updateKPINumbers() {
            const sections = document.querySelectorAll('.kpi-section');
            sections.forEach((section, index) => {
                const header = section.querySelector('.kpi-section-header h3');
                if (header) {
                    header.innerHTML = `<i class="fas fa-chart-line"></i> KPI #${index + 1}`;
                }
            });
        }

        // Function to setup event listeners for a specific KPI section
        function setupKPIEventListeners(index) {
            const requiredFields = ['kpiName', 'category', 'metricType', 'frequency', 'target'];
            requiredFields.forEach(fieldName => {
                const fieldId = index === 0 ? `${fieldName}_${index}` : `${fieldName}_${index}`;
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', () => validateField(fieldId));
                    field.addEventListener('input', () => clearError(fieldId));
                }
            });
            
            // Add global employee listener on first call
            if (index === 0) {
                addGlobalEmployeeListener();
            }
        }

        // Add event listener for global employee changes
        function addGlobalEmployeeListener() {
            const globalEmployee = document.getElementById('globalEmployee');
            if (globalEmployee && !globalEmployee.hasAttribute('data-listener-added')) {
                globalEmployee.addEventListener('change', handleGlobalEmployeeChange);
                globalEmployee.setAttribute('data-listener-added', 'true');
                console.log('Added global employee change listener');
            }
        }

        // Handle global employee change to update evaluation tab
        function handleGlobalEmployeeChange() {
            // If we're currently in the evaluation tab, update it
            if (currentTab === 'evaluation') {
                handleEvaluationTabSwitch();
            } else if (currentTab === 'yearEnd') {
                handleYearEndTabSwitch();
            }
            
            // Apply field restrictions based on schedule after employee selection
            setTimeout(() => {
                if (typeof reapplyAssignmentFieldRestrictions === 'function') {
                    reapplyAssignmentFieldRestrictions();
                }
            }, 100);
        }

        // Add listeners to KPI form inputs to update evaluation tab in real-time
        function addKPIDataChangeListeners() {
            const kpiSections = document.querySelectorAll('.kpi-section');
            kpiSections.forEach((section, index) => {
                const inputs = section.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (!input.hasAttribute('data-eval-listener')) {
                        input.addEventListener('input', () => {
                            // Debounce the update
                            clearTimeout(window.evalUpdateTimeout);
                            window.evalUpdateTimeout = setTimeout(() => {
                                if (currentTab === 'evaluation') {
                                    handleEvaluationTabSwitch();
                                }
                            }, 500);
                        });
                        input.setAttribute('data-eval-listener', 'true');
                    }
                });
            });
        }

        // Update evaluation when new KPI sections are added
        function onKPISectionAdded() {
            // Add listeners to the new section
            addKPIDataChangeListeners();
            
            // Update evaluation if we're in that tab
            if (currentTab === 'evaluation') {
                setTimeout(() => handleEvaluationTabSwitch(), 100);
            } else if (currentTab === 'yearEnd') {
                setTimeout(() => handleYearEndTabSwitch(), 100);
            }
        }

        // Function to store employee options for new sections (no longer needed)
        function storeEmployeeOptions() {
            // No longer needed since we have a global employee field
        }

        // Function to validate field (placeholder - will be extended in kpi-form.js)
        function validateField(fieldId) {
            // This will be handled by the existing validation in kpi-form.js
            console.log('Validating field:', fieldId);
        }

        // Function to clear error (placeholder - will be extended in kpi-form.js)
        function clearError(fieldId) {
            const errorElement = document.getElementById(fieldId.replace(/(_\d+)?$/, 'Error$1'));
            if (errorElement) {
                errorElement.textContent = '';
            }
        }

        // Function to reset form
        function resetForm() {
            const container = document.getElementById('kpiSectionsContainer');
            const addKPIBtn = document.getElementById('addKPIBtn');
            const gettingStarted = document.getElementById('gettingStarted');
            const loadDraftBtn = document.getElementById('loadDraftBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            // Remove all KPI sections except the first one
            const sections = document.querySelectorAll('.kpi-section');
            sections.forEach((section, index) => {
                if (index > 0) {
                    section.remove();
                }
            });
            
            // Hide the KPI container, show getting started
            container.style.display = 'none';
            gettingStarted.style.display = 'block';
            loadDraftBtn.style.display = 'none';
            resetBtn.style.display = 'none';
            
            // Reset button text
            addKPIBtn.innerHTML = '<i class="fas fa-plus"></i> Add KPI';
            
            // Reset the global employee field
            const globalEmployee = document.getElementById('globalEmployee');
            if (globalEmployee) {
                globalEmployee.selectedIndex = 0;
            }
            
            // Reset the first section
            const firstSection = document.querySelector('.kpi-section');
            if (firstSection) {
                const inputs = firstSection.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'select-one') {
                        input.selectedIndex = 0;
                    } else {
                        input.value = '';
                    }
                });
                
                // Clear error messages
                const errorMessages = firstSection.querySelectorAll('.error-message');
                errorMessages.forEach(error => error.textContent = '');
            }
            
            // Clear global employee error
            const globalEmployeeError = document.getElementById('globalEmployeeError');
            if (globalEmployeeError) {
                globalEmployeeError.textContent = '';
            }
            
            // Reset counter
            kpiCounter = 0;
            toggleRemoveButtons();
            updateKPINumbers();
        }

        // Function to preview all KPIs
        function previewKPIs() {
            console.log('Previewing all KPIs...');
            // This will be implemented in kpi-form.js
        }

        // Function to save draft
        function saveDraft() {
            console.log('Saving draft...');
            // This will be implemented in kpi-form.js
        }

        // Function to load draft
        function loadDraft() {
            console.log('Loading draft...');
            // This will be implemented in kpi-form.js
        }

        // Monitor global employee dropdown and setup initial listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup initial event listeners for the first KPI section
            setupKPIEventListeners(0);
            
            // Setup global employee field validation
            const globalEmployee = document.getElementById('globalEmployee');
            if (globalEmployee) {
                globalEmployee.addEventListener('blur', () => validateField('globalEmployee'));
                globalEmployee.addEventListener('input', () => clearError('globalEmployee'));
                
                // Add change listener to update evaluation tab when employee is selected
                globalEmployee.addEventListener('change', function() {
                    markTabAsChanged('assignment');
                    // If we're currently on the evaluation tab, update it
                    if (currentTab === 'evaluation') {
                        handleEvaluationTabSwitch();
                    }
                });
            }
            
            // Start monitoring assignment changes
            monitorAssignmentChanges();
        });

        // Load user initials for avatar - integrated with centralized auth
        function loadUserInitials() {
            const userInitials = document.getElementById('userInitials');
            const userFullName = document.getElementById('userFullName');
            
            // Use centralized auth manager if available
            if (window.authManager && window.authManager.isAuthenticated()) {
                const user = window.authManager.getUser();
                if (user && userInitials && userFullName) {
                    const displayName = user.name || user.displayName || user.email || 'User';
                    const initials = getInitials(displayName);
                    userInitials.textContent = initials;
                    userFullName.textContent = displayName;
                }
                return;
            }
            
            // Fallback: Check if Firebase auth is available
            if (typeof firebase !== 'undefined' && firebase.auth) {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user && userInitials && userFullName) {
                        const displayName = user.displayName || user.email || 'User';
                        const initials = getInitials(displayName);
                        userInitials.textContent = initials;
                        userFullName.textContent = displayName;
                    } else if (userInitials && userFullName) {
                        userInitials.textContent = 'U';
                        userFullName.textContent = 'User';
                    }
                });
            } else {
                // Fallback: try to get user info from localStorage or session
                const currentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                if (currentUser && userInitials && userFullName) {
                    try {
                        const userData = JSON.parse(currentUser);
                        const displayName = userData.name || userData.email || userData.displayName || 'User';
                        const initials = getInitials(displayName);
                        userInitials.textContent = initials;
                        userFullName.textContent = displayName;
                    } catch (e) {
                        userInitials.textContent = 'U';
                        userFullName.textContent = 'User';
                    }
                } else if (userInitials && userFullName) {
                    userInitials.textContent = 'U';
                    userFullName.textContent = 'User';
                }
            }
        }

        function getInitials(name) {
            if (!name) return 'U';
            const words = name.split(' ').filter(word => word.length > 0);
            if (words.length === 1) {
                return words[0].substring(0, 2).toUpperCase();
            } else {
                return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
            }
        }

        // Initialize user initials when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadUserInitials();
        });

        // Tab change indication functions
        function markTabAsChanged(tabName) {
            const tab = document.getElementById(tabName + 'Tab');
            if (tab) {
                tab.classList.add('has-changes');
            }
        }

        function clearTabChangeIndicator(tabName) {
            const tab = document.getElementById(tabName + 'Tab');
            if (tab) {
                tab.classList.remove('has-changes');
            }
        }

        // Monitor form changes in assignment tab
        function monitorAssignmentChanges() {
            const form = document.getElementById('kpiForm');
            if (form) {
                form.addEventListener('input', function() {
                    markTabAsChanged('assignment');
                });
                
                form.addEventListener('change', function() {
                    markTabAsChanged('assignment');
                });
            }
            
            // Also setup team member consistency when this is called
            ensureTeamMemberConsistency();
        }

        // Ensure team member is consistent across all tabs
        function ensureTeamMemberConsistency() {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee) return;
            
            // Check if listener is already attached to avoid duplicates
            if (globalEmployee.hasAttribute('data-consistency-listener')) {
                return;
            }
            
            // Mark that we've attached the listener
            globalEmployee.setAttribute('data-consistency-listener', 'true');
            
            // Add listener to ensure consistency when team member changes
            globalEmployee.addEventListener('change', function() {
                const selectedEmployeeId = globalEmployee.value;
                const selectedEmployeeName = globalEmployee.options[globalEmployee.selectedIndex]?.textContent || '';
                
                console.log('Team member changed - ensuring consistency across tabs:', {
                    employeeId: selectedEmployeeId,
                    employeeName: selectedEmployeeName,
                    currentTab: currentTab
                });
                
                // Update all tabs based on the selected team member
                updateAllTabsForSelectedEmployee(selectedEmployeeId, selectedEmployeeName);
            });
        }

        // Update all tabs when team member selection changes
        function updateAllTabsForSelectedEmployee(employeeId, employeeName) {
            // Update evaluation tab if it's active or has been initialized
            if (currentTab === 'evaluation' || document.getElementById('kpiEvaluationList').style.display !== 'none') {
                console.log('Updating evaluation tab for selected employee:', employeeId);
                setTimeout(() => handleEvaluationTabSwitch(), 100);
            }
            
            // Update year-end evaluation tab if it's active or has been initialized
            if (currentTab === 'yearEnd' || document.getElementById('kpiEvaluationListYearEnd').style.display !== 'none') {
                console.log('Updating year-end evaluation tab for selected employee:', employeeId);
                setTimeout(() => handleYearEndTabSwitch(), 100);
            }
            
            // Update assignment tab - show/hide KPI sections container
            const gettingStarted = document.getElementById('gettingStarted');
            const kpiSections = document.getElementById('kpiSectionsContainer');
            
            if (employeeId) {
                // Employee selected - show KPI sections, hide getting started
                if (gettingStarted) gettingStarted.style.display = 'none';
                if (kpiSections) kpiSections.style.display = 'block';
            } else {
                // No employee selected - show getting started, hide KPI sections
                if (gettingStarted) gettingStarted.style.display = 'block';
                if (kpiSections) kpiSections.style.display = 'none';
            }
        }

        // Global function to manually set team member selection (can be called externally)
        function setSelectedTeamMember(employeeId, switchToTab = null) {
            const globalEmployee = document.getElementById('globalEmployee');
            if (!globalEmployee) {
                console.error('Global employee dropdown not found');
                return false;
            }
            
            // Find and select the employee
            for (let i = 0; i < globalEmployee.options.length; i++) {
                if (globalEmployee.options[i].value === employeeId) {
                    globalEmployee.selectedIndex = i;
                    
                    // Trigger change event
                    globalEmployee.dispatchEvent(new Event('change'));
                    
                    // Update all tabs
                    const employeeName = globalEmployee.options[i].textContent;
                    updateAllTabsForSelectedEmployee(employeeId, employeeName);
                    
                    // Switch to specific tab if requested
                    if (switchToTab) {
                        setTimeout(() => switchTab(switchToTab), 200);
                    }
                    
                    console.log('Team member set programmatically:', { employeeId, employeeName, switchToTab });
                    return true;
                }
            }
            
            console.warn('Employee not found in dropdown:', employeeId);
            return false;
        }

        // Make the function globally available
        window.setSelectedTeamMember = setSelectedTeamMember;

        // Clear change indicators when form is saved
        function clearAllChangeIndicators() {
            clearTabChangeIndicator('assignment');
            clearTabChangeIndicator('evaluation');
            clearTabChangeIndicator('yearEnd');
        }

        // Cleanup Firebase listeners when page is unloaded
        window.addEventListener('beforeunload', function() {
            if (window.currentEvaluationListener) {
                console.log('Cleaning up Firebase listeners before page unload');
                window.currentEvaluationListener();
                window.currentEvaluationListener = null;
            }
            if (window.currentYearEndEvaluationListener) {
                console.log('Cleaning up year-end Firebase listeners before page unload');
                window.currentYearEndEvaluationListener();
                window.currentYearEndEvaluationListener = null;
            }
        });

        // KPI Schedule Modal Functions
        async function openScheduleModal() {
            // Display company scope information
            const scopeInfo = displayCompanyScope();
            console.log('🔧 Opening KPI Schedule Configuration for company:', scopeInfo.user.companyName);
            
            await loadCurrentSchedule();
            openModal('scheduleModal');
        }

        async function loadCurrentSchedule() {
            try {
                // First try to load from Firebase
                const firebaseSchedule = await loadKPIScheduleFromFirebase();
                
                // Load from localStorage as fallback
                const savedSchedule = localStorage.getItem('kpiSchedule');
                let schedule = getDefaultSchedule();

                // Prefer Firebase data if available, otherwise use localStorage
                if (firebaseSchedule) {
                    schedule = { ...schedule, ...firebaseSchedule };
                    console.log('✅ Loaded schedule from Firebase');
                } else if (savedSchedule) {
                    schedule = { ...schedule, ...JSON.parse(savedSchedule) };
                    console.log('✅ Loaded schedule from localStorage');
                } else {
                    console.log('ℹ️ Using default schedule');
                }

                // Populate the modal with the loaded data
                populateScheduleModal(schedule);
                
                // Initialize multiple notification schedules
                initializeMultipleNotificationSchedules();

            } catch (error) {
                console.error('❌ Error loading schedule:', error);
                // Fall back to localStorage only
                const savedSchedule = localStorage.getItem('kpiSchedule');
                let schedule = getDefaultSchedule();
                if (savedSchedule) {
                    schedule = { ...schedule, ...JSON.parse(savedSchedule) };
                }
                populateScheduleModal(schedule);
                initializeMultipleNotificationSchedules();
            }
        }

        function getDefaultSchedule() {
            const currentYear = new Date().getFullYear();
            return {
                assignmentStartDate: `${currentYear}-01-01`,
                assignmentEndDate: `${currentYear}-03-31`,
                midYearStartDate: `${currentYear}-06-01`,
                midYearEndDate: `${currentYear}-06-30`,
                yearEndStartDate: `${currentYear}-12-01`,
                yearEndEndDate: `${currentYear}-12-31`,
                fiscalYearStart: '1',
                enableNotifications: true,
                autoLockPeriods: false,
                notificationSchedule: {
                    assignmentNotifications: {
                        enabled: true,
                        date: '',
                        time: '09:00'
                    },
                    midYearNotifications: {
                        enabled: true,
                        date: '',
                        time: '09:00'
                    },
                    yearEndNotifications: {
                        enabled: true,
                        date: '',
                        time: '09:00'
                    },
                    reminderNotifications: {
                        enabled: true,
                        scheduleType: 'interval',
                        frequencyDays: 3,
                        specificDates: [
                            { date: '', time: '09:00' },
                            { date: '', time: '09:00' },
                            { date: '', time: '09:00' }
                        ]
                    },
                    additionalRecipients: '',
                    notifySystemAdmins: false
                }
            };
        }

        function resetScheduleToDefaults() {
            const defaultSchedule = getDefaultSchedule();
            
            document.getElementById('assignmentStartDate').value = defaultSchedule.assignmentStartDate;
            document.getElementById('assignmentEndDate').value = defaultSchedule.assignmentEndDate;
            document.getElementById('midYearStartDate').value = defaultSchedule.midYearStartDate;
            document.getElementById('midYearEndDate').value = defaultSchedule.midYearEndDate;
            document.getElementById('yearEndStartDate').value = defaultSchedule.yearEndStartDate;
            document.getElementById('yearEndEndDate').value = defaultSchedule.yearEndEndDate;
            document.getElementById('fiscalYearStart').value = defaultSchedule.fiscalYearStart;
            document.getElementById('enableNotifications').checked = defaultSchedule.enableNotifications;
            document.getElementById('autoLockPeriods').checked = defaultSchedule.autoLockPeriods;
            
            // Reset notification scheduling fields to defaults
            const notifications = defaultSchedule.notificationSchedule;
            
            // Reset assignment notifications
            document.getElementById('enableAssignmentNotifications').checked = notifications.assignmentNotifications.enabled;
            document.getElementById('assignmentNotificationDate').value = notifications.assignmentNotifications.date;
            document.getElementById('assignmentNotificationTime').value = notifications.assignmentNotifications.time;
            
            // Reset mid-year notifications
            document.getElementById('enableMidYearNotifications').checked = notifications.midYearNotifications.enabled;
            document.getElementById('midYearNotificationDate').value = notifications.midYearNotifications.date;
            document.getElementById('midYearNotificationTime').value = notifications.midYearNotifications.time;
            
            // Reset year-end notifications
            document.getElementById('enableYearEndNotifications').checked = notifications.yearEndNotifications.enabled;
            document.getElementById('yearEndNotificationDate').value = notifications.yearEndNotifications.date;
            document.getElementById('yearEndNotificationTime').value = notifications.yearEndNotifications.time;
            
            // Update notification group states
            updateNotificationGroupStates();
            
            updateSchedulePreview();
        }

        function updateSchedulePreview() {
            const assignmentStart = document.getElementById('assignmentStartDate').value;
            const assignmentEnd = document.getElementById('assignmentEndDate').value;
            const midYearStart = document.getElementById('midYearStartDate').value;
            const midYearEnd = document.getElementById('midYearEndDate').value;
            const yearEndStart = document.getElementById('yearEndStartDate').value;
            const yearEndEnd = document.getElementById('yearEndEndDate').value;

            // Format dates for display
            const formatDate = (dateString) => {
                if (!dateString) return 'Not set';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            };

            document.getElementById('assignmentPeriodPreview').textContent = 
                assignmentStart && assignmentEnd ? 
                `${formatDate(assignmentStart)} - ${formatDate(assignmentEnd)}` : 
                'Select dates to see preview';

            document.getElementById('midYearPeriodPreview').textContent = 
                midYearStart && midYearEnd ? 
                `${formatDate(midYearStart)} - ${formatDate(midYearEnd)}` : 
                'Select dates to see preview';

            document.getElementById('yearEndPeriodPreview').textContent = 
                yearEndStart && yearEndEnd ? 
                `${formatDate(yearEndStart)} - ${formatDate(yearEndEnd)}` : 
                'Select dates to see preview';
        }

        function validateScheduleDates(schedule) {
            const dates = [
                { name: 'Assignment Start', date: new Date(schedule.assignmentStartDate) },
                { name: 'Assignment End', date: new Date(schedule.assignmentEndDate) },
                { name: 'Mid Year Start', date: new Date(schedule.midYearStartDate) },
                { name: 'Mid Year End', date: new Date(schedule.midYearEndDate) },
                { name: 'Year End Start', date: new Date(schedule.yearEndStartDate) },
                { name: 'Year End End', date: new Date(schedule.yearEndEndDate) }
            ];

            // Check if all dates are valid
            for (let dateObj of dates) {
                if (isNaN(dateObj.date.getTime())) {
                    showErrorMessage(`Invalid ${dateObj.name} date. Please select a valid date.`);
                    return false;
                }
            }

            // Check date order within periods
            if (new Date(schedule.assignmentStartDate) >= new Date(schedule.assignmentEndDate)) {
                showErrorMessage('Assignment start date must be before assignment end date.');
                return false;
            }

            if (new Date(schedule.midYearStartDate) >= new Date(schedule.midYearEndDate)) {
                showErrorMessage('Mid year start date must be before mid year end date.');
                return false;
            }

            if (new Date(schedule.yearEndStartDate) >= new Date(schedule.yearEndEndDate)) {
                showErrorMessage('Year end start date must be before year end end date.');
                return false;
            }

            // Check logical order of periods (assignment -> mid year -> year end)
            if (new Date(schedule.assignmentEndDate) > new Date(schedule.midYearStartDate)) {
                showErrorMessage('Assignment period should end before mid year evaluation begins.');
                return false;
            }

            if (new Date(schedule.midYearEndDate) > new Date(schedule.yearEndStartDate)) {
                showErrorMessage('Mid year evaluation should end before year end evaluation begins.');
                return false;
            }

            return true;
        }

        function applyScheduleToKPISystem(schedule) {
            // This function will be called to apply the schedule settings to the KPI system
            // It can be used to update the KPI creation form and evaluation tabs
            
            // Store schedule for use across the application
            sessionStorage.setItem('currentKPISchedule', JSON.stringify(schedule));
            
            // Update any existing UI elements that might show schedule information
            updateKPIFormScheduleInfo(schedule);
        }

        // Send KPI assignment notifications to line managers
        async function sendKPIAssignmentNotifications(schedule, notificationNumber = null) {
            try {
                const notificationLabel = notificationNumber ? ` #${notificationNumber}` : '';
                console.log(`Sending KPI assignment notifications${notificationLabel} to line managers...`);
                
                // Get all users to find line managers and their direct reports
                const usersRef = window.firebaseRef(window.firebaseDb, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (!snapshot.exists()) {
                    console.warn('No users found for KPI assignment notifications');
                    showErrorMessage('No users found in the database');
                    return;
                }

                const users = snapshot.val();
                console.log('Users found:', Object.keys(users).length);
                
                // Create a lookup map for all users by their full names (same logic as users.html)
                const userEmailMap = {};
                const usersByEmail = {};
                
                Object.entries(users).forEach(([userId, user]) => {
                    const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                    if (fullName && user.email) {
                        userEmailMap[fullName] = user.email;
                    }
                    if (user.email) {
                        usersByEmail[user.email.toLowerCase()] = user;
                    }
                });
                
                console.log('User email mapping created for', Object.keys(userEmailMap).length, 'users');
                
                // Group users by line manager using the same logic as users.html
                const lineManagerGroups = {};
                
                Object.entries(users).forEach(([userId, user]) => {
                    // Check both lineManagerName (preferred) and lineManager (fallback)
                    const managerName = (user.lineManagerName || user.lineManager || '').trim();
                    
                    if (managerName) {
                        if (!lineManagerGroups[managerName]) {
                            lineManagerGroups[managerName] = {
                                managerName: managerName,
                                managerEmail: userEmailMap[managerName] || null,
                                directReports: []
                            };
                        }
                        
                        // Add this user as a direct report (excluding the manager themselves)
                        const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim();
                        if (fullName !== managerName) {
                            lineManagerGroups[managerName].directReports.push({
                                name: fullName,
                                email: user.email,
                                department: user.department || 'Not specified',
                                position: user.jobTitle || 'Not specified'
                            });
                        }
                    }
                });

                console.log('Line manager groups found:', Object.keys(lineManagerGroups).length);
                
                // Log details for debugging
                Object.entries(lineManagerGroups).forEach(([managerName, group]) => {
                    console.log(`Manager: ${managerName}`);
                    console.log(`  - Manager email:`, group.managerEmail || 'Email not found');
                    console.log(`  - Direct reports:`, group.directReports.length);
                    group.directReports.forEach(report => {
                        console.log(`    - ${report.name} (${report.position})`);
                    });
                });

                // Send notifications to each line manager
                const notificationPromises = [];
                
                Object.entries(lineManagerGroups).forEach(([managerName, group]) => {
                    if (group.managerEmail && group.directReports.length > 0) {
                        console.log(`✉️ Preparing notification for ${managerName} (${group.managerEmail}) - ${group.directReports.length} direct reports`);
                        
                        const notificationData = {
                            toEmail: group.managerEmail,
                            lineManagerName: managerName,
                            assignmentStartDate: formatDate(schedule.assignmentStartDate),
                            assignmentEndDate: formatDate(schedule.assignmentEndDate),
                            midYearStartDate: formatDate(schedule.midYearStartDate),
                            midYearEndDate: formatDate(schedule.midYearEndDate),
                            yearEndStartDate: formatDate(schedule.yearEndStartDate),
                            yearEndEndDate: formatDate(schedule.yearEndEndDate),
                            directReportsList: group.directReports,
                            totalDirectReports: group.directReports.length,
                            companyName: 'Dreamex Datalab',
                            year: new Date().getFullYear()
                        };

                        // Send the notification
                        const notificationPromise = sendEmailNotification(
                            'kpi-assignment',
                            notificationData,
                            'KPI Assignment Notification'
                        ).then(() => {
                            console.log(`✅ KPI assignment notification sent to ${managerName} (${group.managerEmail})`);
                        }).catch(error => {
                            console.error(`❌ Failed to send KPI notification to ${managerName}:`, error);
                        });

                        notificationPromises.push(notificationPromise);
                    } else {
                        const reasons = [];
                        if (!group.managerEmail) reasons.push('line manager email not found in user database');
                        if (group.directReports.length === 0) reasons.push('no direct reports found');
                        
                        console.warn(`⚠️ Skipping notification for line manager "${managerName}": ${reasons.join(', ')}`);
                    }
                });

                // Wait for all notifications to be sent
                if (notificationPromises.length > 0) {
                    await Promise.all(notificationPromises);
                    showSuccessMessage(`🎉 KPI assignment notifications sent successfully to ${notificationPromises.length} line manager(s)!`);
                } else {
                    console.warn('No KPI assignment notifications were sent - no valid line managers found');
                    showErrorMessage('⚠️ No line managers found with valid email addresses and direct reports. Please check that line manager names in user profiles match existing user names exactly.');
                }

            } catch (error) {
                console.error('Error sending KPI assignment notifications:', error);
                showErrorMessage(`Failed to send KPI assignment notifications: ${error.message}`);
            }
        }

        // Send KPI mid-year evaluation notifications to employees
        async function sendKPIMidYearEvaluationNotifications(schedule, notificationNumber = null) {
            try {
                const notificationLabel = notificationNumber ? ` #${notificationNumber}` : '';
                console.log(`Sending KPI mid-year evaluation notifications${notificationLabel} to employees...`);
                
                // Get all users to find employees who need to complete mid-year evaluations
                const usersRef = window.firebaseRef(window.firebaseDb, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (!snapshot.exists()) {
                    console.warn('No users found for KPI mid-year evaluation notifications');
                    showErrorMessage('No users found in the database');
                    return;
                }

                const users = snapshot.val();
                console.log('Users found for mid-year evaluation:', Object.keys(users).length);
                
                // Get all active employees (exclude admins and inactive users)
                const activeEmployees = [];
                
                Object.entries(users).forEach(([userId, user]) => {
                    // Include active employees who should have KPIs
                    if (user.email && user.firstName && user.lastName && 
                        user.status !== 'inactive' && user.role !== 'admin') {
                        const fullName = `${user.firstName} ${user.lastName}`.trim();
                        activeEmployees.push({
                            userId: userId,
                            email: user.email,
                            name: fullName,
                            department: user.department || 'Not specified',
                            lineManagerName: user.lineManagerName || user.lineManager || 'Not assigned',
                            jobTitle: user.jobTitle || 'Not specified'
                        });
                    }
                });

                console.log('Active employees found:', activeEmployees.length);
                
                // Check if we have any KPIs assigned to get more accurate counts
                const kpisRef = window.firebaseRef(window.firebaseDb, 'kpis');
                const kpisSnapshot = await window.firebaseGet(kpisRef);
                let employeeKPIStats = {};
                
                if (kpisSnapshot.exists()) {
                    const kpis = kpisSnapshot.val();
                    Object.entries(kpis).forEach(([kpiId, kpi]) => {
                        if (kpi.teamMember && kpi.status === 'active') {
                            if (!employeeKPIStats[kpi.teamMember]) {
                                employeeKPIStats[kpi.teamMember] = {
                                    total: 0,
                                    onTrack: 0,
                                    ahead: 0,
                                    behind: 0
                                };
                            }
                            employeeKPIStats[kpi.teamMember].total++;
                            
                            // Simulate progress calculation for demo
                            const progress = Math.random() * 100;
                            if (progress >= 90) employeeKPIStats[kpi.teamMember].ahead++;
                            else if (progress >= 70) employeeKPIStats[kpi.teamMember].onTrack++;
                            else employeeKPIStats[kpi.teamMember].behind++;
                        }
                    });
                }

                // Send notifications to each employee
                const notificationPromises = [];
                
                activeEmployees.forEach(employee => {
                    console.log(`✉️ Preparing mid-year evaluation notification for ${employee.name} (${employee.email})`);
                    
                    // Get KPI stats for this employee
                    const kpiStats = employeeKPIStats[employee.name] || {
                        total: 0, onTrack: 0, ahead: 0, behind: 0
                    };
                    
                    const overallProgress = kpiStats.total > 0 ? 
                        Math.round(((kpiStats.onTrack + kpiStats.ahead) / kpiStats.total) * 100) : 0;
                    
                    const notificationData = {
                        toEmail: employee.email,
                        employeeName: employee.name,
                        department: employee.department,
                        lineManagerName: employee.lineManagerName,
                        evaluationPeriod: `${formatDate(schedule.midYearStartDate)} - ${formatDate(schedule.midYearEndDate)}`,
                        midYearStartDate: formatDate(schedule.midYearStartDate),
                        midYearEndDate: formatDate(schedule.midYearEndDate),
                        fiscalYear: new Date().getFullYear(),
                        totalKPIs: kpiStats.total,
                        kpisOnTrack: kpiStats.onTrack,
                        kpisAheadOfTarget: kpiStats.ahead,
                        kpisBehindTarget: kpiStats.behind,
                        overallProgressPercentage: overallProgress,
                        selfEvaluationDeadline: formatDate(schedule.midYearEndDate),
                        managerReviewPeriod: `${formatDate(schedule.midYearEndDate)} - ${formatDate(new Date(schedule.midYearEndDate).getTime() + 7 * 24 * 60 * 60 * 1000)}`,
                        oneOnOneMeetingDate: 'To be scheduled with line manager',
                        finalEvaluationDate: formatDate(new Date(schedule.midYearEndDate).getTime() + 14 * 24 * 60 * 60 * 1000),
                        kpiSystemLink: window.location.origin + '/kpi.html',
                        companyName: 'Dreamex Datalab'
                    };

                    // Send the mid-year evaluation notification
                    const notificationPromise = sendEmailNotification(
                        'kpi-midyear-evaluation',
                        notificationData,
                        'KPI Mid-Year Evaluation Notification'
                    ).then(() => {
                        console.log(`✅ Mid-year evaluation notification sent to ${employee.name} (${employee.email})`);
                    }).catch(error => {
                        console.error(`❌ Failed to send mid-year evaluation notification to ${employee.name}:`, error);
                    });

                    notificationPromises.push(notificationPromise);
                });

                // Wait for all notifications to be sent
                if (notificationPromises.length > 0) {
                    await Promise.all(notificationPromises);
                    showSuccessMessage(`🎉 KPI mid-year evaluation notifications sent successfully to ${notificationPromises.length} employee(s)!`);
                } else {
                    console.warn('No mid-year evaluation notifications were sent - no active employees found');
                    showErrorMessage('⚠️ No active employees found for mid-year evaluation notifications.');
                }

            } catch (error) {
                console.error('Error sending KPI mid-year evaluation notifications:', error);
                showErrorMessage(`Failed to send KPI mid-year evaluation notifications: ${error.message}`);
            }
        }

        // Send KPI year-end evaluation notifications to employees
        async function sendKPIYearEndEvaluationNotifications(schedule, notificationNumber = null) {
            try {
                const notificationLabel = notificationNumber ? ` #${notificationNumber}` : '';
                console.log(`Sending KPI year-end evaluation notifications${notificationLabel} to employees...`);
                
                // Get all users to find employees who need to complete year-end evaluations
                const usersRef = window.firebaseRef(window.firebaseDb, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (!snapshot.exists()) {
                    console.warn('No users found for KPI year-end evaluation notifications');
                    showErrorMessage('No users found in the database');
                    return;
                }

                const users = snapshot.val();
                console.log('Users found for year-end evaluation:', Object.keys(users).length);
                
                // Get all active employees (exclude admins and inactive users)
                const activeEmployees = [];
                
                Object.entries(users).forEach(([userId, user]) => {
                    // Include active employees who should have KPIs
                    if (user.email && user.firstName && user.lastName && 
                        user.status !== 'inactive' && user.role !== 'admin') {
                        const fullName = `${user.firstName} ${user.lastName}`.trim();
                        activeEmployees.push({
                            userId: userId,
                            email: user.email,
                            name: fullName,
                            department: user.department || 'Not specified',
                            lineManagerName: user.lineManagerName || user.lineManager || 'Not assigned',
                            jobTitle: user.jobTitle || 'Not specified'
                        });
                    }
                });

                console.log('Active employees found for year-end evaluation:', activeEmployees.length);
                
                // Check if we have any KPIs assigned to get more accurate counts
                const kpisRef = window.firebaseRef(window.firebaseDb, 'kpis');
                const kpisSnapshot = await window.firebaseGet(kpisRef);
                let employeeKPIStats = {};
                
                if (kpisSnapshot.exists()) {
                    const kpis = kpisSnapshot.val();
                    Object.entries(kpis).forEach(([kpiId, kpi]) => {
                        if (kpi.teamMember && kpi.status === 'active') {
                            if (!employeeKPIStats[kpi.teamMember]) {
                                employeeKPIStats[kpi.teamMember] = {
                                    total: 0,
                                    fullyAchieved: 0,
                                    partiallyAchieved: 0,
                                    notAchieved: 0
                                };
                            }
                            employeeKPIStats[kpi.teamMember].total++;
                            
                            // Simulate year-end achievement calculation for demo
                            const achievement = Math.random() * 100;
                            if (achievement >= 95) employeeKPIStats[kpi.teamMember].fullyAchieved++;
                            else if (achievement >= 60) employeeKPIStats[kpi.teamMember].partiallyAchieved++;
                            else employeeKPIStats[kpi.teamMember].notAchieved++;
                        }
                    });
                }

                // Send notifications to each employee
                const notificationPromises = [];
                
                activeEmployees.forEach(employee => {
                    console.log(`✉️ Preparing year-end evaluation notification for ${employee.name} (${employee.email})`);
                    
                    // Get KPI stats for this employee
                    const kpiStats = employeeKPIStats[employee.name] || {
                        total: 0, fullyAchieved: 0, partiallyAchieved: 0, notAchieved: 0
                    };
                    
                    const overallAchievementRate = kpiStats.total > 0 ? 
                        Math.round(((kpiStats.fullyAchieved + (kpiStats.partiallyAchieved * 0.5)) / kpiStats.total) * 100) : 0;
                    
                    // Calculate performance rating based on achievement rate
                    let performanceRating = 1.0;
                    if (overallAchievementRate >= 95) performanceRating = 5.0;
                    else if (overallAchievementRate >= 85) performanceRating = 4.5;
                    else if (overallAchievementRate >= 75) performanceRating = 4.0;
                    else if (overallAchievementRate >= 60) performanceRating = 3.5;
                    else if (overallAchievementRate >= 40) performanceRating = 3.0;
                    else if (overallAchievementRate >= 25) performanceRating = 2.5;
                    else if (overallAchievementRate >= 15) performanceRating = 2.0;
                    else performanceRating = 1.5;
                    
                    const currentYear = new Date().getFullYear();
                    const nextYear = currentYear + 1;
                    
                    const notificationData = {
                        toEmail: employee.email,
                        employeeName: employee.name,
                        department: employee.department,
                        jobTitle: employee.jobTitle,
                        lineManagerName: employee.lineManagerName,
                        evaluationYear: currentYear,
                        yearEndStartDate: formatDate(schedule.yearEndStartDate),
                        yearEndEndDate: formatDate(schedule.yearEndEndDate),
                        fiscalYearPeriod: `${currentYear} (Jan 1 - Dec 31, ${currentYear})`,
                        totalKPIs: kpiStats.total,
                        kpisFullyAchieved: kpiStats.fullyAchieved,
                        kpisPartiallyAchieved: kpiStats.partiallyAchieved,
                        kpisNotAchieved: kpiStats.notAchieved,
                        overallAchievementRate: overallAchievementRate,
                        performanceRating: performanceRating.toFixed(1),
                        selfEvaluationDeadline: formatDate(schedule.yearEndEndDate),
                        managerReviewPeriod: `${formatDate(schedule.yearEndEndDate)} - ${formatDate(new Date(new Date(schedule.yearEndEndDate).getTime() + 10 * 24 * 60 * 60 * 1000))}`,
                        managerReviewDeadline: formatDate(new Date(new Date(schedule.yearEndEndDate).getTime() + 10 * 24 * 60 * 60 * 1000)),
                        performanceReviewMeetingDate: 'To be scheduled with line manager',
                        finalRatingApprovalDate: formatDate(new Date(new Date(schedule.yearEndEndDate).getTime() + 21 * 24 * 60 * 60 * 1000)),
                        salaryReviewDate: `Q1 ${nextYear} (if applicable)`,
                        nextYearKPIPlanningDate: `January ${nextYear}`,
                        kpiSystemLink: window.location.origin + '/kpi.html',
                        notificationId: `YE${currentYear}_${employee.userId}_${Date.now()}`,
                        generationTimestamp: new Date().toLocaleString(),
                        companyName: 'Dreamex Datalab'
                    };

                    // Send the year-end evaluation notification
                    const notificationPromise = sendEmailNotification(
                        'kpi-yearend-evaluation',
                        notificationData,
                        'KPI Year-End Evaluation Notification'
                    ).then(() => {
                        console.log(`✅ Year-end evaluation notification sent to ${employee.name} (${employee.email})`);
                    }).catch(error => {
                        console.error(`❌ Failed to send year-end evaluation notification to ${employee.name}:`, error);
                    });

                    notificationPromises.push(notificationPromise);
                });

                // Wait for all notifications to be sent
                if (notificationPromises.length > 0) {
                    await Promise.all(notificationPromises);
                    showSuccessMessage(`🎉 KPI year-end evaluation notifications sent successfully to ${notificationPromises.length} employee(s)!`);
                } else {
                    console.warn('No year-end evaluation notifications were sent - no active employees found');
                    showErrorMessage('⚠️ No active employees found for year-end evaluation notifications.');
                }

            } catch (error) {
                console.error('Error sending KPI year-end evaluation notifications:', error);
                showErrorMessage(`Failed to send KPI year-end evaluation notifications: ${error.message}`);
            }
        }

        // Helper function to send email notifications
        async function sendEmailNotification(type, data, description) {
            const API_KEY = 'dreemex_hse_email_service_2025';
            
            let emailPayload;
            let endpoint = 'http://localhost:3001/send/kpi-assignment';

            if (type === 'kpi-midyear-evaluation') {
                // Mid-year evaluation template for employees
                const midYearTemplate = `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        KPI MID-YEAR EVALUATION NOTIFICATION
================================================================================

Dear ${data.employeeName},

The KPI mid-year evaluation period has officially started! It's time to review your performance for the first half of the evaluation cycle and update your KPI progress.

EVALUATION PERIOD DETAILS:
--------------------------------------------------------------------------------
Employee Name         : ${data.employeeName}
Department           : ${data.department}
Line Manager         : ${data.lineManagerName}
Evaluation Period    : ${data.evaluationPeriod}
Mid-Year Start Date  : ${data.midYearStartDate}
Mid-Year End Date    : ${data.midYearEndDate}
Fiscal Year          : ${data.fiscalYear}

YOUR KPI PERFORMANCE SUMMARY:
--------------------------------------------------------------------------------
Total KPIs Assigned  : ${data.totalKPIs}
KPIs On Track        : ${data.kpisOnTrack}
KPIs Ahead of Target : ${data.kpisAheadOfTarget}
KPIs Behind Target   : ${data.kpisBehindTarget}
Overall Progress     : ${data.overallProgressPercentage}%

EVALUATION TIMELINE:
--------------------------------------------------------------------------------
📅 Self-Evaluation Due       : ${data.selfEvaluationDeadline}
👥 Manager Review Period     : ${data.managerReviewPeriod}
🤝 One-on-One Meeting       : ${data.oneOnOneMeetingDate}
📊 Final Evaluation Complete : ${data.finalEvaluationDate}

REQUIRED ACTIONS FOR YOU:
--------------------------------------------------------------------------------
1. 📝 Complete self-evaluation for all assigned KPIs
2. 📊 Update progress percentages and achievement status
3. 💬 Provide comments on challenges and successes
4. 📈 Suggest adjustments for the remaining evaluation period
5. 📅 Schedule meeting with your line manager
6. 🎯 Submit evaluation by the deadline

SELF-EVALUATION GUIDELINES:
--------------------------------------------------------------------------------
✓ Be honest and objective about your performance
✓ Provide specific examples and evidence of achievements
✓ Highlight challenges faced and how you addressed them
✓ Suggest realistic adjustments for remaining period
✓ Include any support or resources needed
✓ Document professional development activities completed

MID-YEAR EVALUATION FOCUS AREAS:
--------------------------------------------------------------------------------
🎯 Achievement Rate: How much of your annual target have you achieved?
📈 Progress Trend: Are you on track to meet year-end goals?
🚧 Obstacles: What challenges have impacted your performance?
💡 Solutions: What strategies have worked well for you?
🔄 Adjustments: What changes might improve your performance?
📚 Development: What skills or training would help you succeed?

SYSTEM ACCESS:
--------------------------------------------------------------------------------
Access your KPI evaluation: ${data.kpiSystemLink}
- Log in with your corporate credentials
- Navigate to "Mid-Year Evaluation" section
- Complete all required fields
- Save draft frequently to avoid data loss
- Submit final evaluation before deadline

EVALUATION SCALE:
--------------------------------------------------------------------------------
🟢 Exceeding Expectations (4.5-5.0): Significantly above target
🔵 Meeting Expectations (3.5-4.4): On track to achieve goals
🟡 Approaching Expectations (2.5-3.4): Some improvement needed
🔴 Below Expectations (1.0-2.4): Significant improvement required

MEETING PREPARATION:
--------------------------------------------------------------------------------
Before your one-on-one meeting with ${data.lineManagerName}, prepare:
• Review all KPI progress and self-ratings
• Prepare examples of achievements and challenges
• List any support or resources needed
• Think about goals for the remaining period
• Consider professional development opportunities

SUPPORT RESOURCES:
--------------------------------------------------------------------------------
📞 HR Support: extension 1234
📧 Performance Support: performance@dreamexdatalab.com
📖 Evaluation Guidelines: Available in employee portal
🎓 Performance Resources: Training materials available
👥 Peer Support: Connect with colleagues for best practices

IMPORTANT REMINDERS:
--------------------------------------------------------------------------------
⚠️  Complete evaluation by ${data.selfEvaluationDeadline}
⚠️  Missing the deadline may delay your performance review
⚠️  Be thorough and provide detailed comments
⚠️  Schedule your manager meeting early to avoid delays
⚠️  Contact HR if you experience any technical issues

CONFIDENTIALITY:
--------------------------------------------------------------------------------
Your evaluation responses are confidential and will only be shared with:
• Your direct line manager
• HR team members involved in the review process
• Senior management as required for approval processes

This mid-year evaluation is an important milestone in your professional development. We encourage open and honest feedback to support your growth and success.

Best regards,
Dreamex Datalab HR Team
Performance Management Division

================================================================================
This is an automated evaluation notification.
For urgent assistance: hr-urgent@dreamexdatalab.com
================================================================================`;

                emailPayload = {
                    to: data.toEmail,
                    toName: data.employeeName,
                    subject: `KPI Mid-Year Evaluation Period Started - ${data.employeeName} - ${data.evaluationPeriod}`,
                    htmlContent: midYearTemplate.replace(/\n/g, '<br>'),
                    templateType: 'kpi-midyear-evaluation',
                    priority: 'normal'
                };
                endpoint = 'http://localhost:3001/send/kpi-assignment';

            } else if (type === 'kpi-yearend-evaluation') {
                // Year-end evaluation template for employees
                const yearEndTemplate = `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        KPI YEAR-END EVALUATION NOTIFICATION
================================================================================

Dear ${data.employeeName},

The KPI year-end evaluation period has officially started! It's time to conduct your comprehensive annual performance review and finalize your KPI achievements for the entire evaluation cycle.

EVALUATION PERIOD DETAILS:
--------------------------------------------------------------------------------
Employee Name         : ${data.employeeName}
Department           : ${data.department}
Position             : ${data.jobTitle}
Line Manager         : ${data.lineManagerName}
Evaluation Year      : ${data.evaluationYear}
Year-End Start Date  : ${data.yearEndStartDate}
Year-End End Date    : ${data.yearEndEndDate}
Fiscal Year Period   : ${data.fiscalYearPeriod}

ANNUAL KPI PERFORMANCE SUMMARY:
--------------------------------------------------------------------------------
Total KPIs Assigned        : ${data.totalKPIs}
KPIs Fully Achieved        : ${data.kpisFullyAchieved}
KPIs Partially Achieved    : ${data.kpisPartiallyAchieved}
KPIs Not Achieved          : ${data.kpisNotAchieved}
Overall Achievement Rate   : ${data.overallAchievementRate}%
Performance Rating         : ${data.performanceRating} / 5.0 ⭐

EVALUATION TIMELINE:
--------------------------------------------------------------------------------
📅 Self-Evaluation Due           : ${data.selfEvaluationDeadline}
👥 Manager Review Period         : ${data.managerReviewPeriod}
🤝 Performance Review Meeting    : ${data.performanceReviewMeetingDate}
📊 Final Rating Approval         : ${data.finalRatingApprovalDate}
💰 Salary Review (if applicable) : ${data.salaryReviewDate}
🎯 Next Year KPI Planning        : ${data.nextYearKPIPlanningDate}

COMPREHENSIVE EVALUATION REQUIREMENTS:
--------------------------------------------------------------------------------
1. 📝 Complete detailed self-evaluation for all KPIs
2. 📊 Provide final achievement percentages and evidence
3. 💬 Write comprehensive comments on performance
4. 🏆 Highlight major accomplishments and successes
5. 🚧 Document challenges and how they were addressed
6. 📈 Assess professional development and growth
7. 🎯 Propose objectives for the upcoming year
8. 📅 Schedule comprehensive review meeting

YEAR-END EVALUATION COMPONENTS:
--------------------------------------------------------------------------------
🎯 KPI Achievement Assessment:
   • Quantitative results vs. targets
   • Quality of work delivered
   • Timeliness and consistency
   • Innovation and problem-solving

📈 Professional Development Review:
   • Skills acquired during the year
   • Training and certifications completed
   • Leadership and initiative demonstrated
   • Collaboration and teamwork

🤝 Behavioral Competencies:
   • Communication effectiveness
   • Adaptability and flexibility
   • Accountability and ownership
   • Customer service orientation

SELF-EVALUATION GUIDELINES:
--------------------------------------------------------------------------------
✓ Provide comprehensive and honest assessment
✓ Include specific examples and quantifiable achievements
✓ Document major projects and contributions
✓ Reflect on learning and professional growth
✓ Acknowledge areas for improvement
✓ Support claims with evidence and data
✓ Consider feedback received throughout the year

PERFORMANCE RATING SCALE:
--------------------------------------------------------------------------------
🌟 Outstanding (4.5-5.0): Consistently exceeds expectations, exceptional performance
⭐ Exceeds Expectations (4.0-4.4): Frequently exceeds requirements and targets
✅ Meets Expectations (3.0-3.9): Consistently meets job requirements and standards
⚠️  Improvement Needed (2.0-2.9): Performance below expectations in some areas
❌ Unsatisfactory (1.0-1.9): Performance significantly below requirements

CAREER DEVELOPMENT DISCUSSION:
--------------------------------------------------------------------------------
Your year-end review will include discussion about:
• Career aspirations and goals
• Potential advancement opportunities
• Professional development needs
• Skill gaps and training requirements
• Mentoring and coaching opportunities
• Next year's role responsibilities

COMPENSATION REVIEW:
--------------------------------------------------------------------------------
Based on your performance evaluation, the following may be considered:
• Merit-based salary adjustments
• Performance bonuses and incentives
• Promotion opportunities
• Additional benefits or allowances
• Professional development funding
• Recognition and awards

SYSTEM ACCESS & TECHNICAL SUPPORT:
--------------------------------------------------------------------------------
Access your year-end evaluation: ${data.kpiSystemLink}
- Complete all evaluation sections thoroughly
- Save progress frequently
- Upload supporting documents if required
- Review all entries before final submission
- Contact IT support for technical issues

MEETING PREPARATION CHECKLIST:
--------------------------------------------------------------------------------
Before your performance review meeting with ${data.lineManagerName}:
□ Complete all self-evaluation sections
□ Gather evidence of achievements
□ Prepare examples of key accomplishments
□ List professional development activities
□ Consider career goals for next year
□ Prepare questions about feedback and development
□ Review company objectives for alignment

IMPORTANT DEADLINES:
--------------------------------------------------------------------------------
⏰ Self-Evaluation Submission: ${data.selfEvaluationDeadline}
⏰ Manager Review Completion: ${data.managerReviewDeadline}
⏰ Performance Meeting: ${data.performanceReviewMeetingDate}
⏰ Final Rating Approval: ${data.finalRatingApprovalDate}

SUPPORT & RESOURCES:
--------------------------------------------------------------------------------
📞 HR Support Hotline: extension 1234
📧 Performance Team: performance@dreamexdatalab.com
📧 Technical Support: it-support@dreamexdatalab.com
📖 Evaluation Guide: Available in employee portal
🎓 Career Development: career-dev@dreamexdatalab.com

CONFIDENTIALITY & DATA PROTECTION:
--------------------------------------------------------------------------------
Your evaluation data is strictly confidential and protected under company policy.
Access is limited to:
• Your direct line manager
• HR performance management team
• Senior management for approval processes
• Only as required for legitimate business purposes

RECOGNITION & REWARDS:
--------------------------------------------------------------------------------
Outstanding performers may be eligible for:
🏆 Employee of the Year awards
💰 Performance bonuses
📈 Promotion considerations
🎓 Professional development opportunities
🌟 Public recognition and appreciation
🎁 Additional benefits and perquisites

Your year-end evaluation is a crucial component of your career development at Dreamex Datalab. We encourage thorough preparation and honest reflection to maximize the value of this process.

Thank you for your dedication and contributions throughout the year!

Best regards,
Dreamex Datalab HR Team
Performance Management & Career Development Division

================================================================================
This is an automated year-end evaluation notification.
For immediate assistance: hr-urgent@dreamexdatalab.com
Report ID: ${data.notificationId} | Generated: ${data.generationTimestamp}
================================================================================`;

                emailPayload = {
                    to: data.toEmail,
                    toName: data.employeeName,
                    subject: `KPI Year-End Evaluation Period Started - ${data.employeeName} - ${data.evaluationYear}`,
                    htmlContent: yearEndTemplate.replace(/\n/g, '<br>'),
                    templateType: 'kpi-yearend-evaluation',
                    priority: 'normal'
                };
                endpoint = 'http://localhost:3001/send/kpi-assignment';

            } else {
                // Default: KPI assignment template for line managers
                const directReportsHtml = data.directReportsList ? data.directReportsList.map(report => 
                    `<li><strong>${report.name}</strong> - ${report.position} (${report.department})</li>`
                ).join('') : '';

                const htmlContent = `
                    <div style="margin-bottom: 20px;">
                        <h2 style="color: #2c3e50;">Dear ${data.lineManagerName},</h2>
                        <p>We hope this message finds you well. The KPI performance evaluation cycle for <strong>${data.year}</strong> has been scheduled, and we need your assistance in organizing meetings with your direct reports.</p>
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h3 style="color: #2c3e50; margin-top: 0;">📅 KPI Schedule Overview</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="background: #e9ecef;">
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">Assignment Period</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6;">${data.assignmentStartDate} to ${data.assignmentEndDate}</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">Mid-Year Evaluation</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6;">${data.midYearStartDate} to ${data.midYearEndDate}</td>
                            </tr>
                            <tr style="background: #e9ecef;">
                                <td style="padding: 10px; border: 1px solid #dee2e6; font-weight: bold;">Year-End Evaluation</td>
                                <td style="padding: 10px; border: 1px solid #dee2e6;">${data.yearEndStartDate} to ${data.yearEndEndDate}</td>
                            </tr>
                        </table>
                    </div>

                    <div style="margin: 20px 0;">
                        <h3 style="color: #2c3e50;">👥 Your Direct Reports (${data.totalDirectReports})</h3>
                        <p>Please organize KPI assignment meetings with the following team members:</p>
                        <ul style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                            ${directReportsHtml}
                        </ul>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
                        <h4 style="color: #856404; margin-top: 0;">📋 Action Required</h4>
                        <p style="color: #856404; margin-bottom: 0;">Please schedule individual meetings with each of your direct reports during the assignment period (${data.assignmentStartDate} to ${data.assignmentEndDate}) to discuss and assign their KPIs for ${data.year}.</p>
                    </div>

                    <div style="margin: 20px 0;">
                        <p>If you have any questions or need assistance with the KPI assignment process, please don't hesitate to reach out to the HR team.</p>
                        <p>Thank you for your continued leadership and commitment to our performance management process.</p>
                        <p style="margin-top: 30px;">Best regards,<br><strong>HR Team<br>${data.companyName}</strong></p>
                    </div>
                `;

                emailPayload = {
                    to: data.toEmail,
                    toName: data.lineManagerName || data.employeeName,
                    subject: `🎯 KPI Assignment Required - ${data.totalDirectReports} Direct Report${data.totalDirectReports > 1 ? 's' : ''} (${data.year})`,
                    htmlContent: htmlContent,
                    templateType: 'kpi-assignment',
                    priority: 'normal'
                };
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': API_KEY
                },
                body: JSON.stringify(emailPayload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to send ${description}: ${response.status} - ${errorText}`);
            }

            return await response.json();
        }

        // ===============================================
        // Multiple Notification Scheduling Functions
        // ===============================================

        /**
         * Add a new notification schedule for a specific period
         */
        function addNotificationSchedule(periodType) {
            const container = document.getElementById(`${periodType}NotificationSchedules`);
            const countBadge = document.getElementById(`${periodType}NotificationCount`);
            
            if (!container || !countBadge) {
                console.error(`Cannot find notification container for period: ${periodType}`);
                return;
            }
            
            const existingItems = container.querySelectorAll('.notification-schedule-item');
            const newIndex = existingItems.length;
            const notificationNumber = newIndex + 1;
            
            // Create new notification schedule item
            const newItem = document.createElement('div');
            newItem.className = 'notification-schedule-item';
            newItem.setAttribute('data-index', newIndex);
            
            newItem.innerHTML = `
                <div class="notification-item-header">
                    <span class="notification-item-title">Notification #${notificationNumber}</span>
                    <button type="button" class="notification-item-remove" onclick="removeNotificationSchedule('${periodType}', ${newIndex})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="datetime-input-group">
                    <div class="datetime-input-container">
                        <label for="${periodType}NotificationDate_${newIndex}" class="datetime-label">Date</label>
                        <input type="date" id="${periodType}NotificationDate_${newIndex}" name="${periodType}NotificationDate_${newIndex}" 
                               class="form-control datetime-input" required>
                    </div>
                    <div class="datetime-input-container">
                        <label for="${periodType}NotificationTime_${newIndex}" class="datetime-label">Time</label>
                        <input type="time" id="${periodType}NotificationTime_${newIndex}" name="${periodType}NotificationTime_${newIndex}" 
                               class="form-control datetime-input" value="09:00" required>
                    </div>
                </div>
            `;
            
            // Add the new item to the container
            container.appendChild(newItem);
            
            // Update count badge
            const newCount = existingItems.length + 1;
            countBadge.textContent = newCount;
            
            // Show remove buttons if there's more than one notification
            updateRemoveButtonVisibility(periodType);
            
            // Add event listeners to new datetime inputs for summary updates
            const newDatetimeInputs = newItem.querySelectorAll('.datetime-input');
            newDatetimeInputs.forEach(input => {
                input.addEventListener('change', updateNotificationScheduleSummary);
            });
            
            // Update notification summary
            updateNotificationScheduleSummary();
            
            // Scroll to the new item
            newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            console.log(`Added notification schedule #${notificationNumber} for ${periodType} period`);
        }

        /**
         * Remove a notification schedule for a specific period
         */
        function removeNotificationSchedule(periodType, index) {
            const container = document.getElementById(`${periodType}NotificationSchedules`);
            const countBadge = document.getElementById(`${periodType}NotificationCount`);
            
            if (!container || !countBadge) {
                console.error(`Cannot find notification container for period: ${periodType}`);
                return;
            }
            
            const itemToRemove = container.querySelector(`[data-index="${index}"]`);
            if (!itemToRemove) {
                console.error(`Cannot find notification item with index ${index} for period ${periodType}`);
                return;
            }
            
            // Animate removal
            itemToRemove.style.transition = 'all 0.3s ease';
            itemToRemove.style.opacity = '0';
            itemToRemove.style.transform = 'translateX(-100%)';
            
            setTimeout(() => {
                itemToRemove.remove();
                
                // Re-index remaining items and update their numbers
                reindexNotificationSchedules(periodType);
                
                // Update count badge
                const remainingItems = container.querySelectorAll('.notification-schedule-item');
                countBadge.textContent = remainingItems.length;
                
                // Update remove button visibility
                updateRemoveButtonVisibility(periodType);
                
                // Update notification summary
                updateNotificationScheduleSummary();
                
                console.log(`Removed notification schedule #${index + 1} for ${periodType} period`);
            }, 300);
        }

        /**
         * Re-index notification schedules after removal
         */
        function reindexNotificationSchedules(periodType) {
            const container = document.getElementById(`${periodType}NotificationSchedules`);
            const items = container.querySelectorAll('.notification-schedule-item');
            
            items.forEach((item, newIndex) => {
                // Update data-index attribute
                item.setAttribute('data-index', newIndex);
                
                // Update notification title
                const titleElement = item.querySelector('.notification-item-title');
                titleElement.textContent = `Notification #${newIndex + 1}`;
                
                // Update remove button onclick
                const removeButton = item.querySelector('.notification-item-remove');
                removeButton.setAttribute('onclick', `removeNotificationSchedule('${periodType}', ${newIndex})`);
                
                // Update input IDs and names
                const dateInput = item.querySelector('input[type="date"]');
                const timeInput = item.querySelector('input[type="time"]');
                const dateLabel = item.querySelector('label[for*="Date"]');
                const timeLabel = item.querySelector('label[for*="Time"]');
                
                if (dateInput) {
                    const newDateId = `${periodType}NotificationDate_${newIndex}`;
                    dateInput.id = newDateId;
                    dateInput.name = newDateId;
                    if (dateLabel) dateLabel.setAttribute('for', newDateId);
                }
                
                if (timeInput) {
                    const newTimeId = `${periodType}NotificationTime_${newIndex}`;
                    timeInput.id = newTimeId;
                    timeInput.name = newTimeId;
                    if (timeLabel) timeLabel.setAttribute('for', newTimeId);
                }
            });
        }

        /**
         * Update visibility of remove buttons based on number of items
         */
        function updateRemoveButtonVisibility(periodType) {
            const container = document.getElementById(`${periodType}NotificationSchedules`);
            const items = container.querySelectorAll('.notification-schedule-item');
            
            items.forEach((item, index) => {
                const removeButton = item.querySelector('.notification-item-remove');
                if (removeButton) {
                    removeButton.style.display = items.length > 1 ? 'flex' : 'none';
                }
            });
        }

        /**
         * Get all notification schedules for a specific period
         */
        function getNotificationSchedules(periodType) {
            const container = document.getElementById(`${periodType}NotificationSchedules`);
            if (!container) return [];
            
            const items = container.querySelectorAll('.notification-schedule-item');
            const schedules = [];
            
            items.forEach((item, index) => {
                const dateInput = item.querySelector('input[type="date"]');
                const timeInput = item.querySelector('input[type="time"]');
                
                if (dateInput && timeInput && dateInput.value && timeInput.value) {
                    schedules.push({
                        index: index,
                        date: dateInput.value,
                        time: timeInput.value,
                        datetime: `${dateInput.value}T${timeInput.value}:00`
                    });
                }
            });
            
            return schedules;
        }

        /**
         * Initialize multiple notification schedules on page load
         */
        function initializeMultipleNotificationSchedules() {
            const periodTypes = ['assignment', 'midYear', 'yearEnd'];
            
            periodTypes.forEach(periodType => {
                // Initialize remove button visibility
                updateRemoveButtonVisibility(periodType);
                
                // Add event listeners to existing datetime inputs
                const container = document.getElementById(`${periodType}NotificationSchedules`);
                if (container) {
                    const datetimeInputs = container.querySelectorAll('.datetime-input');
                    datetimeInputs.forEach(input => {
                        input.addEventListener('change', updateNotificationScheduleSummary);
                    });
                }
            });
            
            console.log('Multiple notification schedules initialized');
        }

        /**
         * Handle reminder schedule type change (interval vs specific dates)
         */

        // ===============================================
        // Notification Scheduling Functions (DateTime)
        // ===============================================

        /**
         * Test notification functionality - sends a test email immediately
         */
        async function testNotificationSending() {
            try {
                console.log('🧪 Testing notification sending...');
                
                // Create a test schedule with current data
                const testSchedule = {
                    assignmentStartDate: new Date().toISOString().split('T')[0],
                    assignmentEndDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    midYearStartDate: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    midYearEndDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    yearEndStartDate: new Date(Date.now() + 300 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    yearEndEndDate: new Date(Date.now() + 330 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    createdDate: new Date().toISOString()
                };
                
                // Show loading message
                showLoadingMessage('Sending test notification...');
                
                // Send test assignment notification
                await sendKPIAssignmentNotifications(testSchedule, 'TEST');
                
                hideLoadingMessage();
                
                // Show success message
                showSuccessMessage('✅ Test notification sent successfully! Check your email service logs and recipient inboxes.');
                
                console.log('✅ Test notification completed');
                
            } catch (error) {
                hideLoadingMessage();
                console.error('❌ Test notification failed:', error);
                showErrorMessage(`Test notification failed: ${error.message}`);
            }
        }

        // ...existing code...

        /**
         * Test KPI notification system - sends test notifications to verify email service
         */
        async function testKPINotifications() {
            try {
                // Check if email server is running
                console.log('🧪 Testing KPI notification system...');
                
                // First, check if the email server is available
                const healthResponse = await fetch('http://localhost:3001/health');
                if (!healthResponse.ok) {
                    throw new Error('Email server is not running. Please start the email service first.');
                }
                
                const healthData = await healthResponse.json();
                console.log('📧 Email server status:', healthData);
                
                if (!healthData.smtpReady) {
                    throw new Error('SMTP service is not ready. Please check email server configuration.');
                }
                
                // Get current schedule data
                const schedule = JSON.parse(localStorage.getItem('kpiSchedule') || '{}');
                
                if (!schedule.assignmentStartDate) {
                    // Use default test schedule if no schedule is saved
                    const today = new Date();
                    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                    const midYear = new Date(today.getFullYear(), 5, 1); // June 1st
                    const yearEnd = new Date(today.getFullYear(), 11, 1); // December 1st
                    
                    schedule.assignmentStartDate = today.toISOString().split('T')[0];
                    schedule.assignmentEndDate = nextWeek.toISOString().split('T')[0];
                    schedule.midYearStartDate = midYear.toISOString().split('T')[0];
                    schedule.midYearEndDate = new Date(midYear.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    schedule.yearEndStartDate = yearEnd.toISOString().split('T')[0];
                    schedule.yearEndEndDate = new Date(yearEnd.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                    
                    console.log('📅 Using default test schedule:', schedule);
                }
                
                // Show loading state
                showLoadingMessage('Testing email notifications...');
                
                // Send test notifications for assignment, mid-year, and year-end evaluations
                console.log('📧 Testing KPI assignment notifications to line managers...');
                await sendKPIAssignmentNotifications(schedule);
                console.log('✅ KPI assignment notifications test completed');
                
                showLoadingMessage('Testing mid-year evaluation notifications...');
                console.log('📧 Testing KPI mid-year evaluation notifications to employees...');
                await sendKPIMidYearEvaluationNotifications(schedule);
                console.log('✅ Mid-year evaluation notifications test completed');
                
                showLoadingMessage('Testing year-end evaluation notifications...');
                console.log('📧 Testing KPI year-end evaluation notifications to employees...');
                await sendKPIYearEndEvaluationNotifications(schedule);
                console.log('✅ Year-end evaluation notifications test completed');
                
                // Hide loading state
                hideLoadingMessage();
                
                console.log('🎉 All KPI notification tests completed successfully!');
                
            } catch (error) {
                console.error('❌ KPI notification test failed:', error);
                hideLoadingMessage();
                
                let errorMessage = `Notification test failed: ${error.message}`;
                
                if (error.message.includes('Email server is not running')) {
                    errorMessage += '\n\n💡 To fix this:\n1. Open a terminal in the email-service folder\n2. Run: npm start\n3. Wait for "Email notification service running" message\n4. Try the test again';
                } else if (error.message.includes('SMTP service is not ready')) {
                    errorMessage += '\n\n💡 Check your SMTP configuration in email-service/.env file';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage += '\n\n💡 Make sure the email server is running on http://localhost:3001';
                }
                
                showErrorMessage(errorMessage);
            }
        }

        /**
         * Show loading message
         */
        function showLoadingMessage(message) {
            let overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.querySelector('p').textContent = message;
                overlay.style.display = 'flex';
            }
        }

        /**
         * Hide loading message
         */
        function hideLoadingMessage() {
            let overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        /**
         * Initialize notification scheduling system with datetime inputs
         */
        function initializeNotificationScheduling() {
            console.log('Initializing notification scheduling system...');
            
            // Add event listeners for notification group toggles
            const notificationToggles = [
                'enableAssignmentNotifications',
                'enableMidYearNotifications', 
                'enableYearEndNotifications',
                'enableReminderNotifications'
            ];
            
            notificationToggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', handleNotificationToggle);
                }
            });
            
            // Add event listeners for reminder schedule type radio buttons
            const reminderTypeRadios = document.querySelectorAll('input[name="reminderScheduleType"]');
            reminderTypeRadios.forEach(radio => {
                radio.addEventListener('change', handleReminderScheduleTypeChange);
            });
            
            // Add event listeners for datetime inputs to update summary
            const datetimeInputs = document.querySelectorAll('.datetime-input');
            datetimeInputs.forEach(input => {
                input.addEventListener('change', updateNotificationScheduleSummary);
            });
            
            // Initialize UI state
            updateNotificationGroupStates();
            updateNotificationScheduleSummary();
            
            console.log('Notification scheduling initialization complete');
        }

        /**
         * Handle notification group enable/disable toggle
         */
        function handleNotificationToggle(event) {
            const checkboxId = event.target.id;
            const isEnabled = event.target.checked;
            
            // Find the parent notification group
            const notificationGroup = event.target.closest('.notification-group');
            if (notificationGroup) {
                if (isEnabled) {
                    notificationGroup.classList.remove('disabled');
                } else {
                    notificationGroup.classList.add('disabled');
                }
            }
            
            console.log(`Notification group ${checkboxId} ${isEnabled ? 'enabled' : 'disabled'}`);
            updateNotificationScheduleSummary();
        }

        /**
         * Handle reminder schedule type change (interval vs specific dates)
         */
        function handleReminderScheduleTypeChange(event) {
            const selectedType = event.target.value;
            const intervalInputs = document.getElementById('intervalInputs');
            const specificDatesInputs = document.getElementById('specificDatesInputs');
            
            if (selectedType === 'interval') {
                intervalInputs.style.display = 'block';
                specificDatesInputs.style.display = 'none';
            } else if (selectedType === 'specific') {
                intervalInputs.style.display = 'none';
                specificDatesInputs.style.display = 'block';
            }
            
            console.log(`Reminder schedule type changed to: ${selectedType}`);
            updateNotificationScheduleSummary();
        }

        /**
         * Set notification date and time using quick presets
         */
        function setNotificationDateTime(notificationType, datePreset, timePreset) {
            const dateInput = document.getElementById(`${notificationType}NotificationDate`);
            const timeInput = document.getElementById(`${notificationType}NotificationTime`);
            
            if (!dateInput || !timeInput) {
                console.error(`Date/time inputs not found for notification type: ${notificationType}`);
                return;
            }
            
            let targetDate = new Date();
            
            // Calculate target date based on preset
            switch (datePreset) {
                case 'today':
                    // Use today's date
                    break;
                case 'tomorrow':
                    targetDate.setDate(targetDate.getDate() + 1);
                    break;
                case 'next-week':
                    targetDate.setDate(targetDate.getDate() + 7);
                    break;
                case 'assignment-start':
                    const assignmentStart = document.getElementById('assignmentStartDate');
                    if (assignmentStart && assignmentStart.value) {
                        targetDate = new Date(assignmentStart.value);
                    }
                    break;
                case 'midyear-start':
                    const midYearStart = document.getElementById('midYearStartDate');
                    if (midYearStart && midYearStart.value) {
                        targetDate = new Date(midYearStart.value);
                    }
                    break;
                case 'yearend-start':
                    const yearEndStart = document.getElementById('yearEndStartDate');
                    if (yearEndStart && yearEndStart.value) {
                        targetDate = new Date(yearEndStart.value);
                    }
                    break;
            }
            
            // Set the date input
            dateInput.value = targetDate.toISOString().split('T')[0];
            timeInput.value = timePreset;
            
            // Update summary
            updateNotificationScheduleSummary();
            
            // Visual feedback
            dateInput.style.backgroundColor = '#e8f5e8';
            timeInput.style.backgroundColor = '#e8f5e8';
            
            setTimeout(() => {
                dateInput.style.backgroundColor = '';
                timeInput.style.backgroundColor = '';
            }, 1000);
            
            console.log(`Set ${notificationType} notification to ${dateInput.value} at ${timeInput.value}`);
        }

        /**
         * Set deadline reminder date and time using quick presets
         */
        function setDeadlineReminderDateTime(datePreset, timePreset) {
            const dateInput = document.getElementById('deadlineReminderDate');
            const timeInput = document.getElementById('deadlineReminderTime');
            
            if (!dateInput || !timeInput) {
                console.error('Deadline reminder date/time inputs not found');
                return;
            }
            
            let targetDate = new Date();
            
            // Calculate target date based on preset
            switch (datePreset) {
                case 'today':
                    // Use today's date
                    break;
                case 'tomorrow':
                    targetDate.setDate(targetDate.getDate() + 1);
                    break;
                case 'next-week':
                    targetDate.setDate(targetDate.getDate() + 7);
                    break;
                case 'period-end':
                    // Use the current period end date
                    const schedule = JSON.parse(localStorage.getItem('kpiSchedule') || '{}');
                    const currentDate = new Date();
                    const today = currentDate.toISOString().split('T')[0];
                    
                    if (today >= schedule.assignmentStartDate && today <= schedule.assignmentEndDate) {
                        targetDate = new Date(schedule.assignmentEndDate);
                    } else if (today >= schedule.midYearStartDate && today <= schedule.midYearEndDate) {
                        targetDate = new Date(schedule.midYearEndDate);
                    } else if (today >= schedule.yearEndStartDate && today <= schedule.yearEndEndDate) {
                        targetDate = new Date(schedule.yearEndEndDate);
                    }
                    break;
            }
            
            // Set the date input
            dateInput.value = targetDate.toISOString().split('T')[0];
            timeInput.value = timePreset;
            
            // Update summary
            updateNotificationScheduleSummary();
            
            // Visual feedback
            dateInput.style.backgroundColor = '#e8f5e8';
            timeInput.style.backgroundColor = '#e8f5e8';
            
            setTimeout(() => {
                dateInput.style.backgroundColor = '';
                timeInput.style.backgroundColor = '';
            }, 1000);
            
            console.log(`Set deadline reminder to ${dateInput.value} at ${timeInput.value}`);
        }

        /**
         * Set reminder frequency (for interval-based reminders)
         */
        function setReminderFrequency(days) {
            const input = document.getElementById('reminderFrequencyDays');
            if (input) {
                input.value = days;
                updateNotificationScheduleSummary();
                
                // Visual feedback
                input.style.backgroundColor = '#e8f5e8';
                setTimeout(() => {
                    input.style.backgroundColor = '';
                }, 1000);
                
                console.log(`Set reminder frequency to ${days} days`);
            }
        }

        /**
         * Update notification group visual states
         */
        function updateNotificationGroupStates() {
            const notificationGroups = document.querySelectorAll('.notification-group');
            
            notificationGroups.forEach(group => {
                const checkbox = group.querySelector('input[type="checkbox"]');
                if (checkbox && !checkbox.checked) {
                    group.classList.add('disabled');
                } else {
                    group.classList.remove('disabled');
                }
            });
        }

        /**
         * Update the notification schedule summary
         */
        function updateNotificationScheduleSummary() {
            // This function can be called to update any summary displays
            // For now, we'll just log the current notification schedule
            const notificationSchedule = getNotificationScheduleData();
            console.log('Current notification schedule:', notificationSchedule);
        }

        /**
         * Get current notification schedule data with support for multiple schedules
         */
        function getNotificationScheduleData() {
            const data = {
                assignmentNotifications: {
                    enabled: document.getElementById('enableAssignmentNotifications')?.checked || false,
                    schedules: getNotificationSchedules('assignment') // Get multiple schedules
                },
                midYearNotifications: {
                    enabled: document.getElementById('enableMidYearNotifications')?.checked || false,
                    schedules: getNotificationSchedules('midYear') // Get multiple schedules
                },
                yearEndNotifications: {
                    enabled: document.getElementById('enableYearEndNotifications')?.checked || false,
                    schedules: getNotificationSchedules('yearEnd') // Get multiple schedules
                }
            };
            
            // Add backward compatibility for single notification format
            if (data.assignmentNotifications.schedules.length > 0) {
                data.assignmentNotifications.date = data.assignmentNotifications.schedules[0].date;
                data.assignmentNotifications.time = data.assignmentNotifications.schedules[0].time;
            }
            if (data.midYearNotifications.schedules.length > 0) {
                data.midYearNotifications.date = data.midYearNotifications.schedules[0].date;
                data.midYearNotifications.time = data.midYearNotifications.schedules[0].time;
            }
            if (data.yearEndNotifications.schedules.length > 0) {
                data.yearEndNotifications.date = data.yearEndNotifications.schedules[0].date;
                data.yearEndNotifications.time = data.yearEndNotifications.schedules[0].time;
            }
            
            return data;
        }

        /**
         * Show notification schedule summary modal with multiple schedules support
         */
        function showNotificationScheduleSummary() {
            const notificationData = getNotificationScheduleData();
            let summaryHTML = '<div class="notification-summary">';
            
            summaryHTML += '<h3><i class="fas fa-bell"></i> Notification Schedule Summary</h3>';
            
            // Assignment notifications
            if (notificationData.assignmentNotifications.enabled && notificationData.assignmentNotifications.schedules.length > 0) {
                summaryHTML += `
                    <div class="summary-item active">
                        <h4><i class="fas fa-user-plus"></i> Assignment Period Notifications (${notificationData.assignmentNotifications.schedules.length})</h4>
                `;
                notificationData.assignmentNotifications.schedules.forEach((schedule, index) => {
                    summaryHTML += `<p><strong>Schedule #${index + 1}:</strong> ${formatDate(schedule.date)} at ${schedule.time}</p>`;
                });
                summaryHTML += `</div>`;
            } else {
                summaryHTML += `
                    <div class="summary-item disabled">
                        <h4><i class="fas fa-user-plus"></i> Assignment Period Notifications</h4>
                        <p><em>Disabled or no schedules configured</em></p>
                    </div>
                `;
            }
            
            // Mid-year notifications
            if (notificationData.midYearNotifications.enabled && notificationData.midYearNotifications.schedules.length > 0) {
                summaryHTML += `
                    <div class="summary-item active">
                        <h4><i class="fas fa-chart-bar"></i> Mid-Year Evaluation Notifications (${notificationData.midYearNotifications.schedules.length})</h4>
                `;
                notificationData.midYearNotifications.schedules.forEach((schedule, index) => {
                    summaryHTML += `<p><strong>Schedule #${index + 1}:</strong> ${formatDate(schedule.date)} at ${schedule.time}</p>`;
                });
                summaryHTML += `</div>`;
            } else {
                summaryHTML += `
                    <div class="summary-item disabled">
                        <h4><i class="fas fa-chart-bar"></i> Mid-Year Evaluation Notifications</h4>
                        <p><em>Disabled or no schedules configured</em></p>
                    </div>
                `;
            }
            
            // Year-end notifications
            if (notificationData.yearEndNotifications.enabled && notificationData.yearEndNotifications.schedules.length > 0) {
                summaryHTML += `
                    <div class="summary-item active">
                        <h4><i class="fas fa-trophy"></i> Year-End Evaluation Notifications (${notificationData.yearEndNotifications.schedules.length})</h4>
                `;
                notificationData.yearEndNotifications.schedules.forEach((schedule, index) => {
                    summaryHTML += `<p><strong>Schedule #${index + 1}:</strong> ${formatDate(schedule.date)} at ${schedule.time}</p>`;
                });
                summaryHTML += `</div>`;
            } else {
                summaryHTML += `
                    <div class="summary-item disabled">
                        <h4><i class="fas fa-trophy"></i> Year-End Evaluation Notifications</h4>
                        <p><em>Disabled or no schedules configured</em></p>
                    </div>
                `;
            }
            if (notificationData.yearEndNotifications.enabled) {
                summaryHTML += `
                    <div class="summary-item active">
                        <h4><i class="fas fa-trophy"></i> Year-End Evaluation Notifications</h4>
                        <p><strong>Scheduled:</strong> ${formatDate(notificationData.yearEndNotifications.date)} at ${notificationData.yearEndNotifications.time}</p>
                    </div>
                `;
            } else {
                summaryHTML += `
                    <div class="summary-item disabled">
                        <h4><i class="fas fa-trophy"></i> Year-End Evaluation Notifications</h4>
                        <p><em>Disabled</em></p>
                    </div>
                `;
            }
            
            // Reminder notifications
            if (notificationData.reminderNotifications.enabled) {
                if (notificationData.reminderNotifications.scheduleType === 'interval') {
                    summaryHTML += `
                        <div class="summary-item active">
                            <h4><i class="fas fa-clock"></i> Reminder Notifications</h4>
                            <p><strong>Frequency:</strong> Every ${notificationData.reminderNotifications.frequencyDays} day(s)</p>
                        </div>
                    `;
                } else {
                    const specificDates = notificationData.reminderNotifications.specificDates.filter(d => d.date);
                    summaryHTML += `
                        <div class="summary-item active">
                            <h4><i class="fas fa-clock"></i> Reminder Notifications</h4>
                            <p><strong>Specific Dates:</strong></p>
                            <ul>
                    `;
                    specificDates.forEach(dateTime => {
                        summaryHTML += `<li>${formatDate(dateTime.date)} at ${dateTime.time}</li>`;
                    });
                    summaryHTML += '</ul></div>';
                }
            } else {
                summaryHTML += `
                    <div class="summary-item disabled">
                        <h4><i class="fas fa-clock"></i> Reminder Notifications</h4>
                        <p><em>Disabled</em></p>
                    </div>
                `;
            }
            
            // Deadline reminder
            if (notificationData.deadlineReminder.date) {
                summaryHTML += `
                    <div class="summary-item active">
                        <h4><i class="fas fa-exclamation-triangle"></i> Deadline Reminder</h4>
                        <p><strong>Scheduled:</strong> ${formatDate(notificationData.deadlineReminder.date)} at ${notificationData.deadlineReminder.time}</p>
                    </div>
                `;
            }
            
            summaryHTML += '</div>';
            
            // Show modal with summary
            showModal('Notification Schedule Summary', summaryHTML, [
                {
                    text: 'Close',
                    class: 'btn-secondary',
                    action: () => console.log('Summary closed')
                }
            ]);
        }

        /**
         * Initialize the notification scheduler on page load
         */
        async function initializeNotificationScheduler() {
            try {
                // Try to load schedule from Firebase first, then localStorage
                let schedule = null;
                
                try {
                    const firebaseSchedule = await loadKPIScheduleFromFirebase();
                    if (firebaseSchedule) {
                        schedule = firebaseSchedule;
                        console.log('🔔 Found KPI schedule in Firebase');
                    }
                } catch (error) {
                    console.warn('⚠️ Could not load schedule from Firebase for initialization:', error.message);
                }
                
                // Fallback to localStorage
                if (!schedule) {
                    const savedSchedule = localStorage.getItem('kpiSchedule');
                    if (savedSchedule) {
                        schedule = JSON.parse(savedSchedule);
                        console.log('🔔 Found KPI schedule in localStorage');
                    }
                }
                
                if (!schedule) {
                    console.log('ℹ️ No KPI schedule found - notification scheduler not started');
                    return;
                }
                
                // Check if any notifications are enabled
                const hasEnabledNotifications = schedule.notificationSchedule && (
                    schedule.notificationSchedule.assignmentNotifications?.enabled ||
                    schedule.notificationSchedule.midYearNotifications?.enabled ||
                    schedule.notificationSchedule.yearEndNotifications?.enabled ||
                    schedule.notificationSchedule.reminderNotifications?.enabled
                );

                if (hasEnabledNotifications) {
                    console.log('🔔 Notifications enabled in schedule - starting scheduler automatically');
                    startNotificationScheduler();
                    
                    // Show user that notifications are active
                    setTimeout(() => {
                        const indicator = document.createElement('div');
                        indicator.innerHTML = `
                            <div style="
                                position: fixed;
                                bottom: 20px;
                                left: 20px;
                                background: #d4edda;
                                color: #155724;
                                border: 1px solid #c3e6cb;
                                padding: 10px 15px;
                                border-radius: 6px;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                z-index: 9999;
                                font-size: 13px;
                                max-width: 300px;
                            ">
                                🔔 <strong>Notification Scheduler Active</strong><br>
                                Checking for scheduled notifications every minute
                                <button onclick="this.parentElement.parentElement.remove()" style="
                                    float: right;
                                    background: none;
                                    border: none;
                                    font-size: 14px;
                                    color: #155724;
                                    cursor: pointer;
                                    margin-left: 10px;
                                ">✕</button>
                            </div>
                        `;
                        document.body.appendChild(indicator);
                        
                        // Auto-remove after 10 seconds
                        setTimeout(() => {
                            if (indicator.parentElement) {
                                indicator.remove();
                            }
                        }, 10000);
                    }, 2000);
                } else {
                    console.log('ℹ️ No notifications enabled in schedule - scheduler not started');
                }
            } catch (error) {
                console.error('❌ Error initializing notification scheduler:', error);
            }
        }

        // ...existing code...

        // ===============================================
        // Notification Settings Auto-Save Functions
        // ===============================================

        /**
         * Save current notification settings (used for auto-updates)
         */
        async function saveCurrentNotificationSettings() {
            try {
                // Get the current notification data from the form
                const notificationData = getNotificationScheduleData();
                
                // Get current period dates
                const scheduleData = {
                    assignmentStartDate: document.getElementById('assignmentStartDate')?.value || '',
                    assignmentEndDate: document.getElementById('assignmentEndDate')?.value || '',
                    midYearStartDate: document.getElementById('midYearStartDate')?.value || '',
                    midYearEndDate: document.getElementById('midYearEndDate')?.value || '',
                    yearEndStartDate: document.getElementById('yearEndStartDate')?.value || '',
                    yearEndEndDate: document.getElementById('yearEndEndDate')?.value || '',
                    enableNotifications: document.getElementById('enableNotifications')?.checked || false,
                    autoLockPeriods: document.getElementById('autoLockPeriods')?.checked || false,
                    fiscalYearStart: document.getElementById('fiscalYearStart')?.value || '',
                    notificationSchedule: notificationData
                };
                
                // Save to Firebase
                await saveKPIScheduleToFirebase(scheduleData);
                
                // Also save to localStorage as backup
                localStorage.setItem('kpiScheduleConfig', JSON.stringify(scheduleData));
                
                console.log('Notification settings auto-saved');
            } catch (error) {
                console.error('Error auto-saving notification settings:', error);
            }
        }

        // ===============================================
        // Firebase Integration for Notification Schedules
        // ===============================================

        /**
         * Get the company-scoped Firebase path for KPI schedule
         */
        function getCompanyKPISchedulePath() {
            const currentUser = getCurrentUser();
            if (!currentUser || !currentUser.companyId) {
                console.warn('No valid user or company ID found, using default company');
                return 'companies/default_company/kpiSchedule';
            }
            
            const companyId = currentUser.companyId;
            const schedulePath = `companies/${companyId}/kpiSchedule`;
            
            console.log(`Using company-scoped KPI schedule path: ${schedulePath} for user: ${currentUser.email}`);
            return schedulePath;
        }

        /**
         * Display current company scope information for debugging
         */
        function displayCompanyScope() {
            const currentUser = getCurrentUser();
            const schedulePath = getCompanyKPISchedulePath();
            
            console.group('🏢 Company Scope Information');
            console.log('Current User:', currentUser);
            console.log('Company ID:', currentUser.companyId);
            console.log('Company Name:', currentUser.companyName);
            console.log('Firebase Path:', schedulePath);
            console.groupEnd();
            
            return {
                user: currentUser,
                path: schedulePath
            };
        }

        /**
         * Save KPI schedule and notification data to Firebase
         */
        async function saveKPIScheduleToFirebase(schedule) {
            try {
                if (!window.firebaseDb || !window.firebaseRef || !window.firebaseSet) {
                    console.warn('Firebase not initialized, saving to localStorage only');
                    return;
                }

                const currentUser = getCurrentUser();
                if (!currentUser || !currentUser.email) {
                    console.warn('No current user found, saving to localStorage only');
                    return;
                }

                // Get company-scoped path
                const schedulePath = getCompanyKPISchedulePath();
                if (!schedulePath) {
                    console.warn('Could not determine company path, saving to localStorage only');
                    return;
                }
                
                // Use company-scoped path for organization-wide KPI schedule
                const scheduleRef = window.firebaseRef(window.firebaseDb, schedulePath);
                
                // Prepare data for Firebase with comprehensive company context
                const firebaseData = {
                    ...schedule,
                    companyId: currentUser.companyId || 'default_company',
                    companyName: currentUser.companyName || currentUser.company || 'Default Company',
                    lastUpdatedBy: {
                        email: currentUser.email,
                        name: currentUser.name || currentUser.email,
                        department: currentUser.department || 'General',
                        role: currentUser.role || 'Employee',
                        timestamp: new Date().toISOString()
                    },
                    createdAt: schedule.createdAt || new Date().toISOString(),
                    lastUpdated: new Date().toISOString(),
                    version: '2.0', // Version for tracking notification schedule format
                    isCompanyWide: true // Flag to indicate this is organization-wide schedule
                };

                // Save to company-scoped Firebase path
                await window.firebaseSet(scheduleRef, firebaseData);

                console.log(`✅ KPI schedule saved to company scope (${firebaseData.companyId}) in Firebase successfully`);
                
                // Update local storage with Firebase reference
                const localData = JSON.parse(localStorage.getItem('kpiSchedule') || '{}');
                localData.firebaseKey = schedulePath;
                localData.companyId = firebaseData.companyId;
                localData.lastSyncedToFirebase = new Date().toISOString();
                localStorage.setItem('kpiSchedule', JSON.stringify(localData));

                // Show success message with company context
                showSuccessMessage(`KPI schedule configuration saved successfully for ${currentUser.companyName || 'your organization'}`);

            } catch (error) {
                console.error('❌ Error saving KPI schedule to Firebase:', error);
                // Don't throw error - local storage save should still work
                showErrorMessage('Schedule saved locally but failed to sync to cloud. Changes may not be visible on other devices.');
            }
        }

        /**
         * Load KPI schedule from Firebase
         */
        async function loadKPIScheduleFromFirebase() {
            try {
                if (!window.firebaseDb || !window.firebaseRef || !window.firebaseGet) {
                    console.warn('Firebase not initialized, loading from localStorage only');
                    return null;
                }

                const currentUser = getCurrentUser();
                if (!currentUser || !currentUser.email) {
                    console.warn('No current user found, loading from localStorage only');
                    return null;
                }

                // Get company-scoped path
                const schedulePath = getCompanyKPISchedulePath();
                if (!schedulePath) {
                    console.warn('Could not determine company path, loading from localStorage only');
                    return null;
                }
                
                // Load from company-scoped path
                const scheduleRef = window.firebaseRef(window.firebaseDb, schedulePath);
                const snapshot = await window.firebaseGet(scheduleRef);
                
                if (snapshot.exists()) {
                    const firebaseData = snapshot.val();
                    const companyId = currentUser.companyId || 'default_company';
                    console.log(`✅ KPI schedule loaded from company scope (${companyId}):`, firebaseData);
                    
                    // Validate that this schedule belongs to the current company
                    if (firebaseData.companyId && firebaseData.companyId !== companyId) {
                        console.warn('⚠️ Schedule company ID mismatch, using local data');
                        return null;
                    }
                    
                    return firebaseData;
                } else {
                    const companyId = currentUser.companyId || 'default_company';
                    console.log(`No KPI schedule found in Firebase for company: ${companyId}`);
                    return null;
                }

            } catch (error) {
                console.error('❌ Error loading KPI schedule from Firebase:', error);
                return null;
            }
        }

        /**
         * Set up real-time listener for KPI schedule changes
         */
        function setupKPIScheduleFirebaseListener() {
            try {
                if (!window.firebaseDb || !window.firebaseRef || !window.firebaseOnValue) {
                    console.warn('Firebase not initialized, real-time sync not available');
                    return;
                }

                const currentUser = getCurrentUser();
                if (!currentUser || !currentUser.email) {
                    console.warn('No current user found, real-time sync not available');
                    return;
                }

                // Get company-scoped path
                const schedulePath = getCompanyKPISchedulePath();
                if (!schedulePath) {
                    console.warn('Could not determine company path, real-time sync not available');
                    return;
                }
                
                // Set up listener for company-scoped schedule path
                const scheduleRef = window.firebaseRef(window.firebaseDb, schedulePath);
                
                // Set up real-time listener
                const unsubscribe = window.firebaseOnValue(scheduleRef, (snapshot) => {
                    if (snapshot.exists()) {
                        const firebaseData = snapshot.val();
                        const companyId = currentUser.companyId || 'default_company';
                        console.log(`📡 Real-time KPI schedule update received for company ${companyId}:`, firebaseData);
                        
                        // Validate company ID match
                        if (firebaseData.companyId && firebaseData.companyId !== companyId) {
                            console.warn('⚠️ Received schedule for different company, ignoring');
                            return;
                        }
                        
                        // Update localStorage
                        localStorage.setItem('kpiSchedule', JSON.stringify(firebaseData));
                        
                        // Update UI if schedule modal is open
                        if (document.getElementById('scheduleModal').style.display !== 'none') {
                            populateScheduleModal(firebaseData);
                        }
                        
                        // Immediately apply schedule to entire page
                        const today = new Date().toISOString().split('T')[0];
                        updateKPIFormScheduleInfo(firebaseData);
                        updateScheduleIndicators(firebaseData, today);
                        updateTabScheduleInfo(firebaseData, today);
                        updateAddKPIButtonState(firebaseData, today);
                        enforceWorkflowRestrictions(firebaseData, today);
                        
                        console.log('🔄 Schedule immediately applied to page after real-time update (including team member field freeze check)');
                        
                        // Show notification about schedule update (only if not the same user who made the change)
                        if (firebaseData.lastUpdatedBy && firebaseData.lastUpdatedBy.email !== currentUser.email) {
                            showTemporaryMessage(`📊 Schedule updated by ${firebaseData.lastUpdatedBy.name || firebaseData.lastUpdatedBy.email}`, 'info');
                        }
                    }
                });

                // Store unsubscribe function for cleanup
                window.kpiScheduleFirebaseUnsubscribe = unsubscribe;
                console.log(`📡 Real-time KPI schedule listener set up successfully for company path: ${schedulePath}`);

            } catch (error) {
                console.error('❌ Error setting up Firebase listener:', error);
            }
        }

        /**
         * Populate schedule modal with data (supports both local and Firebase data)
         */
        function populateScheduleModal(scheduleData) {
            try {
                // Display current company scope information
                const currentUser = getCurrentUser();
                const companyNameElement = document.getElementById('scheduleCompanyName');
                if (companyNameElement) {
                    companyNameElement.textContent = `${currentUser.companyName} (ID: ${currentUser.companyId})`;
                }
                
                // Populate basic schedule fields
                if (scheduleData.assignmentStartDate) {
                    document.getElementById('assignmentStartDate').value = scheduleData.assignmentStartDate;
                }
                if (scheduleData.assignmentEndDate) {
                    document.getElementById('assignmentEndDate').value = scheduleData.assignmentEndDate;
                }
                if (scheduleData.midYearStartDate) {
                    document.getElementById('midYearStartDate').value = scheduleData.midYearStartDate;
                }
                if (scheduleData.midYearEndDate) {
                    document.getElementById('midYearEndDate').value = scheduleData.midYearEndDate;
                }
                if (scheduleData.yearEndStartDate) {
                    document.getElementById('yearEndStartDate').value = scheduleData.yearEndStartDate;
                }
                if (scheduleData.yearEndEndDate) {
                    document.getElementById('yearEndEndDate').value = scheduleData.yearEndEndDate;
                }

                // Populate notification settings
                if (scheduleData.notificationSchedule) {
                    const notifications = scheduleData.notificationSchedule;
                    
                    // Assignment notifications
                    if (notifications.assignmentNotifications) {
                        const enableCheckbox = document.getElementById('enableAssignmentNotifications');
                        if (enableCheckbox) {
                            enableCheckbox.checked = notifications.assignmentNotifications.enabled;
                        }
                        
                        // Populate multiple notification schedules
                        if (notifications.assignmentNotifications.schedules && notifications.assignmentNotifications.schedules.length > 0) {
                            populateNotificationSchedules('assignment', notifications.assignmentNotifications.schedules);
                        }
                    }
                    
                    // Mid-year notifications
                    if (notifications.midYearNotifications) {
                        const enableCheckbox = document.getElementById('enableMidYearNotifications');
                        if (enableCheckbox) {
                            enableCheckbox.checked = notifications.midYearNotifications.enabled;
                        }
                        
                        if (notifications.midYearNotifications.schedules && notifications.midYearNotifications.schedules.length > 0) {
                            populateNotificationSchedules('midYear', notifications.midYearNotifications.schedules);
                        }
                    }
                    
                    // Year-end notifications
                    if (notifications.yearEndNotifications) {
                        const enableCheckbox = document.getElementById('enableYearEndNotifications');
                        if (enableCheckbox) {
                            enableCheckbox.checked = notifications.yearEndNotifications.enabled;
                        }
                        
                        if (notifications.yearEndNotifications.schedules && notifications.yearEndNotifications.schedules.length > 0) {
                            populateNotificationSchedules('yearEnd', notifications.yearEndNotifications.schedules);
                        }
                    }
                }

                console.log('✅ Schedule modal populated with data');

            } catch (error) {
                console.error('❌ Error populating schedule modal:', error);
            }
        }

        /**
         * Populate notification schedules for a specific period
         */
        function populateNotificationSchedules(periodType, schedules) {
            const container = document.getElementById(`${periodType}NotificationSchedules`);
            const countBadge = document.getElementById(`${periodType}NotificationCount`);
            
            if (!container || !countBadge) {
                console.warn(`Cannot find notification container for period: ${periodType}`);
                return;
            }

            // Clear existing schedules
            container.innerHTML = '';

            // Add each schedule
            schedules.forEach((schedule, index) => {
                addNotificationScheduleWithData(periodType, index, schedule.date, schedule.time);
            });

            // Update count badge
            countBadge.textContent = schedules.length;

            // Update remove button visibility
            updateRemoveButtonVisibility(periodType);

            console.log(`✅ Populated ${schedules.length} notification schedules for ${periodType}`);
        }

        /**
         * Add notification schedule with predefined data
         */
        function addNotificationScheduleWithData(periodType, index, date, time) {
            const container = document.getElementById(`${periodType}NotificationSchedules`);
            
            if (!container) {
                console.error(`Cannot find notification container for period: ${periodType}`);
                return;
            }
            
            const notificationNumber = index + 1;
            
            // Create new notification schedule item
            const newItem = document.createElement('div');
            newItem.className = 'notification-schedule-item';
            newItem.setAttribute('data-index', index);
            
            newItem.innerHTML = `
                <div class="notification-item-header">
                    <span class="notification-item-title">Notification #${notificationNumber}</span>
                    <button type="button" class="notification-item-remove" onclick="removeNotificationSchedule('${periodType}', ${index})" style="${index === 0 ? 'display: none;' : ''}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="datetime-input-group">
                    <div class="datetime-input-container">
                        <label for="${periodType}NotificationDate_${index}" class="datetime-label">Date</label>
                        <input type="date" id="${periodType}NotificationDate_${index}" name="${periodType}NotificationDate_${index}" 
                               class="form-control datetime-input" value="${date || ''}" required>
                    </div>
                    <div class="datetime-input-container">
                        <label for="${periodType}NotificationTime_${index}" class="datetime-label">Time</label>
                        <input type="time" id="${periodType}NotificationTime_${index}" name="${periodType}NotificationTime_${index}" 
                               class="form-control datetime-input" value="${time || '09:00'}" required>
                    </div>
                </div>
            `;
            
            // Add the new item to the container
            container.appendChild(newItem);
            
            // Add event listeners to datetime inputs for summary updates
            const newDatetimeInputs = newItem.querySelectorAll('.datetime-input');
            newDatetimeInputs.forEach(input => {
                input.addEventListener('change', updateNotificationScheduleSummary);
            });
        }

        // ...existing code...

        /**
         * Notification Scheduler - Automatically sends notifications at scheduled times
         */
        class KPINotificationScheduler {
            constructor() {
                this.checkInterval = 60000; // Check every minute
                this.schedulerTimer = null;
                this.isRunning = false;
                this.lastCheck = null;
                this.sentNotifications = JSON.parse(localStorage.getItem('sentNotifications') || '[]');
                console.log('📅 KPI Notification Scheduler initialized');
            }

            start() {
                if (this.isRunning) {
                    console.log('⚠️ Scheduler already running');
                    return;
                }

                this.isRunning = true;
                this.schedulerTimer = setInterval(() => {
                    this.checkAndSendDueNotifications();
                }, this.checkInterval);

                console.log('🚀 KPI Notification Scheduler started (checking every minute)');
                
                // Run initial check
                this.checkAndSendDueNotifications();
            }

            stop() {
                if (this.schedulerTimer) {
                    clearInterval(this.schedulerTimer);
                    this.schedulerTimer = null;
                }
                this.isRunning = false;
                console.log('⏹️ KPI Notification Scheduler stopped');
            }

            async checkAndSendDueNotifications() {
                try {
                    const now = new Date();
                    this.lastCheck = now;
                    
                    // Try to get schedule from Firebase first, then localStorage
                    let schedule = null;
                    
                    try {
                        const firebaseSchedule = await loadKPIScheduleFromFirebase();
                        if (firebaseSchedule) {
                            schedule = firebaseSchedule;
                            console.log('📅 Using Firebase schedule for notifications');
                        }
                    } catch (error) {
                        console.warn('⚠️ Could not load schedule from Firebase, using localStorage:', error.message);
                    }
                    
                    // Fallback to localStorage
                    if (!schedule) {
                        const savedSchedule = localStorage.getItem('kpiSchedule');
                        if (savedSchedule) {
                            schedule = JSON.parse(savedSchedule);
                            console.log('📅 Using localStorage schedule for notifications');
                        }
                    }
                    
                    if (!schedule || !schedule.notificationSchedule) {
                        console.log('ℹ️ No notification schedule configured');
                        return; // No notification schedule configured
                    }

                    const notifications = schedule.notificationSchedule;
                    console.log('🔍 Checking for due notifications at', now.toISOString());

                    // Check assignment notifications
                    if (notifications.assignmentNotifications?.enabled) {
                        await this.checkNotificationType('assignment', notifications.assignmentNotifications, schedule, now);
                    }

                    // Check mid-year notifications
                    if (notifications.midYearNotifications?.enabled) {
                        await this.checkNotificationType('midYear', notifications.midYearNotifications, schedule, now);
                    }

                    // Check year-end notifications
                    if (notifications.yearEndNotifications?.enabled) {
                        await this.checkNotificationType('yearEnd', notifications.yearEndNotifications, schedule, now);
                    }

                    // Check reminder notifications
                    if (notifications.reminderNotifications?.enabled) {
                        await this.checkReminderNotifications(notifications.reminderNotifications, schedule, now);
                    }

                } catch (error) {
                    console.error('❌ Error in notification scheduler:', error);
                }
            }

            async checkNotificationType(type, notificationConfig, schedule, now) {
                // Handle multiple notification schedules
                const schedules = this.getMultipleNotificationSchedules(type, schedule);
                
                if (schedules.length === 0) {
                    // Fallback to single notification format for backward compatibility
                    if (notificationConfig.date && notificationConfig.time) {
                        schedules.push({
                            date: notificationConfig.date,
                            time: notificationConfig.time,
                            index: 0
                        });
                    }
                }

                for (const scheduleItem of schedules) {
                    const notificationDateTime = new Date(`${scheduleItem.date}T${scheduleItem.time}`);
                    const notificationId = `${type}_${scheduleItem.index}_${scheduleItem.date}_${scheduleItem.time}`;

                    // Check if this notification has already been sent
                    if (this.sentNotifications.includes(notificationId)) {
                        continue;
                    }

                    // Check if notification time has passed (within 2 minutes window)
                    const timeDiff = now.getTime() - notificationDateTime.getTime();
                    const isOverdue = timeDiff >= 0 && timeDiff <= 120000; // 2 minutes window

                    if (isOverdue) {
                        console.log(`📧 Sending ${type} notification #${scheduleItem.index + 1} - scheduled for ${notificationDateTime.toISOString()}`);
                        
                        try {
                            await this.sendScheduledNotification(type, schedule, scheduleItem.index + 1);
                            
                            // Mark as sent
                            this.sentNotifications.push(notificationId);
                            localStorage.setItem('sentNotifications', JSON.stringify(this.sentNotifications));
                            
                            console.log(`✅ ${type} notification #${scheduleItem.index + 1} sent successfully`);
                            
                            // Show user notification
                            this.showUserNotification(type, `#${scheduleItem.index + 1} sent successfully`);
                            
                        } catch (error) {
                            console.error(`❌ Failed to send ${type} notification #${scheduleItem.index + 1}:`, error);
                            this.showUserNotification(type, `#${scheduleItem.index + 1} failed: ${error.message}`);
                        }
                    }
                }
            }

            /**
             * Get multiple notification schedules for a specific type from saved data
             */
            getMultipleNotificationSchedules(type, schedule) {
                const schedules = [];
                
                // Get schedules from saved notification data (more reliable than DOM)
                if (schedule.notificationSchedule) {
                    const notifications = schedule.notificationSchedule;
                    let notificationConfig = null;
                    
                    switch (type) {
                        case 'assignment':
                            notificationConfig = notifications.assignmentNotifications;
                            break;
                        case 'midYear':
                            notificationConfig = notifications.midYearNotifications;
                            break;
                        case 'yearEnd':
                            notificationConfig = notifications.yearEndNotifications;
                            break;
                    }
                    
                    if (notificationConfig && notificationConfig.schedules) {
                        // Use the new multiple schedules format
                        notificationConfig.schedules.forEach((schedule, index) => {
                            if (schedule.date && schedule.time) {
                                schedules.push({
                                    index: index,
                                    date: schedule.date,
                                    time: schedule.time
                                });
                            }
                        });
                    }
                }
                
                // Fallback: Try to get schedules from DOM if modal is open and no saved data
                if (schedules.length === 0) {
                    const container = document.getElementById(`${type}NotificationSchedules`);
                    if (container) {
                        const items = container.querySelectorAll('.notification-schedule-item');
                        items.forEach((item, index) => {
                            const dateInput = item.querySelector('input[type="date"]');
                            const timeInput = item.querySelector('input[type="time"]');
                            
                            if (dateInput && timeInput && dateInput.value && timeInput.value) {
                                schedules.push({
                                    index: index,
                                    date: dateInput.value,
                                    time: timeInput.value
                                });
                            }
                        });
                    }
                }
                
                console.log(`📅 Found ${schedules.length} notification schedules for ${type}:`, schedules);
                return schedules;
            }

            async checkReminderNotifications(reminderConfig, schedule, now) {
                if (reminderConfig.scheduleType === 'interval') {
                    // Handle interval-based reminders
                    const lastReminderKey = 'lastIntervalReminder';
                    const lastReminder = localStorage.getItem(lastReminderKey);
                    const daysSinceLastReminder = lastReminder ? 
                        Math.floor((now.getTime() - new Date(lastReminder).getTime()) / (24 * 60 * 60 * 1000)) : 999;

                    if (daysSinceLastReminder >= reminderConfig.frequencyDays) {
                        console.log(`📧 Sending interval reminder (every ${reminderConfig.frequencyDays} days)`);
                        
                        try {
                            await this.sendScheduledNotification('reminder', schedule);
                            localStorage.setItem(lastReminderKey, now.toISOString());
                            console.log('✅ Interval reminder sent successfully');
                            this.showUserNotification('reminder', 'sent successfully');
                            
                        } catch (error) {
                            console.error('❌ Failed to send interval reminder:', error);
                            this.showUserNotification('reminder', `failed: ${error.message}`);
                        }
                    }
                } else if (reminderConfig.scheduleType === 'specific') {
                    // Handle specific date reminders
                    for (const dateTime of reminderConfig.specificDates) {
                        if (dateTime.date && dateTime.time) {
                            const reminderDateTime = new Date(`${dateTime.date}T${dateTime.time}`);
                            const reminderId = `reminder_${dateTime.date}_${dateTime.time}`;

                            if (this.sentNotifications.includes(reminderId)) {
                                continue;
                            }

                            const timeDiff = now.getTime() - reminderDateTime.getTime();
                            const isOverdue = timeDiff >= 0 && timeDiff <= 120000; // 2 minutes window

                            if (isOverdue) {
                                console.log(`📧 Sending specific reminder - scheduled for ${reminderDateTime.toISOString()}`);
                                
                                try {
                                    await this.sendScheduledNotification('reminder', schedule);
                                    this.sentNotifications.push(reminderId);
                                    localStorage.setItem('sentNotifications', JSON.stringify(this.sentNotifications));
                                    console.log('✅ Specific reminder sent successfully');
                                    this.showUserNotification('reminder', 'sent successfully');
                                    
                                } catch (error) {
                                    console.error('❌ Failed to send specific reminder:', error);
                                    this.showUserNotification('reminder', `failed: ${error.message}`);
                                }
                            }
                        }
                    }
                }
            }

            async sendScheduledNotification(type, schedule, notificationNumber = null) {
                const notificationNumberText = notificationNumber ? ` #${notificationNumber}` : '';
                console.log(`📧 Sending ${type} notification${notificationNumberText}...`);
                
                // Use the appropriate notification function based on type
                switch (type) {
                    case 'assignment':
                    case 'reminder':
                        await sendKPIAssignmentNotifications(schedule, notificationNumber);
                        break;
                    case 'midYear':
                        await sendKPIMidYearEvaluationNotifications(schedule, notificationNumber);
                        break;
                    case 'yearEnd':
                        await sendKPIYearEndEvaluationNotifications(schedule, notificationNumber);
                        break;
                    default:
                        throw new Error(`Unknown notification type: ${type}`);
                }
            }

            showUserNotification(type, status) {
                // Create a visual notification for the user
                const notificationHtml = `
                    <div class="auto-notification-alert" style="
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: ${status.includes('failed') ? '#f8d7da' : '#d4edda'};
                        color: ${status.includes('failed') ? '#721c24' : '#155724'};
                        border: 1px solid ${status.includes('failed') ? '#f5c6cb' : '#c3e6cb'};
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        max-width: 350px;
                        font-size: 14px;
                        font-family: Arial, sans-serif;
                    ">
                        <strong>${status.includes('failed') ? '❌' : '✅'} Scheduled Notification</strong><br>
                        ${type.charAt(0).toUpperCase() + type.slice(1)} notification ${status}
                        <button onclick="this.parentElement.remove()" style="
                            float: right;
                            background: none;
                            border: none;
                            font-size: 16px;
                            cursor: pointer;
                            margin-left: 10px;
                        ">×</button>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', notificationHtml);

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    const alert = document.querySelector('.auto-notification-alert');
                    if (alert) alert.remove();
                }, 10000);
            }

            getStatus() {
                return {
                    isRunning: this.isRunning,
                    lastCheck: this.lastCheck,
                    sentNotifications: this.sentNotifications.length,
                    checkInterval: this.checkInterval
                };
            }

            // Method to reset sent notifications (useful for testing)
            resetSentNotifications() {
                this.sentNotifications = [];
                localStorage.removeItem('sentNotifications');
                localStorage.removeItem('lastIntervalReminder');
                console.log('🔄 Reset sent notifications list');
            }
        }

        // Initialize global scheduler instance
        let kpiNotificationScheduler = null;

        /**
         * Start the notification scheduler
         */
        function startNotificationScheduler() {
            if (!kpiNotificationScheduler) {
                kpiNotificationScheduler = new KPINotificationScheduler();
            }
            kpiNotificationScheduler.start();
            
            // Update UI to show scheduler status
            updateSchedulerStatusIndicator(true);
        }

        /**
         * Stop the notification scheduler
         */
        function stopNotificationScheduler() {
            if (kpiNotificationScheduler) {
                kpiNotificationScheduler.stop();
            }
            updateSchedulerStatusIndicator(false);
        }

        /**
         * Update scheduler status indicator in UI
         */
        function updateSchedulerStatusIndicator(isRunning) {
            // Add status indicator to the schedule modal if it doesn't exist
            let statusIndicator = document.getElementById('schedulerStatus');
            if (!statusIndicator) {
                statusIndicator = document.createElement('div');
                statusIndicator.id = 'schedulerStatus';
                statusIndicator.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 8px 12px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-weight: 600;
                    z-index: 9999;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                `;
                document.body.appendChild(statusIndicator);
            }

            if (isRunning) {
                statusIndicator.innerHTML = '🟢 Auto-Scheduler ON';
                statusIndicator.style.background = '#d4edda';
                statusIndicator.style.color = '#155724';
                statusIndicator.style.border = '1px solid #c3e6cb';
            } else {
                statusIndicator.innerHTML = '🔴 Auto-Scheduler OFF';
                statusIndicator.style.background = '#f8d7da';
                statusIndicator.style.color = '#721c24';
                statusIndicator.style.border = '1px solid #f5c6cb';
            }
        }

        // ...existing code...

        /**
         * Save KPI schedule with notification datetime settings
         */
        async function saveKPISchedule(event) {
            event.preventDefault();
            
            try {
                // Get basic schedule data
                const formData = new FormData(event.target);
                const schedule = {
                    assignmentStartDate: formData.get('assignmentStartDate'),
                    assignmentEndDate: formData.get('assignmentEndDate'),
                    midYearStartDate: formData.get('midYearStartDate'),
                    midYearEndDate: formData.get('midYearEndDate'),
                    yearEndStartDate: formData.get('yearEndStartDate'),
                    yearEndEndDate: formData.get('yearEndEndDate'),
                    autoLockPeriods: formData.get('autoLockPeriods') === 'on',
                    createdDate: new Date().toISOString(),
                    // Add notification schedule data
                    notificationSchedule: getNotificationScheduleData()
                };
                
                // Validate required fields
                const requiredFields = [
                    'assignmentStartDate', 'assignmentEndDate',
                    'midYearStartDate', 'midYearEndDate', 
                    'yearEndStartDate', 'yearEndEndDate'
                ];
                
                const missingFields = requiredFields.filter(field => !schedule[field]);
                if (missingFields.length > 0) {
                    throw new Error(`Please fill in all required fields: ${missingFields.join(', ')}`);
                }
                
                // Validate date logic
                validateScheduleDates(schedule);
                
                // Validate notification dates
                validateNotificationDates(schedule);
                
                // Save to localStorage
                localStorage.setItem('kpiSchedule', JSON.stringify(schedule));
                
                // Save to Firebase for real-time sync
                await saveKPIScheduleToFirebase(schedule);
                
                // Update form schedule info
                updateKPIFormScheduleInfo(schedule);
                
                // Close modal
                closeModal('scheduleModal');
                
                // Show success message
                showSuccessMessage('✅ KPI schedule and notification settings saved successfully!');
                
                // Auto-start the notification scheduler if notifications are enabled
                const hasEnabledNotifications = schedule.notificationSchedule && (
                    schedule.notificationSchedule.assignmentNotifications?.enabled ||
                    schedule.notificationSchedule.midYearNotifications?.enabled ||
                    schedule.notificationSchedule.yearEndNotifications?.enabled ||
                    schedule.notificationSchedule.reminderNotifications?.enabled
                );
                
                if (hasEnabledNotifications) {
                    setTimeout(() => {
                        startNotificationScheduler();
                        console.log('🚀 Auto-started notification scheduler due to enabled notifications');
                    }, 1000); // Small delay to ensure modal closes first
                }
                
                console.log('Schedule saved with notification settings:', schedule);
                
            } catch (error) {
                console.error('Error saving schedule:', error);
                showErrorMessage(`Failed to save schedule: ${error.message}`);
            }
        }

        /**
         * Validate notification dates against schedule periods
         */
        function validateNotificationDates(schedule) {
            const notifications = schedule.notificationSchedule;
            
            // Validate assignment notification
            if (notifications.assignmentNotifications.enabled) {
                if (!notifications.assignmentNotifications.date || !notifications.assignmentNotifications.time) {
                    throw new Error('Assignment notification date and time are required when enabled');
                }
                
                const notificationDateTime = new Date(`${notifications.assignmentNotifications.date}T${notifications.assignmentNotifications.time}`);
                const assignmentStart = new Date(schedule.assignmentStartDate);
                
                if (notificationDateTime >= assignmentStart) {
                    throw new Error('Assignment notification must be scheduled before the assignment period starts');
                }
            }
            
            // Validate mid-year notification
            if (notifications.midYearNotifications.enabled) {
                if (!notifications.midYearNotifications.date || !notifications.midYearNotifications.time) {
                    throw new Error('Mid-year notification date and time are required when enabled');
                }
                
                const notificationDateTime = new Date(`${notifications.midYearNotifications.date}T${notifications.midYearNotifications.time}`);
                const midYearStart = new Date(schedule.midYearStartDate);
                
                if (notificationDateTime >= midYearStart) {
                    throw new Error('Mid-year notification must be scheduled before the mid-year period starts');
                }
            }
            
            // Validate year-end notification  
            if (notifications.yearEndNotifications.enabled) {
                if (!notifications.yearEndNotifications.date || !notifications.yearEndNotifications.time) {
                    throw new Error('Year-end notification date and time are required when enabled');
                }
                
                const notificationDateTime = new Date(`${notifications.yearEndNotifications.date}T${notifications.yearEndNotifications.time}`);
                const yearEndStart = new Date(schedule.yearEndStartDate);
                
                if (notificationDateTime >= yearEndStart) {
                    throw new Error('Year-end notification must be scheduled before the year-end period starts');
                }
            }
            
            console.log('Notification dates validated successfully');
        }

        /**
         * Simple modal helper function
         */
        function showModal(title, content, buttons = []) {
            // Create modal elements
            let modal = document.getElementById('dynamicModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'dynamicModal';
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="dynamicModalTitle"></h3>
                            <button type="button" class="modal-close" onclick="document.getElementById('dynamicModal').style.display='none'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="dynamicModalContent">
                        </div>
                        <div class="modal-actions" id="dynamicModalActions">
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Set content
            document.getElementById('dynamicModalTitle').innerHTML = title;
            document.getElementById('dynamicModalContent').innerHTML = content;
            
            // Set buttons
            const actionsDiv = document.getElementById('dynamicModalActions');
            actionsDiv.innerHTML = '';
            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = `btn ${button.class || 'btn-primary'}`;
                btn.textContent = button.text;
                btn.onclick = () => {
                    if (button.action) button.action();
                    modal.style.display = 'none';
                };
                actionsDiv.appendChild(btn);
            });
            
            // Show modal
            modal.style.display = 'block';
        }

        function updateKPIFormScheduleInfo(schedule) {
            // This function will be called to apply the schedule settings to the KPI system
            // It can be used to update the KPI creation form and evaluation tabs
            
            // Store schedule with company information for use across the application
            const currentUser = getCurrentUser();
            const scheduleWithCompanyInfo = {
                ...schedule,
                companyId: currentUser.companyId,
                companyName: currentUser.companyName,
                lastLoadedBy: currentUser.email,
                lastLoadedAt: new Date().toISOString()
            };
            sessionStorage.setItem('currentKPISchedule', JSON.stringify(scheduleWithCompanyInfo));
            
            // Log company scope information
            console.log(`📋 KPI schedule loaded for company: ${currentUser.companyName} (${currentUser.companyId})`);
            
            // Update any existing UI elements that might show schedule information
            updateKPIFormScheduleInfo(schedule);
        }

        function updateKPIFormScheduleInfo(schedule) {
            // Check current date against schedule periods and update UI accordingly
            const currentDate = new Date();
            const today = currentDate.toISOString().split('T')[0];
            
            let currentPeriod = 'Outside Schedule';
            let nextPeriod = null;
            
            if (today >= schedule.assignmentStartDate && today <= schedule.assignmentEndDate) {
                currentPeriod = 'KPI Assignment Period';
                nextPeriod = `Mid Year Evaluation starts ${formatDate(schedule.midYearStartDate)}`;
            } else if (today >= schedule.midYearStartDate && today <= schedule.midYearEndDate) {
                currentPeriod = 'Mid Year Evaluation Period';
                nextPeriod = `Year End Evaluation starts ${formatDate(schedule.yearEndStartDate)}`;
            } else if (today >= schedule.yearEndStartDate && today <= schedule.yearEndEndDate) {
                currentPeriod = 'Year End Evaluation Period';
                nextPeriod = 'Evaluation cycle complete';
            }
            
            // Store current period info for use by other functions
            window.kpiScheduleInfo = {
                currentPeriod,
                nextPeriod,
                schedule,
                today
            };
            
            // Update all tab schedule indicators
            updateScheduleIndicators(schedule, today);
            
            console.log('Current Period:', currentPeriod);
            console.log('Next Period:', nextPeriod);
        }

        function updateScheduleIndicators(schedule, today) {
            // Update Assignment tab indicator
            updateAssignmentScheduleIndicator(schedule, today);
            
            // Update Mid Year Evaluation tab indicator
            updateEvaluationScheduleIndicator(schedule, today);
            
            // Update Year End Evaluation tab indicator
            updateYearEndScheduleIndicator(schedule, today);
            
            // Update Add KPI button state based on period expiry
            updateAddKPIButtonState(schedule, today);
            
            // Update tab schedule information
            updateTabScheduleInfo(schedule, today);
            
            // Enforce workflow restrictions based on schedule
            enforceWorkflowRestrictions(schedule, today);
        }

        function updateAssignmentScheduleIndicator(schedule, today) {
            const indicator = document.getElementById('assignmentScheduleIndicator');
            const noScheduleIndicator = document.getElementById('noScheduleIndicatorAssignment');
            const datesElement = document.getElementById('assignmentPeriodDates');
            const statusElement = document.getElementById('assignmentPeriodStatus');

            if (!schedule) {
                indicator.style.display = 'none';
                noScheduleIndicator.style.display = 'block';
                return;
            }

            noScheduleIndicator.style.display = 'none';
            indicator.style.display = 'flex';

            // Set dates with more detailed format
            const startDate = new Date(schedule.assignmentStartDate);
            const endDate = new Date(schedule.assignmentEndDate);
            datesElement.textContent = `${formatDateWithDay(schedule.assignmentStartDate)} - ${formatDateWithDay(schedule.assignmentEndDate)}`;

            // Determine status and styling
            const currentDate = new Date(today);

            indicator.className = 'schedule-indicator';

            if (currentDate >= startDate && currentDate <= endDate) {
                indicator.classList.add('current-period');
                const daysLeft = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Active - ${daysLeft} day${daysLeft !== 1 ? 's' : ''} remaining`;
            } else if (currentDate < startDate) {
                indicator.classList.add('upcoming-period');
                const daysUntil = Math.ceil((startDate - currentDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Starts in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`;
            } else {
                indicator.classList.add('past-period');
                const daysAgo = Math.ceil((currentDate - endDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Ended ${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago`;
            }
        }

        function updateEvaluationScheduleIndicator(schedule, today) {
            const indicator = document.getElementById('evaluationScheduleIndicator');
            const noScheduleIndicator = document.getElementById('noScheduleIndicatorEvaluation');
            const datesElement = document.getElementById('evaluationPeriodDates');
            const statusElement = document.getElementById('evaluationPeriodStatus');

            if (!schedule) {
                indicator.style.display = 'none';
                noScheduleIndicator.style.display = 'block';
                return;
            }

            noScheduleIndicator.style.display = 'none';
            indicator.style.display = 'flex';

            // Set dates with more detailed format
            const startDate = new Date(schedule.midYearStartDate);
            const endDate = new Date(schedule.midYearEndDate);
            datesElement.textContent = `${formatDateWithDay(schedule.midYearStartDate)} - ${formatDateWithDay(schedule.midYearEndDate)}`;

            // Determine status and styling
            const currentDate = new Date(today);

            indicator.className = 'schedule-indicator';

            if (currentDate >= startDate && currentDate <= endDate) {
                indicator.classList.add('current-period');
                const daysLeft = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Active - ${daysLeft} day${daysLeft !== 1 ? 's' : ''} remaining`;
            } else if (currentDate < startDate) {
                indicator.classList.add('upcoming-period');
                const daysUntil = Math.ceil((startDate - currentDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Starts in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`;
            } else {
                indicator.classList.add('past-period');
                const daysAgo = Math.ceil((currentDate - endDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Ended ${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago`;
            }
        }

        function updateYearEndScheduleIndicator(schedule, today) {
            const indicator = document.getElementById('yearEndScheduleIndicator');
            const noScheduleIndicator = document.getElementById('noScheduleIndicatorYearEnd');
            const datesElement = document.getElementById('yearEndPeriodDates');
            const statusElement = document.getElementById('yearEndPeriodStatus');

            if (!schedule) {
                indicator.style.display = 'none';
                noScheduleIndicator.style.display = 'block';
                return;
            }

            noScheduleIndicator.style.display = 'none';
            indicator.style.display = 'flex';

            // Set dates with more detailed format
            const startDate = new Date(schedule.yearEndStartDate);
            const endDate = new Date(schedule.yearEndEndDate);
            datesElement.textContent = `${formatDateWithDay(schedule.yearEndStartDate)} - ${formatDateWithDay(schedule.yearEndEndDate)}`;

            // Determine status and styling
            const currentDate = new Date(today);

            indicator.className = 'schedule-indicator';

            if (currentDate >= startDate && currentDate <= endDate) {
                indicator.classList.add('current-period');
                const daysLeft = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Active - ${daysLeft} day${daysLeft !== 1 ? 's' : ''} remaining`;
            } else if (currentDate < startDate) {
                indicator.classList.add('upcoming-period');
                const daysUntil = Math.ceil((startDate - currentDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Starts in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`;
            } else {
                indicator.classList.add('past-period');
                const daysAgo = Math.ceil((currentDate - endDate) / (1000 * 60 * 60 * 24));
                statusElement.textContent = `Ended ${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago`;
            }
        }

        // Function to check if any KPI periods have ended and lock Add KPI button accordingly
        function updateAddKPIButtonState(schedule, today) {
            const addKPIBtn = document.getElementById('addKPIBtn');
            const banner = document.getElementById('periodExpiryBanner');
            const bannerMessage = document.getElementById('periodExpiryMessage');
            
            if (!addKPIBtn) {
                console.log('Add KPI button not found');
                return;
            }

            if (!schedule || !today) {
                // No schedule configured or no date provided - allow adding KPIs
                unlockAddKPIButton(addKPIBtn);
                unfreezeAssignmentTabFields();
                if (banner) banner.style.display = 'none';
                return;
            }

            const currentDate = new Date(today);
            let isPeriodExpired = false;
            let expiredPeriodName = '';
            const expiredPeriods = [];

            // Check Assignment Period - This will freeze team member selection
            let isAssignmentPeriodEnded = false;
            if (schedule.assignmentStartDate && schedule.assignmentEndDate) {
                const assignmentEndDate = new Date(schedule.assignmentEndDate);
                if (currentDate > assignmentEndDate) {
                    isPeriodExpired = true;
                    isAssignmentPeriodEnded = true;
                    expiredPeriods.push('Assignment Period');
                }
            }

            // Check Mid-Year Period
            if (schedule.midYearStartDate && schedule.midYearEndDate) {
                const midYearEndDate = new Date(schedule.midYearEndDate);
                if (currentDate > midYearEndDate) {
                    isPeriodExpired = true;
                    expiredPeriods.push('Mid-Year Period');
                }
            }

            // Check Year-End Period
            if (schedule.yearEndStartDate && schedule.yearEndEndDate) {
                const yearEndEndDate = new Date(schedule.yearEndEndDate);
                if (currentDate > yearEndEndDate) {
                    isPeriodExpired = true;
                    expiredPeriods.push('Year-End Period');
                }
            }

            // Freeze/unfreeze assignment tab fields based on assignment period
            if (isAssignmentPeriodEnded) {
                freezeAssignmentTabFields(schedule.assignmentEndDate);
            } else {
                unfreezeAssignmentTabFields();
            }

            if (isPeriodExpired) {
                // Determine message based on number of expired periods
                if (expiredPeriods.length === 1) {
                    expiredPeriodName = expiredPeriods[0];
                } else {
                    expiredPeriodName = 'Multiple Periods';
                }

                lockAddKPIButton(addKPIBtn, expiredPeriodName);
                
                // Show banner with appropriate message
                if (banner && bannerMessage) {
                    let bannerText = '';
                    if (expiredPeriods.length === 1) {
                        bannerText = `The ${expiredPeriods[0]} has ended. Contact your administrator to extend the period if needed.`;
                    } else {
                        bannerText = `Multiple evaluation periods (${expiredPeriods.join(', ')}) have ended. Contact your administrator to extend the periods if needed.`;
                    }
                    bannerMessage.textContent = bannerText;
                    banner.style.display = 'flex';
                }
            } else {
                unlockAddKPIButton(addKPIBtn);
                if (banner) banner.style.display = 'none';
            }
        }

        // Function to lock the Add KPI button
        function lockAddKPIButton(button, expiredPeriodName) {
            button.classList.add('btn-locked');
            button.disabled = true;
            button.style.pointerEvents = 'none';
            
            // Update button text to show lock status
            const originalText = button.getAttribute('data-original-text') || button.textContent.trim();
            if (!button.getAttribute('data-original-text')) {
                button.setAttribute('data-original-text', originalText);
            }
            
            button.innerHTML = `<i class="fas fa-lock"></i> KPI Creation Locked`;
            button.title = `KPI creation is locked because the ${expiredPeriodName} has ended. Contact your administrator to extend the period if needed.`;
            
            console.log(`🔒 Add KPI button locked due to expired ${expiredPeriodName}`);
        }

        // Function to unlock the Add KPI button
        function unlockAddKPIButton(button) {
            button.classList.remove('btn-locked');
            button.disabled = false;
            button.style.pointerEvents = '';
            
            // Restore original button text
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                button.innerHTML = originalText;
            } else {
                // Fallback to default text
                const hasKPIs = document.querySelectorAll('#kpiSectionsContainer .kpi-section:not([style*="display: none"])').length > 0;
                button.innerHTML = hasKPIs ? '<i class="fas fa-plus"></i> Add Another KPI' : '<i class="fas fa-plus"></i> Add KPI';
            }
            
            button.title = 'Add a new KPI to your evaluation';
            
            console.log('🔓 Add KPI button unlocked - periods are active or not yet started');
        }

        // Function to reapply assignment field restrictions to newly created KPI sections
        function reapplyAssignmentFieldRestrictions() {
            try {
                // Get current schedule from localStorage
                const scheduleData = localStorage.getItem('kpiSchedule');
                if (!scheduleData) {
                    console.log('📋 No schedule found, no field restrictions to reapply');
                    return;
                }
                
                const schedule = JSON.parse(scheduleData);
                const today = new Date().toISOString().split('T')[0];
                
                // Check if assignment period has ended
                let isAssignmentPeriodEnded = false;
                if (schedule.assignmentStartDate && schedule.assignmentEndDate) {
                    const assignmentEndDate = new Date(schedule.assignmentEndDate);
                    const currentDate = new Date(today);
                    if (currentDate > assignmentEndDate) {
                        isAssignmentPeriodEnded = true;
                    }
                }
                
                if (isAssignmentPeriodEnded) {
                    console.log('❄️ Reapplying assignment field restrictions to newly created KPI sections');
                    // Use the existing comprehensive freezing function
                    freezeAllKPIFields(schedule.assignmentEndDate);
                } else {
                    console.log('🔓 Assignment period active, no restrictions to apply to new KPI sections');
                }
                
            } catch (error) {
                console.error('❌ Error reapplying assignment field restrictions:', error);
            }
        }

        // Function to freeze all assignment tab fields when assignment period ends
        function freezeAssignmentTabFields(assignmentEndDate) {
            const endDate = formatDate(assignmentEndDate);
            
            // Freeze team member selection
            freezeTeamMemberField(assignmentEndDate);
            
            // Freeze all KPI form fields in assignment tab
            freezeAllKPIFields(assignmentEndDate);
            
            // Freeze Add KPI button
            const addKPIBtn = document.getElementById('addKPIBtn');
            if (addKPIBtn) {
                lockAddKPIButton(addKPIBtn, 'Assignment Period');
            }
            
            // Show comprehensive frozen message for assignment tab
            showAssignmentTabFrozenMessage(endDate);
            
            console.log(`❄️ All assignment tab fields frozen due to assignment period ending on ${endDate}`);
        }

        // Function to unfreeze all assignment tab fields
        function unfreezeAssignmentTabFields() {
            // Unfreeze team member selection
            unfreezeTeamMemberField();
            
            // Unfreeze all KPI form fields
            unfreezeAllKPIFields();
            
            // Unfreeze Add KPI button
            const addKPIBtn = document.getElementById('addKPIBtn');
            if (addKPIBtn) {
                unlockAddKPIButton(addKPIBtn);
            }
            
            // Hide frozen message
            hideAssignmentTabFrozenMessage();
            
            console.log('🔓 All assignment tab fields unfrozen - assignment period is active');
        }

        // Function to freeze all KPI form fields
        function freezeAllKPIFields(assignmentEndDate) {
            const endDate = formatDate(assignmentEndDate);
            
            // Find all KPI sections
            const kpiSections = document.querySelectorAll('.kpi-section');
            
            kpiSections.forEach((section, index) => {
                // Freeze all input fields within this KPI section
                const inputs = section.querySelectorAll('input, select, textarea');
                
                inputs.forEach(input => {
                    // Skip if already disabled
                    if (input.disabled) return;
                    
                    // Disable and style the field
                    input.disabled = true;
                    input.classList.add('field-disabled');
                    input.style.pointerEvents = 'none';
                    input.style.cursor = 'not-allowed';
                    
                    // Update title
                    input.title = `This field is frozen because the assignment period ended on ${endDate}. Contact your administrator if changes are needed.`;
                    
                    // Store original state for unfreezing
                    input._wasDisabledBeforeFreeze = false;
                });
                
                // Freeze remove buttons
                const removeBtn = section.querySelector('.remove-kpi-btn');
                if (removeBtn) {
                    removeBtn.disabled = true;
                    removeBtn.classList.add('field-disabled');
                    removeBtn.style.pointerEvents = 'none';
                    removeBtn.title = `KPI removal is frozen because the assignment period ended on ${endDate}.`;
                }
                
                // Add frozen indicator to KPI section header
                const header = section.querySelector('.kpi-section-header h3');
                if (header && !header.querySelector('.frozen-indicator')) {
                    const frozenIndicator = document.createElement('span');
                    frozenIndicator.className = 'frozen-indicator kpi-frozen-indicator';
                    frozenIndicator.innerHTML = ' <i class="fas fa-lock" style="color: #dc3545; margin-left: 8px;" title="KPI frozen due to assignment period expiry"></i>';
                    header.appendChild(frozenIndicator);
                }
            });
            
            console.log(`❄️ Frozen ${kpiSections.length} KPI sections with all their fields`);
        }

        // Function to unfreeze all KPI form fields
        function unfreezeAllKPIFields() {
            // Find all KPI sections
            const kpiSections = document.querySelectorAll('.kpi-section');
            
            kpiSections.forEach((section, index) => {
                // Unfreeze all input fields within this KPI section
                const inputs = section.querySelectorAll('input, select, textarea');
                
                inputs.forEach(input => {
                    // Only unfreeze if it wasn't disabled before freezing
                    if (input._wasDisabledBeforeFreeze === false) {
                        input.disabled = false;
                        input.classList.remove('field-disabled');
                        input.style.pointerEvents = '';
                        input.style.cursor = '';
                        input.title = '';
                        
                        // Clean up freeze state
                        delete input._wasDisabledBeforeFreeze;
                    }
                });
                
                // Unfreeze remove buttons
                const removeBtn = section.querySelector('.remove-kpi-btn');
                if (removeBtn && removeBtn.classList.contains('field-disabled')) {
                    removeBtn.disabled = false;
                    removeBtn.classList.remove('field-disabled');
                    removeBtn.style.pointerEvents = '';
                    removeBtn.title = 'Remove this KPI';
                }
                
                // Remove frozen indicator from KPI section header
                const frozenIndicator = section.querySelector('.kpi-frozen-indicator');
                if (frozenIndicator) {
                    frozenIndicator.remove();
                }
            });
            
            console.log(`🔓 Unfrozen ${kpiSections.length} KPI sections and their fields`);
        }

        // Function to freeze the team member selection field when assignment period ends
        function freezeTeamMemberField(assignmentEndDate) {
            const teamMemberSelect = document.getElementById('globalEmployee');
            const teamMemberLabel = document.querySelector('label[for="globalEmployee"]');
            
            if (!teamMemberSelect) {
                console.log('Team member select field not found');
                return;
            }

            // Disable the select field and prevent dropdown interaction
            teamMemberSelect.disabled = true;
            teamMemberSelect.classList.add('field-disabled');
            
            // Prevent dropdown from opening by blocking click and focus events
            teamMemberSelect.style.pointerEvents = 'none';
            teamMemberSelect.style.cursor = 'not-allowed';
            
            // Add event listeners to prevent dropdown interaction
            const preventDropdown = (e) => {
                e.preventDefault();
                e.stopPropagation();
                return false;
            };
            
            teamMemberSelect.addEventListener('click', preventDropdown, true);
            teamMemberSelect.addEventListener('mousedown', preventDropdown, true);
            teamMemberSelect.addEventListener('focus', preventDropdown, true);
            teamMemberSelect.addEventListener('keydown', preventDropdown, true);
            
            // Store event listeners for removal later
            teamMemberSelect._preventDropdownHandler = preventDropdown;
            
            // Update title with explanation
            const endDate = formatDate(assignmentEndDate);
            teamMemberSelect.title = `Team member selection is frozen because the assignment period ended on ${endDate}. Contact your administrator if changes are needed.`;
            
            // Add visual indicator to the label
            if (teamMemberLabel && !teamMemberLabel.querySelector('.frozen-indicator')) {
                const frozenIndicator = document.createElement('span');
                frozenIndicator.className = 'frozen-indicator';
                frozenIndicator.innerHTML = ' <i class="fas fa-lock" style="color: #dc3545; margin-left: 5px;" title="Field frozen due to assignment period expiry"></i>';
                teamMemberLabel.appendChild(frozenIndicator);
            }
            
            // Show frozen state message if no team member is currently selected
            if (teamMemberSelect.value === '') {
                showTeamMemberFrozenMessage(endDate);
            }
            
            console.log(`❄️ Team member field frozen due to assignment period ending on ${endDate}`);
        }

        // Function to unfreeze the team member selection field
        function unfreezeTeamMemberField() {
            const teamMemberSelect = document.getElementById('globalEmployee');
            const teamMemberLabel = document.querySelector('label[for="globalEmployee"]');
            
            if (!teamMemberSelect) {
                return;
            }

            // Re-enable the select field and restore dropdown interaction
            teamMemberSelect.disabled = false;
            teamMemberSelect.classList.remove('field-disabled');
            teamMemberSelect.style.pointerEvents = '';
            teamMemberSelect.style.cursor = '';
            teamMemberSelect.title = 'Select a team member to assign KPIs';
            
            // Remove event listeners that prevent dropdown interaction
            if (teamMemberSelect._preventDropdownHandler) {
                teamMemberSelect.removeEventListener('click', teamMemberSelect._preventDropdownHandler, true);
                teamMemberSelect.removeEventListener('mousedown', teamMemberSelect._preventDropdownHandler, true);
                teamMemberSelect.removeEventListener('focus', teamMemberSelect._preventDropdownHandler, true);
                teamMemberSelect.removeEventListener('keydown', teamMemberSelect._preventDropdownHandler, true);
                delete teamMemberSelect._preventDropdownHandler;
            }
            
            // Remove frozen indicator from label
            if (teamMemberLabel) {
                const frozenIndicator = teamMemberLabel.querySelector('.frozen-indicator');
                if (frozenIndicator) {
                    frozenIndicator.remove();
                }
            }
            
            // Hide frozen state message
            hideTeamMemberFrozenMessage();
            
            console.log('🔓 Team member field unfrozen - assignment period is active');
        }

        // Function to show assignment tab frozen message
        function showAssignmentTabFrozenMessage(endDate) {
            hideAssignmentTabFrozenMessage(); // Remove any existing message
            
            const assignmentTab = document.querySelector('#assignment');
            if (assignmentTab) {
                const message = document.createElement('div');
                message.id = 'assignment-tab-frozen-message';
                message.className = 'frozen-message assignment-tab-frozen';
                message.innerHTML = `
                    <div class="frozen-message-content">
                        <i class="fas fa-snowflake frozen-icon"></i>
                        <strong>Assignment Tab Frozen</strong>
                        <p>All assignment fields are frozen because the assignment period ended on <strong>${endDate}</strong>.</p>
                        <p>Contact your administrator if changes are needed during other periods.</p>
                    </div>
                `;
                
                // Insert at the top of assignment tab
                assignmentTab.insertBefore(message, assignmentTab.firstChild);
                
                // Animate in
                setTimeout(() => {
                    message.style.opacity = '1';
                    message.style.transform = 'translateY(0)';
                }, 100);
            }
        }

        // Function to hide assignment tab frozen message
        function hideAssignmentTabFrozenMessage() {
            const message = document.getElementById('assignment-tab-frozen-message');
            if (message) {
                message.style.opacity = '0';
                message.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }
        }

        // Function to show team member frozen message
        function showTeamMemberFrozenMessage(endDate) {
            const gettingStartedSection = document.querySelector('.getting-started-section');
            
            if (!gettingStartedSection) {
                return;
            }
            
            // Remove existing frozen message if any
            const existingMessage = document.getElementById('teamMemberFrozenMessage');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create frozen message
            const frozenMessage = document.createElement('div');
            frozenMessage.id = 'teamMemberFrozenMessage';
            frozenMessage.className = 'schedule-notification warning';
            frozenMessage.style.marginBottom = '20px';
            frozenMessage.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <div class="notification-content">
                    <strong>Team Member Selection Frozen</strong>
                    <p>The assignment period ended on ${endDate}. Team member selection is now locked. If you need to assign KPIs to a different team member, please contact your administrator to extend the assignment period.</p>
                </div>
            `;
            
            // Insert before getting started section
            gettingStartedSection.parentNode.insertBefore(frozenMessage, gettingStartedSection);
        }

        // Function to hide team member frozen message
        function hideTeamMemberFrozenMessage() {
            const frozenMessage = document.getElementById('teamMemberFrozenMessage');
            if (frozenMessage) {
                frozenMessage.remove();
            }
        }

        // Function to update tab schedule information
        function updateTabScheduleInfo(schedule, today) {
            const assignmentTabPeriod = document.getElementById('assignmentTabPeriod');
            const evaluationTabPeriod = document.getElementById('evaluationTabPeriod');
            const yearEndTabPeriod = document.getElementById('yearEndTabPeriod');
            
            const assignmentTab = document.getElementById('assignmentTab');
            const evaluationTab = document.getElementById('evaluationTab');
            const yearEndTab = document.getElementById('yearEndTab');

            if (!schedule || !today) {
                // No schedule configured
                if (assignmentTabPeriod) {
                    assignmentTabPeriod.innerHTML = '<i class="fas fa-calendar-times"></i> No schedule configured';
                    assignmentTabPeriod.className = 'schedule-period-text outside';
                }
                if (evaluationTabPeriod) {
                    evaluationTabPeriod.innerHTML = '<i class="fas fa-calendar-times"></i> No schedule configured';
                    evaluationTabPeriod.className = 'schedule-period-text outside';
                }
                if (yearEndTabPeriod) {
                    yearEndTabPeriod.innerHTML = '<i class="fas fa-calendar-times"></i> No schedule configured';
                    yearEndTabPeriod.className = 'schedule-period-text outside';
                }
                
                // Apply tab status classes
                applyTabStatusClass(assignmentTab, 'outside');
                applyTabStatusClass(evaluationTab, 'outside');
                applyTabStatusClass(yearEndTab, 'outside');
                return;
            }

            const currentDate = new Date(today);

            // Update Assignment Tab
            const assignmentStatus = updateTabPeriodInfo(
                assignmentTabPeriod,
                schedule.assignmentStartDate,
                schedule.assignmentEndDate,
                currentDate,
                'Assignment'
            );
            applyTabStatusClass(assignmentTab, assignmentStatus);

            // Update Mid-Year Evaluation Tab
            const evaluationStatus = updateTabPeriodInfo(
                evaluationTabPeriod,
                schedule.midYearStartDate,
                schedule.midYearEndDate,
                currentDate,
                'Mid-Year'
            );
            applyTabStatusClass(evaluationTab, evaluationStatus);

            // Update Year-End Evaluation Tab
            const yearEndStatus = updateTabPeriodInfo(
                yearEndTabPeriod,
                schedule.yearEndStartDate,
                schedule.yearEndEndDate,
                currentDate,
                'Year-End'
            );
            applyTabStatusClass(yearEndTab, yearEndStatus);
        }

        // Helper function to apply status class to tab
        function applyTabStatusClass(tabElement, status) {
            if (!tabElement) return;
            
            // Remove existing status classes
            tabElement.classList.remove('tab-current', 'tab-upcoming', 'tab-past', 'tab-outside');
            
            // Add new status class
            if (status) {
                tabElement.classList.add(`tab-${status}`);
            }
        }

        // Helper function to update individual tab period information
        function updateTabPeriodInfo(element, startDateStr, endDateStr, currentDate, periodName) {
            if (!element || !startDateStr || !endDateStr) {
                if (element) {
                    element.innerHTML = '<i class="fas fa-calendar-times"></i> Not scheduled';
                    element.className = 'schedule-period-text outside';
                }
                return 'outside';
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            let statusClass = '';
            let icon = '';
            let text = '';
            
            if (currentDate >= startDate && currentDate <= endDate) {
                // Current period
                statusClass = 'current';
                icon = '<i class="fas fa-clock"></i>';
                const daysLeft = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                text = `Active (${daysLeft} day${daysLeft !== 1 ? 's' : ''} left)`;
            } else if (currentDate < startDate) {
                // Upcoming period
                statusClass = 'upcoming';
                icon = '<i class="fas fa-hourglass-start"></i>';
                const daysUntil = Math.ceil((startDate - currentDate) / (1000 * 60 * 60 * 24));
                text = `Starts in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`;
            } else {
                // Past period
                statusClass = 'past';
                icon = '<i class="fas fa-check-circle"></i>';
                const daysAgo = Math.ceil((currentDate - endDate) / (1000 * 60 * 60 * 24));
                text = `Ended ${daysAgo} day${daysAgo !== 1 ? 's' : ''} ago`;
            }

            element.innerHTML = `${icon} ${text}`;
            element.className = `schedule-period-text ${statusClass}`;
            element.title = `${periodName} Period: ${formatDate(startDateStr)} - ${formatDate(endDateStr)}`;
            
            return statusClass;
        }

        // Function to enforce period-based workflow restrictions
        function enforceWorkflowRestrictions(schedule, today) {
            if (!schedule || !today) return;

            const currentDate = new Date(today);
            const tabs = ['assignmentTab', 'evaluationTab', 'yearEndTab'];
            
            // Check each period and disable tabs that are not yet active
            const assignmentPeriod = getPeriodStatus(schedule.assignmentStartDate, schedule.assignmentEndDate, currentDate);
            const midYearPeriod = getPeriodStatus(schedule.midYearStartDate, schedule.midYearEndDate, currentDate);
            const yearEndPeriod = getPeriodStatus(schedule.yearEndStartDate, schedule.yearEndEndDate, currentDate);

            // Evaluation tab should only be accessible during or after mid-year period
            const evaluationTab = document.getElementById('evaluationTab');
            if (evaluationTab) {
                if (midYearPeriod === 'upcoming') {
                    evaluationTab.style.opacity = '0.6';
                    evaluationTab.style.pointerEvents = 'none';
                    evaluationTab.title = 'Mid-year evaluation will be available when the period starts';
                } else {
                    evaluationTab.style.opacity = '1';
                    evaluationTab.style.pointerEvents = '';
                    evaluationTab.title = '';
                }
            }

            // Year-end tab should only be accessible during or after year-end period
            const yearEndTab = document.getElementById('yearEndTab');
            if (yearEndTab) {
                if (yearEndPeriod === 'upcoming') {
                    yearEndTab.style.opacity = '0.6';
                    yearEndTab.style.pointerEvents = 'none';
                    yearEndTab.title = 'End of year evaluation will be available when the period starts';
                } else {
                    yearEndTab.style.opacity = '1';
                    yearEndTab.style.pointerEvents = '';
                    yearEndTab.title = '';
                }
            }
        }

        // Helper function to get period status
        function getPeriodStatus(startDateStr, endDateStr, currentDate) {
            if (!startDateStr || !endDateStr) return 'outside';
            
            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);
            
            if (currentDate >= startDate && currentDate <= endDate) {
                return 'current';
            } else if (currentDate < startDate) {
                return 'upcoming';
            } else {
                return 'past';
            }
        }

        /**
         * Initialize KPI page with immediate schedule application
         */
        async function initializeKPIPageWithSchedule() {
            try {
                // Show company scope information
                const scopeInfo = displayCompanyScope();
                console.log('🏢 Initializing KPI page for company:', scopeInfo.user.companyName);
                
                // Load schedule from Firebase (company-scoped) with immediate application
                console.log('📅 Loading company-scoped KPI schedule...');
                const firebaseSchedule = await loadKPIScheduleFromFirebase();
                
                // Try localStorage as fallback
                const savedSchedule = localStorage.getItem('kpiSchedule');
                let schedule = null;
                let scheduleSource = 'none';
                
                if (firebaseSchedule) {
                    schedule = firebaseSchedule;
                    scheduleSource = 'firebase';
                    console.log(`✅ Loaded schedule from Firebase for company: ${firebaseSchedule.companyName || firebaseSchedule.companyId}`);
                } else if (savedSchedule) {
                    schedule = JSON.parse(savedSchedule);
                    scheduleSource = 'localStorage';
                    console.log('⚠️ Using localStorage schedule as fallback');
                } else {
                    console.log('❌ No schedule found - using default behavior');
                }
                
                // Immediately apply schedule to the page
                if (schedule) {
                    // Apply schedule information to UI elements
                    updateKPIFormScheduleInfo(schedule);
                    
                    // Update all schedule indicators and period status
                    const currentDate = new Date();
                    const today = currentDate.toISOString().split('T')[0];
                    updateScheduleIndicators(schedule, today);
                    
                    // Update tab schedule information
                    updateTabScheduleInfo(schedule, today);
                    
                    // Apply button locking based on periods
                    updateAddKPIButtonState(schedule, today);
                    
                    // Enforce workflow restrictions
                    enforceWorkflowRestrictions(schedule, today);
                    
                    console.log(`🎯 Schedule successfully applied from ${scheduleSource} for company: ${scopeInfo.user.companyName}`);
                    
                    // Show success indicator
                    if (scheduleSource === 'firebase') {
                        showTemporaryMessage(`📊 Company schedule loaded successfully`, 'success');
                    } else {
                        showTemporaryMessage(`📊 Schedule loaded from local storage`, 'info');
                    }
                } else {
                    // No schedule available - show default state
                    updateScheduleIndicators(null, null);
                    updateTabScheduleInfo(null, null);
                    console.log('ℹ️ No schedule configured - displaying default state');
                    showTemporaryMessage(`⚙️ No schedule configured for ${scopeInfo.user.companyName}`, 'neutral');
                }
                
            } catch (error) {
                console.error('❌ Error initializing KPI page with schedule:', error);
                
                // Fallback to localStorage only
                try {
                    const savedSchedule = localStorage.getItem('kpiSchedule');
                    if (savedSchedule) {
                        const schedule = JSON.parse(savedSchedule);
                        updateKPIFormScheduleInfo(schedule);
                        const today = new Date().toISOString().split('T')[0];
                        updateScheduleIndicators(schedule, today);
                        updateTabScheduleInfo(schedule, today);
                        updateAddKPIButtonState(schedule, today);
                        console.log('⚠️ Applied schedule from localStorage after Firebase error');
                        showTemporaryMessage(`📊 Schedule loaded from local backup`, 'warning');
                    } else {
                        updateScheduleIndicators(null, null);
                        updateTabScheduleInfo(null, null);
                        showTemporaryMessage(`❌ Unable to load schedule`, 'error');
                    }
                } catch (fallbackError) {
                    console.error('❌ Fallback schedule loading also failed:', fallbackError);
                    updateScheduleIndicators(null, null);
                    updateTabScheduleInfo(null, null);
                    showTemporaryMessage(`❌ Schedule system unavailable`, 'error');
                }
            }
        }

        /**
         * Show temporary status message to user
         */
        function showTemporaryMessage(message, type = 'info') {
            // Create or update status indicator
            let statusElement = document.getElementById('scheduleStatusIndicator');
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = 'scheduleStatusIndicator';
                statusElement.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 16px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 500;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    transition: all 0.3s ease;
                    max-width: 300px;
                `;
                document.body.appendChild(statusElement);
            }
            
            // Set colors based on type
            const colors = {
                success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
                info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' },
                warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
                error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
                neutral: { bg: '#e2e3e5', border: '#ced4da', text: '#495057' }
            };
            
            const color = colors[type] || colors.info;
            statusElement.style.backgroundColor = color.bg;
            statusElement.style.borderLeft = `4px solid ${color.border}`;
            statusElement.style.color = color.text;
            statusElement.textContent = message;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                if (statusElement && statusElement.parentNode) {
                    statusElement.style.opacity = '0';
                    statusElement.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (statusElement && statusElement.parentNode) {
                            statusElement.parentNode.removeChild(statusElement);
                        }
                    }, 300);
                }
            }, 5000);
        }

        function getCurrentUser() {
            // Get current user info for audit trail and company scope
            try {
                const currentUser = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                if (currentUser) {
                    const userData = JSON.parse(currentUser);
                    
                    // Return full user object for company-scoped operations
                    if (typeof userData === 'object' && userData !== null) {
                        return {
                            id: userData.id || userData.email || userData.name || 'unknown',
                            email: userData.email || userData.name || userData.id || 'Unknown User',
                            name: userData.name || userData.email || userData.id || 'Unknown User',
                            companyId: userData.companyId || userData.company || 'default_company',
                            companyName: userData.companyName || userData.company || 'Default Company',
                            department: userData.department || 'General',
                            role: userData.role || 'Employee'
                        };
                    }
                    
                    // Fallback for legacy string format
                    return {
                        id: userData,
                        email: userData,
                        name: userData,
                        companyId: 'default_company',
                        companyName: 'Default Company',
                        department: 'General',
                        role: 'Employee'
                    };
                }
            } catch (e) {
                console.error('Error getting current user:', e);
            }
            
            // Default fallback user object
            return {
                id: 'system',
                email: 'System User',
                name: 'System User',
                companyId: 'default_company',
                companyName: 'Default Company',
                department: 'System',
                role: 'System'
            };
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function formatDateWithDay(dateString) {
            if (!dateString) return 'Not set';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                weekday: 'short',
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function showSuccessMessage(message) {
            const successModal = document.getElementById('successModal');
            if (successModal) {
                const messageElement = successModal.querySelector('.modal-body p');
                if (messageElement) {
                    messageElement.textContent = message;
                }
                openModal('successModal');
            } else {
                alert(message);
            }
        }

        function showErrorMessage(message) {
            const errorModal = document.getElementById('errorModal');
            if (errorModal) {
                const messageElement = document.getElementById('errorMessage');
                if (messageElement) {
                    messageElement.textContent = message;
                }
                openModal('errorModal');
            } else {
                alert(message);
            }
        }

        // Handle edit mode initialization when coming from KPI dashboard
        function handleEditModeInitialization() {
            // Check URL parameters for edit mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const employeeParam = urlParams.get('employee');
            
            console.log('Checking edit mode - mode:', mode, 'employee:', employeeParam);
            
            if (mode === 'edit' && employeeParam) {
                // Wait for employee options to be loaded (they are loaded asynchronously)
                const waitForEmployeeOptions = () => {
                    const globalEmployee = document.getElementById('globalEmployee');
                    if (!globalEmployee || globalEmployee.options.length <= 1) {
                        // Options not loaded yet, wait a bit longer
                        setTimeout(waitForEmployeeOptions, 100);
                        return;
                    }
                    
                    // Find and select the employee in the dropdown
                    let employeeFound = false;
                    for (let i = 0; i < globalEmployee.options.length; i++) {
                        const option = globalEmployee.options[i];
                        if (option.value === employeeParam) {
                            globalEmployee.selectedIndex = i;
                            employeeFound = true;
                            console.log('Selected employee from URL parameter:', employeeParam);
                            break;
                        }
                    }
                    
                    if (employeeFound) {
                        // Trigger change event to update any dependent UI
                        globalEmployee.dispatchEvent(new Event('change'));
                        
                        // Ensure team member consistency across all tabs
                        setTimeout(() => {
                            updateAllTabsForSelectedEmployee(employeeParam, globalEmployee.options[globalEmployee.selectedIndex].textContent);
                        }, 200);
                        
                        // Check if there's edit data in sessionStorage
                        const editData = sessionStorage.getItem('kpiEditData');
                        if (editData) {
                            try {
                                const parsedEditData = JSON.parse(editData);
                                console.log('Found edit data in sessionStorage:', parsedEditData);
                                
                                // Determine which tab to open based on the edit context
                                // If we have evaluation data, open evaluation tab
                                // Otherwise, default to assignment tab for editing KPIs
                                if (parsedEditData.hasEvaluationData) {
                                    console.log('Opening evaluation tab for editing');
                                    setTimeout(() => switchTab('evaluation'), 500);
                                } else {
                                    console.log('Opening assignment tab for editing KPIs');
                                    // Stay on assignment tab but ensure the form shows with selected employee
                                    setTimeout(() => {
                                        // Hide getting started section and show KPI sections
                                        const gettingStarted = document.getElementById('gettingStarted');
                                        const kpiSections = document.getElementById('kpiSectionsContainer');
                                        if (gettingStarted) gettingStarted.style.display = 'none';
                                        if (kpiSections) kpiSections.style.display = 'block';
                                    }, 300);
                                }
                                
                                // Clear the edit data from sessionStorage after using it
                                sessionStorage.removeItem('kpiEditData');
                                
                            } catch (error) {
                                console.error('Error parsing edit data from sessionStorage:', error);
                            }
                        } else {
                            // No specific edit data, default to assignment tab
                            console.log('No edit data found, staying on assignment tab');
                            setTimeout(() => {
                                // Ensure the form shows with selected employee
                                const gettingStarted = document.getElementById('gettingStarted');
                                const kpiSections = document.getElementById('kpiSectionsContainer');
                                if (gettingStarted) gettingStarted.style.display = 'none';
                                if (kpiSections) kpiSections.style.display = 'block';
                            }, 300);
                        }
                        
                        // Clean up URL parameters to prevent re-triggering on refresh
                        if (window.history && window.history.replaceState) {
                            const cleanUrl = window.location.pathname;
                            window.history.replaceState({}, document.title, cleanUrl);
                        }
                        
                    } else {
                        console.warn('Employee not found in dropdown:', employeeParam);
                    }
                };
                
                // Start checking for employee options
                waitForEmployeeOptions();
            }
        }

        // Initialize page when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 KPI evaluation page initialized with Firebase real-time support');
            
            // Immediately load and apply schedule on page load
            initializeKPIPageWithSchedule();
            
            // Handle edit mode from KPI dashboard
            handleEditModeInitialization();
            
            // Setup team member consistency after a small delay to ensure DOM is ready
            setTimeout(() => {
                ensureTeamMemberConsistency();
            }, 100);

            // Setup schedule form
            const scheduleForm = document.getElementById('kpiScheduleForm');
            if (scheduleForm) {
                scheduleForm.addEventListener('submit', saveKPISchedule);
                
                // Add event listeners for real-time schedule preview updates
                document.getElementById('assignmentStartDate').addEventListener('change', updateSchedulePreview);
                document.getElementById('assignmentEndDate').addEventListener('change', updateSchedulePreview);
                document.getElementById('midYearStartDate').addEventListener('change', updateSchedulePreview);
                document.getElementById('midYearEndDate').addEventListener('change', updateSchedulePreview);
                document.getElementById('yearEndStartDate').addEventListener('change', updateSchedulePreview);
                document.getElementById('yearEndEndDate').addEventListener('change', updateSchedulePreview);
                
                // Add event listeners for deadline reminder fields to trigger auto-save
                document.getElementById('deadlineReminderDate').addEventListener('change', () => {
                    setTimeout(() => saveCurrentNotificationSettings(), 500);
                });
                document.getElementById('deadlineReminderTime').addEventListener('change', () => {
                    setTimeout(() => saveCurrentNotificationSettings(), 500);
                });
                
                // Initialize notification scheduling
                initializeNotificationScheduling();
                
                // Initialize multiple notification schedules
                initializeMultipleNotificationSchedules();
                
                // Initialize and start notification scheduler if schedule exists
                initializeNotificationScheduler();
                
                // Setup Firebase real-time listener for schedule changes
                setupKPIScheduleFirebaseListener();
            }
        });
    </script>
</body>
</html>

