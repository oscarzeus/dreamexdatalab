<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMS Register - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        
        /* === Core Variables / Layout (derived from recruitboard + staff) === */
        :root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --orange:#e67e22; --red:#e74c3c; --purple:#9b59b6; --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem; --font-scale:1; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333; --text-secondary:#666; --border-color:#e0e0e0; --spacing-unit:.9rem; --padding-sm:.45rem; --padding-md:.75rem; --padding-lg:1.2rem; --transition-speed:.2s; }
        *{margin:0;padding:0;box-sizing:border-box;} body{font-family:var(--font-family);font-size:var(--base-font-size);line-height:1.4;color:var(--text-primary);background:#f8f9fa;}
        .app-container{display:flex;min-height:100vh;}
        .sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;height:100vh;overflow-y:auto;transition:transform .3s ease;}
        .sidebar.collapsed{transform:translateX(-100%);} .logo h2{text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.05rem;}
        .menu{list-style:none;margin-top:1.5rem;} .menu li{margin-bottom:.45rem;} .menu a{color:#fff;text-decoration:none;display:flex;align-items:center;padding:.65rem .9rem;border-radius:6px;font-size:.78rem;gap:.55rem;letter-spacing:.25px;transition:background .25s;} .menu a:hover,.menu a.active{background:var(--secondary-color);} .menu-dropdown .submenu{display:none;list-style:none;margin-left:1.2rem;margin-top:.35rem;} .menu-dropdown:hover .submenu{display:block;}
        /* Feature-based visibility */
        [data-feature]:not(.menu-visible){display:none !important;} .menu-dropdown:not(.menu-visible){display:none !important;} 
        
        /* Hide ALL menu items by default during loading - only for sidebar menu */
        .sidebar.menu-loading .menu-item, .sidebar.menu-loading .menu-dropdown, .sidebar.menu-loading li[data-feature], .sidebar.menu-loading [data-feature] {display:none !important;} .menu-loading [data-feature]{display:none !important;} .menu-loading .menu-dropdown{display:none !important;}
        .main-content{flex:1;margin-left:var(--sidebar-width);padding:.45rem;width:calc(100% - var(--sidebar-width));box-sizing:border-box;display:flex;flex-direction:column;transition:margin-left .3s ease,width .3s ease;}
        .main-content.sidebar-collapsed{margin-left:0;width:100%;}
        /* Top Nav (copied style approach from staff.html) */
    .top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:.35rem;position:fixed;top:.25rem;right:.5rem;left:calc(var(--sidebar-width) + .5rem);height:50px;min-height:50px;z-index:100;transition:left .3s ease;border-radius:0;}
        .top-nav-left{display:flex;align-items:center;gap:1rem;font-size:.8rem;font-weight:600;color:var(--text-secondary);} .sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;padding:.45rem;color:#666;border-radius:6px;display:flex;align-items:center;justify-content:center;} .sidebar-toggle-btn:hover{background:rgba(0,0,0,.06);}
    /* Company logo (adjusted to NOT be forced square like camp.html) */
    #headerCompanyLogo, .header-company-logo {height:35px; width:auto; max-width:140px; border-radius:0; object-fit:contain; display:none; background:transparent; border:none; box-shadow:none;}
    #headerCompanyLogo.visible{display:block;}
    #headerCompanyName{font-size:.8rem;font-weight:600;letter-spacing:.5px;color:var(--primary-color);max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .top-nav-right{display:flex;align-items:center;gap:1.2rem;margin-left:auto;}
    .user-profile{position:relative;display:flex;align-items:center;}
        .notifications{position:relative;display:flex;align-items:center;} .notification-btn{background:none;border:none;cursor:pointer;position:relative;font-size:1.1rem;padding:.45rem;display:flex;align-items:center;justify-content:center;} .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--accent-color);color:#fff;border-radius:50%;padding:.15rem .45rem;font-size:.6rem;}
        .notification-dropdown{display:none;position:absolute;right:0;top:100%;width:280px;background:#fff;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,.12);z-index:1000;}
        .notification-dropdown.show{display:block;} .notification-list{max-height:280px;overflow-y:auto;}
        /* User Profile Styles (from travel.html) */
        .profile-btn { background:none; border:none; cursor:pointer; padding:0; }
        .profile-btn img { width:40px; height:40px; border-radius:50%; object-fit:cover; background:#eee; }
        .profile-dropdown { position:absolute; top:100%; right:0; background:#fff; border:1px solid #ddd; border-radius:6px; padding:0; display:none; min-width:220px; box-shadow:0 4px 12px rgba(0,0,0,0.12); }
        .profile-dropdown.show { display:block; }
        .profile-dropdown ul { list-style:none; margin:0; padding:0; }
        .profile-dropdown li a { display:flex; align-items:center; gap:8px; padding:10px 14px; text-decoration:none; color:#333; font-size:0.8rem; }
        .profile-dropdown li a:hover { background:#f5f5f5; }
        .avatar-initials{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1rem;}
        
        /* Content Area Styles */
    .content{padding:1rem;background:#fff;border-radius:0 0 8px 8px;margin:60px 0 0 0;min-height:calc(100vh - 80px);}
        
        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 0.55rem 0.75rem;
            border-radius: 0;
            margin: 0.35rem 0 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.9rem;
        }

        .page-header i {
            font-size: 1rem;
        }

        .header-main {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .page-header h1 {
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.9rem;
            margin: 0;
            font-weight: 600;
        }

        .page-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-add-new {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-add-new:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .content-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid #e9ecef;}
        .content-header h1{color:#333;font-size:1.5rem;margin:0;}
        
        /* Button Styles */
        .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1.2rem;border:none;border-radius:6px;font-size:.85rem;font-weight:500;cursor:pointer;transition:all .2s;text-decoration:none;justify-content:center;}
        .btn-primary{background:#2196F3;color:#fff;} .btn-primary:hover{background:#1976D2;}
        .btn-secondary{background:#6c757d;color:#fff;} .btn-secondary:hover{background:#5a6268;}
        .btn-success{background:#28a745;color:#fff;} .btn-success:hover{background:#218838;}
        .btn-danger{background:#dc3545;color:#fff;} .btn-danger:hover{background:#c82333;}
        .btn-edit{background:#ffc107;color:#000;} .btn-edit:hover{background:#e0a800;}
        .btn-delete{background:#dc3545;color:#fff;} .btn-delete:hover{background:#c82333;}
        
        /* Table Styles */
        .table-container{background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);overflow:hidden;}
        .data-table{width:100%;border-collapse:collapse;}
        .data-table thead th{background:#f8f9fa;padding:.6rem;text-align:left;font-weight:600;color:#495057;border-bottom:2px solid #dee2e6;}
        .data-table tbody td{padding:.6rem;border-bottom:1px solid #dee2e6;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .data-table tbody tr:hover{background:#f8f9fa;}
    #changeRequestsTable tbody tr{cursor:pointer;}
        .empty-state{text-align:center;padding:3rem;color:#6c757d;}
        .empty-state i{font-size:3rem;margin-bottom:1rem;color:#dee2e6;}
        .empty-state p{margin:0.5rem 0;}
        .empty-state a{color:#2196F3;text-decoration:none;}
        .empty-state a:hover{text-decoration:underline;}

        /* Search Bar Styles */
        .search-bar{flex:1;max-width:400px;}
        .search-bar input{width:100%;padding:.5rem 1rem;border:1px solid #ddd;border-radius:6px;font-size:.85rem;}
        .search-bar input:focus{outline:none;border-color:#2196F3;box-shadow:0 0 0 2px rgba(33,150,243,.2);}

        /* DMS-specific styles */
        .severity-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .severity-badge.low { background: #4CAF50; color: white; }
        .severity-badge.medium { background: #FFC107; color: black; }
        .severity-badge.high { background: #FF9800; color: white; }
        .severity-badge.critical { background: #F44336; color: white; }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .status-badge.pending { background: #FFC107; color: black; }
        .status-badge.approved { background: #4CAF50; color: white; }
        .status-badge.rejected { background: #F44336; color: white; }

        /* Custom DMS filters */
        .filters { 
            display: flex; 
            gap: 0.5rem; 
            flex-wrap: wrap; 
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .filters input, .filters select { 
            padding: 0.45rem 0.6rem; 
            border: 1px solid #e1e5ea; 
            border-radius: 6px; 
            font-size: 0.85rem;
        }
        .filters input:focus, .filters select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        /* Document-specific styles */
        .doc-title { font-weight: 600; color: #2c3e50; }
        .muted { color: #6c757d; font-size: 0.85rem; margin-top: 2px; }
        .version-info { color: #495057; font-size: 0.8rem; font-weight: 500; margin-top: 4px; }
        .category-badge { 
            display: inline-block;
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.75rem; 
            font-weight: 500;
            margin-top: 4px;
        }
        .category-badge.hse { background: #e3f2fd; color: #1976d2; }
        .category-badge.quality { background: #f3e5f5; color: #7b1fa2; }
        .category-badge.operations { background: #e8f5e8; color: #388e3c; }
        .category-badge.maintenance { background: #fff3e0; color: #f57c00; }
        .category-badge.training { background: #fce4ec; color: #c2185b; }
        .category-badge.emergency { background: #ffebee; color: #d32f2f; }
        .category-badge.regulatory { background: #e0f2f1; color: #00796b; }
        .category-badge.hr { background: #f1f8e9; color: #689f38; }
        
        .status-pill { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8rem; 
            font-weight: 500;
        }
        .status-pill i { font-size: 0.7rem; }
        .status-draft { background: #fff3cd; color: #856404; }
        .status-inreview { background: #cff4fc; color: #055160; }
        .status-approved { background: #d1e7dd; color: #0f5132; }
        
        .risk-pill { 
            display: inline-flex; 
            align-items: center; 
            gap: 4px; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8rem; 
            font-weight: 500;
        }
        .risk-pill i { font-size: 0.7rem; }
        .risk-low { background: #d1e7dd; color: #0f5132; }
        .risk-medium { background: #fff3cd; color: #856404; }
        .risk-high { background: #f8d7da; color: #721c24; }
        .risk-critical { background: #f5c2c7; color: #58151c; }
        
        .actions button {
            background: none;
            border: 1px solid #dee2e6;
            padding: 0.4rem;
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .actions button:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }
        .actions button i {
            font-size: 0.85rem;
        }

        /* Modal Styles */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; padding:2rem 1rem; z-index:10000; }
        .modal.show { display:flex; }
    .modal-content { background:#fff; width:100%; max-width:900px; min-width:600px; border-radius:10px; padding:1.25rem 1.5rem 1.5rem; max-height:85vh; overflow:auto; box-shadow:0 18px 48px rgba(0,0,0,0.25); }
        .modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.75rem; }
        .modal-header h2 { font-size:1.1rem; font-weight:600; }
        .close-btn { background:none; border:none; font-size:1.2rem; cursor:pointer; color:#666; }
        .modal-details-row { margin-bottom:0.7rem; }
        .modal-details-label { font-weight:600; color:#2c3e50; display:inline-block; min-width:120px; }
        .modal-details-value { color:#333; }

        /* Tab Styles */
        .tab-navigation {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 1.5rem;
        }
        .tab-btn {
            background: none;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab-btn:hover {
            color: #495057;
            background: #f8f9fa;
        }
        .tab-btn.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            background: #f8f9fa;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Change Request Form Styles */
        .change-request-form {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            margin-bottom: 2rem;
        }
        .change-request-form h3 {
            margin: 0 0 1.5rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-control:focus {
            border-color: #3498db;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-primary:hover {
            background: #2980b9;
        }
        .change-requests-list h3 {
            margin: 0 0 1rem 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }
        .btn-small {
            background: none;
            border: 1px solid #dee2e6;
            padding: 0.4rem;
            margin: 0 2px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        .btn-small:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }
    </style>
</head>
<body>
    
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                        <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                        <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                        <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
                    <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo">
                    <div id="headerLogoPlaceholder" style="width:44px;height:44px;border-radius:6px;background:#f8f9fa;border:2px dashed #ced4da;display:flex;align-items:center;justify-content:center;color:#6c757d;"><i class="fas fa-building"></i></div>
                    <span id="headerCompanyName"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile" style="position:relative;">
                        <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                        <div class="profile-dropdown"><ul></ul></div>
                    </div>
                </div>
            </header>

                        <!-- Page Content -->
                        <div class="content">
                                <!-- Document Details Modal -->
                                <div id="docDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5><i class="fas fa-file-alt"></i> Document Details</h5>
            <button class="close-btn" id="closeDocModal">&times;</button>
        </div>
        <div class="modal-body" id="docDetailsBody"></div>
        <div class="modal-footer" id="docDetailsFooter" style="display:flex;gap:1rem;justify-content:flex-end;align-items:center;">
            <div id="approvalActions" style="margin-right:auto; display:none;">
                <button class="modal-icon-btn" id="modalApproveBtn" title="Approve"><i class="fas fa-check" style="color:#16a34a"></i></button>
                <button class="modal-icon-btn" id="modalDeclineBtn" title="Decline"><i class="fas fa-times" style="color:#f59e0b"></i></button>
                <button class="modal-icon-btn" id="modalDeleteBtn" title="Delete"><i class="fas fa-trash" style="color:#dc2626"></i></button>
            </div>
            <button class="modal-icon-btn" id="modalEditBtn" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="modal-icon-btn" id="modalExportBtn" title="Export"><i class="fas fa-file-export"></i></button>
    <style>
    .modal-icon-btn {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        color: #444;
        font-size: 1.25rem;
        padding: 0.35rem 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.15s;
    }
    .modal-icon-btn:hover {
        background: #f0f0f0 !important;
        color: #222;
    }
    /* Freeze modal header/footer, make body scroll */
    #docDetailsModal .modal-content {
        display: flex;
        flex-direction: column;
        max-height: 85vh;
    }
    #docDetailsModal .modal-header,
    #docDetailsModal .modal-footer {
        flex: 0 0 auto;
    }
    #docDetailsModal .modal-body {
        flex: 1 1 auto;
        overflow-y: auto;
    }
    .modal-footer {
        background: none !important;
        box-shadow: none !important;
        border: none !important;
    }
    </style>
        </div>
    </div>
                                </div>

                                <!-- Change Request Creation Modal -->
                                <div id="createChangeRequestModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5><i class="fas fa-plus"></i> Create Change Request</h5>
            <button class="close-btn" id="closeCreateChangeRequestModal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="change-request-form">
                <div class="form-group">
                    <label for="modalRequestDocumentSelect">Select Document:</label>
                    <select id="modalRequestDocumentSelect" class="form-control">
                        <option value="">Choose a document...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modalChangeReason">Reason for Change:</label>
                    <textarea id="modalChangeReason" class="form-control" rows="4" placeholder="Please describe why this document needs to be changed..."></textarea>
                </div>
                <div class="form-group">
                    <label for="modalChangeDescription">Detailed Description:</label>
                    <textarea id="modalChangeDescription" class="form-control" rows="6" placeholder="Please provide detailed description of the changes needed..."></textarea>
                </div>
                <div class="form-group">
                    <label for="modalChangePriority">Priority:</label>
                    <select id="modalChangePriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer" style="display:flex;gap:1rem;justify-content:flex-end;align-items:center;">
            <button id="modalSubmitChangeRequestBtn" class="btn-primary">Submit Change Request</button>
        </div>
    </div>
                                </div>

                                <!-- Change Request Details Modal -->
                                <div id="changeRequestModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5><i class="fas fa-edit"></i> Change Request Details</h5>
            <button class="close-btn" id="closeChangeRequestModal">&times;</button>
        </div>
        <div class="modal-body" id="changeRequestBody"></div>
        <div class="modal-footer" id="changeRequestFooter" style="display:flex;gap:1rem;justify-content:flex-end;align-items:center;">
            <div id="changeRequestActions" style="margin-right:auto; display:none;">
                <button class="modal-icon-btn" id="crApproveBtn" title="Approve"><i class="fas fa-check" style="color:#16a34a"></i></button>
                <button class="modal-icon-btn" id="crDeclineBtn" title="Decline"><i class="fas fa-times" style="color:#f59e0b"></i></button>
            </div>
        </div>
    </div>
                                </div>
                <!-- Page Header -->
                <div class="page-header">
                    <div style="display: flex; align-items: center; gap: 0.6rem;">
                        <i class="fas fa-file-alt"></i>
                        <span>Document Management System</span>
                    </div>
                    <div class="page-actions">
                        <button type="button" class="btn-add-new" onclick="handleAddAction()" title="Add New Item" style="display: flex !important; background: transparent !important; color: white !important; border: none !important; font-size: 1.2rem !important; padding: 0.4rem !important;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="documents">
                        <i class="fas fa-folder-open"></i> Documents
                    </button>
                    <button class="tab-btn" data-tab="change-requests">
                        <i class="fas fa-edit"></i> Change Requests
                    </button>
                </div>

                <!-- Documents Tab Content -->
                <div id="documentsTab" class="tab-content active"">

                <div class="filters">
                    <input id="searchInput" type="text" placeholder="Search title, category, owner..." />
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="in_review">In Review</option>
                        <option value="approved">Approved</option>
                    </select>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                        <option value="policy">Policy</option>
                        <option value="procedure">Procedure</option>
                        <option value="work_instruction">Work Instruction</option>
                        <option value="form">Form</option>
                    </select>
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="hse">HSE</option>
                        <option value="quality">Quality Management</option>
                        <option value="operations">Operations</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="training">Training</option>
                        <option value="emergency">Emergency Response</option>
                        <option value="regulatory">Regulatory Compliance</option>
                        <option value="hr">HR</option>
                    </select>
                    <select id="riskFilter">
                        <option value="">All Risk Levels</option>
                        <option value="low">Low Risk</option>
                        <option value="medium">Medium Risk</option>
                        <option value="high">High Risk</option>
                        <option value="critical">Critical Risk</option>
                    </select>
                </div>

                <div class="table-container">
                    <table id="documentsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Document Info</th>
                                <th>Type</th>
                                <th>Category</th>
                                <th>Owner</th>
                                <th>Review Cycle</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows injected dynamically -->
                        </tbody>
                    </table>
                </div>
                </div>

                <!-- Change Requests Tab Content -->
                <div id="changeRequestsTab" class="tab-content">
                    <div class="change-requests-list">
                        <div class="table-container">
                            <table id="changeRequestsTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th>Request #</th>
                                        <th>Document</th>
                                        <th>Reason</th>
                                        <th>Status</th>
                                        <th>Requested Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Change requests will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

  <script>
    // Firebase v8 configuration (aligned with riskboard.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
      authDomain: "users-8be65.firebaseapp.com",
      databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
      projectId: "users-8be65",
      storageBucket: "users-8be65.firebasestorage.app",
      messagingSenderId: "909025468149",
      appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        function initializeFirebase() {
      if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
        window.firebase.initializeApp(firebaseConfig);
      }
      return window.firebase;
    }

    /**************** NotificationManager ****************/
    class NotificationManager {
        constructor() {
            this.notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
        }
        save() {
            localStorage.setItem('notifications', JSON.stringify(this.notifications));
            this.updateBadge();
            this.render();
        }
        addNotification(n) {
            this.notifications.unshift({
                id: Date.now(),
                timestamp: new Date().toISOString(),
                read: false,
                ...n
            });
            this.save();
        }
        init() {
            this.bindUI();
            this.updateBadge();
            this.render();
            if (this.notifications.length === 0) {
                this.addNotification({ type: 'System', message: 'Welcome to DMS Dashboard' });
            }
        }
        bindUI() {
            const btn = document.getElementById('notificationBtn');
            if (btn) {
                btn.onclick = () => document.querySelector('.notification-dropdown')?.classList.toggle('show');
            }
            document.addEventListener('click', e => {
                if (!e.target.closest('.notifications'))
                    document.querySelector('.notification-dropdown')?.classList.remove('show');
            });
            const mark = document.querySelector('.mark-all-read');
            if (mark) {
                mark.onclick = () => {
                    this.notifications.forEach(n => n.read = true);
                    this.save();
                };
            }
        }
        updateBadge() {
            const badge = document.querySelector('.notification-badge');
            if (!badge) return;
            const unread = this.notifications.filter(n => !n.read).length;
            badge.textContent = unread;
            badge.style.display = unread ? 'inline-block' : 'none';
        }
        render() {
            const list = document.querySelector('.notification-list');
            if (!list) return;
            list.innerHTML = '';
            if (this.notifications.length === 0) {
                list.innerHTML = '<div style="padding:.9rem;font-size:.65rem;">No notifications</div>';
                return;
            }
            this.notifications.slice(0, 25).forEach(n => {
                const d = new Date(n.timestamp);
                const div = document.createElement('div');
                div.className = 'notification-item' + (n.read ? ' read' : '');
                div.style.cssText = 'padding:.65rem .75rem;border-bottom:1px solid #eee;font-size:.62rem;cursor:pointer;' + (n.read ? 'opacity:.6;' : '');
                div.innerHTML = `<div style="display:flex;justify-content:space-between;font-weight:600;margin-bottom:2px;"><span>${n.type || 'Info'}</span><span style="font-weight:400;color:#555;">${d.toLocaleDateString()} ${d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span></div><div style="line-height:1.2;">${n.message || ''}</div>`;
                div.onclick = () => {
                    n.read = true;
                    this.save();
                    if (n.link) location.href = n.link;
                };
                list.appendChild(div);
            });
        }
    }
    window.notificationManager = new NotificationManager();

    /**************** AuthManager ****************/
    class AuthManager {
        constructor() {
            this.currentUser = this.getCurrentUser();
            this.currentCompany = null;
            console.log('🔐 AuthManager(init) dmstable');
            this.initializeAuth();
        }
        getCurrentUser() {
            try {
                return JSON.parse(localStorage.getItem('currentUser') || 'null');
            } catch {
                return null;
            }
        }
        setCurrentUser(u) {
            localStorage.setItem('currentUser', JSON.stringify(u));
            localStorage.setItem('user', JSON.stringify(u));
            this.currentUser = u;
        }
        async logout() {
            try {
                await firebase.auth().signOut();
            } catch (e) {
                console.warn('Logout error', e);
            }
            ['currentUser', 'user'].forEach(k => {
                localStorage.removeItem(k);
                sessionStorage.removeItem(k);
            });
            location.href = 'index.html';
        }
        initializeAuth() {
            console.log('🚀 initializeAuth called');
            console.log('👤 Current user:', this.currentUser);
            if (!this.currentUser) {
                console.warn('No user -> redirect login');
                location.href = 'login.html';
                return;
            }
            console.log('✅ User:', this.currentUser.email);

            this.loadUserRole(this.currentUser);
            this.loadUserCompany();
            
            // Initialize company branding (will show placeholder if no company)
            this.updateCompanyBranding();

            // Add small delay to ensure DOM is fully ready
            setTimeout(() => {
                console.log('🔄 Starting UI updates...');
                this.updateUIForAuthenticatedUser();
                this.updateMenuVisibility();
                this.bindProfileDropdown();
                console.log('✅ UI initialization complete');
            }, 100);
        }
        bindProfileDropdown() {
            console.log('🔗 bindProfileDropdown called');
            const btn = document.getElementById('userProfileBtn');
            const dd = document.querySelector('.profile-dropdown');
            console.log('🔍 Elements found:', { btn: !!btn, dropdown: !!dd });
            if (btn && dd) {
                console.log('✅ Binding profile dropdown events');
                btn.addEventListener('click', e => {
                    console.log('🖱️ Profile button clicked');
                    e.stopPropagation();
                    dd.classList.toggle('show');
                    console.log('📋 Dropdown toggled, show class:', dd.classList.contains('show'));
                });
                document.addEventListener('click', e => {
                    if (!btn.contains(e.target)) {
                        dd.classList.remove('show');
                        console.log('🖱️ Clicked outside, hiding dropdown');
                    }
                });
                const logoutLink = dd.querySelector('a[href="#"]:has(.fa-sign-out-alt)') || dd.querySelector('.fa-sign-out-alt')?.closest('a');
                if (logoutLink) {
                    logoutLink.addEventListener('click', e => {
                        e.preventDefault();
                        this.logout();
                    });
                }
            } else {
                console.error('❌ Missing elements for profile dropdown:', { btn, dd });
            }
        }
        resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(i => i.classList.remove('menu-visible'));
            document.querySelectorAll('.menu-dropdown').forEach(d => d.classList.remove('menu-visible'));
        }
        async updateMenuVisibility() {
            console.log('🎯 Starting feature-based menu authorization for dmstable.html...');
            const sidebar = document.querySelector('.sidebar');
            if (!this.currentUser) {
                this.resetMenuVisibility();
                sidebar?.classList.remove('menu-loading');
                return;
            }
            const companyId = this.currentUser.companyId;
            const userRole = this.currentUser.role;
            console.log('👤 User:', this.currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
            if (!companyId) {
                this.resetMenuVisibility();
                sidebar?.classList.remove('menu-loading');
                return;
            }

            // STEP 1: Apply company feature-based authorization
            console.log('🏢 STEP 1: Applying company feature authorization...');
            const authorizedPages = await this.applyFeatureBasedMenuVisibility(companyId);

            // STEP 2: Filter by user role permissions within authorized features
            if (userRole && authorizedPages && authorizedPages.length > 0) {
                console.log('👤 STEP 2: Applying role-based filtering within authorized features...');
                await this.applyRoleBasedFiltering(companyId, userRole, authorizedPages);
            } else {
                console.log('⚠️ STEP 2: Skipping role-based filtering (no role found or no authorized pages)');
                sidebar?.classList.remove('menu-loading');
            }
        }
        async applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                if (!featuresSnapshot.exists()) {
                    console.log('⚠️ No platform features found');
                    this.resetMenuVisibility();
                    return [];
                }
                const featuresData = featuresSnapshot.val();
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                if (!companyData) {
                    console.error('❌ Company data not found');
                    this.resetMenuVisibility();
                    return [];
                }
                const subscribed = companyData.selectedFeatures || [];
                console.log('🏢 Company subscribed features:', subscribed);
                if (subscribed.length === 0) {
                    console.log('⚠️ Company has no subscribed features');
                    this.resetMenuVisibility();
                    return [];
                }
                const authorizedPages = [];
                subscribed.forEach(fid => {
                    const f = featuresData[fid];
                    if (f && f.status === 'active' && f.authorizedPages) {
                        console.log(`📦 Adding pages from feature "${f.name}":`, f.authorizedPages);
                        authorizedPages.push(...f.authorizedPages);
                    } else {
                        console.log(`⚠️ Feature ${fid} not found or inactive`);
                    }
                });
                console.log('🔐 All authorized pages from company features:', authorizedPages);
                const authorizedFeatures = new Set();
                authorizedPages.forEach(p => {
                    if (p.feature) authorizedFeatures.add(p.feature);
                });
                console.log('🎯 Authorized features for dmstable.html:', Array.from(authorizedFeatures));
                this.resetMenuVisibility();
                let visibleCount = 0;
                document.querySelectorAll('li[data-feature]').forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const isDropdownContainer = item.classList.contains('menu-dropdown');

                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }

                    if (authorizedFeatures.has(feature)) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Feature authorized - showing menu item: ${feature}`);
                    } else {
                        console.log(`❌ Feature not authorized - hiding menu item: ${feature}`);
                    }
                });
                // Handle dropdown menus - show if they have visible children or are directly authorized
                document.querySelectorAll('li.menu-dropdown').forEach(drop => {
                    const feature = drop.getAttribute('data-feature');
                    const hasVisibleChildren = [...drop.querySelectorAll('.submenu li[data-feature]')].some(li => li.classList.contains('menu-visible'));
                    const isDirectlyAuthorized = authorizedFeatures.has(feature);
                    
                    if (hasVisibleChildren || isDirectlyAuthorized) {
                        drop.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${feature} (children: ${hasVisibleChildren}, authorized: ${isDirectlyAuthorized})`);
                    } else {
                        console.log(`❌ Hiding dropdown menu: ${feature} (no visible children and not authorized)`);
                    }
                });
                console.log(`🎯 Company feature authorization completed - ${visibleCount} items initially visible`);
                // Return authorized pages for role-based filtering
                return authorizedPages;
            } catch (e) {
                console.error('❌ Error applying feature-based menu visibility:', e);
                this.resetMenuVisibility();
                return [];
            }
        }

        // Apply role-based filtering within company authorized features
        async applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                console.log('👤 Applying role-based filtering for role:', userRole);

                // Get user role permissions from company
                const database = firebase.database();
                const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');

                if (!permissionsSnapshot.exists()) {
                    console.log(`⚠️ No permissions found for role ${userRole} in company ${companyId}`);

                    // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
                    if (userRole === 'administrator') {
                        console.log('🔑 ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                        this.showSidebarAfterAuth();
                        return;
                    }

                    // For other roles without permissions, hide all items with permission requirements
                    console.log('❌ No valid permissions found - filtering out items requiring permissions');
                    this.hideItemsRequiringPermissions();
                    this.showSidebarAfterAuth();
                    return;
                }

                const permissions = permissionsSnapshot.val();
                console.log('✅ Loaded role permissions:', permissions);

                // Apply permission-based filtering
                this.filterMenuByPermissions(permissions);

            } catch (error) {
                console.error('❌ Error applying role-based filtering:', error);
                // Don't hide everything on error - keep company features visible
                this.showSidebarAfterAuth();
            }
        }

        filterMenuByPermissions(permissions) {
            console.log('🔍 Filtering menu items by permissions...');
            let filteredCount = 0;

            document.querySelectorAll('[data-requires-permission]').forEach(item => {
                const requiredPermission = item.getAttribute('data-requires-permission');
                const feature = item.getAttribute('data-feature');

                if (!requiredPermission) {
                    console.log(`⚠️ Menu item ${feature} has no required permission`);
                    return;
                }

                const hasPermission = this.checkPermission(permissions, requiredPermission);

                if (hasPermission && item.classList.contains('menu-visible')) {
                    console.log(`✅ Permission granted - keeping menu item: ${feature} (${requiredPermission})`);
                } else if (item.classList.contains('menu-visible')) {
                    item.classList.remove('menu-visible');
                    filteredCount++;
                    console.log(`❌ Permission denied - hiding menu item: ${feature} (${requiredPermission})`);
                }
            });

            // Re-evaluate dropdown visibility after permission filtering
            document.querySelectorAll('li.menu-dropdown').forEach(drop => {
                const feature = drop.getAttribute('data-feature');
                const hasVisibleChildren = [...drop.querySelectorAll('.submenu li[data-feature]')].some(li => li.classList.contains('menu-visible'));
                const dropdownHasPermission = drop.hasAttribute('data-requires-permission') ? 
                    this.checkPermission(permissions, drop.getAttribute('data-requires-permission')) : true;

                // Keep dropdown visible if it has visible children OR if it's directly permitted
                if (hasVisibleChildren || (dropdownHasPermission && drop.classList.contains('menu-visible'))) {
                    if (!drop.classList.contains('menu-visible')) {
                        drop.classList.add('menu-visible');
                        console.log(`✅ Restoring dropdown menu: ${feature} (children: ${hasVisibleChildren}, permitted: ${dropdownHasPermission})`);
                    }
                } else if (drop.classList.contains('menu-visible')) {
                    drop.classList.remove('menu-visible');
                    console.log(`❌ Hiding dropdown menu: ${feature} (no visible children and no permission)`);
                }
            });

            console.log(`🎯 Role-based filtering completed - ${filteredCount} items filtered out`);
            this.showSidebarAfterAuth();
        }

        checkPermission(permissions, permissionKey) {
            if (!permissions || !permissionKey) return false;

            const permission = permissions[permissionKey];
            if (permission === true) return true;
            if (typeof permission === 'object' && permission !== null) {
                return permission.view === true || permission.access === 'view' || permission.read === true;
            }
            return false;
        }

        hideItemsRequiringPermissions() {
            document.querySelectorAll('[data-requires-permission]').forEach(item => {
                if (item.classList.contains('menu-visible')) {
                    item.classList.remove('menu-visible');
                    const feature = item.getAttribute('data-feature');
                    console.log(`❌ Hiding menu item requiring permission: ${feature}`);
                }
            });

            // Re-evaluate dropdown visibility
            document.querySelectorAll('li.menu-dropdown').forEach(drop => {
                const hasVisibleChildren = [...drop.querySelectorAll('.submenu li[data-feature]')].some(li => li.classList.contains('menu-visible'));
                if (!hasVisibleChildren && drop.classList.contains('menu-visible')) {
                    drop.classList.remove('menu-visible');
                    const feature = drop.getAttribute('data-feature');
                    console.log(`❌ Hiding dropdown menu: ${feature} (no visible children)`);
                }
            });
        }

        showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            sidebar?.classList.remove('menu-loading');
            console.log('🎯 Menu authorization complete - sidebar visible');
        }

        loadUserRole(user) {
            console.log('👤 Loading user role for:', user?.email);
            // Role should be in user object already
            if (user?.role) {
                console.log('✅ User role found:', user.role);
            } else {
                console.log('⚠️ No role found for user - defaulting to employee');
                user.role = 'employee';
            }
        }

        async loadUserCompany() {
            if (!this.currentUser?.companyId) {
                console.log('⚠️ No company ID found for user');
                return;
            }

            try {
                const database = firebase.database();
                const companySnapshot = await database.ref(`companies/${this.currentUser.companyId}`).once('value');
                if (companySnapshot.exists()) {
                    this.currentCompany = companySnapshot.val();
                    console.log('🏢 Company loaded:', this.currentCompany?.companyName);
                    this.updateCompanyBranding();
                }
            } catch (error) {
                console.error('❌ Error loading company:', error);
            }
        }

        updateCompanyBranding() {
            const companyLogo = document.getElementById('headerCompanyLogo');
            const logoPlaceholder = document.getElementById('headerLogoPlaceholder');
            const companyName = document.getElementById('headerCompanyName');

            if (this.currentCompany) {
                if (companyName) {
                    companyName.textContent = this.currentCompany.companyName || '';
                }
                
                const logoUrl = this.currentCompany.logoUrl || this.currentCompany.logo || '';
                if (companyLogo && logoPlaceholder) {
                    if (logoUrl) {
                        // Show company logo
                        companyLogo.src = logoUrl;
                        companyLogo.classList.add('visible');
                        companyLogo.style.display = 'block';
                        logoPlaceholder.style.display = 'none';
                        console.log('🏢 Company logo loaded:', logoUrl);
                        
                        // Handle logo load error
                        companyLogo.onerror = () => {
                            console.warn('🏢 Company logo failed to load, showing placeholder');
                            companyLogo.style.display = 'none';
                            companyLogo.classList.remove('visible');
                            logoPlaceholder.style.display = 'flex';
                        };
                    } else {
                        // Show placeholder
                        companyLogo.style.display = 'none';
                        companyLogo.classList.remove('visible');
                        logoPlaceholder.style.display = 'flex';
                        console.log('🏢 Using logo placeholder for company:', this.currentCompany.companyName);
                    }
                }
                
                // Update page title with company name
                if (this.currentCompany.companyName) {
                    document.title = document.title.replace('Dreamex Datalab HSE', `${this.currentCompany.companyName} HSE`);
                }
            } else {
                // No company data
                if (companyName) companyName.textContent = '';
                if (companyLogo) {
                    companyLogo.style.display = 'none';
                    companyLogo.classList.remove('visible');
                }
                if (logoPlaceholder) {
                    logoPlaceholder.style.display = 'flex';
                }
            }
        }

        updateUIForAuthenticatedUser() {
            console.log('🔄 updateUIForAuthenticatedUser called');
            this.updateUserAvatar();
            this.populateProfileDropdown();
        }

        updateUserAvatar() {
            console.log('👤 updateUserAvatar called');
            const avatarImg = document.querySelector('#userProfileBtn img');

            if (!avatarImg) {
                console.error('❌ Avatar image element not found');
                return;
            }

            const user = this.currentUser;
            if (!user) {
                console.log('⚠️ No current user for avatar update');
                return;
            }

            console.log('👤 Updating avatar for user:', user.email);

            // Try to use profile picture first
            if (user.photoURL || user.profilePicture) {
                const photoUrl = user.photoURL || user.profilePicture;
                console.log('🖼️ Using profile picture:', photoUrl);
                avatarImg.src = photoUrl;

                avatarImg.onerror = () => {
                    console.log('❌ Profile picture failed to load, using initials');
                    this.generateInitialsAvatar(user, avatarImg);
                };
            } else {
                console.log('📝 Using initials for avatar');
                this.generateInitialsAvatar(user, avatarImg);
            }
        }

        generateInitialsAvatar(user, imgElement) {
            const name = user.displayName || user.firstName || user.name || user.email || 'User';
            const parts = name.split(' ').filter(p => p.length > 0);
            let initials = 'U';

            if (parts.length >= 2) {
                initials = (parts[0][0] + parts[1][0]).toUpperCase();
            } else if (parts.length === 1) {
                initials = parts[0][0].toUpperCase();
            }

            // Create SVG avatar with initials
            const svg = `data:image/svg+xml;base64,${btoa(`
                <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="#3498db"/>
                    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" 
                          font-family="Arial, sans-serif" font-size="16" font-weight="600" fill="white">
                        ${initials}
                    </text>
                </svg>
            `)}`;

            imgElement.src = svg;
            console.log('📝 Generated initials avatar:', initials);
        }

        populateProfileDropdown() {
            console.log('📋 populateProfileDropdown called');
            const dropdown = document.querySelector('.profile-dropdown ul');
            if (!dropdown) {
                console.error('❌ Profile dropdown not found');
                return;
            }

            dropdown.innerHTML = `
                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                <li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            `;

            // Bind logout
            const logoutLink = dropdown.querySelector('#logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });
            }
        }
    }

    /**************** DMS Manager ****************/
    const DMS = {
        currentUser: null,
        db: null,
        docs: [],
        lastOpenedDocId: null,
        init() {
            initializeFirebase();
            this.db = firebase.database();
            this.currentUser = this.getStoredUser();
            this.wireHeader();
            this.bindFilters();
            this.loadDocuments();
            this.initTabs();
        },
        getStoredUser() {
            try { 
                return JSON.parse(localStorage.getItem('currentUser') || 'null'); 
            } catch { 
                return null; 
            }
        },
        wireHeader() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            if (sidebarToggle && sidebar && mainContent) {
                const topNav = document.querySelector('.top-nav');
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                    if (topNav) {
                        if (sidebar.classList.contains('collapsed')) {
                            topNav.style.left = '0.5rem';
                        } else {
                            topNav.style.left = 'calc(var(--sidebar-width) + 0.5rem)';
                        }
                    }
                });
            }
        },
        bindFilters() {
            document.getElementById('searchInput').addEventListener('input', () => this.renderTable());
            document.getElementById('statusFilter').addEventListener('change', () => this.renderTable());
            document.getElementById('typeFilter').addEventListener('change', () => this.renderTable());
            document.getElementById('categoryFilter').addEventListener('change', () => this.renderTable());
            document.getElementById('riskFilter').addEventListener('change', () => this.renderTable());
        },
        async hasDocumentAccess(doc, user) {
            // User has access if they created the document or are an approver
            if (!doc || !user) return false;
            
            // Check if user created the document
            if (doc.createdBy === user.uid || doc.updatedBy === user.uid) {
                return true;
            }
            
            // Check if user is an approver in the approval flow
            if (!user.companyId) return false;
            
            try {
                const flowSnap = await this.db.ref(`companies/${user.companyId}/approvalFlows/document`).once('value');
                const flow = flowSnap.val();
                
                if (!flow || !Array.isArray(flow.levels)) return false;
                
                // Get user candidates for matching
                const normalize = v => (v || '').toString().trim().toLowerCase();
                const userCandidates = [
                    user.jobTitleKey, user.jobTitle, user.title, user.roleKey, user.role,
                    user.function, user.position
                ].map(normalize);
                const identityCandidates = [
                    user.uid, user.id, user.userId, user.email, user.displayName,
                    user.name, user.fullName
                ].map(normalize);
                
                // Check if user is an approver at any level
                for (const level of flow.levels) {
                    const sr = (flow.selectedRoles || {})[`level${level.level}`] || [];
                    const srValues = sr.map(r => normalize(r.value));
                    const srTexts = sr.map(r => normalize(r.text));
                    
                    if (level.approverType === 'function') {
                        if (userCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)))) {
                            return true;
                        }
                    } else if (level.approverType === 'name') {
                        if (identityCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)))) {
                            return true;
                        }
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error checking document access:', error);
                return false;
            }
        },
        async loadDocuments() {
            // Load documents from Firebase if available; otherwise use sample data
            if (this.currentUser?.companyId) {
                try {
                    const snap = await this.db.ref(`companies/${this.currentUser.companyId}/dms/documents`).once('value');
                    if (snap.exists()) {
                        const data = snap.val();
                        const allDocs = Object.keys(data).map(id => ({ id, ...data[id] }));
                        
                        // Filter documents by user access (created by user or user is approver)
                        const accessibleDocs = [];
                        for (const doc of allDocs) {
                            if (await this.hasDocumentAccess(doc, this.currentUser)) {
                                accessibleDocs.push(doc);
                            }
                        }
                        
                        this.docs = accessibleDocs.sort((a, b) => (b.updated || 0) - (a.updated || 0));
                    } else {
                        this.docs = [];
                    }
                } catch { 
                    this.docs = []; 
                }
            } else {
                this.docs = [];
            }
            this.renderTable();
        },
        renderTable() {
            const q = (document.getElementById('searchInput').value || '').toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const risk = document.getElementById('riskFilter').value;
            const tbody = document.querySelector('#documentsTable tbody');
            tbody.innerHTML = '';
            const filtered = this.docs.filter(d => {
                const hit = d.title.toLowerCase().includes(q) ||
                    (d.category || '').toLowerCase().includes(q) ||
                    (d.documentNumber || '').toLowerCase().includes(q) ||
                    (d.owner || '').toLowerCase().includes(q);
                const sOk = !status || d.status === status;
                const tOk = !type || d.type === type;
                const cOk = !category || d.category === category;
                const rOk = !risk || d.riskLevel === risk;
                return hit && sOk && tOk && cOk && rOk;
            });
                        filtered.forEach(d => {
                                const owner = d.owner || d.updatedBy || '—';
                                const version = d.version || String((d.versions?.length || 0) + 1 || '1.0');
                                const docNumber = d.documentNumber ? ` (${d.documentNumber})` : '';
                                const categoryBadge = d.category ? `<span class="category-badge ${d.category}">${this.prettyCategory(d.category)}</span>` : '';
                                const reviewDate = d.expiryDate ? ` - Due: ${d.expiryDate}` : '';

                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                        <td><span class="doc-title">${d.title}</span><span class="muted">${docNumber}</span> <span class="version-info">v${version}</span></td>
                        <td>${DMS.prettyType(d.type)}</td>
                        <td>${categoryBadge}</td>
                        <td>${owner}</td>
                        <td>${DMS.prettyReviewCycle(d.reviewCycle)}<span class="muted">${reviewDate}</span></td>
                        <td>${DMS.statusPill(d.status)}</td>
                        `;
                                tr.style.cursor = 'pointer';
                                tr.addEventListener('click', (e) => {
                                    DMS.showDocModal(d);
                                });
                                tbody.appendChild(tr);
                        });

        },
                showDocModal(doc) {
                        // Track the currently opened document for edit button refresh
                        this.lastOpenedDocId = doc.id;
                        
                        const modal = document.getElementById('docDetailsModal');
                        const body = document.getElementById('docDetailsBody');
                        if (!modal || !body) return;

                        const esc = (s) => String(s == null ? '' : s)
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
                        const br = (s) => esc(s).replace(/\n/g, '<br>');

                        const hasArr = (a) => Array.isArray(a) && a.length > 0;

                        // Build complex sections
                        const definitionsHtml = hasArr(doc.definitions)
                            ? `<div class='modal-details-row'><span class='modal-details-label'>Definitions:</span>
                                     <div class='modal-details-value'>${doc.definitions.map(d => `<div><strong>${esc(d.term||'')}</strong>${(d.term&&d.text)?' — ':''}${esc(d.text||'')}</div>`).join('')}</div>
                                 </div>`
                            : '';

                        const rolesHtml = hasArr(doc.roles)
                            ? `<div class='modal-details-row'><span class='modal-details-label'>Roles & Responsibilities:</span>
                                     <div class='modal-details-value'>${doc.roles.map(r => `<div><strong>${esc(r.role||'')}</strong>${(r.role&&r.responsibility)?' — ':''}${esc(r.responsibility||'')}</div>`).join('')}</div>
                                 </div>`
                            : '';

                        const procedures = Array.isArray(doc.steps) ? doc.steps : [];
                        let proceduresHtml = '';
                        if (procedures.length) {
                                // New structure: [{ title, steps: [{name, description}] }]
                                if (procedures[0] && typeof procedures[0] === 'object' && ('title' in procedures[0] || 'steps' in procedures[0])) {
                                        proceduresHtml = `
                                        <div class='modal-details-row'>
                                            <span class='modal-details-label'>Operating procedure:</span>
                                            <div class='modal-details-value'>
                                                ${procedures.map(p => `
                                                    <div style="margin-bottom:.5rem;">
                                                        ${p.title ? `<div style='font-weight:600; margin:.2rem 0;'>${esc(p.title)}</div>` : ''}
                                                        ${Array.isArray(p.steps) && p.steps.length ? `
                                                            <ol style='padding-left:1.25rem; margin:.2rem 0;'>
                                                                ${p.steps.map(s => `
                                                                    <li style='margin:.2rem 0;'>
                                                                        ${esc(s.name||'Step')}
                                                                        ${s.description ? `<div style='color:#374151; margin-left:.25rem;'>${br(s.description)}</div>` : ''}
                                                                    </li>
                                                                `).join('')}
                                                            </ol>
                                                        ` : `<em class='muted'>No steps</em>`}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>`;
                                } else {
                                        // Legacy structure: array of strings or simple items
                                        proceduresHtml = `<div class='modal-details-row'><span class='modal-details-label'>Operating procedure:</span>
                                            <div class='modal-details-value'>${procedures.map((s,i)=>`<div>${i+1}. ${esc(s && s.name ? s.name : s)}</div>`).join('')}</div></div>`;
                                }
                        }

                                    const tagsStr = Array.isArray(doc.tags) ? doc.tags.join(', ') : (doc.tags || '');
                    const deriveStatusText = (s) => ({ draft: 'Draft', in_review: 'In Review', approved: 'Approved', declined: 'Declined' }[s] || (s || '—'));
                    const summaryRows = [
                { label: 'Title', value: doc.title },
                { label: 'Document Number', value: doc.documentNumber },
                { label: 'Type', value: this.prettyType(doc.type) },
                { label: 'Category', value: this.prettyCategory(doc.category) },
                { label: 'Classification', value: doc.classification },
                // Status row always present - will be updated by approval status listener
                { label: 'Status', value: deriveStatusText(doc.status || 'draft') },
                    { label: 'Version', value: doc.version || String((doc.versions?.length || 0) + 1 || '1.0') },
                    { label: 'Tags', value: tagsStr }
            ].filter(r => r.label === 'Status' || r.value);

                                    const peopleRows = [
                            { label: 'Initiator', value: doc.owner || doc.updatedBy },
                            { label: 'Approver', value: doc.approver },
                            { label: 'Effective Date', value: doc.effectiveDate },
                                        { label: 'Next Review Date', value: doc.expiryDate },
                                        { label: 'Review Cycle', value: this.prettyReviewCycle(doc.reviewCycle) }
                        ].filter(r => r.value);

                        const longTextRows = [
                            { label: 'Purpose', value: doc.purpose },
                            { label: 'Scope', value: doc.scope },
                            { label: 'Risk Assessment', value: doc.riskLevel },
                            { label: 'Training Requirements', value: doc.training },
                            { label: 'Compliance References', value: doc.compliance },
                            { label: 'Distribution List', value: doc.distribution },
                            { label: 'Legacy Responsibilities', value: doc.responsibilities },
                            { label: 'References', value: doc.references },
                            { label: 'Revision History', value: doc.revisionHistory }
                        ].filter(r => r.value);

                        const lastUpdated = doc.updated ? `<div class='modal-details-row'><span class='modal-details-label'>Last Updated:</span> <span class='modal-details-value'>${new Date(doc.updated).toLocaleString()}</span></div>` : '';

                        body.innerHTML = `
                            <div style="overflow-x:auto; min-width:500px; max-width:900px;" data-doc-id="${esc(doc.id)}">
                                ${summaryRows.map(f => {
                                    if (f.label === 'Status') {
                                        return `<div class='modal-details-row'><span class='modal-details-label'>Status:</span> <span class='modal-details-value' id='docStatusValue'>${esc(f.value)}</span></div>`;
                                    }
                                    return `<div class='modal-details-row'><span class='modal-details-label'>${f.label}:</span> <span class='modal-details-value'>${esc(f.value)}</span></div>`;
                                }).join('')}
                                ${peopleRows.map(f => `<div class='modal-details-row'><span class='modal-details-label'>${f.label}:</span> <span class='modal-details-value'>${esc(f.value)}</span></div>`).join('')}
                                ${definitionsHtml}
                                ${rolesHtml}
                                ${longTextRows.map(f => `<div class='modal-details-row'><span class='modal-details-label'>${f.label}:</span> <span class='modal-details-value'>${br(f.value)}</span></div>`).join('')}
                                ${proceduresHtml}
                                ${lastUpdated}
                                <div class='modal-details-row'><span class='modal-details-label'>Approval Flow:</span> <div class='modal-details-value' id='approvalFlowContainer'><em>Loading…</em></div></div>
                                <div class='modal-details-row'><span class='modal-details-label'>Approval History:</span> <div class='modal-details-value' id='approvalHistoryContainer'><em>No history</em></div></div>
                            </div>`;

                        // Load approval flow and wire actions
                        try {
                            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                            const companyId = (user && (user.companyId || user.companyID || user.company_id)) || null;
                            if (companyId && doc && doc.id && window.firebase && firebase.database) {
                                const db = firebase.database();
                                const flowRef = db.ref(`companies/${companyId}/approvalFlows/document`);
                                const statusRef = db.ref(`companies/${companyId}/dms/documents/${doc.id}/approvalStatus`);
                                const historyRef = db.ref(`companies/${companyId}/dms/documents/${doc.id}/approvalHistory`);
                                
                                // Also check the document itself for status
                                const docRef = db.ref(`companies/${companyId}/dms/documents/${doc.id}/status`);
                                
                                Promise.all([flowRef.once('value'), statusRef.once('value'), historyRef.once('value'), docRef.once('value')]).then(([flowSnap, statusSnap, historySnap, docStatusSnap]) => {
                                    const flow = flowSnap.val();
                                    const status = statusSnap.val() || { currentLevel: 1, state: 'pending' };
                                    const docStatus = docStatusSnap.val();
                                    const cont = document.getElementById('approvalFlowContainer');
                                    if (cont) {
                                        if (flow && Array.isArray(flow.levels) && flow.levels.length) {
                                            cont.innerHTML = flow.levels.map(l => {
                                                const sr = (flow.selectedRoles || {})[`level${l.level}`] || [];
                                                const names = sr.map(r => r.text || r.value).join(', ');
                                                return `<div style="display:flex;justify-content:space-between;padding:.2rem 0;">
                                                            <div><span style='display:inline-block;background:#e5e7eb;color:#374151;border-radius:4px;padding:0 .35rem;margin-right:.35rem;'>L${l.level}</span> ${l.approverType}</div>
                                                            <div>${names || '-'}</div>
                                                        </div>`;
                                            }).join('');
                                        } else {
                                            cont.innerHTML = '<em>No approval flow configured.</em>';
                                        }
                                    }

                                    const actions = document.getElementById('approvalActions');
                                    const normalize = v => (v || '').toString().trim().toLowerCase();
                                    const userObj = (window.DMS && DMS.currentUser) ? DMS.currentUser : user || {};
                                    const userCandidates = [
                                        userObj.jobTitleKey, userObj.jobTitle, userObj.title, userObj.roleKey, userObj.role,
                                        userObj.function, userObj.position
                                    ].map(normalize);
                                    const identityCandidates = [
                                        userObj.uid, userObj.id, userObj.userId, userObj.email, userObj.displayName,
                                        userObj.name, userObj.fullName
                                    ].map(normalize);

                                    let canApprove = false;
                                    if (flow && Array.isArray(flow.levels)) {
                                        const currentLevel = status.currentLevel || 1;
                                        const lvlCfg = flow.levels.find(l => (l.level || 0) === currentLevel);
                                        const sr = (flow.selectedRoles || {})[`level${currentLevel}`] || [];
                                        const srValues = sr.map(r => normalize(r.value));
                                        const srTexts = sr.map(r => normalize(r.text));
                                        if (lvlCfg && status.state === 'pending') {
                                            if (lvlCfg.approverType === 'function') {
                                                canApprove = userCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)));
                                            } else if (lvlCfg.approverType === 'name') {
                                                canApprove = identityCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)));
                                            } else {
                                                canApprove = false; // TODO: support 'level' approverType when org hierarchy is available
                                            }
                                        }
                                    }

                                    if (actions) actions.style.display = canApprove ? 'flex' : 'none';
                                    // Update visible Status value - prioritize approval status, then document status
                                    const statusEl = document.getElementById('docStatusValue');
                                    if (statusEl) {
                                        let sText = '';
                                        // Priority: approval status > document status > fallback
                                        if (status.state === 'approved' || docStatus === 'approved') {
                                            sText = 'Approved';
                                        } else if (status.state === 'declined') {
                                            sText = 'Declined';
                                        } else if (status.state === 'pending') {
                                            sText = 'In Review';
                                        } else {
                                            sText = deriveStatusText(docStatus || doc.status || 'draft');
                                        }
                                        statusEl.textContent = sText;
                                    }
                                    
                                    // Edit button visibility logic: check for approved change requests
                                    const editBtnEl = document.getElementById('modalEditBtn');
                                    if (editBtnEl) {
                                        // Hide edit button by default if document is approved
                                        if (status.state === 'approved' || docStatus === 'approved' || doc.status === 'approved') {
                                            editBtnEl.style.display = 'none';
                                            
                                            // Check for approved change requests that allow editing
                                            this.checkApprovedChangeRequests(doc.id, editBtnEl, userObj);
                                        } else {
                                            // For non-approved documents, show edit button normally
                                            editBtnEl.style.display = 'inline-block';
                                        }
                                    }

                                    // Render approval history
                                    const histCont = document.getElementById('approvalHistoryContainer');
                                    if (histCont) {
                                        const histVal = historySnap.val();
                                        if (histVal && typeof histVal === 'object') {
                                            const items = Object.values(histVal).sort((a,b) => new Date(a.at||0) - new Date(b.at||0));
                                            if (items.length) {
                                                histCont.innerHTML = items.map(h => {
                                                    const when = h.at ? new Date(h.at).toLocaleString() : '';
                                                    const who = (h.by && (h.by.name || h.by.email)) || 'Unknown';
                                                    const lvl = h.level != null ? `L${h.level}` : '';
                                                    const act = (h.action||'').toUpperCase();
                                                    return `<div style='display:flex;justify-content:space-between;padding:.2rem 0;border-bottom:1px dashed #e5e7eb;'>
                                                                <div><span style='margin-right:.35rem;color:#6b7280;'>${when}</span> <strong>${act}</strong> ${lvl ? `at ${lvl}` : ''}</div>
                                                                <div style='color:#374151;'>${who}</div>
                                                            </div>`;
                                                }).join('');
                                            } else {
                                                histCont.innerHTML = '<em>No history</em>';
                                            }
                                        } else {
                                            histCont.innerHTML = '<em>No history</em>';
                                        }
                                    }

                                    const approveBtn = document.getElementById('modalApproveBtn');
                                    const declineBtn = document.getElementById('modalDeclineBtn');
                                    const deleteBtn = document.getElementById('modalDeleteBtn');

                                    if (approveBtn) approveBtn.onclick = () => {
                                        const total = (flow && flow.levels && flow.levels.length) || 1;
                                        const currLevel = status.currentLevel || 1;
                                        let nextLevel = currLevel + 1;
                                        const newState = nextLevel > total ? 'approved' : 'pending';
                                        if (newState === 'approved') nextLevel = total;
                                        const nowIso = new Date().toISOString();
                                        statusRef.update({ currentLevel: nextLevel, state: newState, updatedAt: nowIso })
                                            .then(() => historyRef.push({ level: currLevel, action: 'approved', by: { uid: userObj.uid || userObj.id || '', name: userObj.displayName || userObj.name || userObj.fullName || '', email: userObj.email || '' }, at: nowIso }))
                                            .then(() => {
                                                if (newState === 'approved') {
                                                    db.ref(`companies/${companyId}/dms/documents/${doc.id}`).update({ status: 'approved' })
                                                        .then(() => {
                                                            // On final approval, mark any approved change requests for this document as complete
                                                            const crListRef = db.ref(`companies/${companyId}/changeRequests`);
                                                            return crListRef.orderByChild('documentId').equalTo(doc.id).once('value').then(s => {
                                                                if (!s.exists()) return null;
                                                                const changes = s.val() || {};
                                                                const ops = [];
                                                                const completedAtIso = new Date().toISOString();
                                                                Object.entries(changes).forEach(([crId, cr]) => {
                                                                    if (cr && cr.status === 'approved') {
                                                                        const reqRef = db.ref(`companies/${companyId}/changeRequests/${crId}`);
                                                                        const histRef = db.ref(`companies/${companyId}/changeRequests/${crId}/approvalHistory`);
                                                                        ops.push(
                                                                            reqRef.update({ 
                                                                                status: 'complete', 
                                                                                completedAt: completedAtIso, 
                                                                                completedBy: { uid: userObj.uid || userObj.id || '', name: userObj.displayName || userObj.name || userObj.fullName || '', email: userObj.email || '' },
                                                                                updatedAt: completedAtIso
                                                                            }).then(() => histRef.push({ 
                                                                                level: (cr.currentLevel || null), 
                                                                                action: 'completed', 
                                                                                by: { uid: userObj.uid || userObj.id || '', name: userObj.displayName || userObj.name || userObj.fullName || '', email: userObj.email || '' }, 
                                                                                at: completedAtIso 
                                                                            }))
                                                                        );
                                                                    }
                                                                });
                                                                return Promise.all(ops).then(() => {
                                                                    // Refresh change requests list UI if tab exists
                                                                    if (window.DMS && typeof DMS.loadChangeRequests === 'function') {
                                                                        DMS.loadChangeRequests();
                                                                    }
                                                                });
                                                            }).finally(() => {
                                                                if (window.DMS && typeof DMS.load === 'function') { DMS.load(); }
                                                            });
                                                        });
                                                }
                                                if (actions) actions.style.display = 'none';
                                                const editEl = document.getElementById('modalEditBtn');
                                                if (editEl) editEl.style.display = 'none';
                                                const statusEl2 = document.getElementById('docStatusValue');
                                                if (statusEl2) statusEl2.textContent = 'Approved';
                                                // Append to history UI
                                                const hist = document.getElementById('approvalHistoryContainer');
                                                if (hist) {
                                                    const when = new Date(nowIso).toLocaleString();
                                                    const who = userObj.displayName || userObj.name || userObj.fullName || userObj.email || 'Unknown';
                                                    const row = `<div style='display:flex;justify-content:space-between;padding:.2rem 0;border-bottom:1px dashed #e5e7eb;'>
                                                                    <div><span style='margin-right:.35rem;color:#6b7280;'>${when}</span> <strong>APPROVED</strong> at L${currLevel}</div>
                                                                    <div style='color:#374151;'>${who}</div>
                                                                </div>`;
                                                    if (hist.innerHTML.includes('No history')) hist.innerHTML = row; else hist.innerHTML += row;
                                                }
                                                alert('Approval recorded.');
                                            })
                                            .catch(err => console.error('Approve error', err));
                                    };

                                    if (declineBtn) declineBtn.onclick = () => {
                                        const currLevel = status.currentLevel || 1;
                                        const nowIso = new Date().toISOString();
                                        statusRef.update({ state: 'declined', updatedAt: nowIso })
                                            .then(() => historyRef.push({ level: currLevel, action: 'declined', by: { uid: userObj.uid || userObj.id || '', name: userObj.displayName || userObj.name || userObj.fullName || '', email: userObj.email || '' }, at: nowIso }))
                                            .then(() => {
                                                if (actions) actions.style.display = 'none';
                                                const statusEl3 = document.getElementById('docStatusValue');
                                                if (statusEl3) statusEl3.textContent = 'Declined';
                                                const hist = document.getElementById('approvalHistoryContainer');
                                                if (hist) {
                                                    const when = new Date(nowIso).toLocaleString();
                                                    const who = userObj.displayName || userObj.name || userObj.fullName || userObj.email || 'Unknown';
                                                    const row = `<div style='display:flex;justify-content:space-between;padding:.2rem 0;border-bottom:1px dashed #e5e7eb;'>
                                                                    <div><span style='margin-right:.35rem;color:#6b7280;'>${when}</span> <strong>DECLINED</strong> at L${currLevel}</div>
                                                                    <div style='color:#374151;'>${who}</div>
                                                                </div>`;
                                                    if (hist.innerHTML.includes('No history')) hist.innerHTML = row; else hist.innerHTML += row;
                                                }
                                                alert('Document declined.');
                                            })
                                            .catch(err => console.error('Decline error', err));
                                    };

                                    if (deleteBtn) deleteBtn.onclick = () => {
                                        if (!confirm('Are you sure you want to delete this document?')) return;
                                        db.ref(`companies/${companyId}/dms/documents/${doc.id}`).remove()
                                            .then(() => {
                                                const m = document.getElementById('docDetailsModal');
                                                if (m) { m.classList.remove('show'); }
                                                document.body.style.overflow = '';
                                                alert('Document deleted.');
                                                if (window.DMS && typeof DMS.load === 'function') { DMS.load(); }
                                            })
                                            .catch(err => console.error('Delete error', err));
                                    };
                                }).catch(err => console.error('Load flow/status error', err));
                            }
                        } catch (e) { console.error('Approval flow init error', e); }

                        // Wire up modal action buttons
                        setTimeout(() => {
                                const editBtn = document.getElementById('modalEditBtn');
                                const exportBtn = document.getElementById('modalExportBtn');
                                if (editBtn) editBtn.onclick = () => {
                                        window.location.href = `dmsedit.html?doc=${encodeURIComponent(doc.id)}&mode=edit`;
                                };
                                if (exportBtn) exportBtn.onclick = () => {
                                        if (doc && doc.id) {
                                            const url = `dmsedit.html?doc=${encodeURIComponent(doc.id)}&mode=view&autopdf=1`;
                                            const iframe = document.createElement('iframe');
                                            iframe.style.display = 'none';
                                            iframe.src = url;
                                            document.body.appendChild(iframe);
                                            // Clean up iframe after some time
                                            setTimeout(() => { try { iframe.remove(); } catch(e){} }, 45000);
                                        } else {
                                            alert('Document not found.');
                                        }
                                };
                        }, 0);
                        modal.classList.add('show');
                        document.body.style.overflow = 'hidden';
                },
        prettyType(t) {
            return ({ policy: 'Policy', procedure: 'Procedure', work_instruction: 'Work Instruction', form: 'Form' }[t] || t);
        },
        prettyCategory(c) {
            return ({ hse: 'HSE', quality: 'Quality Mgmt', operations: 'Operations', maintenance: 'Maintenance', training: 'Training', emergency: 'Emergency', regulatory: 'Regulatory', hr: 'HR' }[c] || c);
        },
        prettyReviewCycle(r) {
            return ({ annual: 'Annual', biannual: 'Bi-annual', quarterly: 'Quarterly', monthly: 'Monthly', adhoc: 'Ad-hoc' }[r] || r || '—');
        },
        statusPill(s) {
            const map = { draft: 'status-draft', in_review: 'status-inreview', approved: 'status-approved' };
            const cls = map[s] || '';
            const label = { draft: 'Draft', in_review: 'In Review', approved: 'Approved' }[s] || s;
            return `<span class="status-pill ${cls}"><i class="fas fa-circle"></i> ${label}</span>`;
        },
        riskPill(r) {
            const map = { low: 'risk-low', medium: 'risk-medium', high: 'risk-high', critical: 'risk-critical' };
            const cls = map[r] || '';
            const label = { low: 'Low', medium: 'Medium', high: 'High', critical: 'Critical' }[r] || (r || '—');
            return `<span class="risk-pill ${cls}"><i class="fas fa-exclamation-triangle"></i> ${label}</span>`;
        },
        viewDoc(id) { window.location.href = `dmsedit.html?doc=${encodeURIComponent(id)}&mode=view`; },
    editDoc(id) { window.location.href = `dmsedit.html?doc=${encodeURIComponent(id)}&mode=edit`; },
                exportDoc(id) {
            // Find the document by id
            const doc = this.docs.find(d => d.id === id);
            if (!doc) { alert('Document not found.'); return; }
                        // Create PDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
                        const pageW = pdf.internal.pageSize.getWidth();
                        const pageH = pdf.internal.pageSize.getHeight();
                        const margin = 40;
                        const labelColX = margin;
                        const valueColX = margin + 120;
                        const usableWidth = pageW - valueColX - margin;
                        const lineHeight = 14;
                        let y = margin;

                        const ensurePage = (lines = 1, extra = 0) => {
                            const needed = lines * lineHeight + extra;
                            if (y + needed > pageH - margin) { pdf.addPage(); y = margin; }
                        };

                        // Header: Company name (if available) + Report title
                        const headerCompanyName = (document.getElementById('headerCompanyName')?.textContent || '').trim();
                        if (headerCompanyName) {
                            pdf.setFont('helvetica', 'bold');
                            pdf.setFontSize(14);
                            pdf.text(headerCompanyName, margin, y);
                            y += 18;
                        }
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(18);
                        pdf.text('Document Details', margin, y);
                        y += 26;
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'normal');

                        const line = (label, value) => {
                            if (!value) return;
                            const valueStr = String(value);
                            const textLines = pdf.splitTextToSize(valueStr, usableWidth);
                            ensurePage(textLines.length);
                            pdf.setFont('helvetica', 'bold');
                            pdf.text(String(label)+':', labelColX, y);
                            pdf.setFont('helvetica', 'normal');
                            pdf.text(textLines, valueColX, y);
                            y += lineHeight * textLines.length;
                        };

                        // Summary
                        line('Title', doc.title);
                        line('Document Number', doc.documentNumber);
                        line('Type', this.prettyType(doc.type));
                        line('Category', this.prettyCategory(doc.category));
                        line('Classification', doc.classification);
                        line('Tags', Array.isArray(doc.tags) ? doc.tags.join(', ') : doc.tags);
                        line('Status', doc.status);
                        line('Version', doc.version || String((doc.versions?.length || 0) + 1 || '1.0'));

                        // People & Dates
                        line('Initiator', doc.owner || doc.updatedBy);
                        line('Approver', doc.approver);
                        line('Effective Date', doc.effectiveDate);
                        line('Next Review Date', doc.expiryDate);
                        line('Review Cycle', this.prettyReviewCycle(doc.reviewCycle));

                        // Long text
                        line('Purpose', doc.purpose);
                        line('Scope', doc.scope);
                        line('Risk Assessment', doc.riskLevel);
                        line('Training Requirements', doc.training);
                        line('Compliance References', doc.compliance);
                        line('Distribution List', doc.distribution);
                        line('Legacy Responsibilities', doc.responsibilities);
                        line('References', doc.references);
                        line('Revision History', doc.revisionHistory);

                        // Definitions
                                    if (Array.isArray(doc.definitions) && doc.definitions.length) {
                                        pdf.setFont('helvetica', 'bold'); pdf.text('Definitions:', margin, y); y += 18; pdf.setFont('helvetica', 'normal');
                                        const indentX = margin + 20; const wrapW = pageW - indentX - margin;
                                        doc.definitions.forEach(d => {
                                            const term = d && d.term ? `${d.term}${(d.term && d.text)?' — ':''}` : '';
                                            const val = `${term}${d && d.text ? d.text : ''}`;
                                            const textLines = pdf.splitTextToSize(val, wrapW);
                                            ensurePage(textLines.length);
                                            pdf.text(textLines, indentX, y);
                                            y += lineHeight * textLines.length;
                                        });
                                        y += 6;
                                    }

                        // Roles & Responsibilities
                                    if (Array.isArray(doc.roles) && doc.roles.length) {
                                        pdf.setFont('helvetica', 'bold'); pdf.text('Roles & Responsibilities:', margin, y); y += 18; pdf.setFont('helvetica', 'normal');
                                        const indentX = margin + 20; const wrapW = pageW - indentX - margin;
                                        doc.roles.forEach(r => {
                                            const role = r && r.role ? `${r.role}${(r.role && r.responsibility)?' — ':''}` : '';
                                            const val = `${role}${r && r.responsibility ? r.responsibility : ''}`;
                                            const textLines = pdf.splitTextToSize(val, wrapW);
                                            ensurePage(textLines.length);
                                            pdf.text(textLines, indentX, y);
                                            y += lineHeight * textLines.length;
                                        });
                                        y += 6;
                                    }

                        // Operating procedure
                                    const procedures = Array.isArray(doc.steps) ? doc.steps : [];
                                    if (procedures.length) {
                                        pdf.setFont('helvetica', 'bold'); pdf.text('Operating procedure:', margin, y); y += 18; pdf.setFont('helvetica', 'normal');
                            const isNew = procedures[0] && typeof procedures[0] === 'object' && ('title' in procedures[0] || 'steps' in procedures[0]);
                            if (isNew) {
                                procedures.forEach((p) => {
                                                const pTitleX = margin + 20; const stepHeadX = margin + 30; const stepDescX = margin + 40;
                                                const pWrap = pageW - pTitleX - margin; const sWrap = pageW - stepDescX - margin;
                                                if (p.title) {
                                                    const pTitleLines = pdf.splitTextToSize(String(p.title), pWrap);
                                                    ensurePage(pTitleLines.length);
                                                    pdf.setFont('helvetica', 'bold');
                                                    pdf.text(pTitleLines, pTitleX, y);
                                                    y += lineHeight * pTitleLines.length;
                                                    pdf.setFont('helvetica', 'normal');
                                                }
                                                (Array.isArray(p.steps)?p.steps:[]).forEach((s, i) => {
                                                    const head = `${(i+1).toString()}. ${s && s.name ? s.name : 'Step'}`;
                                                    const headLines = pdf.splitTextToSize(head, pageW - stepHeadX - margin);
                                                    ensurePage(headLines.length);
                                                    pdf.text(headLines, stepHeadX, y); y += lineHeight * headLines.length;
                                                    if (s && s.description) {
                                                        const descLines = pdf.splitTextToSize(String(s.description), sWrap);
                                                        ensurePage(descLines.length);
                                                        pdf.text(descLines, stepDescX, y); y += lineHeight * descLines.length;
                                                    }
                                                    y += 6;
                                                });
                                    y += 6;
                                });
                            } else {
                                procedures.forEach((s, i) => {
                                                const lineTxt = `${(i+1).toString()}. ${s && s.name ? s.name : (typeof s==='string'?s:'Step')}`;
                                                const indentX = margin + 20; const wrapW = pageW - indentX - margin;
                                                const textLines = pdf.splitTextToSize(lineTxt, wrapW);
                                                ensurePage(textLines.length);
                                                pdf.text(textLines, indentX, y); y += lineHeight * textLines.length;
                                });
                            }
                        }

                        // Last Updated
                                    if (doc.updated) { line('Last Updated', new Date(doc.updated).toLocaleString()); }
            // Save PDF
            const fileName = (doc.title ? doc.title.replace(/[^a-z0-9]/gi, '_') : 'document') + '.pdf';
            pdf.save(fileName);
        },
        // Tab Management
        initTabs() {
            // Wire tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
            });
            
            // Load change requests when tab is activated
            this.loadChangeRequests();
        },
        switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            
            // Update tab content - handle the naming mismatch
            document.querySelectorAll('.tab-content').forEach(content => {
                let targetId;
                if (tabName === 'change-requests') {
                    targetId = 'changeRequestsTab';
                } else if (tabName === 'documents') {
                    targetId = 'documentsTab';
                } else {
                    targetId = tabName + 'Tab';
                }
                content.classList.toggle('active', content.id === targetId);
            });
            
            // Update add button title
            updateAddButtonTitle();
            
            if (tabName === 'change-requests') {
                this.loadChangeRequests();
            }
        },
        async hasChangeRequestAccess(cr, user) {
            // User has access if they created the change request or are an approver
            if (!cr || !user) return false;
            
            // Check if user created the change request
            if (cr.requestedBy?.uid === user.uid || cr.requestedBy?.id === user.uid) {
                return true;
            }
            
            // Check if user is an approver in the change request approval flow (same as document flow)
            if (!user.companyId) return false;
            
            try {
                const flowSnap = await this.db.ref(`companies/${user.companyId}/approvalFlows/document`).once('value');
                const flow = flowSnap.val();
                
                if (!flow || !Array.isArray(flow.levels)) return false;
                
                // Get user candidates for matching
                const normalize = v => (v || '').toString().trim().toLowerCase();
                const userCandidates = [
                    user.jobTitleKey, user.jobTitle, user.title, user.roleKey, user.role,
                    user.function, user.position
                ].map(normalize);
                const identityCandidates = [
                    user.uid, user.id, user.userId, user.email, user.displayName,
                    user.name, user.fullName
                ].map(normalize);
                
                // Check if user is an approver at any level
                for (const level of flow.levels) {
                    const sr = (flow.selectedRoles || {})[`level${level.level}`] || [];
                    const srValues = sr.map(r => normalize(r.value));
                    const srTexts = sr.map(r => normalize(r.text));
                    
                    if (level.approverType === 'function') {
                        if (userCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)))) {
                            return true;
                        }
                    } else if (level.approverType === 'name') {
                        if (identityCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)))) {
                            return true;
                        }
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Error checking change request access:', error);
                return false;
            }
        },
        async loadChangeRequests() {
            if (!this.currentUser?.companyId) return;
            
            try {
                const snap = await this.db.ref(`companies/${this.currentUser.companyId}/changeRequests`).once('value');
                let requests = [];
                
                if (snap.exists()) {
                    const data = snap.val();
                    const allRequests = Object.keys(data).map(id => ({ id, ...data[id] }));
                    
                    // Filter change requests by user access (created by user or user is approver)
                    const accessibleRequests = [];
                    for (const request of allRequests) {
                        if (await this.hasChangeRequestAccess(request, this.currentUser)) {
                            accessibleRequests.push(request);
                        }
                    }
                    
                    requests = accessibleRequests.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));
                }
                
                this.renderChangeRequestsTable(requests);
            } catch (error) {
                console.error('Error loading change requests:', error);
                this.renderChangeRequestsTable([]);
            }
        },
        renderChangeRequestsTable(requests) {
            const tbody = document.querySelector('#changeRequestsTable tbody');
            tbody.innerHTML = '';
            
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:2rem;color:#6c757d;">No change requests found</td></tr>';
                return;
            }
            
            requests.forEach(req => {
                const statusClass = {
                    pending: 'status-inreview',
                    approved: 'status-approved',
                    declined: 'risk-critical',
                    complete: 'status-approved'
                }[req.status] || 'status-draft';
                
                const tr = document.createElement('tr');
                tr.addEventListener('click', () => DMS.viewChangeRequest(req.id));
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600;color:#007bff;">${req.id}</div>
                    </td>
                    <td>
                        <div style="font-weight:600;">${req.documentTitle || 'Unknown Document'}</div>
                        <div style="font-size:0.85rem;color:#6c757d;">${req.documentNumber || req.documentId}</div>
                    </td>
                    <td style="max-width:200px;word-wrap:break-word;">${req.reason}</td>
                    <td><span class="status-pill ${statusClass}">${(req.status === 'complete' ? 'Complete' : req.status.charAt(0).toUpperCase() + req.status.slice(1))}</span></td>
                    <td>${new Date(req.requestedAt).toLocaleDateString()}</td>
                `;
                tbody.appendChild(tr);
            });
        },
        viewChangeRequest(id) {
            // Load and display change request details
            if (!this.currentUser?.companyId) return;
            
            this.db.ref(`companies/${this.currentUser.companyId}/changeRequests/${id}`).once('value').then(snap => {
                if (!snap.exists()) {
                    alert('Change request not found.');
                    return;
                }
                
                const request = snap.val();
                this.showChangeRequestModal(request, id);
            }).catch(error => {
                console.error('Error loading change request:', error);
                alert('Error loading change request.');
            });
        },
        async showChangeRequestModal(request, requestId) {
            const modal = document.getElementById('changeRequestModal');
            const body = document.getElementById('changeRequestBody');
            
            // Build change request details
            const statusClass = {
                pending: 'status-inreview',
                approved: 'status-approved',
                declined: 'risk-critical',
                complete: 'status-approved'
            }[request.status] || 'status-draft';
            
            const priorityClass = {
                low: 'status-draft',
                medium: 'status-inreview', 
                high: 'status-approved',
                urgent: 'risk-critical'
            }[request.priority] || 'status-draft';
            
            body.innerHTML = `
                <div style="overflow-x:auto; min-width:500px; max-width:900px;">
                    <div class='modal-details-row'><span class='modal-details-label'>Document:</span> <span class='modal-details-value'>${request.documentTitle || 'Unknown'}</span></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Document Number:</span> <span class='modal-details-value'>${request.documentNumber || request.documentId}</span></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Requested By:</span> <span class='modal-details-value'>${request.requestedBy?.name || 'Unknown'}</span></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Priority:</span> <span class='modal-details-value'><span class="status-pill ${priorityClass}">${request.priority.charAt(0).toUpperCase() + request.priority.slice(1)}</span></span></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Status:</span> <span class='modal-details-value'><span class="status-pill ${statusClass}" id="crStatusValue">${(request.status === 'complete' ? 'Complete' : request.status.charAt(0).toUpperCase() + request.status.slice(1))}</span></span></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Requested Date:</span> <span class='modal-details-value'>${new Date(request.requestedAt).toLocaleString()}</span></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Reason for Change:</span> <span class='modal-details-value'>${request.reason}</span></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Detailed Description:</span> <span class='modal-details-value'>${request.description}</span></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Approval Flow:</span> <div class='modal-details-value' id='crApprovalFlowContainer'><em>Loading…</em></div></div>
                    <div class='modal-details-row'><span class='modal-details-label'>Approval History:</span> <div class='modal-details-value' id='crApprovalHistoryContainer'><em>No history</em></div></div>
                </div>
            `;
            
            // Load approval flow and handle approval logic
            await this.loadChangeRequestApprovalFlow(requestId, request);
            
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        },
        async loadChangeRequestApprovalFlow(requestId, request) {
            const user = this.currentUser;
            const companyId = user?.companyId;
            if (!companyId) return;
            
            try {
                const db = firebase.database();
                // Use the same approval flow as documents
                const flowRef = db.ref(`companies/${companyId}/approvalFlows/document`);
                const statusRef = db.ref(`companies/${companyId}/changeRequests/${requestId}`);
                const historyRef = db.ref(`companies/${companyId}/changeRequests/${requestId}/approvalHistory`);
                
                Promise.all([flowRef.once('value'), statusRef.once('value'), historyRef.once('value')]).then(([flowSnap, statusSnap, historySnap]) => {
                    const flow = flowSnap.val();
                    const currentRequest = statusSnap.val();
                    const status = { currentLevel: currentRequest.currentLevel || 1, state: currentRequest.status || 'pending' };
                    
                    const cont = document.getElementById('crApprovalFlowContainer');
                    if (cont) {
                        if (flow && Array.isArray(flow.levels) && flow.levels.length) {
                            cont.innerHTML = flow.levels.map(l => {
                                const sr = (flow.selectedRoles || {})[`level${l.level}`] || [];
                                const names = sr.map(r => r.text || r.value).join(', ');
                                return `<div style="display:flex;justify-content:space-between;padding:.2rem 0;">
                                            <div><span style='display:inline-block;background:#e5e7eb;color:#374151;border-radius:4px;padding:0 .35rem;margin-right:.35rem;'>L${l.level}</span> ${l.approverType}</div>
                                            <div>${names || '-'}</div>
                                        </div>`;
                            }).join('');
                        } else {
                            cont.innerHTML = '<em>No approval flow configured.</em>';
                        }
                    }
                    
                    // Check if current user can approve
                    const actions = document.getElementById('changeRequestActions');
                    const normalize = v => (v || '').toString().trim().toLowerCase();
                    const userObj = (window.DMS && DMS.currentUser) ? DMS.currentUser : user || {};
                    const userCandidates = [
                        userObj.jobTitleKey, userObj.jobTitle, userObj.title, userObj.roleKey, userObj.role,
                        userObj.function, userObj.position
                    ].map(normalize);
                    const identityCandidates = [
                        userObj.uid, userObj.id, userObj.userId, userObj.email, userObj.displayName,
                        userObj.name, userObj.fullName
                    ].map(normalize);
                    
                    let canApprove = false;
                    if (flow && Array.isArray(flow.levels)) {
                        const currentLevel = status.currentLevel || 1;
                        const lvlCfg = flow.levels.find(l => (l.level || 0) === currentLevel);
                        const sr = (flow.selectedRoles || {})[`level${currentLevel}`] || [];
                        const srValues = sr.map(r => normalize(r.value));
                        const srTexts = sr.map(r => normalize(r.text));
                        if (lvlCfg && status.state === 'pending') {
                            if (lvlCfg.approverType === 'function') {
                                canApprove = userCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)));
                            } else if (lvlCfg.approverType === 'name') {
                                canApprove = identityCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)));
                            } else {
                                canApprove = false; // TODO: support 'level' approverType when org hierarchy is available
                            }
                        }
                    }
                    
                    if (actions) actions.style.display = (currentRequest.status === 'complete') ? 'none' : (canApprove ? 'flex' : 'none');
                    
                    // Wire approval buttons
                    const approveBtn = document.getElementById('crApproveBtn');
                    const declineBtn = document.getElementById('crDeclineBtn');
                    
                    if (approveBtn) approveBtn.onclick = () => this.approveChangeRequest(requestId, flow, status, userObj);
                    if (declineBtn) declineBtn.onclick = () => this.declineChangeRequest(requestId, status, userObj);
                    
                    // Render approval history
                    const histCont = document.getElementById('crApprovalHistoryContainer');
                    if (histCont) {
                        const histVal = historySnap.val();
                        if (histVal && typeof histVal === 'object') {
                            const entries = Object.values(histVal).sort((a, b) => new Date(a.at) - new Date(b.at));
                            histCont.innerHTML = entries.map(entry => {
                                const when = new Date(entry.at).toLocaleString();
                                const who = entry.by?.name || entry.by?.email || 'Unknown';
                                const action = entry.action.toUpperCase();
                                return `<div style='display:flex;justify-content:space-between;padding:.2rem 0;border-bottom:1px dashed #e5e7eb;'>
                                            <div><span style='margin-right:.35rem;color:#6b7280;'>${when}</span> <strong>${action}</strong> at L${entry.level}</div>
                                            <div style='color:#374151;'>${who}</div>
                                        </div>`;
                            }).join('');
                        } else {
                            histCont.innerHTML = '<em>No history</em>';
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading change request approval flow:', error);
            }
        },
        async approveChangeRequest(requestId, flow, status, userObj) {
            const total = (flow && flow.levels && flow.levels.length) || 1;
            const currLevel = status.currentLevel || 1;
            let nextLevel = currLevel + 1;
            const newState = nextLevel > total ? 'approved' : 'pending';
            if (newState === 'approved') nextLevel = total;
            const nowIso = new Date().toISOString();
            
            try {
                const db = firebase.database();
                const requestRef = db.ref(`companies/${this.currentUser.companyId}/changeRequests/${requestId}`);
                const historyRef = db.ref(`companies/${this.currentUser.companyId}/changeRequests/${requestId}/approvalHistory`);
                
                await requestRef.update({ 
                    currentLevel: nextLevel, 
                    status: newState, 
                    updatedAt: nowIso 
                });
                
                await historyRef.push({ 
                    level: currLevel, 
                    action: 'approved', 
                    by: { 
                        uid: userObj.uid || userObj.id || '', 
                        name: userObj.displayName || userObj.name || userObj.fullName || '', 
                        email: userObj.email || '' 
                    }, 
                    at: nowIso 
                });
                
                // Hide actions and update status
                const actions = document.getElementById('changeRequestActions');
                if (actions) actions.style.display = 'none';
                
                const statusEl = document.getElementById('crStatusValue');
                if (statusEl && newState === 'approved') {
                    statusEl.textContent = 'Approved';
                    statusEl.className = 'status-pill status-approved';
                }
                
                // Append to history UI
                const hist = document.getElementById('crApprovalHistoryContainer');
                if (hist) {
                    const when = new Date(nowIso).toLocaleString();
                    const who = userObj.displayName || userObj.name || userObj.fullName || userObj.email || 'Unknown';
                    const row = `<div style='display:flex;justify-content:space-between;padding:.2rem 0;border-bottom:1px dashed #e5e7eb;'>
                                    <div><span style='margin-right:.35rem;color:#6b7280;'>${when}</span> <strong>APPROVED</strong> at L${currLevel}</div>
                                    <div style='color:#374151;'>${who}</div>
                                </div>`;
                    if (hist.innerHTML.includes('No history')) hist.innerHTML = row; else hist.innerHTML += row;
                }
                
                alert('Change request approved.');
                this.loadChangeRequests(); // Refresh the table
                
                // Refresh any open document modal to update edit button visibility
                this.refreshDocumentModalEditButton();
            } catch (error) {
                console.error('Error approving change request:', error);
                alert('Error approving change request.');
            }
        },
        async declineChangeRequest(requestId, status, userObj) {
            const currLevel = status.currentLevel || 1;
            const nowIso = new Date().toISOString();
            
            try {
                const db = firebase.database();
                const requestRef = db.ref(`companies/${this.currentUser.companyId}/changeRequests/${requestId}`);
                const historyRef = db.ref(`companies/${this.currentUser.companyId}/changeRequests/${requestId}/approvalHistory`);
                
                await requestRef.update({ 
                    status: 'declined', 
                    updatedAt: nowIso 
                });
                
                await historyRef.push({ 
                    level: currLevel, 
                    action: 'declined', 
                    by: { 
                        uid: userObj.uid || userObj.id || '', 
                        name: userObj.displayName || userObj.name || userObj.fullName || '', 
                        email: userObj.email || '' 
                    }, 
                    at: nowIso 
                });
                
                // Hide actions and update status
                const actions = document.getElementById('changeRequestActions');
                if (actions) actions.style.display = 'none';
                
                const statusEl = document.getElementById('crStatusValue');
                if (statusEl) {
                    statusEl.textContent = 'Declined';
                    statusEl.className = 'status-pill risk-critical';
                }
                
                // Append to history UI
                const hist = document.getElementById('crApprovalHistoryContainer');
                if (hist) {
                    const when = new Date(nowIso).toLocaleString();
                    const who = userObj.displayName || userObj.name || userObj.fullName || userObj.email || 'Unknown';
                    const row = `<div style='display:flex;justify-content:space-between;padding:.2rem 0;border-bottom:1px dashed #e5e7eb;'>
                                    <div><span style='margin-right:.35rem;color:#6b7280;'>${when}</span> <strong>DECLINED</strong> at L${currLevel}</div>
                                    <div style='color:#374151;'>${who}</div>
                                </div>`;
                    if (hist.innerHTML.includes('No history')) hist.innerHTML = row; else hist.innerHTML += row;
                }
                
                alert('Change request declined.');
                this.loadChangeRequests(); // Refresh the table
            } catch (error) {
                console.error('Error declining change request:', error);
                alert('Error declining change request.');
            }
        },
        refreshDocumentModalEditButton() {
            // Check if document modal is open and refresh edit button visibility
            const docModal = document.getElementById('docDetailsModal');
            const editBtn = document.getElementById('modalEditBtn');
            
            if (docModal && docModal.classList.contains('show') && editBtn) {
                // Get the current document ID from the modal
                const docIdElement = document.querySelector('#docDetailsModal [data-doc-id]');
                let documentId = null;
                
                if (docIdElement) {
                    documentId = docIdElement.getAttribute('data-doc-id');
                } else {
                    // Try to find document ID from the modal content or last opened document
                    // This is a fallback if we can't find the data attribute
                    const titleElement = document.querySelector('#docDetailsModal .modal-details-value');
                    if (titleElement && this.lastOpenedDocId) {
                        documentId = this.lastOpenedDocId;
                    }
                }
                
                if (documentId) {
                    console.log('🔄 Refreshing edit button for document:', documentId);
                    const currentUser = (window.DMS && DMS.currentUser) ? DMS.currentUser : this.currentUser;
                    this.checkApprovedChangeRequests(documentId, editBtn, currentUser);
                } else {
                    console.warn('⚠️ Could not determine document ID for edit button refresh');
                }
            }
        },
        async checkApprovedChangeRequests(documentId, editButtonElement, currentUser) {
            if (!this.currentUser?.companyId) return;
            
            try {
                const db = firebase.database();
                const changeRequestsRef = db.ref(`companies/${this.currentUser.companyId}/changeRequests`);
                const snapshot = await changeRequestsRef.orderByChild('documentId').equalTo(documentId).once('value');
                
                if (!snapshot.exists()) return;
                
                const requests = snapshot.val();
                let hasApprovedRequest = false;
                let userCanEdit = false;
                
                // Get the approval flow to check if user is an approver
                const flowRef = db.ref(`companies/${this.currentUser.companyId}/approvalFlows/document`);
                const flowSnapshot = await flowRef.once('value');
                const flow = flowSnapshot.val();
                
                // Check if there are any approved change requests for this document
                Object.values(requests).forEach(request => {
                    if (request.status === 'approved') {
                        hasApprovedRequest = true;
                        
                        // Check if current user is the initiator
                        const requesterId = request.requestedBy?.uid || request.requestedBy?.id || request.requestedBy;
                        const currentUserId = currentUser?.uid || currentUser?.id || currentUser?.email || '';
                        
                        if (requesterId && currentUserId && (requesterId === currentUserId || requesterId === currentUser?.email)) {
                            userCanEdit = true;
                        }
                        
                        // Check if current user is an approver in the change request flow
                        if (!userCanEdit && flow && Array.isArray(flow.levels)) {
                            const normalize = v => (v || '').toString().trim().toLowerCase();
                            const userObj = currentUser || {};
                            const userCandidates = [
                                userObj.jobTitleKey, userObj.jobTitle, userObj.title, userObj.roleKey, userObj.role,
                                userObj.function, userObj.position
                            ].map(normalize);
                            const identityCandidates = [
                                userObj.uid, userObj.id, userObj.userId, userObj.email, userObj.displayName,
                                userObj.name, userObj.fullName
                            ].map(normalize);
                            
                            // Check all approval levels to see if user is an approver
                            flow.levels.forEach(level => {
                                const sr = (flow.selectedRoles || {})[`level${level.level}`] || [];
                                const srValues = sr.map(r => normalize(r.value));
                                const srTexts = sr.map(r => normalize(r.text));
                                
                                if (level.approverType === 'function') {
                                    if (userCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)))) {
                                        userCanEdit = true;
                                    }
                                } else if (level.approverType === 'name') {
                                    if (identityCandidates.some(c => c && (srValues.includes(c) || srTexts.includes(c)))) {
                                        userCanEdit = true;
                                    }
                                }
                            });
                        }
                    }
                });
                
                // Show edit button if there's an approved change request and user has permission
                if (hasApprovedRequest && userCanEdit) {
                    editButtonElement.style.display = 'inline-block';
                    // Add visual indicator that editing is allowed due to approved change request
                    editButtonElement.title = 'Edit (Change Request Approved)';
                    console.log('✅ Edit button shown for approved change request');
                } else if (hasApprovedRequest) {
                    console.log('⚠️ Approved change request found but user cannot edit');
                } else {
                    console.log('ℹ️ No approved change requests found for document');
                }
            } catch (error) {
                console.error('Error checking approved change requests:', error);
            }
        }
    }
    // End of DMS object

    // Make DMS available globally
    window.DMS = DMS;

    // Context-aware add button handler
    function handleAddAction() {
        // Check which tab content is currently active
        const activeTabContent = document.querySelector('.tab-content.active');
        console.log('Active tab content:', activeTabContent ? activeTabContent.id : 'none');
        
        if (activeTabContent && activeTabContent.id === 'changeRequestsTab') {
            console.log('Opening change request modal');
            showCreateChangeRequestModal();
        } else {
            console.log('Opening document editor');
            DMS.editDoc('');
        }
    }

    // Update button title based on active tab
    function updateAddButtonTitle() {
        const addBtn = document.querySelector('.btn-add-new');
        const activeTabContent = document.querySelector('.tab-content.active');
        
        if (addBtn) {
            if (activeTabContent && activeTabContent.id === 'changeRequestsTab') {
                addBtn.title = 'Create Change Request';
            } else {
                addBtn.title = 'Add New Document';
            }
        }
    }

    // Show create change request modal
    function showCreateChangeRequestModal() {
        // Load documents for selection
        loadDocumentsForChangeRequest();
        
        // Show modal
        document.getElementById('createChangeRequestModal').style.display = 'block';
    }

    // Load documents for change request selection
    async function loadDocumentsForChangeRequest() {
        try {
            console.log('🔍 Loading documents for change request...');
            
            // Check if DMS is available and has current user data
            if (!window.DMS || !DMS.currentUser || !DMS.currentUser.companyId) {
                console.warn('❌ DMS or user data not available');
                Swal.fire('Error', 'User authentication not available. Please refresh the page.', 'error');
                return;
            }

            console.log('👤 Company ID:', DMS.currentUser.companyId);

            // Use DMS database reference
            const docRef = DMS.db.ref(`companies/${DMS.currentUser.companyId}/dms/documents`);
            const crRef = DMS.db.ref(`companies/${DMS.currentUser.companyId}/changeRequests`);
            console.log('📡 Firebase path:', `companies/${DMS.currentUser.companyId}/dms/documents`);
            
            const [docSnap, crSnap] = await Promise.all([docRef.once('value'), crRef.once('value')]);
            const documents = docSnap.val() || {};
            const changeRequests = crSnap.val() || {};
            // Build a set of documentIds that have a pending CR
            const docsWithPendingCR = new Set();
            Object.values(changeRequests).forEach(cr => {
                if (cr && cr.documentId && (cr.status === 'pending')) {
                    docsWithPendingCR.add(cr.documentId);
                }
            });

            console.log('📄 Raw documents data:', documents);
            console.log('📊 Number of documents found:', Object.keys(documents).length);

            const select = document.getElementById('modalRequestDocumentSelect');
            if (!select) {
                console.error('❌ Select element not found');
                return;
            }
            
            select.innerHTML = '<option value="">Choose a document...</option>';

            let addedCount = 0;
            let hiddenDueToPending = 0;
            let hiddenDueToAccess = 0;
            
            for (const docId of Object.keys(documents)) {
                const doc = documents[docId];
                console.log(`📝 Processing document ${docId}:`, doc);
                
                // Only show approved documents that have a title and are enabled
                if (doc.title && doc.enabled !== false && doc.status === 'approved') {
                    // Check if user has access to this document
                    if (!(await DMS.hasDocumentAccess(doc, DMS.currentUser))) {
                        hiddenDueToAccess++;
                        console.log(`🔒 Skipping ${docId} - user doesn't have access`);
                        continue;
                    }
                    
                    // Skip if there's already a pending change request for this document
                    if (docsWithPendingCR.has(docId)) {
                        hiddenDueToPending++;
                        console.log(`⛔ Skipping ${docId} - pending change request exists`);
                        continue;
                    }
                    const option = document.createElement('option');
                    option.value = docId;
                    // Display both title and document number if available
                    const displayText = doc.documentNumber 
                        ? `${doc.title} (${doc.documentNumber})` 
                        : doc.title;
                    option.textContent = displayText;
                    select.appendChild(option);
                    addedCount++;
                    console.log(`✅ Added approved document: ${displayText}`);
                } else {
                    console.log(`⚠️ Skipped document ${docId}: title=${doc.title}, enabled=${doc.enabled}, status=${doc.status}`);
                }
            }

            console.log(`✅ Successfully loaded ${addedCount} approved documents for change request selection`);
            
            if (addedCount === 0) {
                select.innerHTML = '<option value="">No approved documents available</option>';
            }

            // Show info message if some docs were hidden due to existing pending change requests or access
            let infoEl = document.getElementById('crDocFilterInfo');
            if (!infoEl) {
                const selectGroup = document.getElementById('modalRequestDocumentSelect').closest('.form-group');
                infoEl = document.createElement('div');
                infoEl.id = 'crDocFilterInfo';
                infoEl.style.cssText = 'margin-top:6px;font-size:0.85rem;color:#6b7280;';
                selectGroup.appendChild(infoEl);
            }
            
            const totalHidden = hiddenDueToPending + hiddenDueToAccess;
            if (totalHidden > 0) {
                let message = '';
                if (hiddenDueToPending > 0 && hiddenDueToAccess > 0) {
                    message = `${totalHidden} document(s) hidden: ${hiddenDueToPending} with pending change requests, ${hiddenDueToAccess} without access.`;
                } else if (hiddenDueToPending > 0) {
                    message = `${hiddenDueToPending} document(s) hidden because a change request is already pending.`;
                } else if (hiddenDueToAccess > 0) {
                    message = `${hiddenDueToAccess} document(s) hidden due to access restrictions.`;
                }
                infoEl.textContent = message;
                infoEl.style.display = 'block';
            } else {
                infoEl.textContent = '';
                infoEl.style.display = 'none';
            }
            
        } catch (error) {
            console.error('❌ Error loading documents:', error);
            Swal.fire('Error', 'Failed to load documents: ' + error.message, 'error');
        }
    }

    // Submit change request from modal
    async function submitChangeRequestFromModal() {
        const documentId = document.getElementById('modalRequestDocumentSelect').value;
        const reason = document.getElementById('modalChangeReason').value.trim();
        const description = document.getElementById('modalChangeDescription').value.trim();
        const priority = document.getElementById('modalChangePriority').value;

        if (!documentId) {
            Swal.fire('Error', 'Please select a document', 'error');
            return;
        }

        if (!reason) {
            Swal.fire('Error', 'Please provide a reason for the change', 'error');
            return;
        }

        if (!description) {
            Swal.fire('Error', 'Please provide a detailed description of the changes', 'error');
            return;
        }

        try {
            // Validate auth & context
            if (!window.DMS || !DMS.currentUser || !DMS.currentUser.companyId) {
                Swal.fire('Error', 'User authentication not available. Please refresh the page.', 'error');
                return;
            }

            const currentUser = DMS.currentUser;
            const companyId = DMS.currentUser.companyId;

            // Guard: prevent duplicate CR if pending exists for this doc
            const existingCRSnap = await DMS.db.ref(`companies/${companyId}/changeRequests`).orderByChild('documentId').equalTo(documentId).once('value');
            if (existingCRSnap.exists()) {
                const existing = Object.values(existingCRSnap.val() || {}).find(cr => cr && cr.status === 'pending');
                if (existing) {
                    Swal.fire('Not allowed', 'There is already a pending change request for this document. Please complete or decline it first.', 'warning');
                    return;
                }
            }

            // Get document details from the DMS documents path
            const docRef = DMS.db.ref(`companies/${companyId}/dms/documents/${documentId}`);
            const docSnapshot = await docRef.once('value');
            const docData = docSnapshot.val() || {};

            // Create change request
            const changeRequestId = Date.now().toString();
            const changeRequest = {
                id: changeRequestId,
                documentId: documentId,
                documentTitle: docData.title || 'Unknown Document',
                documentNumber: docData.documentNumber || '',
                reason: reason,
                description: description,
                priority: priority,
                requestedBy: currentUser.email,
                requestedByName: currentUser.name || currentUser.email,
                requestedAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                status: 'pending',
                currentLevel: 1
            };

            await DMS.db.ref(`companies/${companyId}/changeRequests/${changeRequestId}`).set(changeRequest);

            // Close modal and reset form
            document.getElementById('createChangeRequestModal').style.display = 'none';
            resetChangeRequestModal();

            Swal.fire('Success', 'Change request submitted successfully', 'success');
            
            // Refresh change requests if on that tab using DMS method
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'changeRequestsTab' && DMS.loadChangeRequests) {
                DMS.loadChangeRequests();
            }

        } catch (error) {
            console.error('Error submitting change request:', error);
            Swal.fire('Error', 'Failed to submit change request', 'error');
        }
    }

    // Reset change request modal form
    function resetChangeRequestModal() {
        document.getElementById('modalRequestDocumentSelect').value = '';
        document.getElementById('modalChangeReason').value = '';
        document.getElementById('modalChangeDescription').value = '';
        document.getElementById('modalChangePriority').value = 'medium';
    }

// Modal close logic (must be outside DMS object)
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('docDetailsModal');
    const closeBtn = document.getElementById('closeDocModal');
    if (closeBtn && modal) {
        closeBtn.addEventListener('click', () => {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        });
    }
    
    // Change request modal close logic
    const crModal = document.getElementById('changeRequestModal');
    const crCloseBtn = document.getElementById('closeChangeRequestModal');
    if (crCloseBtn && crModal) {
        crCloseBtn.addEventListener('click', () => {
            crModal.classList.remove('show');
            document.body.style.overflow = '';
            crModal.style.display = 'none';
        });
    }

    // Create change request modal close logic
    const createCrModal = document.getElementById('createChangeRequestModal');
    const createCrCloseBtn = document.getElementById('closeCreateChangeRequestModal');
    if (createCrCloseBtn && createCrModal) {
        createCrCloseBtn.addEventListener('click', () => {
            createCrModal.style.display = 'none';
            resetChangeRequestModal();
        });
    }

    // Submit change request button
    const submitCrBtn = document.getElementById('modalSubmitChangeRequestBtn');
    if (submitCrBtn) {
        submitCrBtn.addEventListener('click', submitChangeRequestFromModal);
    }

    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target === createCrModal) {
            createCrModal.style.display = 'none';
            resetChangeRequestModal();
        }
        if (event.target === crModal) {
            crModal.style.display = 'none';
        }
    });
    
    // Optional: close modals on outside click
    window.addEventListener('click', (e) => {
        if (modal && modal.classList.contains('show') && e.target === modal) {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
        if (crModal && crModal.classList.contains('show') && e.target === crModal) {
            crModal.classList.remove('show');
            document.body.style.overflow = '';
        }
    });
});


    // Initialize when DOM is ready
    window.addEventListener('DOMContentLoaded', () => {
        console.log('🚀 DMS Table initializing...');
        
        // Initialize Firebase first
        initializeFirebase();
        
        // Initialize managers
        window.notificationManager.init();
        window.authManager = new AuthManager();
        
        // Initialize DMS functionality
        DMS.init();
        
        // Initialize tabs
        initTabs();
        
        // Update add button title initially
        updateAddButtonTitle();
        
        console.log('✅ DMS Table initialization complete');
    });
  </script>
</body>
</html>
