<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Register - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        :root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --orange:#e67e22; --red:#e74c3c; --purple:#9b59b6; --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333; --text-secondary:#666; --border-color:#e0e0e0; --spacing-unit:.9rem; --padding-sm:.45rem; --padding-md:.75rem; --padding-lg:1.2rem; --transition-speed:.2s; }
        *{margin:0;padding:0;box-sizing:border-box;} body{font-family:var(--font-family);font-size:var(--base-font-size);line-height:1.4;color:var(--text-primary);background:#f8f9fa;}
        .app-container{display:flex;min-height:100vh;}
        .sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;height:100vh;overflow-y:auto;transition:transform .3s ease;}
        .sidebar.collapsed{transform:translateX(-100%);} .logo h2{text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.05rem;}
        .menu{list-style:none;margin-top:2rem;}
        .menu li{margin-bottom:.45rem;}
        .menu a{display:flex;align-items:center;gap:10px;color:#fff;text-decoration:none;padding:.6rem .75rem;border-radius:6px;font-size:.82rem;font-weight:500;transition:background .25s;}
        .menu a:hover,.menu a.active{background:rgba(255,255,255,.12);} 
        .submenu{list-style:none;margin-left:.75rem;display:none;margin-top:.25rem;}
        .menu-dropdown:hover .submenu{display:block;}
        .submenu a{font-size:.75rem;padding:.45rem .65rem;}
        /* Feature-based visibility */
        [data-feature]:not(.menu-visible){display:none !important;}
        .menu-dropdown:not(.menu-visible){display:none !important;}
        /* Hide ALL menu items by default during loading - only for sidebar menu */
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature]{display:none !important;}
        /* Allow menu-visible items to show even during loading */
        .sidebar.menu-loading .menu-visible,
        .sidebar.menu-loading li.menu-visible,
        .sidebar.menu-loading [data-feature].menu-visible{display:block !important;}
        .menu-loading [data-feature]{display:none !important;}
        .menu-loading .menu-dropdown{display:none !important;}
        .menu-visible{display:block !important;}
        li.menu-visible,[data-feature].menu-visible{display:block !important;}

        .main-content{flex:1;margin-left:var(--sidebar-width);padding:.45rem;width:calc(100% - var(--sidebar-width));box-sizing:border-box;display:flex;flex-direction:column;transition:margin-left .3s ease,width .3s ease;}
        .main-content.sidebar-collapsed{margin-left:0;width:100%;}

        /* Top Nav */
        .top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:.35rem;position:fixed;top:.25rem;right:.5rem;left:calc(var(--sidebar-width) + .5rem);height:50px;min-height:50px;z-index:100;transition:left .3s ease;}
        .top-nav-left{display:flex;align-items:center;gap:1rem;font-size:.8rem;font-weight:600;color:var(--text-secondary);} .sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;padding:.45rem;color:#666;border-radius:6px;display:flex;align-items:center;justify-content:center;} .sidebar-toggle-btn:hover{background:rgba(0,0,0,.06);}
    /* Header branding (aligned with project-list.html) */
    .company-branding{display:flex;align-items:center;gap:.5rem}
    #headerCompanyLogo{width:32px;height:32px;object-fit:contain;display:none;border-radius:6px}
    #headerCompanyLogo.visible{display:block}
    #headerCompanyName{font-size:.8rem;font-weight:600;letter-spacing:.5px;color:var(--primary-color);max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .top-nav-right{display:flex;align-items:center;gap:1.2rem;margin-left:auto;}
        .profile-btn{background:none;border:none;cursor:pointer;padding:.25rem;display:flex;align-items:center;position:relative;} 
        .avatar-initials{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1rem;}
    .profile-dropdown{display:none;position:absolute;right:0;top:110%;background:#fff;border-radius:8px;min-width:200px;box-shadow:0 6px 18px rgba(0,0,0,0.12);overflow:hidden;z-index:1000}
    .profile-dropdown.show{display:block}
    .profile-dropdown ul{list-style:none;margin:0;padding:0}
    .profile-dropdown li a{display:block;padding:.65rem .85rem;font-size:.72rem;text-decoration:none;color:#1e293b;font-weight:500}
    .profile-dropdown li a:hover{background:#f1f5f9}

        /* Content */
        .content{padding:1rem;background:#fff;border-radius:8px;margin:60px 0 0 0;min-height:calc(100vh - 80px);}        
        .page-header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;padding:.55rem .75rem;border-radius:0;margin:.35rem 0 .5rem 0;display:flex;align-items:center;justify-content:space-between;box-shadow:0 10px 28px rgba(0,0,0,0.18),0 6px 16px rgba(0,0,0,0.14);font-size:.9rem;}
        .page-header h1{color:#fff;display:flex;align-items:center;gap:.6rem;font-size:.9rem;margin:0;font-weight:600;}
        .page-actions{display:flex;align-items:center;gap:.5rem;}
        .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .9rem;border:none;border-radius:6px;font-size:.82rem;font-weight:500;cursor:pointer;transition:all .2s;text-decoration:none;justify-content:center;}
        .btn-primary{background:#2196F3;color:#fff;} .btn-primary:hover{background:#1976D2;}
        .btn-secondary{background:#6c757d;color:#fff;} .btn-secondary:hover{background:#5a6268;}
        .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.5);color:#fff;}

    .filters{display:flex;flex-wrap:wrap;gap:.5rem;align-items:flex-end;margin:.5rem 0 .25rem 0}
    .filters .field{display:flex;flex-direction:column;gap:.25rem}
    .filters .field label{font-size:.68rem;color:#475569;font-weight:600}
    .filters .field input,.filters .field select{padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:6px;font-size:.8rem;background:#fff;min-width:180px}
    /* Custom dropdown (same look as select) */
    .custom-select{position:relative;min-width:180px}
    .custom-select-trigger{padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:6px;font-size:.8rem;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:.5rem}
    .custom-select-trigger:after{content:'\25BC'; /* ▼ */ font-size:.65rem;color:#475569}
    .custom-select.open .custom-select-trigger{border-color:#94a3b8;box-shadow:0 0 0 3px rgba(148,163,184,.2)}
    .custom-select-panel{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 25px rgba(0,0,0,.12);z-index:1000;max-height:240px;overflow:auto;display:none}
    .custom-select.open .custom-select-panel{display:block}
    .custom-option{display:flex;align-items:center;gap:.5rem;padding:.45rem .5rem;cursor:pointer;font-size:.82rem}
    .custom-option:hover{background:#f8fafc}
    .custom-option .box{width:16px;display:inline-block;text-align:center;color:#111}
    .filters .chip-group{display:flex;gap:.35rem;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .55rem;border-radius:999px;border:1px solid #cbd5e1;background:#fff;font-size:.75rem;color:#334155;cursor:pointer}
    .chip input{margin-right:.2rem}

    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem;margin-top:.5rem}
        .card{background:#fff;border:1px solid #eee;border-radius:8px;padding:1rem;box-shadow:0 1px 2px rgba(0,0,0,.06);}        
        .card h3{font-size:.82rem;color:#555;margin-bottom:.45rem;}
        .stat{font-size:1.35rem;font-weight:700;color:#2c3e50;}
        .muted{color:#6b7280;font-size:.75rem;}

    /* Charts grid */
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:.75rem;margin-top:.75rem}
    .chart-card{background:#fff;border:1px solid #eee;border-radius:8px;padding:.75rem;box-shadow:0 1px 2px rgba(0,0,0,.06)}
    .chart-card h3{font-size:.82rem;color:#555;margin:.2rem .2rem .6rem}

    /* Risk heat map 5x5 */
    .heatmap{background:#fff;border:1px solid #eee;border-radius:8px;padding:.75rem;margin-top:.75rem}
    .heatmap h3{font-size:.82rem;color:#555;margin:.2rem .2rem .6rem}
    .heat-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px}
    .heat-cell{border-radius:6px;min-height:48px;display:flex;align-items:center;justify-content:center;font-weight:600;color:#111}
    .heat-cell.small{min-height:36px;font-size:.8rem}
    .legend{display:flex;justify-content:space-between;margin-top:.5rem;font-size:.72rem;color:#475569}
    .legend .axis{display:flex;gap:.35rem;align-items:center}
    .legend .swatch{width:14px;height:14px;border-radius:3px;border:1px solid rgba(0,0,0,.1)}
    .heat-1{background:#d1fae5}.heat-2{background:#a7f3d0}.heat-3{background:#fef3c7}.heat-4{background:#fdba74}.heat-5{background:#fecaca}

    /* High risks list */
    .high-risks{background:#fff;border:1px solid #eee;border-radius:8px;padding:.75rem;margin-top:.75rem}
    .high-risks h3{font-size:.82rem;color:#555;margin:.2rem .2rem .6rem}
    .risk-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem .6rem;border-bottom:1px dashed #eee;gap:.6rem}
    .risk-item:last-child{border-bottom:none}
    .risk-meta{display:flex;gap:.5rem;align-items:center;color:#6b7280;font-size:.78rem}
    .risk-title{font-weight:600;color:#111}

    /* Hide legacy table by default */
    .table-container{display:none;margin-top:1rem;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.08);overflow:hidden;border:1px solid #eee;}
        table{width:100%;border-collapse:collapse;}
        thead th{background:#f8f9fa;padding:.75rem;text-align:left;font-weight:600;color:#495057;border-bottom:1px solid #e5e7eb;}
        tbody td{padding:.7rem;border-bottom:1px solid #f0f0f0;vertical-align:middle;font-size:.87rem;color:#374151;}
        tr:hover{background:#f8fafc;}
        .clickable-row{cursor:pointer;}
        .badge{padding:4px 8px;border-radius:999px;font-size:.75rem;font-weight:700;}
        .badge.low{background:#4CAF50;color:#fff;} .badge.medium{background:#FFC107;color:#000;} .badge.high{background:#FF9800;color:#fff;} .badge.critical{background:#F44336;color:#fff;}
        .badge.pending{background:#FFC107;color:#000;} .badge.approved{background:#4CAF50;color:#fff;} .badge.rejected{background:#F44336;color:#fff;}
    </style>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="github-pages-fix.js"></script>
    <!-- Charts and reporting libs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
    <!-- Menu flicker guard -->
    <style>
        [data-feature]{display:none !important;visibility:hidden !important;}
        [data-feature].menu-visible{display:block !important;visibility:visible !important;}
        .menu-dropdown:not([data-feature]){display:none !important;}
        .menu-dropdown:not([data-feature]).menu-visible{display:block !important;}
    </style>
    <script>window.__DISABLE_MODULE_MENU_VIS = true;</script>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view"><a href="dashboard.html"><i class="fas fa-home"></i> Home</a></li>

                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown menu-visible" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html" class="active">Risk Register</a></li>
                    </ul>
                </li>

                <!-- Project Management (aligned to project-list.html) -->
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                    </ul>
                </li>
            </ul>
        </aside>

        <!-- Main content -->
        <main class="main-content">
            <!-- Top nav -->
            <div class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle sidebar"><i class="fas fa-bars"></i></button>
                    <div class="company-branding">
                        <img id="headerCompanyLogo" alt="Company Logo" />
                        <span id="headerCompanyName"></span>
                    </div>
                </div>
                <div class="top-nav-right">
                    <div class="user-profile" style="position:relative;">
                        <button id="userProfileBtn" class="profile-btn" title="Account"><img src="" alt="User Avatar" /></button>
                        <div class="profile-dropdown"><ul></ul></div>
                    </div>
                </div>
            </div>

            <section class="content">
                <div class="page-header">
                    <h1><i class="fas fa-clipboard-list"></i> Risk Register</h1>
                    <div class="page-actions">
                        <button id="exportPdfBtn" class="btn btn-secondary"><i class="fas fa-file-pdf"></i> Export PDF</button>
                        <button id="exportCsvBtn" class="btn btn-outline"><i class="fas fa-file-csv"></i> Export CSV</button>
                        <a href="risk.html" class="btn btn-primary" title="New Risk" aria-label="New Risk"><i class="fas fa-plus"></i></a>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filters">
                    <div class="field">
                        <label for="filterStart">Start Date</label>
                        <input type="date" id="filterStart" />
                    </div>
                    <div class="field">
                        <label for="filterEnd">End Date</label>
                        <input type="date" id="filterEnd" />
                    </div>
                    <div class="field">
                        <label for="filterDeptTrigger">Department</label>
                        <div class="custom-select" id="deptSelect">
                            <div class="custom-select-trigger" id="filterDeptTrigger">All Departments</div>
                            <div class="custom-select-panel" id="filterDeptPanel"></div>
                        </div>
                    </div>
                    <div class="field">
                        <label for="severityTrigger">Severity</label>
                        <div class="custom-select" id="severitySelect">
                            <div class="custom-select-trigger" id="severityTrigger">All Severities</div>
                            <div class="custom-select-panel" id="severityPanel"></div>
                        </div>
                    </div>
                    <div class="field">
                        <label for="statusTrigger">Status</label>
                        <div class="custom-select" id="statusSelect">
                            <div class="custom-select-trigger" id="statusTrigger">All Statuses</div>
                            <div class="custom-select-panel" id="statusPanel"></div>
                        </div>
                    </div>
                    <div class="field">
                        <label for="riskLevelSelect">Risk Level</label>
                        <select id="riskLevelSelect">
                            <option value="inherent" selected>Inherent</option>
                            <option value="residual">Residual</option>
                        </select>
                    </div>
                    <div class="field" style="min-width:220px;">
                        <label for="filterSearch">Search</label>
                        <input type="text" id="filterSearch" placeholder="Title, location, type..." />
                    </div>
                </div>

                <!-- Summary cards -->
                <div class="cards">
                    <div class="card"><h3>Total Risks</h3><div class="stat" id="statTotal">0</div><div class="muted">All records</div></div>
                    <div class="card"><h3>Open / Pending</h3><div class="stat" id="statOpen">0</div><div class="muted">Awaiting action</div></div>
                    <div class="card"><h3>High & Critical</h3><div class="stat" id="statHigh">0</div><div class="muted">Severity level</div></div>
                    <div class="card"><h3>Departments</h3><div class="stat" id="statDepts">0</div><div class="muted">Affected units</div></div>
                </div>

                <!-- Charts grid -->
                <div class="charts">
                    <div class="chart-card">
                        <h3>By Severity</h3>
                        <canvas id="chartSeverity" height="200"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3>By Department</h3>
                        <canvas id="chartDepartment" height="200"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="heatmap">
                            <h3>Risk Heat Map (Likelihood x Impact)</h3>
                            <div class="heat-grid" id="heatGrid"></div>
                            <div class="legend">
                                <div class="axis"><strong>Likelihood</strong> 1 to 5 →</div>
                                <div class="axis">← 1 to 5 <strong>Impact</strong></div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>By Status</h3>
                        <canvas id="chartStatus" height="200"></canvas>
                    </div>
                </div>

                <!-- Risk Map (moved here) -->
                <div class="map-section" style="background:#fff;border:1px solid #eee;border-radius:8px;padding:.75rem;margin-top:.75rem;">
                    <h3 style="font-size:.82rem;color:#555;margin:.2rem .2rem .6rem;">Risk Map</h3>
                    <div id="riskMap" style="height:360px;border-radius:8px;overflow:hidden;"></div>
                </div>

                <!-- High/Critical Risks -->
                <div class="high-risks">
                    <h3>Top High/Critical Risks</h3>
                    <div id="highRiskList"></div>
                </div>

                <!-- Register table -->
                <div class="table-container">
                    <table id="riskRegisterTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Department</th>
                                <th>Hazard Type</th>
                                <th>Severity</th>
                                <th>Location</th>
                                <th>Submitted By</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Firebase config (compatible with project-list AuthManager usage)
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };
        if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // Helpers
        function normalizeHref(href){ if(!href) return ''; const h = href.toLowerCase(); const fileOnly = h.replace(/^.*[\\\/]/,''); return fileOnly; }
        function formatDate(d){ try{ const dt = new Date(d); return dt.toLocaleDateString(); }catch{return 'N/A';} }
        function getCurrentUser(){ try{ if (window.authManager && window.authManager.currentUser) return window.authManager.currentUser; const raw=localStorage.getItem('currentUser'); return raw? JSON.parse(raw): null; }catch{return null;} }
        async function getUserDisplayName(userId){ try{ const cu = getCurrentUser(); const companyId = cu?.companyId; if(companyId){ const s=await firebase.database().ref(`companies/${companyId}/users/${userId}`).once('value'); if(s.exists()){ const u=s.val(); return `${u.firstName||''} ${u.lastName||''}`.trim()||u.displayName||u.name||u.email||'N/A'; } } const g=await firebase.database().ref(`users/${userId}`).once('value'); if(g.exists()){ const u=g.val(); return `${u.firstName||''} ${u.lastName||''}`.trim()||u.displayName||u.name||u.email||'N/A'; } return 'N/A'; }catch(e){ return 'N/A'; } }

        // Menu auth (function-style from project-list/riskboard with alias + href + add-visibility)
        let isMenuUpdateInProgress = false;
        function resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=>d.classList.remove('menu-visible')); }
        function showSidebarAfterAuth(){ document.querySelector('.sidebar')?.classList.remove('menu-loading'); }
        function ensureHomeIsVisible(){ const homeItem=document.querySelector('#roleBasedMenu li[data-feature="home_view"]'); if(homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible'); }

        async function updateMenuWithFeatureAuthorization(){
            if(isMenuUpdateInProgress){ return; }
            isMenuUpdateInProgress=true;
            try{
                let currentUser=null, companyId=null, userRole=null;
                if(window.authManager?.currentUser){ currentUser=window.authManager.currentUser; companyId=currentUser.companyId; userRole=currentUser.role; }
                else if(firebase.auth().currentUser){ currentUser=firebase.auth().currentUser; }
                if(!companyId && currentUser){ const companiesSnap=await firebase.database().ref('companies').once('value'); if(companiesSnap.exists()){ for(const [cid,comp] of Object.entries(companiesSnap.val())){ if(comp.status!=='active') continue; if(comp.users && comp.users[currentUser.uid]){ companyId=cid; userRole=comp.users[currentUser.uid].role || comp.users[currentUser.uid].userRole; break; } } } }
                if(!companyId){ resetMenuVisibility(); showSidebarAfterAuth(); return; }
                const authorizedPages = await applyFeatureBasedMenuVisibility(companyId);
                if(userRole){ await applyRoleBasedFiltering(companyId, userRole, authorizedPages||[]); }
            }catch(e){ resetMenuVisibility(); showSidebarAfterAuth(); }
            finally{ isMenuUpdateInProgress=false; }
        }

        async function applyFeatureBasedMenuVisibility(companyId){
            try{
                const featuresSnap = await firebase.database().ref('/platformFeatures').once('value');
                if(!featuresSnap.exists()){ resetMenuVisibility(); return []; }
                const featuresData = featuresSnap.val();
                const companySnap = await firebase.database().ref(`/companies/${companyId}`).once('value');
                const companyData = companySnap.val();
                if(!companyData){ resetMenuVisibility(); return []; }
                const subscribed = companyData.selectedFeatures || [];
                const authorizedPages = [];
                subscribed.forEach(fid=>{ const f = featuresData[fid]; if(f && f.status==='active' && f.authorizedPages){ authorizedPages.push(...f.authorizedPages); } });
                resetMenuVisibility();
                const authorizedFeatures = new Set();
                const authorizedHrefs = new Set();
                authorizedPages.forEach(p=>{ if(p.feature) authorizedFeatures.add(String(p.feature)); if(p.page) authorizedHrefs.add(String(p.page).toLowerCase()); if(p.href) authorizedHrefs.add(String(p.href).toLowerCase()); });
                const featureAliasMap = { 'risk_view':['risk_management_section'], 'risk_management_section':['risk_view'] };
                const isAuthorizedFeatureKey = (key)=>{ if(authorizedFeatures.has(key)) return true; const aliases = featureAliasMap[key]||[]; return aliases.some(a=>authorizedFeatures.has(a)); };
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                allMenuItems.forEach(item=>{
                    const isDropdown = item.classList.contains('menu-dropdown'); if(isDropdown) return;
                    const key = item.getAttribute('data-feature');
                    let allowByFeature = isAuthorizedFeatureKey(key);
                    let allowByHref = false; const link=item.querySelector('a[href]'); if(link){ const href=normalizeHref(link.getAttribute('href')); if(authorizedHrefs.has(href)) allowByHref=true; }
                    if(allowByFeature || allowByHref){ item.classList.add('menu-visible'); }
                });
                document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{
                    const dropdownKey = drop.getAttribute('data-feature');
                    const hasVisibleChildren = drop.querySelectorAll('.submenu li.menu-visible').length>0;
                    let dropdownHrefAuthorized=false; const dlink=drop.querySelector('> a[href]'); if(dlink){ const dh=normalizeHref(dlink.getAttribute('href')); dropdownHrefAuthorized = authorizedHrefs.has(dh); }
                    if(hasVisibleChildren || isAuthorizedFeatureKey(dropdownKey) || dropdownHrefAuthorized){ drop.classList.add('menu-visible'); }
                });
                return authorizedPages;
            }catch(e){ resetMenuVisibility(); return []; }
        }

        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages){
            try{
                const permSnap = await firebase.database().ref(`companies/${companyId}/roles/${userRole}/permissions`).once('value');
                if(!permSnap.exists()) { if(userRole==='administrator'){ showSidebarAfterAuth(); return; } hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; }
                const permissions = permSnap.val();
                filterMenuByPermissions(permissions);
            }catch(e){ showSidebarAfterAuth(); }
        }

        function hideItemsRequiringPermissions(){ const items=document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]'); items.forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(d=>{ const any=d.querySelectorAll('.submenu li.menu-visible').length>0; if(!any) d.classList.remove('menu-visible'); }); ensureHomeIsVisible(); }

        function filterMenuByPermissions(permissions){
            const permissionAliasMap = { 'risk_view':['risk_management_section'], 'risk_management_section':['risk_view'] };
            const hasPermissionKey=(key)=>{ if(key in permissions) return permissions[key]; const aliases=permissionAliasMap[key]||[]; for(const a of aliases){ if(a in permissions) return permissions[a]; } return undefined; };
            const items = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
            items.forEach(item=>{
                const requires = item.getAttribute('data-requires-permission');
                const permVal = hasPermissionKey(requires);
                const hasView = permVal === true || (permVal && permVal.view===true);
                if(hasView){ item.classList.add('menu-visible'); }
                else { item.classList.remove('menu-visible'); }
            });
            document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{
                const childrenVisible = drop.querySelectorAll('.submenu li.menu-visible').length>0;
                const dropdownRequires = drop.getAttribute('data-requires-permission');
                if(childrenVisible){ drop.classList.add('menu-visible'); }
                else if(dropdownRequires){ const permVal = hasPermissionKey(dropdownRequires); const hasView = permVal===true || (permVal && permVal.view===true); if(hasView) drop.classList.add('menu-visible'); else drop.classList.remove('menu-visible'); }
                else { drop.classList.remove('menu-visible'); }
            });
            ensureHomeIsVisible();
            showSidebarAfterAuth();
        }

        function initializeMenuAuthorization(){ document.querySelector('.sidebar')?.classList.add('menu-loading'); setTimeout(()=>updateMenuWithFeatureAuthorization(), 300); }

        // Risk Register data loader
    let risksRef = null, risksCallback = null;
    let allRisks = {};
    let filteredRisks = {};
    const selectedDepartments = new Set();
    const selectedSeverities = new Set(); // empty means all
    const selectedStatuses = new Set(); // empty means all
    let charts = { severity:null, department:null, status:null };
    // Map state
    let riskMap = null, riskMapLayer = null;
        async function startRisksListener(){
            const cu = getCurrentUser(); if(!cu?.companyId) return;
            const companyId = cu.companyId;
            if(risksRef && risksCallback){ risksRef.off('value', risksCallback); }
            risksRef = db.ref(`companies/${companyId}/risks`);
            risksCallback = async (snap)=>{
                const data = snap.val()||{}; allRisks = data; 
                // If company department options not set, fallback build from data
                const deptPanel = document.getElementById('filterDeptPanel');
                if(deptPanel && deptPanel.children.length === 0){ buildDepartmentFilterFromData(data); }
                applyFiltersAndRender();
            };
            risksRef.on('value', risksCallback);
        }

        function applyFiltersAndRender(){
            const filters = collectFilters();
            const entries = Object.entries(allRisks||{});
            const result = {};
            for(const [id, r] of entries){
                if(!passesFilters(r, filters)) continue; result[id]=r;
            }
            filteredRisks = result; renderDashboard(result, filters);
        }

        function collectFilters(){
            const start = document.getElementById('filterStart').value ? new Date(document.getElementById('filterStart').value) : null;
            const end = document.getElementById('filterEnd').value ? new Date(document.getElementById('filterEnd').value+'T23:59:59') : null;
            const deptValues = Array.from(selectedDepartments).map(v=>v.toLowerCase());
            const sevValues = Array.from(selectedSeverities).map(v=>v.toLowerCase());
            const statusValues = Array.from(selectedStatuses).map(v=>v.toLowerCase());
            const search = (document.getElementById('filterSearch').value||'').toLowerCase();
            const riskLevel = (document.getElementById('riskLevelSelect')?.value||'inherent').toLowerCase();
            return { start, end, deptValues, sevValues, statusValues, search, riskLevel };
        }

        function passesFilters(r, f){
            const date = r.dateSubmitted? new Date(r.dateSubmitted): null;
            if(f.start && date && date < f.start) return false;
            if(f.end && date && date > f.end) return false;
            if(f.deptValues && f.deptValues.length){ const d=(r.department||'').toLowerCase(); if(!f.deptValues.includes(d)) return false; }
            const sev=(r.severity||'low').toString().toLowerCase(); if(f.sevValues && f.sevValues.length && !f.sevValues.includes(sev)) return false;
            const status=(r.status||'pending').toString().toLowerCase(); if(f.statusValues && f.statusValues.length){ const norm=status.replace(/\s+/g,' '); const alias = norm==='in progress'? 'open': norm; if(!f.statusValues.includes(alias)) return false; }
            if(f.search){ const text=`${r.riskTitle||''} ${r.title||''} ${r.location||''} ${r.hazardType||r.type||''}`.toLowerCase(); if(!text.includes(f.search)) return false; }
            return true;
        }

    function populateDropdown(selectId, items, placeholder){ /* no-op for custom selects */ }

        function setDeptOptions(items){
            const panel = document.getElementById('filterDeptPanel'); if(!panel) return;
            panel.innerHTML='';
            // All Departments option
            const allOpt=document.createElement('div'); allOpt.className='custom-option'; allOpt.dataset.value=''; allOpt.innerHTML = `<span class="box">—</span><span>All Departments</span>`;
            allOpt.addEventListener('click', (e)=>{ selectedDepartments.clear(); updateDeptPanelTicks(); updateDeptTriggerLabel(); applyFiltersAndRender(); });
            panel.appendChild(allOpt);
            // Departments
            (items||[]).forEach(v=>{
                const dep = typeof v==='string'? v: (v?.value||v?.name||''); if(!dep) return;
                const row=document.createElement('div'); row.className='custom-option'; row.dataset.value=dep;
                row.innerHTML = `<span class="box">${selectedDepartments.has(dep)? '☑':'☐'}</span><span>${dep}</span>`;
                row.addEventListener('click', ()=>{ toggleDeptSelection(dep); });
                panel.appendChild(row);
            });
        }

        // Severity custom dropdown helpers
        function setSeverityOptions(items){
            const panel = document.getElementById('severityPanel'); if(!panel) return;
            panel.innerHTML='';
            // All severities option
            const allOpt=document.createElement('div'); allOpt.className='custom-option'; allOpt.dataset.value=''; allOpt.innerHTML = `<span class="box">—</span><span>All Severities</span>`;
            allOpt.addEventListener('click', ()=>{ selectedSeverities.clear(); updateSeverityPanelTicks(); updateSeverityTriggerLabel(); applyFiltersAndRender(); });
            panel.appendChild(allOpt);
            (items||[]).forEach(v=>{
                const raw = typeof v==='string'? v: (v?.value||v?.name||''); if(!raw) return;
                const val = raw.toString().toLowerCase();
                const label = raw.toString().charAt(0).toUpperCase()+raw.toString().slice(1);
                const row=document.createElement('div'); row.className='custom-option'; row.dataset.value=val;
                row.innerHTML = `<span class="box">${selectedSeverities.has(val)? '☑':'☐'}</span><span>${label}</span>`;
                row.addEventListener('click', ()=>{ toggleSeveritySelection(val); });
                panel.appendChild(row);
            });
        }

        function updateSeverityPanelTicks(){
            const panel=document.getElementById('severityPanel'); if(!panel) return;
            const rows=panel.querySelectorAll('.custom-option');
            rows.forEach((row,idx)=>{
                const box=row.querySelector('.box'); const val=row.dataset.value;
                if(idx===0){ if(box) box.textContent='—'; return; }
                if(box) box.textContent = selectedSeverities.has(val)? '☑':'☐';
            });
        }

        function updateSeverityTriggerLabel(){
            const trigger=document.getElementById('severityTrigger'); if(!trigger) return;
            if(selectedSeverities.size===0){ trigger.textContent='All Severities'; return; }
            trigger.textContent = `${selectedSeverities.size} selected`;
        }

        function toggleSeveritySelection(val){
            if(selectedSeverities.has(val)) selectedSeverities.delete(val); else selectedSeverities.add(val);
            updateSeverityPanelTicks();
            updateSeverityTriggerLabel();
            applyFiltersAndRender();
        }

        // Status custom dropdown helpers
        function setStatusOptions(items){
            const panel = document.getElementById('statusPanel'); if(!panel) return;
            panel.innerHTML='';
            // All Statuses option
            const allOpt=document.createElement('div'); allOpt.className='custom-option'; allOpt.dataset.value=''; allOpt.innerHTML = `<span class="box">—</span><span>All Statuses</span>`;
            allOpt.addEventListener('click', ()=>{ selectedStatuses.clear(); updateStatusPanelTicks(); updateStatusTriggerLabel(); applyFiltersAndRender(); });
            panel.appendChild(allOpt);
            (items||[]).forEach(v=>{
                const raw = typeof v==='string'? v: (v?.value||v?.name||''); if(!raw) return;
                const val = raw.toString().toLowerCase();
                const label = raw.toString().charAt(0).toUpperCase()+raw.toString().slice(1);
                const row=document.createElement('div'); row.className='custom-option'; row.dataset.value=val;
                row.innerHTML = `<span class="box">${selectedStatuses.has(val)? '☑':'☐'}</span><span>${label}</span>`;
                row.addEventListener('click', ()=>{ toggleStatusSelection(val); });
                panel.appendChild(row);
            });
        }

        function updateStatusPanelTicks(){
            const panel=document.getElementById('statusPanel'); if(!panel) return;
            const rows=panel.querySelectorAll('.custom-option');
            rows.forEach((row,idx)=>{
                const box=row.querySelector('.box'); const val=row.dataset.value;
                if(idx===0){ if(box) box.textContent='—'; return; }
                if(box) box.textContent = selectedStatuses.has(val)? '☑':'☐';
            });
        }

        function updateStatusTriggerLabel(){
            const trigger=document.getElementById('statusTrigger'); if(!trigger) return;
            if(selectedStatuses.size===0){ trigger.textContent='All Statuses'; return; }
            trigger.textContent = `${selectedStatuses.size} selected`;
        }

        function toggleStatusSelection(val){
            if(selectedStatuses.has(val)) selectedStatuses.delete(val); else selectedStatuses.add(val);
            updateStatusPanelTicks();
            updateStatusTriggerLabel();
            applyFiltersAndRender();
        }

        function updateDeptPanelTicks(){
            const panel = document.getElementById('filterDeptPanel'); if(!panel) return;
            const rows = panel.querySelectorAll('.custom-option');
            rows.forEach((row,idx)=>{
                const box = row.querySelector('.box');
                const val = row.dataset.value;
                if(idx===0){ if(box) box.textContent='—'; return; }
                if(box) box.textContent = selectedDepartments.has(val)? '☑':'☐';
            });
        }

        function updateDeptTriggerLabel(){
            const trigger = document.getElementById('filterDeptTrigger'); if(!trigger) return;
            if(selectedDepartments.size===0){ trigger.textContent='All Departments'; return; }
            const count = selectedDepartments.size; trigger.textContent = `${count} selected`;
        }

        function toggleDeptSelection(dep){
            if(selectedDepartments.has(dep)) selectedDepartments.delete(dep); else selectedDepartments.add(dep);
            updateDeptPanelTicks();
            updateDeptTriggerLabel();
            applyFiltersAndRender();
        }

        async function initDepartmentDropdownFromCompany(){
            try{
                const user = getCurrentUser(); if(!user||!user.companyId) return;
                const comp = window.authManager?.currentCompany; 
                let departments = [];
                if(comp){
                    if(comp.fieldOptions && comp.fieldOptions['department']) departments = comp.fieldOptions['department'];
                    else if(comp.departments) departments = comp.departments;
                }
                if(!departments || departments.length===0){
                    const snap = await firebase.database().ref(`companies/${user.companyId}`).once('value');
                    const data = snap.val()||{};
                    if(data.fieldOptions && data.fieldOptions['department']) departments = data.fieldOptions['department'];
                    else if(data.departments) departments = data.departments;
                }
                if(departments && departments.length){ setDeptOptions(departments); updateDeptTriggerLabel(); }
            }catch(e){ /* ignore */ }
        }

        function buildDepartmentFilterFromData(data){
            const set=new Set(); Object.values(data||{}).forEach(r=>{ if(r.department) set.add(r.department); });
            const list = Array.from(set).sort(); if(list.length){ setDeptOptions(list); updateDeptTriggerLabel(); }
        }

        function renderDashboard(risks, filters){
            const list = Object.entries(risks||{});
            // Stats
            let total=0, open=0, high=0; const deptSet=new Set();
            const sevCounts = {low:0, medium:0, high:0, critical:0};
            const statusCounts = {open:0, pending:0, approved:0, rejected:0};
            const deptCounts={};
            const heat = buildEmptyHeatMatrix();

            for(const [id,r] of list){
                total++;
                const sev=(r.severity||'low').toString().toLowerCase(); if(sevCounts[sev]!==undefined) sevCounts[sev]++;
                const status=(r.status||'pending').toString().toLowerCase(); const norm=status==='in progress'? 'open': status; if(statusCounts[norm]!==undefined) statusCounts[norm]++;
                if(norm==='open' || norm==='pending') open++;
                if(sev==='high' || sev==='critical') high++;
                const dept=r.department||'Unassigned'; deptSet.add(dept); deptCounts[dept]=(deptCounts[dept]||0)+1;
                // Heat map
                const level = (filters?.riskLevel|| (document.getElementById('riskLevelSelect')?.value||'inherent')).toLowerCase();
                const { lh, im } = getLikelihoodImpactForLevel(r, level, sev);
                heat[im-1][lh-1]++;
            }

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statOpen').textContent = open;
            document.getElementById('statHigh').textContent = high;
            document.getElementById('statDepts').textContent = deptSet.size;

            // Charts
            initOrUpdateCharts({sevCounts, deptCounts, statusCounts});
            renderHeatMap(heat);
            renderHighRisksList(risks);
            renderRiskMap(risks);
        }

        // Resolve Likelihood/Impact pair based on selected risk level with robust fallbacks
        function getLikelihoodImpactForLevel(risk, level, sev){
            const getFirst = (obj, keys)=>{ for(const k of keys){ if(obj[k]!=null && obj[k]!=='' && obj[k]!==undefined) return obj[k]; } return null; };
            let l=null, i=null;
            if(level==='residual'){
                l = getFirst(risk, ['residualLikelihoodLevel','residualLikelihood','likelihoodAfter','residual_likelihood','residualRiskLikelihood','resLikelihood','postMitigationLikelihood']);
                i = getFirst(risk, ['residualImpactLevel','residualImpact','impactAfter','residual_impact','residualRiskImpact','resImpact','postMitigationImpact']);
            } else { // inherent (default)
                l = getFirst(risk, ['inherentLikelihoodLevel','inherentLikelihood','likelihoodBefore','inherent_likelihood','preMitigationLikelihood','baseLikelihood']);
                i = getFirst(risk, ['inherentImpactLevel','inherentImpact','impactBefore','inherent_impact','preMitigationImpact','baseImpact']);
            }
            // Generic fallbacks
            if(l==null) l = getFirst(risk, ['likelihoodLevel','likelihood','likelihoodScore']);
            if(i==null) i = getFirst(risk, ['impactLevel','impact','impactScore']);
            const lh = to1to5(l!=null? l: sevToLikelihood(sev));
            const im = to1to5(i!=null? i: sevToImpact(sev));
            return { lh, im };
        }

        function buildEmptyHeatMatrix(){ return Array.from({length:5},()=>Array.from({length:5},()=>0)); }
        function to1to5(v){ const n = parseInt(v,10); if(!isNaN(n)) return Math.max(1, Math.min(5,n)); const s = (v||'').toString().toLowerCase(); const map={verylow:1,low:2,medium:3,moderate:3,high:4,veryhigh:5,critical:5}; return map[s]||3; }
        function sevToLikelihood(sev){ return {low:2, medium:3, high:4, critical:5}[sev]||3; }
        function sevToImpact(sev){ return {low:2, medium:3, high:4, critical:5}[sev]||3; }

        function initOrUpdateCharts(data){
            const sevData = [data.sevCounts.low, data.sevCounts.medium, data.sevCounts.high, data.sevCounts.critical];
            const sevLabels = ['Low','Medium','High','Critical'];
            const sevColors = ['#22c55e','#eab308','#f59e0b','#ef4444'];
            const cvsS = document.getElementById('chartSeverity');
            const ctxS = cvsS ? cvsS.getContext('2d') : null;
            if(ctxS){
                const makeSeverityBar = ()=> new Chart(ctxS, {
                    type: 'bar',
                    data: { labels: sevLabels, datasets: [{ label: 'Risks', data: sevData, backgroundColor: sevColors }] },
                    options: {
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                    }
                });
                if(!charts.severity){ charts.severity = makeSeverityBar(); }
                else if(charts.severity?.config?.type !== 'bar') { charts.severity.destroy(); charts.severity = makeSeverityBar(); }
                else { charts.severity.data.labels = sevLabels; charts.severity.data.datasets[0].data=sevData; charts.severity.update(); }
            }

            const deptLabels = Object.keys(data.deptCounts);
            const deptValues = Object.values(data.deptCounts);
            const cvsD = document.getElementById('chartDepartment');
            const ctxD = cvsD ? cvsD.getContext('2d') : null;
            if(ctxD){
                const deptData = { labels: deptLabels, datasets: [{ label:'Risks', data: deptValues, backgroundColor:'#60a5fa' }] };
                const deptOptions = { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { ticks: { precision: 0 } } } };
                if(!charts.department){ charts.department = new Chart(ctxD, { type:'bar', data: deptData, options: deptOptions }); }
                else { charts.department.data.labels=deptLabels; charts.department.data.datasets[0].data=deptValues; charts.department.update(); }
            }

            const statusLabels=['Open','Pending','Approved','Rejected'];
            const statusValues=[data.statusCounts.open,data.statusCounts.pending,data.statusCounts.approved,data.statusCounts.rejected];
            const statusColors=['#3b82f6','#eab308','#22c55e','#ef4444'];
            const cvsSt=document.getElementById('chartStatus');
            const ctxSt = cvsSt ? cvsSt.getContext('2d') : null;
            if(ctxSt){
                if(!charts.status){ charts.status = new Chart(ctxSt,{type:'doughnut',data:{labels:statusLabels,datasets:[{data:statusValues,backgroundColor:statusColors}]},options:{plugins:{legend:{position:'bottom'}}}}); }
                else { charts.status.data.datasets[0].data=statusValues; charts.status.update(); }
            }
        }

        function renderHeatMap(matrix){
            const grid=document.getElementById('heatGrid'); if(!grid) return; grid.innerHTML='';
            // Update title to reflect selected risk level
            const titleEl = document.querySelector('.heatmap h3');
            if(titleEl){ const rl=(document.getElementById('riskLevelSelect')?.value||'inherent'); titleEl.textContent = `Risk Heat Map (Likelihood x Impact - ${rl.charAt(0).toUpperCase()+rl.slice(1)})`; }
            for(let i=5;i>=1;i--){ // Impact rows (5 to 1)
                for(let j=1;j<=5;j++){ // Likelihood cols (1 to 5)
                    const val = matrix[i-1][j-1]||0; const cell=document.createElement('div');
                    const level = j>=4 && i>=4 ? 5 : j>=3 && i>=3 ? 4 : j>=3 || i>=3 ? 3 : j>=2 || i>=2 ? 2 : 1;
                    cell.className=`heat-cell heat-${level}`; cell.textContent=val; grid.appendChild(cell);
                }
            }
        }

        function renderHighRisksList(risks){
            const container=document.getElementById('highRiskList'); if(!container) return; container.innerHTML='';
            const items = Object.entries(risks||{}).map(([id,r])=>({id, title:r.riskTitle||r.title||'Untitled', dept:r.department||'—', sev:(r.severity||'low').toString().toLowerCase(), date:r.dateSubmitted||null, status:(r.status||'pending').toLowerCase()}));
            items.sort((a,b)=> sevRank(b.sev)-sevRank(a.sev));
            const top = items.filter(x=> x.sev==='high'||x.sev==='critical').slice(0,10);
            if(top.length===0){ container.innerHTML='<div class="muted" style="padding:.5rem .6rem;">No high/critical risks</div>'; return; }
            top.forEach(it=>{
                const el=document.createElement('div'); el.className='risk-item';
                el.innerHTML = `<div class="risk-title">${escapeHtml(it.title)}</div><div class="risk-meta"><span class="badge ${it.sev}">${capitalize(it.sev)}</span><span>${escapeHtml(it.dept)}</span><span>${it.date? formatDate(it.date): ''}</span></div>`;
                el.addEventListener('click',()=>{ window.location.href = `risk.html?edit=${it.id}`; });
                container.appendChild(el);
            });
        }

        // Map helpers
        function initRiskMap(){
            if(riskMap) return;
            const el = document.getElementById('riskMap');
            if(!el || !window.L) return;
            riskMap = L.map('riskMap', { scrollWheelZoom: true }).setView([20,0], 2);

            // Base layers (calques)
            const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            });
            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
            });
            const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenTopoMap (CC-BY-SA), Map data: &copy; OpenStreetMap contributors'
            });

            // Default layer
            streets.addTo(riskMap);

            // Risks overlay layer group
            riskMapLayer = L.layerGroup().addTo(riskMap);

            // Layer control
            const baseLayers = { 'Streets': streets, 'Satellite': satellite, 'Topographic': topo };
            const overlays = { 'Risks': riskMapLayer };
            L.control.layers(baseLayers, overlays, { collapsed: true, position: 'topright' }).addTo(riskMap);
            L.control.scale({ imperial: false }).addTo(riskMap);

            // Severity legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function(){
                const div = L.DomUtil.create('div','info legend');
                div.style.background = 'white';
                div.style.padding = '6px 8px';
                div.style.borderRadius = '6px';
                div.style.boxShadow = '0 1px 4px rgba(0,0,0,0.2)';
                div.style.fontSize = '.8rem';
                const items = [
                    {label:'Low', color:'#22c55e'},
                    {label:'Medium', color:'#eab308'},
                    {label:'High', color:'#f59e0b'},
                    {label:'Critical', color:'#ef4444'}
                ];
                div.innerHTML = '<div style="font-weight:600;margin-bottom:4px;">Severity</div>' +
                    items.map(i=>`<div style="display:flex;align-items:center;gap:6px;margin:2px 0;">
                        <span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${i.color};border:1px solid rgba(0,0,0,.2);"></span>
                        <span>${i.label}</span>
                    </div>`).join('');
                return div;
            };
            legend.addTo(riskMap);

            setTimeout(()=> riskMap.invalidateSize(), 200);
        }

        function parseRiskLatLng(r){
            let lat = r.latitude ?? r.lat; let lng = r.longitude ?? r.lng;
            if((lat==null || lng==null) && typeof r.coordinates==='string'){
                const parts = r.coordinates.split(',').map(s=>parseFloat(String(s).trim()));
                if(parts.length===2){ lat = parts[0]; lng = parts[1]; }
            }
            lat = parseFloat(lat); lng = parseFloat(lng);
            if(!isFinite(lat) || !isFinite(lng)) return null;
            if(lat < -90 || lat > 90 || lng < -180 || lng > 180) return null;
            return [lat, lng];
        }

        function renderRiskMap(risks){
            initRiskMap();
            if(!riskMap || !riskMapLayer) return;
            riskMapLayer.clearLayers();
            const bounds = [];
            Object.entries(risks||{}).forEach(([id,r])=>{
                const ll = parseRiskLatLng(r); if(!ll) return;
                const sev=(r.severity||'low').toString().toLowerCase();
                const status=(r.status||'pending').toString().toLowerCase();
                const title = escapeHtml(r.riskTitle||r.title||'Risk');
                const dept = escapeHtml(r.department||'—');
                const date = r.dateSubmitted? formatDate(r.dateSubmitted): '';
                const html = `<div style="min-width:180px"><div style="font-weight:600;margin-bottom:4px;">${title}</div><div style="font-size:.8rem;color:#555;display:flex;flex-direction:column;gap:2px;"><span><strong>Severity:</strong> ${capitalize(sev)}</span><span><strong>Status:</strong> ${capitalize(status)}</span><span><strong>Dept:</strong> ${dept}</span><span><strong>Date:</strong> ${date}</span></div></div>`;
                const color = getSeverityColor(sev);
                const radius = {low:6, medium:7, high:8, critical:9}[sev] || 6;
                L.circleMarker(ll, { radius, color, fillColor: color, fillOpacity: 0.9, weight: 1 }).addTo(riskMapLayer).bindPopup(html);
                bounds.push(ll);
            });
            if(bounds.length){ riskMap.fitBounds(bounds, { padding:[30,30] }); }
            else { riskMap.setView([20,0], 2); }
            setTimeout(()=> riskMap.invalidateSize(), 50);
        }

        function getSeverityColor(sev){
            switch(sev){
                case 'low': return '#22c55e';
                case 'medium': return '#eab308';
                case 'high': return '#f59e0b';
                case 'critical': return '#ef4444';
                default: return '#3b82f6';
            }
        }

        function sevRank(sev){ return {low:1, medium:2, high:3, critical:4}[sev]||1; }
        function capitalize(s){ return (s||'').charAt(0).toUpperCase()+s.slice(1); }
        function escapeHtml(s){ return (s||'').replace(/[&<>"]+/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

        // Export PDF report
        async function exportPdfReport(){
            try{
                const { jsPDF } = window.jspdf || {};
                if(!jsPDF) { alert('PDF library not available'); return; }
                const doc = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
                const company = (window.authManager?.currentCompany?.companyName) || (getCurrentUser()?.companyName) || 'Company';
                const title = 'Risk Register Report';
                const date = new Date().toLocaleString();
                let y=40;
                doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.text(title, 40, y); y+=18;
                doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.text(`Company: ${company}`,40,y); y+=14; doc.text(`Generated: ${date}`,40,y); y+=22;
                // Stats
                const stats = [
                    `Total Risks: ${document.getElementById('statTotal').textContent}`,
                    `Open/Pending: ${document.getElementById('statOpen').textContent}`,
                    `High/Critical: ${document.getElementById('statHigh').textContent}`,
                    `Departments: ${document.getElementById('statDepts').textContent}`
                ];
                doc.setFont('helvetica','bold'); doc.text('Summary',40,y); y+=14; doc.setFont('helvetica','normal'); stats.forEach(s=>{ doc.text(s, 52, y); y+=14; }); y+=10;
                // Add charts if available
                const addChart = (canvasId, label)=>{ const c=document.getElementById(canvasId); if(!c) return; const img=c.toDataURL('image/png', 0.98); if(y>700){ doc.addPage(); y=40; } doc.setFont('helvetica','bold'); doc.text(label,40,y); y+=10; doc.addImage(img,'PNG',40,y,515,0); y+=240; };
                addChart('chartSeverity','By Severity');
                addChart('chartDepartment','By Department');
                addChart('chartStatus','By Status');
                doc.save('risk-register-report.pdf');
            }catch(err){ console.error('PDF export error', err); alert('Unable to export PDF'); }
        }

        // CSV export
        function exportTableToCSV(){
            const rows = [];
            // Header
            rows.push(['Risk ID','Title','Department','Type','Severity','Location','Submitted By','Date Submitted','Status']);
            // Data
            const data = Object.entries(filteredRisks||allRisks||{});
            data.forEach(([id,r])=>{
                rows.push([
                    r.riskID || r.id || id,
                    (r.riskTitle || r.title || '').toString(),
                    r.department || '',
                    r.hazardType || r.type || '',
                    r.severity || '',
                    r.location || '',
                    r.submittedBy || '',
                    r.dateSubmitted ? formatDate(r.dateSubmitted): '',
                    r.status || ''
                ]);
            });
            const csv = rows.map(row=>row.map(cell=>`"${(cell||'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='risk-register.csv'; a.click(); URL.revokeObjectURL(url);
        }

        // AuthManager (copied/adapted from project-list.html for consistent branding and avatar dropdown)
        class AuthManager {
            constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; this.init(); }
            getCurrentUser(){ try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); }catch{return null;} }
            setCurrentUser(u){ localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser=u; }
            async init(){ if(!this.currentUser){ location.href='login.html'; return; } await this.loadUserCompany(); this.updateCompanyBranding(); await this.updateUIForAuthenticatedUser(); this.bindProfileDropdown(); }
            async loadUserCompany(){ if(!this.currentUser) return; try{ const snap=await firebase.database().ref('companies').once('value'); if(!snap.exists()) return; const companies=snap.val(); for(const [cid,comp] of Object.entries(companies)){ if(comp.status!=='active') continue; if(comp.users){ for(const [uid,u] of Object.entries(comp.users)){ if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ this.currentUser.companyId=cid; this.currentUser.companyName=comp.companyName; this.currentUser.role=u.role||u.userRole||'user'; this.currentCompany=comp; this.setCurrentUser(this.currentUser); return; } } } } }catch(e){} }
            updateCompanyBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(!this.currentCompany){ this.showFallbackBranding(); return; } if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.classList.add('visible'); } else { const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.src=svg; logoEl.classList.add('visible'); } } if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); } }
            showFallbackBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); if(logoEl){ const svg=this.generateCompanyInitialsSVG('DX'); logoEl.src=svg; logoEl.classList.add('visible'); } }
            getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
            generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
            getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=> typeof v==='string'? v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
            getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
            async getUserAvatarUrl(){ if(!this.currentUser) return null; const companyId=this.currentUser.companyId||'default'; const paths=[`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,`avatars/${this.currentUser.uid}/profile.jpg`,`avatars/${this.currentUser.uid}/profile.png`,`avatars/${this.currentUser.uid}/avatar.jpg`,`avatars/${this.currentUser.uid}/avatar.png`,`profiles/${this.currentUser.uid}/profile.jpg`,`profiles/${this.currentUser.uid}/profile.png`]; for(const p of paths){ try{ const ref=firebase.storage().ref(p); const url=await ref.getDownloadURL(); return url; }catch(err){ continue; } } return null; }
            async updateUIForAuthenticatedUser(){ const btn=document.getElementById('userProfileBtn'); const list=document.querySelector('.profile-dropdown ul'); if(!btn||!list||!this.currentUser) return; const displayName=this.getUserDisplayName(); const email=this.currentUser.email||''; let avatarUrl=null; try{ avatarUrl=await this.getUserAvatarUrl(); }catch{} const btnImg=btn.querySelector('img'); if(avatarUrl&&btnImg){ btnImg.src=avatarUrl; btnImg.alt=displayName+' Avatar'; btnImg.style.display='block'; btnImg.onerror=()=>{ btnImg.style.display='none'; btn.innerHTML=`<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`; }; } else { btn.innerHTML=`<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`; }
                const avatarHtml = avatarUrl ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
                list.innerHTML = `<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style=\"font-weight:600;color:#333;font-size:14px;margin-bottom:2px;\">${displayName}</div><div style=\"color:#666;font-size:12px;\">${email}</div></div></div></li><li><a href=\"profile.html\"><i class=\"fas fa-user\"></i> Profile</a></li><li><a href=\"account.html\"><i class=\"fas fa-cog\"></i> Account Settings</a></li><li><a href=\"#\" id=\"logoutLink\"><i class=\"fas fa-sign-out-alt\"></i> Sign out</a></li>`;
                list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); });
            }
            bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn&&dd){ btn.addEventListener('click',e=>{ e.stopPropagation(); dd.classList.toggle('show'); }); document.addEventListener('click',e=>{ if(!btn.contains(e.target)) dd.classList.remove('show'); }); } }
            async logout(){ try{ await firebase.auth().signOut(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); location.href='login.html'; }catch(e){ localStorage.removeItem('currentUser'); localStorage.removeItem('user'); location.href='login.html'; } }
        }

        // Sidebar toggle
    function bindSidebarToggle(){ const btn=document.getElementById('sidebarToggle'); const sidebar=document.querySelector('.sidebar'); const main=document.querySelector('.main-content'); const topNav=document.querySelector('.top-nav'); btn?.addEventListener('click',()=>{ sidebar?.classList.toggle('collapsed'); main?.classList.toggle('sidebar-collapsed'); if(topNav){ topNav.style.left = sidebar?.classList.contains('collapsed') ? '0.5rem' : 'calc(var(--sidebar-width) + 0.5rem)'; } }); }

        document.addEventListener('DOMContentLoaded', ()=>{
            // Initialize AuthManager for header branding/profile (match project-list)
            window.authManager = new AuthManager();
            initializeMenuAuthorization();
            startRisksListener();
            bindSidebarToggle();
            document.getElementById('exportCsvBtn')?.addEventListener('click', exportTableToCSV);
            document.getElementById('exportPdfBtn')?.addEventListener('click', exportPdfReport);
            // Populate department dropdown from company configuration
            initDepartmentDropdownFromCompany();
            // Filter events
            document.getElementById('filterStart')?.addEventListener('change', applyFiltersAndRender);
            document.getElementById('filterEnd')?.addEventListener('change', applyFiltersAndRender);
            // Department multi-select behavior with single-style dropdown
            // Custom dropdowns open/close
            const deptSelect = document.getElementById('deptSelect');
            const deptTrigger = document.getElementById('filterDeptTrigger');
            const deptPanel = document.getElementById('filterDeptPanel');
            const severitySelect = document.getElementById('severitySelect');
            const severityTrigger = document.getElementById('severityTrigger');
            const severityPanel = document.getElementById('severityPanel');
            const statusSelect = document.getElementById('statusSelect');
            const statusTrigger = document.getElementById('statusTrigger');
            const statusPanel = document.getElementById('statusPanel');
            deptTrigger?.addEventListener('click', (e)=>{ e.stopPropagation(); deptSelect?.classList.toggle('open'); severitySelect?.classList.remove('open'); statusSelect?.classList.remove('open'); });
            severityTrigger?.addEventListener('click', (e)=>{ e.stopPropagation(); severitySelect?.classList.toggle('open'); deptSelect?.classList.remove('open'); statusSelect?.classList.remove('open'); });
            statusTrigger?.addEventListener('click', (e)=>{ e.stopPropagation(); statusSelect?.classList.toggle('open'); deptSelect?.classList.remove('open'); severitySelect?.classList.remove('open'); });
            document.addEventListener('click', (e)=>{ 
                if(!deptSelect?.contains(e.target)) deptSelect?.classList.remove('open');
                if(!severitySelect?.contains(e.target)) severitySelect?.classList.remove('open');
                if(!statusSelect?.contains(e.target)) statusSelect?.classList.remove('open');
            });
            // Initialize severity options
            setSeverityOptions(['low','medium','high','critical']);
            updateSeverityTriggerLabel();
            // Initialize status options
            setStatusOptions(['open','pending','approved','rejected']);
            updateStatusTriggerLabel();
            // Risk level change triggers re-render
            document.getElementById('riskLevelSelect')?.addEventListener('change', applyFiltersAndRender);
            document.getElementById('filterSearch')?.addEventListener('input', ()=>{ clearTimeout(window.__rfst); window.__rfst=setTimeout(applyFiltersAndRender, 250); });
        });
    </script>

    <script>
    // Resource load error logging and sidebar toggle alignment (like riskboard.html)
    window.addEventListener('error', function(e){ if(e.target.tagName==='LINK' && e.target.rel==='stylesheet'){ console.warn('CSS not found:', e.target.href);} if(e.target.tagName==='SCRIPT'){ console.warn('JS not found:', e.target.src);} });
    </script>
</body>
</html>
