<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard - Dreamex Datalab</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Super Admin Container */
        .super-admin-container {
            padding: 2rem;
            width: 100%;
            margin: 0;
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 1.1rem;
            margin: 0;
        }

        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #495057;
            font-weight: 500;
        }

        .stat-number {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Controls Section */
        .controls-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .search-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 1;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        /* Tab Navigation Styles */
        .content-tabs {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-navigation {
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            padding: 0;
        }

        .tab-nav-btn {
            background: none;
            border: none;
            padding: 1rem 2rem;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 3px solid transparent;
        }

        .tab-nav-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab-nav-btn.active {
            background: white;
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
        }

        .tab-content.active {
            display: block;
        }

        /* Users Table Styles */
        .users-table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 1rem;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .users-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .users-table tbody tr:hover {
            background: #f8f9fa;
        }

        .user-name-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
            display: inline-block;
        }

        .role-badge.admin {
            background: #dc3545;
            color: white;
        }

        .role-badge.company-admin {
            background: #6f42c1;
            color: white;
        }

        .role-badge.manager {
            background: #fd7e14;
            color: white;
        }

        .role-badge.user {
            background: #28a745;
            color: white;
        }

        .role-badge.viewer {
            background: #6c757d;
            color: white;
        }

        .last-login-cell {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .company-info-header {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .company-info-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .back-to-companies {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-to-companies:hover {
            background: #5a6268;
        }
        .loading-container {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Companies Table Styles */

        .companies-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-top: 1.5rem;
        }

        .companies-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .companies-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .companies-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .companies-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .companies-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .companies-table tbody tr {
            transition: all 0.2s ease;
        }

        .company-name-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        .company-id-badge {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
            display: inline-block;
            margin-bottom: 0.25rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .table-action-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            text-decoration: none;
            min-width: 70px;
            justify-content: center;
        }

        .table-btn-primary {
            background: #007bff;
            color: white;
        }

        .table-btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .table-btn-success {
            background: #28a745;
            color: white;
        }

        .table-btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }

        .table-btn-danger {
            background: #dc3545;
            color: white;
        }

        .table-btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        /* Quota Management Button */
        .table-action-btn[style*="background: #17a2b8"]:hover {
            background: #138496 !important;
            transform: translateY(-1px);
        }

        .email-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #495057;
        }

        .industry-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #495057;
        }

        .date-cell {
            font-size: 0.9rem;
            color: #6c757d;
            white-space: nowrap;
        }

        .users-cell {
            text-align: center;
            font-weight: 500;
            color: #495057;
        }

        .subscription-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.8rem;
            background: #f8f9fa;
            color: #495057;
            font-weight: 500;
            text-transform: capitalize;
        }

        .subscription-badge.basic {
            background: #e9ecef;
            color: #495057;
        }

        .subscription-badge.professional {
            background: #d4edda;
            color: #155724;
        }

        .subscription-badge.premium {
            background: #cce5ff;
            color: #004085;
        }

        .subscription-badge.enterprise {
            background: #fff3cd;
            color: #856404;
        }

        .quota-display {
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .quota-normal {
            background: #e8f5e8;
            color: #2d5f2d;
        }

        .quota-exceeded {
            background: #ffe6e6;
            color: #cc0000;
        }

        .quota-cell {
            text-align: center;
            min-width: 80px;
        }

        @media (max-width: 768px) {
            .companies-table {
                font-size: 0.8rem;
            }
            
            .companies-table th,
            .companies-table td {
                padding: 0.5rem;
            }
            
            .email-cell,
            .industry-cell {
                max-width: 100px;
            }

            .quota-cell {
                min-width: 70px;
            }
            
            .table-actions {
                flex-direction: column;
                gap: 0.25rem;
            }

            .companies-table-container {
                overflow-x: auto;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .super-admin-container {
                padding: 1rem;
            }

            .stats-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .search-export-row {
                flex-direction: column;
                align-items: stretch;
            }

            .companies-table {
                font-size: 0.8rem;
            }
            
            .companies-table th,
            .companies-table td {
                padding: 0.5rem;
            }
            
            .email-cell,
            .industry-cell {
                max-width: 100px;
            }
            
            .table-actions {
                flex-direction: column;
                gap: 0.25rem;
            }

            .table-action-btn {
                font-size: 0.7rem;
                padding: 0.4rem 0.5rem;
                min-width: 60px;
            }

            .companies-table-container {
                overflow-x: auto;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 16px;
            width: 95%;
            max-width: 900px;
            max-height: 95vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalSlideIn 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: 16px 16px 0 0;
        }

        .modal-title {
            margin: 0;
            color: #2c3e50;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close {
            color: #6c757d;
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
            max-height: calc(95vh - 120px);
        }

        /* Responsive Modal Styles */
        @media (max-width: 768px) {
            .modal-content {
                width: 98%;
                margin: 1% auto;
                max-height: 98vh;
                border-radius: 12px;
            }
            
            .modal-body {
                padding: 1.5rem;
                max-height: calc(98vh - 100px);
            }
            
            .modal-header {
                padding: 1rem 1.5rem;
            }
            
            .modal-title {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                width: 100%;
                margin: 0;
                height: 100vh;
                border-radius: 0;
                max-height: 100vh;
            }
            
            .modal-body {
                padding: 1rem;
                max-height: calc(100vh - 80px);
            }
            
            .modal-header {
                padding: 0.75rem 1rem;
            }
        }

        /* Action Button Styles */
        .action-btn {
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-success:hover {
            background: #218838 !important;
        }

        .btn-primary:hover {
            background: #0056b3 !important;
        }

        .btn-warning:hover {
            background: #e0a800 !important;
        }

        /* Company Status Styles */
        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* Top Navigation Header Styles */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: white;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
            position: relative;
            font-size: 1.2rem;
            color: #6c757d;
        }

        .notification-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #2c3e50;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .mark-all-read:hover {
            text-decoration: underline;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            overflow: hidden;
            width: 40px;
            height: 40px;
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            min-width: 180px;
        }

        .profile-dropdown ul {
            list-style: none;
            margin: 0;
            padding: 0.5rem 0;
        }

        .profile-dropdown li {
            margin: 0;
        }

        .profile-dropdown a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: #495057;
            transition: background-color 0.2s;
        }

        .profile-dropdown a:hover {
            background: #f8f9fa;
            color: #2c3e50;
        }

        .profile-dropdown i {
            width: 16px;
            font-size: 0.9rem;
        }

        /* Profile dropdown user info section */
        .profile-dropdown .user-info {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .profile-dropdown .user-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.2;
        }

        .profile-dropdown .user-email {
            color: #6c757d;
            font-size: 0.8rem;
            margin: 0;
            line-height: 1.2;
            word-break: break-word;
        }

        /* Enhanced profile button hover effect */
        .profile-btn:hover {
            transform: scale(1.05);
            transition: transform 0.2s ease;
        }

        .profile-btn img {
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        }

        .profile-btn:hover img {
            border-color: #007bff;
        }

        /* Company Features Styles */
        .company-features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .feature-stat-card {
            text-align: center;
            padding: 1rem;
            border-radius: 6px;
            transition: transform 0.2s ease;
        }

        .feature-stat-card:hover {
            transform: translateY(-2px);
        }

        .feature-stat-number {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .feature-stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .feature-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }

        .feature-item:hover {
            background: #ffffff;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.1);
        }

        .feature-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .feature-icon {
            color: #007bff;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .feature-details {
            flex: 1;
        }

        .feature-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .feature-description {
            font-size: 0.85rem;
            color: #6c757d;
            margin: 0;
        }

        .feature-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .feature-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 500;
        }

        .feature-pricing {
            text-align: right;
        }

        .feature-price {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .feature-price-label {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* Status colors */
        .status-active {
            background: #28a745;
        }

        .status-inactive {
            background: #6c757d;
        }

        .status-coming-soon {
            background: #ffc107;
            color: #212529;
        }

        .status-legacy {
            background: #856404;
        }

        /* Loading and empty states */
        .features-loading,
        .features-empty,
        .features-error {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 2rem;
            text-align: center;
        }

        .features-loading {
            color: #6c757d;
        }

        .features-empty {
            color: #6c757d;
        }

        .features-error {
            color: #dc3545;
        }

        .features-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .features-scrollable {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.5rem;
        }

        .features-scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .features-scrollable::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .features-scrollable::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .features-scrollable::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Feature Card Styles - Matching companymanagement.html */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .feature-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: white;
        }

        .feature-card:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .feature-card.selected {
            border-color: #3498db;
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.05) 0%, rgba(52, 152, 219, 0.05) 100%);
        }

        .feature-card.selected::before {
            content: "✓";
            position: absolute;
            top: -10px;
            right: -10px;
            background: #28a745;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .feature-card .feature-icon {
            font-size: 2.5rem;
            color: #3498db;
            margin-bottom: 1rem;
        }

        .feature-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .feature-card .feature-description {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .feature-cost {
            font-size: 0.85rem;
            color: #007bff;
            font-weight: 600;
            background: #f0f8ff;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            display: inline-block;
        }

        .subscribed-indicator {
            position: absolute;
            bottom: 12px;
            left: 12px;
            font-size: 0.75rem;
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .subscribed-indicator i {
            font-size: 0.7rem;
        }

        /* Status colors for feature cards */
        .feature-card .status-active {
            color: #28a745;
        }

        .feature-card .status-inactive {
            color: #6c757d;
        }

        .feature-card .status-coming-soon {
            color: #ffc107;
        }

        .feature-card .status-legacy {
            color: #fd7e14;
        }
    </style>
    <!-- GitHub Pages Fix Script -->
    <script src="github-pages-fix.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li data-feature="home_view" data-requires-permission="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li data-feature="dashboard_view" data-requires-permission="dashboard_view"><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li data-feature="charts_view" data-requires-permission="charts_view"><a href="chartboard.html"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> Human Capital</a>
                    <ul class="submenu">
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="recruitment_view" data-requires-permission="recruitment_view"><a href="recruitboard.html">Recruitment</a></li>
                        <li data-feature="kpi_management_view" data-requires-permission="kpi_management_view"><a href="kpi.html">KPI Management</a></li>
                        <li data-feature="onboarding_management_view" data-requires-permission="onboarding_management_view"><a href="onboard.html">Employee Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="training_management_view" data-requires-permission="training_management_view"><a href="trainingboard.html">Training Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                        <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                        <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                        <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                        <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="secur.html">Security Site Map</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view"><a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                        <li data-feature="fuel_management_view" data-requires-permission="fuel_management_view"><a href="fuelanalys.html">Fuel Management</a></li>
                        <li data-feature="vessel_view" data-requires-permission="vessel_view"><a href="vessel.html">Vessel Management</a></li>
                        <li data-feature="waste_view" data-requires-permission="waste_view"><a href="wasteboard.html">Waste Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="dms_view" data-requires-permission="dms_view">
                    <a href="#"><i class="fas fa-file-alt"></i> Document Management</a>
                    <ul class="submenu">
                        <li data-feature="dms_view" data-requires-permission="dms_view"><a href="dmstable.html">Document Register</a></li>
                        <li data-feature="dms_edit_view" data-requires-permission="dms_edit_view"><a href="dmsedit.html">Document Editor</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="camp_view" data-requires-permission="camp_view">
                    <a href="#"><i class="fas fa-building"></i> Camp Management</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Accommodation</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="super_admin_view" data-requires-permission="super_admin_view"><a href="super-admin-dashboard.html" class="active">Super Admin Dashboard</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html">Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-crown"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header">Super Admin Dashboard</span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="assets/default-avatar.png" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <div style="padding: 0.75rem 1rem; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">
                                <div style="font-weight: 600; color: #2c3e50; font-size: 0.9rem;" id="userDisplayName">Super Admin</div>
                                <div style="color: #6c757d; font-size: 0.8rem;" id="userDisplayEmail">admin@dreamexdatalab.com</div>
                            </div>
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="preferences.html"><i class="fas fa-cog"></i> Preferences</a></li>
                                <li style="border-top: 1px solid #e9ecef; margin-top: 0.5rem; padding-top: 0.5rem;">
                                    <a href="#" onclick="logout()" style="color: #dc3545;">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Super Admin Content -->
            <div class="super-admin-container">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="fas fa-crown"></i>
                        Super Admin Dashboard
                    </h1>
                    <p class="page-subtitle">Global Company Management Portal</p>
                    
                    <div class="stats-bar">
                        <div class="stat-item">
                            <i class="fas fa-building"></i>
                            <span>Total Companies:</span>
                            <span class="stat-number" id="totalCompanies">0</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-users"></i>
                            <span>Total Users:</span>
                            <span class="stat-number" id="totalUsers">0</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-chart-line"></i>
                            <span>Active:</span>
                            <span class="stat-number" id="activeCompanies">0</span>
                        </div>
                        <div class="stat-item">
                            <i class="fas fa-user"></i>
                            <span>Admin:</span>
                            <span class="stat-number" id="adminEmailDisplay" style="background: #28a745; font-size: 0.7rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">syllaoussein@yahoo.fr</span>
                        </div>
                    </div>
                </div>

                <!-- Controls Section -->
                <div class="controls-section">
                    <div class="search-export-row">
                        <div class="search-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" id="searchInput" placeholder="Search companies by name, admin email, or industry...">
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="debugData()">
                                <i class="fas fa-bug"></i>
                                Debug Data
                            </button>
                            <button class="btn" style="background: #28a745; color: white;" onclick="testFirebaseConnection()">
                                <i class="fas fa-database"></i>
                                Test Firebase
                            </button>
                            <button class="btn btn-success" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Content Tabs Layout -->
                <div class="content-tabs">
                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <button class="tab-nav-btn active" id="companiesTabBtn" onclick="switchToTab('companies')">
                            <i class="fas fa-building"></i>
                            Companies
                        </button>
                        <button class="tab-nav-btn" id="usersTabBtn" onclick="switchToTab('users')">
                            <i class="fas fa-users"></i>
                            Users
                        </button>
                        <button class="tab-nav-btn" id="featuresTabBtn" onclick="switchToTab('features')">
                            <i class="fas fa-puzzle-piece"></i>
                            Features
                        </button>
                        <button class="tab-nav-btn" id="archivesTabBtn" onclick="switchToTab('archives')">
                            <i class="fas fa-archive"></i>
                            Archives
                        </button>
                    </div>

                    <!-- Companies Tab Content -->
                    <div class="tab-content active" id="companiesTabContent">
                        <!-- Companies Table -->
                        <div id="companiesTableContainer" class="companies-table-container" style="display: none;">
                            <table class="companies-table">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Admin Email</th>
                                        <th>Industry</th>
                                        <th>Status</th>
                                        <th>Users</th>
                                        <th>User Quota</th>
                                        <th>Subscription</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="companiesTableBody">
                                    <!-- Table rows will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Loading State -->
                        <div id="loadingState" class="loading-container">
                            <div class="loading-spinner"></div>
                            <p>Loading companies...</p>
                        </div>

                        <!-- Empty State -->
                        <div id="emptyState" class="empty-state" style="display: none;">
                            <div class="empty-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <h3>No Companies Found</h3>
                            <p>No companies match your current search criteria.</p>
                        </div>
                    </div>

                    <!-- Users Tab Content -->
                    <div class="tab-content" id="usersTabContent">
                        <!-- Company Info Header -->
                        <div id="companyInfoHeader" class="company-info-header" style="display: none;">
                            <div>
                                <h3 class="company-info-title" id="selectedCompanyName">Company Users</h3>
                                <p style="margin: 0; color: #6c757d; font-size: 0.9rem;" id="selectedCompanyEmail"></p>
                            </div>
                            <button class="back-to-companies" onclick="switchToTab('companies')">
                                <i class="fas fa-arrow-left"></i>
                                Back to Companies
                            </button>
                        </div>

                        <!-- Users Table -->
                        <div id="usersTableContainer" class="users-table-container" style="display: none;">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Department</th>
                                        <th>Last Login</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- User rows will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Users Loading State -->
                        <div id="usersLoadingState" class="loading-container" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Loading users...</p>
                        </div>

                        <!-- Users Empty State -->
                        <div id="usersEmptyState" class="empty-state" style="display: none;">
                            <div class="empty-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3>No Users Found</h3>
                            <p>No users found for the selected company or no company selected.</p>
                        </div>

                        <!-- No Company Selected State -->
                        <div id="noCompanySelectedState" class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-hand-pointer"></i>
                            </div>
                            <h3>Select a Company</h3>
                            <p>Click on a company from the Companies tab to view its users.</p>
                        </div>
                    </div>

                    <!-- Features Tab Content -->
                    <div class="tab-content" id="featuresTabContent">
                        <div class="controls-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="margin: 0; color: #2c3e50;">
                                    <i class="fas fa-puzzle-piece"></i>
                                    Platform Features Management
                                </h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn" style="background: #28a745; color: white;" onclick="resetSidebarMenuVisibility()" title="Reset Menu Visibility">
                                        <i class="fas fa-eye"></i>
                                        Show All Menu
                                    </button>
                                    <button class="btn" style="background: #17a2b8; color: white;" onclick="applyAllFeaturesMenuVisibility()" title="Apply Feature Menu Rules">
                                        <i class="fas fa-sync"></i>
                                        Apply Menu Rules
                                    </button>
                                    <button class="btn btn-primary" onclick="showAddFeatureModal()">
                                        <i class="fas fa-plus"></i>
                                        Add Feature
                                    </button>
                                </div>
                            </div>
                            <p style="color: #6c757d; margin: 0;">Create and manage platform features that will be available for companies during registration and on the main platform.</p>
                        </div>

                        <!-- Features Table -->
                        <div id="featuresTableContainer" class="companies-table-container">
                            <table class="companies-table" id="featuresTable">
                                <thead>
                                    <tr>
                                        <th>Feature Name</th>
                                        <th>Description</th>
                                        <th>Icon</th>
                                        <th>Price (per user/month)</th>
                                        <th>Category</th>
                                        <th>Status</th>
                                        <th>Created Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="featuresTableBody">
                                    <!-- Features will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Features Loading State -->
                        <div id="featuresLoadingState" class="loading-container" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Loading features...</p>
                        </div>

                        <!-- Features Empty State -->
                        <div id="featuresEmptyState" class="empty-state" style="display: none;">
                            <div class="empty-icon">
                                <i class="fas fa-puzzle-piece"></i>
                            </div>
                            <h3>No Features Found</h3>
                            <p>No platform features have been created yet. Click "Add Feature" to create the first feature.</p>
                        </div>
                    </div>

                    <!-- Archives Tab Content -->
                    <div class="tab-content" id="archivesTabContent">
                        <div class="controls-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h3 style="margin: 0; color: #2c3e50;">
                                    <i class="fas fa-archive"></i>
                                    Archived Companies
                                </h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-success" onclick="loadArchivedCompanies()" title="Refresh Archives">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh
                                    </button>
                                    <button class="btn" style="background: #17a2b8; color: white;" onclick="debugArchivesData()" title="Debug Archives Data">
                                        <i class="fas fa-bug"></i>
                                        Debug
                                    </button>
                                    <button class="btn" style="background: #6f42c1; color: white;" onclick="testFirebaseArchivedCompanies()" title="Test Firebase Connection">
                                        <i class="fas fa-database"></i>
                                        Test DB
                                    </button>
                                    <button class="btn" style="background: #fd7e14; color: white;" onclick="createSampleArchivedCompanies()" title="Create Sample Data for Testing">
                                        <i class="fas fa-plus-circle"></i>
                                        Sample Data
                                    </button>
                                    <button class="btn btn-primary" onclick="clearAllArchives()">
                                        <i class="fas fa-trash-alt"></i>
                                        Clear All Archives
                                    </button>
                                </div>
                            </div>
                            <p style="color: #6c757d; margin: 0 0 1rem 0;">Companies that have been deleted are stored here. You can restore them or permanently delete them from the archives.</p>
                            
                            <!-- Search for archived companies -->
                            <div class="search-export-row">
                                <div class="search-wrapper">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" 
                                           id="archivesSearchInput" 
                                           class="search-input" 
                                           placeholder="Search archived companies by name, email, or industry..." 
                                           onkeyup="filterArchivedCompanies()">
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn" style="background: #6c757d; color: white;" onclick="exportArchivedCompanies()" title="Export Archives Data">
                                        <i class="fas fa-download"></i>
                                        Export
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Archives Table -->
                        <div id="archivesTableContainer" class="companies-table-container">
                            <table class="companies-table" id="archivesTable">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Admin Email</th>
                                        <th>Industry</th>
                                        <th>Users Count</th>
                                        <th>Subscription</th>
                                        <th>Archived Date</th>
                                        <th>Archived By</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="archivesTableBody">
                                    <!-- Archived companies will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Archives Loading State -->
                        <div id="archivesLoadingState" class="loading-container" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>Loading archived companies...</p>
                        </div>

                        <!-- Archives Empty State -->
                        <div id="archivesEmptyState" class="empty-state" style="display: none;">
                            <div class="empty-icon">
                                <i class="fas fa-archive"></i>
                            </div>
                            <h3>No Archived Companies</h3>
                            <p>No companies have been archived yet. Deleted companies will appear here for restoration.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Company Details Modal -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Company Details</h3>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Company details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Delete Company Confirmation Modal -->
    <div id="deleteCompanyModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #ff9500;">
                    <i class="fas fa-archive"></i>
                    Archive Company
                </h3>
                <button class="close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <p style="font-weight: 600; margin-bottom: 1rem;">You are about to archive:</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #ff9500;">
                        <strong id="deleteCompanyName"></strong>
                    </div>
                </div>
                
                <div style="background: #e6f3ff; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #0c5460; margin: 0 0 0.5rem 0;">
                        <i class="fas fa-info-circle"></i> Archive Information
                    </h4>
                    <p style="margin: 0; color: #0c5460;">This action will:</p>
                    <ul style="margin: 0.5rem 0 0 1rem; color: #0c5460;">
                        <li>Move company to Archives (can be restored later)</li>
                        <li>Temporarily disable all company users</li>
                        <li>Preserve all company data and documents</li>
                        <li><strong>Company can be restored from Archives tab</strong></li>
                    </ul>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label for="deleteConfirmationInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Type "DELETE" to confirm archiving:
                    </label>
                    <input type="text" id="deleteConfirmationInput" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #ff9500; border-radius: 6px; font-size: 1rem;"
                           placeholder="Type DELETE in capital letters"
                           autocomplete="off"
                           spellcheck="false">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeDeleteModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button id="confirmDeleteBtn" onclick="confirmDeleteCompany()" 
                            style="padding: 0.75rem 1.5rem; border: none; background: #ff9500; color: white; border-radius: 6px; cursor: pointer;" 
                            disabled>
                        <i class="fas fa-archive"></i>
                        Archive Company
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div id="deleteUserModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #dc3545;">
                    <i class="fas fa-user-times"></i>
                    Delete User
                </h3>
                <button class="close" onclick="closeDeleteUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <p style="font-weight: 600; margin-bottom: 1rem;">You are about to permanently delete:</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <strong id="deleteUserName"></strong>
                        <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;" id="deleteUserEmail"></div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #856404; margin: 0 0 0.5rem 0;">
                        <i class="fas fa-warning"></i> Warning
                    </h4>
                    <p style="margin: 0; color: #856404;">This action will permanently:</p>
                    <ul style="margin: 0.5rem 0 0 1rem; color: #856404;">
                        <li>Delete the user account</li>
                        <li>Remove all user data and settings</li>
                        <li>Revoke all access permissions</li>
                        <li><strong>This action cannot be undone!</strong></li>
                    </ul>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label for="deleteUserConfirmationInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Type "DELETE" to confirm:
                    </label>
                    <input type="text" id="deleteUserConfirmationInput" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #dc3545; border-radius: 6px; font-size: 1rem;"
                           placeholder="Type DELETE in capital letters"
                           autocomplete="off"
                           spellcheck="false">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeDeleteUserModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button id="confirmDeleteUserBtn" onclick="confirmDeleteUser()" 
                            style="padding: 0.75rem 1.5rem; border: none; background: #dc3545; color: white; border-radius: 6px; cursor: pointer;" 
                            disabled>
                        <i class="fas fa-trash"></i>
                        Delete User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Quota Management Modal -->
    <div id="quotaManagementModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #17a2b8;">
                    <i class="fas fa-users"></i>
                    Manage Company Quota
                </h3>
                <button class="close" onclick="closeQuotaModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0;" id="quotaCompanyName">Company Name</h4>
                    <p style="color: #6c757d; margin: 0;" id="quotaCompanyId">Company ID</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-weight: 600; color: #495057; display: block; margin-bottom: 0.5rem;">Current Users:</label>
                            <span style="font-size: 1.5rem; font-weight: 600; color: #28a745;" id="quotaCurrentUsers">0</span>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: #495057; display: block; margin-bottom: 0.5rem;">Current Quota:</label>
                            <span style="font-size: 1.5rem; font-weight: 600; color: #007bff;" id="quotaCurrentLimit">0</span>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label for="newQuotaInput" style="display: block; font-weight: 600; margin-bottom: 0.5rem;">
                        New Quota Limit:
                    </label>
                    <input type="number" 
                           id="newQuotaInput" 
                           min="0" 
                           max="10000"
                           style="width: 100%; padding: 0.75rem; border: 2px solid #ced4da; border-radius: 6px; font-size: 1rem;"
                           placeholder="Enter new quota limit (0 for unlimited)">
                    <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
                        Enter 0 for unlimited users, or specify a maximum number of users allowed.
                    </small>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeQuotaModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="updateCompanyQuota()" 
                            style="padding: 0.75rem 1.5rem; border: none; background: #17a2b8; color: white; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-save"></i>
                        Update Quota
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Feature Modal -->
    <div id="addFeatureModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-plus"></i>
                    Add New Feature
                </h3>
                <button class="close" onclick="closeFeatureModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addFeatureForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Feature Name</label>
                            <input type="text" id="featureName" name="featureName" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" 
                                   placeholder="e.g., Logistics Management" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Price (per user/month)</label>
                            <input type="number" id="featurePrice" name="featurePrice" step="0.01" min="0"
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" 
                                   placeholder="0.00" required>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description</label>
                        <textarea id="featureDescription" name="featureDescription" rows="3"
                                  style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px; resize: vertical;" 
                                  placeholder="Brief description of what this feature provides..." required></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Category</label>
                            <select id="featureCategory" name="featureCategory"
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" required>
                                <option value="">Select Category</option>
                                <option value="core">Core Functionality</option>
                                <option value="analytics">Analytics & Reporting</option>
                                <option value="communication">Communication</option>
                                <option value="integration">Integration</option>
                                <option value="security">Security</option>
                                <option value="productivity">Productivity</option>
                                <option value="management">Management</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Icon (FontAwesome class)</label>
                            <input type="text" id="featureIcon" name="featureIcon"
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" 
                                   placeholder="fas fa-truck" required>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Status</label>
                        <select id="featureStatus" name="featureStatus"
                                style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="coming-soon">Coming Soon</option>
                        </select>
                    </div>

                    <!-- Page Authorization Section -->
                    <div style="margin-bottom: 1.5rem; border-top: 1px solid #e9ecef; padding-top: 1.5rem;">
                        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: #2c3e50; font-size: 1.1rem;">
                                <i class="fas fa-shield-alt"></i>
                                Page Authorization
                            </h4>
                            <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                                <button type="button" onclick="selectAllAddPages()" 
                                        style="padding: 0.5rem 1rem; border: 1px solid #28a745; background: white; color: #28a745; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    Select All
                                </button>
                                <button type="button" onclick="deselectAllAddPages()" 
                                        style="padding: 0.5rem 1rem; border: 1px solid #dc3545; background: white; color: #dc3545; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    Deselect All
                                </button>
                            </div>
                        </div>
                        <p style="color: #6c757d; font-size: 0.9rem; margin-bottom: 1rem;">
                            Select which pages/modules will be accessible when this feature is enabled for a company.
                        </p>
                        
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 6px; padding: 1rem; background: #f8f9fa;">
                            <!-- Core Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-home"></i> Core Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="home_view">
                                        <span style="font-size: 0.9rem;">Home</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="dashboard_view">
                                        <span style="font-size: 0.9rem;">Dashboard</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="charts_view">
                                        <span style="font-size: 0.9rem;">Analytics</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Health Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-medkit"></i> Health Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="health_view">
                                        <span style="font-size: 0.9rem;">Health</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="health_assessment_view">
                                        <span style="font-size: 0.9rem;">Health Assessment</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="health_consultation_view">
                                        <span style="font-size: 0.9rem;">Health Consultation</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="medical_folder_view">
                                        <span style="font-size: 0.9rem;">Medical Folder</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Safety Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-shield-alt"></i> Safety Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="safety_view">
                                        <span style="font-size: 0.9rem;">Safety</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="training_view">
                                        <span style="font-size: 0.9rem;">Training</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="risk_view">
                                        <span style="font-size: 0.9rem;">Risk Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="jsa_view">
                                        <span style="font-size: 0.9rem;">Job Safety Analysis</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="ptw_view">
                                        <span style="font-size: 0.9rem;">Permit to Work</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="incident_view">
                                        <span style="font-size: 0.9rem;">Incident Reports</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="inspection_view">
                                        <span style="font-size: 0.9rem;">Inspection</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="audit_view">
                                        <span style="font-size: 0.9rem;">Audit</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="audit_log_view">
                                        <span style="font-size: 0.9rem;">Audit Log</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Environment Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-leaf"></i> Environment Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="environment_view">
                                        <span style="font-size: 0.9rem;">Environment</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="water_view">
                                        <span style="font-size: 0.9rem;">Water Quality</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Security Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-lock"></i> Security Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="security_view">
                                        <span style="font-size: 0.9rem;">Security</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="access_view">
                                        <span style="font-size: 0.9rem;">Access Request</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="access_daily_view">
                                        <span style="font-size: 0.9rem;">Daily Access Control</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="removal_view">
                                        <span style="font-size: 0.9rem;">Property Removal</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="security_site_map_view">
                                        <span style="font-size: 0.9rem;">Security Site Map</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Logistics Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-truck"></i> Logistics Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="logistics_view">
                                        <span style="font-size: 0.9rem;">Logistics</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="fleet_view">
                                        <span style="font-size: 0.9rem;">Fleet Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="fuel_management_view">
                                        <span style="font-size: 0.9rem;">Fuel Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="vessel_view">
                                        <span style="font-size: 0.9rem;">Vessel Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="waste_view">
                                        <span style="font-size: 0.9rem;">Waste Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="travel_view">
                                        <span style="font-size: 0.9rem;">Travel Requests</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="lms_view">
                                        <span style="font-size: 0.9rem;">Learning Management System</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Document Management Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-file-alt"></i> Document Management Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="dms_view">
                                        <span style="font-size: 0.9rem;">Document Register</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="dms_edit_view">
                                        <span style="font-size: 0.9rem;">Document Editor</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Accommodation Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-bed"></i> Accommodation Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="accommodation_view">
                                        <span style="font-size: 0.9rem;">Accommodation Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="camp_view">
                                        <span style="font-size: 0.9rem;">Camp Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="camp_settings_view">
                                        <span style="font-size: 0.9rem;">Camp Settings</span>
                                    </label>
                                </div>
                            </div>

                            <!-- HR Management Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-users"></i> HR Management Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="hr_view">
                                        <span style="font-size: 0.9rem;">HR Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="staff_management_view">
                                        <span style="font-size: 0.9rem;">Staff Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="salary_management_view">
                                        <span style="font-size: 0.9rem;">Salary Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="authority_to_recruit_view">
                                        <span style="font-size: 0.9rem;">Authority to Recruit</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="job_advertising_view">
                                        <span style="font-size: 0.9rem;">Job Advertising</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="screening_view">
                                        <span style="font-size: 0.9rem;">Screening</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="interview_view">
                                        <span style="font-size: 0.9rem;">Interview</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="hiring_view">
                                        <span style="font-size: 0.9rem;">Hiring Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="offer_view">
                                        <span style="font-size: 0.9rem;">Offer Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="contract_view">
                                        <span style="font-size: 0.9rem;">Contract Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="onboarding_view">
                                        <span style="font-size: 0.9rem;">Onboarding</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="chart_view">
                                        <span style="font-size: 0.9rem;">HR Charts</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="chartboard_view">
                                        <span style="font-size: 0.9rem;">HR Chart Board</span>
                                    </label>
                                </div>
                            </div>

                            <!-- KPI Management Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-chart-line"></i> KPI Management Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="kpi_view">
                                        <span style="font-size: 0.9rem;">KPI Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="kpi_create_view">
                                        <span style="font-size: 0.9rem;">Create KPI</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="kpi_dashboard_view">
                                        <span style="font-size: 0.9rem;">KPI Dashboard</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Project Management Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-project-diagram"></i> Project Management Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="project_management_view">
                                        <span style="font-size: 0.9rem;">Project Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="project_dashboard_view">
                                        <span style="font-size: 0.9rem;">Project Dashboard</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="project_create_view">
                                        <span style="font-size: 0.9rem;">Create Projects</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="project_list_view">
                                        <span style="font-size: 0.9rem;">Project List</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="task_management_view">
                                        <span style="font-size: 0.9rem;">Task Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="milestone_tracking_view">
                                        <span style="font-size: 0.9rem;">Milestone Tracking</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="resource_allocation_view">
                                        <span style="font-size: 0.9rem;">Resource Allocation</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="project_reports_view">
                                        <span style="font-size: 0.9rem;">Project Reports</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="gantt_chart_view">
                                        <span style="font-size: 0.9rem;">Gantt Chart</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Settings Module -->
                            <div style="margin-bottom: 0;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-cog"></i> Settings Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="settings_view">
                                        <span style="font-size: 0.9rem;">Settings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="profile_view">
                                        <span style="font-size: 0.9rem;">Profile</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="account_settings_view">
                                        <span style="font-size: 0.9rem;">Account Settings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="company_management_view">
                                        <span style="font-size: 0.9rem;">Company Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="approval_settings_view">
                                        <span style="font-size: 0.9rem;">Approval Flow Settings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="field_setup_view">
                                        <span style="font-size: 0.9rem;">Field Setup</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="preferences_view">
                                        <span style="font-size: 0.9rem;">Preferences</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="notification_settings_view">
                                        <span style="font-size: 0.9rem;">Notification Settings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="user_management_view">
                                        <span style="font-size: 0.9rem;">User Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="add-page-checkbox" data-feature="role_permissions_view">
                                        <span style="font-size: 0.9rem;">Role Permissions</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeFeatureModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="saveFeature()" 
                            style="padding: 0.75rem 1.5rem; border: none; background: #007bff; color: white; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-save"></i>
                        Save Feature
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Feature Modal -->
    <div id="editFeatureModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-edit"></i>
                    Edit Feature
                </h3>
                <button class="close" onclick="closeEditFeatureModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editFeatureForm">
                    <input type="hidden" id="editFeatureId" name="featureId">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Feature Name</label>
                            <input type="text" id="editFeatureName" name="featureName" 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" 
                                   placeholder="e.g., Logistics Management" required>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Price (per user/month)</label>
                            <input type="number" id="editFeaturePrice" name="featurePrice" step="0.01" min="0"
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" 
                                   placeholder="0.00" required>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description</label>
                        <textarea id="editFeatureDescription" name="featureDescription" rows="3"
                                  style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px; resize: vertical;" 
                                  placeholder="Brief description of what this feature provides..." required></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Category</label>
                            <select id="editFeatureCategory" name="featureCategory"
                                    style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" required>
                                <option value="">Select Category</option>
                                <option value="core">Core Functionality</option>
                                <option value="analytics">Analytics & Reporting</option>
                                <option value="communication">Communication</option>
                                <option value="integration">Integration</option>
                                <option value="security">Security</option>
                                <option value="productivity">Productivity</option>
                                <option value="management">Management</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Icon (FontAwesome class)</label>
                            <input type="text" id="editFeatureIcon" name="featureIcon"
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" 
                                   placeholder="fas fa-truck" required>
                        </div>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Status</label>
                        <select id="editFeatureStatus" name="featureStatus"
                                style="width: 100%; padding: 0.75rem; border: 1px solid #ced4da; border-radius: 6px;" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="coming-soon">Coming Soon</option>
                        </select>
                    </div>

                    <!-- Page Authorization Section -->
                    <div style="margin-bottom: 1.5rem; border-top: 1px solid #e9ecef; padding-top: 1.5rem;">
                        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: #2c3e50; font-size: 1.1rem;">
                                <i class="fas fa-shield-alt"></i>
                                Page Authorization
                            </h4>
                            <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                                <button type="button" onclick="selectAllPages()" 
                                        style="padding: 0.5rem 1rem; border: 1px solid #28a745; background: white; color: #28a745; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    Select All
                                </button>
                                <button type="button" onclick="deselectAllPages()" 
                                        style="padding: 0.5rem 1rem; border: 1px solid #dc3545; background: white; color: #dc3545; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    Deselect All
                                </button>
                            </div>
                        </div>
                        <p style="color: #6c757d; font-size: 0.9rem; margin-bottom: 1rem;">
                            Select which menu permissions will be accessible when this feature is enabled for a company.
                        </p>
                        
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 6px; padding: 1rem; background: #f8f9fa;">
                            <!-- Core Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-home"></i> Core Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="home_view">
                                        <span style="font-size: 0.9rem;">Home</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="dashboard_view">
                                        <span style="font-size: 0.9rem;">Dashboard</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="charts_view">
                                        <span style="font-size: 0.9rem;">Analytics</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Health Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-medkit"></i> Health Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="health_view">
                                        <span style="font-size: 0.9rem;">Health</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="health_assessment_view">
                                        <span style="font-size: 0.9rem;">Health Assessment</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="health_consultation_view">
                                        <span style="font-size: 0.9rem;">Health Consultation</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="medical_folder_view">
                                        <span style="font-size: 0.9rem;">Medical Folder</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Safety Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-shield-alt"></i> Safety Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="safety_view">
                                        <span style="font-size: 0.9rem;">Safety</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="training_view">
                                        <span style="font-size: 0.9rem;">Training</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="risk_view">
                                        <span style="font-size: 0.9rem;">Risk Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="jsa_view">
                                        <span style="font-size: 0.9rem;">Job Safety Analysis</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="ptw_view">
                                        <span style="font-size: 0.9rem;">Permit to Work</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="incident_view">
                                        <span style="font-size: 0.9rem;">Incident Reports</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="inspection_view">
                                        <span style="font-size: 0.9rem;">Inspection</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="audit_view">
                                        <span style="font-size: 0.9rem;">Audit</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="audit_log_view">
                                        <span style="font-size: 0.9rem;">Audit Log</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Environment Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-leaf"></i> Environment Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="environment_view">
                                        <span style="font-size: 0.9rem;">Environment</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="water_view">
                                        <span style="font-size: 0.9rem;">Water Quality</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Security Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-lock"></i> Security Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="security_view">
                                        <span style="font-size: 0.9rem;">Security</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="access_view">
                                        <span style="font-size: 0.9rem;">Access Request</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="access_daily_view">
                                        <span style="font-size: 0.9rem;">Daily Access Control</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="removal_view">
                                        <span style="font-size: 0.9rem;">Property Removal</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="security_site_map_view">
                                        <span style="font-size: 0.9rem;">Security Site Map</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Logistics Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-truck"></i> Logistics Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="logistics_view">
                                        <span style="font-size: 0.9rem;">Logistics</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="fleet_view">
                                        <span style="font-size: 0.9rem;">Fleet Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="fuel_management_view">
                                        <span style="font-size: 0.9rem;">Fuel Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="vessel_view">
                                        <span style="font-size: 0.9rem;">Vessel Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="waste_view">
                                        <span style="font-size: 0.9rem;">Waste Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="travel_view">
                                        <span style="font-size: 0.9rem;">Travel Requests</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="lms_view">
                                        <span style="font-size: 0.9rem;">Learning Management System</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Document Management Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-file-alt"></i> Document Management Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="dms_view">
                                        <span style="font-size: 0.9rem;">Document Register</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="dms_edit_view">
                                        <span style="font-size: 0.9rem;">Document Editor</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Accommodation Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-bed"></i> Accommodation Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="accommodation_view">
                                        <span style="font-size: 0.9rem;">Accommodation Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="camp_view">
                                        <span style="font-size: 0.9rem;">Camp Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="camp_settings_view">
                                        <span style="font-size: 0.9rem;">Camp Settings</span>
                                    </label>
                                </div>
                            </div>

                            <!-- HR Management Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-users"></i> HR Management Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="hr_view">
                                        <span style="font-size: 0.9rem;">HR Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="staff_management_view">
                                        <span style="font-size: 0.9rem;">Staff Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="salary_management_view">
                                        <span style="font-size: 0.9rem;">Salary Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="authority_to_recruit_view">
                                        <span style="font-size: 0.9rem;">Authority to Recruit</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="job_advertising_view">
                                        <span style="font-size: 0.9rem;">Job Advertising</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="screening_view">
                                        <span style="font-size: 0.9rem;">Screening</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="interview_view">
                                        <span style="font-size: 0.9rem;">Interview</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="hiring_view">
                                        <span style="font-size: 0.9rem;">Hiring Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="offer_view">
                                        <span style="font-size: 0.9rem;">Offer Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="contract_view">
                                        <span style="font-size: 0.9rem;">Contract Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="onboarding_view">
                                        <span style="font-size: 0.9rem;">Onboarding</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="chart_view">
                                        <span style="font-size: 0.9rem;">HR Charts</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="chartboard_view">
                                        <span style="font-size: 0.9rem;">HR Chart Board</span>
                                    </label>
                                </div>
                            </div>

                            <!-- KPI Management Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-chart-line"></i> KPI Management Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="kpi_view">
                                        <span style="font-size: 0.9rem;">KPI Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="kpi_create_view">
                                        <span style="font-size: 0.9rem;">Create KPI</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="kpi_dashboard_view">
                                        <span style="font-size: 0.9rem;">KPI Dashboard</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Project Management Module -->
                            <div style="margin-bottom: 1.5rem;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-project-diagram"></i> Project Management Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="project_management_view">
                                        <span style="font-size: 0.9rem;">Project Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="project_dashboard_view">
                                        <span style="font-size: 0.9rem;">Project Dashboard</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="project_create_view">
                                        <span style="font-size: 0.9rem;">Create Projects</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="project_list_view">
                                        <span style="font-size: 0.9rem;">Project List</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="task_management_view">
                                        <span style="font-size: 0.9rem;">Task Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="milestone_tracking_view">
                                        <span style="font-size: 0.9rem;">Milestone Tracking</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="resource_allocation_view">
                                        <span style="font-size: 0.9rem;">Resource Allocation</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="project_reports_view">
                                        <span style="font-size: 0.9rem;">Project Reports</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="gantt_chart_view">
                                        <span style="font-size: 0.9rem;">Gantt Chart</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Settings Module -->
                            <div style="margin-bottom: 0;">
                                <h5 style="margin: 0 0 0.75rem 0; color: #495057; font-size: 0.95rem; font-weight: 600; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                    <i class="fas fa-cog"></i> Settings Module
                                </h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="settings_view">
                                        <span style="font-size: 0.9rem;">Settings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="profile_view">
                                        <span style="font-size: 0.9rem;">Profile</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="account_settings_view">
                                        <span style="font-size: 0.9rem;">Account Settings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="company_management_view">
                                        <span style="font-size: 0.9rem;">Company Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="approval_settings_view">
                                        <span style="font-size: 0.9rem;">Approval Flow Settings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="field_setup_view">
                                        <span style="font-size: 0.9rem;">Field Setup</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="preferences_view">
                                        <span style="font-size: 0.9rem;">Preferences</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="notification_settings_view">
                                        <span style="font-size: 0.9rem;">Notification Settings</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="user_management_view">
                                        <span style="font-size: 0.9rem;">User Management</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.25rem;">
                                        <input type="checkbox" class="page-checkbox" data-feature="role_permissions_view">
                                        <span style="font-size: 0.9rem;">Role Permissions</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeEditFeatureModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="updateFeature()" 
                            style="padding: 0.75rem 1.5rem; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-save"></i>
                        Update Feature
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Feature Confirmation Modal -->
    <div id="deleteFeatureModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #dc3545;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Delete Feature
                </h3>
                <button class="close" onclick="closeDeleteFeatureModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <p style="font-weight: 600; margin-bottom: 1rem;">You are about to permanently delete:</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <strong id="deleteFeatureName"></strong>
                        <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;" id="deleteFeatureDescription"></div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #856404; margin: 0 0 0.5rem 0;">
                        <i class="fas fa-warning"></i> Warning
                    </h4>
                    <p style="color: #856404; margin: 0;">This action cannot be undone. The feature will be removed from all company plans and will no longer be available for selection.</p>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Type "DELETE" to confirm:</p>
                    <input type="text" id="deleteFeatureConfirmationInput" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #dc3545; border-radius: 6px; font-weight: 600;" 
                           placeholder="Type DELETE here">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeDeleteFeatureModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button id="confirmDeleteFeatureBtn" onclick="confirmDeleteFeature()" disabled
                            style="padding: 0.75rem 1.5rem; border: none; background: #6c757d; color: white; border-radius: 6px; cursor: not-allowed;">
                        <i class="fas fa-trash"></i>
                        Delete Feature
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Restore Company Confirmation Modal -->
    <div id="restoreCompanyModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #28a745;">
                    <i class="fas fa-undo"></i>
                    Restore Company
                </h3>
                <button class="close" onclick="closeRestoreModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <p style="font-weight: 600; margin-bottom: 1rem;">You are about to restore:</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                        <strong id="restoreCompanyName"></strong>
                        <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;" id="restoreCompanyEmail"></div>
                    </div>
                </div>
                
                <div style="background: #d1ecf1; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #0c5460; margin: 0 0 0.5rem 0;">
                        <i class="fas fa-info-circle"></i> Restoration Process
                    </h4>
                    <ul style="color: #0c5460; margin: 0; padding-left: 1.2rem;">
                        <li>Company data will be restored to the active companies list</li>
                        <li>All users and associated data will be reactivated</li>
                        <li>Previous subscription and quota settings will be restored</li>
                        <li>Company will be accessible immediately after restoration</li>
                    </ul>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeRestoreModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button id="confirmRestoreBtn" onclick="confirmRestoreCompany()"
                            style="padding: 0.75rem 1.5rem; border: none; background: #28a745; color: white; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-undo"></i>
                        Restore Company
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Permanent Delete Company Confirmation Modal -->
    <div id="permanentDeleteModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #dc3545;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Permanent Delete
                </h3>
                <button class="close" onclick="closePermanentDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem;">
                    <p style="font-weight: 600; margin-bottom: 1rem;">You are about to permanently delete:</p>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <strong id="permanentDeleteCompanyName"></strong>
                        <div style="font-size: 0.9rem; color: #6c757d; margin-top: 0.25rem;" id="permanentDeleteCompanyEmail"></div>
                    </div>
                </div>
                
                <div style="background: #f8d7da; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #721c24; margin: 0 0 0.5rem 0;">
                        <i class="fas fa-skull-crossbones"></i> CRITICAL WARNING
                    </h4>
                    <ul style="color: #721c24; margin: 0; padding-left: 1.2rem; font-weight: 600;">
                        <li><strong>ALL COMPANY DATA WILL BE PERMANENTLY DESTROYED</strong></li>
                        <li>All user accounts and profiles will be deleted</li>
                        <li>All documents, files, and records will be lost</li>
                        <li>This action CANNOT be undone or reversed</li>
                        <li>The company will be completely removed from all systems</li>
                    </ul>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label for="permanentDeleteConfirmationInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Type "PERMANENT DELETE" to confirm:
                    </label>
                    <input type="text" id="permanentDeleteConfirmationInput" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #dc3545; border-radius: 6px; font-size: 1rem;"
                           placeholder="Type PERMANENT DELETE in capital letters"
                           autocomplete="off"
                           spellcheck="false">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closePermanentDeleteModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button id="confirmPermanentDeleteBtn" onclick="confirmPermanentDelete()" 
                            style="padding: 0.75rem 1.5rem; border: none; background: #dc3545; color: white; border-radius: 6px; cursor: pointer;" 
                            disabled>
                        <i class="fas fa-skull-crossbones"></i>
                        Permanent Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear All Archives Confirmation Modal -->
    <div id="clearArchivesModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #dc3545;">
                    <i class="fas fa-trash-alt"></i>
                    Clear All Archives
                </h3>
                <button class="close" onclick="closeClearArchivesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: #f8d7da; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #721c24; margin: 0 0 0.5rem 0;">
                        <i class="fas fa-exclamation-triangle"></i> WARNING
                    </h4>
                    <p style="color: #721c24; margin: 0; font-weight: 600;">
                        This will permanently delete ALL archived companies and their data. This action cannot be undone!
                    </p>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <label for="clearArchivesConfirmationInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        Type "CLEAR ALL" to confirm:
                    </label>
                    <input type="text" id="clearArchivesConfirmationInput" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #dc3545; border-radius: 6px; font-size: 1rem;"
                           placeholder="Type CLEAR ALL in capital letters"
                           autocomplete="off"
                           spellcheck="false">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeClearArchivesModal()" 
                            style="padding: 0.75rem 1.5rem; border: 1px solid #6c757d; background: white; color: #6c757d; border-radius: 6px; cursor: pointer;">
                        Cancel
                    </button>
                    <button id="confirmClearArchivesBtn" onclick="confirmClearAllArchives()" 
                            style="padding: 0.75rem 1.5rem; border: none; background: #dc3545; color: white; border-radius: 6px; cursor: pointer;" 
                            disabled>
                        <i class="fas fa-trash-alt"></i>
                        Clear All Archives
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <script>
        // Error notification function (defined early for use in initialization)
        function showErrorNotification(message) {
            // Remove any existing error notifications
            const existingNotification = document.querySelector('.error-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create error notification
            const notification = document.createElement('div');
            notification.className = 'error-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                    <i class="fas fa-exclamation-triangle" style="color: white; margin-top: 2px;"></i>
                    <div>
                        <strong>Error</strong><br>
                        ${message}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; margin-left: auto; padding: 0;">
                        &times;
                    </button>
                </div>
            `;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 10000);
        }

        // Firebase configuration (aligned with the rest of the app)
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Firebase and global variables
        let database;
        let companies = [];
        let filteredCompanies = [];
        let selectedCompany = null;
        let users = [];

        // Initialize Firebase
        if (typeof firebase === 'undefined') {
            console.error('Firebase SDK not loaded');
            document.addEventListener('DOMContentLoaded', function() {
                showErrorNotification('Firebase SDK failed to load. Please check your internet connection and refresh the page.');
            });
        } else {
            try {
                console.log('Initializing Firebase with config:', firebaseConfig);
                if (!firebase.apps || !firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                console.log('Firebase initialized successfully');
                console.log('Database instance created:', !!database);
                console.log('Database URL:', firebaseConfig.databaseURL);
                
                // Test database reference creation
                try {
                    const testRef = database.ref('/test');
                    console.log('Database reference created successfully');
                } catch (refError) {
                    console.error('Error creating database reference:', refError);
                }
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    name: error.name
                });
                document.addEventListener('DOMContentLoaded', function() {
                    showErrorNotification('Firebase initialization failed. Please refresh the page and try again.');
                });
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Add a small delay to ensure Firebase is fully loaded
            setTimeout(async () => {
                try {
                    checkSuperAdminAuth();
                    loadAuthenticatedUserAvatar();
                    
                    // Wait for Firebase auth to be ready before loading data
                    if (firebase && firebase.auth) {
                        await new Promise((resolve) => {
                            firebase.auth().onAuthStateChanged((user) => {
                                console.log('Auth state changed:', user ? user.uid : 'no user');
                                resolve();
                            });
                        });
                    }
                    
                    await loadDashboardData();
                    setupEventListeners();
                } catch (error) {
                    console.error('Error during page initialization:', error);
                    showErrorNotification('Failed to initialize dashboard. Please refresh the page.');
                }
            }, 500);
        });

        function checkSuperAdminAuth() {
            const superAdminSession = localStorage.getItem('superAdminSession');
            const isSuperAdmin = sessionStorage.getItem('isSuperAdmin');

            if (!superAdminSession || !isSuperAdmin) {
                window.location.href = 'adminlogin.html';
                return;
            }

            try {
                const sessionData = JSON.parse(superAdminSession);
                const loginTime = new Date(sessionData.timestamp);
                const currentTime = new Date();
                const hoursSinceLogin = (currentTime - loginTime) / (1000 * 60 * 60);

                // Session expires after 24 hours
                if (hoursSinceLogin >= 24) {
                    logout();
                    return;
                }
            } catch (error) {
                console.error('Error validating session:', error);
                logout();
            }
        }

        function setupEventListeners() {
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', filterCompanies);

            // Delete confirmation input validation
            document.getElementById('deleteConfirmationInput').addEventListener('input', function(event) {
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const inputValue = event.target.value;
                
                if (inputValue === 'DELETE') {
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = '#dc3545';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.background = '#6c757d';
                }
            });

            // Delete user confirmation input validation
            document.getElementById('deleteUserConfirmationInput').addEventListener('input', function(event) {
                const confirmBtn = document.getElementById('confirmDeleteUserBtn');
                const inputValue = event.target.value;
                
                if (inputValue === 'DELETE') {
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = '#dc3545';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.background = '#6c757d';
                }
            });

            // Delete feature confirmation input validation
            document.getElementById('deleteFeatureConfirmationInput').addEventListener('input', function(event) {
                const confirmBtn = document.getElementById('confirmDeleteFeatureBtn');
                const inputValue = event.target.value;
                
                if (inputValue === 'DELETE') {
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = '#dc3545';
                    confirmBtn.style.cursor = 'pointer';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.background = '#6c757d';
                    confirmBtn.style.cursor = 'not-allowed';
                }
            });

            // Permanent delete confirmation input validation
            document.getElementById('permanentDeleteConfirmationInput').addEventListener('input', function(event) {
                const confirmBtn = document.getElementById('confirmPermanentDeleteBtn');
                const inputValue = event.target.value;
                
                if (inputValue === 'PERMANENT DELETE') {
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = '#dc3545';
                    confirmBtn.style.cursor = 'pointer';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.background = '#6c757d';
                    confirmBtn.style.cursor = 'not-allowed';
                }
            });

            // Clear all archives confirmation input validation
            document.getElementById('clearArchivesConfirmationInput').addEventListener('input', function(event) {
                const confirmBtn = document.getElementById('confirmClearArchivesBtn');
                const inputValue = event.target.value;
                
                if (inputValue === 'CLEAR ALL') {
                    confirmBtn.disabled = false;
                    confirmBtn.style.background = '#dc3545';
                    confirmBtn.style.cursor = 'pointer';
                } else {
                    confirmBtn.disabled = true;
                    confirmBtn.style.background = '#6c757d';
                    confirmBtn.style.cursor = 'not-allowed';
                }
            });

            // Modal close on outside click
            window.onclick = function(event) {
                const modal = document.getElementById('companyModal');
                const deleteModal = document.getElementById('deleteCompanyModal');
                const deleteUserModal = document.getElementById('deleteUserModal');
                const restoreModal = document.getElementById('restoreCompanyModal');
                const permanentDeleteModal = document.getElementById('permanentDeleteModal');
                const clearArchivesModal = document.getElementById('clearArchivesModal');
                
                if (event.target === modal) {
                    closeModal();
                } else if (event.target === deleteModal) {
                    closeDeleteModal();
                } else if (event.target === deleteUserModal) {
                    closeDeleteUserModal();
                } else if (event.target === restoreModal) {
                    closeRestoreModal();
                } else if (event.target === permanentDeleteModal) {
                    closePermanentDeleteModal();
                } else if (event.target === clearArchivesModal) {
                    closeClearArchivesModal();
                }
            };

            // Escape key to close modal
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                    closeDeleteModal();
                    closeDeleteUserModal();
                }
            });
        }

        async function loadDashboardData() {
            try {
                showLoading(true);
                console.log('Starting to load companies data...');
                
                // Check if Firebase is initialized properly
                if (!firebase || !firebase.database || !database) {
                    console.error('Firebase not properly initialized');
                    throw new Error('Firebase is not properly initialized');
                }
                
                // Check and setup Firebase authentication FIRST
                if (firebase.auth) {
                    const currentUser = firebase.auth().currentUser;
                    console.log('Current Firebase user:', currentUser);
                    
                    if (!currentUser) {
                        console.log('No Firebase user authenticated, attempting authentication...');
                        try {
                            // Try anonymous authentication to access database
                            await firebase.auth().signInAnonymously();
                            console.log('Successfully authenticated with Firebase anonymously');
                        } catch (authError) {
                            console.error('Firebase authentication failed:', authError);
                            
                            // If anonymous auth fails, try REST API approach
                            console.log('Trying REST API fallback...');
                            const restUrl = `${firebaseConfig.databaseURL}/companies.json`;
                            const response = await fetch(restUrl);
                            
                            if (response.ok) {
                                const restData = await response.json();
                                console.log('REST API data received:', restData);
                                
                                if (restData && typeof restData === 'object') {
                                    const processedCompanies = Object.keys(restData).map(id => {
                                        const companyEntry = restData[id];
                                        let companyData = null;
                                        
                                        if (companyEntry && companyEntry.company) {
                                            companyData = companyEntry.company;
                                        } else if (typeof companyEntry === 'object' && companyEntry !== null) {
                                            companyData = companyEntry;
                                        }
                                        
                                        if (companyData) {
                                            return {
                                                id: id,
                                                name: companyData.name || 'Unknown Company',
                                                email: companyData.email || '',
                                                phone: companyData.phone || '',
                                                registrationDate: companyData.registrationDate || 'Unknown',
                                                status: companyData.status || 'pending',
                                                address: companyData.address || '',
                                                userCount: 0,
                                                isArchived: companyData.isArchived || false
                                            };
                                        }
                                        return null;
                                    }).filter(company => company !== null && !company.isArchived);
                                    
                                    companies = processedCompanies;
                                    filteredCompanies = [...companies];
                                    displayCompanies(filteredCompanies);
                                    updateStats();
                                    showLoading(false);
                                    
                                    showErrorNotification('Data loaded using fallback method. Firebase authentication failed.');
                                    return;
                                }
                            }
                            
                            throw new Error('Both Firebase authentication and REST API failed');
                        }
                    } else {
                        console.log('Firebase user already authenticated:', currentUser.uid);
                    }
                } else {
                    console.warn('Firebase Auth not available, trying without authentication...');
                }
                
                console.log('Firebase is initialized, attempting to load companies...');
                
                // Load companies data directly without connection test (which might be causing issues)
                console.log('Loading companies from /companies path...');
                const companiesSnapshot = await database.ref('/companies').once('value');
                const companiesData = companiesSnapshot.val();
                
                console.log('Raw companies data loaded:', companiesData);
                console.log('Companies data type:', typeof companiesData);
                console.log('Companies data keys:', companiesData ? Object.keys(companiesData) : 'null');
                
                if (!companiesData || typeof companiesData !== 'object') {
                    console.log('No companies data found or invalid data structure');
                    companies = [];
                } else {
                    // Handle the nested structure where data is under /companies/{id}/company/
                    const processedCompanies = Object.keys(companiesData).map(id => {
                        const companyEntry = companiesData[id];
                        
                        console.log(`Processing company ${id}:`, companyEntry);
                        
                        // Check if data is nested under a 'company' object
                        let companyData = null;
                        let adminData = null;
                        
                        if (companyEntry && companyEntry.company) {
                            companyData = companyEntry.company;
                            console.log(`Found nested company data for ${id}:`, companyData);
                        } else if (typeof companyEntry === 'object' && companyEntry !== null) {
                            companyData = companyEntry;
                            console.log(`Using direct company data for ${id}:`, companyData);
                        }
                        
                        // Get admin email from nested admin object
                        if (companyEntry && companyEntry.admin) {
                            adminData = companyEntry.admin;
                            console.log(`Admin data for company ${id}:`, adminData);
                        }
                        
                        if (companyData) {
                            const processedCompany = {
                                id: id,
                                name: companyData.companyName || companyData.name || 'Unnamed Company',
                                email: adminData ? (adminData.adminEmail || adminData.email) : (companyData.email || companyData.contactEmail || companyData.businessEmail || 'Not provided'),
                                phone: companyData.phone || companyData.contactPhone,
                                industry: companyData.industry || companyData.sector || companyData.businessType,
                                location: companyData.location || companyData.address,
                                status: companyData.status || 'pending',
                                userCount: companyData.userCount || companyData.users || companyData.totalUsers || 0,
                                userQuota: 0, // Will be fetched separately
                                subscription: companyEntry.selectedPlan || companyData.subscription || companyData.plan || 'Basic',
                                monthlyRevenue: companyData.monthlyRevenue || companyData.revenue || companyData.totalRevenue || 0,
                                createdAt: companyEntry.createdAt || companyData.createdAt || companyData.dateCreated || companyData.registrationDate,
                                lastActivity: companyData.lastActivity,
                                adminEmail: adminData ? (adminData.adminEmail || adminData.email) : null,
                                selectedPlan: companyEntry.selectedPlan,
                                ...companyData
                            };
                            
                            console.log(`Successfully processed company ${id}:`, processedCompany);
                            return processedCompany;
                        } else {
                            console.warn(`No valid company data found for ${id}`);
                            return null;
                        }
                    }).filter(company => company !== null);
                    
                    // Deduplicate companies
                    const uniqueCompanies = [];
                    const seenIds = new Set();
                    
                    processedCompanies.forEach(company => {
                        if (!seenIds.has(company.id)) {
                            seenIds.add(company.id);
                            uniqueCompanies.push(company);
                        }
                    });
                    
                    companies = uniqueCompanies;
                }
                
                console.log('Processed companies:', companies);
                console.log('Total companies loaded:', companies.length);

                // Only load additional data if we have companies
                if (companies.length > 0) {
                    try {
                        // Load additional data with individual error handling
                        await loadAllCompaniesUserCounts();
                        await loadAllCompaniesUserQuotas();
                        await loadCompanySubscriptions();
                    } catch (additionalDataError) {
                        console.warn('Error loading additional company data:', additionalDataError);
                        // Continue anyway with basic company data
                    }
                }

                // Update dashboard stats
                updateDashboardStats();
                
                // Display companies
                filteredCompanies = [...companies];
                displayCompanies();
                
                // Refresh quota displays
                if (companies.length > 0) {
                    refreshAllQuotaDisplays();
                }
                
                // Pre-load archived companies data (don't wait for user to click the tab)
                try {
                    console.log('Pre-loading archived companies...');
                    await loadArchivedCompanies();
                    console.log('Archived companies pre-loaded successfully');
                } catch (archiveError) {
                    console.warn('Error pre-loading archived companies:', archiveError);
                    // Don't fail the entire dashboard load because of archives
                }
                
                showLoading(false);
                
                if (companies.length === 0) {
                    console.log('No valid companies found, showing empty state');
                    showEmptyState();
                }
                
                console.log('Dashboard data loading completed successfully');
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    name: error.name,
                    stack: error.stack
                });
                console.error('Firebase status:', {
                    firebaseAvailable: typeof firebase !== 'undefined',
                    databaseAvailable: typeof database !== 'undefined',
                    databaseUrl: firebaseConfig.databaseURL
                });
                
                showLoading(false);
                showEmptyState();
                
                // Only show error notification for critical errors
                if (error.message.includes('Firebase') || error.code === 'PERMISSION_DENIED') {
                    let errorMessage = 'Failed to load company data. ';
                    
                    if (error.message.includes('Firebase') || error.code === 'NETWORK_ERROR') {
                        errorMessage += 'Firebase connection failed. Please refresh the page.';
                    } else if (error.code === 'PERMISSION_DENIED') {
                        errorMessage += 'You do not have permission to access this data.';
                    } else {
                        errorMessage += 'Please try refreshing the page.';
                    }
                    
                    showErrorNotification(errorMessage);
                } else {
                    // For non-critical errors, just log them
                    console.warn('Non-critical error loading dashboard data:', error.message);
                }
            }
        }

        function updateDashboardStats() {
            console.log('Updating dashboard stats with companies:', companies);
            
            // Calculate stats with better error handling
            const totalCompanies = companies.length;
            const activeCompanies = companies.filter(c => c && (c.status === 'active' || c.status === 'Active')).length;
            
            // Calculate total users - check multiple possible field names
            const totalUsers = companies.reduce((sum, company) => {
                if (!company) return sum;
                const userCount = company.userCount || company.users || company.totalUsers || 0;
                return sum + (typeof userCount === 'number' ? userCount : 0);
            }, 0);
            
            // Calculate total revenue - check multiple possible field names
            const totalRevenue = companies.reduce((sum, company) => {
                if (!company) return sum;
                const revenue = company.monthlyRevenue || company.revenue || company.totalRevenue || 0;
                return sum + (typeof revenue === 'number' ? revenue : 0);
            }, 0);

            console.log('Stats calculated:', {
                totalCompanies,
                activeCompanies,
                totalUsers,
                totalRevenue
            });

            // Update DOM with error handling
            try {
                document.getElementById('totalCompanies').textContent = totalCompanies;
                document.getElementById('activeCompanies').textContent = activeCompanies;
                document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();
                document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
            } catch (error) {
                console.error('Error updating dashboard stats DOM:', error);
            }
        }

        function filterCompanies() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            filteredCompanies = companies.filter(company => {
                const matchesSearch = !searchTerm || 
                    (company.name && company.name.toLowerCase().includes(searchTerm)) ||
                    (company.email && company.email.toLowerCase().includes(searchTerm)) ||
                    (company.adminEmail && company.adminEmail.toLowerCase().includes(searchTerm)) ||
                    (company.industry && company.industry.toLowerCase().includes(searchTerm));

                return matchesSearch;
            });

            displayCompanies();
        }

        function filterArchivedCompanies() {
            const searchTerm = document.getElementById('archivesSearchInput').value.toLowerCase();
            console.log('Filtering archived companies with search term:', searchTerm);

            filteredArchivedCompanies = archivedCompanies.filter(company => {
                const matchesSearch = !searchTerm || 
                    (company.companyName && company.companyName.toLowerCase().includes(searchTerm)) ||
                    (company.name && company.name.toLowerCase().includes(searchTerm)) ||
                    (company.businessName && company.businessName.toLowerCase().includes(searchTerm)) ||
                    (company.adminEmail && company.adminEmail.toLowerCase().includes(searchTerm)) ||
                    (company.email && company.email.toLowerCase().includes(searchTerm)) ||
                    (company.contactEmail && company.contactEmail.toLowerCase().includes(searchTerm)) ||
                    (company.industry && company.industry.toLowerCase().includes(searchTerm)) ||
                    (company.businessType && company.businessType.toLowerCase().includes(searchTerm)) ||
                    (company.sector && company.sector.toLowerCase().includes(searchTerm));

                return matchesSearch;
            });

            console.log(`Filtered archived companies: ${filteredArchivedCompanies.length} of ${archivedCompanies.length}`);
            displayArchivedCompanies();
        }

        function displayCompanies() {
            const tableContainer = document.getElementById('companiesTableContainer');
            const tableBody = document.getElementById('companiesTableBody');
            
            console.log('displayCompanies called with:', {
                totalCompanies: companies.length,
                filteredCompanies: filteredCompanies.length,
                filteredCompanyIds: filteredCompanies.map(c => c.id)
            });
            
            if (filteredCompanies.length === 0) {
                showEmptyState();
                return;
            }

            tableContainer.style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            // Clear existing content before adding new rows
            tableBody.innerHTML = '';
            
            // Add each company row
            filteredCompanies.forEach(company => {
                if (company && company.id) {
                    const rowHTML = createCompanyTableRow(company);
                    tableBody.innerHTML += rowHTML;
                }
            });
            
            console.log(`Displayed ${filteredCompanies.length} companies in table`);
        }

        function createCompanyTableRow(company) {
            if (!company || !company.id) {
                console.warn('Invalid company data provided to createCompanyTableRow:', company);
                return '';
            }
            
            // Check if a row with this company ID already exists in the table to prevent duplicates
            const existingRow = document.querySelector(`tr[data-company-id="${company.id}"]`);
            if (existingRow) {
                console.warn(`Row for company ${company.id} already exists, skipping duplicate`);
                return '';
            }
            
            const status = (company.status || 'pending').toLowerCase();
            const userCount = company.userCount || 0;
            const userQuota = company.userQuota || 0;
            const joinedDate = company.createdAt ? new Date(company.createdAt).toLocaleDateString() : 'Unknown';
            const subscription = company.subscription || company.selectedPlan || 'Basic';
            
            const companyName = company.name || 'Unnamed Company';
            const adminEmail = company.adminEmail || company.email || 'Not provided';
            const companyIndustry = company.industry || 'Not specified';
            
            // Create quota display with usage indicator
            const quotaDisplay = userQuota > 0 ? `${userCount}/${userQuota}` : (userQuota === 0 ? 'No limit' : 'Not set');
            const quotaClass = userQuota > 0 && userCount >= userQuota ? 'quota-exceeded' : 'quota-normal';
            
            // Format subscription display with proper capitalization and CSS class
            const formattedSubscription = subscription ? subscription.charAt(0).toUpperCase() + subscription.slice(1).toLowerCase() : 'Basic';
            const subscriptionClass = subscription ? subscription.toLowerCase().replace(/[^a-z]/g, '') : 'basic';
            
            console.log(`Creating table row for company ${company.id}:`, {
                companyName,
                adminEmail: company.adminEmail,
                email: company.email,
                finalAdminEmail: adminEmail,
                userQuota,
                quotaDisplay,
                subscription: subscription,
                formattedSubscription: formattedSubscription,
                subscriptionClass: subscriptionClass
            });

            return `
                <tr data-company-id="${company.id}" onclick="viewCompanyUsers('${company.id}')">
                    <td>
                        <div class="company-name-cell">${companyName}</div>
                    </td>
                    <td class="email-cell" title="${adminEmail}">${adminEmail}</td>
                    <td class="industry-cell" title="${companyIndustry}">${companyIndustry}</td>
                    <td>
                        <span class="status-badge ${status}">${status}</span>
                    </td>
                    <td class="users-cell">${userCount}</td>
                    <td class="quota-cell">
                        <span class="quota-display ${quotaClass}">${quotaDisplay}</span>
                    </td>
                    <td><span class="subscription-badge ${subscriptionClass}">${formattedSubscription}</span></td>
                    <td class="date-cell">${joinedDate}</td>
                    <td onclick="event.stopPropagation()">
                        <div class="table-actions">
                            <button class="table-action-btn table-btn-primary" onclick="viewCompanyDetails('${company.id}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                            <button class="table-action-btn table-btn-success" onclick="accessCompanyPortal('${company.id}')">
                                <i class="fas fa-external-link-alt"></i>
                                Access
                            </button>
                            <button class="table-action-btn" style="background: #17a2b8; color: white;" onclick="manageCompanyQuota('${company.id}', '${company.name}', ${company.userQuota || 0})">
                                <i class="fas fa-users"></i>
                                Quota
                            </button>
                            <button class="table-action-btn table-btn-danger" onclick="deleteCompany('${company.id}', '${company.name}')">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function createCompanyCard(company) {
            if (!company) return '';
            
            const status = (company.status || 'pending').toLowerCase();
            const statusClass = `status-${status}`;
            const userCount = company.userCount || 0;
            const userQuota = company.userQuota || 0;
            const joinedDate = company.createdAt ? new Date(company.createdAt).toLocaleDateString() : 'Unknown';
            const subscription = company.subscription || company.selectedPlan || 'Basic';
            
            // Use the processed company name (already extracted from nested structure)
            const companyName = company.name || 'Unnamed Company';
            const companyEmail = company.email || 'Not provided';
            const companyIndustry = company.industry || 'Not specified';

            // Create quota display
            const quotaDisplay = userQuota > 0 ? `${userCount}/${userQuota}` : (userQuota === 0 ? 'No limit' : 'Not set');
            
            // Format subscription display with proper capitalization
            const formattedSubscription = subscription ? subscription.charAt(0).toUpperCase() + subscription.slice(1).toLowerCase() : 'Basic';

            return `
                <div class="company-card">
                    <div class="company-header">
                        <div class="company-info">
                            <div class="company-id">ID: ${company.id || 'N/A'}</div>
                            <h3>${companyName}</h3>
                        </div>
                        <span class="company-status ${statusClass}">${status}</span>
                    </div>
                    
                    <div class="company-details">
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${companyEmail}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Industry:</span>
                            <span class="detail-value">${companyIndustry}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Users:</span>
                            <span class="detail-value">${userCount}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">User Quota:</span>
                            <span class="detail-value">${quotaDisplay}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Subscription:</span>
                            <span class="detail-value">${formattedSubscription}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Joined:</span>
                            <span class="detail-value">${joinedDate}</span>
                        </div>
                    </div>

                    <div class="company-actions">
                        <button class="action-btn btn-primary" onclick="viewCompanyDetails('${company.id}')">
                            <i class="fas fa-eye"></i>
                            View Details
                        </button>
                        <button class="action-btn btn-success" onclick="accessCompanyPortal('${company.id}')">
                            <i class="fas fa-external-link-alt"></i>
                            Access Portal
                        </button>
                    </div>
                </div>
            `;
        }

        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
            document.getElementById('companiesTableContainer').style.display = show ? 'none' : 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('companiesTableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        async function viewCompanyDetails(companyId) {
            try {
                const company = companies.find(c => c.id === companyId);
                if (!company) {
                    alert('Company not found');
                    return;
                }

                // Load additional company data from Firebase (check nested structure)
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const rawCompanyData = companySnapshot.val();
                
                // Handle nested structure
                let fullCompanyData = company;
                if (rawCompanyData && rawCompanyData.company) {
                    fullCompanyData = {
                        ...company,
                        ...rawCompanyData.company,
                        id: companyId
                    };
                    // Also get admin data if available
                    if (rawCompanyData.admin) {
                        fullCompanyData.adminEmail = rawCompanyData.admin.email;
                        fullCompanyData.adminData = rawCompanyData.admin;
                    }
                } else if (rawCompanyData) {
                    fullCompanyData = {
                        ...company,
                        ...rawCompanyData,
                        id: companyId
                    };
                }

                // Load users count - try different possible paths
                let userCount = 0;
                try {
                    const usersSnapshot = await database.ref(`/users/${companyId}`).once('value');
                    const usersData = usersSnapshot.val() || {};
                    userCount = Object.keys(usersData).length;
                    
                    // If no users found in /users/{companyId}, try other paths
                    if (userCount === 0) {
                        const companyUsersSnapshot = await database.ref(`/companies/${companyId}/users`).once('value');
                        const companyUsersData = companyUsersSnapshot.val() || {};
                        userCount = Object.keys(companyUsersData).length;
                    }
                } catch (error) {
                    console.log('Could not load user count:', error);
                    userCount = fullCompanyData.userCount || 0;
                }

                showCompanyModal(fullCompanyData, userCount);
            } catch (error) {
                console.error('Error loading company details:', error);
                alert('Error loading company details');
            }
        }

        function showCompanyModal(company, userCount) {
            const modalBody = document.getElementById('modalBody');
            const status = company.status || 'pending';
            const joinedDate = company.createdAt ? new Date(company.createdAt).toLocaleDateString() : 'Unknown';
            const userQuota = company.userQuota || 0;
            const quotaDisplay = userQuota > 0 ? `${userCount}/${userQuota}` : (userQuota === 0 ? 'No limit' : 'Not set');
            const subscription = company.subscription || company.selectedPlan || 'Basic';
            const formattedSubscription = subscription ? subscription.charAt(0).toUpperCase() + subscription.slice(1).toLowerCase() : 'Basic';

            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-building" style="color: #007bff;"></i>
                            Company Information
                        </h4>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; space-y: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>Name:</strong> 
                                <span>${company.name || 'Not provided'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>Admin Email:</strong> 
                                <span style="word-break: break-all;">${company.adminEmail || company.email || 'Not provided'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>Phone:</strong> 
                                <span>${company.phone || 'Not provided'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>Industry:</strong> 
                                <span>${company.industry || 'Not specified'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>Location:</strong> 
                                <span>${company.location || 'Not specified'}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <strong>Status:</strong> 
                                <span class="company-status status-${status}" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">${status}</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-bar" style="color: #28a745;"></i>
                            Statistics
                        </h4>
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; space-y: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>Total Users:</strong> 
                                <span style="color: #007bff; font-weight: 600;">${userCount}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>User Quota:</strong> 
                                <span>${quotaDisplay}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>Subscription:</strong> 
                                <span style="color: #6f42c1; font-weight: 600;">${formattedSubscription}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e9ecef;">
                                <strong>Joined Date:</strong> 
                                <span>${joinedDate}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                <strong>Last Activity:</strong> 
                                <span>${company.lastActivity || 'Unknown'}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Pricing Section -->
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-dollar-sign" style="color: #28a745;"></i>
                        Current Pricing Breakdown
                    </h4>
                    <div id="currentPricingContainer" style="min-height: 100px;">
                        <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; color: #6c757d; background: #f8f9fa; border-radius: 12px;">
                            <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                            Calculating current pricing...
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-tools" style="color: #6c757d;"></i>
                        Quick Actions
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <button class="action-btn btn-success" onclick="accessCompanyPortal('${company.id || company.key}')" style="padding: 1rem; border-radius: 8px; border: none; background: #28a745; color: white; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <i class="fas fa-external-link-alt"></i>
                            Access Company Portal
                        </button>
                        <button class="action-btn btn-primary" onclick="window.open('mailto:${company.adminEmail || company.email}', '_blank')" style="padding: 1rem; border-radius: 8px; border: none; background: #007bff; color: white; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <i class="fas fa-envelope"></i>
                            Send Email
                        </button>
                        <button class="action-btn btn-warning" onclick="generateCompanyReport('${company.id || company.key}')" style="padding: 1rem; border-radius: 8px; border: none; background: #ffc107; color: #212529; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                            <i class="fas fa-file-alt"></i>
                            Generate Report
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('companyModal').style.display = 'block';
            
            // Load current pricing after modal is displayed
            loadCurrentPricing(company.id || company.key, userCount);
        }

        function closeModal() {
            document.getElementById('companyModal').style.display = 'none';
        }

        // Load and display company features
        async function loadCompanyFeatures(companyId) {
            try {
                console.log(`Loading features for company: ${companyId}`);
                
                const container = document.getElementById('companyFeaturesContainer');
                if (!container) {
                    console.error('Company features container not found');
                    return;
                }

                // Show loading state
                container.innerHTML = `
                    <div class="features-loading">
                        <i class="fas fa-spinner fa-spin features-icon"></i>
                        <p>Loading company features...</p>
                    </div>
                `;

                // Load company's selected features directly from the correct path
                console.log(`Fetching from: /companies/${companyId}/selectedFeatures`);
                const selectedFeaturesSnapshot = await database.ref(`/companies/${companyId}/selectedFeatures`).once('value');
                const enabledFeatures = selectedFeaturesSnapshot.val();
                
                // Also get company basic info for user count calculation
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    container.innerHTML = `
                        <div class="features-error">
                            <i class="fas fa-exclamation-circle features-icon"></i>
                            <p>Company data not found</p>
                        </div>
                    `;
                    return;
                }
                // Check if company has any selected features
                if (!enabledFeatures || (typeof enabledFeatures === 'object' && Object.keys(enabledFeatures).length === 0) || (Array.isArray(enabledFeatures) && enabledFeatures.length === 0)) {
                    container.innerHTML = `
                        <div class="features-empty">
                            <i class="fas fa-puzzle-piece features-icon"></i>
                            <p>No features enabled for this company</p>
                            <small>Features can be managed through company settings</small>
                        </div>
                    `;
                    return;
                }

                console.log('Found enabled features for company:', enabledFeatures);

                // Load platform features to get details
                const platformFeaturesSnapshot = await database.ref('/platformFeatures').once('value');
                const allPlatformFeatures = platformFeaturesSnapshot.val() || {};

                console.log('Platform features loaded:', allPlatformFeatures);

                // Create features display using feature-card format (matching companymanagement.html)
                let featuresHtml = '';
                let enabledCount = 0;
                let totalPrice = 0;

                // Convert features to array format for processing
                let featuresArray = [];
                
                if (Array.isArray(enabledFeatures)) {
                    featuresArray = enabledFeatures;
                } else if (typeof enabledFeatures === 'object') {
                    // Handle object format - could be {featureId: true} or {featureId: {...}}
                    featuresArray = Object.keys(enabledFeatures).filter(key => 
                        enabledFeatures[key] === true || 
                        (typeof enabledFeatures[key] === 'object' && enabledFeatures[key] !== null)
                    );
                }

                console.log('Processing features array:', featuresArray);

                featuresArray.forEach(featureId => {
                    console.log(`Processing feature: ${featureId}`);
                    
                    // Find the feature in platform features with multiple lookup strategies
                    let feature = null;
                    
                    // Strategy 1: Direct lookup by key
                    if (allPlatformFeatures[featureId]) {
                        feature = allPlatformFeatures[featureId];
                        console.log(`Found feature by direct key lookup: ${featureId}`);
                    }
                    
                    // Strategy 2: Search by ID property in objects
                    if (!feature) {
                        feature = Object.values(allPlatformFeatures).find(f => 
                            f && f.id === featureId
                        );
                        if (feature) console.log(`Found feature by ID property: ${featureId}`);
                    }
                    
                    // Strategy 3: Search by name property
                    if (!feature) {
                        feature = Object.values(allPlatformFeatures).find(f => 
                            f && f.name === featureId
                        );
                        if (feature) console.log(`Found feature by name property: ${featureId}`);
                    }

                    if (feature) {
                        enabledCount++;
                        const price = parseFloat(feature.price || 0);
                        totalPrice += price;
                        
                        console.log(`Feature details:`, {
                            name: feature.name,
                            price: feature.price,
                            icon: feature.icon,
                            description: feature.description
                        });

                        featuresHtml += `
                            <div class="feature-card selected">
                                <div class="feature-icon">
                                    <i class="${feature.icon || 'fas fa-puzzle-piece'}"></i>
                                </div>
                                <div class="feature-title">${feature.name || featureId}</div>
                                <div class="feature-description">${feature.description || 'No description available'}</div>
                                <div class="feature-cost">$${price.toFixed(2)}/user/month</div>
                                <div class="subscribed-indicator">
                                    <i class="fas fa-check-circle"></i>
                                    Active
                                </div>
                            </div>
                        `;
                    } else {
                        // Feature not found in platform features (might be legacy)
                        enabledCount++;
                        console.log(`Feature not found in platform features: ${featureId}`);
                        
                        featuresHtml += `
                            <div class="feature-card selected" style="background: #fff3cd; border-color: #ffeaa7;">
                                <div class="feature-icon" style="color: #856404;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <div class="feature-title" style="color: #856404;">${featureId}</div>
                                <div class="feature-description" style="color: #856404;">Legacy or unknown feature</div>
                                <div class="feature-cost" style="background: #fcf8e3; color: #856404;">Legacy</div>
                                <div class="subscribed-indicator" style="background: rgba(133, 100, 4, 0.1); color: #856404;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Legacy
                                </div>
                            </div>
                        `;
                    }
                });

                // Get user count for pricing calculation
                const totalUsersText = document.querySelector('#modalBody').textContent;
                const userCountMatch = totalUsersText.match(/Total Users:\s*(\d+)/);
                const userCount = userCountMatch ? parseInt(userCountMatch[1]) : 0;
                const monthlyTotal = totalPrice * userCount;

                container.innerHTML = `
                    <div class="company-features-grid">
                        <div class="feature-stat-card" style="background: #e3f2fd;">
                            <div class="feature-stat-number" style="color: #1976d2;">${enabledCount}</div>
                            <div class="feature-stat-label" style="color: #1976d2;">Features Enabled</div>
                        </div>
                        <div class="feature-stat-card" style="background: #e8f5e8;">
                            <div class="feature-stat-number" style="color: #388e3c;">$${totalPrice.toFixed(2)}</div>
                            <div class="feature-stat-label" style="color: #388e3c;">Per User/Month</div>
                        </div>
                        <div class="feature-stat-card" style="background: #fff3e0;">
                            <div class="feature-stat-number" style="color: #f57c00;">$${monthlyTotal.toFixed(2)}</div>
                            <div class="feature-stat-label" style="color: #f57c00;">Monthly Total</div>
                        </div>
                    </div>
                    
                    <div class="features-grid">
                        ${featuresHtml || '<div class="features-empty"><i class="fas fa-puzzle-piece features-icon"></i><p>No valid features found</p></div>'}
                    </div>
                `;

            } catch (error) {
                console.error('Error loading company features:', error);
                const container = document.getElementById('companyFeaturesContainer');
                if (container) {
                    container.innerHTML = `
                        <div class="features-error">
                            <i class="fas fa-exclamation-triangle features-icon"></i>
                            <p>Error loading company features</p>
                            <small>${error.message}</small>
                        </div>
                    `;
                }
            }
        }

        // Load and display current pricing breakdown
        async function loadCurrentPricing(companyId, userCount) {
            try {
                console.log(`Loading current pricing for company: ${companyId} with ${userCount} users`);
                
                const container = document.getElementById('currentPricingContainer');
                if (!container) {
                    console.error('Current pricing container not found');
                    return;
                }

                // Show loading state
                container.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; padding: 2rem; color: #6c757d;">
                        <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                        Calculating current pricing...
                    </div>
                `;

                // Load company's selected features
                const selectedFeaturesSnapshot = await database.ref(`/companies/${companyId}/selectedFeatures`).once('value');
                const enabledFeatures = selectedFeaturesSnapshot.val();
                
                // Load platform features to get pricing
                const platformFeaturesSnapshot = await database.ref('/platformFeatures').once('value');
                const allPlatformFeatures = platformFeaturesSnapshot.val() || {};

                // Load company subscription info
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                // Base pricing (Enterprise plan base cost)
                const basePricePerUser = 25; // Enterprise base price per user
                const baseCost = basePricePerUser * userCount;
                
                // Calculate features cost
                let featuresCost = 0;
                let featuresBreakdown = [];
                
                if (enabledFeatures) {
                    // Convert features to array format for processing
                    let featuresArray = [];
                    
                    if (Array.isArray(enabledFeatures)) {
                        featuresArray = enabledFeatures;
                    } else if (typeof enabledFeatures === 'object') {
                        featuresArray = Object.keys(enabledFeatures).filter(key => 
                            enabledFeatures[key] === true || 
                            (typeof enabledFeatures[key] === 'object' && enabledFeatures[key] !== null)
                        );
                    }

                    featuresArray.forEach(featureId => {
                        // Find the feature in platform features
                        let feature = allPlatformFeatures[featureId] || 
                                    Object.values(allPlatformFeatures).find(f => f && f.id === featureId) ||
                                    Object.values(allPlatformFeatures).find(f => f && f.name === featureId);

                        if (feature) {
                            const price = parseFloat(feature.price || 0);
                            const totalPrice = price * userCount;
                            featuresCost += totalPrice;
                            
                            featuresBreakdown.push({
                                name: feature.name || featureId,
                                pricePerUser: price,
                                totalPrice: totalPrice,
                                icon: feature.icon || 'fas fa-puzzle-piece'
                            });
                        }
                    });
                }

                const totalMonthlyCost = baseCost + featuresCost;
                
                // Generate features breakdown HTML
                let featuresBreakdownHtml = '';
                if (featuresBreakdown.length > 0) {
                    featuresBreakdownHtml = featuresBreakdown.map(feature => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="${feature.icon}" style="color: #007bff; width: 20px;"></i>
                                <span style="font-weight: 500;">${feature.name}</span>
                                <span style="color: #6c757d; font-size: 0.9rem;">($${feature.pricePerUser.toFixed(2)}/user)</span>
                            </div>
                            <span style="font-weight: 600; color: #2c3e50;">$${feature.totalPrice.toFixed(2)}</span>
                        </div>
                    `).join('');
                } else {
                    featuresBreakdownHtml = `
                        <div style="text-align: center; padding: 1rem; color: #6c757d; font-style: italic;">
                            No additional features enabled
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #e9ecef;">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1976d2;">$${baseCost.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #1976d2; opacity: 0.8;">Base Cost</div>
                            </div>
                            <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #388e3c;">$${featuresCost.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #388e3c; opacity: 0.8;">Features Cost</div>
                            </div>
                            <div style="background: #fff3e0; padding: 1rem; border-radius: 8px; text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: #f57c00;">$${totalMonthlyCost.toFixed(2)}</div>
                                <div style="font-size: 0.8rem; color: #f57c00; opacity: 0.8;">Total Monthly</div>
                            </div>
                        </div>

                        <!-- Pricing Breakdown -->
                        <div style="margin-bottom: 1.5rem;">
                            <h5 style="color: #2c3e50; margin-bottom: 1rem; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                                <i class="fas fa-calculator"></i>
                                Pricing Breakdown
                            </h5>
                            
                            <!-- Base Cost -->
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #e9ecef;">
                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                    <i class="fas fa-building" style="color: #007bff; width: 20px;"></i>
                                    <span style="font-weight: 500;">Enterprise Base Plan</span>
                                    <span style="color: #6c757d; font-size: 0.9rem;">($${basePricePerUser}/user × ${userCount} users)</span>
                                </div>
                                <span style="font-weight: 600; color: #2c3e50;">$${baseCost.toFixed(2)}</span>
                            </div>

                            <!-- Features Cost -->
                            ${featuresBreakdownHtml}
                        </div>

                        <!-- Annual Savings -->
                        <div style="background: #d4edda; padding: 1rem; border-radius: 8px; border: 1px solid #c3e6cb;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-calendar-alt" style="color: #155724;"></i>
                                <strong style="color: #155724;">Annual Pricing</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: #155724;">
                                <span>Annual Total (12 months):</span>
                                <span style="font-weight: 600;">$${(totalMonthlyCost * 12).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: #155724; font-size: 0.9rem;">
                                <span>Potential 10% annual discount:</span>
                                <span style="font-weight: 600;">Save $${(totalMonthlyCost * 1.2).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading current pricing:', error);
                const container = document.getElementById('currentPricingContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="background: #f8d7da; padding: 1rem; border-radius: 8px; border: 1px solid #f5c6cb; color: #721c24;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error loading pricing information: ${error.message}
                        </div>
                    `;
                }
            }
        }

        // Refresh company features
        function refreshCompanyFeatures(companyId) {
            loadCompanyFeatures(companyId);
        }

        function accessCompanyPortal(companyId) {
            // Store super admin context
            sessionStorage.setItem('superAdminAccess', 'true');
            sessionStorage.setItem('accessedCompanyId', companyId);
            
            // Open company portal in new tab
            window.open(`dashboard.html?company=${companyId}&superadmin=true`, '_blank');
            
            closeModal();
        }

        function generateCompanyReport(companyId) {
            // Placeholder for report generation
            alert(`Generating comprehensive report for company ${companyId}...`);
            closeModal();
        }

        function exportArchivedCompanies() {
            try {
                console.log('Exporting archived companies data...');
                
                if (!archivedCompanies || archivedCompanies.length === 0) {
                    alert('No archived companies to export');
                    return;
                }

                // Prepare data for export
                const exportData = archivedCompanies.map(company => ({
                    'Company ID': company.id,
                    'Company Name': company.companyName || company.name || company.businessName || 'N/A',
                    'Admin Email': company.adminEmail || company.email || company.contactEmail || 'N/A',
                    'Industry': company.industry || company.businessType || company.sector || 'N/A',
                    'User Count': company.userCount || company.totalUsers || company.employeeCount || 0,
                    'Subscription': company.subscription || company.subscriptionPlan || company.plan || 'Basic',
                    'Archived Date': company.archivedAt ? new Date(company.archivedAt).toLocaleString() : 
                                   company.deletedAt ? new Date(company.deletedAt).toLocaleString() : 'Unknown',
                    'Archived By': company.archivedBy || company.deletedBy || company.actionBy || 'Unknown',
                    'Original Registration Date': company.registrationDate ? new Date(company.registrationDate).toLocaleString() : 
                                                company.createdAt ? new Date(company.createdAt).toLocaleString() : 'Unknown'
                }));

                // Convert to CSV
                const headers = Object.keys(exportData[0]);
                const csvContent = [
                    headers.join(','),
                    ...exportData.map(row => 
                        headers.map(header => {
                            const value = row[header];
                            // Escape commas and quotes in CSV values
                            return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
                                ? `"${value.replace(/"/g, '""')}"` 
                                : value;
                        }).join(',')
                    )
                ].join('\n');

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `archived_companies_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(`Successfully exported ${archivedCompanies.length} archived companies`);
                    alert(`Successfully exported ${archivedCompanies.length} archived companies to CSV file`);
                } else {
                    // Fallback for older browsers
                    alert('CSV export is not supported in this browser');
                }

            } catch (error) {
                console.error('Error exporting archived companies:', error);
                alert(`Error exporting archived companies: ${error.message}`);
            }
        }

        async function deleteCompany(companyId, companyName) {
            // Store the company details for deletion
            window.pendingDeletion = { companyId, companyName };
            
            // Populate the modal with company name
            document.getElementById('deleteCompanyName').textContent = companyName;
            
            // Reset the confirmation input
            document.getElementById('deleteConfirmationInput').value = '';
            document.getElementById('confirmDeleteBtn').disabled = true;
            
            // Show the delete confirmation modal
            document.getElementById('deleteCompanyModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteCompanyModal').style.display = 'none';
            window.pendingDeletion = null;
        }

        async function confirmDeleteCompany() {
            const { companyId, companyName } = window.pendingDeletion;
            
            try {
                // Show loading state
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Archiving...';
                confirmBtn.disabled = true;

                console.log(`Starting archive process for company: ${companyId}`);

                // Get company data before archiving
                const companySnapshot = await database.ref(`companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    throw new Error('Company data not found');
                }

                // Get all users associated with this company
                const usersSnapshot = await database.ref('users').once('value');
                const allUsers = usersSnapshot.val() || {};
                
                const companyUsers = [];
                Object.keys(allUsers).forEach(userId => {
                    const user = allUsers[userId];
                    if (user.companyId === companyId) {
                        companyUsers.push({ id: userId, ...user });
                    }
                });

                // Create archive entry with all necessary data
                const archiveData = {
                    ...companyData,
                    id: companyId,
                    archivedAt: Date.now(),
                    archivedBy: 'syllaoussein@yahoo.fr', // Current super admin email
                    originalUsers: companyUsers,
                    userCount: companyUsers.length
                };

                // Save to archives
                await database.ref(`archivedCompanies/${companyId}`).set(archiveData);
                
                // Remove company from active companies
                await database.ref(`companies/${companyId}`).remove();
                
                // Remove users from active users (they're stored in archive)
                const deleteUserPromises = [];
                Object.keys(allUsers).forEach(userId => {
                    const user = allUsers[userId];
                    if (user.companyId === companyId) {
                        deleteUserPromises.push(database.ref(`users/${userId}`).remove());
                    }
                });

                if (deleteUserPromises.length > 0) {
                    await Promise.all(deleteUserPromises);
                    console.log(`Archived ${deleteUserPromises.length} users with company`);
                }

                // Remove company from local arrays
                companies = companies.filter(company => company.id !== companyId);
                filteredCompanies = filteredCompanies.filter(company => company.id !== companyId);

                // Close the modal
                closeDeleteModal();

                // Refresh the display
                displayCompanies();
                updateDashboardStats();

                // Show success message
                alert(`Company "${companyName}" has been archived successfully. You can restore it from the Archives tab if needed.`);

                console.log(`Successfully archived company: ${companyId}`);

            } catch (error) {
                console.error('Error archiving company:', error);
                alert(`Error archiving company: ${error.message}`);

                // Restore button state
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                confirmBtn.innerHTML = '<i class="fas fa-archive"></i> Archive Company';
                confirmBtn.disabled = false;
            }
        }

        async function deleteUser(userId, userName, companyId) {
            // Store the user details for deletion
            window.pendingUserDeletion = { userId, userName, companyId };
            
            // Populate the modal with user details
            document.getElementById('deleteUserName').textContent = userName;
            document.getElementById('deleteUserEmail').textContent = userId.includes('@') ? userId : 'User ID: ' + userId;
            
            // Reset the confirmation input
            document.getElementById('deleteUserConfirmationInput').value = '';
            document.getElementById('confirmDeleteUserBtn').disabled = true;
            
            // Show the delete confirmation modal
            document.getElementById('deleteUserModal').style.display = 'block';
        }

        function closeDeleteUserModal() {
            document.getElementById('deleteUserModal').style.display = 'none';
            window.pendingUserDeletion = null;
        }

        async function confirmDeleteUser() {
            const { userId, userName, companyId } = window.pendingUserDeletion;
            
            try {
                // Show loading state
                const confirmBtn = document.getElementById('confirmDeleteUserBtn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                confirmBtn.disabled = true;

                console.log(`Starting deletion process for user: ${userId}`);

                // Delete user from Firebase users collection
                await database.ref(`users/${userId}`).remove();
                
                // Delete user from company's users collection (if they exist there)
                if (companyId) {
                    await database.ref(`companies/${companyId}/users/${userId}`).remove();
                }

                // Remove user from local users array
                users = users.filter(user => (user.id || user.email) !== userId);

                // Close the modal
                closeDeleteUserModal();

                // Refresh the users display
                displayUsers();
                
                // Update the company user count in the header
                if (selectedCompany) {
                    document.getElementById('selectedCompanyName').textContent = `${selectedCompany.name} (${users.length} users)`;
                }

                // Update company user count in companies array and table if we're viewing a specific company
                if (companyId && selectedCompany && selectedCompany.id === companyId) {
                    updateCompanyUserCount(companyId, users.length);
                    updateCompanyTableRow(companyId, users.length);
                }

                // Show success message
                alert(`User "${userName}" has been successfully deleted.`);

                console.log(`Successfully deleted user: ${userId}`);

            } catch (error) {
                console.error('Error deleting user:', error);
                alert(`Error deleting user: ${error.message}`);

                // Restore button state
                const confirmBtn = document.getElementById('confirmDeleteUserBtn');
                confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Delete User';
                confirmBtn.disabled = false;
            }
        }

        // Quota Management Functions
        let pendingQuotaUpdate = null;

        async function manageCompanyQuota(companyId, companyName, currentQuota) {
            try {
                // Store pending quota update data
                pendingQuotaUpdate = { companyId, companyName, currentQuota };
                
                // Get current user count for the company
                const companySnapshot = await database.ref(`companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                let currentUserCount = 0;
                if (companyData && companyData.users) {
                    currentUserCount = Object.keys(companyData.users).length;
                }
                
                // Populate modal
                document.getElementById('quotaCompanyName').textContent = companyName;
                document.getElementById('quotaCompanyId').textContent = `ID: ${companyId}`;
                document.getElementById('quotaCurrentUsers').textContent = currentUserCount;
                document.getElementById('quotaCurrentLimit').textContent = currentQuota || 'Unlimited';
                document.getElementById('newQuotaInput').value = currentQuota || '';
                
                // Show modal
                document.getElementById('quotaManagementModal').style.display = 'block';
                
                // Focus on input
                setTimeout(() => {
                    document.getElementById('newQuotaInput').focus();
                }, 100);
                
            } catch (error) {
                console.error('Error loading quota data:', error);
                alert(`Error loading quota data: ${error.message}`);
            }
        }

        function closeQuotaModal() {
            document.getElementById('quotaManagementModal').style.display = 'none';
            pendingQuotaUpdate = null;
        }

        async function updateCompanyQuota() {
            if (!pendingQuotaUpdate) return;
            
            const { companyId, companyName } = pendingQuotaUpdate;
            const newQuota = parseInt(document.getElementById('newQuotaInput').value) || 0;
            
            try {
                // Show loading state
                const updateBtn = event.target;
                const originalText = updateBtn.innerHTML;
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                updateBtn.disabled = true;
                
                // Update quota in Firebase
                await database.ref(`companies/${companyId}/userQuota`).set(newQuota);
                
                console.log(`Updated quota for ${companyName} (${companyId}) to ${newQuota}`);
                
                // Update local companies array
                const company = companies.find(c => c.id === companyId);
                if (company) {
                    company.userQuota = newQuota;
                }
                
                // Refresh the companies table to show updated quota
                displayCompanies();
                
                // Close modal
                closeQuotaModal();
                
                // Show success message
                const quotaText = newQuota === 0 ? 'unlimited' : newQuota;
                alert(`Successfully updated quota for "${companyName}" to ${quotaText} users.`);
                
            } catch (error) {
                console.error('Error updating company quota:', error);
                alert(`Error updating quota: ${error.message}`);
                
                // Restore button state
                updateBtn.innerHTML = originalText;
                updateBtn.disabled = false;
            }
        }

        // Add Enter key support for quota input
        document.addEventListener('DOMContentLoaded', function() {
            const quotaInput = document.getElementById('newQuotaInput');
            if (quotaInput) {
                quotaInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        updateCompanyQuota();
                    }
                });
            }
            
            // Add click outside modal to close functionality
            window.addEventListener('click', function(event) {
                const quotaModal = document.getElementById('quotaManagementModal');
                if (event.target === quotaModal) {
                    closeQuotaModal();
                }
            });
        });

        function logout() {
            // Clear all sessions
            localStorage.removeItem('superAdminSession');
            sessionStorage.removeItem('isSuperAdmin');
            sessionStorage.removeItem('superAdminAccess');
            sessionStorage.removeItem('accessedCompanyId');
            
            // Redirect to login
            window.location.href = 'adminlogin.html';
        }

        // Debug function to inspect data
        function debugData() {
            console.log('=== DEBUG DATA ===');
            console.log('Raw companies array:', companies);
            console.log('Filtered companies:', filteredCompanies);
            console.log('Companies count:', companies.length);
            
            // Check Firebase authentication status
            let authStatus = 'Not Available';
            let currentUser = null;
            
            if (firebase && firebase.auth) {
                currentUser = firebase.auth().currentUser;
                authStatus = currentUser ? 'Authenticated' : 'Not Authenticated';
            }
            
            // Show detailed info in alert
            const debugInfo = `
Debug Information:
- Total companies loaded: ${companies.length}
- Filtered companies: ${filteredCompanies.length}
- Database URL: ${firebaseConfig.databaseURL}
- Firebase Auth Status: ${authStatus}
- Current User: ${currentUser ? currentUser.uid : 'None'}
- Companies data: ${JSON.stringify(companies.slice(0, 1), null, 2)}
            `;
            
            alert(debugInfo);
            console.log('=== END DEBUG ===');
        }

        // Test Firebase connection and authentication
        async function testFirebaseConnection() {
            console.log('=== TESTING FIREBASE CONNECTION ===');
            
            let results = [];
            
            try {
                // Test 1: Firebase availability
                if (typeof firebase === 'undefined') {
                    results.push('❌ Firebase SDK not loaded');
                    alert('Firebase SDK not loaded! Check your internet connection.');
                    return;
                } else {
                    results.push('✅ Firebase SDK loaded');
                }
                
                // Test 2: Firebase Auth
                if (!firebase.auth) {
                    results.push('❌ Firebase Auth not available');
                } else {
                    results.push('✅ Firebase Auth available');
                    
                    const currentUser = firebase.auth().currentUser;
                    if (!currentUser) {
                        results.push('❌ No authenticated user');
                        try {
                            results.push('🔄 Attempting authentication...');
                            await firebase.auth().signInAnonymously();
                            results.push('✅ Anonymous authentication successful');
                        } catch (authError) {
                            results.push(`❌ Authentication failed: ${authError.message}`);
                        }
                    } else {
                        results.push(`✅ User authenticated: ${currentUser.uid}`);
                    }
                }
                
                // Test 3: Database access
                if (database) {
                    try {
                        results.push('🔄 Testing database read access...');
                        const snapshot = await database.ref('/companies').once('value');
                        const data = snapshot.val();
                        
                        if (data) {
                            const companyCount = Object.keys(data).length;
                            results.push(`✅ Database read successful: ${companyCount} companies found`);
                        } else {
                            results.push('⚠️ Database read successful but no data found');
                        }
                    } catch (dbError) {
                        results.push(`❌ Database read failed: ${dbError.message}`);
                        
                        // Try REST API
                        try {
                            results.push('🔄 Testing REST API...');
                            const restUrl = `${firebaseConfig.databaseURL}/companies.json`;
                            const response = await fetch(restUrl);
                            
                            if (response.ok) {
                                const restData = await response.json();
                                if (restData) {
                                    results.push(`✅ REST API successful: ${Object.keys(restData).length} companies`);
                                } else {
                                    results.push('⚠️ REST API successful but no data');
                                }
                            } else {
                                results.push(`❌ REST API failed: ${response.status}`);
                            }
                        } catch (restError) {
                            results.push(`❌ REST API error: ${restError.message}`);
                        }
                    }
                }
                
                const resultText = results.join('\n');
                console.log('Firebase Test Results:', resultText);
                alert(`Firebase Connection Test:\n\n${resultText}`);
                
            } catch (error) {
                alert(`Test failed: ${error.message}`);
            }
            
            console.log('=== END FIREBASE TEST ===');
        }

        // Debug function for archived companies
        function debugArchivesData() {
            console.log('=== DEBUG ARCHIVES DATA ===');
            console.log('Raw archived companies array:', archivedCompanies);
            console.log('Filtered archived companies:', filteredArchivedCompanies);
            console.log('Archived companies count:', archivedCompanies.length);
            console.log('Database reference:', database);
            console.log('Firebase initialized:', !!firebase);
            
            // Test direct Firebase connection
            if (database) {
                console.log('Testing direct Firebase connection to archivedCompanies...');
                database.ref('archivedCompanies').once('value')
                    .then(snapshot => {
                        const data = snapshot.val();
                        console.log('Direct Firebase query result:', data);
                        console.log('Direct query returned data:', !!data);
                        if (data) {
                            console.log('Number of archived companies found:', Object.keys(data).length);
                        }
                    })
                    .catch(error => {
                        console.error('Direct Firebase query error:', error);
                    });
            }
            
            // Show detailed info in alert
            const debugInfo = `
Archives Debug Information:
- Total archived companies loaded: ${archivedCompanies.length}
- Filtered archived companies: ${filteredArchivedCompanies.length}
- Database URL: ${firebaseConfig.databaseURL}
- Database initialized: ${!!database}
- Firebase available: ${typeof firebase !== 'undefined'}
- Archived companies data: ${JSON.stringify(archivedCompanies.slice(0, 2), null, 2)}
            `;
            
            alert(debugInfo);
            console.log('=== END ARCHIVES DEBUG ===');
        }

        // Test function to verify Firebase connection and data
        async function testFirebaseArchivedCompanies() {
            console.log('=== TESTING FIREBASE ARCHIVED COMPANIES ===');
            
            try {
                if (!database) {
                    console.error('Database not initialized');
                    alert('Firebase database is not initialized!');
                    return;
                }

                console.log('Testing connection to Firebase...');
                console.log('Database URL:', firebaseConfig.databaseURL);
                
                // Test basic connection
                const testRef = database.ref('.info/connected');
                const connectedSnapshot = await testRef.once('value');
                console.log('Firebase connected:', connectedSnapshot.val());
                
                // Test archived companies path
                console.log('Querying archivedCompanies path...');
                const archivesRef = database.ref('archivedCompanies');
                const snapshot = await archivesRef.once('value');
                const data = snapshot.val();
                
                console.log('Query result:', data);
                console.log('Data exists:', data !== null);
                console.log('Data type:', typeof data);
                
                if (data) {
                    const keys = Object.keys(data);
                    console.log('Company keys found:', keys);
                    console.log('Number of archived companies:', keys.length);
                    
                    // Show first company as sample
                    if (keys.length > 0) {
                        const firstCompany = data[keys[0]];
                        console.log('Sample company data:', firstCompany);
                    }
                    
                    alert(`Success! Found ${keys.length} archived companies in Firebase.`);
                } else {
                    console.log('No data found at archivedCompanies path');
                    alert('No archived companies found in Firebase database.');
                }
                
            } catch (error) {
                console.error('Error testing Firebase:', error);
                alert(`Firebase test failed: ${error.message}`);
            }
            
            console.log('=== END FIREBASE TEST ===');
        }

        // Function to create sample archived companies for testing
        async function createSampleArchivedCompanies() {
            if (!database) {
                alert('Firebase database not initialized!');
                return;
            }

            const confirmed = confirm('Create sample archived companies for testing? This will add test data to your Firebase database.');
            if (!confirmed) return;

            try {
                const sampleData = {
                    'archived_company_1': {
                        companyName: 'Test Company Alpha',
                        adminEmail: 'admin@testcompanyalpha.com',
                        industry: 'Technology',
                        userCount: 25,
                        subscription: 'Professional',
                        archivedAt: new Date().toISOString(),
                        archivedBy: 'Super Admin',
                        registrationDate: new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString() // 1 year ago
                    },
                    'archived_company_2': {
                        companyName: 'Beta Solutions Inc',
                        adminEmail: 'contact@betasolutions.com',
                        industry: 'Consulting',
                        userCount: 12,
                        subscription: 'Basic',
                        archivedAt: new Date().toISOString(),
                        archivedBy: 'Super Admin',
                        registrationDate: new Date(Date.now() - 180 * 24 * 60 * 60 * 1000).toISOString() // 6 months ago
                    },
                    'archived_company_3': {
                        companyName: 'Gamma Corp',
                        adminEmail: 'admin@gammacorp.com',
                        industry: 'Manufacturing',
                        userCount: 45,
                        subscription: 'Enterprise',
                        archivedAt: new Date().toISOString(),
                        archivedBy: 'Super Admin',
                        registrationDate: new Date(Date.now() - 730 * 24 * 60 * 60 * 1000).toISOString() // 2 years ago
                    }
                };

                console.log('Creating sample archived companies:', sampleData);
                
                for (const [key, companyData] of Object.entries(sampleData)) {
                    await database.ref(`archivedCompanies/${key}`).set(companyData);
                    console.log(`Created sample company: ${key}`);
                }

                alert('Sample archived companies created successfully! Click Refresh to see them.');
                console.log('Sample archived companies creation completed');

            } catch (error) {
                console.error('Error creating sample archived companies:', error);
                alert(`Error creating sample data: ${error.message}`);
            }
        }

        // Security: Prevent unauthorized access
        window.addEventListener('beforeunload', function() {
            // Keep session for legitimate navigation
            if (!sessionStorage.getItem('isSuperAdmin')) {
                localStorage.removeItem('superAdminSession');
            }
        });

        // Features Management Functions
        let features = [];
        let filteredFeatures = [];

        // --- Project Management Feature Definition ---
        // Add this to your features array if not already present
        const projectManagementFeature = {
            id: 'project_management',
            name: 'Project Management',
            description: 'Manage projects, dashboards, lists, and reports.',
            status: 'active',
            authorizedPages: [
                { page: 'project-create.html', feature: 'project_create_view', name: 'Create Project' },
                { page: 'project-dashboard.html', feature: 'project_dashboard_view', name: 'Project Dashboard' },
                { page: 'project-list.html', feature: 'project_list_view', name: 'Project List' },
                { page: 'project-reports.html', feature: 'project_reports_view', name: 'Project Reports' }
            ],
            price: 0.00,
            createdAt: Date.now()
        };

        // Ensure Project Management feature is present in features list
        document.addEventListener('DOMContentLoaded', function() {
            if (!features.some(f => f.id === 'project_management')) {
                features.push(projectManagementFeature);
                filteredFeatures = features;
                displayFeatures();
            }
        });

        // Archives Management Functions
        let archivedCompanies = [];
        let filteredArchivedCompanies = [];

        async function loadFeatures() {
            try {
                console.log('Loading platform features...');
                showFeaturesLoading(true);
                
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                const featuresData = featuresSnapshot.val();
                
                if (featuresData) {
                    features = Object.keys(featuresData).map(id => ({
                        id: id,
                        ...featuresData[id]
                    }));
                } else {
                    features = [];
                }
                
                console.log(`Loaded ${features.length} features`);
                filteredFeatures = [...features];
                displayFeatures();
                
                // Apply sidebar menu visibility based on all active features
                applyAllFeaturesMenuVisibility();
                
                showFeaturesLoading(false);
                
                if (features.length === 0) {
                    showFeaturesEmptyState();
                }
            } catch (error) {
                console.error('Error loading features:', error);
                showFeaturesLoading(false);
                showFeaturesEmptyState();
            }
        }

        function displayFeatures() {
            const tableContainer = document.getElementById('featuresTableContainer');
            const tableBody = document.getElementById('featuresTableBody');
            
            if (filteredFeatures.length === 0) {
                showFeaturesEmptyState();
                return;
            }

            tableContainer.style.display = 'block';
            document.getElementById('featuresEmptyState').style.display = 'none';

            tableBody.innerHTML = filteredFeatures.map(feature => createFeatureTableRow(feature)).join('');
        }

        function createFeatureTableRow(feature) {
            const createdDate = feature.createdAt ? new Date(feature.createdAt).toLocaleDateString() : 'Unknown';
            const status = feature.status || 'active';
            const statusClass = `status-${status.replace('-', '')}`;
            const price = parseFloat(feature.price || 0).toFixed(2);
            
            return `
                <tr data-feature-id="${feature.id}">
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i class="${feature.icon || 'fas fa-puzzle-piece'}" style="color: #007bff;"></i>
                            <strong>${feature.name}</strong>
                        </div>
                    </td>
                    <td title="${feature.description}">${feature.description}</td>
                    <td><code>${feature.icon}</code></td>
                    <td>$${price}</td>
                    <td><span class="role-badge">${feature.category || 'Other'}</span></td>
                    <td><span class="status-badge ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1).replace('-', ' ')}</span></td>
                    <td>${createdDate}</td>
                    <td onclick="event.stopPropagation()">
                        <div class="table-actions">
                            <button class="table-action-btn table-btn-primary" onclick="editFeature('${feature.id}')" title="Edit Feature">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="table-action-btn table-btn-danger" onclick="deleteFeature('${feature.id}', '${feature.name}')" title="Delete Feature">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function showFeaturesLoading(show) {
            document.getElementById('featuresLoadingState').style.display = show ? 'block' : 'none';
            document.getElementById('featuresTableContainer').style.display = show ? 'none' : 'block';
            document.getElementById('featuresEmptyState').style.display = 'none';
        }

        function showFeaturesEmptyState() {
            document.getElementById('featuresLoadingState').style.display = 'none';
            document.getElementById('featuresTableContainer').style.display = 'none';
            document.getElementById('featuresEmptyState').style.display = 'block';
        }

        // Feature Modal Functions
        function showAddFeatureModal() {
            document.getElementById('addFeatureModal').style.display = 'block';
            // Add event listeners for real-time preview in Add modal
            addAddModalCheckboxEventListeners();
        }
        
        // Add event listeners to Add modal checkboxes for real-time menu preview
        function addAddModalCheckboxEventListeners() {
            const checkboxes = document.querySelectorAll('.add-page-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    // Get current selected pages and preview menu changes
                    const currentSelectedPages = getSelectedAddPages();
                    updateSidebarMenuVisibility(currentSelectedPages);
                });
            });
        }

        // Select all pages for Add modal
        function selectAllAddPages() {
            const checkboxes = document.querySelectorAll('.add-page-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            // Update menu visibility
            updateSidebarMenuVisibility(getSelectedAddPages());
        }

        // Deselect all pages for Add modal
        function deselectAllAddPages() {
            const checkboxes = document.querySelectorAll('.add-page-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            // Update menu visibility
            updateSidebarMenuVisibility(getSelectedAddPages());
        }

        // Get selected pages from Add modal checkboxes
        function getSelectedAddPages() {
            const checkboxes = document.querySelectorAll('.add-page-checkbox:checked');
            const selectedPages = [];

            checkboxes.forEach(checkbox => {
                selectedPages.push({
                    page: checkbox.getAttribute('data-page'),
                    feature: checkbox.getAttribute('data-feature')
                });
            });

            return selectedPages;
        }

        function closeFeatureModal() {
            document.getElementById('addFeatureModal').style.display = 'none';
            document.getElementById('addFeatureForm').reset();
            // Clear all page selections
            deselectAllAddPages();
            // Restore menu to show all active features
            applyAllFeaturesMenuVisibility();
        }

        async function saveFeature() {
            try {
                const form = document.getElementById('addFeatureForm');
                const formData = new FormData(form);
                
                // Get selected authorized pages
                const authorizedPages = getSelectedAddPages();
                
                const featureData = {
                    name: formData.get('featureName'),
                    description: formData.get('featureDescription'),
                    icon: formData.get('featureIcon'),
                    price: parseFloat(formData.get('featurePrice')),
                    category: formData.get('featureCategory'),
                    status: formData.get('featureStatus'),
                    authorizedPages: authorizedPages,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Generate a unique ID for the feature
                const featureRef = database.ref('/platformFeatures').push();
                const featureId = featureRef.key;
                await featureRef.set(featureData);

                // Update sidebar menu visibility based on authorized pages
                updateSidebarMenuVisibility(authorizedPages);

                // Signal menu visibility update for all company management pages
                signalMenuVisibilityUpdate(featureId, featureData);

                console.log('Feature saved successfully with authorized pages:', authorizedPages);
                closeFeatureModal();
                loadFeatures(); // Reload features

            } catch (error) {
                console.error('Error saving feature:', error);
                alert('Error saving feature. Please try again.');
            }
        }

        function editFeature(featureId) {
            const feature = features.find(f => f.id === featureId);
            if (!feature) return;

            // Populate edit form
            document.getElementById('editFeatureId').value = feature.id;
            document.getElementById('editFeatureName').value = feature.name;
            document.getElementById('editFeatureDescription').value = feature.description;
            document.getElementById('editFeatureIcon').value = feature.icon;
            document.getElementById('editFeaturePrice').value = feature.price;
            document.getElementById('editFeatureCategory').value = feature.category;
            document.getElementById('editFeatureStatus').value = feature.status;

            // Show the modal first
            document.getElementById('editFeatureModal').style.display = 'block';

            // Load authorized pages for this feature after modal is shown
            setTimeout(() => {
                loadAuthorizedPages(feature.authorizedPages || []);
            }, 100);
        }

        // Load authorized pages into checkboxes
        function loadAuthorizedPages(authorizedPages) {
            console.log('Loading authorized pages:', authorizedPages);
            const checkboxes = document.querySelectorAll('.page-checkbox');
            console.log('Found checkboxes:', checkboxes.length);
            
            // Reset all checkboxes
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });

            // Check the authorized pages
            if (authorizedPages && Array.isArray(authorizedPages)) {
                authorizedPages.forEach(pageInfo => {
                    // Look for checkbox by data-feature attribute (since edit modal uses data-feature)
                    const featureAttribute = pageInfo.feature || pageInfo.page;
                    const checkbox = document.querySelector(`.page-checkbox[data-feature="${featureAttribute}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('Checked checkbox for feature:', featureAttribute);
                    } else {
                        console.log('Checkbox not found for feature:', featureAttribute);
                    }
                });
            }
            
            // Add event listeners for real-time preview
            addCheckboxEventListeners();
            
            // Update preview to show currently selected items
            const currentSelectedPages = getSelectedPages();
            console.log('Currently selected pages after loading:', currentSelectedPages);
        }
        
        // Add event listeners to checkboxes for real-time menu preview
        function addCheckboxEventListeners() {
            const checkboxes = document.querySelectorAll('.page-checkbox');
            checkboxes.forEach(checkbox => {
                // Remove existing listener if any to prevent duplicates
                checkbox.removeEventListener('change', handleCheckboxChange);
                // Add new listener
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        }

        // Separate function to handle checkbox changes
        function handleCheckboxChange() {
            // Get current selected pages and preview menu changes
            const currentSelectedPages = getSelectedPages();
            updateSidebarMenuVisibility(currentSelectedPages);
        }

        // Get selected pages from checkboxes
        function getSelectedPages() {
            const checkboxes = document.querySelectorAll('.page-checkbox:checked');
            const selectedPages = [];

            checkboxes.forEach(checkbox => {
                // For edit modal, we use data-feature attribute
                const feature = checkbox.getAttribute('data-feature');
                const page = checkbox.getAttribute('data-page'); // This might be null for edit modal
                
                selectedPages.push({
                    page: page || feature, // Use feature as fallback for page
                    feature: feature
                });
            });

            return selectedPages;
        }

        // Select all pages
        function selectAllPages() {
            const checkboxes = document.querySelectorAll('.page-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            // Update menu visibility
            updateSidebarMenuVisibility(getSelectedPages());
        }

        // Deselect all pages
        function deselectAllPages() {
            const checkboxes = document.querySelectorAll('.page-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            // Update menu visibility
            updateSidebarMenuVisibility(getSelectedPages());
        }

        function closeEditFeatureModal() {
            document.getElementById('editFeatureModal').style.display = 'none';
            // Clear all page selections
            deselectAllPages();
            // Restore menu to show all active features
            applyAllFeaturesMenuVisibility();
        }

        async function updateFeature() {
            try {
                const form = document.getElementById('editFeatureForm');
                const formData = new FormData(form);
                const featureId = formData.get('featureId');
                
                console.log('Updating feature with ID:', featureId);
                
                // Get selected authorized pages
                const authorizedPages = getSelectedPages();
                console.log('Selected authorized pages:', authorizedPages);
                
                const featureData = {
                    name: formData.get('featureName'),
                    description: formData.get('featureDescription'),
                    icon: formData.get('featureIcon'),
                    price: parseFloat(formData.get('featurePrice')),
                    category: formData.get('featureCategory'),
                    status: formData.get('featureStatus'),
                    authorizedPages: authorizedPages,
                    updatedAt: new Date().toISOString()
                };

                console.log('Feature data to update:', featureData);

                // Check if database is available
                if (!database) {
                    throw new Error('Database not initialized');
                }

                await database.ref(`/platformFeatures/${featureId}`).update(featureData);

                // Update sidebar menu visibility based on authorized pages
                updateSidebarMenuVisibility(authorizedPages);

                // Signal menu visibility update for all company management pages
                signalMenuVisibilityUpdate(featureId, featureData);

                console.log('Feature updated successfully with authorized pages:', authorizedPages);
                alert('Feature updated successfully!');
                closeEditFeatureModal();
                loadFeatures(); // Reload features

            } catch (error) {
                console.error('Error updating feature:', error);
                alert(`Error updated feature: ${error.message}. Please try again.`);
            }
        }

        function deleteFeature(featureId, featureName) {
            const feature = features.find(f => f.id === featureId);
            if (!feature) return;

            // Store feature data for deletion
            window.pendingFeatureDelete = { id: featureId, name: featureName };

            // Populate delete modal
            document.getElementById('deleteFeatureName').textContent = feature.name;
            document.getElementById('deleteFeatureDescription').textContent = feature.description;
            
            // Reset confirmation input
            const confirmInput = document.getElementById('deleteFeatureConfirmationInput');
            confirmInput.value = '';
            
            // Reset confirm button
            const confirmBtn = document.getElementById('confirmDeleteFeatureBtn');
            confirmBtn.disabled = true;
            confirmBtn.style.background = '#6c757d';
            confirmBtn.style.cursor = 'not-allowed';

            document.getElementById('deleteFeatureModal').style.display = 'block';
        }

        function closeDeleteFeatureModal() {
            document.getElementById('deleteFeatureModal').style.display = 'none';
            document.getElementById('deleteFeatureConfirmationInput').value = '';
            window.pendingFeatureDelete = null;
        }

        async function confirmDeleteFeature() {
            if (!window.pendingFeatureDelete) return;

            try {
                const featureId = window.pendingFeatureDelete.id;
                const featureName = window.pendingFeatureDelete.name;
                
                await database.ref(`/platformFeatures/${featureId}`).remove();

                // Signal menu visibility update for feature deletion
                signalMenuVisibilityUpdate(featureId, {
                    name: featureName,
                    authorizedPages: [], // Empty since feature is deleted
                    updatedAt: new Date().toISOString(),
                    deleted: true
                });

                console.log('Feature deleted successfully');
                closeDeleteFeatureModal();
                loadFeatures(); // Reload features (this will also update menu visibility)

            } catch (error) {
                console.error('Error deleting feature:', error);
                alert('Error deleting feature. Please try again.');
            }
        }

        // Function to update sidebar menu visibility based on authorized pages
        function updateSidebarMenuVisibility(authorizedPages) {
            console.log('Updating sidebar menu visibility with authorized pages:', authorizedPages);
            
            // Get all menu items in the sidebar
            const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
            
            // Create a set of authorized feature data attributes for quick lookup
            const authorizedFeatures = new Set();
            authorizedPages.forEach(pageInfo => {
                if (pageInfo.feature) {
                    authorizedFeatures.add(pageInfo.feature);
                }
            });
            
            console.log('Authorized features:', Array.from(authorizedFeatures));
            
            // Update visibility for each menu item
            allMenuItems.forEach(menuItem => {
                const featureAttribute = menuItem.getAttribute('data-feature');
                const isAuthorized = authorizedFeatures.has(featureAttribute);
                
                if (isAuthorized) {
                    // Show the menu item
                    menuItem.style.display = '';
                    console.log(`Showing menu item: ${featureAttribute}`);
                } else {
                    // Hide the menu item
                    menuItem.style.display = 'none';
                    console.log(`Hiding menu item: ${featureAttribute}`);
                }
            });
            
            // Handle dropdown menus - hide dropdown if all children are hidden
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                let hasVisibleChildren = false;
                
                submenuItems.forEach(submenuItem => {
                    if (submenuItem.style.display !== 'none') {
                        hasVisibleChildren = true;
                    }
                });
                
                // Hide the entire dropdown if no children are visible
                if (!hasVisibleChildren) {
                    dropdown.style.display = 'none';
                    console.log(`Hiding dropdown menu: ${dropdown.getAttribute('data-feature')}`);
                } else {
                    dropdown.style.display = '';
                    console.log(`Showing dropdown menu: ${dropdown.getAttribute('data-feature')}`);
                }
            });
        }

        // Function to reset all menu items to visible (useful for testing)
        function resetSidebarMenuVisibility() {
            const allMenuItems = document.querySelectorAll('#roleBasedMenu li');
            allMenuItems.forEach(menuItem => {
                menuItem.style.display = '';
            });
            console.log('All menu items reset to visible');
        }

        // Function to apply menu visibility based on all active features
        function applyAllFeaturesMenuVisibility() {
            console.log('Applying menu visibility for all active features...');
            
            // Collect all authorized pages from all active features
            const allAuthorizedPages = [];
            features.forEach(feature => {
                if (feature.status === 'active' && feature.authorizedPages) {
                    allAuthorizedPages.push(...feature.authorizedPages);
                }
            });
            
            console.log('All authorized pages from active features:', allAuthorizedPages);
            
            // Remove duplicates and apply to sidebar
            const uniqueAuthorizedPages = allAuthorizedPages.filter((page, index, self) => 
                index === self.findIndex(p => p.feature === page.feature)
            );
            
            updateSidebarMenuVisibility(uniqueAuthorizedPages);
        }

        // Function to signal menu visibility update to company management pages
        function signalMenuVisibilityUpdate(featureId, featureData) {
            try {
                console.log('📡 Signaling menu visibility update for feature:', featureId);
                
                // Create update signal with timestamp to ensure uniqueness
                const updateSignal = {
                    type: featureData.deleted ? 'featureDelete' : 'featureUpdate',
                    featureId: featureId,
                    featureName: featureData.name,
                    authorizedPages: featureData.authorizedPages || [],
                    deleted: featureData.deleted || false,
                    timestamp: Date.now(),
                    updatedAt: featureData.updatedAt
                };
                
                // Store in localStorage for company management pages to detect
                localStorage.setItem('platformFeatureUpdate', JSON.stringify(updateSignal));
                console.log('✅ Feature update signal stored in localStorage:', updateSignal);
                
                // Also trigger custom event for real-time updates if pages are open
                if (window.opener || window.parent !== window) {
                    try {
                        const event = new CustomEvent('platformFeatureUpdated', {
                            detail: updateSignal
                        });
                        window.dispatchEvent(event);
                        console.log('✅ Custom event dispatched for real-time update');
                    } catch (eventError) {
                        console.warn('⚠️ Could not dispatch custom event:', eventError);
                    }
                }
                
                // Clear the signal after a delay to prevent stale updates
                setTimeout(() => {
                    const currentSignal = localStorage.getItem('platformFeatureUpdate');
                    if (currentSignal) {
                        const parsedSignal = JSON.parse(currentSignal);
                        if (parsedSignal.timestamp === updateSignal.timestamp) {
                            localStorage.removeItem('platformFeatureUpdate');
                            console.log('🧹 Cleared feature update signal from localStorage');
                        }
                    }
                }, 30000); // Clear after 30 seconds
                
            } catch (error) {
                console.error('❌ Error signaling menu visibility update:', error);
            }
        }

        // Test function to verify menu visibility update communication
        window.testMenuVisibilityUpdate = function() {
            console.log('🧪 Testing menu visibility update communication...');
            
            const testSignal = {
                name: 'Test Feature',
                authorizedPages: [
                    { feature: 'home_view', page: 'Home' },
                    { feature: 'health_view', page: 'Health' }
                ],
                updatedAt: new Date().toISOString()
            };
            
            signalMenuVisibilityUpdate('test-feature-id', testSignal);
            console.log('✅ Test signal sent. Check companymanagement.html console for updates.');
        };

        // Archives Management Functions
        async function loadArchivedCompanies() {
            try {
                showArchivesLoading(true);
                console.log('Loading archived companies from Firebase...');
                console.log('Database reference:', database);
                console.log('Firebase config URL:', firebaseConfig.databaseURL);
                
                if (!database) {
                    throw new Error('Firebase database not initialized');
                }

                const archivesSnapshot = await database.ref('archivedCompanies').once('value');
                const archivesData = archivesSnapshot.val();
                console.log('Raw archived companies data:', archivesData);
                console.log('Archives data type:', typeof archivesData);
                console.log('Archives data exists:', archivesData !== null && archivesData !== undefined);

                if (archivesData && typeof archivesData === 'object') {
                    const companyKeys = Object.keys(archivesData);
                    console.log('Found company keys:', companyKeys);
                    
                    archivedCompanies = companyKeys.map(key => {
                        const companyData = {
                            id: key,
                            ...archivesData[key]
                        };
                        console.log(`Archived company ${key}:`, companyData);
                        return companyData;
                    });
                    
                    filteredArchivedCompanies = [...archivedCompanies];
                    console.log(`Successfully loaded ${archivedCompanies.length} archived companies`);
                } else {
                    archivedCompanies = [];
                    filteredArchivedCompanies = [];
                    console.log('No archived companies found in database');
                }

                // Always call display function to handle empty state properly
                displayArchivedCompanies();
                
            } catch (error) {
                console.error('Error loading archived companies:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                
                // Reset arrays on error
                archivedCompanies = [];
                filteredArchivedCompanies = [];
                
                showArchivesEmptyState();
                showErrorNotification(`Failed to load archived companies: ${error.message}`);
            }
        }

        function displayArchivedCompanies() {
            console.log('Displaying archived companies...');
            console.log('Number of filtered archived companies:', filteredArchivedCompanies.length);
            
            const tableContainer = document.getElementById('archivesTableContainer');
            const tableBody = document.getElementById('archivesTableBody');
            const loadingState = document.getElementById('archivesLoadingState');
            const emptyState = document.getElementById('archivesEmptyState');
            
            // Stop loading animation
            showArchivesLoading(false);
            
            // Check if elements exist
            if (!tableContainer || !tableBody) {
                console.error('Archives table elements not found in DOM');
                return;
            }
            
            if (filteredArchivedCompanies.length === 0) {
                console.log('No archived companies to display, showing empty state');
                showArchivesEmptyState();
                return;
            }

            // Hide empty and loading states
            if (emptyState) emptyState.style.display = 'none';
            if (loadingState) loadingState.style.display = 'none';
            
            // Show table container
            tableContainer.style.display = 'block';

            try {
                // Generate table rows
                const tableRows = filteredArchivedCompanies.map((company, index) => {
                    console.log(`Creating row for company ${index + 1}:`, company);
                    return createArchivedCompanyTableRow(company);
                });
                
                console.log(`Generated ${tableRows.length} table rows`);
                tableBody.innerHTML = tableRows.join('');
                console.log('Successfully populated archived companies table');
                
            } catch (error) {
                console.error('Error creating archived companies table rows:', error);
                showArchivesEmptyState();
                showErrorNotification(`Error displaying archived companies: ${error.message}`);
            }
        }

        function createArchivedCompanyTableRow(company) {
            if (!company) {
                console.warn('Attempted to create table row for null/undefined company');
                return '';
            }
            
            console.log('Creating table row for company:', company);
            
            try {
                // Handle archived date formatting with multiple fallbacks
                let archivedDate = 'Unknown';
                if (company.archivedAt) {
                    try {
                        archivedDate = new Date(company.archivedAt).toLocaleDateString();
                    } catch (dateError) {
                        console.warn('Error formatting archived date:', dateError);
                        archivedDate = company.archivedAt.toString();
                    }
                } else if (company.deletedAt) {
                    try {
                        archivedDate = new Date(company.deletedAt).toLocaleDateString();
                    } catch (dateError) {
                        console.warn('Error formatting deleted date:', dateError);
                        archivedDate = company.deletedAt.toString();
                    }
                }
                
                // Handle archived by information with fallbacks
                const archivedBy = company.archivedBy || 
                                 company.deletedBy || 
                                 company.actionBy ||
                                 'Unknown Admin';
                
                // Handle user count from archived data with multiple fallbacks
                const userCount = company.userCount || 
                                company.totalUsers ||
                                company.employeeCount ||
                                (company.originalUsers ? company.originalUsers.length : 0) || 
                                (company.users ? Object.keys(company.users).length : 0) ||
                                0;
                
                // Handle subscription information with multiple fallbacks
                const subscription = company.subscription || 
                                   company.subscriptionPlan || 
                                   company.plan || 
                                   company.tier ||
                                   'Basic';
                
                // Get company name from multiple possible sources
                const companyName = company.companyName || 
                                  company.name || 
                                  company.businessName || 
                                  company.organizationName ||
                                  `Company ${company.id}`;
                
                // Handle admin email from multiple possible sources
                const adminEmail = company.adminEmail || 
                                 company.email || 
                                 company.contactEmail || 
                                 company.primaryEmail ||
                                 company.ownerEmail ||
                                 'Not provided';
                
                // Handle industry information with fallbacks
                const industry = company.industry || 
                               company.businessType || 
                               company.sector || 
                               company.category ||
                               'Not specified';

                // Escape quotes in company name for onclick functions
                const escapedCompanyName = companyName.replace(/'/g, "\\'").replace(/"/g, '\\"');

                return `
                    <tr>
                        <td class="company-name-cell">
                            <strong>${companyName}</strong>
                        </td>
                        <td class="email-cell">${adminEmail}</td>
                        <td class="industry-cell">${industry}</td>
                        <td class="users-cell">
                            <span style="font-weight: 600;">${userCount}</span>
                        </td>
                        <td>
                            <span class="subscription-badge subscription-${subscription.toLowerCase().replace(/[^a-z0-9]/g, '')}">${subscription}</span>
                        </td>
                        <td class="date-cell">${archivedDate}</td>
                        <td class="email-cell">${archivedBy}</td>
                        <td class="table-actions">
                            <button onclick="restoreCompany('${company.id}', '${escapedCompanyName}')" 
                                    class="table-action-btn" 
                                    style="background: #28a745; color: white; margin-right: 0.25rem;" 
                                    title="Restore Company">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button onclick="permanentDeleteCompany('${company.id}', '${escapedCompanyName}')" 
                                    class="table-action-btn table-btn-danger" 
                                    title="Permanently Delete">
                                <i class="fas fa-skull-crossbones"></i>
                            </button>
                        </td>
                    </tr>
                `;
            } catch (error) {
                console.error('Error creating archived company table row:', error, 'Company data:', company);
                return `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #dc3545; padding: 1rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error displaying company: ${company.id || 'Unknown ID'}
                        </td>
                    </tr>
                `;
            }
        }

        function showArchivesLoading(show) {
            document.getElementById('archivesLoadingState').style.display = show ? 'block' : 'none';
            document.getElementById('archivesTableContainer').style.display = show ? 'none' : 'block';
            document.getElementById('archivesEmptyState').style.display = 'none';
        }

        function showArchivesEmptyState() {
            document.getElementById('archivesLoadingState').style.display = 'none';
            document.getElementById('archivesTableContainer').style.display = 'none';
            document.getElementById('archivesEmptyState').style.display = 'block';
        }

        // Restore Company Functions
        function restoreCompany(companyId, companyName) {
            const company = archivedCompanies.find(c => c.id === companyId);
            if (!company) return;

            // Store company data for restoration
            window.pendingRestore = { companyId, companyName, companyData: company };

            // Populate restore modal with correct field names
            const displayName = company.companyName || company.name || company.businessName || 'Unknown Company';
            const displayEmail = company.adminEmail || company.email || company.contactEmail || 'Not provided';
            
            document.getElementById('restoreCompanyName').textContent = displayName;
            document.getElementById('restoreCompanyEmail').textContent = displayEmail;

            document.getElementById('restoreCompanyModal').style.display = 'block';
        }

        function closeRestoreModal() {
            document.getElementById('restoreCompanyModal').style.display = 'none';
            window.pendingRestore = null;
        }

        async function confirmRestoreCompany() {
            if (!window.pendingRestore) return;

            const { companyId, companyName, companyData } = window.pendingRestore;
            
            try {
                // Show loading state
                const confirmBtn = document.getElementById('confirmRestoreBtn');
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restoring...';
                confirmBtn.disabled = true;

                console.log(`Starting restore process for company: ${companyId}`);

                // Create clean company data (remove archive-specific fields)
                const { archivedAt, archivedBy, originalUsers, ...cleanCompanyData } = companyData;

                // Restore company to active companies
                await database.ref(`companies/${companyId}`).set(cleanCompanyData);

                // Restore users if they exist
                if (originalUsers && originalUsers.length > 0) {
                    const restoreUserPromises = originalUsers.map(user => {
                        const { id, ...userData } = user;
                        return database.ref(`users/${id}`).set(userData);
                    });
                    await Promise.all(restoreUserPromises);
                    console.log(`Restored ${originalUsers.length} users with company`);
                }

                // Remove from archives
                await database.ref(`archivedCompanies/${companyId}`).remove();

                // Update local arrays
                archivedCompanies = archivedCompanies.filter(c => c.id !== companyId);
                filteredArchivedCompanies = filteredArchivedCompanies.filter(c => c.id !== companyId);

                // Refresh archives display
                displayArchivedCompanies();

                // Refresh companies data if on companies tab
                if (document.getElementById('companiesTabBtn').classList.contains('active')) {
                    loadDashboardData();
                }

                // Close modal
                closeRestoreModal();

                // Show success message
                alert(`Company "${companyName}" has been successfully restored!`);

                console.log(`Successfully restored company: ${companyId}`);

            } catch (error) {
                console.error('Error restoring company:', error);
                alert(`Error restoring company: ${error.message}`);

                // Restore button state
                const confirmBtn = document.getElementById('confirmRestoreBtn');
                confirmBtn.innerHTML = '<i class="fas fa-undo"></i> Restore Company';
                confirmBtn.disabled = false;
            }
        }

        // Permanent Delete Functions
        function permanentDeleteCompany(companyId, companyName) {
            const company = archivedCompanies.find(c => c.id === companyId);
            if (!company) return;

            // Store company data for permanent deletion
            window.pendingPermanentDelete = { companyId, companyName };

            // Populate permanent delete modal with correct field names
            const displayName = company.companyName || company.name || company.businessName || 'Unknown Company';
            const displayEmail = company.adminEmail || company.email || company.contactEmail || 'Not provided';
            
            document.getElementById('permanentDeleteCompanyName').textContent = displayName;
            document.getElementById('permanentDeleteCompanyEmail').textContent = displayEmail;
            
            // Reset confirmation input
            const confirmInput = document.getElementById('permanentDeleteConfirmationInput');
            confirmInput.value = '';
            
            // Reset confirm button
            const confirmBtn = document.getElementById('confirmPermanentDeleteBtn');
            confirmBtn.disabled = true;
            confirmBtn.style.background = '#6c757d';
            confirmBtn.style.cursor = 'not-allowed';

            document.getElementById('permanentDeleteModal').style.display = 'block';
        }

        function closePermanentDeleteModal() {
            document.getElementById('permanentDeleteModal').style.display = 'none';
            document.getElementById('permanentDeleteConfirmationInput').value = '';
            window.pendingPermanentDelete = null;
        }

        async function confirmPermanentDelete() {
            if (!window.pendingPermanentDelete) return;

            const { companyId, companyName } = window.pendingPermanentDelete;
            
            try {
                // Show loading state
                const confirmBtn = document.getElementById('confirmPermanentDeleteBtn');
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                confirmBtn.disabled = true;

                console.log(`Starting permanent deletion for company: ${companyId}`);

                // Permanently remove from archives
                await database.ref(`archivedCompanies/${companyId}`).remove();

                // Update local arrays
                archivedCompanies = archivedCompanies.filter(c => c.id !== companyId);
                filteredArchivedCompanies = filteredArchivedCompanies.filter(c => c.id !== companyId);

                // Refresh display
                displayArchivedCompanies();

                // Close modal
                closePermanentDeleteModal();

                // Show success message
                alert(`Company "${companyName}" has been permanently deleted from archives.`);

                console.log(`Successfully permanently deleted company: ${companyId}`);

            } catch (error) {
                console.error('Error permanently deleting company:', error);
                alert(`Error permanently deleting company: ${error.message}`);

                // Restore button state
                const confirmBtn = document.getElementById('confirmPermanentDeleteBtn');
                confirmBtn.innerHTML = '<i class="fas fa-skull-crossbones"></i> Permanent Delete';
                confirmBtn.disabled = false;
            }
        }

        // Clear All Archives Functions
        function clearAllArchives() {
            if (archivedCompanies.length === 0) {
                alert('No archived companies to clear.');
                return;
            }

            // Reset confirmation input
            const confirmInput = document.getElementById('clearArchivesConfirmationInput');
            confirmInput.value = '';
            
            // Reset confirm button
            const confirmBtn = document.getElementById('confirmClearArchivesBtn');
            confirmBtn.disabled = true;
            confirmBtn.style.background = '#6c757d';
            confirmBtn.style.cursor = 'not-allowed';

            document.getElementById('clearArchivesModal').style.display = 'block';
        }

        function closeClearArchivesModal() {
            document.getElementById('clearArchivesModal').style.display = 'none';
            document.getElementById('clearArchivesConfirmationInput').value = '';
        }

        async function confirmClearAllArchives() {
            try {
                // Show loading state
                const confirmBtn = document.getElementById('confirmClearArchivesBtn');
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
                confirmBtn.disabled = true;

                console.log('Starting clear all archives process');

                // Remove all archived companies
                await database.ref('archivedCompanies').remove();

                // Update local arrays
                archivedCompanies = [];
                filteredArchivedCompanies = [];

                // Refresh display
                displayArchivedCompanies();

                // Close modal
                closeClearArchivesModal();

                // Show success message
                alert('All archived companies have been permanently cleared.');

                console.log('Successfully cleared all archives');

            } catch (error) {
                console.error('Error clearing all archives:', error);
                alert(`Error clearing archives: ${error.message}`);

                // Restore button state
                const confirmBtn = document.getElementById('confirmClearArchivesBtn');
                confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Clear All Archives';
                confirmBtn.disabled = false;
            }
        }

        // Tab Management Functions
        function switchToTab(tabName) {
            // Update tab navigation
            document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.getElementById(`${tabName}TabBtn`).classList.add('active');
            document.getElementById(`${tabName}TabContent`).classList.add('active');
            
            // If switching to users tab and no company is selected, show the selection prompt
            if (tabName === 'users' && !selectedCompany) {
                showNoCompanySelected();
            }
            
            // If switching to features tab, load features
            if (tabName === 'features') {
                loadFeatures();
            }

            // If switching to archives tab, load archived companies
            if (tabName === 'archives') {
                loadArchivedCompanies();
            }
        }

        function viewCompanyUsers(companyId) {
            selectedCompany = companies.find(c => c.id === companyId);
            if (!selectedCompany) {
                alert('Company not found');
                return;
            }
            
            // Switch to users tab
            switchToTab('users');
            
            // Update company info header
            document.getElementById('selectedCompanyName').textContent = `${selectedCompany.name} (${users.length} users)`;
            document.getElementById('selectedCompanyEmail').textContent = selectedCompany.adminEmail || selectedCompany.email;
            document.getElementById('companyInfoHeader').style.display = 'flex';
            document.getElementById('noCompanySelectedState').style.display = 'none';
            
            // Load users for this company
            loadCompanyUsers(companyId);
        }

        // Load and display users for a specific company with intelligent admin merging
        // Prevents duplicate admin entries by merging admin data with existing user records
        async function loadCompanyUsers(companyId) {
            try {
                showUsersLoading(true);
                console.log(`Loading users for company: ${companyId}`);
                
                // Try multiple possible paths for users data
                let usersData = {};
                
                // First try: /users/{companyId}
                const usersSnapshot1 = await database.ref(`/users/${companyId}`).once('value');
                const userData1 = usersSnapshot1.val();
                
                if (userData1) {
                    usersData = userData1;
                } else {
                    // Second try: /companies/{companyId}/users
                    const usersSnapshot2 = await database.ref(`/companies/${companyId}/users`).once('value');
                    const userData2 = usersSnapshot2.val();
                    
                    if (userData2) {
                        usersData = userData2;
                    }
                }
                
                console.log('Raw users data:', usersData);
                
                // Load admin data separately and include it in the users list
                let adminData = null;
                try {
                    const adminSnapshot = await database.ref(`/companies/${companyId}/admin`).once('value');
                    adminData = adminSnapshot.val();
                    console.log('Admin data loaded:', adminData);
                } catch (error) {
                    console.log('Could not load admin data:', error);
                }
                
                users = [];
                const seenEmails = new Set(); // Track users by email to prevent duplicates
                const usersByEmail = new Map(); // Map to store users by email for merging
                
                // Process regular users data
                if (usersData && Object.keys(usersData).length > 0) {
                    const regularUsers = Object.keys(usersData).map(userId => {
                        const userData = usersData[userId];
                        
                        return {
                            id: userId,
                            name: userData.fullName || userData.name || userData.firstName + ' ' + userData.lastName || 'Unknown User',
                            email: userData.email || 'Not provided',
                            role: userData.role || userData.position || 'User',
                            department: userData.department || userData.division || 'Not specified',
                            lastLogin: userData.lastLogin || userData.lastActive || 'Never',
                            status: userData.status || (userData.active ? 'Active' : 'Inactive'),
                            phone: userData.phone,
                            joinedDate: userData.createdAt || userData.joinedDate,
                            isAdmin: false,
                            ...userData
                        };
                    });
                    
                    // Store users by email in the map for potential merging
                    regularUsers.forEach(user => {
                        if (user.email && user.email !== 'Not provided') {
                            usersByEmail.set(user.email, user);
                        }
                    });
                    
                    users = users.concat(regularUsers);
                }
                
                // Process admin data and merge with existing user if duplicate
                if (adminData && adminData.adminEmail) {
                    const adminEmail = adminData.adminEmail || adminData.email;
                    
                    // Check if a user with this email already exists
                    const existingUser = usersByEmail.get(adminEmail);
                    
                    if (existingUser) {
                        // Merge admin data with existing user, but keep the user's role from roles.html
                        console.log(`Merging admin data with existing user: ${adminEmail}`);
                        
                        // Update the existing user to mark them as admin but keep their original role
                        existingUser.isAdmin = true;
                        existingUser.name = existingUser.name || adminData.adminName || adminData.name || adminData.fullName || 'Company Admin';
                        existingUser.phone = existingUser.phone || adminData.phone || adminData.adminPhone || 'Not provided';
                        existingUser.department = existingUser.department || 'Administration';
                        
                        // Keep the original role from the users data (likely "super user")
                        console.log(`Keeping user role "${existingUser.role}" for admin user ${adminEmail}`);
                        
                        seenEmails.add(adminEmail);
                    } else {
                        // Admin doesn't exist in regular users, add as new admin user
                        const adminUser = {
                            id: 'admin_' + companyId,
                            name: adminData.adminName || adminData.name || adminData.fullName || 'Company Admin',
                            email: adminEmail,
                            role: 'Company Admin',
                            department: 'Administration',
                            lastLogin: adminData.lastLogin || adminData.lastActive || 'Unknown',
                            status: 'Active',
                            phone: adminData.phone || adminData.adminPhone || 'Not provided',
                            joinedDate: adminData.createdAt || adminData.joinedDate || 'Unknown',
                            isAdmin: true,
                            ...adminData
                        };
                        
                        // Add admin at the beginning of the users list
                        users.unshift(adminUser);
                        seenEmails.add(adminEmail);
                        console.log('Added new admin user to list:', adminUser);
                    }
                }
                
                // Final deduplication pass - remove any remaining duplicates by email
                const finalUsers = [];
                const finalSeenEmails = new Set();
                
                users.forEach(user => {
                    if (user.email && user.email !== 'Not provided') {
                        if (!finalSeenEmails.has(user.email)) {
                            finalSeenEmails.add(user.email);
                            finalUsers.push(user);
                        } else {
                            console.log('Final duplicate removal for email:', user.email);
                        }
                    } else {
                        // Keep users without proper email
                        finalUsers.push(user);
                    }
                });
                
                users = finalUsers;
                
                console.log('Processed users (including admin):', users);
                console.log('Total users loaded:', users.length);
                
                // Update the company's user count in the companies array and table
                updateCompanyUserCount(companyId, users.length);
                
                displayUsers();
                showUsersLoading(false);
                
                if (users.length === 0) {
                    showUsersEmptyState();
                }
            } catch (error) {
                console.error('Error loading users data:', error);
                showUsersLoading(false);
                showUsersEmptyState();
                alert('Failed to load users data. Please try again.');
            }
        }

        // Display users with admin styling for company administrators
        function displayUsers() {
            const tableContainer = document.getElementById('usersTableContainer');
            const tableBody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                showUsersEmptyState();
                return;
            }

            tableContainer.style.display = 'block';
            document.getElementById('usersEmptyState').style.display = 'none';

            console.log(`Displaying ${users.length} users`);
            tableBody.innerHTML = users.map(user => createUserTableRow(user)).join('');
        }

        function createUserTableRow(user) {
            if (!user) {
                console.warn('Attempted to create table row for null/undefined user');
                return '';
            }
            
            // Validate essential user data
            if (!user.email && !user.id) {
                console.warn('User missing both email and ID, skipping:', user);
                return '';
            }
            
            const userName = user.name || 'Unknown User';
            const userEmail = user.email || 'Not provided';
            const userRole = user.role || 'User';
            const userDepartment = user.department || 'Not specified';
            const lastLogin = user.lastLogin && user.lastLogin !== 'Never' && user.lastLogin !== 'Unknown' ? 
                new Date(user.lastLogin).toLocaleDateString() : (user.lastLogin || 'Never');
            const status = user.status || 'Active';
            
            // Special styling for admin users
            const isAdminUser = user.isAdmin || userRole.toLowerCase().includes('admin');
            const adminBadge = isAdminUser ? '<i class="fas fa-crown" style="color: #ffd700; margin-left: 0.5rem;" title="Company Administrator"></i>' : '';
            const rowClass = isAdminUser ? 'style="background-color: #fff8e1;"' : '';

            return `
                <tr ${rowClass}>
                    <td>
                        <div class="user-name-cell">${userName}${adminBadge}</div>
                    </td>
                    <td class="email-cell" title="${userEmail}">${userEmail}</td>
                    <td>
                        <span class="role-badge ${userRole.toLowerCase().replace(' ', '-')}">${userRole}</span>
                    </td>
                    <td>${userDepartment}</td>
                    <td class="last-login-cell">${lastLogin}</td>
                    <td>
                        <span class="status-badge ${status.toLowerCase()}">${status}</span>
                    </td>
                    <td>
                        <div class="table-actions">
                            <button class="table-action-btn table-btn-primary" onclick="viewUserDetails('${user.id || user.email}')">
                                <i class="fas fa-eye"></i>
                                View
                            </button>
                            <button class="table-action-btn table-btn-success" onclick="contactUser('${userEmail}')">
                                <i class="fas fa-envelope"></i>
                                Contact
                            </button>
                            <button class="table-action-btn table-btn-danger" onclick="deleteUser('${user.id || user.email}', '${userName}', '${user.companyId || selectedCompany?.id}')">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function showUsersLoading(show) {
            document.getElementById('usersLoadingState').style.display = show ? 'block' : 'none';
            document.getElementById('usersTableContainer').style.display = show ? 'none' : 'block';
            document.getElementById('usersEmptyState').style.display = 'none';
        }

        function showUsersEmptyState() {
            document.getElementById('usersLoadingState').style.display = 'none';
            document.getElementById('usersTableContainer').style.display = 'none';
            document.getElementById('usersEmptyState').style.display = 'block';
        }

        function showNoCompanySelected() {
            document.getElementById('usersLoadingState').style.display = 'none';
            document.getElementById('usersTableContainer').style.display = 'none';
            document.getElementById('usersEmptyState').style.display = 'none';
            document.getElementById('companyInfoHeader').style.display = 'none';
            document.getElementById('noCompanySelectedState').style.display = 'block';
        }

        function viewUserDetails(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                alert('User not found');
                return;
            }
            
            // Create and show user details modal (similar to company modal)
            const modalBody = document.getElementById('modalBody');
            const joinedDate = user.joinedDate ? new Date(user.joinedDate).toLocaleDateString() : 'Unknown';
            
            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">User Information</h4>
                        <div style="space-y: 0.5rem;">
                            <p><strong>Name:</strong> ${user.name || 'Not provided'}</p>
                            <p><strong>Email:</strong> ${user.email || 'Not provided'}</p>
                            <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                            <p><strong>Role:</strong> <span class="role-badge ${user.role.toLowerCase()}">${user.role}</span></p>
                            <p><strong>Department:</strong> ${user.department || 'Not specified'}</p>
                            <p><strong>Status:</strong> <span class="status-badge ${user.status.toLowerCase()}">${user.status}</span></p>
                        </div>
                    </div>
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 1rem;">Activity</h4>
                        <div style="space-y: 0.5rem;">
                            <p><strong>Company:</strong> ${selectedCompany.name}</p>
                            <p><strong>Joined Date:</strong> ${joinedDate}</p>
                            <p><strong>Last Login:</strong> ${user.lastLogin === 'Never' ? 'Never' : new Date(user.lastLogin).toLocaleDateString()}</p>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">Quick Actions</h4>
                    <div style="display: flex; gap: 1rem;">
                        <button class="action-btn btn-primary" onclick="contactUser('${user.email}')">
                            <i class="fas fa-envelope"></i>
                            Send Email
                        </button>
                        <button class="action-btn btn-success" onclick="resetUserPassword('${user.id}')">
                            <i class="fas fa-key"></i>
                            Reset Password
                        </button>
                    </div>
                </div>
            `;
            
            document.querySelector('.modal-title').textContent = 'User Details';
            document.getElementById('companyModal').style.display = 'block';
        }

        function contactUser(email) {
            window.open(`mailto:${email}`, '_blank');
        }

        function resetUserPassword(userId) {
            // Placeholder for password reset functionality
            alert(`Password reset request sent for user ID: ${userId}`);
            closeModal();
        }

        function updateCompanyUserCount(companyId, actualUserCount) {
            // Update the company in the companies array
            const companyIndex = companies.findIndex(c => c.id === companyId);
            if (companyIndex !== -1) {
                companies[companyIndex].userCount = actualUserCount;
                console.log(`Updated company ${companyId} user count to ${actualUserCount}`);
                
                // Also update in filtered companies if it exists there
                const filteredIndex = filteredCompanies.findIndex(c => c.id === companyId);
                if (filteredIndex !== -1) {
                    filteredCompanies[filteredIndex].userCount = actualUserCount;
                }
                
                // Update the specific table row without refreshing the entire table
                updateCompanyTableRow(companyId, actualUserCount);
                
                // Update the selected company info header if this is the currently selected company
                if (selectedCompany && selectedCompany.id === companyId) {
                    selectedCompany.userCount = actualUserCount;
                    const companyNameElement = document.getElementById('selectedCompanyName');
                    if (companyNameElement) {
                        companyNameElement.textContent = `${selectedCompany.name} (${actualUserCount} users)`;
                    }
                }
                
                // Update dashboard stats to reflect the change
                updateDashboardStats();
            }
        }

        function updateCompanyTableRow(companyId, userCount) {
            // Find the table row for this company and update the user count cell
            const tableBody = document.getElementById('companiesTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            rows.forEach(row => {
                // Check if this row corresponds to the company (by looking at onclick attribute)
                const onclick = row.getAttribute('onclick');
                if (onclick && onclick.includes(`viewCompanyUsers('${companyId}')`)) {
                    // Update user count cell
                    const userCell = row.querySelector('.users-cell');
                    if (userCell) {
                        userCell.textContent = userCount;
                    }
                    
                    // Update quota display dynamically
                    const quotaCell = row.querySelector('.quota-cell .quota-display');
                    if (quotaCell) {
                        // Get the company data to access userQuota
                        const company = companies.find(c => c.id === companyId);
                        if (company) {
                            const userQuota = company.userQuota || 0;
                            
                            // Create updated quota display
                            const quotaDisplay = userQuota > 0 ? `${userCount}/${userQuota}` : (userQuota === 0 ? 'No limit' : 'Not set');
                            const quotaClass = userQuota > 0 && userCount >= userQuota ? 'quota-exceeded' : 'quota-normal';
                            
                            // Update quota display text and class
                            quotaCell.textContent = quotaDisplay;
                            quotaCell.className = `quota-display ${quotaClass}`;
                            
                            console.log(`Updated quota display for company ${companyId}: ${quotaDisplay} (class: ${quotaClass})`);
                        }
                    }
                    
                    console.log(`Updated table row for company ${companyId} with user count ${userCount}`);
                }
            });
        }

        async function loadAllCompaniesUserCounts() {
            console.log('Loading user counts for all companies...');
            
            if (!companies || companies.length === 0) {
                console.log('No companies to load user counts for');
                return;
            }
            
            try {
                // Process companies in batches to avoid overwhelming Firebase
                const batchSize = 5;
                for (let i = 0; i < companies.length; i += batchSize) {
                    const batch = companies.slice(i, i + batchSize);
                    const promises = batch.map(async (company) => {
                        try {
                            let userCount = 0;
                            const seenEmails = new Set();
                            
                            // Try to load users from multiple paths
                            const usersSnapshot1 = await database.ref(`/users/${company.id}`).once('value');
                            const userData1 = usersSnapshot1.val();
                            
                            if (userData1) {
                                Object.keys(userData1).forEach(userId => {
                                    const user = userData1[userId];
                                    const userEmail = user.email;
                                    if (userEmail && userEmail !== 'Not provided' && !seenEmails.has(userEmail)) {
                                        seenEmails.add(userEmail);
                                        userCount++;
                                    } else if (!userEmail || userEmail === 'Not provided') {
                                        userCount++;
                                    }
                                });
                            } else {
                                const usersSnapshot2 = await database.ref(`/companies/${company.id}/users`).once('value');
                                const userData2 = usersSnapshot2.val();
                                if (userData2) {
                                    Object.keys(userData2).forEach(userId => {
                                        const user = userData2[userId];
                                        const userEmail = user.email;
                                        if (userEmail && userEmail !== 'Not provided' && !seenEmails.has(userEmail)) {
                                            seenEmails.add(userEmail);
                                            userCount++;
                                        } else if (!userEmail || userEmail === 'Not provided') {
                                            userCount++;
                                        }
                                    });
                                }
                            }
                            
                            // Check if admin exists and add to count only if not already counted
                            try {
                                const adminSnapshot = await database.ref(`/companies/${company.id}/admin`).once('value');
                                const adminData = adminSnapshot.val();
                                if (adminData && adminData.adminEmail) {
                                    if (!seenEmails.has(adminData.adminEmail)) {
                                        userCount += 1;
                                        console.log(`Added admin to count for company ${company.id}: ${adminData.adminEmail}`);
                                    }
                                }
                            } catch (adminError) {
                                console.log(`Could not load admin for company ${company.id}:`, adminError.message);
                            }
                            
                            company.userCount = userCount;
                            console.log(`Company ${company.id} (${company.name}) has ${userCount} total unique users`);
                            
                        } catch (error) {
                            console.error(`Error loading user count for company ${company.id}:`, error.message);
                            company.userCount = 0;
                        }
                    });
                    
                    await Promise.all(promises);
                }
                
                console.log('Finished loading user counts for all companies');
            } catch (error) {
                console.error('Error in loadAllCompaniesUserCounts:', error);
            }
        }

        async function loadAllCompaniesUserQuotas() {
            console.log('Loading user quotas for all companies...');
            
            // Process companies in batches to avoid overwhelming Firebase
            const batchSize = 5;
            for (let i = 0; i < companies.length; i += batchSize) {
                const batch = companies.slice(i, i + batchSize);
                const promises = batch.map(async (company) => {
                    try {
                        // Fetch user quota from /companies/{companyId}/userQuota
                        const quotaSnapshot = await database.ref(`/companies/${company.id}/userQuota`).once('value');
                        const quotaData = quotaSnapshot.val();
                        
                        let userQuota = 0;
                        if (quotaData !== null && quotaData !== undefined) {
                            // If it's a number, use it directly
                            if (typeof quotaData === 'number') {
                                userQuota = quotaData;
                           
                            }
                            // If it's an object with a limit field
                            else if (typeof quotaData === 'object' && quotaData.limit) {
                                userQuota = quotaData.limit;
                            }
                            // If it's an object with a max field
                            else if (typeof quotaData === 'object' && quotaData.max) {
                                userQuota = quotaData.max;
                            }
                        }
                        
                        // Update the company's user quota
                        company.userQuota = userQuota;
                        console.log(`Company ${company.id} (${company.name}) has user quota: ${userQuota}`);
                        
                    } catch (error) {
                        console.error(`Error loading user quota for company ${company.id}:`, error);
                        company.userQuota = 0;
                    }
                });
                
                // Wait for this batch to complete before processing the next
                await Promise.all(promises);
            }
            
            console.log('Finished loading user quotas for all companies');
        }

        function refreshAllQuotaDisplays() {
            console.log('Refreshing all quota displays...');
            
            companies.forEach(company => {
                if (company && company.id) {
                    updateCompanyTableRow(company.id, company.userCount || 0);
                }
            });
            
            console.log('Finished refreshing all quota displays');
        }

        async function loadCompanySubscriptions() {
            console.log('Loading subscription data for all companies...');
            
            // Process companies in batches to avoid overwhelming Firebase
            const batchSize = 5;
            for (let i = 0; i < companies.length; i += batchSize) {
                const batch = companies.slice(i, i + batchSize);
                const promises = batch.map(async (company) => {
                    try {
                        // Fetch selectedPlan directly from the company root
                        const subscriptionSnapshot = await database.ref(`/companies/${company.id}/selectedPlan`).once('value');
                        const selectedPlan = subscriptionSnapshot.val();
                        
                        if (selectedPlan) {
                            company.subscription = selectedPlan;
                            company.selectedPlan = selectedPlan;
                            console.log(`Updated subscription for company ${company.id} (${company.name}): ${selectedPlan}`);
                        } else {
                            console.log(`No selectedPlan found for company ${company.id}, keeping current: ${company.subscription || 'Basic'}`);
                        }
                        
                    } catch (error) {
                        console.error(`Error loading subscription for company ${company.id}:`, error);
                    }
                });
                
                // Wait for this batch to complete before processing the next
                await Promise.all(promises);
            }
            
            console.log('Finished loading subscription data for all companies');
        }

        // Auto-refresh data every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);

        // Load authenticated super admin avatar and information
        async function loadAuthenticatedUserAvatar() {
            try {
                console.log('Loading super admin avatar...');
                
                // Get super admin session data
                const superAdminSession = localStorage.getItem('superAdminSession');
                let superAdminData = null;
                
                if (superAdminSession) {
                    try {
                        superAdminData = JSON.parse(superAdminSession);
                    } catch (error) {
                        console.log('Could not parse super admin session data');
                    }
                }
                
                // Get super admin information from session
                const adminEmail = superAdminData?.email || 'admin@dreamexdatalab.com';
                const adminName = superAdminData?.name || 'Super Administrator';
                const adminPhoto = superAdminData?.photo || null;
                
                console.log('Super Admin:', { email: adminEmail, name: adminName, photo: adminPhoto });
                
                // Update user profile button
                const profileBtn = document.getElementById('userProfileBtn');
                const profileImg = profileBtn ? profileBtn.querySelector('img') : null;
                
                if (profileImg) {
                    if (adminPhoto && adminPhoto !== 'null' && adminPhoto !== 'undefined') {
                        // Use super admin's photo
                        profileImg.src = adminPhoto;
                        profileImg.alt = adminName;
                        console.log('Updated avatar with super admin photo:', adminPhoto);
                    } else {
                        // Try to load super admin avatar from Firebase
                        await loadSuperAdminAvatarFromFirebase(adminEmail, profileImg);
                    }
                }
                
                // Update user info in profile dropdown
                const userDisplayName = document.getElementById('userDisplayName');
                const userDisplayEmail = document.getElementById('userDisplayEmail');
                
                if (userDisplayName) {
                    userDisplayName.textContent = adminName;
                }
                
                if (userDisplayEmail) {
                    userDisplayEmail.textContent = adminEmail;
                } else {
                    // No super admin session found, set defaults
                    setDefaultSuperAdminInfo();
                }
                
            } catch (error) {
                console.error('Error loading super admin avatar:', error);
                // Set default super admin info on error
                setDefaultSuperAdminInfo();
            }
        }

        async function loadSuperAdminAvatarFromFirebase(adminEmail, profileImg) {
            if (!adminEmail || !database) {
                setDefaultSuperAdminAvatar(adminEmail, profileImg);
                return;
            }
            
            try {
                console.log('Attempting to load super admin avatar from Firebase for:', adminEmail);
                
                // Try to load from super admin collection
                const superAdminSnapshot = await database.ref('/superAdmins').once('value');
                const superAdminsData = superAdminSnapshot.val();
                
                if (superAdminsData) {
                    // Search through super admins to find matching email
                    for (const adminId in superAdminsData) {
                        const adminData = superAdminsData[adminId];
                        if (adminData && adminData.email === adminEmail) {
                            console.log('Found super admin data:', adminData);
                            
                            // Update avatar if photo exists
                            if (adminData.photoURL || adminData.photo || adminData.profilePicture) {
                                const photoURL = adminData.photoURL || adminData.photo || adminData.profilePicture;
                                profileImg.src = photoURL;
                                profileImg.alt = adminData.name || adminData.displayName || 'Super Administrator';
                                
                                // Store in session for future use
                                const sessionData = {
                                    email: adminEmail,
                                    name: adminData.name || adminData.displayName,
                                    photo: photoURL,
                                    timestamp: new Date().toISOString()
                                };
                                localStorage.setItem('superAdminSession', JSON.stringify(sessionData));
                                
                                // Update profile dropdown info
                                const userDisplayName = document.getElementById('userDisplayName');
                                const userDisplayEmail = document.getElementById('userDisplayEmail');
                                
                                if (userDisplayName) {
                                    userDisplayName.textContent = adminData.name || adminData.displayName || 'Super Administrator';
                                }
                                
                                if (userDisplayEmail) {
                                    userDisplayEmail.textContent = adminEmail;
                                }
                                
                                console.log('Updated super admin avatar from Firebase:', photoURL);
                                return;
                            }
                        }
                    }
                }
                
                // If no avatar found, use default
                setDefaultSuperAdminAvatar(adminEmail, profileImg);
                
            } catch (error) {
                console.error('Error loading super admin avatar from Firebase:', error);
                setDefaultSuperAdminAvatar(adminEmail, profileImg);
            }
        }

        function setDefaultSuperAdminAvatar(email, profileImg) {
            // Create avatar with super admin crown icon
            const canvas = document.createElement('canvas');
            canvas.width = 80;
            canvas.height = 80;
            const ctx = canvas.getContext('2d');
            
            // Draw background with super admin colors
            const gradient = ctx.createLinearGradient(0, 0, 80, 80);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 80, 80);
            
            // Draw crown icon
            ctx.fillStyle = '#FFD700';
            ctx.font = 'bold 32px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('👑', 40, 40);
            
            // Set the generated image as avatar
            profileImg.src = canvas.toDataURL();
            profileImg.alt = 'Super Administrator';
            
            console.log('Set default super admin avatar with crown icon');
        }

        function setDefaultSuperAdminInfo() {
            // Set default super admin information
            const userDisplayName = document.getElementById('userDisplayName');
            const userDisplayEmail = document.getElementById('userDisplayEmail');
            const profileImg = document.querySelector('#userProfileBtn img');
            
            if (userDisplayName) {
                userDisplayName.textContent = 'Super Administrator';
            }
            
            if (userDisplayEmail) {
                userDisplayEmail.textContent = 'admin@dreamexdatalab.com';
            }
            
            if (profileImg) {
                setDefaultSuperAdminAvatar('admin@dreamexdatalab.com', profileImg);
            }
        }

        // Header Navigation Functions
        document.addEventListener('DOMContentLoaded', function() {
            // Notification dropdown toggle
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.style.display = notificationDropdown.style.display === 'block' ? 'none' : 'block';
                    // Close user dropdown if open
                    document.querySelector('.profile-dropdown').style.display = 'none';
                });
            }

            // User profile dropdown toggle
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.style.display = profileDropdown.style.display === 'block' ? 'none' : 'block';
                    // Close notification dropdown if open
                    notificationDropdown.style.display = 'none';
                });
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (notificationDropdown) {
                    notificationDropdown.style.display = 'none';
                }
                if (profileDropdown) {
                    profileDropdown.style.display = 'none';
                }
            });

            // Mark all notifications as read
            const markAllReadBtn = document.querySelector('.mark-all-read');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', function() {
                    const notificationBadge = document.querySelector('.notification-badge');
                    if (notificationBadge) {
                        notificationBadge.textContent = '0';
                    }
                    // Here you would typically update the notification status in the database
                    console.log('Marked all notifications as read');
                });
            }

            // Load notifications (placeholder function)
            loadNotifications();
        });

        function loadNotifications() {
            // Placeholder function for loading notifications
            // In a real implementation, this would fetch notifications from the database
            const notificationBadge = document.querySelector('.notification-badge');
            const notificationList = document.querySelector('.notification-list');
            
            if (notificationBadge) {
                // Set a placeholder count
                notificationBadge.textContent = '0';
            }
            
            if (notificationList) {
                // Add placeholder message
                notificationList.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #6c757d;">
                        <i class="fas fa-bell-slash" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No new notifications</p>
                    </div>
                `;
            }
        }
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }
});
</script>
</body>
</html>

