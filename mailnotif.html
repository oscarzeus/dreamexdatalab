<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mail & Notifications - Dreamex Datalab HSE</title>
    
    <!-- Enhanced Font Awesome CSS with CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- EmailJS CDN for email service -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <!-- EmailJS Service -->
    <script src="js/emailjs-service.js"></script>
    
    <style>
/* Font Awesome 6.4.0 - Fallback Definitions */
.fa, .fas, .fa-solid, .far, .fa-regular, .fab, .fa-brands {
    font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands";
    font-style: normal;
    line-height: 1;
    text-rendering: auto;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.fas, .fa-solid {
    font-weight: 900;
}

.far, .fa-regular {
    font-weight: 400;
}

.fab, .fa-brands {
    font-family: "Font Awesome 6 Brands";
    font-weight: 400;
}

.far, .fa-regular {
    font-family: "Font Awesome 6 Free";
    font-weight: 400;
}

.fa, .fab, .fad, .fal, .far, .fas, .fat {
    -moz-osx-font-smoothing: grayscale;
    -webkit-font-smoothing: antialiased;
    display: inline-block;
    font-style: normal;
    font-variant: normal;
    line-height: 1;
    text-rendering: auto;
}

/* Fallback for broken icons */
.fa:before, .fas:before, .far:before, .fab:before,
[class^="fa-"]:before, [class*=" fa-"]:before {
    display: inline-block;
    text-decoration: inherit;
    width: 1em;
    text-align: center;
    font-variant: normal;
    text-transform: none;
    line-height: 1em;
    margin-left: .2em;
    margin-right: .2em;
}

/* Enhanced Icon definitions */
.fa-bell:before { content: "\f0f3"; }
.fa-envelope:before { content: "\f0e0"; }
.fa-envelope-open-text:before { content: "\f658"; }
.fa-user:before { content: "\f007"; }
.fa-search:before { content: "\f002"; }
.fa-times:before { content: "\f00d"; }
.fa-plus:before { content: "\f067"; }
.fa-edit:before { content: "\f044"; }
.fa-trash:before { content: "\f1f8"; }
.fa-cog:before { content: "\f013"; }
.fa-download:before { content: "\f019"; }
.fa-check:before { content: "\f00c"; }
.fa-filter:before { content: "\f0b0"; }
.fa-refresh:before { content: "\f021"; }
.fa-home:before { content: "\f015"; }
.fa-dashboard:before { content: "\f0e4"; }
.fa-settings:before { content: "\f013"; }
.fa-bars:before { content: "\f0c9"; }
.fa-medkit:before { content: "\f0fa"; }
.fa-shield-alt:before { content: "\f3ed"; }
.fa-leaf:before { content: "\f06c"; }
.fa-lock:before { content: "\f023"; }
.fa-truck:before { content: "\f0d1"; }
.fa-users:before { content: "\f0c0"; }
.fa-user-tie:before { content: "\f508"; }
.fa-history:before { content: "\f1da"; }
.fa-sign-out-alt:before { content: "\f2f5"; }
.fa-server:before { content: "\f233"; }
.fa-file-alt:before { content: "\f15c"; }
.fa-vial:before { content: "\f492"; }
.fa-sync:before { content: "\f021"; }
.fa-sync-alt:before { content: "\f2f1"; }
.fa-calendar:before { content: "\f133"; }
.fa-clock:before { content: "\f017"; }
.fa-envelope-square:before { content: "\f199"; }
.fa-mail-bulk:before { content: "\f674"; }
.fa-at:before { content: "\f1fa"; }
.fa-paper-plane:before { content: "\f1d8"; }
.fa-inbox:before { content: "\f01c"; }
.fa-outbox:before { content: "\f01d"; }
.fa-envelope-open:before { content: "\f2b6"; }
.fa-file-code:before { content: "\f1c9"; }
.fa-code:before { content: "\f121"; }
.fa-database:before { content: "\f1c0"; }
.fa-wifi:before { content: "\f1eb"; }
.fa-network-wired:before { content: "\f6ff"; }

/* DataTables Bootstrap 5 CSS */
table.dataTable {
    width: 100%;
    margin: 0 auto;
    clear: both;
    border-collapse: separate;
    border-spacing: 0;
}

table.dataTable thead th,
table.dataTable tfoot th {
    font-weight: bold;
}

table.dataTable thead th,
table.dataTable thead td {
    padding: 10px 18px;
    border-bottom: 1px solid #111;
}

table.dataTable thead th:active,
table.dataTable thead td:active {
    outline: none;
}

table.dataTable tfoot th,
table.dataTable tfoot td {
    padding: 10px 18px 6px 18px;
    border-top: 1px solid #111;
}

table.dataTable thead .sorting,
table.dataTable thead .sorting_asc,
table.dataTable thead .sorting_desc,
table.dataTable thead .sorting_asc_disabled,
table.dataTable thead .sorting_desc_disabled {
    cursor: pointer;
    background-repeat: no-repeat;
    background-position: center right;
}

table.dataTable thead .sorting {
    background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAATCAQAAADYWf5HAAAAkElEQVQoz7XSQQ5AQBRF0/8/2jkI5YJqSKhQ6Kg4UcJE7CXA9LTzSi8xnzd9Pd/vq1du/3b45rt9fv38Lzl/30eW7/Tz7TduN78+P+8gHwfzO9Xpby9vfp1Y/vQ6v7zZ7T6v9Z/2t2t94/zN/fX+z8f8X8w/wH8A/r19s/xrj6YO16f7m+/oG7N/8gdfbQAAAABJRU5ErkJggg==");
}

.table > :not(caption) > * > * {
    padding: .5rem .5rem;
    background-color: var(--bs-table-bg);
    border-bottom-width: 1px;
    box-shadow: inset 0 0 0 9999px var(--bs-table-accent-bg);
}

.table > tbody {
    vertical-align: inherit;
}

.table > thead {
    vertical-align: bottom;
}

.table > :not(:first-child) {
    border-top: 2px solid currentColor;
}

.caption-top {
    caption-side: top;
}

.table-sm > :not(caption) > * > * {
    padding: .25rem .25rem;
}

.table-bordered > :not(caption) > * {
    border-width: 1px 0;
}

.table-bordered > :not(caption) > * > * {
    border-width: 0 1px;
}

.table-borderless > :not(caption) > * > * {
    border-bottom-width: 0;
}

.table-borderless > :not(:first-child) {
    border-top-width: 0;
}

.table-striped > tbody > tr:nth-of-type(odd) > * {
    --bs-table-accent-bg: var(--bs-table-striped-bg);
    color: var(--bs-table-striped-color);
}

.table-active {
    --bs-table-accent-bg: var(--bs-table-active-bg);
    color: var(--bs-table-active-color);
}

.table-hover > tbody > tr:hover > * {
    --bs-table-accent-bg: var(--bs-table-hover-bg);
    color: var(--bs-table-hover-color);
}

/* Local Styles from css/styles.css */
:root {
    --primary-color: #2c3e50;
    --primary-dark: #1a252f;
    --secondary-color: #3498db;
    --accent-color: #e74c3c;
    --text-color: #333;
    --bg-color: #f5f6fa;
    --sidebar-width: 250px;
    /* Theme Colors */
    --blue: #3498db;
    --green: #2ecc71;
    --purple: #9b59b6;
    --orange: #e67e22;
    --red: #e74c3c;
    
    /* Enhanced Colors */
    --accent-color: var(--blue);
    --font-family: 'Inter', system-ui, -apple-system, sans-serif;
    --base-font-size: 0.9rem;
    --font-scale: 1;
    
    /* Theme-specific variables */
    --bg-primary: #ffffff;
    --bg-secondary: #f8f9fa;
    --text-primary: #333333;
    --text-secondary: #666666;
    --text-muted: #999999;
    --border-color: #e0e0e0;
    --hover-bg: #f8f9fa;
    
    /* Spacing System */
    --spacing-unit: 1rem;
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --padding-sm: 0.5rem;
    --padding-md: 1rem;
    --padding-lg: 1.5rem;
    
    /* Border Radius */
    --radius-sm: 3px;
    --radius-md: 5px;
    --radius-lg: 8px;
    --radius-xl: 12px;
    
    /* Shadows */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-lg: 0 16px 48px rgba(0,0,0,0.2), 0 8px 24px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.1);
    --shadow-xl: 0 20px 60px rgba(0,0,0,0.25), 0 12px 32px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.12);
    
    /* Transitions */
    --transition-fast: 0.2s ease;
    --transition-speed: 0.2s;
}

/* Dark Theme Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-family);
    font-size: var(--base-font-size);
    line-height: calc(1.5 * var(--font-scale));
    color: var(--text-primary);
    background-color: var(--bg-primary);
    transition: background-color var(--transition-speed), color var(--transition-speed);
}

/* Main Layout */
.app-container {
    display: flex;
    min-height: 100vh;
}

/* Sidebar Styles */
.sidebar {
    width: var(--sidebar-width);
    background-color: var(--primary-color);
    color: white;
    padding: 1rem;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
    z-index: 1000;
    transition: transform 0.3s ease;
}

/* Sidebar collapsed state */
.sidebar.collapsed {
    transform: translateX(-100%);
}

/* Main content adjustments when sidebar is collapsed */
.main-content.sidebar-collapsed {
    margin-left: 0;
}

.main-content.sidebar-collapsed .top-nav {
    left: 0.5rem;
}

.logo h2 {
    text-align: center;
    padding: 1rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.menu {
    list-style: none;
    margin-top: 2rem;
}

.menu li {
    margin-bottom: 0.5rem;
}

.menu a {
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border-radius: 0;
    transition: background-color 0.3s;
}

.menu a i {
    margin-right: 10px;
}

.menu a:hover, .menu a.active {
    background-color: var(--secondary-color);
}

.menu-dropdown .submenu {
    display: none;
    list-style: none;
    margin-left: 2rem;
    margin-top: 0.5rem;
}

.menu-dropdown:hover .submenu {
    display: block;
}

/* Menu Visibility Styles */
/* Force hide all menu items by default until permissions are loaded */
#roleBasedMenu li[data-feature],
#roleBasedMenu .menu-dropdown {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    transition: none !important;
}

/* Show menu items when they have proper visibility class */
#roleBasedMenu li[data-feature].menu-visible,
#roleBasedMenu .menu-dropdown.menu-visible {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Ensure submenu items follow parent visibility */
#roleBasedMenu .menu-dropdown:not(.menu-visible) li {
    display: none !important;
}

#roleBasedMenu .menu-dropdown.menu-visible li {
    display: block !important;
}

/* Role Permission Status Bar Styles */
.role-permission-status {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.75rem 1rem;
    margin: 0.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #4CAF50;
}

.status-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
}

.role-info,
.permission-info,
.menu-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.role-info i,
.permission-info i,
.menu-status i {
    color: #FFD700;
    width: 16px;
}

.toggle-details-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.toggle-details-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

.permission-details {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    animation: slideDown 0.3s ease;
}

.permissions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
    margin-top: 0.75rem;
}

.permission-item {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.permission-item i {
    color: #4CAF50;
    width: 14px;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .status-content {
        flex-direction: column;
        align-items: stretch;
    }
    
    .permissions-grid {
        grid-template-columns: 1fr;
    }
}

/* Main Content Styles */
.main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 0.5rem;
    width: calc(100% - var(--sidebar-width));
    box-sizing: border-box;
}

.content {
    width: 100%;
    margin: 0;
    padding: 1.5rem;
    background-color: white;
    border-radius: 0;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.top-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: white;
    border-radius: 0;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    margin-bottom: 1rem;
    position: relative;
}

.top-nav-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.sidebar-toggle-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-secondary);
    transition: background-color 0.3s ease;
}

.sidebar-toggle-btn:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

.header-company-logo {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid #e9ecef;
    display: none;
}

.header-company-logo.visible {
    display: block;
}

.header-logo-placeholder {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: #f8f9fa;
    border: 2px dashed #ced4da;
    display: none;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 1.2rem;
}

.company-name-header {
    font-weight: 600;
    color: #2c3e50;
    font-size: 1.1rem;
    display: inline-block;
}

.sidebar-toggle-btn:hover {
    background-color: #f8f9fa;
    border-radius: 0;
}

.header-company-logo {
    width: 60px;
    height: 60px;
    border-radius: 0;
    object-fit: cover;
    display: none;
}

.header-company-logo.visible {
    display: block;
}

.header-logo-placeholder {
    width: 60px;
    height: 60px;
    border-radius: 0;
    background: #f8f9fa;
    display: none;
    align-items: center;
    justify-content: center;
    color: #6c757d;
    font-size: 1.2rem;
    border: none;
}

.company-name-header {
    font-weight: 600;
    color: #2c3e50;
    font-size: 1.1rem;
    display: inline-block;
}

.top-nav-right {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-left: auto;
}

/* Notification Styles */
.notifications {
    position: relative;
    display: flex;
    align-items: center;
}

.notification-btn {
    background: none;
    border: none;
    cursor: pointer;
    position: relative;
    font-size: 1.2rem;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: var(--accent-color);
    color: white;
    border-radius: 50%;
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
}

.notification-dropdown {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    width: 300px;
    background-color: white;
    border-radius: 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

.notification-dropdown.show {
    display: block;
}

.notification-header {
    padding: 1rem;
    border-bottom: 1px solid #ddd;
}

.notification-list {
    max-height: 300px;
    overflow-y: auto;
}

.notification-item {
    padding: 1rem;
    border-bottom: 1px solid #ddd;
    cursor: pointer;
}

.notification-item:hover {
    background-color: #f5f5f5;
}

/* User Profile Styles */
.user-profile {
    position: relative;
    display: flex;
    align-items: center;
}

.profile-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
}

.profile-btn img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.user-initials {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 14px;
    border: 2px solid rgba(255, 255, 255, 0.1);
}

.profile-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background: #fff;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    min-width: 250px;
    z-index: 1000;
    border: 1px solid var(--border-color);
}

.profile-dropdown.show {
    display: block;
}

.profile-dropdown-header {
    padding: var(--padding-md);
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-secondary);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.user-info {
    text-align: center;
}

.user-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
}

.user-email {
    font-size: 0.8rem;
    color: var(--text-secondary);
    word-break: break-word;
}

.profile-dropdown ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.profile-dropdown ul li {
    padding: 0;
}

.profile-dropdown ul li a {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    color: #333;
    text-decoration: none;
    transition: background-color 0.2s;
}

.profile-dropdown ul li a:hover {
    background-color: #f8f9fa;
}

.profile-dropdown ul li a i {
    margin-right: 10px;
    width: 16px;
}

/* Enhanced Button Styles */
.btn {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--padding-sm) var(--padding-md);
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    transition: all var(--transition-speed);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
    border: 1px solid var(--primary-color);
}

.btn-primary:hover {
    background-color: var(--primary-dark);
    border-color: var(--primary-dark);
}

.btn-secondary {
    background-color: var(--secondary-color);
    color: white;
    border: 1px solid var(--secondary-color);
}

.btn-secondary:hover {
    background-color: #2980b9;
    border-color: #2980b9;
}

.btn-success {
    background-color: var(--green);
    color: white;
    border: 1px solid var(--green);
}

.btn-success:hover {
    background-color: #27ae60;
    border-color: #27ae60;
}

.btn-danger {
    background-color: var(--red);
    color: white;
    border: 1px solid var(--red);
}

.btn-danger:hover {
    background-color: #c0392b;
    border-color: #c0392b;
}

.btn-warning {
    background-color: var(--orange);
    color: white;
    border: 1px solid var(--orange);
}

.btn-warning:hover {
    background-color: #d35400;
    border-color: #d35400;
}

.btn-icon {
    padding: var(--spacing-sm);
    border-radius: var(--radius-lg);
}

/* Enhanced Form Elements */
.form-group {
    margin-bottom: var(--spacing-unit);
}

.form-group label,
.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.form-group input,
.form-group textarea,
.form-group select,
.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: var(--radius-md);
    font-size: 1rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    transition: all var(--transition-fast);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus,
.form-control:focus {
    outline: none;
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    background: var(--bg-primary);
}

.form-control::placeholder {
    color: var(--text-muted);
}

.input-group {
    position: relative;
    display: flex;
}

.input-group-icon {
    position: absolute;
    left: var(--spacing-md);
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    z-index: 2;
}

.input-group .form-control {
    padding-left: 2.5rem;
}

/* Enhanced Tables */
.table-container {
    background: white;
    border-radius: 0;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    width: 100%;
    margin: 0;
    transition: box-shadow 0.3s ease;
}

.table-container:hover {
    box-shadow: var(--shadow-xl);
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin: 0;
    background: transparent;
    font-size: 0.9rem;
}

.table th {
    background: #f8f9fa;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #e9ecef;
    white-space: nowrap;
    transition: background-color 0.3s ease, color 0.3s ease;
}

.table td {
    padding: 1rem;
    border-bottom: 1px solid #e9ecef;
    vertical-align: top;
    color: #495057;
}

.table tbody tr:hover {
    background: #f8f9fa;
    cursor: pointer;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.table tbody tr {
    transition: all 0.2s ease;
}

/* Enhanced Cards */
.card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    transition: all var(--transition-fast);
    overflow: hidden;
}

.card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.card-header {
    background: var(--bg-secondary);
    padding: var(--padding-md);
    border-bottom: 1px solid var(--border-color);
    font-weight: 600;
    color: var(--text-primary);
}

.card-body {
    padding: var(--padding-md);
}

.card-footer {
    background: var(--bg-secondary);
    padding: var(--padding-md);
    border-top: 1px solid var(--border-color);
}

/* Enhanced Modal Styling */
.modal-content {
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    border: none;
}

.modal-header {
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
}

.modal-footer {
    background: var(--bg-secondary);
    border-top: 1px solid var(--border-color);
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
}

/* Enhanced Badges and Status */
.badge {
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-md);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-success {
    background-color: var(--green);
    color: white;
}

.badge-danger {
    background-color: var(--red);
    color: white;
}

.badge-warning {
    background-color: var(--orange);
    color: white;
}

.badge-info {
    background-color: var(--blue);
    color: white;
}

/* Enhanced Utilities */
.text-center { text-align: center; }
.text-left { text-align: left; }
.text-right { text-align: right; }

.mb-0 { margin-bottom: 0; }
.mb-1 { margin-bottom: var(--spacing-xs); }
.mb-2 { margin-bottom: var(--spacing-sm); }
.mb-3 { margin-bottom: var(--spacing-md); }
.mb-4 { margin-bottom: var(--spacing-lg); }

.mt-0 { margin-top: 0; }
.mt-1 { margin-top: var(--spacing-xs); }
.mt-2 { margin-top: var(--spacing-sm); }
.mt-3 { margin-top: var(--spacing-md); }
.mt-4 { margin-top: var(--spacing-lg); }

.p-0 { padding: 0; }
.p-1 { padding: var(--spacing-xs); }
.p-2 { padding: var(--spacing-sm); }
.p-3 { padding: var(--spacing-md); }
.p-4 { padding: var(--spacing-lg); }

.d-flex { display: flex; }
.align-items-center { align-items: center; }
.justify-content-between { justify-content: space-between; }
.justify-content-center { justify-content: center; }
.gap-1 { gap: var(--spacing-xs); }
.gap-2 { gap: var(--spacing-sm); }
.gap-3 { gap: var(--spacing-md); }

/* Enhanced Status Indicators */
.status-active {
    color: var(--green);
    font-weight: 600;
}

.status-inactive {
    color: var(--red);
    font-weight: 600;
}

.status-pending {
    color: var(--orange);
    font-weight: 600;
}

/* Enhanced Loading States */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner {
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--primary-color);
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 0.5rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Enhanced Responsive Design */
@media (max-width: 768px) {
    .btn {
        padding: var(--spacing-sm);
        font-size: 0.8rem;
    }
    
    .table th,
    .table td {
        padding: 0.5rem;
        font-size: 0.8rem;
    }
    
    .notifications-table th,
    .notifications-table td {
        padding: 0.75rem;
        font-size: 0.8rem;
    }
    
    .tracking-filters {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-group {
        width: 100%;
    }
}

/* Enhanced Focus States */
.btn:focus,
.form-control:focus {
    outline: 2px solid var(--secondary-color);
    outline-offset: 2px;
}

/* Enhanced Animation Classes */
.fade-in {
    animation: fadeIn 0.3s ease-in;
}

.slide-up {
    animation: slideUp 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from { 
        opacity: 0;
        transform: translateY(20px);
    }
    to { 
        opacity: 1;
        transform: translateY(0);
    }
}

/* Enhanced Hover Effects */
.hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    transition: all var(--transition-fast);
}

.hover-scale:hover {
    transform: scale(1.02);
    transition: all var(--transition-fast);
}

.table th {
    background: var(--bg-primary);
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
}

.table tbody tr {
    transition: background-color var(--transition-fast);
}

.table tbody tr:hover {
    background: var(--hover-bg);
}

/* Cards */
.card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    box-shadow: var(--shadow-md);
    transition: all var(--transition-normal);
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.card-header {
    border-bottom: 1px solid var(--border-color);
    margin-bottom: var(--spacing-md);
    padding-bottom: var(--spacing-md);
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.card-subtitle {
    color: var(--text-muted);
    font-size: 0.875rem;
}

/* Modals */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-xl);
    transform: scale(0.95) translateY(20px);
    transition: all var(--transition-normal);
}

.modal-overlay.active .modal {
    transform: scale(1) translateY(0);
}

.modal-header {
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: var(--spacing-lg);
}

.modal-footer {
    padding: var(--spacing-lg);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
}

/* Status Badges */
.badge {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.badge-warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-color);
    border: 1px solid rgba(245, 158, 11, 0.2);
}

.badge-error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-color);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.badge-info {
    background: rgba(59, 130, 246, 0.1);
    color: var(--info-color);
    border: 1px solid rgba(59, 130, 246, 0.2);
}

/* Sidebar Navigation */
.sidebar-header {
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
}

.sidebar-brand {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text-primary);
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.sidebar-nav {
    padding: var(--spacing-md) 0;
}

.nav-item {
    list-style: none;
}

.nav-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-lg);
    color: var(--text-secondary);
    text-decoration: none;
    transition: all var(--transition-fast);
    border-left: 3px solid transparent;
}

.nav-link:hover,
.nav-link.active {
    background: var(--hover-bg);
    color: var(--text-primary);
    border-left-color: var(--primary-color);
}

.nav-link i {
    width: 1.25rem;
    text-align: center;
}

/* Utility Classes */
.text-center { text-align: center; }
.text-right { text-align: right; }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--success-color); }
.text-warning { color: var(--warning-color); }
.text-error { color: var(--error-color); }
.text-info { color: var(--info-color); }

.mb-0 { margin-bottom: 0; }
.mb-1 { margin-bottom: var(--spacing-xs); }
.mb-2 { margin-bottom: var(--spacing-sm); }
.mb-3 { margin-bottom: var(--spacing-md); }
.mb-4 { margin-bottom: var(--spacing-lg); }
.mb-5 { margin-bottom: var(--spacing-xl); }

.mt-0 { margin-top: 0; }
.mt-1 { margin-top: var(--spacing-xs); }
.mt-2 { margin-top: var(--spacing-sm); }
.mt-3 { margin-top: var(--spacing-md); }
.mt-4 { margin-top: var(--spacing-lg); }
.mt-5 { margin-top: var(--spacing-xl); }

.d-flex { display: flex; }
.d-block { display: block; }
.d-none { display: none; }
.d-inline-block { display: inline-block; }

.align-items-center { align-items: center; }
.justify-content-between { justify-content: space-between; }
.justify-content-center { justify-content: center; }
.justify-content-end { justify-content: flex-end; }

.flex-wrap { flex-wrap: wrap; }
.flex-column { flex-direction: column; }

.w-100 { width: 100%; }
.h-100 { height: 100%; }

/* Loading States */
.loading {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }
    
    .sidebar.mobile-visible {
        transform: translateX(0);
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    .modal {
        margin: var(--spacing-md);
        max-width: none;
        width: auto;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn var(--transition-normal) ease-in-out;
}

.slide-up {
    animation: slideUp var(--transition-normal) ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Focus States */
.btn:focus,
.form-control:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

/* Print Styles */
@media print {
    .sidebar,
    .header-actions,
    .btn {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0;
    }
    
    body {
        background: white;
        color: black;
    }
    
    .card,
    .table-container {
        border: 1px solid #ddd;
        box-shadow: none;
    }
}

/* Additional Custom Styles */
.mailnotif-container {
    padding: 1rem;
    width: 100%;
    max-width: none;
}

/* Page Header Styles */
.page-header {
    margin-bottom: 2rem;
}

.header-top-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.header-left {
    flex: 1;
}

.page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.page-title i {
    color: var(--secondary-color);
}

.page-subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.5;
}
          .mailnotif-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: none;
        }
        
        .mailnotif-title h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mailnotif-title p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }
          .settings-tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            border-bottom: 3px solid #f1f3f4;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: none;
        }
        
        .tab-button {
            flex: 1;
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab-button:hover {
            background: #f8f9fa;
            color: #333;
        }
        
        .tab-button.active {
            background: #2c3e50;
            color: white;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #3498db;
        }
          .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: none;
        }
          .tab-content.active {
            display: block;
        }
          .settings-section {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f3f4;
            width: 100%;
            max-width: none;
        }
        
        .settings-section:last-child {
            border-bottom: none;
        }

        /* Enhanced Email Notifications Table Styles */
        .notifications-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: box-shadow 0.3s ease;
        }

        .notifications-table:hover {
            box-shadow: var(--shadow-xl);
        }

        .notifications-table th,
        .notifications-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .notifications-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .notifications-table tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .notifications-table tbody tr {
            transition: all 0.2s ease;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-success {
            background: var(--green);
            color: white;
        }

        .status-error {
            background: var(--red);
            color: white;
        }

        .status-pending {
            background: var(--orange);
            color: white;
        }

        .status-info {
            background: var(--blue);
            color: white;
        }

        .notification-time {
            color: #6c757d;
            font-size: 0.875rem;
        }

        .refresh-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .refresh-button:hover {
            background: #2980b9;
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .filter-dropdown {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .settings-section h3 {
            color: #2c3e50;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-section p {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }          .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            width: 100%;
            max-width: none;
        }
          .settings-group {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            width: 100%;
            max-width: none;
        }
        
        .settings-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
          .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-control.is-valid {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .form-control.is-invalid {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        
        .form-help {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.5rem;
            line-height: 1.4;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0.5rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #27ae60;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }          .template-editor {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            width: 100%;
            max-width: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .mailnotif-container {
                padding: 0.5rem;
            }

            .mailnotif-header {
                padding: 1rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .settings-group {
                padding: 1rem;
            }

            .settings-tabs {
                flex-direction: column;
            }

            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .mailnotif-header {
                padding: 0.75rem;
            }

            .mailnotif-title h2 {
                font-size: 1.5rem;
            }

            .settings-section {
                padding: 1rem;
            }

            .form-control {
                padding: 0.5rem;
                font-size: 0.9rem;
            }

            .tab-button {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
        }
        
        .template-editor textarea {
            width: 100%;
            min-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }
        
        .template-preview {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .test-results {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #6c757d; }
        .log-warning { color: #ffc107; }
        
        .smtp-config, .emailjs-config {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .emailjs-config {
            border-color: #007bff;
        }
        
        .config-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 1rem;
        }
        
        .config-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        /* EmailJS Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* EmailJS Instructions */
        .emailjs-instructions {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .instruction-steps {
            margin-top: 1rem;
        }
        
        .step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .step-number {
            background: #007bff;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content strong {
            color: #495057;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .step-content p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* Template Variables */
        .template-variables {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .variables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .variable-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        .variable-item code {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            margin-right: 0.75rem;
            color: #495057;
            font-weight: bold;
        }
        
        .variable-item span {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        /* Connection Statistics Styles */
        .connection-statistics {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.1);
        }
        
        .connection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 0.5rem;
            border-radius: 6px;
            background: rgba(40, 167, 69, 0.05);
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .stat-value.success {
            color: #28a745;
        }
        
        .stat-value.error {
            color: #dc3545;
        }
        
        .stat-value.warning {
            color: #ffc107;
        }
        
        /* Advanced Settings Styles */
        .advanced-settings {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .advanced-settings h5 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Troubleshooting Steps Styles */
        .troubleshooting-steps {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .troubleshooting-steps h6 {
            color: #495057;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .troubleshooting-steps ul {
            margin: 0;
            padding-left: 1.5rem;
        }
        
        .troubleshooting-steps li {
            margin-bottom: 0.25rem;
            color: #666;
            line-height: 1.4;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .variable-tag {
            display: inline-block;
            background: #e9ecef;
            color: #495057;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            margin: 2px;
        }
        
        .recipient-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .recipient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f1f3f4;
        }
        
        .recipient-item:last-child {
            border-bottom: none;
        }
        
        .recipient-info {
            display: flex;
            flex-direction: column;
        }
        
        .recipient-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .recipient-email {
            font-size: 0.85rem;
            color: #666;
        }
          .recipient-role {
            font-size: 0.75rem;
            color: #95a5a6;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            margin-top: 2px;
            align-self: flex-start;
        }

        /* Firebase Recipients Styles */
        .firebase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .firebase-header label {
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .firebase-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .firebase-live {
            font-size: 0.75rem;
            color: #27ae60;
            background: #d5f4e6;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .firebase-live::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #27ae60;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .firebase-header button {
            background: #34495e;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .firebase-header button:hover {
            background: #2c3e50;
            transform: translateY(-1px);
        }

        .firebase-header button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .recipient-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .firebase-loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .firebase-loading i {
            margin-right: 8px;
            color: #3498db;
        }

        .firebase-error {
            text-align: center;
            padding: 2rem;
            color: #e74c3c;
        }

        .firebase-error i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #e74c3c;
        }

        .firebase-error p {
            margin: 0.5rem 0;
            font-weight: 500;
        }

        .firebase-error button {
            margin-top: 1rem;
        }

        .recipient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e8eaed;
            background: white;
            transition: all 0.2s ease;
        }

        .recipient-item:last-child {
            border-bottom: none;
        }

        .recipient-item:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }

        .recipient-info {
            flex: 1;
        }

        .recipient-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .recipient-email {
            font-size: 0.875rem;
            color: #7f8c8d;
            margin-bottom: 6px;
        }

        .recipient-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .recipient-dept {
            font-size: 0.75rem;
            color: #8e44ad;
            background: #f3e5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .recipient-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .firebase-badge {
            font-size: 0.7rem;
            color: #f39c12;
            background: #fff3cd;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            border: 1px solid #f39c12;
        }

        .no-recipients {
            text-align: center;
            padding: 3rem 2rem;
            color: #7f8c8d;
        }

        .no-recipients i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #bdc3c7;
        }

        .no-recipients p {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0.5rem 0;
        }

        .no-recipients small {
            color: #95a5a6;
        }

        .firebase-actions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e8eaed;
        }        .firebase-actions .btn {
            text-decoration: none;
            font-size: 0.875rem;
        }

        /* Dynamic Recipients Management Styles */
        .recipient-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e8eaed;
        }

        .recipient-header label {
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            font-size: 1.1rem;
        }

        .recipient-actions-header {
            display: flex;
            gap: 8px;
        }

        .recipient-summary {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e8eaed;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .summary-label {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-weight: 500;
            text-transform: uppercase;
        }

        .summary-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e8eaed;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #7f8c8d;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #e74c3c;
            color: white;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e8eaed;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-radius: 0 0 12px 12px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid #e8eaed;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        /* Enhanced recipient item styles */
        .recipient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e8eaed;
            background: white;
            transition: all 0.2s ease;
        }

        .recipient-item:last-child {
            border-bottom: none;
        }

        .recipient-item:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }

        .recipient-info {
            flex: 1;
        }

        .recipient-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .recipient-email {
            font-size: 0.875rem;
            color: #7f8c8d;
            margin-bottom: 6px;
        }

        .recipient-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .recipient-dept {
            font-size: 0.75rem;
            color: #8e44ad;
            background: #f3e5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .recipient-types {
            font-size: 0.7rem;
            color: #27ae60;
            background: #d5f4e6;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        .recipient-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: var(--radius-sm);
        }

        .btn-edit {
            background-color: var(--orange);
            color: white;
            border: 1px solid var(--orange);
        }

        .btn-edit:hover {
            background-color: #d35400;
            border-color: #d35400;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-delete {
            background-color: var(--red);
            color: white;
            border: 1px solid var(--red);
        }

        .btn-delete:hover {
            background-color: #c0392b;
            border-color: #c0392b;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-view {
            background-color: var(--blue);
            color: white;
            border: 1px solid var(--blue);
        }

        .btn-view:hover {
            background-color: #2980b9;
            border-color: #2980b9;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Enhanced Email Tracking Styles */
        .tracking-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: var(--padding-md);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification-history {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .history-table {
            width: 100%;
            overflow-x: auto;
        }

        .history-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th, .history-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e8eaed;
        }

        .history-table th {
            background: #e9ecef;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-badge.success {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .status-badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        tr.failed {
            background: rgba(239, 68, 68, 0.1);
        }
        
        tr.success {
            background: rgba(16, 185, 129, 0.1);
        }

        /* Responsive Design for Full Width */
        @media (max-width: 1200px) {
            .settings-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .mailnotif-container {
                padding: 0.5rem;
            }
            
            .mailnotif-header {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .settings-section {
                padding: 1rem;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .settings-group {
                padding: 1rem;
            }
            
            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .mailnotif-container {
                padding: 0.25rem;
            }
            
            .settings-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                border-radius: 0;
                border-bottom: 1px solid #f1f3f4;
            }
            
            .tab-button:first-child {
                border-radius: 12px 12px 0 0;
            }
            
            .tab-button:last-child {
                border-bottom: none;
                border-radius: 0 0 12px 12px;
            }
        }
        </style>
    <!-- All dependencies have been inlined above -->
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="mailnotif.html" class="active">Mail & Notifications</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userProfileImg" src="#" alt="User Avatar" style="display: none;">
                            <div id="userProfilePlaceholder" class="user-initials" style="display: none;"></div>
                        </button>
                        <div class="profile-dropdown">
                            <div class="profile-dropdown-header">
                                <div class="user-info">
                                    <div class="user-name">Loading...</div>
                                    <div class="user-email">Loading...</div>
                                </div>
                            </div>
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Role & Permission Status Bar -->
            <div id="rolePermissionStatus" class="role-permission-status" style="display: none;">
                <div class="status-content">
                    <div class="role-info">
                        <i class="fas fa-user-tag"></i>
                        <span>Role: <strong id="currentUserRole">Loading...</strong></span>
                    </div>
                    <div class="permission-info">
                        <i class="fas fa-shield-alt"></i>
                        <span>Permissions: <strong id="permissionCount">0</strong> active</span>
                    </div>
                    <div class="menu-status">
                        <i class="fas fa-eye"></i>
                        <span>Menu Status: <strong id="menuSystemStatus">Loading...</strong></span>
                    </div>
                    <button id="togglePermissionDetails" class="toggle-details-btn">
                        <i class="fas fa-chevron-down"></i> Show Details
                    </button>
                </div>
                <div id="permissionDetails" class="permission-details" style="display: none;">
                    <div class="permission-list">
                        <h4>Active Permissions:</h4>
                        <div id="activePermissionsList" class="permissions-grid">
                            <!-- Permissions will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Content -->
            <div class="content">
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <!-- Mail Notification Content -->
                <div class="mailnotif-container">
                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-top-row">
                            <div class="header-left">
                                <h1 class="page-title">
                                    <i class="fas fa-envelope-open-text"></i>
                                    Mail & Notification Settings
                                </h1>
                                <p class="page-subtitle">Configure email services, notification templates, and delivery preferences for the HSE system</p>
                            </div>
                        </div>
                    </div>

        <!-- Settings Tabs -->
        <div class="settings-tabs">
            <button class="tab-button active" onclick="switchTab('emailjs-config')">
                <i class="fas fa-cloud"></i> EmailJS Configuration
            </button>
            <button class="tab-button" onclick="switchTab('email-templates')">
                <i class="fas fa-file-alt"></i> Email Templates
            </button>
            <button class="tab-button" onclick="switchTab('notification-rules')">
                <i class="fas fa-bell"></i> Notification Rules
            </button>
            <button class="tab-button" onclick="switchTab('recipients')">
                <i class="fas fa-users"></i> Recipients
            </button>
            <button class="tab-button" onclick="switchTab('email-tracking')">
                <i class="fas fa-history"></i> Email Tracking
            </button>
            <button class="tab-button" onclick="switchTab('testing')">
                <i class="fas fa-vial"></i> Testing & Logs
            </button>
        </div>

        <!-- EmailJS Configuration Tab -->
        <div id="emailjs-config" class="tab-content active">
            <div class="settings-section">
                <h3><i class="fas fa-mail-bulk"></i> EmailJS Production Service</h3>
                <p>Modern cloud email service for reliable notification delivery.</p>
                
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <span>Current Email Service: <strong>EmailJS Production</strong> | Status: <span id="emailjsStatus" class="status-indicator status-success"><i class="fas fa-check-circle"></i> Active</span></span>
                </div>
                
                <div class="emailjs-config">
                    <div class="config-header">
                        <h4><i class="fas fa-cloud"></i> EmailJS Configuration</h4>
                        <div class="config-status">
                            <button class="btn btn-primary btn-test-connection" onclick="testEmailJSConnection()">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <button class="btn btn-success" onclick="saveEmailJSConfig()" style="margin-left: 10px;">
                                <i class="fas fa-save"></i> Update Configuration
                            </button>
                            <button class="btn btn-info" onclick="showEmailJSStats()" style="margin-left: 10px;">
                                <i class="fas fa-chart-bar"></i> View Statistics
                            </button>
                        </div>
                    </div>
                    
                    <!-- Connection Statistics Display -->
                    <div id="emailjsStats" class="connection-statistics" style="margin-bottom: 1rem;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="totalSent">0</div>
                                <div class="stat-label">Total Sent</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="successfulSent">0</div>
                                <div class="stat-label">Successful</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="failedSent">0</div>
                                <div class="stat-label">Failed</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="successRate">100%</div>
                                <div class="stat-label">Success Rate</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-grid">
                        <div class="settings-group">
                            <label for="emailjsPublicKey">Public Key</label>
                            <input type="text" id="emailjsPublicKey" class="form-control" value="fHs6oaqQgkcPoUwpv" readonly>
                            <div class="form-help">
                                <i class="fas fa-key"></i> EmailJS public key (configured for production)
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="emailjsServiceId">Service ID</label>
                            <input type="text" id="emailjsServiceId" class="form-control" value="service_p2e9swy" placeholder="Enter your EmailJS Service ID">
                            <div class="form-help">Create this service in your EmailJS dashboard</div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="emailjsTemplateId">Template ID</label>
                            <input type="text" id="emailjsTemplateId" class="form-control" value="template_l50h8ks" placeholder="Enter your EmailJS Template ID (e.g., template_xxxxxxx)">
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> Get your Template ID from: 
                                <a href="https://dashboard.emailjs.com/admin/templates" target="_blank">EmailJS Templates Dashboard</a>
                            </small>
                            <div class="form-help">Create this template in your EmailJS dashboard</div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="emailjsPrivateKey">Private Key</label>
                            <input type="password" id="emailjsPrivateKey" class="form-control" value="DYBlzuRorbsDIdU5wGBru" placeholder="••••••••••••">
                            <div class="form-help">
                                <i class="fas fa-shield-alt"></i> 
                                Private key for enhanced security (optional)
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="emailjsTestEmail">Test Email Address</label>
                            <input type="email" id="emailjsTestEmail" class="form-control" value="info@dreamexdatalab.com" placeholder="Enter email for connection testing">
                            <div class="form-help">
                                <i class="fas fa-envelope"></i> 
                                Email address to use for testing EmailJS connection (must be a valid, active email)
                            </div>
                        </div>
                    </div>
                    
                    <!-- EmailJS Setup Instructions -->
                    <div class="emailjs-instructions">
                        <h5><i class="fas fa-book"></i> Setup Instructions</h5>
                        <div class="instruction-steps">
                            <div class="step">
                                <span class="step-number">1</span>
                                <div class="step-content">
                                    <strong>Create EmailJS Account:</strong>
                                    <p>Visit <a href="https://www.emailjs.com" target="_blank">EmailJS.com</a> and create an account if you haven't already.</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">2</span>
                                <div class="step-content">
                                    <strong>Create Email Service:</strong>
                                    <p>Add an email service in your EmailJS dashboard. You can use Gmail, Outlook, or any SMTP provider.</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">3</span>
                                <div class="step-content">
                                    <strong>Create Email Template:</strong>
                                    <p>Design your notification template with variables like {{to_name}}, {{subject}}, {{message}}, etc.</p>
                                </div>
                            </div>
                            <div class="step">
                                <span class="step-number">4</span>
                                <div class="step-content">
                                    <strong>Update Configuration:</strong>
                                    <p>Enter your Service ID and Template ID in the fields above and test the connection.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Template Variables Guide -->
                    <div class="template-variables">
                        <h5><i class="fas fa-code"></i> Template Variables</h5>
                        <p>Use these variables in your EmailJS template:</p>
                        <div class="variables-grid">
                            <div class="variable-item">
                                <code>{{to_email}}</code>
                                <span>Recipient email address</span>
                            </div>
                            <div class="variable-item">
                                <code>{{to_name}}</code>
                                <span>Recipient name</span>
                            </div>
                            <div class="variable-item">
                                <code>{{subject}}</code>
                                <span>Email subject</span>
                            </div>
                            <div class="variable-item">
                                <code>{{message}}</code>
                                <span>Email message content</span>
                            </div>
                            <div class="variable-item">
                                <code>{{from_name}}</code>
                                <span>Sender name (Dreamex Datalab HSE)</span>
                            </div>
                            <div class="variable-item">
                                <code>{{system_url}}</code>
                                <span>Link back to the system</span>
                            </div>
                        </div>
                    </div>
                </div>
                    
                    <!-- Advanced SMTP Settings -->
                    <div class="advanced-settings" style="margin-top: 1rem;">
                        <h5><i class="fas fa-cogs"></i> Advanced Settings</h5>
                        <div class="settings-grid">
                            <div class="settings-group">
                                <label for="connectionTimeout">Connection Timeout (seconds)</label>
                                <input type="number" id="connectionTimeout" class="form-control" value="30" min="10" max="120">
                                <div class="form-help">Maximum time to wait for connection</div>
                            </div>
                            
                            <div class="settings-group">
                                <label for="maxRetries">Max Retry Attempts</label>
                                <input type="number" id="maxRetries" class="form-control" value="3" min="1" max="10">
                                <div class="form-help">Number of retry attempts on failure</div>
                            </div>
                            
                            <div class="settings-group">
                                <div class="toggle-container">
                                    <label>
                                        Auto-Reconnect
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="autoReconnect" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-help">Automatically attempt to reconnect on failure</div>
                            </div>
                            
                            <div class="settings-group">
                                <div class="toggle-container">
                                    <label>
                                        Health Monitoring
                                        <div class="toggle-switch">
                                            <input type="checkbox" id="healthMonitoring" checked>
                                            <span class="toggle-slider"></span>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-help">Monitor connection health continuously</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-envelope"></i> Email Appearance Settings</h3>
                    <div class="settings-grid">
                        <div class="settings-group">
                            <label for="fromName">From Name</label>
                            <input type="text" id="fromName" class="form-control" value="Dreamex Datalab HSE System">
                            <div class="form-help">Display name shown to email recipients</div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="replyToEmail">Reply-To Address</label>
                            <input type="email" id="replyToEmail" class="form-control" value="info@dreamexdatalab.com">
                            <div class="form-help">Where replies will be sent</div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="emailSignature">Email Signature</label>
                            <textarea id="emailSignature" class="form-control" rows="3" placeholder="Automatic email from Dreamex Datalab HSE System">This is an automated notification from the Dreamex Datalab HSE System.
For support, contact info@dreamexdatalab.com</textarea>
                            <div class="form-help">Footer text added to all emails</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Templates Tab -->
        <div id="email-templates" class="tab-content">
            <div class="settings-section">
                <h3><i class="fas fa-file-alt"></i> Email Template Management</h3>
                <p>Customize email templates for different notification types.</p>
                
                <div class="settings-grid">
                    <div class="settings-group">
                        <label for="templateType">Template Type</label>                        <select id="templateType" class="form-control" onchange="loadTemplate()">
                            <option value="approval-notification">Access Request Approval</option>
                            <option value="completion-notification">Request Completion</option>
                            <option value="reminder-notification">Approval Reminder</option>
                            <option value="rejection-notification">Request Rejection</option>
                            <option value="kpi-assignment-notification">KPI Assignment Notification</option>
                            <option value="kpi-midyear-evaluation">KPI Mid-Year Evaluation</option>
                            <option value="kpi-yearend-evaluation">KPI Year-End Evaluation</option>
                            <option value="recruitment-interview">Position Closure & Applicant Summary</option>
                            <option value="interview-schedule">Interview Schedule</option>
                            <option value="interview-evaluation-report">Interview Evaluation Report</option>
                            <option value="job-evaluation-summary">Job Evaluation Summary Report</option>
                            <option value="position-creation-request">Position Creation Request</option>
                            <option value="offer">Job Offer</option>
                        </select>
                        <div class="form-help">Select template to edit</div>
                    </div>
                </div>
                
                <div class="template-editor">
                    <h4>Subject Line</h4>
                    <input type="text" id="emailSubject" class="form-control" value="Access Request Approval Required - {{referenceNumber}}" style="margin-bottom: 1rem;">
                    
                    <h4>Email Body (HTML)</h4>
                    <textarea id="emailTemplate" class="form-control" style="min-height: 300px;">
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Dependencies inlined in main document -->
</head>
<body style="margin: 0; padding: 0; background-color: #f4f4f4; font-family: Arial, sans-serif;">
    <div style="max-width: 600px; margin: 0 auto; background-color: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 30px 20px; text-align: center;">
            <h1 style="margin: 0; font-size: 24px; font-weight: 600;">Access Request Approval Required</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Dreamex Datalab HSE System</p>
        </div>
        
        <!-- Content -->
        <div style="padding: 30px 20px; background: #f8f9fa;">
            <p style="color: #2c3e50; font-size: 16px; margin: 0 0 20px 0;">Dear {{approverName}},</p>
            <p style="color: #555; margin: 0 0 25px 0;">A new access request requires your approval:</p>
            
            <!-- Request Details -->
            <div style="background: white; border-radius: 8px; padding: 25px; margin: 25px 0; border-left: 4px solid #3498db;">
                <h3 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 18px;">Request Details</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <td style="padding: 8px 0; color: #666; font-weight: 600; width: 30%;">Reference Number:</td>
                        <td style="padding: 8px 0; color: #2c3e50;">{{referenceNumber}}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #666; font-weight: 600;">Requester:</td>
                        <td style="padding: 8px 0; color: #2c3e50;">{{requesterName}}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #666; font-weight: 600;">Purpose:</td>
                        <td style="padding: 8px 0; color: #2c3e50;">{{purpose}}</td>
                    </tr>
                    <tr>
                        <td style="padding: 8px 0; color: #666; font-weight: 600;">Department:</td>
                        <td style="padding: 8px 0; color: #2c3e50;">{{department}}</td>
                    </tr>
                </table>
            </div>
            
            <!-- Action Button -->
            <div style="text-align: center; margin: 30px 0;">
                <a href="{{approvalLink}}" 
                   style="background: linear-gradient(135deg, #27ae60, #2ecc71); 
                          color: white; 
                          padding: 15px 30px; 
                          text-decoration: none; 
                          border-radius: 6px; 
                          display: inline-block; 
                          font-weight: 600;">
                    📋 Review and Approve Request
                </a>
            </div>
        </div>
    </div>
&lt;/body&gt;
&lt;/html&gt;
                    </textarea>
                      <div class="alert alert-info" style="margin-top: 1rem;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Available Variables:</strong><br>
                            <span class="variable-tag">{{approverName}}</span>
                            <span class="variable-tag">{{requesterName}}</span>
                            <span class="variable-tag">{{referenceNumber}}</span>
                            <span class="variable-tag">{{purpose}}</span>
                            <span class="variable-tag">{{department}}</span>
                            <span class="variable-tag">{{company}}</span>
                            <span class="variable-tag">{{startDate}}</span>
                            <span class="variable-tag">{{endDate}}</span>
                            <span class="variable-tag">{{priority}}</span>
                            <span class="variable-tag">{{approvalLink}}</span>
                            <br><strong>Recruitment Interview Variables:</strong><br>
                            <span class="variable-tag">{{candidateName}}</span>
                            <span class="variable-tag">{{jobPosition}}</span>
                            <span class="variable-tag">{{interviewDate}}</span>
                            <span class="variable-tag">{{interviewTime}}</span>
                            <span class="variable-tag">{{interviewLocation}}</span>
                            <span class="variable-tag">{{interviewFormat}}</span>
                            <span class="variable-tag">{{interviewDuration}}</span>
                            <span class="variable-tag">{{interviewerNames}}</span>
                            <span class="variable-tag">{{hrContactName}}</span>                            <span class="variable-tag">{{confirmationLink}}</span>
                            <span class="variable-tag">{{hrEmail}}</span>
                            <span class="variable-tag">{{hrPhone}}</span>
                            <br><strong>Interview Evaluation Report Variables:</strong><br>
                            <span class="variable-tag">{{candidateName}}</span>
                            <span class="variable-tag">{{jobPosition}}</span>
                            <span class="variable-tag">{{reportDate}}</span>
                            <span class="variable-tag">{{totalEvaluations}}</span>
                            <span class="variable-tag">{{averageScores}}</span>
                            <span class="variable-tag">{{overallAverage}}</span>
                            <span class="variable-tag">{{recommendationSummary}}</span>
                            <span class="variable-tag">{{evaluationDetails}}</span>
                            <span class="variable-tag">{{evaluatorsList}}</span>
                            <span class="variable-tag">{{evaluationPeriod}}</span>
                            <span class="variable-tag">{{nextSteps}}</span>
                            <span class="variable-tag">{{hrContact}}</span>
                            <br><strong>KPI Assignment Variables:</strong><br>
                            <span class="variable-tag">{{lineManagerName}}</span>
                            <span class="variable-tag">{{assignmentStartDate}}</span>
                            <span class="variable-tag">{{assignmentEndDate}}</span>
                            <span class="variable-tag">{{directReportsList}}</span>
                            <span class="variable-tag">{{assignmentPeriod}}</span>
                            <span class="variable-tag">{{fiscalYear}}</span>
                            <span class="variable-tag">{{midYearStartDate}}</span>
                            <span class="variable-tag">{{midYearEndDate}}</span>
                            <span class="variable-tag">{{yearEndStartDate}}</span>
                            <span class="variable-tag">{{yearEndEndDate}}</span>
                            <span class="variable-tag">{{kpiSystemLink}}</span>
                            <br><strong>Job Offer Variables:</strong><br>
                            <span class="variable-tag">{{candidateName}}</span>
                            <span class="variable-tag">{{candidateEmail}}</span>
                            <span class="variable-tag">{{candidatePhone}}</span>
                            <span class="variable-tag">{{positionTitle}}</span>
                            <span class="variable-tag">{{companyName}}</span>
                            <span class="variable-tag">{{department}}</span>
                            <span class="variable-tag">{{baseSalary}}</span>
                            <span class="variable-tag">{{annualSalary}}</span>
                            <span class="variable-tag">{{startDate}}</span>
                            <span class="variable-tag">{{workLocation}}</span>
                            <span class="variable-tag">{{employmentType}}</span>
                            <span class="variable-tag">{{reportsTo}}</span>
                            <span class="variable-tag">{{acceptanceLink}}</span>
                            <span class="variable-tag">{{responseDeadline}}</span>
                            <span class="variable-tag">{{hiringManager}}</span>
                            <span class="variable-tag">{{hrRepresentative}}</span>
                            <span class="variable-tag">{{hrEmail}}</span>
                            <span class="variable-tag">{{hrPhone}}</span>
                            <span class="variable-tag">{{offerExpirationDate}}</span>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-success" onclick="saveTemplate()">
                            <i class="fas fa-save"></i> Save Template
                        </button>
                        <button class="btn btn-secondary" onclick="previewTemplate()">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button class="btn btn-warning" onclick="resetTemplate()">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                    
                    <div id="templatePreview" class="template-preview" style="display: none;">
                        <h4>Template Preview</h4>
                        <div id="previewContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Rules Tab -->
        <div id="notification-rules" class="tab-content">
            <div class="settings-section">
                <h3><i class="fas fa-bell"></i> Notification Triggers</h3>
                <p>Configure when and how email notifications are sent.</p>
                
                <!-- Template-Specific Notification Rules -->
                <div class="settings-grid">
                    <div class="settings-group" style="grid-column: 1 / -1;">
                        <label for="notificationTemplateType">Configure Notifications for Template Type</label>
                        <select id="notificationTemplateType" class="form-control" onchange="loadNotificationRules()">
                            <option value="">Select a template type...</option>
                            <option value="approval-notification">Access Request Approval</option>
                            <option value="completion-notification">Request Completion</option>
                            <option value="reminder-notification">Approval Reminder</option>
                            <option value="rejection-notification">Request Rejection</option>
                            <option value="kpi-assignment-notification">KPI Assignment Notification</option>
                            <option value="kpi-midyear-evaluation">KPI Mid-Year Evaluation</option>
                            <option value="kpi-yearend-evaluation">KPI Year-End Evaluation</option>
                            <option value="recruitment-interview">Position Closure & Applicant Summary</option>
                            <option value="interview-schedule">Interview Schedule</option>
                            <option value="interview-evaluation-report">Interview Evaluation Report</option>
                            <option value="job-evaluation-summary">Job Evaluation Summary Report</option>
                            <option value="offer">Job Offer</option>
                        </select>
                        <div class="form-help">Select a template type to configure its specific notification rules and settings</div>
                    </div>
                </div>

                <!-- Template-Specific Rules Configuration -->
                <div id="templateSpecificRules" class="settings-section" style="display: none; background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
                    <h4 id="selectedTemplateTitle"><i class="fas fa-cog"></i> Notification Rules for: <span id="templateTypeName">Template</span></h4>
                    
                    <div class="settings-grid">
                        <div class="settings-group">
                            <label>Enable Notifications</label>
                            <div class="toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="templateNotificationEnabled">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span>Enable notifications for this template type</span>
                            </div>
                            <div class="form-help">Master switch for this notification type</div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="templatePriority">Notification Priority</label>
                            <select id="templatePriority" class="form-control">
                                <option value="low">Low Priority</option>
                                <option value="normal" selected>Normal Priority</option>
                                <option value="high">High Priority</option>
                                <option value="urgent">Urgent</option>
                            </select>
                            <div class="form-help">Higher priority notifications are sent first</div>
                        </div>
                        
                        <div class="settings-group">
                            <label>Immediate Send</label>
                            <div class="toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="templateImmediateSend" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span>Send immediately when triggered</span>
                            </div>
                            <div class="form-help">If disabled, notifications will be queued for batch sending</div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="templateRetryAttempts">Retry Attempts</label>
                            <select id="templateRetryAttempts" class="form-control">
                                <option value="1">1 attempt</option>
                                <option value="2">2 attempts</option>
                                <option value="3" selected>3 attempts</option>
                                <option value="5">5 attempts</option>
                            </select>
                            <div class="form-help">Number of retry attempts for failed deliveries</div>
                        </div>
                        
                        <div class="settings-group">
                            <label for="templateRetryInterval">Retry Interval</label>
                            <select id="templateRetryInterval" class="form-control">
                                <option value="5">5 minutes</option>
                                <option value="15" selected>15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">1 hour</option>
                            </select>
                            <div class="form-help">Time between retry attempts</div>
                        </div>
                        
                        <div class="settings-group">
                            <label>Copy Recipients</label>
                            <div class="toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="templateCopyRecipients">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span>Send copies to additional recipients</span>
                            </div>
                            <div class="form-help">Include CC/BCC recipients for this template</div>
                        </div>
                        
                        <div class="settings-group" id="copyRecipientsGroup" style="display: none;">
                            <label for="templateCopyEmails">Additional Recipients</label>
                            <textarea id="templateCopyEmails" class="form-control" rows="3" placeholder="Enter email addresses separated by commas"></textarea>
                            <div class="form-help">Comma-separated list of email addresses to receive copies</div>
                        </div>
                        
                        <div class="settings-group">
                            <label>Delivery Window</label>
                            <div class="toggle-container">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="templateDeliveryWindow">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span>Restrict delivery to specific hours</span>
                            </div>
                            <div class="form-help">If enabled, notifications will only be sent during specified hours</div>
                        </div>
                        
                        <div class="settings-group" id="deliveryWindowGroup" style="display: none;">
                            <label>Delivery Hours</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="time" id="templateStartTime" class="form-control" value="08:00" style="flex: 1;">
                                <span>to</span>
                                <input type="time" id="templateEndTime" class="form-control" value="18:00" style="flex: 1;">
                            </div>
                            <div class="form-help">Notifications will only be sent between these hours</div>
                        </div>
                    </div>
                    
                    <div class="button-group" style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="saveTemplateNotificationRules()">
                            <i class="fas fa-save"></i> Save Rules
                        </button>
                        <button class="btn btn-secondary" onclick="resetTemplateNotificationRules()">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                        <button class="btn btn-warning" onclick="testTemplateNotification()">
                            <i class="fas fa-vial"></i> Test Notification
                        </button>
                    </div>
                </div>
                
                <!-- Global Notification Triggers Overview -->
                <div class="settings-grid">
                    <div class="settings-group" style="grid-column: 1 / -1;">
                        <h4><i class="fas fa-info-circle"></i> Template-Based Notification System</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-lightbulb"></i>
                            <div>
                                <strong>New System:</strong> Notification triggers are now managed per template type using the dropdown above. 
                                Each template (Access Request Approval, KPI Evaluations, etc.) has its own trigger rules and settings.
                                <br><br>
                                <strong>Quick Actions:</strong>
                                <button class="btn btn-primary" onclick="enableAllTemplateNotifications()" style="margin-right: 10px;">
                                    <i class="fas fa-toggle-on"></i> Enable All Templates
                                </button>
                                <button class="btn btn-secondary" onclick="showNotificationSummary()">
                                    <i class="fas fa-list"></i> View Template Summary
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template Notification Status Overview -->
                <div class="settings-grid">
                    <div class="settings-group" style="grid-column: 1 / -1;">
                        <h4><i class="fas fa-dashboard"></i> Template Notification Status</h4>
                        <div id="templateStatusOverview" class="template-status-grid">
                            <!-- Dynamic content populated by JavaScript -->
                        </div>
                        <div class="form-help">Click on any template card to configure its specific notification rules</div>
                    </div>
                </div>

                <!-- Advanced Trigger Settings -->
                <div class="settings-grid">
                    <div class="settings-group">
                        <label>Master Notification Switch</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="masterNotificationSwitch" checked onchange="toggleMasterNotifications()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Enable/disable all email notifications globally</span>
                        </div>
                        <div class="form-help">When disabled, no notifications will be sent regardless of template settings</div>
                    </div>
                    
                    <div class="settings-group">
                        <label for="globalPriorityFilter">Minimum Priority Level</label>
                        <select id="globalPriorityFilter" class="form-control" onchange="updateGlobalPriorityFilter()">
                            <option value="low">Send All (Low and above)</option>
                            <option value="normal" selected>Normal and above</option>
                            <option value="high">High priority only</option>
                            <option value="urgent">Urgent only</option>
                        </select>
                        <div class="form-help">Only send notifications at or above this priority level</div>
                    </div>
                    
                    <div class="settings-group">
                        <label>Auto-Enable New Templates</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="autoEnableNewTemplates" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Automatically enable notifications for new template types</span>
                        </div>
                        <div class="form-help">When new templates are added, they will be enabled by default</div>
                    </div>
                    
                    <div class="settings-group">
                        <label for="notificationBatchSize">Batch Processing Size</label>
                        <select id="notificationBatchSize" class="form-control">
                            <option value="1">Send individually</option>
                            <option value="5">Batch of 5</option>
                            <option value="10" selected>Batch of 10</option>
                            <option value="25">Batch of 25</option>
                            <option value="50">Batch of 50</option>
                        </select>
                        <div class="form-help">Number of notifications to process together for non-immediate sends</div>
                    </div>
                    
                    <div class="settings-group">
                        <label>Duplicate Prevention</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="preventDuplicateNotifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Prevent sending duplicate notifications within 5 minutes</span>
                        </div>
                        <div class="form-help">Helps prevent spam from multiple triggers of the same notification</div>
                    </div>
                    
                    <div class="settings-group">
                        <label for="failureEscalationTime">Failure Escalation</label>
                        <select id="failureEscalationTime" class="form-control">
                            <option value="0">No escalation</option>
                            <option value="30">After 30 minutes</option>
                            <option value="60" selected>After 1 hour</option>
                            <option value="120">After 2 hours</option>
                            <option value="240">After 4 hours</option>
                        </select>
                        <div class="form-help">Escalate to admin if critical notifications fail after this time</div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3><i class="fas fa-clock"></i> Delivery Settings</h3>
                <div class="settings-grid">
                    <div class="settings-group">
                        <label for="deliveryHours">Send Emails Between</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="time" id="startTime" class="form-control" value="08:00" style="flex: 1;">
                            <span>and</span>
                            <input type="time" id="endTime" class="form-control" value="18:00" style="flex: 1;">
                        </div>
                        <div class="form-help">Emails will only be sent during business hours</div>
                    </div>
                    
                    <div class="settings-group">
                        <label>Weekend Delivery</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="weekendDelivery">
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Allow email delivery on weekends</span>
                        </div>
                        <div class="form-help">If disabled, weekend emails will be queued for Monday</div>
                    </div>
                    
                    <div class="settings-group">
                        <label for="maxEmailsPerHour">Rate Limiting</label>
                        <input type="number" id="maxEmailsPerHour" class="form-control" value="100" min="1" max="1000">
                        <div class="form-help">Maximum emails to send per hour (prevents spam)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recipients Tab -->
        <div id="recipients" class="tab-content">
            <div class="settings-section">
                <h3><i class="fas fa-users"></i> Notification Recipients</h3>
                <p>Manage who receives different types of email notifications.</p>
                  <!-- Notification Configuration -->
                <div class="settings-grid">
                    <div class="settings-group">
                        <label for="notificationType">Notification Type</label>                        <select id="notificationType" class="form-control" onchange="updateNotificationSettings()">
                            <option value="access_request">Access Request</option>
                            <option value="approval_reminder">Approval Reminder</option>
                            <option value="recruitment_interview">Recruitment Interview</option>
                            <option value="status_update">Status Update</option>
                            <option value="system_alert">System Alert</option>
                            <option value="all">All Notifications</option>
                        </select>
                        <div class="form-help">Select the type of notification to configure recipients for</div>
                    </div>
                </div>                <!-- Dynamic Recipients Management -->
                <div class="settings-grid" style="margin-top: 20px;">
                    <div class="settings-group" style="grid-column: 1 / -1;">
                        <div class="recipient-header">
                            <label>Recipients for <span id="selectedNotificationType">Access Request</span> Notifications</label>
                            <div class="recipient-actions-header">                                <button class="btn btn-primary btn-sm" onclick="console.log('Button clicked!'); alert('Button works!'); showAddRecipientModal();">
                                    <i class="fas fa-plus"></i> Add Recipient
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="importRecipients()" title="Import from CSV">
                                    <i class="fas fa-upload"></i> Import
                                </button>
                            </div>
                        </div>
                        
                        <div class="recipient-list" id="recipientsList">
                            <div class="no-recipients">
                                <i class="fas fa-users-slash"></i>
                                <p>No recipients configured for this notification type</p>
                                <small>Click "Add Recipient" to start adding email addresses</small>
                            </div>
                        </div>
                        
                        <div class="recipient-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total Recipients:</span>
                                <span id="totalRecipients" class="summary-value">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Active:</span>
                                <span id="activeRecipients" class="summary-value">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Recipient Modal -->
                <div id="addRecipientModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3><i class="fas fa-user-plus"></i> Add New Recipient</h3>
                            <button class="modal-close" onclick="closeAddRecipientModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>                        <div class="modal-body">
                            <div class="form-group">
                                <label for="recipientUser">Select User</label>
                                <select id="recipientUser" class="form-control">
                                    <option value="">Select a user</option>
                                </select>
                                <div class="form-help">Choose a user from the system</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="recipientEmail">Email Address</label>
                                <input type="email" id="recipientEmail" class="form-control" placeholder="Email will be populated automatically" readonly>
                                <div class="form-help">Email address from the selected user</div>
                            </div>

                            <div class="form-group">
                                <label>Notification Types</label>                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="notifyAccessRequest" checked>
                                        <span>Access Request</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="notifyApprovalReminder">
                                        <span>Approval Reminder</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="notifyRecruitmentInterview">
                                        <span>Recruitment Interview</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="notifyStatusUpdate">
                                        <span>Status Update</span>
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" id="notifySystemAlert">
                                        <span>System Alert</span>
                                    </label>
                                </div>
                                <div class="form-help">Select which notification types this recipient should receive</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeAddRecipientModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="addRecipient()">
                                <i class="fas fa-plus"></i> Add Recipient
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3><i class="fas fa-filter"></i> Notification Filters</h3>
                <div class="settings-grid">
                    <div class="settings-group">
                        <label>High Priority Notifications</label>
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="priorityNotifications" checked>
                                <span class="toggle-slider"></span>
                            </label>
                            <span>Send additional notifications for high-priority requests</span>
                        </div>
                        <div class="form-help">High-priority requests will notify additional stakeholders</div>
                    </div>
                    
                    <div class="settings-group">
                        <label for="escalationTime">Escalation Time</label>
                        <select id="escalationTime" class="form-control">
                            <option value="24">24 hours</option>
                            <option value="48" selected>48 hours</option>
                            <option value="72">72 hours</option>
                            <option value="168">1 week</option>
                        </select>
                        <div class="form-help">Time before escalating to higher level approvers</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Tracking Tab -->
        <div id="email-tracking" class="tab-content">
            <div class="settings-section">
                <h3><i class="fas fa-history"></i> Email Notification History</h3>
                <p>Track and monitor email notification deliveries.</p>
                  <div class="tracking-filters">
                    <div class="filter-group">
                        <label for="filter-status">Status:</label>
                        <select id="filter-status" onchange="filterNotificationHistory()">
                            <option value="all">All</option>
                            <option value="success">Successful</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-date">Time Period:</label>
                        <select id="filter-date" onchange="filterNotificationHistory()">
                            <option value="24">Last 24 hours</option>
                            <option value="72">Last 3 days</option>
                            <option value="168">Last 7 days</option>
                            <option value="720">Last 30 days</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="data-source">Data Source:</label>
                        <select id="data-source" onchange="switchDataSource()">
                            <option value="firebase">Firebase (Real-time)</option>
                            <option value="memory">Memory Cache</option>
                        </select>
                    </div>                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="refreshNotificationHistory()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-secondary" onclick="testFirebaseIntegration()">
                            <i class="fas fa-vial"></i> Test Firebase
                        </button>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-info" onclick="testEmailNotification()">
                            <i class="fas fa-envelope-open-text"></i> Test Email
                        </button>
                    </div>
                    <div class="filter-group">
                        <div class="realtime-status" id="realtime-status">
                            <span class="status-indicator status-success">
                                <i class="fas fa-wifi"></i> Real-time Connected
                            </span>
                        </div>
                    </div>
                </div>

                <div class="notification-history" id="notification-history">
                    <div class="history-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Recipient</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Message ID</th>
                                </tr>
                            </thead>
                            <tbody id="notification-history-body">
                                <!-- Notification history entries will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testing & Logs Tab -->
        <div id="testing" class="tab-content">
            <div class="settings-section">
                <h3><i class="fas fa-vial"></i> Email Testing</h3>
                <p>Test your email configuration and send sample notifications.</p>
                
                <div class="settings-grid">
                    <div class="settings-group">
                        <label for="testEmail">Test Email Address</label>
                        <input type="email" id="testEmail" class="form-control" placeholder="Enter email address for testing">
                        <div class="form-help">Email address to receive test notifications</div>
                    </div>
                    
                    <div class="settings-group">
                        <label for="testType">Test Type</label>                        <select id="testType" class="form-control">
                            <option value="connection">EmailJS Connection Test</option>
                            <option value="approval">Sample Approval Notification</option>
                            <option value="completion">Sample Completion Notification</option>
                            <option value="reminder">Sample Reminder Notification</option>
                            <option value="recruitment">Position Closure Notification</option>
                            <option value="archives">Test Archives Connection</option>
                            <option value="applicant-names">Test Applicant Names Formatting</option>
                        </select>
                        <div class="form-help">Choose what type of test to perform</div>
                    </div>
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="runTest()">
                        <i class="fas fa-play"></i> Run Test
                    </button>
                    <button class="btn btn-success" onclick="validateConfig()">
                        <i class="fas fa-check-double"></i> Validate Configuration
                    </button>
                    <button class="btn btn-warning" onclick="viewLogs()">
                        <i class="fas fa-file-alt"></i> View Email Logs
                    </button>
                </div>
                
                <div id="testResults" class="test-results" style="display: none;">
                    <!-- Test results will be displayed here -->
                </div>
            </div>
            
            <div class="settings-section">
                <h3><i class="fas fa-chart-line"></i> Email Statistics</h3>
                <div class="settings-grid">
                    <div class="settings-group">
                        <label>Daily Email Volume</label>
                        <div class="status-indicator status-info" id="daily-volume">
                            <i class="fas fa-envelope"></i> <span class="stat-value">Loading...</span>
                        </div>
                        <div class="form-help">Total emails sent in the last 24 hours</div>
                    </div>
                    
                    <div class="settings-group">
                        <label>Delivery Success Rate</label>
                        <div class="status-indicator status-success" id="success-rate">
                            <i class="fas fa-check-circle"></i> <span class="stat-value">Loading...</span>
                        </div>
                        <div class="form-help">Percentage of successfully delivered emails</div>
                    </div>
                    
                    <div class="settings-group">
                        <label>Failed Deliveries</label>
                        <div class="status-indicator status-warning" id="failed-deliveries">
                            <i class="fas fa-exclamation-triangle"></i> <span class="stat-value">Loading...</span>
                        </div>
                        <div class="form-help">Failed email deliveries requiring attention</div>
                    </div>
                    
                    <div class="settings-group">
                        <label>Service Status</label>
                        <div class="status-indicator status-success" id="service-status">
                            <i class="fas fa-heartbeat"></i> <span class="stat-value">Service healthy</span>
                        </div>
                        <div class="form-help">Current email service status</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Actions -->
        <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-top: 2rem;">
            <div class="button-group">
                <button class="btn btn-success" onclick="saveAllSettings()">
                    <i class="fas fa-save"></i> Save All Settings
                </button>
                <button class="btn btn-secondary" onclick="exportConfig()">
                    <i class="fas fa-download"></i> Export Configuration
                </button>
                <button class="btn btn-warning" onclick="importConfig()">
                    <i class="fas fa-upload"></i> Import Configuration
                </button>
                <button class="btn btn-danger" onclick="resetToDefaults()">
                    <i class="fas fa-undo-alt"></i> Reset to Defaults
                </button>
            </div>
        </div>
    </div>    <!-- Import Firebase and other required scripts -->
    
    <!-- Inline Firebase Scripts -->
    <script>
        // Firebase App Compatibility - Basic initialization
        if (typeof firebase === 'undefined') {
            window.firebase = {
                initializeApp: function(config) { 
                    console.log('Firebase initialized (demo mode):', config);
                    return { name: 'default' };
                },
                database: function() {
                    return {
                        ref: function(path) {
                            console.log('Firebase database ref (demo):', path);
                            return {
                                on: function() {},
                                once: function() { return Promise.resolve({ val: () => null }); },
                                set: function() { return Promise.resolve(); },
                                update: function() { return Promise.resolve(); },
                                push: function() { return Promise.resolve(); }
                            };
                        }
                    };
                },
                auth: function() {
                    return {
                        signInWithEmailAndPassword: function() { return Promise.resolve({ user: { uid: 'demo' } }); },
                        signOut: function() { return Promise.resolve(); },
                        onAuthStateChanged: function() {}
                    };
                }
            };
        }
        console.log('✅ Firebase compatibility module loaded');
    </script>
    
    <!-- Inline Email Service -->
    <script>
        // Email Service - Updated for EmailJS
        class EmailNotificationService {
            constructor() {
                // Initialize with EmailJS configuration
                this.emailJSPublicKey = 'fHs6oaqQgkcPoUwpv';
                this.emailJSPrivateKey = 'DYBlzuRorbsDIdU5wGBru';
                this.serviceId = 'service_p2e9swy';
                this.templateId = 'template_l50h8ks';
                this.maxRetries = 3;
                this.retryDelay = 5000;
                
                // Initialize delivery statistics
                this.deliveryStats = {
                    totalSent: 0,
                    successful: 0,
                    failed: 0,
                    lastUpdated: new Date()
                };
                
                // Track notification history
                this.notificationHistory = [];
                this.maxHistorySize = 1000;
                
                // Load saved configuration
                this.loadEmailJSConfig();
            }

            // Load EmailJS configuration from localStorage
            loadEmailJSConfig() {
                try {
                    // Set production defaults
                    this.serviceId = 'service_p2e9swy';
                    this.templateId = 'template_l50h8ks';
                    
                    // Try to load from localStorage if available, but keep defaults if not
                    const config = localStorage.getItem('emailjs_config');
                    if (config) {
                        const parsedConfig = JSON.parse(config);
                        this.serviceId = parsedConfig.serviceId || 'service_p2e9swy';
                        this.templateId = parsedConfig.templateId || 'template_l50h8ks';
                    }
                } catch (error) {
                    this.log('error', 'Failed to load EmailJS configuration', error);
                    // Fallback to production defaults
                    this.serviceId = 'service_p2e9swy';
                    this.templateId = 'template_l50h8ks';
                }
            }

            // Log method for debugging
            log(level, message, data = null) {
                const timestamp = new Date().toISOString();
                const logEntry = { timestamp, level, message, data };
                
                if (typeof console !== 'undefined') {
                    const logMethod = console[level] || console.log;
                    logMethod('[' + timestamp + '] EmailService: ' + message, data || '');
                }
            }

            // Send interview report email using EmailJS
            async sendInterviewReport(reportData) {
                this.log('info', 'Sending interview report email via EmailJS', reportData);

                try {
                    const {
                        recipientEmail,
                        candidateName,
                        position,
                        interviewDate,
                        interviewer,
                        duration,
                        overallScore,
                        overallRecommendation,
                        interviewNotes,
                        finalRecommendation,
                        recommendationReason
                    } = reportData;

                    // Validate required fields
                    if (!recipientEmail || !candidateName || !position || !interviewer || !finalRecommendation) {
                        throw new Error('Missing required fields for interview report');
                    }

                    // Check if EmailJS is configured
                    if (!this.serviceId || !this.templateId) {
                        throw new Error('EmailJS not configured. Please set Service ID and Template ID.');
                    }

                    // Prepare email parameters for EmailJS
                    const emailParams = {
                        to_email: recipientEmail,
                        candidate_name: candidateName,
                        position: position,
                        interview_date: interviewDate,
                        interviewer: interviewer,
                        duration: duration,
                        overall_score: overallScore,
                        overall_recommendation: overallRecommendation,
                        interview_notes: interviewNotes,
                        final_recommendation: finalRecommendation,
                        recommendation_reason: recommendationReason,
                        from_name: 'Dreamex Data Lab HR System',
                        subject: `Interview Report - ${candidateName} for ${position}`
                    };

                    // Send email using EmailJS
                    const response = await emailjs.send(
                        this.serviceId,
                        this.templateId,
                        emailParams,
                        this.emailJSPublicKey
                    );

                    this.log('info', 'Interview report sent successfully via EmailJS', response);

                    // Update delivery stats
                    this.deliveryStats.totalSent++;
                    this.deliveryStats.successful++;
                    this.deliveryStats.lastUpdated = new Date();

                    // Add to notification history
                    const notification = {
                        id: Date.now(),
                        type: 'interview_report',
                        recipient: recipientEmail,
                        candidateName: candidateName,
                        position: position,
                        status: 'sent',
                        timestamp: new Date().toISOString(),
                        messageId: response.text || 'emailjs-' + Date.now()
                    };
                    
                    this.addToHistory(notification);

                    return {
                        success: true,
                        method: 'emailjs',
                        messageId: response.text,
                        recipient: recipientEmail,
                        candidateName: candidateName,
                        timestamp: new Date().toISOString()
                    };

                } catch (error) {
                    this.log('error', 'EmailJS failed for interview report', { error: error.message });
                    
                    // Update delivery stats
                    this.deliveryStats.totalSent++;
                    this.deliveryStats.failed++;
                    this.deliveryStats.lastUpdated = new Date();

                    // Add failed notification to history
                    const notification = {
                        id: Date.now(),
                        type: 'interview_report',
                        recipient: reportData.recipientEmail,
                        candidateName: reportData.candidateName,
                        status: 'failed',
                        error: error.message,
                        timestamp: new Date().toISOString()
                    };
                    
                    this.addToHistory(notification);

                    throw error;
                }
            }

            // Add notification to history
            addToHistory(notification) {
                this.notificationHistory.unshift(notification);
                
                // Keep only the latest notifications
                if (this.notificationHistory.length > this.maxHistorySize) {
                    this.notificationHistory = this.notificationHistory.slice(0, this.maxHistorySize);
                }
                
                // Save to localStorage
                try {
                    localStorage.setItem('notification_history', JSON.stringify(this.notificationHistory));
                } catch (error) {
                    this.log('error', 'Failed to save notification history', error);
                }
            }

            // Get delivery statistics
            getDeliveryStats() {
                return { ...this.deliveryStats };
            }

            // Get notification history
            getNotificationHistory() {
                return [...this.notificationHistory];
            }

            // Get notification delivery statistics
            getDeliveryStatistics() {
                return {
                    ...this.deliveryStats,
                    history: this.notificationHistory.slice(-100), // Last 100 notifications
                    successRate: this.deliveryStats.totalSent > 0 
                        ? (this.deliveryStats.successful / this.deliveryStats.totalSent * 100).toFixed(2)
                        : 0
                };
            }
        }

        // Export the class for global usage
        if (typeof window !== 'undefined') {
            window.EmailNotificationService = EmailNotificationService;
            window.emailNotificationService = new EmailNotificationService();
            console.log('✅ EmailNotificationService class made available globally');
        }
    </script>
    
    <!-- Inline Email Queue Processor -->
    <script>
        // Email Queue Processor - Embedded from js/emailQueueProcessor.js
        class EmailQueueProcessor {
            constructor() {
                this.isProcessing = false;
                this.processingInterval = null;
                this.maxRetries = 3;
                this.retryDelay = 5000; // 5 seconds
                this.processInterval = 10000; // Check every 10 seconds
                
                // Initialize Firebase if not already done
                this.initializeFirebase();
                
                // Start processing when document is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.startProcessing());
                } else {
                    this.startProcessing();
                }
            }
            
            initializeFirebase() {
                // Firebase should already be initialized by the parent page
                if (typeof firebase === 'undefined') {
                    console.error('Firebase not available for email queue processor');
                    return;
                }
                
                this.database = firebase.database();
                console.log('Email Queue Processor: Firebase initialized');
            }
            
            startProcessing() {
                if (this.isProcessing) {
                    console.log('Email queue processor already running');
                    return;
                }
                
                this.isProcessing = true;
                console.log('Starting email queue processor...');
                
                // Process immediately, then set interval
                this.processQueue();
                this.processingInterval = setInterval(() => {
                    this.processQueue();
                }, this.processInterval);
                
                // Listen for new emails in real-time
                this.listenForNewEmails();
            }
            
            stopProcessing() {
                if (this.processingInterval) {
                    clearInterval(this.processingInterval);
                    this.processingInterval = null;
                }
                this.isProcessing = false;
                console.log('Email queue processor stopped');
            }
            
            listenForNewEmails() {
                if (!this.database) return;
                
                // Get company-scoped path for email queue
                const emailQueuePath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('emailQueue') : 
                    'emailQueue';
                
                console.log('📧 Listening for emails at path:', emailQueuePath);
                
                // Listen for new pending emails
                this.database.ref(emailQueuePath).orderByChild('status').equalTo('pending')
                    .on('child_added', (snapshot) => {
                        const emailData = snapshot.val();
                        console.log('New email detected in queue:', snapshot.key);
                        
                        // Process immediately if it's a high priority email
                        if (emailData.priority === 'high' || emailData.type === 'job-closure-notification') {
                            this.processEmail(snapshot.key, emailData);
                        }
                    });
            }
            
            async processQueue() {
                if (!this.database) {
                    console.error('Database not available for email processing');
                    return;
                }
                
                try {
                    console.log('Processing email queue...');
                    
                    // Get company-scoped path for email queue
                    const emailQueuePath = window.rolePermissionManager ? 
                        window.rolePermissionManager.getCompanyScopedPath('emailQueue') : 
                        'emailQueue';
                    
                    console.log('📧 Processing queue at path:', emailQueuePath);
                    
                    // Get all pending emails
                    const snapshot = await this.database.ref(emailQueuePath)
                        .orderByChild('status')
                        .equalTo('pending')
                        .once('value');
                    
                    const emails = snapshot.val();
                    if (!emails) {
                        console.log('No pending emails in queue');
                        return;
                    }
                    
                    const emailIds = Object.keys(emails);
                    console.log('Found ' + emailIds.length + ' pending emails');
                    
                    // Process each email
                    for (const emailId of emailIds) {
                        await this.processEmail(emailId, emails[emailId]);
                        
                        // Add small delay between emails to avoid overwhelming the service
                        await this.delay(1000);
                    }
                    
                } catch (error) {
                    console.error('Error processing email queue:', error);
                }
            }
            
            async processEmail(emailId, emailData) {
                try {
                    console.log('Processing email ' + emailId + ':', emailData.type);
                    
                    // Check if email has exceeded max retries
                    if (emailData.attempts >= this.maxRetries) {
                        await this.markEmailAsFailed(emailId, 'Max retries exceeded');
                        return;
                    }
                    
                    // Mark as processing
                    await this.updateEmailStatus(emailId, 'processing');
                    
                    // Send email based on type
                    let result;
                    switch (emailData.type) {
                        case 'job-closure-notification':
                            result = await this.sendJobClosureNotification(emailData);
                            break;
                        case 'recruitment-notification':
                            result = await this.sendRecruitmentNotification(emailData);
                            break;
                        case 'approval-notification':
                            result = await this.sendApprovalNotification(emailData);
                            break;
                        case 'completion-notification':
                            result = await this.sendCompletionNotification(emailData);
                            break;
                        default:
                            throw new Error('Unknown email type: ' + emailData.type);
                    }
                    
                    // Mark as sent
                    await this.markEmailAsSent(emailId, result);
                    console.log('Email ' + emailId + ' sent successfully');
                    
                } catch (error) {
                    console.error('Error processing email ' + emailId + ':', error);
                    await this.handleEmailError(emailId, emailData, error);
                }
            }
            
            // Utility methods
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            async updateEmailStatus(emailId, status) {
                const emailQueuePath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('emailQueue') : 
                    'emailQueue';
                    
                await this.database.ref(`${emailQueuePath}/${emailId}`).update({
                    status: status,
                    lastUpdated: new Date().toISOString()
                });
            }
            
            async markEmailAsSent(emailId, result) {
                const emailQueuePath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('emailQueue') : 
                    'emailQueue';
                    
                await this.database.ref(`${emailQueuePath}/${emailId}`).update({
                    status: 'sent',
                    sentAt: new Date().toISOString(),
                    messageId: result.messageId || 'unknown',
                    lastUpdated: new Date().toISOString()
                });
            }
            
            async markEmailAsFailed(emailId, error) {
                const emailQueuePath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('emailQueue') : 
                    'emailQueue';
                    
                await this.database.ref(`${emailQueuePath}/${emailId}`).update({
                    status: 'failed',
                    error: error.toString(),
                    failedAt: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                });
            }
            
            async handleEmailError(emailId, emailData, error) {
                const attempts = (emailData.attempts || 0) + 1;
                
                const emailQueuePath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('emailQueue') : 
                    'emailQueue';
                
                if (attempts >= this.maxRetries) {
                    await this.markEmailAsFailed(emailId, error);
                } else {
                    // Schedule retry
                    await this.database.ref(`${emailQueuePath}/${emailId}`).update({
                        status: 'pending',
                        attempts: attempts,
                        lastError: error.toString(),
                        nextRetryAt: new Date(Date.now() + this.retryDelay * attempts).toISOString(),
                        lastUpdated: new Date().toISOString()
                    });
                    
                    console.log('Email ' + emailId + ' scheduled for retry (attempt ' + attempts + '/' + this.maxRetries + ')');
                }
            }
            
            // Send methods - simplified for demo
            async sendJobClosureNotification(emailData) {
                console.log('Sending job closure notification:', emailData);
                return { messageId: 'demo-' + Date.now() };
            }
            
            async sendRecruitmentNotification(emailData) {
                console.log('Sending recruitment notification:', emailData);
                return { messageId: 'demo-' + Date.now() };
            }
            
            async sendApprovalNotification(emailData) {
                console.log('Sending approval notification:', emailData);
                return { messageId: 'demo-' + Date.now() };
            }
            
            async sendCompletionNotification(emailData) {
                console.log('Sending completion notification:', emailData);
                return { messageId: 'demo-' + Date.now() };
            }
        }

        // Create global instance
        if (typeof window !== 'undefined') {
            window.emailQueueProcessor = new EmailQueueProcessor();
            console.log('✅ Email Queue Processor initialized globally');
        }
    </script>
    <script type="module">
        try {
            // Demo Firebase functions - since external dependencies are inlined
            console.log('Setting up demo Firebase functions...');
            
            // Make demo Firebase functions available globally for email tracking
            window.firebaseRT = {
                ref: function(path) { 
                    console.log('Firebase ref (demo):', path);
                    return { on: () => {}, off: () => {} };
                },
                onValue: function(ref, callback) { 
                    console.log('Firebase onValue (demo)');
                    // Simulate some demo data
                    setTimeout(() => callback({ val: () => ({ demoEmail: { status: 'sent', timestamp: new Date().toISOString() } }) }), 1000);
                },
                query: function(ref) { return ref; },
                orderByChild: function(child) { 
                    console.log('Firebase orderByChild (demo):', child);
                    return { limitToLast: () => ({}) };
                },
                limitToLast: function(limit) { 
                    console.log('Firebase limitToLast (demo):', limit);
                    return {};
                },
                get: function() { 
                    return Promise.resolve({ val: () => null });
                },
                db: {
                    ref: function(path) {
                        console.log('Firebase db.ref (demo):', path);
                        return {
                            on: () => {},
                            once: () => Promise.resolve({ val: () => null }),
                            set: () => Promise.resolve(),
                            update: () => Promise.resolve()
                        };
                    }
                }
            };
            
            // Make database reference available for recruitment notifications
            window.database = {
                ref: (path) => ref(db, path)
            };
            
            console.log('Firebase RT modules loaded successfully');
        } catch (error) {
            console.error('Failed to load Firebase RT modules:', error);
            window.firebaseRT = null;
            window.database = null;
        }
    </script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Initialize Firebase Storage
        let storage = null;
        try {
            if (firebase.storage) {
                storage = firebase.storage();
                console.log('✅ Firebase Storage initialized successfully');
            } else {
                console.warn('⚠️ Firebase Storage SDK not available');
            }
        } catch (error) {
            console.error('❌ Failed to initialize Firebase Storage:', error);
        }

        // Enhanced Firebase Authentication State Management
        let currentAuthenticatedUser = null;
        let authenticationInitialized = false;

        // Check if user is coming from authenticated session (e.g., from index.html)
        function hasValidAuthenticationIndicators() {
            const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
            const userEmail = localStorage.getItem('userEmail');
            const userName = localStorage.getItem('userName');
            
            return isAuthenticated && userEmail && userName;
        }

        // Enhanced page initialization
        function initializeAuthenticationFlow() {
            console.log('🚀 Initializing authentication flow...');
            
            // If user has valid authentication indicators, don't redirect immediately
            if (hasValidAuthenticationIndicators()) {
                console.log('✅ Found valid authentication indicators, preserving session');
                authenticationInitialized = true;
                
                // Initialize profile with cached data while Firebase loads
                if (typeof initializeUserProfile === 'function') {
                    initializeUserProfile();
                }
            }
        }

        // Call initialization on page load
        document.addEventListener('DOMContentLoaded', initializeAuthenticationFlow);

        // Monitor authentication state changes without redirects
        auth.onAuthStateChanged((user) => {
            currentAuthenticatedUser = user;
            console.log('🔐 Auth state changed:', user ? 'User logged in' : 'User logged out');
            
            if (user) {
                // User is signed in
                console.log('✅ Authenticated user:', {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                });
                
                // Update localStorage
                localStorage.setItem('isAuthenticated', 'true');
                localStorage.setItem('userEmail', user.email);
                localStorage.setItem('userPhotoURL', user.photoURL || '');
                if (user.displayName) {
                    localStorage.setItem('userName', user.displayName);
                } else {
                    localStorage.setItem('userName', user.email.split('@')[0]);
                }
                
                // Refresh user profile display
                if (typeof initializeUserProfile === 'function') {
                    initializeUserProfile();
                }
                
                authenticationInitialized = true;
            } else {
                // User is signed out - log but don't redirect
                console.log('⚠️ User not authenticated - staying on current page');
                
                const wasAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
                const userEmail = localStorage.getItem('userEmail');
                
                // Keep authentication data for users who might be temporarily unauthenticated
                if (wasAuthenticated && userEmail) {
                    console.log('� Preserving authentication data for session restoration');
                    // Don't clear localStorage immediately - keep user data for potential restoration
                } else {
                    console.log('🧹 Clearing localStorage for unauthenticated user');
                    localStorage.removeItem('isAuthenticated');
                    localStorage.removeItem('userName');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userPhotoURL');
                }
            }
        });

        // Enhanced logout function without redirects
        async function logout() {
            try {
                console.log('🚪 Logging out user...');
                
                // Sign out from Firebase
                await auth.signOut();
                
                // Clear localStorage
                localStorage.clear();
                
                // Clear any session data
                sessionStorage.clear();
                
                console.log('✅ Logout successful - staying on current page');
                
                // Don't redirect - just clear the user profile display
                const profileBtn = document.getElementById('userProfileBtn');
                if (profileBtn) {
                    profileBtn.style.display = 'none';
                }
                
            } catch (error) {
                console.error('❌ Logout error:', error);
                
                // Force logout even if Firebase fails
                localStorage.clear();
                sessionStorage.clear();
                
                console.log('🧹 Forced logout completed - staying on current page');
            }
        }
    </script>

    <script>
        // Role-Based Menu Visibility Permission System
        class RolePermissionManager {
            constructor() {
                this.currentUser = null;
                this.userPermissions = {};
                this.companyId = null;
                this.userRole = null;
                this.currentCompany = null;
                this.db = firebase.database();
            }

            // Initialize the permission system
            async initialize() {
                try {
                    console.log('🔐 Initializing Role Permission Manager...');
                    
                    // Get current user data
                    await this.loadCurrentUser();
                    
                    if (!this.currentUser) {
                        console.log('⚠️ No authenticated user found - showing basic menu');
                        this.showBasicMenu();
                        this.showFallbackBranding();
                        return;
                    }

                    // Load user permissions and update menu
                    await this.loadUserPermissions();
                    await this.updateMenuVisibility();
                    this.updatePermissionStatusBar();
                    
                    // Update user profile display with Firebase Storage photo
                    await this.updateUserProfileDisplay();
                    
                    // Load company data and update branding
                    await this.loadCompanyData();
                    
                    console.log('✅ Role Permission Manager initialized successfully');
                } catch (error) {
                    console.error('❌ Error initializing Role Permission Manager:', error);
                    this.showBasicMenu();
                    this.showFallbackBranding();
                }
            }

            // Load current user data from Firebase
            async loadCurrentUser() {
                return new Promise((resolve) => {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        // Get additional user data from localStorage or Firebase
                        const userEmail = user.email || localStorage.getItem('userEmail');
                        const userName = user.displayName || localStorage.getItem('userName');
                        const companyId = localStorage.getItem('companyId') || localStorage.getItem('userCompanyId');
                        
                        this.currentUser = {
                            uid: user.uid,
                            email: userEmail,
                            displayName: userName,
                            companyId: companyId,
                            role: localStorage.getItem('userRole')
                        };
                        
                        this.companyId = companyId;
                        this.userRole = this.currentUser.role;
                        
                        console.log('👤 Current user loaded:', {
                            email: this.currentUser.email,
                            role: this.userRole,
                            companyId: this.companyId
                        });
                        
                        resolve(this.currentUser);
                    } else {
                        // Try to get from localStorage as fallback
                        const storedEmail = localStorage.getItem('userEmail');
                        const storedRole = localStorage.getItem('userRole');
                        const storedCompanyId = localStorage.getItem('companyId') || localStorage.getItem('userCompanyId');
                        
                        if (storedEmail && storedRole) {
                            this.currentUser = {
                                email: storedEmail,
                                role: storedRole,
                                companyId: storedCompanyId
                            };
                            this.companyId = storedCompanyId;
                            this.userRole = storedRole;
                            
                            console.log('📱 User data loaded from localStorage:', this.currentUser);
                            resolve(this.currentUser);
                        } else {
                            console.log('❌ No user data found');
                            resolve(null);
                        }
                    }
                });
            }

            // Load user permissions from Firebase based on role
            async loadUserPermissions() {
                if (!this.userRole) {
                    console.log('⚠️ No user role found');
                    return;
                }

                try {
                    let permissions = {};

                    // Try company-scoped permissions first
                    if (this.companyId) {
                        console.log(`🔍 Loading company-scoped permissions for role: ${this.userRole}`);
                        const companyRoleRef = firebase.database().ref(`companies/${this.companyId}/roles/${this.userRole}/permissions`);
                        const companyRoleSnapshot = await companyRoleRef.once('value');
                        
                        if (companyRoleSnapshot.exists()) {
                            permissions = companyRoleSnapshot.val();
                            console.log('✅ Loaded company-scoped permissions:', Object.keys(permissions));
                        }
                    }

                    // Fallback to global role permissions if company-scoped not found
                    if (Object.keys(permissions).length === 0) {
                        console.log(`🔍 Loading global permissions for role: ${this.userRole}`);
                        const globalRoleRef = firebase.database().ref(`roles/${this.userRole}/permissions`);
                        const globalRoleSnapshot = await globalRoleRef.once('value');
                        
                        if (globalRoleSnapshot.exists()) {
                            permissions = globalRoleSnapshot.val();
                            console.log('✅ Loaded global permissions:', Object.keys(permissions));
                        }
                    }

                    this.userPermissions = permissions;
                    
                    if (Object.keys(permissions).length === 0) {
                        console.log('⚠️ No permissions found for user role - using basic menu');
                    }

                } catch (error) {
                    console.error('❌ Error loading user permissions:', error);
                    this.userPermissions = {};
                }
            }

            // Check if user has specific permission
            hasPermission(permissionName) {
                if (!this.userPermissions || Object.keys(this.userPermissions).length === 0) {
                    console.log(`⚠️ No permissions loaded, denying access to: ${permissionName}`);
                    return false;
                }

                const hasPermission = this.userPermissions[permissionName] === true;
                console.log(`🔍 Permission check for "${permissionName}": ${hasPermission}`);
                
                return hasPermission;
            }

            // Update menu visibility based on permissions
            async updateMenuVisibility() {
                console.log('🎯 Updating menu visibility based on permissions...');
                
                const menuItems = document.querySelectorAll('#roleBasedMenu [data-feature]');
                console.log(`🔍 Found ${menuItems.length} menu items to check`);

                if (Object.keys(this.userPermissions).length === 0) {
                    console.log('⚠️ No permissions available - hiding all permission-based menu items');
                    this.showBasicMenu();
                    return;
                }

                let visibleCount = 0;

                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    const isDropdownContainer = item.classList.contains('menu-dropdown');
                    
                    console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission})`);

                    // Check if user has permission for this feature
                    let hasAccess = false;
                    
                    if (requiresPermission) {
                        hasAccess = this.hasPermission(requiresPermission);
                    } else if (feature) {
                        hasAccess = this.hasPermission(feature);
                    } else {
                        // No permission required - show by default
                        hasAccess = true;
                    }

                    if (hasAccess) {
                        item.classList.add('menu-visible');
                        item.style.display = '';
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${feature}`);
                    } else {
                        item.classList.remove('menu-visible');
                        item.style.display = 'none';
                        console.log(`❌ Hiding menu item: ${feature}`);
                    }
                });

                // Handle dropdown containers - show if any child is visible
                const dropdownContainers = document.querySelectorAll('#roleBasedMenu .menu-dropdown');
                dropdownContainers.forEach(dropdown => {
                    const visibleChildren = dropdown.querySelectorAll('.submenu li:not([style*="display: none"])');
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    
                    if (visibleChildren.length > 0) {
                        dropdown.classList.add('menu-visible');
                        dropdown.style.display = '';
                        console.log(`✅ Showing dropdown: ${dropdownFeature} (${visibleChildren.length} visible children)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        dropdown.style.display = 'none';
                        console.log(`❌ Hiding dropdown: ${dropdownFeature} (no visible children)`);
                    }
                });

                console.log(`🎯 Menu visibility update complete. ${visibleCount} items visible.`);
            }

            // Show basic menu when no permissions are available
            showBasicMenu() {
                console.log('📋 Showing basic menu...');
                
                // Hide all permission-based menu items
                const menuItems = document.querySelectorAll('#roleBasedMenu [data-feature]');
                menuItems.forEach(item => {
                    item.classList.remove('menu-visible');
                    item.style.display = 'none';
                });

                // Show basic items that don't require permissions
                const basicItems = document.querySelectorAll('#roleBasedMenu li:not([data-feature])');
                basicItems.forEach(item => {
                    item.style.display = '';
                });

                // Always show notification settings (current page) and basic navigation
                const currentPageItems = [
                    '#roleBasedMenu [data-feature="notification_settings_view"]',
                    '#roleBasedMenu [data-feature="settings_view"]',
                    '#roleBasedMenu [data-feature="home_view"]'
                ];

                currentPageItems.forEach(selector => {
                    const item = document.querySelector(selector);
                    if (item) {
                        item.classList.add('menu-visible');
                        item.style.display = '';
                        console.log(`✅ Showing basic item: ${item.getAttribute('data-feature')}`);
                    }
                });

                // Update status bar for basic access
                this.updateBasicAccessStatusBar();
            }

            // Update status bar for basic access
            updateBasicAccessStatusBar() {
                const statusBar = document.getElementById('rolePermissionStatus');
                const roleElement = document.getElementById('currentUserRole');
                const permissionCountElement = document.getElementById('permissionCount');
                const menuStatusElement = document.getElementById('menuSystemStatus');
                const activePermissionsList = document.getElementById('activePermissionsList');

                if (!statusBar) return;

                // Show the status bar
                statusBar.style.display = 'block';

                // Update role information
                if (roleElement) {
                    roleElement.textContent = this.userRole || 'Guest User';
                }

                // Update permission count
                if (permissionCountElement) {
                    permissionCountElement.textContent = '0';
                }

                // Update menu status
                if (menuStatusElement) {
                    menuStatusElement.textContent = 'Basic Access Only';
                    statusBar.style.borderLeftColor = '#FF9800';
                }

                // Update active permissions list
                if (activePermissionsList) {
                    activePermissionsList.innerHTML = '<div class="permission-item"><i class="fas fa-info-circle"></i>Limited access - contact administrator for additional permissions</div>';
                }

                // Setup toggle functionality
                this.setupPermissionStatusToggle();
            }

            // Check if user can access current page
            canAccessCurrentPage() {
                const hasNotificationPermission = this.hasPermission('notification_settings_view') || 
                                                this.hasPermission('settings_view') ||
                                                this.hasPermission('mail_notification_view');
                
                console.log('🔍 Current page access check:', hasNotificationPermission);
                return hasNotificationPermission;
            }

            // Get user role for display
            getUserRole() {
                return this.userRole || 'Unknown';
            }

            // Get user permissions for display
            getUserPermissions() {
                return this.userPermissions;
            }

            // Update the permission status bar
            updatePermissionStatusBar() {
                const statusBar = document.getElementById('rolePermissionStatus');
                const roleElement = document.getElementById('currentUserRole');
                const permissionCountElement = document.getElementById('permissionCount');
                const menuStatusElement = document.getElementById('menuSystemStatus');
                const activePermissionsList = document.getElementById('activePermissionsList');

                if (!statusBar) return;

                // Show the status bar
                statusBar.style.display = 'block';

                // Update role information
                if (roleElement) {
                    roleElement.textContent = this.userRole || 'No Role Assigned';
                }

                // Update permission count
                const permissionCount = Object.keys(this.userPermissions).length;
                if (permissionCountElement) {
                    permissionCountElement.textContent = permissionCount;
                }

                // Update menu status
                if (menuStatusElement) {
                    if (permissionCount > 0) {
                        menuStatusElement.textContent = 'Role-Based Access';
                        statusBar.style.borderLeftColor = '#4CAF50';
                    } else {
                        menuStatusElement.textContent = 'Basic Access Only';
                        statusBar.style.borderLeftColor = '#FF9800';
                    }
                }

                // Update active permissions list
                if (activePermissionsList) {
                    activePermissionsList.innerHTML = '';
                    
                    if (permissionCount === 0) {
                        activePermissionsList.innerHTML = '<div class="permission-item"><i class="fas fa-info-circle"></i>No specific permissions assigned</div>';
                    } else {
                        Object.keys(this.userPermissions).forEach(permission => {
                            if (this.userPermissions[permission] === true) {
                                const permissionItem = document.createElement('div');
                                permissionItem.className = 'permission-item';
                                permissionItem.innerHTML = `
                                    <i class="fas fa-check-circle"></i>
                                    ${this.formatPermissionName(permission)}
                                `;
                                activePermissionsList.appendChild(permissionItem);
                            }
                        });
                    }
                }

                // Setup toggle functionality
                this.setupPermissionStatusToggle();
            }

            // Format permission name for display
            formatPermissionName(permission) {
                return permission
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase())
                    .replace(/View$/, '')
                    .trim();
            }

            // Setup permission status toggle functionality
            setupPermissionStatusToggle() {
                const toggleBtn = document.getElementById('togglePermissionDetails');
                const permissionDetails = document.getElementById('permissionDetails');

                if (toggleBtn && permissionDetails) {
                    toggleBtn.onclick = () => {
                        const isVisible = permissionDetails.style.display !== 'none';
                        
                        if (isVisible) {
                            permissionDetails.style.display = 'none';
                            toggleBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Show Details';
                        } else {
                            permissionDetails.style.display = 'block';
                            toggleBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Hide Details';
                        }
                    };
                }
            }

            // Hide permission status bar
            hidePermissionStatusBar() {
                const statusBar = document.getElementById('rolePermissionStatus');
                if (statusBar) {
                    statusBar.style.display = 'none';
                }
            }

            // Refresh permissions (useful when user role changes)
            async refreshPermissions() {
                console.log('🔄 Refreshing user permissions...');
                await this.loadUserPermissions();
                await this.updateMenuVisibility();
                this.updatePermissionStatusBar();
            }

            // Load company data for branding
            async loadCompanyData() {
                try {
                    if (!this.companyId) {
                        console.log('⚠️ No company ID available for loading company data');
                        this.showFallbackBranding();
                        return;
                    }

                    console.log('🏢 Loading company data for:', this.companyId);
                    const companyRef = this.db.ref(`companies/${this.companyId}`);
                    const companySnapshot = await companyRef.once('value');
                    
                    if (companySnapshot.exists()) {
                        this.currentCompany = companySnapshot.val();
                        console.log('✅ Company data loaded:', this.currentCompany.companyName);
                        this.updateCompanyBranding();
                    } else {
                        console.log('❌ No company data found for ID:', this.companyId);
                        this.showFallbackBranding();
                    }
                } catch (error) {
                    console.error('❌ Error loading company data:', error);
                    this.showFallbackBranding();
                }
            }

            // Update company branding in header
            updateCompanyBranding() {
                console.log('🏢 updateCompanyBranding() called');
                if (!this.currentCompany) {
                    console.log('❌ No company data available for branding');
                    this.showFallbackBranding();
                    return;
                }

                console.log('✅ Company data found:', this.currentCompany.companyName);

                // Update company logo and name in header
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');

                console.log('Header elements found:', {
                    logo: headerLogo ? '✅' : '❌',
                    placeholder: headerLogoPlaceholder ? '✅' : '❌',
                    companyName: headerCompanyName ? '✅' : '❌'
                });

                // Update company name
                if (headerCompanyName) {
                    headerCompanyName.textContent = this.currentCompany.companyName || '';
                    console.log('✅ Company name updated:', headerCompanyName.textContent);
                }

                // Update logo or show placeholder
                if (this.currentCompany.logoUrl || this.currentCompany.logo) {
                    const logoUrl = this.currentCompany.logoUrl || this.currentCompany.logo;
                    console.log('✅ Company logo URL found:', logoUrl);
                    
                    if (headerLogo) {
                        headerLogo.src = logoUrl;
                        headerLogo.style.display = 'block';
                        headerLogo.classList.add('visible');
                        console.log('✅ Company logo displayed');
                    }
                    
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'none';
                        console.log('✅ Logo placeholder hidden');
                    }
                } else {
                    console.log('ℹ️ No company logo URL, showing placeholder');
                    // Show placeholder if no logo
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                        console.log('✅ Logo placeholder shown');
                    }
                    
                    if (headerLogo) {
                        headerLogo.style.display = 'none';
                        console.log('✅ Company logo hidden');
                    }
                }
            }

            // Show fallback branding when no company data available
            showFallbackBranding() {
                console.log('🏢 Showing fallback branding');
                
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerCompanyName = document.getElementById('headerCompanyName');

                // Hide company logo, show placeholder
                if (headerLogo) {
                    headerLogo.style.display = 'none';
                    headerLogo.classList.remove('visible');
                }
                
                if (headerLogoPlaceholder) {
                    headerLogoPlaceholder.style.display = 'flex';
                }

                // Show default company name
                if (headerCompanyName) {
                    headerCompanyName.textContent = 'Dreamex Datalab HSE';
                }

                console.log('✅ Fallback branding displayed');
            }

            // Get company-scoped database reference path
            getCompanyScopedPath(path) {
                if (this.companyId) {
                    return `companies/${this.companyId}/${path}`;
                } else {
                    // Fallback to global path if no company context
                    console.warn('⚠️ No company context - using global path for:', path);
                    return path;
                }
            }

            // Get company-scoped database reference
            getCompanyScopedRef(path) {
                const scopedPath = this.getCompanyScopedPath(path);
                console.log('📍 Using company-scoped path:', scopedPath);
                return this.db.ref(scopedPath);
            }

            // Get current company ID for other functions to use
            getCurrentCompanyId() {
                return this.companyId;
            }

            // Get user avatar URL from Firebase Storage (like roles.html)
            async getUserAvatarUrl(userId) {
                try {
                    if (!storage) {
                        console.log('📷 Firebase Storage not available for avatar');
                        return null;
                    }

                    if (!userId) {
                        userId = this.currentUser?.uid;
                    }

                    if (!userId) {
                        console.log('📷 No user ID available for avatar');
                        return null;
                    }

                    const avatarPath = `avatars/${userId}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    console.log(`📷 Attempting to load avatar from: ${avatarPath}`);
                    const downloadURL = await avatarRef.getDownloadURL();
                    console.log('✅ Avatar URL retrieved successfully');
                    return downloadURL;
                } catch (error) {
                    if (error.code === 'storage/object-not-found') {
                        console.log('📷 No custom avatar found - will use initials');
                    } else {
                        console.error('❌ Error loading avatar:', error);
                    }
                    return null;
                }
            }

            // Update user profile display with photo
            async updateUserProfileDisplay() {
                try {
                    const profileImg = document.getElementById('userProfileImg');
                    const profilePlaceholder = document.getElementById('userProfilePlaceholder');
                    
                    if (!profileImg || !profilePlaceholder) {
                        console.log('📷 Profile avatar elements not found');
                        return;
                    }

                    const user = this.currentUser;
                    if (!user) {
                        console.log('📷 No current user for profile display');
                        return;
                    }

                    // Try to load custom avatar from Firebase Storage
                    const avatarUrl = await this.getUserAvatarUrl(user.uid);
                    
                    if (avatarUrl) {
                        // Show profile photo from Firebase Storage
                        profileImg.src = avatarUrl;
                        profileImg.alt = (user.displayName || user.email || 'User') + ' Avatar';
                        profileImg.style.display = 'block';
                        profilePlaceholder.style.display = 'none';
                        console.log('✅ Profile photo loaded from Firebase Storage');
                    } else {
                        // Fallback to initials
                        profileImg.style.display = 'none';
                        profilePlaceholder.style.display = 'flex';
                        
                        const displayName = user.displayName || user.email || 'User';
                        const initials = this.getInitials(displayName);
                        profilePlaceholder.textContent = initials;
                        
                        // Generate a consistent color based on the name
                        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
                        const colorIndex = displayName.charCodeAt(0) % colors.length;
                        profilePlaceholder.style.backgroundColor = colors[colorIndex];
                        
                        console.log('📝 Using initials as fallback:', initials);
                    }
                } catch (error) {
                    console.error('❌ Error updating user profile display:', error);
                    // Fallback to initials on error
                    const profileImg = document.getElementById('userProfileImg');
                    const profilePlaceholder = document.getElementById('userProfilePlaceholder');
                    
                    if (profileImg && profilePlaceholder && this.currentUser) {
                        profileImg.style.display = 'none';
                        profilePlaceholder.style.display = 'flex';
                        
                        const displayName = this.currentUser.displayName || this.currentUser.email || 'User';
                        profilePlaceholder.textContent = this.getInitials(displayName);
                    }
                }
            }

            // Get initials from name (helper method)
            getInitials(name) {
                if (!name) return 'U';
                
                return name
                    .split(/[\s@.]+/)
                    .filter(part => part.length > 0)
                    .map(part => part[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
            }
        }

        // Initialize Role Permission Manager
        let rolePermissionManager;

        // Initialize when page loads and authentication is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait a bit for Firebase auth to initialize
            setTimeout(async () => {
                try {
                    rolePermissionManager = new RolePermissionManager();
                    window.rolePermissionManager = rolePermissionManager; // Make globally accessible
                    await rolePermissionManager.initialize();
                    
                    // Load SMTP configuration after role permission manager is ready
                    console.log('🔧 Loading EmailJS configuration...');
                    await loadEmailJSConfig();
                    
                    // Load current email template
                    console.log('📧 Loading email templates...');
                    await loadTemplate();
                } catch (error) {
                    console.error('❌ Failed to initialize role permission manager:', error);
                }
            }, 2000);
        });

        // Re-initialize when authentication state changes
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user && rolePermissionManager) {
                    console.log('🔄 Auth state changed - refreshing permissions...');
                    setTimeout(async () => {
                        try {
                            await rolePermissionManager.initialize();
                            
                            // Reload EmailJS configuration for the new user/company context
                            console.log('🔧 Reloading EmailJS configuration for auth change...');
                            await loadEmailJSConfig();
                            
                            // Reload email templates for the new user/company context
                            console.log('📧 Reloading email templates for auth change...');
                            await loadTemplate();
                        } catch (error) {
                            console.error('❌ Failed to refresh permissions after auth change:', error);
                        }
                    }, 1000);
                }
            });
        }

        // Global permission check function for use by other components
        window.checkUserPermission = function(permissionName) {
            if (rolePermissionManager) {
                return rolePermissionManager.hasPermission(permissionName);
            }
            console.warn('Role Permission Manager not initialized');
            return false;
        };

        // Global function to get current user role
        window.getCurrentUserRole = function() {
            if (rolePermissionManager) {
                return rolePermissionManager.getUserRole();
            }
            return 'Unknown';
        };

        // Global function to get all user permissions
        window.getCurrentUserPermissions = function() {
            if (rolePermissionManager) {
                return rolePermissionManager.getUserPermissions();
            }
            return {};
        };

        // Global function to refresh permissions
        window.refreshUserPermissions = async function() {
            if (rolePermissionManager) {
                await rolePermissionManager.refreshPermissions();
                return true;
            }
            return false;
        };
    </script>

    <script>
        // Tab switching functionality
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
        }        // SMTP Configuration Functions
        let smtpConnectionPool = null;
        let connectionHealthCheckInterval = null;
        let lastConnectionTest = null;
        
        // SMTP Connection Manager Class
        class SMTPConnectionManager {
            constructor() {
                this.isConnected = false;
                this.connectionAttempts = 0;
                this.maxRetries = 3;
                this.retryDelay = 2000;
                this.healthCheckInterval = 30000; // 30 seconds
                this.lastHealthCheck = null;
                this.connectionPool = new Map();
            }
            
            async createConnection(config = null) {
                const smtpConfig = config || this.getSMTPConfig();
                
                try {
                    // Simulate SMTP connection with proper validation
                    const connectionResult = await this.validateSMTPSettings(smtpConfig);
                    
                    if (connectionResult.success) {
                        this.isConnected = true;
                        this.connectionAttempts = 0;
                        this.lastHealthCheck = Date.now();
                        
                        // Store connection in pool
                        const connectionId = this.generateConnectionId();
                        this.connectionPool.set(connectionId, {
                            config: smtpConfig,
                            createdAt: Date.now(),
                            lastUsed: Date.now(),
                            healthy: true
                        });
                        
                        return { success: true, connectionId, message: 'SMTP connection established successfully' };
                    } else {
                        throw new Error(connectionResult.error || 'SMTP validation failed');
                    }
                } catch (error) {
                    this.isConnected = false;
                    this.connectionAttempts++;
                    throw error;
                }
            }
            
            getSMTPConfig() {
                // SMTP has been replaced with EmailJS - return default config for compatibility
                console.log('⚠️ getSMTPConfig() called but SMTP has been deprecated');
                return {
                    host: 'mail.privateemail.com',
                    port: 587,
                    secure: false,
                    user: 'info@dreamexdatalab.com',
                    pass: '',
                    from: 'info@dreamexdatalab.com',
                    fromName: 'Dreamex Datalab HSE System'
                };
            }
            
            async validateSMTPSettings(config) {
                try {
                    // Enhanced validation for different providers
                    const validationChecks = [
                        this.validateHost(config.host),
                        this.validatePort(config.port),
                        this.validateCredentials(config.user, config.pass),
                        this.validateEmailFormat(config.user),
                        await this.testSMTPConnection(config)
                    ];
                    
                    const results = await Promise.all(validationChecks);
                    const failed = results.filter(r => !r.success);
                    
                    if (failed.length === 0) {
                        return { success: true, message: 'All SMTP validations passed' };
                    } else {
                        return { 
                            success: false, 
                            error: `Validation failed: ${failed.map(f => f.error).join(', ')}` 
                        };
                    }
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            validateHost(host) {
                if (!host || host.trim() === '') {
                    return { success: false, error: 'SMTP host is required' };
                }
                
                // Check for common SMTP hosts
                const validHosts = [
                    'mail.privateemail.com',
                    'smtp.gmail.com',
                    'smtp.outlook.com',
                    'smtp-mail.outlook.com',
                    'smtp.office365.com',
                    'mail.dreamexdatalab.com'
                ];
                
                const isValidHost = validHosts.some(validHost => 
                    host.toLowerCase().includes(validHost.toLowerCase()) || 
                    host.match(/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$/)
                );
                
                return isValidHost ? 
                    { success: true } : 
                    { success: false, error: 'Invalid SMTP host format' };
            }
            
            validatePort(port) {
                const validPorts = [25, 465, 587, 2525];
                return validPorts.includes(port) ? 
                    { success: true } : 
                    { success: false, error: 'Invalid SMTP port. Use 25, 465, 587, or 2525' };
            }
            
            validateCredentials(user, pass) {
                if (!user || !pass) {
                    return { success: false, error: 'SMTP username and password are required' };
                }
                return { success: true };
            }
            
            validateEmailFormat(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email) ? 
                    { success: true } : 
                    { success: false, error: 'Invalid email format' };
            }
            
            async testEmailJSConnection(config) {
                try {
                    // Test EmailJS connection using their API
                    const testServiceId = config.serviceId || '';
                    const testTemplateId = config.templateId || '';
                    
                    if (!testServiceId || !testTemplateId) {
                        return { success: false, error: 'Service ID and Template ID are required' };
                    }
                    
                    // Test with a minimal email
                    const testParams = {
                        to_email: 'test@example.com',
                        from_name: 'Test',
                        subject: 'EmailJS Connection Test',
                        message: 'This is a test message to verify EmailJS configuration.'
                    };
                    
                    const response = await emailjs.send(
                        testServiceId,
                        testTemplateId,
                        testParams,
                        'fHs6oaqQgkcPoUwpv' // Use the public key
                    );
                    
                    return { success: true, message: 'EmailJS connection test successful', response: response };
                    
                } catch (error) {
                    return { success: false, error: `EmailJS test failed: ${error.message}` };
                }
            }
            
            generateConnectionId() {
                return `smtp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }
            
            async performHealthCheck() {
                if (!this.isConnected) return false;
                
                try {
                    const config = this.getSMTPConfig();
                    const healthResult = await this.testSMTPConnection(config);
                    
                    if (healthResult.success) {
                        this.lastHealthCheck = Date.now();
                        return true;
                    } else {
                        this.isConnected = false;
                        return false;
                    }
                } catch (error) {
                    this.isConnected = false;
                    return false;
                }
            }
            
            startHealthCheckMonitoring() {
                if (connectionHealthCheckInterval) {
                    clearInterval(connectionHealthCheckInterval);
                }
                
                connectionHealthCheckInterval = setInterval(async () => {
                    const isHealthy = await this.performHealthCheck();
                    this.updateConnectionStatus(isHealthy);
                }, this.healthCheckInterval);
            }
            
            stopHealthCheckMonitoring() {
                if (connectionHealthCheckInterval) {
                    clearInterval(connectionHealthCheckInterval);
                    connectionHealthCheckInterval = null;
                }
            }
            
            updateConnectionStatus(isConnected) {
                const statusElement = document.getElementById('smtpStatus');
                if (statusElement) {
                    if (isConnected) {
                        statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                        statusElement.className = 'status-indicator status-success';
                    } else {
                        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Reconnecting...';
                        statusElement.className = 'status-indicator status-warning';
                        
                        // Attempt to reconnect
                        this.attemptReconnection();
                    }
                }
            }
            
            async attemptReconnection() {
                if (this.connectionAttempts >= this.maxRetries) {
                    const statusElement = document.getElementById('smtpStatus');
                    if (statusElement) {
                        statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Disconnected';
                        statusElement.className = 'status-indicator status-error';
                    }
                    return;
                }
                
                try {
                    await new Promise(resolve => setTimeout(resolve, this.retryDelay));
                    await this.createConnection();
                    showNotification('SMTP connection restored successfully!', 'success');
                } catch (error) {
                    console.error('Reconnection attempt failed:', error);
                    setTimeout(() => this.attemptReconnection(), this.retryDelay * 2);
                }
            }
            
            getConnectionStats() {
                return {
                    isConnected: this.isConnected,
                    connectionAttempts: this.connectionAttempts,
                    lastHealthCheck: this.lastHealthCheck,
                    activeConnections: this.connectionPool.size,
                    uptimePercentage: this.calculateUptime()
                };
            }
            
            calculateUptime() {
                // Simple uptime calculation based on successful health checks
                const now = Date.now();
                const startTime = this.lastHealthCheck || now;
                const uptime = Math.max(0, (now - startTime) / (1000 * 60 * 60)); // in hours
                return Math.min(100, (uptime / 24) * 100); // Percentage over last 24 hours
            }
        }
        
        // Initialize SMTP Connection Manager
        if (!smtpConnectionPool) {
            smtpConnectionPool = new SMTPConnectionManager();
        }
        
        // EmailJS Configuration Functions
        async function testEmailJSConnection() {
            const button = event?.target || document.querySelector('button[onclick="testEmailJSConnection()"]');
            const originalText = button?.innerHTML || '<i class="fas fa-plug"></i> Test Connection';
            
            if (button) {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing Connection...';
                button.disabled = true;
            }
            
            // Update status to testing
            const statusElement = document.getElementById('emailjsStatus');
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                statusElement.className = 'status-indicator status-info';
            }
            
            try {
                // Initialize EmailJS if not already done
                if (typeof emailjs === 'undefined') {
                    throw new Error('EmailJS library not loaded. Please refresh the page.');
                }
                
                // Initialize EmailJS with public key
                emailjs.init('fHs6oaqQgkcPoUwpv');
                console.log('✅ EmailJS initialized with public key');
                
                // Test EmailJS connection using direct EmailJS call
                console.log('🔍 Testing EmailJS connection directly...');
                
                // Get template ID from form
                const templateId = document.getElementById('emailjsTemplateId')?.value;
                if (!templateId) {
                    throw new Error('Template ID is required. Please visit https://dashboard.emailjs.com/admin/templates to create a template and get the Template ID.');
                }
                
                // Get test email from form
                const testEmail = document.getElementById('emailjsTestEmail')?.value || 'info@dreamexdatalab.com';
                
                console.log('📧 Using Template ID:', templateId);
                console.log('📧 Using Test Email:', testEmail);
                
                // Use the production EmailJS configuration
                const response = await emailjs.send(
                    'service_p2e9swy',  // Updated service ID
                    templateId, // Use template ID from form
                    {
                        to_email: testEmail,  // Use test email from form
                        to_name: 'Test User',
                        subject: 'EmailJS Connection Test',
                        message: 'This is a test message to verify EmailJS connection.',
                        from_name: 'Dreamex Datalab HSE System',
                        reply_to: 'info@dreamexdatalab.com'
                    },
                    'fHs6oaqQgkcPoUwpv' // Your public key
                );
                
                console.log('✅ EmailJS direct test successful:', response);
                
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Connected';
                    statusElement.className = 'status-indicator status-success';
                }
                
                showNotification('EmailJS connection test successful!', 'success');
                updateEmailJSStats();
                
            } catch (error) {
                console.error('EmailJS connection test failed:', error);
                
                // Enhanced error handling to avoid undefined messages
                const errorMessage = error?.message || error?.text || error?.toString() || 'Unknown EmailJS error';
                console.error('Error details:', {
                    message: error?.message,
                    text: error?.text,
                    status: error?.status,
                    name: error?.name,
                    fullError: error
                });
                
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Connection Failed';
                    statusElement.className = 'status-indicator status-error';
                }
                
                showNotification(`EmailJS connection failed: ${errorMessage}`, 'error');
            } finally {
                if (button) {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            }
        }
        
        async function saveEmailJSConfig() {
            const saveButton = event?.target || document.querySelector('button[onclick="saveEmailJSConfig()"]');
            const originalText = saveButton?.innerHTML || '<i class="fas fa-save"></i> Update Configuration';
            
            if (saveButton) {
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveButton.disabled = true;
            }
            
            try {
                const config = {
                    publicKey: document.getElementById('emailjsPublicKey')?.value || 'fHs6oaqQgkcPoUwpv',
                    privateKey: document.getElementById('emailjsPrivateKey')?.value || 'DYBlzuRorbsDIdU5wGBru',
                    serviceId: document.getElementById('emailjsServiceId')?.value || 'service_p2e9swy',
                    templateId: document.getElementById('emailjsTemplateId')?.value || '',
                    lastUpdated: new Date().toISOString()
                };
                
                // Debug configuration values
                console.log('🔍 EmailJS Config Debug (localStorage disabled):', {
                    serviceIdFromField: document.getElementById('emailjsServiceId')?.value,
                    serviceIdFinal: config.serviceId,
                    serviceIdLength: config.serviceId?.length,
                    templateIdFromField: document.getElementById('emailjsTemplateId')?.value,
                    templateIdFinal: config.templateId,
                    fieldElement: document.getElementById('emailjsServiceId'),
                    fieldValue: document.getElementById('emailjsServiceId')?.value,
                    fieldValueLength: document.getElementById('emailjsServiceId')?.value?.length
                });
                
                // Validate configuration
                if (!config.serviceId || !config.templateId) {
                    throw new Error('Service ID and Template ID are required');
                }
                
                // localStorage disabled for troubleshooting
                console.log('ℹ️ localStorage save disabled for troubleshooting');
                
                // Update the EmailJS service if available
                if (window.emailJSService) {
                    window.emailJSService.serviceId = config.serviceId;
                    window.emailJSService.templateId = config.templateId;
                    window.emailJSService.publicKey = config.publicKey;
                    window.emailJSService.privateKey = config.privateKey;
                    
                    console.log('✅ Updated EmailJS service with config:', {
                        serviceId: window.emailJSService.serviceId,
                        serviceIdLength: window.emailJSService.serviceId?.length
                    });
                    
                    // Reinitialize EmailJS with new configuration
                    await window.emailJSService.initializeEmailJS();
                }
                
                showNotification('EmailJS configuration updated (localStorage disabled for testing)!', 'success');
                updateEmailJSStats();
                
            } catch (error) {
                console.error('Failed to save EmailJS configuration:', error);
                showNotification(`Failed to save configuration: ${error.message}`, 'error');
            } finally {
                if (saveButton) {
                    saveButton.innerHTML = originalText;
                    saveButton.disabled = false;
                }
            }
        }
        
        function showEmailJSStats() {
            if (window.emailJSService) {
                const stats = window.emailJSService.getDeliveryStats();
                const history = window.emailJSService.getNotificationHistory(10);
                
                console.log('📊 EmailJS Statistics:', stats);
                console.log('📧 Recent Notifications:', history);
                
                showNotification(`Total emails sent: ${stats.totalSent}, Success rate: ${Math.round((stats.successful / stats.totalSent) * 100)}%`, 'info');
            } else {
                showNotification('EmailJS service not available', 'warning');
            }
        }
        
        function updateEmailJSStats() {
            try {
                if (window.emailJSService) {
                    const stats = window.emailJSService.getDeliveryStats();
                    
                    // Update stat cards with null checks
                    const totalSentElement = document.getElementById('totalSent');
                    const successfulSentElement = document.getElementById('successfulSent');
                    const failedSentElement = document.getElementById('failedSent');
                    const successRateElement = document.getElementById('successRate');
                    
                    if (totalSentElement) totalSentElement.textContent = stats.totalSent || 0;
                    if (successfulSentElement) successfulSentElement.textContent = stats.successful || 0;
                    if (failedSentElement) failedSentElement.textContent = stats.failed || 0;
                    
                    if (successRateElement) {
                        const successRate = stats.totalSent > 0 ? Math.round((stats.successful / stats.totalSent) * 100) : 100;
                        successRateElement.textContent = successRate + '%';
                    }
                    
                    console.log('📊 EmailJS stats updated:', stats);
                } else {
                    console.log('ℹ️ EmailJS service not available for stats update');
                    
                    // Set default values
                    const totalSentElement = document.getElementById('totalSent');
                    const successfulSentElement = document.getElementById('successfulSent');
                    const failedSentElement = document.getElementById('failedSent');
                    const successRateElement = document.getElementById('successRate');
                    
                    if (totalSentElement) totalSentElement.textContent = '0';
                    if (successfulSentElement) successfulSentElement.textContent = '0';
                    if (failedSentElement) failedSentElement.textContent = '0';
                    if (successRateElement) successRateElement.textContent = '100%';
                }
            } catch (error) {
                console.error('❌ Error updating EmailJS stats:', error);
            }
        }
        
        async function loadEmailJSConfig() {
            try {
                console.log('📧 Loading EmailJS configuration (localStorage disabled)...');
                
                // Always use production defaults - no localStorage
                console.log('📧 Setting production EmailJS defaults...');
                
                // Set production configuration directly
                const defaultConfig = {
                    publicKey: 'fHs6oaqQgkcPoUwpv',
                    privateKey: 'DYBlzuRorbsDIdU5wGBru',
                    serviceId: 'service_p2e9swy',
                    templateId: 'template_l50h8ks' // Set the working template ID
                };
                
                console.log('🔍 Default config values:', {
                    serviceId: defaultConfig.serviceId,
                    serviceIdLength: defaultConfig.serviceId.length,
                    templateId: defaultConfig.templateId
                });
                
                // Set form field values directly - always override
                const publicKeyField = document.getElementById('emailjsPublicKey');
                const privateKeyField = document.getElementById('emailjsPrivateKey');
                const serviceIdField = document.getElementById('emailjsServiceId');
                const templateIdField = document.getElementById('emailjsTemplateId');
                const testEmailField = document.getElementById('emailjsTestEmail');
                
                if (publicKeyField) {
                    publicKeyField.value = defaultConfig.publicKey;
                    console.log('✅ Set public key field');
                }
                if (privateKeyField) {
                    privateKeyField.value = defaultConfig.privateKey;
                    console.log('✅ Set private key field');
                }
                if (serviceIdField) {
                    serviceIdField.value = defaultConfig.serviceId;
                    console.log('✅ Set service ID field to:', serviceIdField.value, '(length:', serviceIdField.value.length, ')');
                }
                if (templateIdField) {
                    templateIdField.value = defaultConfig.templateId;
                    console.log('✅ Set template ID field to:', templateIdField.value);
                }
                if (testEmailField && !testEmailField.value) {
                    testEmailField.value = 'info@dreamexdatalab.com';
                    console.log('✅ Set test email field to default');
                }
                
                // Load and display stats
                console.log('📊 Updating EmailJS stats...');
                updateEmailJSStats();
                
                console.log('✅ EmailJS configuration loaded successfully');
                
            } catch (error) {
                console.error('❌ Failed to load EmailJS configuration:', error);
                
                // Show user-friendly error message
                showNotification('Failed to load email configuration. Please refresh the page.', 'error');
            }
        }

        function showDetailedConnectionError(error) {
            const errorDetails = document.createElement('div');
            errorDetails.className = 'alert alert-warning';
            errorDetails.style.marginTop = '1rem';
            errorDetails.innerHTML = `
                <h5><i class="fas fa-exclamation-triangle"></i> Connection Troubleshooting</h5>
                <p><strong>Error:</strong> ${error.message}</p>
                <div class="troubleshooting-steps">
                    <h6>Try these solutions:</h6>
                    <ul>
                        <li>Verify SMTP server settings (host, port, credentials)</li>
                        <li>Check internet connectivity</li>
                        <li>Ensure firewall allows SMTP connections</li>
                        <li>Verify email account credentials</li>
                        <li>Try different SMTP ports (587, 465, 25)</li>
                        <li>Contact your email provider for specific settings</li>
                        <li>Check if 2-factor authentication requires app passwords</li>
                        <li>Verify email account is not locked or suspended</li>
                    </ul>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i> Dismiss
                </button>
            `;
            
            const smtpSection = document.querySelector('.smtp-config');
            if (smtpSection) {
                // Remove any existing error details
                const existingError = smtpSection.querySelector('.alert-warning');
                if (existingError) existingError.remove();
                
                smtpSection.appendChild(errorDetails);
            }
        }
        
        // Reset SMTP Configuration - DEPRECATED
        // This function is kept for compatibility but no longer used (replaced with resetEmailJSConfig)
        async function resetSMTPConfig() {
            console.log('⚠️ resetSMTPConfig() called but SMTP has been replaced with EmailJS');
            console.log('ℹ️ SMTP reset functionality is deprecated - EmailJS uses different configuration');
            
            showNotification('SMTP has been replaced with EmailJS. Please use the EmailJS configuration panel.', 'info');
        }

        // Save SMTP Configuration to Firebase (Company-Scoped) - DEPRECATED
        // This function is kept for compatibility but no longer used (replaced with saveEmailJSConfig)
        async function saveSMTPConfig() {
            console.log('⚠️ saveSMTPConfig() called but SMTP has been replaced with EmailJS');
            console.log('ℹ️ Redirecting to saveEmailJSConfig()...');
            
            try {
                // Redirect to EmailJS configuration saving
                await saveEmailJSConfig();
                console.log('✅ Successfully redirected SMTP config saving to EmailJS');
            } catch (error) {
                console.error('❌ Error in SMTP->EmailJS save redirect:', error);
                showNotification('Configuration save redirected to EmailJS system', 'info');
            }
        }

        // Load SMTP Configuration from Firebase (Company-Scoped) - DEPRECATED
        // This function is kept for compatibility but no longer used (replaced with EmailJS)
        async function loadSMTPConfig() {
            console.log('⚠️ loadSMTPConfig() called but SMTP has been replaced with EmailJS');
            console.log('ℹ️ Redirecting to loadEmailJSConfig()...');
            
            try {
                // Redirect to EmailJS configuration loading
                await loadEmailJSConfig();
                console.log('✅ Successfully redirected SMTP config loading to EmailJS');
            } catch (error) {
                console.error('❌ Error in SMTP->EmailJS redirect:', error);
                // Don't throw error to prevent breaking calling code
            }
        }
        
        // Auto-reconnection on page visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && smtpConnectionPool) {
                // Page became visible, check connection
                setTimeout(() => {
                    if (!smtpConnectionPool.isConnected) {
                        console.log('Page visible, attempting to reconnect SMTP...');
                        testConnection();
                    }
                }, 1000);
            }
        });
        
        // Connection status monitor
        function displayConnectionStats() {
            if (!smtpConnectionPool) return;
            
            const stats = smtpConnectionPool.getConnectionStats();
            const statsElement = document.getElementById('connectionStats');
            
            if (statsElement) {
                statsElement.innerHTML = `
                    <div class="connection-stats">
                        <div class="stat-item">
                            <span class="stat-label">Status:</span>
                            <span class="stat-value ${stats.isConnected ? 'success' : 'error'}">
                                ${stats.isConnected ? 'Connected' : 'Disconnected'}
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Uptime:</span>
                            <span class="stat-value">${stats.uptimePercentage.toFixed(1)}%</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Last Check:</span>
                            <span class="stat-value">
                                ${stats.lastHealthCheck ? new Date(stats.lastHealthCheck).toLocaleTimeString() : 'Never'}
                            </span>
                        </div>
                    </div>
                `;
            }
        }// Template Management Functions
        async function loadTemplate() {
            const templateType = document.getElementById('templateType').value;
            const subjectField = document.getElementById('emailSubject');
            const templateField = document.getElementById('emailTemplate');
            
            try {
                console.log('📧 Loading email template:', templateType);
                
                // Get company-scoped path for email templates
                const templatesPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('email-templates') : 
                    'email-templates';
                
                console.log('📧 Loading template from path:', `${templatesPath}/${templateType}`);
                
                // Try to load from Firebase first
                const snapshot = await database.ref(`${templatesPath}/${templateType}`).once('value');
                
                if (snapshot.exists()) {
                    const templateData = snapshot.val();
                    console.log('✅ Email template loaded from Firebase');
                    
                    subjectField.value = templateData.subject;
                    templateField.value = templateData.content;
                    
                    // Update localStorage for backward compatibility
                    localStorage.setItem(`emailTemplate_${templateType}`, JSON.stringify(templateData));
                    
                    showNotification(`Custom ${getTemplateDisplayName(templateType)} template loaded!`, 'success');
                    return;
                }
                
                // Fallback to localStorage if Firebase doesn't have the template
                const savedTemplate = localStorage.getItem(`emailTemplate_${templateType}`);
                if (savedTemplate) {
                    try {
                        const templateData = JSON.parse(savedTemplate);
                        subjectField.value = templateData.subject;
                        templateField.value = templateData.content;
                        console.log('📦 Email template loaded from localStorage');
                        showNotification(`Custom ${getTemplateDisplayName(templateType)} template loaded from local storage!`, 'info');
                        return;
                    } catch (error) {
                        console.warn('Failed to load saved template from localStorage:', error);
                    }
                }
                
                // Load default template if no custom version exists
                console.log('📄 Loading default template for:', templateType);
                loadDefaultTemplate(templateType, subjectField, templateField);
                
            } catch (error) {
                console.error('Error loading email template:', error);
                showNotification('Failed to load template: ' + error.message, 'warning');
                
                // Fallback to default template
                loadDefaultTemplate(templateType, subjectField, templateField);
            }
        }
        
        // Helper function to load default templates
        function loadDefaultTemplate(templateType, subjectField, templateField) {
            // Check if there's a saved custom version in localStorage
            const savedTemplate = localStorage.getItem(`emailTemplate_${templateType}`);
            
            if (savedTemplate) {
                try {
                    const templateData = JSON.parse(savedTemplate);
                    subjectField.value = templateData.subject;
                    templateField.value = templateData.content;
                    showNotification(`Custom ${getTemplateDisplayName(templateType)} template loaded!`, 'success');
                    return;
                } catch (error) {
                    console.warn('Failed to load saved template:', error);
                }
            }
            
            // Define templates with subjects and text-based content
            const templates = {
                'approval-notification': {
                    subject: 'Access Request Approval Required - {{referenceNumber}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        ACCESS REQUEST APPROVAL REQUIRED
================================================================================

Dear {{approverName}},

A new access request has been submitted and requires your approval.

REQUEST DETAILS:
--------------------------------------------------------------------------------
Reference Number : {{referenceNumber}}
Requester Name   : {{requesterName}}
Department       : {{department}}
Company          : {{company}}
Purpose          : {{purpose}}
Start Date       : {{startDate}}
End Date         : {{endDate}}
Priority         : {{priority}}
Days Pending     : {{daysPending}}

APPROVAL ACTIONS:
--------------------------------------------------------------------------------
To approve this request, please click the link below:
{{approvalLink}}

Or you can review the request details in the HSE system and take appropriate action.

IMPORTANT NOTES:
- Please review all request details carefully before approval
- Ensure the requester meets all safety requirements
- Verify the purpose and duration of access
- Contact the requester if additional information is needed

For questions or assistance, please contact the HSE team.

Best regards,
Dreamex Datalab HSE System
Automated Notification Service

================================================================================
This is an automated message. Please do not reply to this email.
================================================================================`
                },
                'completion-notification': {
                    subject: 'Access Request Approved - {{referenceNumber}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        ACCESS REQUEST APPROVED & COMPLETED
================================================================================

Dear {{requesterName}},

Great news! Your access request has been approved and processed.

REQUEST DETAILS:
--------------------------------------------------------------------------------
Reference Number : {{referenceNumber}}
Requester Name   : {{requesterName}}
Department       : {{department}}
Company          : {{company}}
Purpose          : {{purpose}}
Start Date       : {{startDate}}
End Date         : {{endDate}}
Approved By      : {{approverName}}
Approval Date    : {{approvalDate}}

ACCESS INFORMATION:
--------------------------------------------------------------------------------
Your access request has been approved and you may now proceed with your planned
activities according to the approved schedule and safety requirements.

IMPORTANT REMINDERS:
- Follow all safety protocols and procedures
- Access is valid only for the approved dates and purposes
- Report any incidents or safety concerns immediately
- Ensure proper PPE usage at all times
- Complete required safety briefings before beginning work

NEXT STEPS:
- Coordinate with your supervisor for access arrangements
- Review all safety requirements for your specific activities
- Contact HSE team if you have any questions

Thank you for following proper safety procedures.

Best regards,
Dreamex Datalab HSE System
Automated Notification Service

================================================================================
This is an automated message. Please do not reply to this email.
================================================================================`
                },
                'reminder-notification': {
                    subject: 'REMINDER: Pending Access Request Approval - {{referenceNumber}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        APPROVAL REMINDER - ACTION REQUIRED
================================================================================

Dear {{approverName}},

This is a reminder that an access request is still pending your approval.

REQUEST DETAILS:
--------------------------------------------------------------------------------
Reference Number : {{referenceNumber}}
Requester Name   : {{requesterName}}
Department       : {{department}}
Company          : {{company}}
Purpose          : {{purpose}}
Start Date       : {{startDate}}
End Date         : {{endDate}}
Priority         : {{priority}}
Days Pending     : {{daysPending}}

URGENT ACTION REQUIRED:
--------------------------------------------------------------------------------
This request has been pending for {{daysPending}} days. Please review and 
approve or reject this request as soon as possible to avoid delays.

APPROVAL ACTIONS:
To approve this request, please click the link below:
{{approvalLink}}

ESCALATION NOTICE:
If this request is not processed within the next 24 hours, it will be 
escalated to the next level of management for review.

IMPORTANT NOTES:
- Time-sensitive request requiring immediate attention
- Requester may be waiting for access to complete critical work
- Please prioritize this approval to maintain operational efficiency
- Contact the HSE team if you need assistance with the approval process

For urgent questions, please contact the HSE team immediately.

Best regards,
Dreamex Datalab HSE System
Automated Notification Service

================================================================================
This is an automated message. Please do not reply to this email.
================================================================================`
                },                'rejection-notification': {
                    subject: 'Access Request Declined - {{referenceNumber}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        ACCESS REQUEST DECLINED
================================================================================

Dear {{requesterName}},

We regret to inform you that your access request has been declined.

REQUEST DETAILS:
--------------------------------------------------------------------------------
Reference Number : {{referenceNumber}}
Requester Name   : {{requesterName}}
Department       : {{department}}
Company          : {{company}}
Purpose          : {{purpose}}
Start Date       : {{startDate}}
End Date         : {{endDate}}
Reviewed By      : {{approverName}}
Rejection Date   : {{rejectionDate}}

REJECTION REASON:
--------------------------------------------------------------------------------
{{rejectionReason}}

NEXT STEPS:
--------------------------------------------------------------------------------
If you believe this rejection was made in error or if you can address the
concerns raised, you may:

1. Review the rejection reason and make necessary adjustments
2. Submit a new request with additional information or modifications
3. Contact your supervisor or the HSE team for guidance
4. Provide additional documentation if required

CONTACT INFORMATION:
For questions about this decision or to discuss alternative solutions,
please contact:
- Your direct supervisor
- HSE Team: {{approverEmail}}
- Safety Department for safety-related concerns

We appreciate your understanding and commitment to maintaining a safe
work environment.

Best regards,
Dreamex Datalab HSE System
Automated Notification Service

================================================================================
This is an automated message. Please do not reply to this email.
================================================================================`
                },                'recruitment-interview': {
                    subject: 'Position Closed - {{jobPosition}} - Final Report with {{totalApplicants}} Applications',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        POSITION CLOSURE NOTIFICATION & APPLICANT SUMMARY
================================================================================

Dear {{approverName}},

This notification confirms that the recruitment process for the position below has been officially closed. Please find the complete summary of all applications received during the recruitment period.

POSITION CLOSURE DETAILS:
--------------------------------------------------------------------------------
Reference Number : {{referenceNumber}}
Job Position     : {{jobPosition}}
Department       : {{department}}
Employment Type  : {{employmentType}}
Location         : {{workLocation}}
Position Start Date : {{startDate}}
Recruitment Period  : {{recruitmentStartDate}} to {{recruitmentEndDate}}
Closure Date        : {{closureDate}}
Closed By           : {{closedBy}}

FINAL RECRUITMENT STATISTICS:
--------------------------------------------------------------------------------
Total Applications Received : {{totalApplicants}}
Applications Under Review    : {{applicationsUnderReview}}
Applications Shortlisted     : {{applicationsShortlisted}}
Applications Interviewed     : {{applicationsInterviewed}}
Applications Rejected        : {{applicationsRejected}}
Final Candidates Selected    : {{finalSelectedCount}}

COMPLETE APPLICANT ROSTER:
================================================================================
{{applicantsList}}

POSITION REQUIREMENTS SUMMARY:
--------------------------------------------------------------------------------
Salary Range     : {{salaryMin}} - {{salaryMax}}
Working Hours    : {{workingHours}} hours/week
Required Education : {{requiredEducation}}
Required Experience: {{requiredExperience}}
Required Skills    : {{requiredSkills}}

JOB DESCRIPTION:
--------------------------------------------------------------------------------
{{jobDescription}}

CLOSURE SUMMARY & OUTCOMES:
--------------------------------------------------------------------------------
✓ Position has been officially closed
✓ All applications have been reviewed and processed
✓ Final candidate selection has been completed
✓ Recruitment metrics have been documented
✓ All applicants have been notified of their status
✓ Position closure documentation has been filed

RECRUITMENT PROCESS COMPLETION:
--------------------------------------------------------------------------------
1. ✅ Position posted and advertised
2. ✅ Applications received and reviewed
3. ✅ Initial screening completed
4. ✅ Interviews conducted for qualified candidates
5. ✅ Reference checks completed
6. ✅ Final selection made
7. ✅ All applicants notified
8. ✅ Position officially closed

POST-CLOSURE ACTIONS:
--------------------------------------------------------------------------------
• Final recruitment report generated
• Unsuccessful candidates added to talent pool
• Recruitment metrics updated in HR system
• Position closure documented for audit trail
• Feedback collected for process improvement

CONTACT INFORMATION:
--------------------------------------------------------------------------------
For questions about this closure or applicant information, please contact:
- HR Team: {{hrEmail}}
- Recruitment Manager: {{recruitmentManagerEmail}}
- Direct Supervisor: {{supervisorEmail}}

IMPORTANT NOTES:
--------------------------------------------------------------------------------
- This position is now officially closed to new applications
- All applicant data is maintained per company retention policy
- Recruitment materials have been archived
- Position may be reopened if business needs change
- Feedback on recruitment process is welcome

COMPLIANCE & DOCUMENTATION:
--------------------------------------------------------------------------------
✓ Equal opportunity compliance verified
✓ Interview documentation completed
✓ Reference check records maintained
✓ Rejection reasons documented appropriately
✓ Selection criteria applied consistently
✓ Audit trail maintained throughout process

Thank you for your participation in this recruitment process.

Best regards,
Dreamex Datalab HR System
Recruitment Management Division

================================================================================
This position closure notification was sent to all recruitment stakeholders.
For technical support, contact: it-support@dreamexdatalab.com
================================================================================`
                },
                'interview-schedule': {
                    subject: 'Interview Scheduled - {{jobPosition}} - {{interviewDate}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        INTERVIEW SCHEDULED NOTIFICATION
================================================================================

Dear {{recipientName}},

This notification confirms that an interview has been scheduled for the position listed below. Please review all details carefully and prepare accordingly.

INTERVIEW DETAILS:
--------------------------------------------------------------------------------
Job Position     : {{jobPosition}}
Reference Number : {{referenceNumber}}
Interview Date   : {{interviewDate}}
Interview Time   : {{interviewTime}}
Interview Type   : {{interviewType}}
Location/Link    : {{interviewLocation}}
Duration         : Approximately 60 minutes

APPLICANT INFORMATION:
--------------------------------------------------------------------------------
Applicant Name   : {{applicantName}}
Application ID   : {{applicationId}}
Contact Email    : {{applicantEmail}}
Contact Phone    : {{applicantPhone}}

INTERVIEWER PANEL:
--------------------------------------------------------------------------------
{{interviewersList}}

INTERVIEW PREPARATION:
--------------------------------------------------------------------------------
For Applicants:
• Arrive 10 minutes early for in-person interviews
• Join the video call 5 minutes early for virtual interviews
• Bring copies of your resume and any relevant documents
• Prepare questions about the role and company
• Dress professionally and appropriately
• Ensure stable internet connection for virtual interviews

For Interviewers:
• Review applicant's resume and application materials
• Prepare interview questions based on job requirements
• Ensure interview room/platform is ready and accessible
• Have evaluation forms and scoring criteria available
• Plan for approximately 60 minutes including discussion time

CONTACT INFORMATION:
--------------------------------------------------------------------------------
If you need to reschedule or have questions:
• HR Team: {{hrEmail}}
• Direct Contact: {{interviewerEmail}}
• Phone: {{hrPhone}}

IMPORTANT NOTES:
--------------------------------------------------------------------------------
• Confirm your attendance at least 24 hours before the interview
• Notify us immediately if you cannot attend
• Bring valid ID for verification
• Questions about the role or process are welcome
• Maintain confidentiality of all candidate information

INTERVIEW AGENDA:
--------------------------------------------------------------------------------
1. Welcome and introductions (5 minutes)
2. Role overview and expectations (10 minutes)
3. Technical/behavioral questions (30 minutes)
4. Candidate questions (10 minutes)
5. Next steps discussion (5 minutes)

WHAT TO EXPECT:
--------------------------------------------------------------------------------
• Professional and respectful interview environment
• Questions about your experience and qualifications
• Opportunity to ask questions about the role and company
• Information about next steps in the process
• Feedback timeline and communication expectations

Thank you for your participation in our recruitment process.

Best regards,
Dreamex Datalab HR Team
Recruitment Division

================================================================================
This is an automated interview notification.
For urgent matters, contact HR directly at {{hrPhone}}
================================================================================`
                },
                'interview-evaluation-report': {
                    subject: 'Interview Evaluation Summary - {{candidateName}} for {{jobPosition}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                     INTERVIEW EVALUATION REPORT & SUMMARY
================================================================================

Dear Team,

Please find below the comprehensive interview evaluation report for the candidate who was interviewed for the specified position. This report consolidates all evaluator feedback and provides actionable insights for the hiring decision.

CANDIDATE & POSITION INFORMATION:
--------------------------------------------------------------------------------
Candidate Name    : {{candidateName}}
Job Position      : {{jobPosition}}
Report Date       : {{reportDate}}
Evaluation Period : {{evaluationPeriod}}
Total Evaluations : {{totalEvaluations}}

OVERALL EVALUATION SUMMARY:
--------------------------------------------------------------------------------
Overall Average Score    : {{overallAverage}}/5 ⭐
Overall Recommendation   : {{recommendationSummary}}

DETAILED SCORE BREAKDOWN:
--------------------------------------------------------------------------------
Technical Skills         : {{technicalScore}}/5 ⭐
Communication Skills     : {{communicationScore}}/5 ⭐
Problem-Solving Ability  : {{problemSolvingScore}}/5 ⭐
Cultural Fit             : {{culturalFitScore}}/5 ⭐
Experience & Background  : {{experienceScore}}/5 ⭐

RECOMMENDATION DISTRIBUTION:
--------------------------------------------------------------------------------
{{recommendationBreakdown}}

EVALUATOR PANEL:
--------------------------------------------------------------------------------
{{evaluatorsList}}

COMPREHENSIVE EVALUATION DETAILS:
================================================================================
{{evaluationDetails}}

INDIVIDUAL EVALUATOR SUMMARIES:
================================================================================
{{individualEvaluations}}

STRENGTHS IDENTIFIED:
--------------------------------------------------------------------------------
• Strong technical competency demonstrated across multiple areas
• Excellent communication and interpersonal skills
• Problem-solving approach shows analytical thinking
• Cultural alignment with company values observed
• Relevant experience matches position requirements

AREAS FOR DEVELOPMENT:
--------------------------------------------------------------------------------
• Technical skills development in specific areas as noted
• Enhanced experience in certain domain areas
• Additional training or mentoring opportunities identified
• Professional development recommendations provided

INTERVIEWER FEEDBACK SYNTHESIS:
--------------------------------------------------------------------------------
✓ Candidate demonstrates strong potential for the role
✓ Technical capabilities align with position requirements  
✓ Communication style fits team dynamics well
✓ Problem-solving approach shows promise
✓ Cultural fit assessment indicates good team integration potential
✓ Experience level appropriate for role responsibilities

HIRING RECOMMENDATION:
--------------------------------------------------------------------------------
Based on the comprehensive evaluation from {{totalEvaluations}} interviewer(s), 
the overall recommendation is: {{finalRecommendation}}

Key Decision Factors:
• Overall score of {{overallAverage}}/5 indicates {{performanceLevel}}
• Majority recommendation: {{majorityRecommendation}}
• Technical competency: {{technicalAssessment}}
• Cultural fit evaluation: {{culturalFitAssessment}}
• Experience alignment: {{experienceAlignment}}

NEXT STEPS & ACTIONS:
--------------------------------------------------------------------------------
Recommended Actions:
1. {{nextStep1}}
2. {{nextStep2}}
3. {{nextStep3}}

Timeline:
• Decision deadline: {{decisionDeadline}}
• Candidate follow-up: {{followupDate}}
• Reference checks: {{referenceCheckStatus}}
• Final approval: {{finalApprovalRequired}}

CONTACT INFORMATION:
--------------------------------------------------------------------------------
For questions or additional information about this evaluation:
• HR Team: {{hrContact}}
• Recruitment Manager: {{recruitmentManager}}
• Direct Supervisor: {{supervisorContact}}
• Interview Panel Lead: {{panelLead}}

COMPLIANCE & DOCUMENTATION:
--------------------------------------------------------------------------------
✓ All evaluations completed and documented
✓ Scoring criteria applied consistently
✓ Equal opportunity guidelines followed
✓ Interview documentation archived
✓ Feedback provided to all evaluators
✓ Audit trail maintained for decision process

CONFIDENTIALITY NOTICE:
--------------------------------------------------------------------------------
This evaluation report contains confidential candidate information and should be 
treated with appropriate confidentiality. Distribution is limited to authorized 
personnel involved in the hiring decision process.

EVALUATION METRICS EXPLAINED:
--------------------------------------------------------------------------------
5 Stars: Exceptional - Exceeds all expectations significantly
4 Stars: Excellent - Exceeds expectations in most areas
3 Stars: Good - Meets expectations consistently
2 Stars: Fair - Meets some expectations, development needed
1 Star: Poor - Below expectations, significant improvement required

Thank you to all evaluators for their thorough and professional assessment.

Best regards,
Dreamex Datalab HR Team
Interview Evaluation System

================================================================================
Report generated automatically by the Dreamex Datalab Interview Management System
For technical support: it-support@dreamexdatalab.com
Report ID: {{reportId}} | Generated: {{generationTimestamp}}
================================================================================`
                },
                'job-evaluation-summary': {
                    subject: 'Job Evaluation Summary Report - {{jobPosition}} Position',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                   JOB EVALUATION SUMMARY REPORT & HIRING RECOMMENDATION
================================================================================

Dear Hiring Team,

Please find below the comprehensive job evaluation summary report for all candidates interviewed for the {{jobPosition}} position. This report provides an overview of all applicants, their rankings, and hiring recommendations based on completed evaluations.

POSITION & EVALUATION INFORMATION:
--------------------------------------------------------------------------------
Job Position          : {{jobPosition}}
Report Date           : {{reportDate}}
Evaluation Period     : {{evaluationPeriod}}
Total Candidates      : {{totalCandidates}}
Evaluated Candidates  : {{evaluatedCandidates}}
Total Evaluations     : {{totalEvaluations}}

POSITION-LEVEL EVALUATION SUMMARY:
--------------------------------------------------------------------------------
Average Overall Score    : {{overallAverage}}/5 ⭐
Top Performing Candidate : {{topCandidate}}
High Performers (4.0+)   : {{highPerformersCount}} candidates
Recommended Candidates   : {{recommendedCandidatesCount}} candidates
Evaluation Progress      : {{evaluationProgress}}%

CANDIDATE RANKINGS & PERFORMANCE:
================================================================================
{{candidateRankings}}

DETAILED EVALUATION BREAKDOWN:
================================================================================
{{evaluationDetails}}

TOP CANDIDATE RECOMMENDATIONS:
--------------------------------------------------------------------------------
Based on comprehensive evaluation scores and feedback, the following candidates 
show the strongest potential for the {{jobPosition}} position:

{{topRecommendations}}

EVALUATOR PANEL:
--------------------------------------------------------------------------------
{{evaluatorsList}}

POSITION-SPECIFIC INSIGHTS:
--------------------------------------------------------------------------------
Technical Requirements Assessment:
• {{technicalAssessment}}

Cultural Fit Analysis:
• {{culturalFitAssessment}}

Experience Level Evaluation:
• {{experienceAssessment}}

HIRING RECOMMENDATION SUMMARY:
--------------------------------------------------------------------------------
Overall Position Assessment: {{overallAssessment}}
Recommendation Strength: {{recommendationStrength}}

Primary Recommendation:
{{primaryRecommendation}}

Alternative Options:
{{alternativeRecommendations}}

NEXT STEPS & ACTIONS:
--------------------------------------------------------------------------------
Recommended Actions:
1. {{nextStep1}}
2. {{nextStep2}}
3. {{nextStep3}}

Timeline:
• Decision deadline: {{decisionDeadline}}
• Candidate follow-up: {{followupDate}}
• Reference checks: {{referenceCheckStatus}}
• Final approval: {{finalApprovalRequired}}

DETAILED EVALUATION STATISTICS:
--------------------------------------------------------------------------------
Score Distribution:
• Excellent (4.5-5.0): {{excellentCount}} candidates
• Good (4.0-4.4): {{goodCount}} candidates  
• Average (3.0-3.9): {{averageCount}} candidates
• Below Average (2.0-2.9): {{belowAverageCount}} candidates
• Poor (1.0-1.9): {{poorCount}} candidates

Recommendation Distribution:
• Strongly Recommend: {{stronglyRecommendCount}} candidates
• Recommend: {{recommendCount}} candidates
• Neutral: {{neutralCount}} candidates
• Not Recommend: {{notRecommendCount}} candidates
• Strongly Not Recommend: {{stronglyNotRecommendCount}} candidates

CANDIDATE STATUS SUMMARY:
--------------------------------------------------------------------------------
{{candidateStatusSummary}}

CONTACT INFORMATION:
--------------------------------------------------------------------------------
For questions or additional information about this evaluation:
• HR Team: {{hrContact}}
• Recruitment Manager: {{recruitmentManager}}
• Direct Supervisor: {{supervisorContact}}
• Interview Panel Lead: {{panelLead}}

COMPLIANCE & DOCUMENTATION:
--------------------------------------------------------------------------------
✓ All evaluations completed and documented according to company standards
✓ Scoring criteria applied consistently across all candidates
✓ Equal opportunity and diversity guidelines followed throughout process
✓ Interview documentation properly archived and secured
✓ Comprehensive feedback provided to all evaluators
✓ Complete audit trail maintained for decision transparency

CONFIDENTIALITY NOTICE:
--------------------------------------------------------------------------------
This job evaluation summary contains confidential candidate and company information. 
Distribution is strictly limited to authorized personnel involved in the hiring 
decision process. Please handle with appropriate confidentiality and data protection.

EVALUATION SCORING REFERENCE:
--------------------------------------------------------------------------------
5 Stars: Exceptional - Significantly exceeds all position requirements
4 Stars: Excellent - Exceeds expectations in most critical areas
3 Stars: Good - Consistently meets all position requirements
2 Stars: Fair - Meets basic requirements but development areas identified
1 Star: Poor - Below minimum requirements for the position

================================================================================
Thank you to all evaluators for their thorough professional assessment and 
dedication to finding the best candidate for our team.

Best regards,
Dreamex Datalab HR Team
Recruitment & Talent Acquisition

================================================================================
Report generated automatically by Dreamex Datalab Interview Management System
For technical support: it-support@dreamexdatalab.com
Report ID: {{reportId}} | Generated: {{generationTimestamp}}
================================================================================`
                },
                'kpi-assignment-notification': {
                    subject: 'KPI Assignment Period Started - Organize Team Meetings - {{assignmentPeriod}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                      KPI ASSIGNMENT PERIOD NOTIFICATION
================================================================================

Dear {{lineManagerName}},

The KPI assignment period has officially started! As a line manager, you are required to organize meetings with your direct reports to set KPIs for the current evaluation cycle.

ASSIGNMENT PERIOD DETAILS:
--------------------------------------------------------------------------------
Assignment Start Date : {{assignmentStartDate}}
Assignment End Date   : {{assignmentEndDate}}
Assignment Period     : {{assignmentPeriod}}
Fiscal Year           : {{fiscalYear}}

EVALUATION SCHEDULE:
--------------------------------------------------------------------------------
Mid-Year Evaluation   : {{midYearStartDate}} to {{midYearEndDate}}
Year-End Evaluation   : {{yearEndStartDate}} to {{yearEndEndDate}}

YOUR DIRECT REPORTS:
--------------------------------------------------------------------------------
{{directReportsList}}

REQUIRED ACTIONS:
--------------------------------------------------------------------------------
1. 📅 Schedule one-on-one meetings with each direct report
2. 📋 Discuss and set SMART KPIs aligned with company objectives
3. 📊 Review previous performance and set improvement goals
4. 📝 Document all KPIs in the system before assignment deadline
5. 🎯 Ensure each KPI has clear metrics and success criteria

MEETING AGENDA SUGGESTIONS:
--------------------------------------------------------------------------------
• Review job role and responsibilities
• Discuss department objectives and individual contributions
• Set 3-5 measurable KPIs for the evaluation period
• Define success criteria and measurement methods
• Agree on support needed and resources required
• Schedule regular check-ins and progress reviews

KPI SETTING GUIDELINES:
--------------------------------------------------------------------------------
✓ Specific - Clear and well-defined objectives
✓ Measurable - Quantifiable metrics and targets
✓ Achievable - Realistic and attainable goals
✓ Relevant - Aligned with role and company objectives
✓ Time-bound - Clear deadlines and milestones

SYSTEM ACCESS:
--------------------------------------------------------------------------------
Access the KPI Management System: {{kpiSystemLink}}
- Log in with your corporate credentials
- Navigate to "KPI Assignment" section
- Create KPIs for each direct report
- Submit for approval before the deadline

IMPORTANT DEADLINES:
--------------------------------------------------------------------------------
• Complete all team meetings: {{assignmentEndDate}}
• Submit all KPIs in system: {{assignmentEndDate}}
• KPI approval and finalization: 3 days after assignment period
• Mid-year review preparation: {{midYearStartDate}}

SUPPORT & RESOURCES:
--------------------------------------------------------------------------------
📞 HR Support Desk: extension 1234
📧 KPI Help Desk: kpi-support@dreamexdatalab.com
📖 KPI Setting Guidelines: Available in company portal
🎓 Management Training: Available upon request

COMPLIANCE REMINDERS:
--------------------------------------------------------------------------------
⚠️  All line managers must complete KPI assignments within the deadline
⚠️  Failure to submit KPIs may affect team evaluation schedules
⚠️  Document all discussions for audit and review purposes
⚠️  Ensure fair and unbiased KPI setting across all team members

NEXT STEPS:
--------------------------------------------------------------------------------
1. Review your direct reports list above
2. Schedule meetings within the next 5 business days
3. Prepare meeting agendas using suggested format
4. Access the KPI system and familiarize yourself with the interface
5. Begin KPI setting meetings with your team

Thank you for your leadership in driving performance excellence across the organization.

Best regards,
Dreamex Datalab HR Team
Performance Management Division

================================================================================
This is an automated notification sent to all line managers.
For technical support: it-support@dreamexdatalab.com
================================================================================`
                },
                'kpi-midyear-evaluation': {
                    subject: 'KPI Mid-Year Evaluation Period Started - {{employeeName}} - {{evaluationPeriod}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        KPI MID-YEAR EVALUATION NOTIFICATION
================================================================================

Dear {{employeeName}},

The KPI mid-year evaluation period has officially started! It's time to review your performance for the first half of the evaluation cycle and update your KPI progress.

EVALUATION PERIOD DETAILS:
--------------------------------------------------------------------------------
Employee Name         : {{employeeName}}
Department           : {{department}}
Line Manager         : {{lineManagerName}}
Evaluation Period    : {{evaluationPeriod}}
Mid-Year Start Date  : {{midYearStartDate}}
Mid-Year End Date    : {{midYearEndDate}}
Fiscal Year          : {{fiscalYear}}

YOUR KPI PERFORMANCE SUMMARY:
--------------------------------------------------------------------------------
Total KPIs Assigned  : {{totalKPIs}}
KPIs On Track        : {{kpisOnTrack}}
KPIs Ahead of Target : {{kpisAheadOfTarget}}
KPIs Behind Target   : {{kpisBehindTarget}}
Overall Progress     : {{overallProgressPercentage}}%

EVALUATION TIMELINE:
--------------------------------------------------------------------------------
📅 Self-Evaluation Due       : {{selfEvaluationDeadline}}
👥 Manager Review Period     : {{managerReviewPeriod}}
🤝 One-on-One Meeting       : {{oneOnOneMeetingDate}}
📊 Final Evaluation Complete : {{finalEvaluationDate}}

REQUIRED ACTIONS FOR YOU:
--------------------------------------------------------------------------------
1. 📝 Complete self-evaluation for all assigned KPIs
2. 📊 Update progress percentages and achievement status
3. 💬 Provide comments on challenges and successes
4. 📈 Suggest adjustments for the remaining evaluation period
5. 📅 Schedule meeting with your line manager
6. 🎯 Submit evaluation by the deadline

SELF-EVALUATION GUIDELINES:
--------------------------------------------------------------------------------
✓ Be honest and objective about your performance
✓ Provide specific examples and evidence of achievements
✓ Highlight challenges faced and how you addressed them
✓ Suggest realistic adjustments for remaining period
✓ Include any support or resources needed
✓ Document professional development activities completed

MID-YEAR EVALUATION FOCUS AREAS:
--------------------------------------------------------------------------------
🎯 Achievement Rate: How much of your annual target have you achieved?
📈 Progress Trend: Are you on track to meet year-end goals?
🚧 Obstacles: What challenges have impacted your performance?
💡 Solutions: What strategies have worked well for you?
🔄 Adjustments: What changes might improve your performance?
📚 Development: What skills or training would help you succeed?

SYSTEM ACCESS:
--------------------------------------------------------------------------------
Access your KPI evaluation: {{kpiSystemLink}}
- Log in with your corporate credentials
- Navigate to "Mid-Year Evaluation" section
- Complete all required fields
- Save draft frequently to avoid data loss
- Submit final evaluation before deadline

EVALUATION SCALE:
--------------------------------------------------------------------------------
🟢 Exceeding Expectations (4.5-5.0): Significantly above target
🔵 Meeting Expectations (3.5-4.4): On track to achieve goals
🟡 Approaching Expectations (2.5-3.4): Some improvement needed
🔴 Below Expectations (1.0-2.4): Significant improvement required

MEETING PREPARATION:
--------------------------------------------------------------------------------
Before your one-on-one meeting with {{lineManagerName}}, prepare:
• Review all KPI progress and self-ratings
• Prepare examples of achievements and challenges
• List any support or resources needed
• Think about goals for the remaining period
• Consider professional development opportunities

SUPPORT RESOURCES:
--------------------------------------------------------------------------------
📞 HR Support: extension 1234
📧 Performance Support: performance@dreamexdatalab.com
📖 Evaluation Guidelines: Available in employee portal
🎓 Performance Resources: Training materials available
👥 Peer Support: Connect with colleagues for best practices

IMPORTANT REMINDERS:
--------------------------------------------------------------------------------
⚠️  Complete evaluation by {{selfEvaluationDeadline}}
⚠️  Missing the deadline may delay your performance review
⚠️  Be thorough and provide detailed comments
⚠️  Schedule your manager meeting early to avoid delays
⚠️  Contact HR if you experience any technical issues

CONFIDENTIALITY:
--------------------------------------------------------------------------------
Your evaluation responses are confidential and will only be shared with:
• Your direct line manager
• HR team members involved in the review process
• Senior management as required for approval processes

This mid-year evaluation is an important milestone in your professional development. We encourage open and honest feedback to support your growth and success.

Best regards,
Dreamex Datalab HR Team
Performance Management Division

================================================================================
This is an automated evaluation notification.
For urgent assistance: hr-urgent@dreamexdatalab.com
================================================================================`
                },
                'kpi-yearend-evaluation': {
                    subject: 'KPI Year-End Evaluation Period Started - {{employeeName}} - {{evaluationYear}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        KPI YEAR-END EVALUATION NOTIFICATION
================================================================================

Dear {{employeeName}},

The KPI year-end evaluation period has officially started! It's time to conduct your comprehensive annual performance review and finalize your KPI achievements for the entire evaluation cycle.

EVALUATION PERIOD DETAILS:
--------------------------------------------------------------------------------
Employee Name         : {{employeeName}}
Department           : {{department}}
Position             : {{jobTitle}}
Line Manager         : {{lineManagerName}}
Evaluation Year      : {{evaluationYear}}
Year-End Start Date  : {{yearEndStartDate}}
Year-End End Date    : {{yearEndEndDate}}
Fiscal Year Period   : {{fiscalYearPeriod}}

ANNUAL KPI PERFORMANCE SUMMARY:
--------------------------------------------------------------------------------
Total KPIs Assigned        : {{totalKPIs}}
KPIs Fully Achieved        : {{kpisFullyAchieved}}
KPIs Partially Achieved    : {{kpisPartiallyAchieved}}
KPIs Not Achieved          : {{kpisNotAchieved}}
Overall Achievement Rate   : {{overallAchievementRate}}%
Performance Rating         : {{performanceRating}} / 5.0 ⭐

EVALUATION TIMELINE:
--------------------------------------------------------------------------------
📅 Self-Evaluation Due           : {{selfEvaluationDeadline}}
👥 Manager Review Period         : {{managerReviewPeriod}}
🤝 Performance Review Meeting    : {{performanceReviewMeetingDate}}
📊 Final Rating Approval         : {{finalRatingApprovalDate}}
💰 Salary Review (if applicable) : {{salaryReviewDate}}
🎯 Next Year KPI Planning        : {{nextYearKPIPlanningDate}}

COMPREHENSIVE EVALUATION REQUIREMENTS:
--------------------------------------------------------------------------------
1. 📝 Complete detailed self-evaluation for all KPIs
2. 📊 Provide final achievement percentages and evidence
3. 💬 Write comprehensive comments on performance
4. 🏆 Highlight major accomplishments and successes
5. 🚧 Document challenges and how they were addressed
6. 📈 Assess professional development and growth
7. 🎯 Propose objectives for the upcoming year
8. 📅 Schedule comprehensive review meeting

YEAR-END EVALUATION COMPONENTS:
--------------------------------------------------------------------------------
🎯 KPI Achievement Assessment:
   • Quantitative results vs. targets
   • Quality of work delivered
   • Timeliness and consistency
   • Innovation and problem-solving

📈 Professional Development Review:
   • Skills acquired during the year
   • Training and certifications completed
   • Leadership and initiative demonstrated
   • Collaboration and teamwork

🤝 Behavioral Competencies:
   • Communication effectiveness
   • Adaptability and flexibility
   • Accountability and ownership
   • Customer service orientation

SELF-EVALUATION GUIDELINES:
--------------------------------------------------------------------------------
✓ Provide comprehensive and honest assessment
✓ Include specific examples and quantifiable achievements
✓ Document major projects and contributions
✓ Reflect on learning and professional growth
✓ Acknowledge areas for improvement
✓ Support claims with evidence and data
✓ Consider feedback received throughout the year

PERFORMANCE RATING SCALE:
--------------------------------------------------------------------------------
🌟 Outstanding (4.5-5.0): Consistently exceeds expectations, exceptional performance
⭐ Exceeds Expectations (4.0-4.4): Frequently exceeds requirements and targets
✅ Meets Expectations (3.0-3.9): Consistently meets job requirements and standards
⚠️  Improvement Needed (2.0-2.9): Performance below expectations in some areas
❌ Unsatisfactory (1.0-1.9): Performance significantly below requirements

CAREER DEVELOPMENT DISCUSSION:
--------------------------------------------------------------------------------
Your year-end review will include discussion about:
• Career aspirations and goals
• Potential advancement opportunities
• Professional development needs
• Skill gaps and training requirements
• Mentoring and coaching opportunities
• Next year's role responsibilities

COMPENSATION REVIEW:
--------------------------------------------------------------------------------
Based on your performance evaluation, the following may be considered:
• Merit-based salary adjustments
• Performance bonuses and incentives
• Promotion opportunities
• Additional benefits or allowances
• Professional development funding
• Recognition and awards

SYSTEM ACCESS & TECHNICAL SUPPORT:
--------------------------------------------------------------------------------
Access your year-end evaluation: {{kpiSystemLink}}
- Complete all evaluation sections thoroughly
- Save progress frequently
- Upload supporting documents if required
- Review all entries before final submission
- Contact IT support for technical issues

MEETING PREPARATION CHECKLIST:
--------------------------------------------------------------------------------
Before your performance review meeting with {{lineManagerName}}:
□ Complete all self-evaluation sections
□ Gather evidence of achievements
□ Prepare examples of key accomplishments
□ List professional development activities
□ Consider career goals for next year
□ Prepare questions about feedback and development
□ Review company objectives for alignment

IMPORTANT DEADLINES:
--------------------------------------------------------------------------------
⏰ Self-Evaluation Submission: {{selfEvaluationDeadline}}
⏰ Manager Review Completion: {{managerReviewDeadline}}
⏰ Performance Meeting: {{performanceReviewMeetingDate}}
⏰ Final Rating Approval: {{finalRatingApprovalDate}}

SUPPORT & RESOURCES:
--------------------------------------------------------------------------------
📞 HR Support Hotline: extension 1234
📧 Performance Team: performance@dreamexdatalab.com
📧 Technical Support: it-support@dreamexdatalab.com
📖 Evaluation Guide: Available in employee portal
🎓 Career Development: career-dev@dreamexdatalab.com

CONFIDENTIALITY & DATA PROTECTION:
--------------------------------------------------------------------------------
Your evaluation data is strictly confidential and protected under company policy.
Access is limited to:
• Your direct line manager
• HR performance management team
• Senior management for approval processes
• Only as required for legitimate business purposes

RECOGNITION & REWARDS:
--------------------------------------------------------------------------------
Outstanding performers may be eligible for:
🏆 Employee of the Year awards
💰 Performance bonuses
📈 Promotion considerations
🎓 Professional development opportunities
🌟 Public recognition and appreciation
🎁 Additional benefits and perquisites

Your year-end evaluation is a crucial component of your career development at Dreamex Datalab. We encourage thorough preparation and honest reflection to maximize the value of this process.

Thank you for your dedication and contributions throughout the year!

Best regards,
Dreamex Datalab HR Team
Performance Management & Career Development Division

================================================================================
This is an automated year-end evaluation notification.
For immediate assistance: hr-urgent@dreamexdatalab.com
Report ID: {{notificationId}} | Generated: {{generationTimestamp}}
================================================================================`
                },
                'position-creation-request': {
                    subject: 'Position Creation Request Approval Required - {{positionTitle}} - {{department}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                        POSITION CREATION REQUEST APPROVAL
================================================================================

Dear {{approverName}},

A new position creation request has been submitted and requires your approval. Please review the details below and take appropriate action.

POSITION CREATION REQUEST DETAILS:
--------------------------------------------------------------------------------
Reference Number      : {{referenceNumber}}
Requested Position    : {{positionTitle}}
Department           : {{department}}
Requesting Manager   : {{requestingManager}}
Request Date         : {{requestDate}}
Requested Start Date : {{requestedStartDate}}
Priority Level       : {{priority}}
Budget Code          : {{budgetCode}}

POSITION SPECIFICATIONS:
--------------------------------------------------------------------------------
Employment Type      : {{employmentType}}
Contract Duration    : {{contractDuration}}
Working Hours        : {{workingHours}} hours/week
Work Location        : {{workLocation}}
Reporting Manager    : {{reportingManager}}
Direct Reports       : {{directReports}}

COMPENSATION DETAILS:
--------------------------------------------------------------------------------
Salary Range         : {{salaryMin}} - {{salaryMax}}
Benefits Package     : {{benefitsPackage}}
Annual Budget Impact : {{annualBudgetImpact}}
Department Budget    : {{departmentBudget}}
Available Budget     : {{availableBudget}}

POSITION JUSTIFICATION:
--------------------------------------------------------------------------------
Business Need        : {{businessNeed}}
Key Responsibilities : {{keyResponsibilities}}
Required Skills      : {{requiredSkills}}
Required Experience  : {{requiredExperience}}
Required Education   : {{requiredEducation}}

ORGANIZATIONAL IMPACT:
--------------------------------------------------------------------------------
Team Size Impact     : {{teamSizeImpact}}
Workflow Changes     : {{workflowChanges}}
Training Required    : {{trainingRequired}}
Equipment Needed     : {{equipmentNeeded}}
Office Space         : {{officeSpace}}

RECRUITMENT TIMELINE:
--------------------------------------------------------------------------------
Position Approval    : Pending your approval
Job Posting Start    : {{jobPostingStartDate}}
Application Deadline : {{applicationDeadline}}
Interview Period     : {{interviewPeriod}}
Expected Start Date  : {{expectedStartDate}}
Onboarding Duration  : {{onboardingDuration}}

APPROVAL ACTIONS:
--------------------------------------------------------------------------------
To approve this position creation request, please click the link below:
{{approvalLink}}

Or access the HSE system to review detailed documentation and make your decision.

APPROVAL CHECKLIST:
--------------------------------------------------------------------------------
□ Budget availability verified
□ Business justification reviewed
□ Organizational impact assessed
□ Reporting structure confirmed
□ Compliance requirements checked
□ Department capacity evaluated

IMPORTANT CONSIDERATIONS:
--------------------------------------------------------------------------------
• Verify budget allocation and approval authority
• Ensure position aligns with department objectives
• Review current team capacity and workload
• Consider long-term organizational impact
• Confirm compliance with HR policies
• Assess recruitment timeline feasibility

REJECTION PROCESS:
--------------------------------------------------------------------------------
If you need to reject this request:
• Provide clear reason for rejection
• Suggest alternative solutions if applicable
• Consider deferral to next budget cycle
• Recommend position modifications if needed

ESCALATION NOTICE:
--------------------------------------------------------------------------------
This request requires approval within 5 business days. If not processed within
this timeframe, it will be escalated to the next approval level automatically.

CONTACT INFORMATION:
--------------------------------------------------------------------------------
For questions about this position request:
• Requesting Manager: {{requestingManagerEmail}}
• HR Team: {{hrEmail}}
• Budget Team: {{budgetTeamEmail}}
• Direct Questions: {{requestingManagerPhone}}

SUPPORTING DOCUMENTATION:
--------------------------------------------------------------------------------
• Detailed job description attached
• Budget analysis and projections
• Organizational chart updates
• Market salary analysis
• Department capacity assessment

COMPLIANCE & AUDIT:
--------------------------------------------------------------------------------
✓ Equal opportunity compliance verified
✓ Position classification reviewed
✓ Salary benchmarking completed
✓ Budget authorization confirmed
✓ Approval workflow documented
✓ Audit trail maintained

NEXT STEPS AFTER APPROVAL:
--------------------------------------------------------------------------------
1. Position will be added to organizational structure
2. Job posting will be prepared and published
3. Recruitment process will be initiated
4. Budget allocation will be confirmed
5. Department notification will be sent
6. Reporting structure will be updated

Thank you for your prompt attention to this position creation request. Your
decision will enable us to maintain optimal staffing levels and meet our
operational objectives.

Best regards,
Dreamex Datalab HR Team
Position Management & Recruitment Division

================================================================================
This is an automated position creation notification.
For technical support: it-support@dreamexdatalab.com
Request ID: {{requestId}} | Generated: {{generationTimestamp}}
================================================================================`
                },
                'offer': {
                    subject: 'Job Offer - {{positionTitle}} - {{companyName}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                               OFFICIAL JOB OFFER LETTER
================================================================================

Dear {{candidateName}},

Congratulations! We are pleased to extend you an official job offer for the position of {{positionTitle}} at {{companyName}}.

PERSONAL INFORMATION:
--------------------------------------------------------------------------------
Candidate Name       : {{candidateName}}
Email Address        : {{candidateEmail}}
Phone Number         : {{candidatePhone}}
Application ID       : {{applicationId}}
Interview Date       : {{interviewDate}}
Interview Score      : {{interviewScore}}

POSITION DETAILS:
--------------------------------------------------------------------------------
Job Title            : {{positionTitle}}
Department           : {{department}}
Division             : {{division}}
Reports To           : {{reportsTo}}
Work Location        : {{workLocation}}
Employment Type      : {{employmentType}}
Contract Duration    : {{contractDuration}}
Start Date           : {{startDate}}
Working Hours        : {{workingHours}} hours per week

COMPENSATION PACKAGE:
--------------------------------------------------------------------------------
Base Salary          : {{baseSalary}}
Annual Salary        : {{annualSalary}}
Payment Frequency    : {{paymentFrequency}}
Currency             : {{currency}}
Bonus Eligibility    : {{bonusEligibility}}
Commission Structure : {{commissionStructure}}
Salary Review Date   : {{salaryReviewDate}}

BENEFITS PACKAGE:
--------------------------------------------------------------------------------
Health Insurance     : {{healthInsurance}}
Dental Coverage      : {{dentalCoverage}}
Vision Coverage      : {{visionCoverage}}
Life Insurance       : {{lifeInsurance}}
Retirement Plan      : {{retirementPlan}}
Paid Time Off        : {{paidTimeOff}} days annually
Sick Leave           : {{sickLeave}} days annually
Holiday Schedule     : {{holidaySchedule}}
Professional Development : {{professionalDevelopment}}

WORKING ARRANGEMENTS:
--------------------------------------------------------------------------------
Remote Work Policy   : {{remoteWorkPolicy}}
Flexible Hours       : {{flexibleHours}}
Office Location      : {{officeLocation}}
Parking              : {{parkingArrangement}}
Equipment Provided   : {{equipmentProvided}}
Software Access      : {{softwareAccess}}
Company Phone        : {{companyPhone}}

JOB RESPONSIBILITIES:
--------------------------------------------------------------------------------
Primary Duties       : {{primaryDuties}}
Key Performance Indicators : {{kpiMetrics}}
Success Metrics      : {{successMetrics}}
Training Program     : {{trainingProgram}}
Probation Period     : {{probationPeriod}}
Performance Reviews  : {{performanceReviews}}

COMPANY POLICIES:
--------------------------------------------------------------------------------
Code of Conduct      : Mandatory compliance required
Confidentiality      : Non-disclosure agreement included
Non-Compete Clause   : {{nonCompeteClause}}
Intellectual Property: {{intellectualProperty}}
Social Media Policy  : {{socialMediaPolicy}}
Travel Requirements  : {{travelRequirements}}

ONBOARDING PROCESS:
--------------------------------------------------------------------------------
Orientation Date     : {{orientationDate}}
Document Requirements: {{documentRequirements}}
Background Check     : {{backgroundCheck}}
Drug Testing         : {{drugTesting}}
Security Clearance   : {{securityClearance}}
First Day Instructions: {{firstDayInstructions}}

OFFER CONDITIONS:
--------------------------------------------------------------------------------
Valid Until          : {{offerExpirationDate}}
Contingent Upon       : {{contingencies}}
References Required   : {{referencesRequired}}
Medical Examination   : {{medicalExamination}}
Educational Verification : {{educationVerification}}

ACCEPTANCE INSTRUCTIONS:
--------------------------------------------------------------------------------
To accept this offer, please:

1. Sign and date the attached employment agreement
2. Complete the acceptance form at: {{acceptanceLink}}
3. Return signed documents by: {{responseDeadline}}
4. Provide required documentation as listed above
5. Confirm your start date availability

You can also accept this offer by clicking: {{acceptOfferLink}}

CONTACT INFORMATION:
--------------------------------------------------------------------------------
HR Representative    : {{hrRepresentative}}
Direct Phone         : {{hrPhone}}
Email                : {{hrEmail}}
Hiring Manager       : {{hiringManager}}
Manager Email        : {{managerEmail}}
Department Head      : {{departmentHead}}

IMPORTANT NOTES:
--------------------------------------------------------------------------------
• This offer is contingent upon successful completion of all pre-employment
  requirements including background checks and reference verification
• Employment is at-will and may be terminated by either party with notice
• Full terms and conditions are detailed in the employment agreement
• This offer supersedes any previous verbal or written communications
• Please review all documents carefully before acceptance

NEXT STEPS:
--------------------------------------------------------------------------------
1. Review this offer and all attached documents thoroughly
2. Discuss with family/advisors if needed
3. Prepare required documentation for submission
4. Sign and return acceptance within the specified timeframe
5. Prepare for your first day and orientation program

We are excited about the possibility of you joining our team and contributing
to our continued success. Your skills and experience make you an excellent
fit for this position, and we look forward to working with you.

If you have any questions about this offer or need clarification on any
terms, please don't hesitate to contact our HR team.

Welcome to the Dreamex Datalab family!

Best regards,

{{hiringManagerName}}
{{hiringManagerTitle}}
{{companyName}}

{{hrRepresentativeName}}
Human Resources Department
{{companyName}}

================================================================================
This is an official job offer. Please retain this document for your records.
Offer ID: {{offerId}} | Generated: {{generationTimestamp}}
================================================================================`
                }
            };
            
            // Load the selected template
            if (templates[templateType]) {
                subjectField.value = templates[templateType].subject;
                templateField.value = templates[templateType].body;
                showNotification(`${getTemplateDisplayName(templateType)} template loaded successfully!`, 'success');
            } else {
                showNotification('Template not found!', 'error');
            }
        }        // Helper function to get display name for template types
        function getTemplateDisplayName(templateType) {
            const displayNames = {
                'approval-notification': 'Access Request Approval',
                'completion-notification': 'Request Completion',
                'reminder-notification': 'Approval Reminder',
                'rejection-notification': 'Request Rejection',
                'kpi-assignment-notification': 'KPI Assignment Notification',
                'kpi-midyear-evaluation': 'KPI Mid-Year Evaluation',
                'kpi-yearend-evaluation': 'KPI Year-End Evaluation',
                'recruitment-interview': 'Position Closure & Applicant Summary',
                'interview-schedule': 'Interview Schedule',
                'interview-evaluation-report': 'Interview Evaluation Report',
                'job-evaluation-summary': 'Job Evaluation Summary Report',
                'position-creation-request': 'Position Creation Request',
                'offer': 'Job Offer'
            };
            return displayNames[templateType] || templateType;
        }
        
        async function saveTemplate() {
            const templateType = document.getElementById('templateType').value;
            const subject = document.getElementById('emailSubject').value;
            const content = document.getElementById('emailTemplate').value;
            
            // Validation
            if (!subject.trim()) {
                showNotification('Subject line cannot be empty!', 'error');
                return;
            }
            
            if (!content.trim()) {
                showNotification('Email template content cannot be empty!', 'error');
                return;
            }
            
            // Show loading state
            const saveButton = document.querySelector('button[onclick="saveTemplate()"]');
            const originalText = saveButton?.innerHTML || '<i class="fas fa-save"></i> Save Template';
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            }
            
            try {
                const templateData = {
                    subject: subject,
                    content: content,
                    lastModified: new Date().toISOString(),
                    templateType: templateType,
                    modifiedBy: auth.currentUser?.uid || 'unknown'
                };
                
                // Get company-scoped path for email templates
                const templatesPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('email-templates') : 
                    'email-templates';
                
                console.log('💾 Saving email template to path:', `${templatesPath}/${templateType}`);
                
                // Save to Firebase
                await database.ref(`${templatesPath}/${templateType}`).set(templateData);
                
                // Also save to localStorage for backward compatibility
                localStorage.setItem(`emailTemplate_${templateType}`, JSON.stringify(templateData));
                
                const displayName = getTemplateDisplayName(templateType);
                showNotification(`${displayName} template saved successfully!`, 'success');
                
            } catch (error) {
                console.error('Error saving email template:', error);
                showNotification('Failed to save template: ' + error.message, 'error');
            } finally {
                // Restore button state
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalText;
                }
            }
        }

        // Reset Template to Default
        async function resetTemplate() {
            const templateType = document.getElementById('templateType').value;
            const displayName = getTemplateDisplayName(templateType);
            
            if (confirm(`Reset ${displayName} template to default? This will remove your custom template from Firebase and cannot be undone.`)) {
                try {
                    // Show loading state
                    const resetButton = document.querySelector('button[onclick="resetTemplate()"]');
                    const originalText = resetButton?.innerHTML || '<i class="fas fa-undo"></i> Reset to Default';
                    if (resetButton) {
                        resetButton.disabled = true;
                        resetButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
                    }
                    
                    // Get company-scoped path for email templates
                    const templatesPath = window.rolePermissionManager ? 
                        window.rolePermissionManager.getCompanyScopedPath('email-templates') : 
                        'email-templates';
                    
                    console.log('🗑️ Removing custom template from Firebase:', `${templatesPath}/${templateType}`);
                    
                    // Remove from Firebase
                    await database.ref(`${templatesPath}/${templateType}`).remove();
                    
                    // Remove from localStorage
                    localStorage.removeItem(`emailTemplate_${templateType}`);
                    
                    // Reload the default template
                    loadDefaultTemplate(templateType, 
                        document.getElementById('emailSubject'), 
                        document.getElementById('emailTemplate')
                    );
                    
                    showNotification(`${displayName} template reset to default!`, 'success');
                    
                    // Restore button state
                    if (resetButton) {
                        resetButton.disabled = false;
                        resetButton.innerHTML = originalText;
                    }
                    
                } catch (error) {
                    console.error('Error resetting email template:', error);
                    showNotification('Failed to reset template: ' + error.message, 'error');
                }
            }
        }

        // Load all email templates from Firebase (Company-Scoped)
        async function loadAllEmailTemplates() {
            try {
                console.log('📧 Loading all email templates...');
                
                // Get company-scoped path for email templates
                const templatesPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('email-templates') : 
                    'email-templates';
                
                console.log('📧 Loading all templates from path:', templatesPath);
                
                // Load all templates from Firebase
                const snapshot = await database.ref(templatesPath).once('value');
                
                if (snapshot.exists()) {
                    const allTemplates = snapshot.val();
                    console.log('✅ All email templates loaded from Firebase:', Object.keys(allTemplates));
                    
                    // Update localStorage for each template (backward compatibility)
                    Object.entries(allTemplates).forEach(([templateType, templateData]) => {
                        localStorage.setItem(`emailTemplate_${templateType}`, JSON.stringify(templateData));
                    });
                    
                    return allTemplates;
                } else {
                    console.log('⚠️ No custom email templates found in Firebase');
                    return {};
                }
                
            } catch (error) {
                console.error('Error loading all email templates:', error);
                return {};
            }
        }

        // Bulk save all email templates to Firebase
        async function saveAllEmailTemplates(templates) {
            try {
                console.log('💾 Bulk saving email templates...');
                
                // Get company-scoped path for email templates
                const templatesPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('email-templates') : 
                    'email-templates';
                
                // Save all templates to Firebase
                await database.ref(templatesPath).set(templates);
                
                console.log('✅ All email templates saved to Firebase');
                showNotification('All email templates saved successfully!', 'success');
                
            } catch (error) {
                console.error('Error saving all email templates:', error);
                showNotification('Failed to save email templates: ' + error.message, 'error');
            }
        }
        
        function previewTemplate() {
            const content = document.getElementById('emailTemplate').value;
            const subject = document.getElementById('emailSubject').value;
            const preview = document.getElementById('templatePreview');
            const previewContent = document.getElementById('previewContent');
            
            // Replace variables with sample data for preview
            let previewSubject = subject
                .replace(/\{\{approverName\}\}/g, 'John Approver')
                .replace(/\{\{requesterName\}\}/g, 'Jane Requester')
                .replace(/\{\{referenceNumber\}\}/g, 'ACC-2025-001')
                .replace(/\{\{purpose\}\}/g, 'Equipment maintenance access')
                .replace(/\{\{department\}\}/g, 'Engineering')
                .replace(/\{\{company\}\}/g, 'Dreamex Datalab')
                .replace(/\{\{startDate\}\}/g, '2025-06-10')
                .replace(/\{\{endDate\}\}/g, '2025-06-11')
                .replace(/\{\{priority\}\}/g, 'High')
                .replace(/\{\{approverEmail\}\}/g, 'approver@dreamexdatalab.com')
                .replace(/\{\{approvalDate\}\}/g, '2025-06-08')
                .replace(/\{\{rejectionDate\}\}/g, '2025-06-08')
                .replace(/\{\{candidateName\}\}/g, 'Jane Smith')
                .replace(/\{\{jobPosition\}\}/g, 'Senior HSE Officer')
                .replace(/\{\{interviewDate\}\}/g, '2025-06-20');
              let previewContentHtml = content
                .replace(/\{\{approverName\}\}/g, 'John Approver')
                .replace(/\{\{requesterName\}\}/g, 'Jane Requester')
                .replace(/\{\{referenceNumber\}\}/g, 'ACC-2025-001')
                .replace(/\{\{purpose\}\}/g, 'Equipment maintenance access')
                .replace(/\{\{department\}\}/g, 'Engineering')
                .replace(/\{\{company\}\}/g, 'Dreamex Datalab')
                .replace(/\{\{startDate\}\}/g, '2025-06-10')
                .replace(/\{\{endDate\}\}/g, '2025-06-11')
                .replace(/\{\{priority\}\}/g, 'High')
                .replace(/\{\{approvalLink\}\}/g, 'http://example.com/approve?ref=ACC-2025-001')
                .replace(/\{\{daysPending\}\}/g, '2')
                .replace(/\{\{finalStatus\}\}/g, 'approved')
                .replace(/\{\{comments\}\}/g, 'This is a test completion notification')
                .replace(/\{\{requestLink\}\}/g, 'http://example.com/request?ref=ACC-2025-001')
                .replace(/\{\{rejectionReason\}\}/g, 'Insufficient information provided')
                .replace(/\{\{approverEmail\}\}/g, 'approver@dreamexdatalab.com')
                // Recruitment interview variables
                .replace(/\{\{candidateName\}\}/g, 'Jane Smith')
                .replace(/\{\{jobPosition\}\}/g, 'Senior HSE Officer')
                .replace(/\{\{interviewDate\}\}/g, '2025-06-20')
                .replace(/\{\{interviewTime\}\}/g, '10:00 AM')
                .replace(/\{\{interviewLocation\}\}/g, 'Dreamex Datalab HQ, Meeting Room 3')
                .replace(/\{\{interviewFormat\}\}/g, 'In-person')
                .replace(/\{\{interviewDuration\}\}/g, '1 hour')
                .replace(/\{\{interviewerNames\}\}/g, 'John Wilson (HSE Manager), Sarah Chen (HR Director)')
                .replace(/\{\{hrContactName\}\}/g, 'Michael Brown')
                .replace(/\{\{additionalNotes\}\}/g, 'Please arrive at the reception desk 15 minutes early for security check-in.')                .replace(/\{\{confirmationLink\}\}/g, 'http://example.com/confirm-interview?ref=INT-2025-001')
                .replace(/\{\{hrEmail\}\}/g, 'hr@dreamexdatalab.com')
                .replace(/\{\{hrPhone\}\}/g, '+1 (555) 123-4567')
                // Interview evaluation report variables
                .replace(/\{\{reportDate\}\}/g, '2025-06-16')
                .replace(/\{\{totalEvaluations\}\}/g, '3')
                .replace(/\{\{overallAverage\}\}/g, '4.2')
                .replace(/\{\{recommendationSummary\}\}/g, 'Strongly Recommended')
                .replace(/\{\{technicalScore\}\}/g, '4.5')
                .replace(/\{\{communicationScore\}\}/g, '4.0')
                .replace(/\{\{problemSolvingScore\}\}/g, '4.3')
                .replace(/\{\{culturalFitScore\}\}/g, '4.1')
                .replace(/\{\{experienceScore\}\}/g, '3.9')
                .replace(/\{\{recommendationBreakdown\}\}/g, 'Strongly Recommend: 2 | Recommend: 1 | Neutral: 0 | Not Recommend: 0')
                .replace(/\{\{evaluatorsList\}\}/g, 'John Wilson (HSE Manager), Sarah Chen (HR Director), Michael Brown (Technical Lead)')
                .replace(/\{\{evaluationDetails\}\}/g, 'Comprehensive evaluation completed by 3 experienced interviewers. Candidate demonstrated strong technical skills, excellent communication, and good cultural fit.')
                .replace(/\{\{individualEvaluations\}\}/g, 'Evaluator 1: "Excellent technical knowledge and problem-solving skills."\nEvaluator 2: "Strong communication and leadership potential."\nEvaluator 3: "Good cultural fit and relevant experience."')
                .replace(/\{\{finalRecommendation\}\}/g, 'STRONGLY RECOMMENDED for hire')
                .replace(/\{\{performanceLevel\}\}/g, 'excellent performance')
                .replace(/\{\{majorityRecommendation\}\}/g, 'Strongly Recommend')
                .replace(/\{\{technicalAssessment\}\}/g, 'Exceeds requirements')
                .replace(/\{\{culturalFitAssessment\}\}/g, 'Excellent fit')
                .replace(/\{\{experienceAlignment\}\}/g, 'Well aligned')
                .replace(/\{\{nextStep1\}\}/g, 'Proceed with reference checks')
                .replace(/\{\{nextStep2\}\}/g, 'Prepare offer package')
                .replace(/\{\{nextStep3\}\}/g, 'Schedule final approval meeting')
                .replace(/\{\{decisionDeadline\}\}/g, '2025-06-20')
                .replace(/\{\{followupDate\}\}/g, '2025-06-18')
                .replace(/\{\{referenceCheckStatus\}\}/g, 'Pending')
                .replace(/\{\{finalApprovalRequired\}\}/g, 'Yes - Director level')
                .replace(/\{\{hrContact\}\}/g, 'hr@dreamexdatalab.com')
                .replace(/\{\{recruitmentManager\}\}/g, 'recruitment@dreamexdatalab.com')
                .replace(/\{\{supervisorContact\}\}/g, 'supervisor@dreamexdatalab.com')
                .replace(/\{\{panelLead\}\}/g, 'John Wilson')
                .replace(/\{\{reportId\}\}/g, 'IER-2025-001')
                .replace(/\{\{generationTimestamp\}\}/g, '2025-06-16 14:30:00')
                .replace(/\{\{evaluationPeriod\}\}/g, '2025-06-10 to 2025-06-15');
            
            // Set preview content with syntax highlighting
            previewContent.innerHTML = `<pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${previewContentHtml}</pre>`;
            
            // Show preview section
            preview.style.display = 'block';
        }

        // Email Testing Functions
        async function runTest() {
            const email = document.getElementById('testEmail').value;
            const testType = document.getElementById('testType').value;
            const resultsDiv = document.getElementById('testResults');
              // Clear previous results
            resultsDiv.innerHTML = '';
            
            // Show results div
            resultsDiv.style.display = 'block';
            
            // Check if email is required for this test type
            if (!email && !['connection', 'recruitment', 'archives'].includes(testType)) {
                showNotification('Please enter a test email address', 'error');
                return;
            }
            
            // Add log entry function
            function addLogEntry(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                resultsDiv.appendChild(entry);
                resultsDiv.scrollTop = resultsDiv.scrollHeight;
            }
              try {
                // Common validation for email format (only if email is provided)
                if (email) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        addLogEntry('Invalid email format', 'error');
                        return;
                    }
                }// Run selected test type
                switch (testType) {
                    case 'connection':
                        await testSmtpConnection(resultsDiv);
                        break;
                    case 'approval':
                        await sendTestApprovalEmail(email, resultsDiv);
                        break;
                    case 'completion':
                        await sendTestCompletionEmail(email, resultsDiv);
                        break;
                    case 'reminder':
                        await sendTestReminderEmail(email, resultsDiv);
                        break;
                    case 'recruitment':
                        await testRecruitmentNotification();
                        addLogEntry('Recruitment notification test completed - check console for details', 'success');                        break;
                    case 'archives':
                        await testArchivesConnection();
                        addLogEntry('Archives connection test completed - check logs above for details', 'success');
                        break;
                    case 'applicant-names':
                        await testApplicantNamesFormatting();
                        addLogEntry('Applicant names formatting test completed - check logs above for details', 'success');
                        break;
                    default:
                        addLogEntry('Unknown test type', 'error');
                }
            } catch (error) {
                addLogEntry(`Error: ${error.message}`, 'error');
            }
        }

        async function testSmtpConnection(resultsDiv) {
            addLogEntry('Testing SMTP connection...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/health');
                const result = await response.json();
                
                if (result.status === 'healthy') {
                    addLogEntry('SMTP connection successful', 'success');
                    addLogEntry(`Service: ${result.service}`, 'info');
                    addLogEntry(`Timestamp: ${result.timestamp}`, 'info');
                } else {
                    throw new Error('SMTP service not healthy');
                }
            } catch (error) {
                addLogEntry(`SMTP connection failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function sendTestApprovalEmail(email, resultsDiv) {
            addLogEntry(resultsDiv, `Sending test approval email to ${email}...`, 'info');
            
            const testData = {
                to: email,
                approverName: 'Test Approver',
                requesterName: 'Test Requester',
                referenceNumber: 'TEST-EMAIL-001',
                purpose: 'Email system testing',
                department: 'IT Department',
                company: 'Dreamex Datalab',
                startDate: '2025-06-10',
                endDate: '2025-06-11',
                priority: 'Normal',
                approvalLink: window.location.origin + '/accessboard.html'
            };
            
            try {
                const response = await fetch('http://localhost:3001/send/approval-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dreemex_hse_email_service_2025'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addLogEntry('Test approval email sent successfully!', 'success');
                    addLogEntry(`Message ID: ${result.messageId}`, 'info');
                } else {
                    throw new Error(`Email send failed: ${response.status}`);
                }
            } catch (error) {
                addLogEntry(`Failed to send test email: ${error.message}`, 'error');
                throw error;
            }
        }

        async function sendTestCompletionEmail(email, resultsDiv) {
            addLogEntry(resultsDiv, `Sending test completion email to ${email}...`, 'info');
            
            const testData = {
                to: email,
                requesterName: 'Test Requester',
                referenceNumber: 'TEST-EMAIL-002',
                finalStatus: 'approved',
                comments: 'This is a test completion notification',
                requestLink: window.location.origin + '/accessboard.html'
            };
            
            try {
                const response = await fetch('http://localhost:3001/send/completion-notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'dreemex_hse_email_service_2025'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    addLogEntry('Test completion email sent successfully!', 'success');
                    addLogEntry(`Message ID: ${result.messageId}`, 'info');
                } else {
                    throw new Error(`Email send failed: ${response.status}`);
                }
            } catch (error) {
                addLogEntry(`Failed to send test email: ${error.message}`, 'error');
                throw error;
            }
        }

        async function sendTestReminderEmail(email, resultsDiv) {
            addLogEntry(resultsDiv, `Sending test reminder email to ${email}...`, 'info');
            // Similar implementation for reminder emails
            addLogEntry(resultsDiv, 'Reminder email functionality not yet implemented', 'warning');
        }

        // Recipient Management Functions
        function addRecipient(type) {
            const name = prompt('Enter recipient name:');
            const email = prompt('Enter recipient email:');
            const role = prompt('Enter recipient role:');
            
            if (name && email && role) {
                // Add recipient to the appropriate list
                showNotification(`${name} added as ${type}`, 'success');
            }
        }

        function removeRecipient(type, id) {
            if (confirm('Are you sure you want to remove this recipient?')) {
                showNotification('Recipient removed', 'info');
            }
        }

        // Settings Management Functions
        function saveAllSettings() {
            showNotification('Saving all settings...', 'info');
            
            // SMTP settings have been replaced with EmailJS
            console.log('⚠️ saveAllSettings() called but SMTP configuration has been replaced with EmailJS');
            
            const settings = {
                // Legacy SMTP settings removed - now using EmailJS
                emailjs: {
                    enabled: true,
                    publicKey: 'fHs6oaqQgkcPoUwpv',
                    serviceId: 'service_p2e9swy',
                    templateId: 'template_oq5yvdk'
                },
                templateNotificationSystem: {
                    enabled: true,
                    version: '2.0',
                    migrationDate: new Date().toISOString()
                }
            };
            
            // Save to localStorage
            localStorage.setItem('mailNotifSettings', JSON.stringify(settings));
            
            // Also ensure template notification rules are preserved
            const templateRules = localStorage.getItem('templateNotificationRules');
            if (!templateRules) {
                // Initialize with default rules for all template types
                initializeDefaultTemplateRules();
            }
            
            setTimeout(() => {
                showNotification('All settings saved successfully! Notifications are now managed per template.', 'success');
            }, 1000);
        }
        
        function initializeDefaultTemplateRules() {
            const templateTypes = [
                'approval-notification',
                'reminder-notification', 
                'interview-schedule',
                'interview-evaluation-report',
                'kpi-assignment-notification',
                'kpi-midyear-evaluation',
                'kpi-yearend-evaluation',
                'recruitment-interview',
                'job-evaluation-summary',
                'offer'
            ];
            
            const defaultRules = {};
            templateTypes.forEach(templateType => {
                defaultRules[templateType] = getDefaultNotificationRules(templateType);
            });
            
            localStorage.setItem('templateNotificationRules', JSON.stringify(defaultRules));
            console.log('Default template notification rules initialized');
        }

        function exportConfig() {
            const settings = localStorage.getItem('mailNotifSettings') || '{}';
            const blob = new Blob([settings], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `mail-notification-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Configuration exported successfully!', 'success');
        }

        function importConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const config = JSON.parse(e.target.result);
                            localStorage.setItem('mailNotifSettings', JSON.stringify(config));
                            showNotification('Configuration imported successfully! Please reload the page.', 'success');
                        } catch (error) {
                            showNotification('Invalid configuration file', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
                localStorage.removeItem('mailNotifSettings');
                showNotification('Settings reset to defaults. Please reload the page.', 'info');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        }

        // Utility Functions
        function addLogEntry(container, message, type) {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function showNotification(message, type) {
            // Create and show a temporary notification
            const notification = document.createElement('div');
            notification.className = `alert alert-${type}`;
            notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
            notification.style.position = 'fixed';
            notification.style.top = '100px';
            notification.style.right = '20px';
            notification.style.zIndex = '10000';
            notification.style.minWidth = '300px';
            notification.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved settings if available
            const savedSettings = localStorage.getItem('mailNotifSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    console.log('📦 Loading saved mail notification settings...');
                    
                    // SMTP configuration has been replaced with EmailJS
                    if (settings.smtp) {
                        console.log('⚠️ Found legacy SMTP settings - these have been replaced with EmailJS');
                    }
                    
                    // Handle migration from old notification system to template-based system
                    if (settings.notifications && !settings.templateNotificationSystem) {
                        console.log('Migrating from old notification system to template-based system');
                        migrateToTemplateNotificationSystem(settings.notifications);
                    }
                    
                    // Initialize template notification system if not already done
                    if (!localStorage.getItem('templateNotificationRules')) {
                        initializeDefaultTemplateRules();
                    }
                } catch (error) {
                    console.error('Error loading saved settings:', error);
                }
            }
              // Initialize notifications
            initializeNotifications();
              
            // Initialize user profile dropdown and avatar
            initializeUserProfileDropdown();
            initializeUserProfile();
            
            // Initialize sidebar toggle
            initializeSidebarToggle();
              
            // Initialize SMTP Manager with enhanced features
            initializeSMTPManager();
            
            // Add real-time field validation
            addSMTPFieldValidation();
            
            // Test SMTP connection on page load with delay to allow UI to load
            setTimeout(() => {
                testConnection();
            }, 1500);
            
            // Start periodic connection monitoring
            startPeriodicConnectionMonitoring();
        });
        
        // Add real-time SMTP field validation - DEPRECATED
        // This function is kept for compatibility but no longer used (SMTP replaced with EmailJS)
        function addSMTPFieldValidation() {
            console.log('⚠️ addSMTPFieldValidation() called but SMTP has been replaced with EmailJS');
            console.log('ℹ️ Field validation for EmailJS is handled differently');
            // No-op function to prevent errors
        }
            
        // Initialization function for the page
        function initializePage() {
            // Add auto-save functionality to Email Templates
            addEmailTemplateAutoSave();
        }

        // Add auto-save functionality to SMTP form fields - DEPRECATED
        // This function is kept for compatibility but no longer used (SMTP replaced with EmailJS)
        function addSMTPAutoSave() {
            console.log('⚠️ addSMTPAutoSave() called but SMTP has been replaced with EmailJS');
            console.log('ℹ️ Auto-save for EmailJS is handled differently');
            // No-op function to prevent errors
        }

        // Add auto-save functionality to Email Template form fields
        function addEmailTemplateAutoSave() {
            const templateFields = ['emailSubject', 'emailTemplate'];
            let autoSaveTimeout;
            
            templateFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Add event listeners for input and blur events
                    ['input', 'blur'].forEach(eventType => {
                        field.addEventListener(eventType, function() {
                            // Clear existing timeout
                            if (autoSaveTimeout) {
                                clearTimeout(autoSaveTimeout);
                            }
                            
                            // Auto-save after 3 seconds of inactivity (longer for templates since they're bigger)
                            autoSaveTimeout = setTimeout(async () => {
                                try {
                                    console.log('🔄 Auto-saving email template...');
                                    await saveTemplate();
                                    
                                    // Show subtle feedback in template editor area
                                    const templateEditor = document.querySelector('.template-editor h4');
                                    if (templateEditor) {
                                        const originalText = templateEditor.textContent;
                                        templateEditor.innerHTML = '<i class="fas fa-check"></i> Auto-saved';
                                        templateEditor.style.color = '#28a745';
                                        
                                        // Revert after 2 seconds
                                        setTimeout(() => {
                                            templateEditor.textContent = originalText;
                                            templateEditor.style.color = '';
                                        }, 2000);
                                    }
                                } catch (error) {
                                    console.error('Template auto-save failed:', error);
                                }
                            }, 3000);
                        });
                    });
                }
            });
        }
        
        // Initialize SMTP Manager with enhanced features
        function initializeSMTPManager() {
            try {
                // Load advanced SMTP settings from localStorage
                const advancedSettings = localStorage.getItem('smtpAdvancedSettings');
                if (advancedSettings) {
                    const settings = JSON.parse(advancedSettings);
                    if (settings.connectionTimeout) document.getElementById('connectionTimeout').value = settings.connectionTimeout;
                    if (settings.maxRetries) document.getElementById('maxRetries').value = settings.maxRetries;
                    if (settings.autoReconnect !== undefined) document.getElementById('autoReconnect').checked = settings.autoReconnect;
                    if (settings.healthMonitoring !== undefined) document.getElementById('healthMonitoring').checked = settings.healthMonitoring;
                }
                
                // Update SMTP manager configuration
                if (smtpConnectionPool) {
                    const connectionTimeout = parseInt(document.getElementById('connectionTimeout')?.value) || 30;
                    const maxRetries = parseInt(document.getElementById('maxRetries')?.value) || 3;
                    
                    smtpConnectionPool.retryDelay = 2000;
                    smtpConnectionPool.maxRetries = maxRetries;
                    smtpConnectionPool.healthCheckInterval = 30000; // 30 seconds
                }
                
                // Add event listeners for advanced settings
                const advancedInputs = ['connectionTimeout', 'maxRetries', 'autoReconnect', 'healthMonitoring'];
                advancedInputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('change', saveAdvancedSMTPSettings);
                    }
                });
                
                console.log('SMTP Connection Manager initialized successfully');
            } catch (error) {
                console.error('Error initializing SMTP Manager:', error);
            }
        }
        
        // Save advanced SMTP settings
        async function saveAdvancedSMTPSettings() {
            try {
                console.log('📧 Saving advanced SMTP settings...');
                
                // Call the main save function which handles all SMTP settings including advanced ones
                await saveSMTPConfig();
                
                console.log('✅ Advanced SMTP settings saved through main save function');
                
            } catch (error) {
                console.error('Error saving advanced SMTP settings:', error);
                showNotification('Failed to save advanced SMTP settings: ' + error.message, 'error');
            }
        }
        
        // Periodic connection monitoring
        let connectionMonitorInterval = null;
        
        function startPeriodicConnectionMonitoring() {
            // Clear any existing interval
            if (connectionMonitorInterval) {
                clearInterval(connectionMonitorInterval);
            }
            
            // Update connection statistics every 15 seconds
            connectionMonitorInterval = setInterval(() => {
                displayConnectionStats();
                
                // Auto-test connection if health monitoring is enabled and connection is lost
                const healthMonitoring = document.getElementById('healthMonitoring')?.checked;
                if (healthMonitoring && smtpConnectionPool && !smtpConnectionPool.isConnected) {
                    console.log('Health monitoring detected disconnection, attempting reconnect...');
                    testConnection();
                }
            }, 15000);
            
            // Initial stats display
            setTimeout(() => displayConnectionStats(), 2000);
        }
        
        // Enhanced connection stats display with real-time updates
        function displayConnectionStats() {
            if (!smtpConnectionPool) return;
            
            const stats = smtpConnectionPool.getConnectionStats();
            const statsElement = document.getElementById('connectionStats');
            
            if (statsElement) {
                const lastCheckTime = stats.lastHealthCheck ? 
                    new Date(stats.lastHealthCheck).toLocaleTimeString() : 'Never';
                    
                const uptimeColor = stats.uptimePercentage >= 95 ? 'success' : 
                                  stats.uptimePercentage >= 80 ? 'warning' : 'error';
                
                statsElement.innerHTML = `
                    <div class="connection-stats">
                        <div class="stat-item">
                            <span class="stat-label">Connection Status</span>
                            <span class="stat-value ${stats.isConnected ? 'success' : 'error'}">
                                <i class="fas ${stats.isConnected ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                ${stats.isConnected ? 'Connected' : 'Disconnected'}
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Uptime</span>
                            <span class="stat-value ${uptimeColor}">
                                <i class="fas fa-clock"></i>
                                ${stats.uptimePercentage.toFixed(1)}%
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Last Health Check</span>
                            <span class="stat-value">
                                <i class="fas fa-heartbeat"></i>
                                ${lastCheckTime}
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Connection Pool</span>
                            <span class="stat-value">
                                <i class="fas fa-database"></i>
                                ${stats.activeConnections} active
                            </span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Retry Attempts</span>
                            <span class="stat-value ${stats.connectionAttempts > 0 ? 'warning' : 'success'}">
                                <i class="fas fa-redo"></i>
                                ${stats.connectionAttempts}/${smtpConnectionPool.maxRetries}
                            </span>
                        </div>
                    </div>
                `;
            }
        }
        
        // Cleanup function when page unloads
        window.addEventListener('beforeunload', () => {
            if (connectionMonitorInterval) {
                clearInterval(connectionMonitorInterval);
            }
            if (smtpConnectionPool) {
                smtpConnectionPool.stopHealthCheckMonitoring();
            }
        });// Notification Management Functions
        async function fetchNotifications() {
            try {
                // Generate comprehensive notifications similar to other pages
                const notifications = [];
                
                // Generate a realistic number of notifications (around 927 like other pages)
                const notificationTypes = [
                    { type: 'success', title: 'Access Request Approved', message: 'Your access request #ACC-{id} has been approved', priority: 'high' },
                    { type: 'warning', title: 'Pending Approval', message: 'Access request #ACC-{id} requires your approval', priority: 'high' },
                    { type: 'info', title: 'Training Reminder', message: 'Safety training session due in 3 days', priority: 'medium' },
                    { type: 'error', title: 'System Alert', message: 'Failed to send notification email for request #ACC-{id}', priority: 'high' },
                    { type: 'success', title: 'Inspection Complete', message: 'Safety inspection for Area {id} completed successfully', priority: 'medium' },
                    { type: 'warning', title: 'Permit Expiring', message: 'Work permit #PTW-{id} expires in 24 hours', priority: 'high' },
                    { type: 'info', title: 'Document Updated', message: 'JSA document #JSA-{id} has been updated', priority: 'low' },
                    { type: 'success', title: 'Training Completed', message: 'Employee completed safety training module', priority: 'medium' },
                    { type: 'warning', title: 'Risk Assessment Due', message: 'Risk assessment for project #{id} is overdue', priority: 'high' },
                    { type: 'info', title: 'Email Sent', message: 'Notification email delivered successfully to 15 recipients', priority: 'low' },
                    { type: 'error', title: 'SMTP Error', message: 'Failed to connect to mail server at 14:30', priority: 'high' },
                    { type: 'success', title: 'Backup Complete', message: 'Daily system backup completed successfully', priority: 'low' },
                    { type: 'warning', title: 'Capacity Alert', message: 'Email queue is 85% full - {id} messages pending', priority: 'medium' },
                    { type: 'info', title: 'User Login', message: 'User {id} logged into the system', priority: 'low' },
                    { type: 'success', title: 'Report Generated', message: 'Monthly safety report generated for department {id}', priority: 'medium' }
                ];
                
                // Generate 927 notifications to match other pages
                for (let i = 1; i <= 927; i++) {
                    const template = notificationTypes[Math.floor(Math.random() * notificationTypes.length)];
                    const hoursAgo = Math.floor(Math.random() * 720); // Random time up to 30 days ago
                    const isRead = Math.random() > 0.15; // 85% chance of being read
                    
                    notifications.push({
                        id: i,
                        title: template.title,
                        message: template.message.replace('{id}', String(i).padStart(3, '0')),
                        type: template.type,
                        priority: template.priority,
                        timestamp: new Date(Date.now() - hoursAgo * 60 * 60 * 1000),
                        read: isRead
                    });
                }
                
                // Sort by timestamp (newest first)
                notifications.sort((a, b) => b.timestamp - a.timestamp);
                
                return notifications;
            } catch (error) {
                console.error('Error fetching notifications:', error);
                return [];
            }
        }

        async function updateNotificationCount() {
            try {
                const notifications = await fetchNotifications();
                const unreadCount = notifications.filter(n => !n.read).length;
                
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    badge.textContent = unreadCount;
                    badge.style.display = unreadCount > 0 ? 'inline' : 'none';
                }
                
                // Update notification list
                updateNotificationList(notifications);
                
            } catch (error) {
                console.error('Error updating notification count:', error);
            }
        }

        function updateNotificationList(notifications) {
            const notificationList = document.querySelector('.notification-list');
            if (!notificationList) return;
            
            if (notifications.length === 0) {
                notificationList.innerHTML = '<div class="no-notifications">No notifications</div>';
                return;
            }
            
            notificationList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                    <div class="notification-icon ${notification.type}">
                        <i class="fas ${getNotificationIcon(notification.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatNotificationTime(notification.timestamp)}</div>
                    </div>
                    ${!notification.read ? '<div class="notification-dot"></div>' : ''}
                </div>
            `).join('');
            
            // Add click listeners to notification items
            notificationList.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', () => markNotificationAsRead(item.dataset.id));
            });
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'error': return 'fa-times-circle';
                case 'info': 
                default: return 'fa-info-circle';
            }
        }

        function formatNotificationTime(timestamp) {
            const now = new Date();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / (1000 * 60));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        async function markNotificationAsRead(notificationId) {
            try {
                // In a real implementation, this would call your API
                console.log(`Marking notification ${notificationId} as read`);
                
                // Update UI
                const item = document.querySelector(`[data-id="${notificationId}"]`);
                if (item) {
                    item.classList.remove('unread');
                    item.classList.add('read');
                    const dot = item.querySelector('.notification-dot');
                    if (dot) dot.remove();
                }
                
                // Update count
                await updateNotificationCount();
                
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllNotificationsAsRead() {
            try {
                // In a real implementation, this would call your API
                console.log('Marking all notifications as read');
                
                // Update UI
                document.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                    item.classList.add('read');
                    const dot = item.querySelector('.notification-dot');
                    if (dot) dot.remove();
                });
                
                // Update count
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    badge.textContent = '0';
                    badge.style.display = 'none';
                }
                
                showNotification('All notifications marked as read', 'success');
                
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
            }
        }

        async function initializeNotifications() {
            // Set up notification button click handler
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationDropdown.style.display = 
                        notificationDropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                        notificationDropdown.style.display = 'none';
                    }
                });
            }
            
            // Set up mark all as read button
            const markAllReadBtn = document.querySelector('.mark-all-read');
            if (markAllReadBtn) {
                markAllReadBtn.addEventListener('click', markAllNotificationsAsRead);
            }
            
            // Initial load
            updateNotificationCount();
            
            // Auto-refresh notifications every 30 seconds
            setInterval(updateNotificationCount, 30000);
        }
        
        // Sidebar toggle functionality
        function initializeSidebarToggle() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebarToggle && sidebar && mainContent) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                    console.log('📱 Sidebar toggled');
                });
            }
        }

        // User Profile Dropdown functionality
        let profileDropdownInitialized = false;
        
        function initializeUserProfileDropdown() {
            // Prevent multiple initializations
            if (profileDropdownInitialized) {
                console.log('👤 Profile dropdown already initialized, skipping...');
                return;
            }
            
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (!userProfileBtn || !profileDropdown) {
                console.warn('👤 Profile button or dropdown not found');
                return;
            }
            
            console.log('👤 Initializing profile dropdown...');
            
            // Toggle dropdown when profile button is clicked
            userProfileBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('👤 Profile button clicked, toggling dropdown');
                profileDropdown.classList.toggle('show');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!userProfileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    if (profileDropdown.classList.contains('show')) {
                        console.log('👤 Closing dropdown (clicked outside)');
                        profileDropdown.classList.remove('show');
                    }
                }
            });
            
            // Enhanced logout functionality
            const logoutBtn = document.querySelector('#logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    console.log('👤 Logout clicked');
                    
                    // Show confirmation dialog
                    if (confirm('Are you sure you want to logout?')) {
                        await logout();
                    }
                });
            }
            
            profileDropdownInitialized = true;
            console.log('✅ Profile dropdown initialized successfully');
        }
        
        // Enhanced User Profile with Firebase Authentication
        async function initializeUserProfile() {
            try {
                const profileBtn = document.getElementById('userProfileBtn');
                const profileImg = document.getElementById('userProfileImg');
                const profilePlaceholder = document.getElementById('userProfilePlaceholder');
                
                if (!profileBtn || !profileImg || !profilePlaceholder) {
                    console.warn('Profile elements not found');
                    return;
                }
                
                // Check Firebase authentication state
                const currentUser = await getCurrentAuthenticatedUser();
                let displayName, email, photoURL;
                
                if (currentUser) {
                    // User is authenticated via Firebase
                    displayName = currentUser.displayName || currentUser.email || 'Authenticated User';
                    email = currentUser.email;
                    photoURL = currentUser.photoURL;
                    
                    // Update localStorage with authenticated user data
                    localStorage.setItem('userName', displayName);
                    localStorage.setItem('userEmail', email);
                    localStorage.setItem('isAuthenticated', 'true');
                    
                    console.log('✅ Firebase authenticated user:', { displayName, email });
                } else {
                    // Check localStorage for previously authenticated user data
                    displayName = localStorage.getItem('userName');
                    email = localStorage.getItem('userEmail');
                    const wasAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
                    
                    if (wasAuthenticated && displayName && email) {
                        console.log('📱 Using cached authenticated user data:', { displayName, email });
                        // Allow using cached data while Firebase authentication is restoring
                    } else {
                        console.warn('⚠️ No authenticated user data found');
                        
                        // Only redirect if we're confident user is not authenticated
                        // Give time for Firebase to initialize before redirecting
                        setTimeout(() => {
                            if (!firebase.auth().currentUser && localStorage.getItem('isAuthenticated') !== 'true') {
                                console.warn('� No authentication found after timeout, redirecting to login');
                                // Don't redirect - stay on current page
                            }
                        }, 2000);
                        return;
                    }
                }
                
                // Update profile image - show either real avatar or initials
                if (photoURL) {
                    // Show Firebase user's photo
                    profileImg.src = photoURL;
                    profileImg.alt = displayName + ' Avatar';
                    profileImg.style.display = 'block';
                    profilePlaceholder.style.display = 'none';
                    console.log('✅ Firebase user photo loaded');
                } else {
                    // Show initials avatar
                    profileImg.style.display = 'none';
                    profilePlaceholder.style.display = 'flex';
                    
                    const initials = getUserInitials(displayName);
                    profilePlaceholder.textContent = initials;
                    
                    // Generate a color based on the name for consistency
                    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#34495e'];
                    const colorIndex = displayName.charCodeAt(0) % colors.length;
                    profilePlaceholder.style.backgroundColor = colors[colorIndex];
                    
                    console.log('✅ User initials avatar generated:', initials);
                }
                
                // Update user info in the dropdown
                updateUserInfoDropdown(displayName, email);
                
            } catch (error) {
                console.error('❌ Error initializing user profile:', error);
                // Fallback to default avatar
                const profileImg = document.querySelector('#userProfileBtn img');
                if (profileImg) {
                    generateInitialsAvatar('User', profileImg);
                }
                // Log error but don't redirect
                console.log('🔍 Profile initialization failed, but staying on current page');
            }
        }

        // Get current authenticated user from Firebase
        async function getCurrentAuthenticatedUser() {
            return new Promise((resolve) => {
                // Check if Firebase Auth is available
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    // If we already have the current user from auth state listener
                    if (currentAuthenticatedUser !== null) {
                        resolve(currentAuthenticatedUser);
                        return;
                    }
                    
                    // Wait for auth state to be determined
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        unsubscribe(); // Remove listener after first call
                        resolve(user);
                    });
                } else {
                    console.warn('⚠️ Firebase Auth not available');
                    resolve(null);
                }
            });
        }

        // Update user info in dropdown
        function updateUserInfoDropdown(displayName, email) {
            const userNameElement = document.querySelector('.profile-dropdown .user-name');
            const userEmailElement = document.querySelector('.profile-dropdown .user-email');
            
            if (userNameElement) {
                userNameElement.textContent = displayName;
            }
            if (userEmailElement) {
                userEmailElement.textContent = email;
            }
        }

        // Authentication utilities removed - no redirects
        
        // Get user initials for avatar display
        function getUserInitials(displayName) {
            if (!displayName || displayName === 'User') return 'U';
            
            const words = displayName.split(' ').filter(word => word.length > 0);
            if (words.length === 1) {
                return words[0].substring(0, 2).toUpperCase();
            } else {
                return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
            }
        }
        
        // Generate initials avatar
        function generateInitialsAvatar(name, imgElement) {
            if (!imgElement || !name) return;
            
            const initials = getUserInitials(name);
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const backgroundColor = colors[name.length % colors.length];
            
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                </svg>
            `;
            
            imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
            imgElement.alt = name + ' Avatar';
        }
        
        // Get user avatar URL (placeholder function - would connect to Firebase Storage in real app)
        async function getUserAvatarUrl() {
            try {
                // In a real app, this would check Firebase Storage for user avatar
                // For demo purposes, return null to show initials avatar
                return null;
            } catch (error) {
                return null;
            }
        }

        // Logout function without redirect
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any saved data
                localStorage.removeItem('currentUser');
                console.log('🚪 User logged out - staying on current page');
                
                // Hide user profile elements if they exist
                const profileBtn = document.getElementById('userProfileBtn');
                if (profileBtn) {
                    profileBtn.style.display = 'none';
                }
            }
        }

        // Template-specific notification functions - New Logic Implementation
        
        /**
         * Main function to check if a notification should be sent for a given template type
         * This replaces the old global notification trigger logic
         * @param {string} templateType - The template type from the email template dropdown
         * @param {Object} context - Additional context like trigger type, time, etc.
         * @returns {boolean|Object} Boolean or detailed response with rules applied
         */
        function shouldSendNotification(templateType, context = {}) {
            try {
                // Get template-specific rules
                const rules = getTemplateNotificationRules(templateType);
                
                if (!rules || !rules.enabled) {
                    console.log(`Notifications disabled for template: ${templateType}`);
                    return false;
                }
                
                // Check delivery window if enabled
                if (rules.deliveryWindow && !isWithinDeliveryWindow(rules)) {
                    console.log(`Outside delivery window for template: ${templateType}`);
                    return false;
                }
                
                // Check day restrictions (weekends)
                if (!rules.weekendDelivery && isWeekend()) {
                    console.log(`Weekend delivery disabled for template: ${templateType}`);
                    return false;
                }
                
                // Return rules object with validation results
                return {
                    shouldSend: true,
                    rules: rules,
                    templateType: templateType,
                    context: context
                };
                
            } catch (error) {
                console.error('Error checking notification rules:', error);
                return false;
            }
        }
        
        /**
         * Send template-specific notification using the new rule system
         * This is the main function that replaces old notification trigger functions
         * @param {string} templateType - Template type identifier
         * @param {Object} data - Data to populate the template
         * @param {Array|string} recipients - Recipients email(s)
         * @param {Object} context - Additional context (trigger type, priority override)
         * @returns {Promise<Object>} Notification sending result
         */
        async function sendTemplateNotification(templateType, data, recipients, context = {}) {
            try {
                console.log(`Attempting to send notification for template: ${templateType}`);
                
                // Check if notification should be sent using new rule system
                const shouldSend = shouldSendNotification(templateType, context);
                
                if (!shouldSend) {
                    return {
                        success: false,
                        message: 'Notification blocked by template rules',
                        templateType: templateType
                    };
                }
                
                // Get template rules for sending configuration
                const rules = typeof shouldSend === 'object' ? shouldSend.rules : getTemplateNotificationRules(templateType);
                
                // Prepare recipients array
                let recipientList = Array.isArray(recipients) ? recipients : [recipients];
                
                // Add copy recipients if enabled
                if (rules.copyRecipients && rules.copyEmails) {
                    const copyEmails = rules.copyEmails.split(',').map(email => email.trim());
                    recipientList = [...recipientList, ...copyEmails];
                }
                
                // Remove duplicates
                recipientList = [...new Set(recipientList)];
                
                // Prepare email options based on template rules
                const emailOptions = {
                    templateType: templateType,
                    priority: rules.priority || 'normal',
                    retryAttempts: rules.retryAttempts || 3,
                    retryInterval: rules.retryInterval || 30,
                    immediateSend: rules.immediateSend || false,
                    rules: rules
                };
                
                // Send using email service with template-specific settings
                const result = await sendNotificationWithTemplate(templateType, data, recipientList, emailOptions);
                
                // Log successful notification
                logNotificationActivity(templateType, recipientList.length, 'sent', result);
                
                return {
                    success: true,
                    templateType: templateType,
                    recipientCount: recipientList.length,
                    rules: rules,
                    result: result
                };
                
            } catch (error) {
                console.error(`Error sending template notification (${templateType}):`, error);
                
                // Log failed notification
                logNotificationActivity(templateType, 0, 'failed', { error: error.message });
                
                return {
                    success: false,
                    templateType: templateType,
                    error: error.message
                };
            }
        }
        
        /**
         * Actual email sending function that works with the email service
         * @param {string} templateType - Template type
         * @param {Object} data - Email data
         * @param {Array} recipients - Recipient emails
         * @param {Object} options - Email options from template rules
         * @returns {Promise<Object>} Email service result
         */
        async function sendNotificationWithTemplate(templateType, data, recipients, options) {
            // Get email service instance
            const emailService = window.emailNotificationService || window.EmailNotificationService;
            
            if (!emailService) {
                throw new Error('Email service not available');
            }
            
            // Map template types to email service methods
            const templateMethodMap = {
                'approval-notification': 'sendApprovalNotificationEmails',
                'reminder-notification': 'sendReminderNotification',
                'interview-schedule': 'sendInterviewScheduleNotification',
                'interview-evaluation-report': 'sendInterviewReport',
                'kpi-assignment-notification': 'sendKPINotification',
                'kpi-midyear-evaluation': 'sendKPIEvaluationNotification',
                'kpi-yearend-evaluation': 'sendKPIEvaluationNotification',
                'recruitment-interview': 'sendRecruitmentNotification',
                'job-evaluation-summary': 'sendJobEvaluationSummary'
            };
            
            // Get the appropriate method name
            const methodName = templateMethodMap[templateType] || 'sendGenericNotification';
            
            // Prepare email data with template-specific rules
            const emailData = {
                ...data,
                recipients: recipients,
                templateType: templateType,
                priority: options.priority,
                retryAttempts: options.retryAttempts,
                retryInterval: options.retryInterval,
                immediateSend: options.immediateSend
            };
            
            // Send via email service
            if (typeof emailService[methodName] === 'function') {
                return await emailService[methodName](emailData);
            } else {
                // Fallback to generic notification method
                return await sendGenericTemplateNotification(emailData, options);
            }
        }
        
        /**
         * Fallback generic notification sender for templates without specific handlers
         * @param {Object} emailData - Email data
         * @param {Object} options - Email options
         * @returns {Promise<Object>} Result object
         */
        async function sendGenericTemplateNotification(emailData, options) {
            console.log(`Sending generic template notification: ${emailData.templateType}`);
            
            // Simulate email sending for now - replace with actual implementation
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({
                        success: true,
                        method: 'generic-template',
                        templateType: emailData.templateType,
                        recipientCount: emailData.recipients.length,
                        timestamp: new Date().toISOString()
                    });
                }, 1000);
            });
        }
        
        /**
         * Replace old notification trigger functions with template-based logic
         */
        
        // KPI Notification Triggers (Updated)
        function triggerKPIAssignmentNotification(assignmentData) {
            return sendTemplateNotification(
                'kpi-assignment-notification',
                assignmentData,
                assignmentData.assigneeEmail,
                { trigger: 'assignment', priority: 'high' }
            );
        }
        
        function triggerKPIMidyearEvaluationNotification(evaluationData) {
            return sendTemplateNotification(
                'kpi-midyear-evaluation',
                evaluationData,
                evaluationData.evaluatorEmails,
                { trigger: 'midyear-evaluation', priority: 'normal' }
            );
        }
        
        function triggerKPIYearEndEvaluationNotification(evaluationData) {
            return sendTemplateNotification(
                'kpi-yearend-evaluation',
                evaluationData,
                evaluationData.evaluatorEmails,
                { trigger: 'yearend-evaluation', priority: 'high' }
            );
        }
        
        // Recruitment Notification Triggers (Updated)
        function triggerRecruitmentInterviewNotification(interviewData) {
            return sendTemplateNotification(
                'recruitment-interview',
                interviewData,
                [interviewData.candidateEmail, interviewData.interviewerEmail],
                { trigger: 'interview-schedule', priority: 'high' }
            );
        }
        
        function triggerJobEvaluationSummaryNotification(jobData) {
            return sendTemplateNotification(
                'job-evaluation-summary',
                jobData,
                jobData.hrEmails,
                { trigger: 'job-evaluation', priority: 'normal' }
            );
        }
        
        // Access Request Notification Triggers (Updated)
        function triggerApprovalNotification(requestData) {
            return sendTemplateNotification(
                'approval-notification',
                requestData,
                requestData.approverEmails,
                { trigger: 'approval-request', priority: 'high' }
            );
        }
        
        function triggerReminderNotification(reminderData) {
            return sendTemplateNotification(
                'reminder-notification',
                reminderData,
                reminderData.recipientEmails,
                { trigger: 'reminder', priority: 'high' }
            );
        }
        
        // Interview Report Notification Triggers (Updated)
        function triggerInterviewReportNotification(reportData) {
            return sendTemplateNotification(
                'interview-evaluation-report',
                reportData,
                reportData.recipientEmails,
                { trigger: 'interview-report', priority: 'normal' }
            );
        }
        
        /**
         * Utility functions for template-based notification system
         */
        
        function isWithinDeliveryWindow(rules) {
            if (!rules.deliveryWindow || !rules.startTime || !rules.endTime) {
                return true; // No restrictions
            }
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const [startHour, startMin] = rules.startTime.split(':').map(Number);
            const [endHour, endMin] = rules.endTime.split(':').map(Number);
            
            const startTime = startHour * 60 + startMin;
            const endTime = endHour * 60 + endMin;
            
            return currentTime >= startTime && currentTime <= endTime;
        }
        
        function isWeekend() {
            const day = new Date().getDay();
            return day === 0 || day === 6; // Sunday = 0, Saturday = 6
        }
        
        function logNotificationActivity(templateType, recipientCount, status, details) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                templateType: templateType,
                recipientCount: recipientCount,
                status: status,
                details: details
            };
            
            // Store in localStorage for tracking
            const logs = JSON.parse(localStorage.getItem('notificationActivityLogs') || '[]');
            logs.push(logEntry);
            
            // Keep only last 1000 entries
            if (logs.length > 1000) {
                logs.splice(0, logs.length - 1000);
            }
            
            localStorage.setItem('notificationActivityLogs', JSON.stringify(logs));
            console.log('Notification activity logged:', logEntry);
        }
        
        /**
         * Template Rules Management Functions 
         * (These should already exist, but adding for completeness)
         */
        
        function getTemplateNotificationRules(templateType) {
            const allRules = JSON.parse(localStorage.getItem('templateNotificationRules') || '{}');
            return allRules[templateType] || getDefaultNotificationRules(templateType);
        }
        
        function saveTemplateNotificationRules() {
            const templateType = document.getElementById('notificationTemplateType').value;
            if (!templateType) {
                showNotification('Please select a template type first', 'warning');
                return;
            }
            
            try {
                const rules = collectNotificationRulesFromForm();
                
                // Validate rules
                const validation = validateNotificationRules(rules);
                if (!validation.isValid) {
                    showNotification(`Validation failed: ${validation.errors.join(', ')}`, 'error');
                    return;
                }
                
                // Save rules
                const allRules = JSON.parse(localStorage.getItem('templateNotificationRules') || '{}');
                allRules[templateType] = rules;
                localStorage.setItem('templateNotificationRules', JSON.stringify(allRules));
                
                showNotification(`Notification rules saved for ${templateType}`, 'success');
                
                // Update status overview
                updateTemplateStatusOverview();
                
            } catch (error) {
                console.error('Error saving notification rules:', error);
                showNotification('Failed to save notification rules', 'error');
            }
        }
        
        function resetTemplateNotificationRules() {
            const templateType = document.getElementById('notificationTemplateType').value;
            if (!templateType) {
                showNotification('Please select a template type first', 'warning');
                return;
            }
            
            if (confirm(`Reset notification rules for ${templateType} to defaults?`)) {
                const defaultRules = getDefaultNotificationRules(templateType);
                populateNotificationRulesForm(defaultRules);
                showNotification(`Rules reset to defaults for ${templateType}`, 'info');
            }
        }
        
        function testTemplateNotification() {
            const templateType = document.getElementById('notificationTemplateType').value;
            if (!templateType) {
                showNotification('Please select a template type first', 'warning');
                return;
            }
            
            const testEmail = prompt('Enter test email address:');
            if (!testEmail || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(testEmail)) {
                showNotification('Please enter a valid email address', 'warning');
                return;
            }
            
            // Prepare test data
            const testData = {
                testMode: true,
                recipientName: 'Test User',
                templateType: templateType,
                timestamp: new Date().toISOString()
            };
            
            // Send test notification
            sendTemplateNotification(templateType, testData, testEmail, { test: true })
                .then(result => {
                    if (result.success) {
                        showNotification(`Test notification sent successfully to ${testEmail}`, 'success');
                    } else {
                        showNotification(`Test notification failed: ${result.message || result.error}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Test notification error:', error);
                    showNotification(`Test notification failed: ${error.message}`, 'error');
                });
        }
        
        function collectNotificationRulesFromForm() {
            return {
                enabled: document.getElementById('enableTemplateNotifications').checked,
                priority: document.getElementById('notificationPriority').value,
                immediateSend: document.getElementById('immediateSend').checked,
                retryAttempts: parseInt(document.getElementById('retryAttempts').value),
                retryInterval: parseInt(document.getElementById('retryInterval').value),
                copyRecipients: document.getElementById('copyRecipients').checked,
                copyEmails: document.getElementById('copyEmails').value,
                deliveryWindow: document.getElementById('deliveryWindow').checked,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                weekendDelivery: document.getElementById('weekendDelivery').checked
            };
        }
        
        function validateNotificationRules(rules) {
            const errors = [];
            
            if (rules.retryAttempts < 1 || rules.retryAttempts > 5) {
                errors.push('Retry attempts must be between 1 and 5');
            }
            
            if (rules.retryInterval < 5 || rules.retryInterval > 60) {
                errors.push('Retry interval must be between 5 and 60 minutes');
            }
            
            if (rules.copyRecipients && rules.copyEmails) {
                const emails = rules.copyEmails.split(',').map(e => e.trim());
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const invalidEmails = emails.filter(email => !emailRegex.test(email));
                if (invalidEmails.length > 0) {
                    errors.push(`Invalid email addresses: ${invalidEmails.join(', ')}`);
                }
            }
            
            if (rules.deliveryWindow && rules.startTime && rules.endTime) {
                if (rules.startTime >= rules.endTime) {
                    errors.push('Start time must be before end time');
                }
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }
        
        function populateNotificationRulesForm(rules) {
            document.getElementById('enableTemplateNotifications').checked = rules.enabled;
            document.getElementById('notificationPriority').value = rules.priority;
            document.getElementById('immediateSend').checked = rules.immediateSend;
            document.getElementById('retryAttempts').value = rules.retryAttempts;
            document.getElementById('retryInterval').value = rules.retryInterval;
            document.getElementById('copyRecipients').checked = rules.copyRecipients;
            document.getElementById('copyEmails').value = rules.copyEmails || '';
            document.getElementById('deliveryWindow').checked = rules.deliveryWindow;
            document.getElementById('startTime').value = rules.startTime || '';
            document.getElementById('endTime').value = rules.endTime || '';
            document.getElementById('weekendDelivery').checked = rules.weekendDelivery;
            
            // Toggle sections based on checkbox states
            toggleCopyRecipientsSection();
            toggleDeliveryWindowSection();
        }
        
        function getDefaultNotificationRules(templateType) {
            const baseDefaults = {
                enabled: true,
                priority: 'normal',
                immediateSend: false,
                retryAttempts: 3,
                retryInterval: 30,
                copyRecipients: false,
                copyEmails: '',
                deliveryWindow: false,
                startTime: '08:00',
                endTime: '18:00',
                weekendDelivery: false
            };
            
            // Template-specific overrides
            const templateOverrides = {
                'approval-notification': {
                    priority: 'high',
                    immediateSend: true,
                    retryAttempts: 5
                },
                'reminder-notification': {
                    priority: 'high',
                    immediateSend: true
                },
                'interview-schedule': {
                    priority: 'high',
                    retryAttempts: 5,
                    copyRecipients: true
                },
                'kpi-assignment-notification': {
                    copyRecipients: true,
                    deliveryWindow: true
                },
                'kpi-midyear-evaluation': {
                    copyRecipients: true,
                    deliveryWindow: true
                },
                'kpi-yearend-evaluation': {
                    copyRecipients: true,
                    deliveryWindow: true
                },
                'recruitment-interview': {
                    copyRecipients: true
                },
                'offer': {
                    priority: 'high',
                    retryAttempts: 5,
                    copyRecipients: true,
                    deliveryWindow: true
                }
            };
            
            return { ...baseDefaults, ...(templateOverrides[templateType] || {}) };
        }
        
        // Make functions globally available for backwards compatibility
        window.shouldSendNotification = shouldSendNotification;
        window.sendTemplateNotification = sendTemplateNotification;
        window.triggerKPIAssignmentNotification = triggerKPIAssignmentNotification;
        window.triggerKPIMidyearEvaluationNotification = triggerKPIMidyearEvaluationNotification;
        window.triggerKPIYearEndEvaluationNotification = triggerKPIYearEndEvaluationNotification;
        window.triggerRecruitmentInterviewNotification = triggerRecruitmentInterviewNotification;
        window.triggerJobEvaluationSummaryNotification = triggerJobEvaluationSummaryNotification;
        window.triggerApprovalNotification = triggerApprovalNotification;
        window.triggerReminderNotification = triggerReminderNotification;
        window.triggerInterviewReportNotification = triggerInterviewReportNotification;
        
        console.log('✅ Template-based notification system initialized');

        // Recipients Management Functions
        let recipientsData = {
            access_request: [],
            approval_reminder: [],
            recruitment_interview: [],
            status_update: [],
            system_alert: []
        };

        // Initialize Firebase Recipients Management
        async function initializeFirebaseRecipients() {
            try {
                // Get company-scoped path for notification recipients
                const recipientsPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('notification-recipients') : 
                    'notification-recipients';
                    
                console.log('📧 Initializing recipients at path:', recipientsPath);
                
                const recipientsRef = database.ref(recipientsPath);
                  recipientsRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        recipientsData = {
                            access_request: [],
                            approval_reminder: [],
                            recruitment_interview: [],
                            status_update: [],
                            system_alert: []
                        };
                        
                        Object.entries(data).forEach(([type, recipients]) => {
                            if (recipientsData.hasOwnProperty(type)) {
                                recipientsData[type] = Array.isArray(recipients) ? recipients : Object.values(recipients);
                                console.log(`Loaded ${recipientsData[type].length} recipients for ${type}`);
                            }
                        });
                    } else {
                        console.log('No recipients data found in Firebase, using empty data structure');
                        recipientsData = {
                            access_request: [],
                            approval_reminder: [],
                            recruitment_interview: [],
                            status_update: [],
                            system_alert: []
                        };
                    }
                    
                    const currentType = document.getElementById('notificationType')?.value || 'access_request';
                    console.log(`Displaying recipients for type: ${currentType}`);
                    displayRecipientsForType(currentType);
                });
                
                console.log('Firebase recipients initialized successfully');
                
            } catch (error) {
                console.error('Error initializing Firebase recipients:', error);
                showNotification('Failed to initialize recipient management', 'error');
            }
        };        async function updateNotificationSettings() {
            try {
                const notificationType = document.getElementById('notificationType').value;
                
                console.log(`Updating notification settings: Type=${notificationType}`);
                  // Update the display label
                document.getElementById('selectedNotificationType').textContent = 
                    notificationType === 'all' ? 'All' : 
                    notificationType === 'recruitment_interview' ? 'Recruitment Interview' :
                    notificationType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                // Display recipients
                await displayRecipientsForType(notificationType);
                
                showNotification(`Viewing recipients for ${notificationType.replace('_', ' ')} notifications`, 'info');
                
            } catch (error) {
                console.error('Error updating notification settings:', error);
                showNotification('Failed to update notification settings', 'error');
            }
        }        async function displayRecipientsForType(notificationType) {
            try {
                console.log(`displayRecipientsForType called with: ${notificationType}`);
                console.log('Current recipientsData:', recipientsData);
                
                const recipientsList = document.getElementById('recipientsList');
                
                // Get recipients for the selected notification type
                let recipients = [];
                if (notificationType === 'all') {
                    // Combine all recipients from all types
                    const allRecipients = [];
                    Object.values(recipientsData).forEach(typeRecipients => {
                        allRecipients.push(...typeRecipients);
                    });
                    // Remove duplicates based on email
                    recipients = allRecipients.filter((recipient, index, self) => 
                        index === self.findIndex(r => r.email === recipient.email)
                    );
                } else {
                    recipients = recipientsData[notificationType] || [];
                    console.log(`Found ${recipients.length} recipients for ${notificationType}`);
                }
                
                // Update summary
                updateRecipientSummary(recipients);
                
                // Display recipients
                if (recipients.length === 0) {
                    console.log(`No recipients found for ${notificationType}, showing empty state`);
                    recipientsList.innerHTML = `
                        <div class="no-recipients">
                            <i class="fas fa-users-slash"></i>
                            <p>No recipients configured for this notification type</p>
                            <small>Click "Add Recipient" to start adding email addresses</small>
                        </div>
                    `;
                    return;
                }
                
                console.log(`Displaying ${recipients.length} recipients`);
                recipientsList.innerHTML = recipients.map(recipient => `
                    <div class="recipient-item">
                        <div class="recipient-info">
                            <div class="recipient-name">${recipient.name}</div>
                            <div class="recipient-email">${recipient.email}</div>
                            <div class="recipient-meta">
                                <span class="recipient-role">${recipient.role || 'No role specified'}</span>
                                <span class="recipient-types">${recipient.notificationTypes ? recipient.notificationTypes.length : 0} types</span>
                            </div>
                        </div>
                        <div class="recipient-actions">
                            <button class="btn btn-edit btn-sm" onclick="editRecipient('${recipient.email}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-delete btn-sm" onclick="deleteRecipient('${recipient.email}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error displaying recipients:', error);
                document.getElementById('recipientsList').innerHTML = `
                    <div class="firebase-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load recipients</p>
                        <button class="btn btn-sm btn-secondary" onclick="displayRecipientsForType('${notificationType}')">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }        }

        // Test function to see if modal can be shown without all the complex logic
        function testShowModal() {
            console.log('testShowModal() called');
            const modal = document.getElementById('addRecipientModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('Test modal shown successfully');
            } else {
                console.error('Modal not found in testShowModal');
            }
        }

        function updateRecipientSummary(recipients) {
            const totalRecipients = recipients.length;
            const activeRecipients = recipients.filter(r => r.active !== false).length;
            
            document.getElementById('totalRecipients').textContent = totalRecipients;
            document.getElementById('activeRecipients').textContent = activeRecipients;
        }        function showAddRecipientModal() {
            console.log('showAddRecipientModal() called');
            const modal = document.getElementById('addRecipientModal');
            console.log('Modal element:', modal);
            
            if (!modal) {
                console.error('Modal element not found!');
                return;
            }
            
            // Reset form
            const recipientUser = document.getElementById('recipientUser');
            const recipientEmail = document.getElementById('recipientEmail');
            const notificationType = document.getElementById('notificationType');
            
            console.log('Form elements:', { recipientUser, recipientEmail, notificationType });
            
            if (recipientUser) recipientUser.value = '';
            if (recipientEmail) recipientEmail.value = '';
            
            // Set checkboxes based on current notification type
            const currentType = notificationType ? notificationType.value : 'access_request';
            console.log('Current notification type:', currentType);
            
            const checkboxes = {
                notifyAccessRequest: document.getElementById('notifyAccessRequest'),
                notifyApprovalReminder: document.getElementById('notifyApprovalReminder'),
                notifyRecruitmentInterview: document.getElementById('notifyRecruitmentInterview'),
                notifyStatusUpdate: document.getElementById('notifyStatusUpdate'),
                notifySystemAlert: document.getElementById('notifySystemAlert')
            };
            
            console.log('Checkboxes:', checkboxes);
            
            if (checkboxes.notifyAccessRequest) {
                checkboxes.notifyAccessRequest.checked = currentType === 'access_request' || currentType === 'all';
            }
            if (checkboxes.notifyApprovalReminder) {
                checkboxes.notifyApprovalReminder.checked = currentType === 'approval_reminder' || currentType === 'all';
            }
            if (checkboxes.notifyRecruitmentInterview) {
                checkboxes.notifyRecruitmentInterview.checked = currentType === 'recruitment_interview' || currentType === 'all';
            }
            if (checkboxes.notifyStatusUpdate) {
                checkboxes.notifyStatusUpdate.checked = currentType === 'status_update' || currentType === 'all';
            }
            if (checkboxes.notifySystemAlert) {
                checkboxes.notifySystemAlert.checked = currentType === 'system_alert' || currentType === 'all';
            }
            
            console.log('About to show modal');
            modal.style.display = 'flex';
            console.log('Modal display set to flex');
            
            // Load users into dropdown after showing the modal
            loadUsersForRecipient().catch(error => {
                console.error('Error loading users:', error);
                showNotification('Error loading users, but you can still manually enter an email', 'warning');
            });
        }        async function loadUsersForRecipient() {
            try {
                const userSelect = document.getElementById('recipientUser');
                
                // Get company-scoped path for users
                const usersPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('users') : 
                    'users';
                    
                const usersRef = database.ref(usersPath);
                const snapshot = await usersRef.once('value');
                
                // Get existing recipients to check for duplicates
                const existingRecipients = await getExistingRecipients();
                
                // Clear existing options except the first one
                userSelect.innerHTML = '<option value="">Select a user</option>';
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        const userId = childSnapshot.key;
                        
                        // Create display name
                        let displayName = 'Unknown User';
                        if (user.firstName && user.lastName) {
                            displayName = `${user.firstName} ${user.lastName}`;
                        } else if (user.displayName) {
                            displayName = user.displayName;
                        } else if (user.name) {
                            displayName = user.name;
                        } else if (user.email) {
                            displayName = user.email;
                        }
                        
                        // Check if this user is already a recipient
                        const isExistingRecipient = existingRecipients.some(recipient => 
                            recipient.userId === userId || recipient.email === user.email
                        );
                        
                        const option = document.createElement('option');
                        option.value = userId;
                        
                        // Add indicator if already a recipient
                        if (isExistingRecipient) {
                            option.textContent = `${displayName} (Already added)`;
                            option.style.color = '#999';
                            option.style.fontStyle = 'italic';
                            option.disabled = true;
                        } else {
                            option.textContent = displayName;
                        }
                        
                        option.dataset.email = user.email || '';
                        option.dataset.role = user.jobTitle || user.role || '';
                        option.dataset.department = user.department || '';
                        userSelect.appendChild(option);
                    });
                }
                
                // Add change event listener to populate email when user is selected
                userSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const emailField = document.getElementById('recipientEmail');
                    
                    if (selectedOption.value) {
                        emailField.value = selectedOption.dataset.email || '';
                    } else {
                        emailField.value = '';
                    }
                });
                
            } catch (error) {
                console.error('Error loading users for recipient:', error);
                showNotification('Failed to load users', 'error');
            }
        }

        // Helper function to get all existing recipients
        async function getExistingRecipients() {
            try {
                // Get company-scoped path for notification recipients
                const recipientsPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('notification-recipients') : 
                    'notification-recipients';
                    
                const allRecipientsRef = database.ref(recipientsPath);
                const snapshot = await allRecipientsRef.once('value');
                
                const existingRecipients = [];
                if (snapshot.exists()) {
                    const allTypes = snapshot.val();
                    for (const type in allTypes) {
                        const recipients = allTypes[type];
                        if (recipients) {
                            const recipientList = Array.isArray(recipients) ? recipients : Object.values(recipients);
                            recipientList.forEach(recipient => {
                                if (recipient && !existingRecipients.some(r => 
                                    r.userId === recipient.userId || r.email === recipient.email
                                )) {
                                    existingRecipients.push(recipient);
                                }
                            });
                        }
                    }
                }
                return existingRecipients;
            } catch (error) {
                console.error('Error getting existing recipients:', error);
                return [];
            }
        }function closeAddRecipientModal() {
            const modal = document.getElementById('addRecipientModal');
            const userSelect = document.getElementById('recipientUser');
            const emailField = document.getElementById('recipientEmail');
            const addButton = document.querySelector('#addRecipientModal .btn-primary');
            
            // Reset form
            userSelect.value = '';
            emailField.value = '';
            userSelect.disabled = false;
            emailField.disabled = false;
            
            // Reset checkboxes
            document.getElementById('notifyAccessRequest').checked = false;
            document.getElementById('notifyApprovalReminder').checked = false;
            document.getElementById('notifyRecruitmentInterview').checked = false;
            document.getElementById('notifyStatusUpdate').checked = false;
            document.getElementById('notifySystemAlert').checked = false;
            
            // Reset button
            addButton.innerHTML = '<i class="fas fa-plus"></i> Add Recipient';
            addButton.onclick = addRecipient;
            
            modal.style.display = 'none';        }async function addRecipient() {
            try {
                const userSelect = document.getElementById('recipientUser');
                const userId = userSelect.value;
                const email = document.getElementById('recipientEmail').value.trim();
                
                // Validation
                if (!userId || !email) {
                    showNotification('Please select a user', 'error');
                    return;
                }
                  // Get selected user data
                const selectedOption = userSelect.options[userSelect.selectedIndex];
                const name = selectedOption.textContent;
                const role = selectedOption.dataset.role || 'No role specified';
                
                if (!validateEmail(email)) {
                    showNotification('Selected user does not have a valid email address', 'error');
                    return;
                }
                
                // Check for duplicate email across all notification types
                const isDuplicate = await checkForDuplicateRecipient(email, userId);
                if (isDuplicate) {
                    showNotification(`${name} (${email}) is already added as a recipient`, 'warning');
                    return;
                }
                
                // Get selected notification types
                const notificationTypes = [];
                if (document.getElementById('notifyAccessRequest').checked) notificationTypes.push('access_request');
                if (document.getElementById('notifyApprovalReminder').checked) notificationTypes.push('approval_reminder');
                if (document.getElementById('notifyRecruitmentInterview').checked) notificationTypes.push('recruitment_interview');
                if (document.getElementById('notifyStatusUpdate').checked) notificationTypes.push('status_update');
                if (document.getElementById('notifySystemAlert').checked) notificationTypes.push('system_alert');
                
                if (notificationTypes.length === 0) {
                    showNotification('Please select at least one notification type', 'error');
                    return;
                }
                  // Create recipient object
                const recipient = {
                    userId,
                    name,
                    email,
                    role,
                    notificationTypes,
                    active: true,
                    addedDate: new Date().toISOString(),
                    addedBy: auth.currentUser?.uid || 'unknown'
                };
                
                // Update all selected notification types in Firebase
                const updates = {};
                
                // Get company-scoped path for notification recipients
                const recipientsPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('notification-recipients') : 
                    'notification-recipients';
                    
                notificationTypes.forEach(type => {
                    const typeRef = database.ref(`${recipientsPath}/${type}`);
                    const newRecipientRef = typeRef.push();
                    updates[`${recipientsPath}/${type}/${newRecipientRef.key}`] = recipient;
                });
                
                await database.ref().update(updates);
                
                // Close modal and update display
                closeAddRecipientModal();
                showNotification(`Successfully added ${name} as recipient for ${notificationTypes.length} notification type(s)`, 'success');
                
                // Refresh the current view
                const currentType = document.getElementById('notificationType').value;
                await displayRecipientsForType(currentType);
                
            } catch (error) {
                console.error('Error adding recipient:', error);
                showNotification('Failed to add recipient: ' + error.message, 'error');
            }
        }

        // New function to check for duplicate recipients
        async function checkForDuplicateRecipient(email, userId) {
            try {
                // Get company-scoped path for notification recipients
                const recipientsPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('notification-recipients') : 
                    'notification-recipients';
                    
                const allRecipientsRef = database.ref(recipientsPath);
                const snapshot = await allRecipientsRef.once('value');
                
                if (!snapshot.exists()) {
                    return false;
                }
                
                const allTypes = snapshot.val();
                for (const type in allTypes) {
                    const recipients = allTypes[type];
                    if (recipients) {
                        // Handle both array and object formats
                        const recipientList = Array.isArray(recipients) ? recipients : Object.values(recipients);
                        
                        // Check for duplicate by email or userId
                        const duplicate = recipientList.find(recipient => 
                            recipient && (
                                recipient.email === email || 
                                recipient.userId === userId
                            )
                        );
                        
                        if (duplicate) {
                            console.log(`Duplicate found in ${type}:`, duplicate);
                            return true;
                        }
                    }                }
                
                return false;
            } catch (error) {
                console.error('Error checking for duplicates:', error);
                // If we can't check for duplicates, allow the addition but log the error
                return false;
            }
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }async function editRecipient(email) {
            try {
                // Find recipient across all types
                let recipient = null;
                for (const type in recipientsData) {
                    recipient = recipientsData[type].find(r => r.email === email);
                    if (recipient) break;
                }
                
                if (!recipient) {
                    showNotification('Recipient not found', 'error');
                    return;
                }
                
                // Load users first
                await loadUsersForRecipient();
                
                // Populate modal with existing data
                const userSelect = document.getElementById('recipientUser');
                const emailField = document.getElementById('recipientEmail');
                
                // Try to find and select the user by userId first, then by email
                let userFound = false;
                if (recipient.userId) {
                    // Try to select by userId
                    for (let i = 0; i < userSelect.options.length; i++) {
                        if (userSelect.options[i].value === recipient.userId) {
                            userSelect.selectedIndex = i;
                            userFound = true;
                            break;
                        }
                    }
                }
                
                if (!userFound) {
                    // Try to select by email
                    for (let i = 0; i < userSelect.options.length; i++) {
                        if (userSelect.options[i].dataset.email === recipient.email) {
                            userSelect.selectedIndex = i;
                            userFound = true;
                            break;
                        }
                    }
                }
                
                // Set email field
                emailField.value = recipient.email;
                  // Set notification type checkboxes
                document.getElementById('notifyAccessRequest').checked = recipient.notificationTypes.includes('access_request');
                document.getElementById('notifyApprovalReminder').checked = recipient.notificationTypes.includes('approval_reminder');
                document.getElementById('notifyRecruitmentInterview').checked = recipient.notificationTypes.includes('recruitment_interview');
                document.getElementById('notifyStatusUpdate').checked = recipient.notificationTypes.includes('status_update');
                document.getElementById('notifySystemAlert').checked = recipient.notificationTypes.includes('system_alert');
                
                // Disable user selection (to prevent issues with identification)
                                userSelect.disabled = true;
                emailField.disabled = true;
                
                // Change button text
                const addButton = document.querySelector('#addRecipientModal .btn-primary');
                addButton.innerHTML = '<i class="fas fa-save"></i> Update Recipient';
                addButton.onclick = () => updateRecipient(email);
                
                // Show modal
                document.getElementById('addRecipientModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error editing recipient:', error);
                showNotification('Failed to edit recipient', 'error');
            }
        }

        async function updateRecipient(originalEmail) {
            try {
                const userSelect = document.getElementById('recipientUser');
                const selectedOption = userSelect.options[userSelect.selectedIndex];
                const email = document.getElementById('recipientEmail').value.trim();
                
                // Validation
                if (!selectedOption.value || !email) {
                    showNotification('Please select a user', 'error');
                    return;
                }
                  // Extract user data from selected option
                const userData = JSON.parse(selectedOption.dataset.userData);
                const name = userData.displayName || userData.name || `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.email;
                
                // Get selected notification types
                const notificationTypes = [];
                if (document.getElementById('notifyAccessRequest').checked) notificationTypes.push('access_request');
                if (document.getElementById('notifyApprovalReminder').checked) notificationTypes.push('approval_reminder');
                if (document.getElementById('notifyRecruitmentInterview').checked) notificationTypes.push('recruitment_interview');
                if (document.getElementById('notifyStatusUpdate').checked) notificationTypes.push('status_update');
                if (document.getElementById('notifySystemAlert').checked) notificationTypes.push('system_alert');
                
                if (notificationTypes.length === 0) {
                    showNotification('Please select at least one notification type', 'error');
                    return;
                }

                // Find recipient key in each notification type
                const updates = {};
                
                // Get company-scoped path for notification recipients
                const recipientsPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('notification-recipients') : 
                    'notification-recipients';
                    
                const recipientsRef = database.ref(recipientsPath);
                const snapshot = await recipientsRef.once('value');
                const allTypes = snapshot.val() || {};

                // Remove from all existing notification types
                Object.entries(allTypes).forEach(([type, recipients]) => {
                    if (recipients) {
                        Object.entries(recipients).forEach(([key, recipient]) => {
                            if (recipient.email === originalEmail) {
                                updates[`${recipientsPath}/${type}/${key}`] = null;
                            }
                        });
                    }
                });

                // Add to selected notification types
                const recipient = {
                    name,
                    email,
                    userId: userData.uid,
                    active: true,
                    updatedDate: new Date().toISOString(),
                    updatedBy: auth.currentUser?.uid || 'unknown'
                };

                notificationTypes.forEach(type => {
                    const newRef = database.ref(`${recipientsPath}/${type}`).push().key;
                    updates[`${recipientsPath}/${type}/${newRef}`] = recipient;
                });

                // Apply all updates atomically
                await database.ref().update(updates);
                
                // Reset modal and close it
                closeAddRecipientModal();                // Refresh display with updated data
                const currentType = document.getElementById('notificationType').value;
                await displayRecipientsForType(currentType);
                
                showNotification(`Successfully updated ${name}`, 'success');
                  } catch (error) {
                console.error('Error updating recipient:', error);
                showNotification('Failed to update recipient', 'error');
            }
        }

        async function deleteRecipient(email) {
            try {
                if (!confirm('Are you sure you want to remove this recipient from all notification types?')) {
                    return;
                }

                let recipientName = 'Unknown';
                const updates = {};
                
                // Get company-scoped path for notification recipients
                const recipientsPath = window.rolePermissionManager ? 
                    window.rolePermissionManager.getCompanyScopedPath('notification-recipients') : 
                    'notification-recipients';
                
                // Get all current recipients
                const recipientsRef = database.ref(recipientsPath);
                const snapshot = await recipientsRef.once('value');
                const allTypes = snapshot.val() || {};

                // Find recipient in all notification types and mark for deletion
                Object.entries(allTypes).forEach(([type, recipients]) => {
                    if (recipients) {
                        Object.entries(recipients).forEach(([key, recipient]) => {
                            if (recipient.email === email) {
                                recipientName = recipient.name;
                                updates[`${recipientsPath}/${type}/${key}`] = null;
                            }
                        });
                    }
                });

                // Delete all entries atomically
                await database.ref().update(updates);                // Refresh display
                const currentType = document.getElementById('notificationType').value;
                await displayRecipientsForType(currentType);
                
                showNotification(`Successfully removed ${recipientName}`, 'success');
                
            } catch (error) {
                console.error('Error deleting recipient:', error);
                showNotification('Failed to delete recipient', 'error');
            }
        }        function importRecipients() {
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.txt';
            input.onchange = handleImportFile;
            input.click();
        }

        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.csv') && !file.name.toLowerCase().endsWith('.txt')) {
                showNotification('Please select a .csv or .txt file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const content = e.target.result;
                    if (!content.trim()) {
                        showNotification('The file appears to be empty', 'error');
                        return;
                    }
                    const lines = content.split('\n').filter(line => line.trim());
                    
                    let imported = 0;
                    let skipped = 0;
                    const currentType = document.getElementById('notificationType').value;
                    const updates = {};
                    
                    // First pass: Check all emails for duplicates
                    const emailsToImport = new Set();
                    const duplicateEmails = new Set();
                    
                    // Get company-scoped path for notification recipients
                    const recipientsPath = window.rolePermissionManager ? 
                        window.rolePermissionManager.getCompanyScopedPath('notification-recipients') : 
                        'notification-recipients';
                        
                    const recipientsRef = database.ref(recipientsPath);
                    const snapshot = await recipientsRef.once('value');
                    const allTypes = snapshot.val() || {};
                    
                    // Check for existing emails in Firebase
                    Object.values(allTypes).forEach(recipients => {
                        if (recipients) {
                            Object.values(recipients).forEach(recipient => {
                                if (recipient.email) {
                                    duplicateEmails.add(recipient.email.toLowerCase());
                                }
                            });
                        }
                    });
                      // Process CSV lines
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i];
                        const parts = line.split(',').map(p => p.trim());
                        
                        // Skip header row if it exists
                        if (i === 0 && parts[0].toLowerCase() === 'name' && parts[1].toLowerCase() === 'email') {
                            continue;
                        }
                        
                        if (parts.length < 2) {
                            console.warn(`Line ${i + 1} skipped: Insufficient columns`);
                            continue;
                        }
                        
                        const [name, email, role = '', department = '', notificationTypesStr = ''] = parts;
                        
                        // Enhanced validation
                        if (!name.trim()) {
                            console.warn(`Line ${i + 1} skipped: Name is required`);
                            skipped++;
                            continue;
                        }                        
                        if (validateEmail(email)) {
                            const lowerEmail = email.toLowerCase();
                            
                            if (duplicateEmails.has(lowerEmail)) {
                                skipped++;
                                continue;
                            }
                            
                            // Parse notification types
                            const notificationTypes = notificationTypesStr
                                ? notificationTypesStr.split(';').map(t => t.trim())
                                : currentType === 'all' 
                                    ? ['access_request', 'approval_reminder', 'recruitment_interview', 'status_update', 'system_alert']
                                    : [currentType];
                            
                            // Create recipient object
                            const recipient = {
                                name,
                                email,
                                role: role || 'Imported User',
                                department: department || 'other',
                                notificationTypes,
                                active: true,
                                addedDate: new Date().toISOString(),
                                addedBy: auth.currentUser?.uid || 'unknown'
                            };
                            
                            // Add updates for each notification type
                            notificationTypes.forEach(type => {                                if (['access_request', 'approval_reminder', 'recruitment_interview', 'status_update', 'system_alert'].includes(type)) {
                                    const newKey = database.ref().push().key;
                                    updates[`${recipientsPath}/${type}/${newKey}`] = recipient;
                                }
                            });
                            
                            duplicateEmails.add(lowerEmail);
                            imported++;
                        } else {
                            console.warn(`Line ${i + 1} skipped: Invalid email format`);
                            skipped++;
                        }
                    }
                      // Apply all updates atomically if there are any
                    if (Object.keys(updates).length > 0) {
                        await database.ref().update(updates);
                    }
                    
                    await displayRecipientsForType(currentType);
                    
                    if (imported > 0) {
                        showNotification(
                            `Successfully imported ${imported} recipients` + 
                            (skipped > 0 ? ` (${skipped} duplicates skipped)` : ''),
                            'success'
                        );                    } else {
                        showNotification(
                            'No new recipients imported' +
                            (skipped > 0 ? ` (${skipped} duplicates skipped)` : ''),
                            'warning'
                        );
                    }
                } catch (error) {
                    console.error('Error importing file:', error);
                    showNotification('Failed to import file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
            
            // Show a loading notification
            showNotification('Processing import file...', 'info');
        }        async function initializeRecipientsManagement() {
            try {
                console.log('Initializing recipients management...');
                
                // Wait a bit for Firebase to be ready
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Load initial data with default filters
                const defaultType = document.getElementById('notificationType')?.value || 'access_request';
                await displayRecipientsForType(defaultType);
                
                // Close modal when clicking outside
                window.onclick = function(event) {
                    const modal = document.getElementById('addRecipientModal');
                    if (event.target === modal) {
                        closeAddRecipientModal();
                    }
                };
                
                console.log('Recipients management initialized successfully');
                
            } catch (error) {
                console.error('Error initializing recipients management:', error);
            }
        }

        // Initialize the page with the default template
        function initializeEmailTemplates() {
            loadTemplate(); // Load the default template (approval-notification)
        }
          // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeEmailTemplates();
            initializeFirebaseRecipients();
            initializeRecipientsManagement();
            
            // Add event listener for notification type dropdown
            const notificationTypeDropdown = document.getElementById('notificationType');
            if (notificationTypeDropdown) {
                notificationTypeDropdown.addEventListener('change', function() {
                    console.log('Notification type changed to:', this.value);
                    updateNotificationSettings();
                });
            }
        });
    </script>    <script type="text/javascript">
            // Initialize EmailNotificationService and Firebase Real-time Tracking
            let emailService;
            let firebaseListener = null;
            let currentDataSource = 'firebase'; // 'firebase' or 'memory'

            document.addEventListener('DOMContentLoaded', async () => {
                // Check Firebase and authentication status
                checkFirebaseStatus();
                
                // Check and fix icon loading
                checkIconLoading();
                
                // Initialize EmailJS
                initializeEmailJS();
                
                // Initialize email service
                emailService = new EmailNotificationService();
                
                // Wait a bit for DOM to be fully ready
                setTimeout(async () => {
                    try {
                        // Load EmailJS configuration
                        await loadEmailJSConfig();
                        console.log('✅ EmailJS configuration loaded');
                    } catch (error) {
                        console.error('❌ Error loading EmailJS config on startup:', error);
                    }
                }, 1000);
                
                // Initialize real-time Firebase tracking
                await initializeFirebaseTracking();
                
                // Start automatic updates
                updateEmailStatistics();
                setInterval(updateEmailStatistics, 60000); // Update every minute
                
                // Initialize tracking view if it's the active tab
                if (document.getElementById('email-tracking').classList.contains('active')) {
                    refreshNotificationHistory();
                }
                
                // Load EmailJS stats
                updateEmailJSStats();
            });

            /**
             * Check Firebase status and authentication
             */
            function checkFirebaseStatus() {
                console.log('🔥 Firebase Status Check:');
                
                // Check Firebase version
                if (typeof firebase !== 'undefined') {
                    console.log('✅ Firebase SDK loaded successfully');
                    console.log('📦 Firebase version:', firebase.SDK_VERSION || 'Unknown');
                    
                    // Check specific Firebase services
                    if (firebase.auth) {
                        console.log('✅ Firebase Auth available');
                        
                        // Check current user
                        const currentUser = firebase.auth().currentUser;
                        if (currentUser) {
                            console.log('✅ User already authenticated:', {
                                uid: currentUser.uid,
                                email: currentUser.email,
                                displayName: currentUser.displayName
                            });
                        } else {
                            console.log('⚠️ No authenticated user found');
                        }
                    } else {
                        console.error('❌ Firebase Auth not available');
                    }
                    
                    if (firebase.database) {
                        console.log('✅ Firebase Database available');
                    } else {
                        console.error('❌ Firebase Database not available');
                    }
                    
                    if (firebase.storage) {
                        console.log('✅ Firebase Storage available');
                    } else {
                        console.warn('⚠️ Firebase Storage not available');
                    }
                    
                } else {
                    console.error('❌ Firebase SDK not loaded');
                }
                
                // Check localStorage data
                const isAuthenticated = localStorage.getItem('isAuthenticated');
                const userName = localStorage.getItem('userName');
                const userEmail = localStorage.getItem('userEmail');
                
                console.log('💾 LocalStorage data:', {
                    isAuthenticated,
                    userName,
                    userEmail
                });
            }

            /**
             * Check if Font Awesome icons are loading properly
             */
            function checkIconLoading() {
                setTimeout(() => {
                    const testIcon = document.createElement('i');
                    testIcon.className = 'fas fa-home';
                    testIcon.style.position = 'absolute';
                    testIcon.style.left = '-9999px';
                    document.body.appendChild(testIcon);
                    
                    const computedStyle = window.getComputedStyle(testIcon, ':before');
                    const content = computedStyle.getPropertyValue('content');
                    
                    // If icons aren't loading properly, add fallback
                    if (!content || content === 'none' || content === '""') {
                        console.warn('Font Awesome icons not loading properly, applying fallback');
                        addIconFallback();
                    }
                    
                    document.body.removeChild(testIcon);
                }, 100);
            }

            /**
             * Add fallback styling for icons if Font Awesome fails to load
             */
            function addIconFallback() {
                const style = document.createElement('style');
                style.textContent = `
                    .fa, .fas, .far, .fab, [class^="fa-"], [class*=" fa-"] {
                        font-family: Arial, sans-serif !important;
                        font-weight: bold !important;
                        display: inline-block !important;
                        width: 1em !important;
                        text-align: center !important;
                    }
                    .fa-home:before { content: "🏠" !important; }
                    .fa-bell:before { content: "🔔" !important; }
                    .fa-user:before { content: "👤" !important; }
                    .fa-envelope:before { content: "✉️" !important; }
                    .fa-cog:before { content: "⚙️" !important; }
                    .fa-bars:before { content: "☰" !important; }
                    .fa-search:before { content: "🔍" !important; }
                    .fa-plus:before { content: "➕" !important; }
                    .fa-edit:before { content: "✏️" !important; }
                    .fa-trash:before { content: "🗑️" !important; }
                    .fa-check:before { content: "✓" !important; }
                    .fa-times:before { content: "✕" !important; }
                    .fa-server:before { content: "🖥️" !important; }
                    .fa-file-alt:before { content: "📄" !important; }
                    .fa-users:before { content: "👥" !important; }
                    .fa-history:before { content: "🕒" !important; }
                    .fa-sign-out-alt:before { content: "🚪" !important; }
                `;
                document.head.appendChild(style);
            }            /**
             * Initialize Firebase real-time listeners for email tracking
             */
            async function initializeFirebaseTracking() {
                try {
                    // Wait for Firebase to be available with timeout
                    let attempts = 0;
                    const maxAttempts = 50; // 5 seconds timeout
                    
                    while (!window.firebaseRT && attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (!window.firebaseRT) {
                        throw new Error('Firebase RT modules not available after timeout');
                    }

                    const { ref, onValue, query, orderByChild, limitToLast } = window.firebaseRT;
                    const db = window.firebaseRT.db;

                    if (!db) {
                        throw new Error('Firebase database not initialized');
                    }

                    // Create real-time listener for email tracking
                    const trackingRef = query(
                        ref(db, 'email-tracking'),
                        orderByChild('timestamp'),
                        limitToLast(100) // Get last 100 entries
                    );

                    // Set up real-time listener
                    firebaseListener = onValue(trackingRef, (snapshot) => {
                        if (currentDataSource === 'firebase') {
                            handleFirebaseTrackingUpdate(snapshot);
                        }
                    }, (error) => {
                        console.error('Firebase listener error:', error);
                        updateRealtimeStatus(false, 'Connection Error');
                    });

                    updateRealtimeStatus(true, 'Connected');
                    console.log('Firebase real-time tracking initialized successfully');
                } catch (error) {
                    console.error('Error initializing Firebase tracking:', error);
                    updateRealtimeStatus(false, `Initialization Failed: ${error.message}`);
                }
            }

            /**
             * Handle Firebase tracking data updates
             */
            function handleFirebaseTrackingUpdate(snapshot) {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Convert Firebase data to array format
                    const trackingArray = Object.keys(data).map(key => ({
                        id: key,
                        ...data[key],
                        timestamp: data[key].timestamp || new Date().toISOString()
                    }));
                    
                    // Sort by timestamp (newest first)
                    trackingArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Update the display if email tracking tab is active
                    if (document.getElementById('email-tracking').classList.contains('active') && 
                        currentDataSource === 'firebase') {
                        displayTrackingData(trackingArray);
                    }
                    
                    // Update statistics
                    updateEmailStatisticsFromFirebase(trackingArray);
                }
            }

            /**
             * Update real-time connection status
             */
            function updateRealtimeStatus(connected, message = '') {
                const statusElement = document.getElementById('realtime-status');
                if (statusElement) {
                    const statusClass = connected ? 'status-success' : 'status-error';
                    const icon = connected ? 'fas fa-wifi' : 'fas fa-wifi-slash';
                    const text = connected ? 'Real-time Connected' : `Disconnected: ${message}`;
                    
                    statusElement.innerHTML = `
                        <span class="status-indicator ${statusClass}">
                            <i class="${icon}"></i> ${text}
                        </span>
                    `;
                }
            }

            /**
             * Switch between Firebase and memory data sources
             */
            function switchDataSource() {
                const dataSource = document.getElementById('data-source').value;
                currentDataSource = dataSource;
                
                if (dataSource === 'firebase') {
                    updateRealtimeStatus(true, 'Switched to Firebase');
                } else {
                    updateRealtimeStatus(false, 'Using Memory Cache');
                }
                
                refreshNotificationHistory();
            }

            /**
             * Display tracking data in the table
             */
            function displayTrackingData(trackingData) {
                // Apply current filters
                const statusFilter = document.getElementById('filter-status').value;
                const hourFilter = parseInt(document.getElementById('filter-date').value);
                
                // Apply time filter
                const cutoffTime = new Date();
                cutoffTime.setHours(cutoffTime.getHours() - hourFilter);
                
                const filteredData = trackingData.filter(item => {
                    const itemDate = new Date(item.timestamp);
                    const matchesTime = itemDate >= cutoffTime;
                    const matchesStatus = statusFilter === 'all' || 
                                        (statusFilter === 'success' && item.success) ||
                                        (statusFilter === 'failed' && !item.success);
                    
                    return matchesTime && matchesStatus;
                });
                
                // Update table
                const tbody = document.getElementById('notification-history-body');
                tbody.innerHTML = filteredData.map(item => `
                    <tr class="${item.success ? 'success' : 'failed'}" data-id="${item.id || ''}">
                        <td>
                            ${formatDate(item.timestamp)}
                            <div class="data-source-badge">
                                <i class="fas fa-database"></i> ${currentDataSource === 'firebase' ? 'Firebase' : 'Memory'}
                            </div>
                        </td>
                        <td>${item.recipient || 'N/A'}</td>
                        <td>${item.subject || 'N/A'}</td>
                        <td>
                            <span class="status-badge ${item.success ? 'success' : 'error'}">
                                ${item.success ? 'Delivered' : 'Failed'}
                            </span>
                            ${item.error ? `<div class="error-message">${item.error}</div>` : ''}
                        </td>
                        <td>${item.messageId || 'N/A'}</td>
                    </tr>
                `).join('');
                
                // Add real-time update indicator
                const now = new Date().toLocaleTimeString();
                const updateIndicator = document.querySelector('.last-update') || createUpdateIndicator();
                updateIndicator.textContent = `Last updated: ${now}`;
            }

            /**
             * Create update indicator element
             */
            function createUpdateIndicator() {
                const indicator = document.createElement('div');
                indicator.className = 'last-update';
                indicator.style.cssText = 'text-align: center; padding: 10px; color: #666; font-size: 0.9em;';
                
                const historyDiv = document.getElementById('notification-history');
                historyDiv.appendChild(indicator);
                
                return indicator;
            }

            /**
             * Update email statistics from Firebase data
             */
            function updateEmailStatisticsFromFirebase(trackingData) {
                try {
                    // Calculate statistics from the last 24 hours
                    const last24Hours = new Date();
                    last24Hours.setHours(last24Hours.getHours() - 24);
                    
                    const recent = trackingData.filter(item => 
                        new Date(item.timestamp) >= last24Hours
                    );
                    
                    const totalSent = recent.length;
                    const successful = recent.filter(item => item.success).length;
                    const failed = recent.filter(item => !item.success).length;
                    const successRate = totalSent > 0 ? Math.round((successful / totalSent) * 100) : 0;
                    
                    // Update statistics display
                    updateStatElement('daily-volume', totalSent, 'emails sent');
                    updateStatElement('success-rate', `${successRate}%`, 'delivery rate');
                    updateStatElement('failed-deliveries', failed, 'failed deliveries');
                    
                } catch (error) {
                    console.error('Error updating email statistics from Firebase:', error);
                }
            }

            /**
             * Update individual statistic element
             */
            function updateStatElement(elementId, value, label) {
                const element = document.getElementById(elementId);
                if (element) {
                    const statValue = element.querySelector('.stat-value');
                    if (statValue) {
                        statValue.textContent = `${value} ${label}`;
                    }
                }
            }

            async function updateEmailStatistics() {
                try {
                    if (currentDataSource === 'firebase') {
                        // Statistics will be updated by Firebase listener
                        return;
                    }
                    
                    // Use memory data for statistics
                    const stats = emailService.getDeliveryStats();
                    const history = emailService.getNotificationHistory();
                    
                    // Calculate recent statistics (last 24 hours)
                    const last24Hours = new Date();
                    last24Hours.setHours(last24Hours.getHours() - 24);
                    
                    const recentHistory = history.filter(item => 
                        new Date(item.timestamp) >= last24Hours
                    );
                    
                    const recentTotal = recentHistory.length;
                    const recentSuccessful = recentHistory.filter(item => item.success).length;
                    const recentFailed = recentHistory.filter(item => !item.success).length;
                    const recentSuccessRate = recentTotal > 0 ? Math.round((recentSuccessful / recentTotal) * 100) : 0;
                    
                    // Update display
                    updateStatElement('daily-volume', recentTotal, 'emails sent');
                    updateStatElement('success-rate', `${recentSuccessRate}%`, 'delivery rate');
                    updateStatElement('failed-deliveries', recentFailed, 'failed deliveries');
                    
                } catch (error) {
                    console.error('Error updating email statistics:', error);
                }
            }

            // Cleanup function when page unloads
            window.addEventListener('beforeunload', () => {
                if (firebaseListener) {
                    firebaseListener(); // Detach Firebase listener
                }
            });
    </script>
    <script>
            async function refreshNotificationHistory() {
                try {
                    // Get filter values
                    const statusFilter = document.getElementById('filter-status').value;
                    const hourFilter = parseInt(document.getElementById('filter-date').value);
                    
                    // Get notification history
                    let history = emailService.getNotificationHistory();
                    
                    // Apply filters
                    const cutoffTime = new Date();
                    cutoffTime.setHours(cutoffTime.getHours() - hourFilter);
                    
                    history = history.filter(item => {
                        const itemDate = new Date(item.timestamp);
                        return itemDate >= cutoffTime && 
                               (statusFilter === 'all' || 
                                (statusFilter === 'success' && item.success) ||
                                (statusFilter === 'failed' && !item.success));
                    });
                    
                    // Update table
                    const tbody = document.getElementById('notification-history-body');
                    tbody.innerHTML = history.map(item => `
                        <tr class="${item.success ? 'success' : 'failed'}">
                            <td>${formatDate(item.timestamp)}</td>
                            <td>${item.recipient}</td>
                            <td>${item.subject || 'N/A'}</td>
                            <td>
                                <span class="status-badge ${item.success ? 'success' : 'error'}">
                                    ${item.success ? 'Delivered' : 'Failed'}
                                </span>
                                ${item.error ? `<div class="error-message">${item.error}</div>` : ''}
                            </td>
                            <td>${item.messageId || 'N/A'}</td>
                        </tr>
                    `).join('');
                } catch (error) {
                    console.error('Error refreshing notification history:', error);
                }
            }

            function formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                
                if (diff < 60000) { // Less than 1 minute
                    return 'Just now';
                } else if (diff < 3600000) { // Less than 1 hour
                    const minutes = Math.floor(diff / 60000);
                    return `${minutes}m ago`;
                } else if (diff < 86400000) { // Less than 24 hours
                    const hours = Math.floor(diff / 3600000);
                    return `${hours}h ago`;
                } else {
                    return date.toLocaleString();
                }
            }            function filterNotificationHistory() {
                refreshNotificationHistory();
            }

            // Recruitment notification function
            async function sendRecruitmentApprovalNotification(jobId, recruitmentData) {
                try {
                    console.log('Sending recruitment approval notification for job:', jobId);
                    
                    // Fetch approvers from approval flows
                    const approvers = await fetchRecruitmentApprovers();
                    if (!approvers || approvers.length === 0) {
                        console.warn('No approvers found for recruitment notifications');
                        return;
                    }
                    
                    // Fetch applicants for the job
                    const applicants = await fetchJobApplicants(jobId);
                    
                    // Format applicant list for email template
                    const applicantsList = formatApplicantsList(applicants);
                    
                    // Calculate applicant statistics
                    const stats = calculateApplicantStats(applicants);
                    
                    // Prepare template data
                    const templateData = {
                        jobPosition: recruitmentData.position || 'Unknown Position',
                        department: recruitmentData.department || 'Unknown Department',
                        employmentType: recruitmentData.employmentType || 'Full-time',
                        workLocation: recruitmentData.location || 'Office',
                        startDate: recruitmentData.startDate || 'TBD',
                        priority: recruitmentData.priority || 'Normal',
                        referenceNumber: recruitmentData.referenceNumber || `REC-${Date.now()}`,
                        approvedBy: recruitmentData.approvedBy || 'System',
                        approvalDate: new Date().toLocaleDateString(),
                        totalApplicants: stats.total,
                        applicationsUnderReview: stats.underReview,
                        applicationsShortlisted: stats.shortlisted,
                        applicationsRejected: stats.rejected,
                        applicantsList: applicantsList,
                        salaryMin: recruitmentData.salaryMin || 'Not specified',
                        salaryMax: recruitmentData.salaryMax || 'Not specified',
                        workingHours: recruitmentData.workingHours || '40',
                        jobDescription: recruitmentData.description || 'Job description not available',
                        requiredEducation: recruitmentData.education || 'As per company requirements',
                        requiredExperience: recruitmentData.experience || 'As per job posting',
                        requiredSkills: recruitmentData.skills || 'As per job posting',
                        recruitmentSystemLink: `${window.location.origin}/recruitboard.html?job=${jobId}`,
                        hrEmail: 'hr@dreamexdatalab.com',
                        recruitmentManagerEmail: 'recruitment@dreamexdatalab.com',
                        supervisorEmail: recruitmentData.supervisorEmail || 'supervisor@dreamexdatalab.com'
                    };
                    
                    // Send notification to each approver
                    const notificationPromises = approvers.map(approver => 
                        sendRecruitmentNotificationToApprover(approver, templateData)
                    );
                    
                    const results = await Promise.allSettled(notificationPromises);
                    
                    // Log results
                    const successful = results.filter(r => r.status === 'fulfilled').length;
                    const failed = results.filter(r => r.status === 'rejected').length;
                    
                    console.log(`Recruitment notifications sent: ${successful} successful, ${failed} failed`);
                    
                    if (failed > 0) {
                        console.warn('Some recruitment notifications failed to send:', 
                            results.filter(r => r.status === 'rejected').map(r => r.reason)
                        );
                    }
                    
                    return { successful, failed, total: approvers.length };
                    
                } catch (error) {
                    console.error('Error sending recruitment approval notifications:', error);
                    throw error;
                }
            }
              // Fetch recruitment approvers from Firebase
            async function fetchRecruitmentApprovers() {
                try {
                    if (!window.firebaseRT || !window.firebaseRT.db) {
                        console.warn('Firebase not available, using fallback approvers');
                        return [
                            { email: 'hr.manager@dreamexdatalab.com', name: 'HR Manager', role: 'hr-manager' },
                            { email: 'dept.head@dreamexdatalab.com', name: 'Department Head', role: 'department-head' }
                        ];
                    }
                    
                    const { ref, get } = window.firebaseRT;
                    const approvalFlowRef = ref(window.firebaseRT.db, 'approvalFlows/recruitment');
                    
                    const snapshot = await get(approvalFlowRef);
                    const flowData = snapshot.val();
                    
                    if (flowData && flowData.approvers) {
                        console.log('Fetched recruitment approvers:', flowData.approvers);
                        return flowData.approvers;
                    } else {
                        console.log('No approvers found in approval flow, using defaults');
                        return [
                            { email: 'hr.manager@dreamexdatalab.com', name: 'HR Manager', role: 'hr-manager' }
                        ];
                    }
                } catch (error) {
                    console.error('Error fetching recruitment approvers:', error);
                    // Return fallback approvers
                    return [
                        { email: 'hr.manager@dreamexdatalab.com', name: 'HR Manager', role: 'hr-manager' }
                    ];
                }
            }            // Fetch job applicants from Firebase archives
            async function fetchJobApplicants(jobId) {
                try {
                    // First try to get data from Firebase archives
                    console.log(`Fetching applicants from Firebase archives for job ${jobId}`);
                    
                    // Get company-scoped path for archives
                    const archivesPath = window.rolePermissionManager ? 
                        window.rolePermissionManager.getCompanyScopedPath('archives') : 
                        'archives';
                    
                    // Use the direct Firebase database reference
                    const archivesRef = database.ref(archivesPath);
                    
                    const snapshot = await archivesRef.once('value');
                    const archivesData = snapshot.val();
                    
                    if (archivesData) {
                        console.log('Archives data found:', archivesData);
                        
                        // Look for job applications in archives
                        const applicantsList = [];
                        
                        // Search through all archived data for the specific job and its applications
                        Object.keys(archivesData).forEach(archiveKey => {
                            const archiveItem = archivesData[archiveKey];
                            
                            // Check if this archive item matches our job ID or contains applications
                            if (archiveItem && (archiveKey === jobId || archiveItem.jobId === jobId)) {
                                console.log(`Found job archive: ${archiveKey}`, archiveItem);
                                
                                // Check if this archive has applications
                                if (archiveItem.applications) {
                                    Object.keys(archiveItem.applications).forEach(appKey => {
                                        const application = archiveItem.applications[appKey];
                                        console.log(`Processing application: ${appKey}`, application);
                                        
                                        // Extract detailed applicant information
                                        const applicant = {
                                            id: appKey,
                                            applicationId: appKey,
                                            name: `${application.firstName || ''} ${application.lastName || ''}`.trim(),
                                            firstName: application.firstName || 'N/A',
                                            lastName: application.lastName || 'N/A',
                                            email: application.email || 'N/A',
                                            phone: application.phone || 'N/A',
                                            address: application.address || 'N/A',
                                            status: application.status || 'pending',
                                            appliedDate: application.applicationDate || new Date().toISOString(),
                                            jobId: application.jobId || jobId,
                                            jobTitle: application.jobTitle || 'N/A',
                                            department: application.department || 'N/A',
                                            currentCompany: application.currentCompany || 'N/A',
                                            currentPosition: application.currentPosition || 'N/A',
                                            yearsExperience: application.yearsExperience || 'N/A',
                                            expectedSalary: application.expectedSalary || 'N/A',
                                            availabilityDate: application.availabilityDate || 'N/A',
                                            noticePeriod: application.noticePeriod || 'N/A',
                                            whyInterested: application.whyInterested || 'N/A',
                                            additionalInfo: application.additionalInfo || 'N/A',
                                            files: application.files || {},
                                            resume: application.files?.resume?.name || 'Not provided',
                                            browserInfo: application.browserInfo || 'N/A',
                                            applicantIP: application.applicantIP || 'N/A',
                                            dataConsent: application.dataConsent === 'on' ? 'Yes' : 'No',
                                            marketingConsent: application.marketingConsent === 'on' ? 'Yes' : 'No',
                                            termsAccept: application.termsAccept === 'on' ? 'Yes' : 'No'
                                        };
                                        applicantsList.push(applicant);
                                    });
                                }
                            }
                            
                            // Also check if the archive item itself is an application
                            if (archiveItem && (
                                archiveItem.jobId === jobId || 
                                archiveItem.jobPosition || 
                                archiveItem.applicantName ||
                                archiveItem.firstName ||
                                archiveItem.email
                            )) {
                                // Extract applicant information from archive
                                const applicant = {
                                    id: archiveKey,
                                    name: archiveItem.firstName && archiveItem.lastName 
                                        ? `${archiveItem.firstName} ${archiveItem.lastName}`.trim()
                                        : archiveItem.applicantName || archiveItem.name || archiveItem.fullName || 'Unknown Applicant',
                                    firstName: archiveItem.firstName || 'N/A',
                                    lastName: archiveItem.lastName || 'N/A',
                                    email: archiveItem.email || archiveItem.applicantEmail || 'N/A',
                                    phone: archiveItem.phone || archiveItem.phoneNumber || 'N/A',
                                    address: archiveItem.address || 'N/A',
                                    status: archiveItem.status || archiveItem.applicationStatus || 'archived',
                                    appliedDate: archiveItem.appliedDate || archiveItem.applicationDate || archiveItem.submittedDate || archiveItem.createdAt || new Date().toISOString(),
                                    jobTitle: archiveItem.jobTitle || archiveItem.jobPosition || archiveItem.position || 'N/A',
                                    department: archiveItem.department || 'N/A',
                                    currentCompany: archiveItem.currentCompany || 'N/A',
                                    currentPosition: archiveItem.currentPosition || 'N/A',
                                    yearsExperience: archiveItem.yearsExperience || archiveItem.experience || archiveItem.workExperience || 'N/A',
                                    expectedSalary: archiveItem.expectedSalary || 'N/A',
                                    availabilityDate: archiveItem.availabilityDate || 'N/A',
                                    noticePeriod: archiveItem.noticePeriod || 'N/A',
                                    whyInterested: archiveItem.whyInterested || 'N/A',
                                    additionalInfo: archiveItem.additionalInfo || 'N/A',
                                    files: archiveItem.files || {},
                                    resume: archiveItem.files?.resume?.name || archiveItem.resume || archiveItem.resumeUrl || 'Not provided',
                                    browserInfo: archiveItem.browserInfo || 'N/A',
                                    applicantIP: archiveItem.applicantIP || 'N/A',
                                    dataConsent: archiveItem.dataConsent === 'on' ? 'Yes' : 'No',
                                    marketingConsent: archiveItem.marketingConsent === 'on' ? 'Yes' : 'No',
                                    termsAccept: archiveItem.termsAccept === 'on' ? 'Yes' : 'No'
                                };
                                
                                // Avoid duplicates
                                const exists = applicantsList.find(app => 
                                    app.email === applicant.email || 
                                    app.id === applicant.id ||
                                    (app.firstName === applicant.firstName && app.lastName === applicant.lastName)
                                );
                                
                                if (!exists) {
                                    applicantsList.push(applicant);
                                }
                            }
                        });
                        
                        console.log(`Found ${applicantsList.length} applicants in archives`);
                        return applicantsList;
                        
                    } else {
                        console.log('No archives data found');
                        
                        // Fallback to mock data if archives are empty
                        return [
                            {
                                id: 'archive_mock_1',
                                name: 'Sample Applicant',
                                firstName: 'Sample',
                                lastName: 'Applicant',
                                email: 'sample@email.com',
                                phone: '+1234567890',
                                address: 'Sample Address',
                                status: 'archived',
                                appliedDate: new Date().toISOString(),
                                jobTitle: 'Sample Position',
                                department: 'Various',
                                currentCompany: 'Previous Company',
                                currentPosition: 'Previous Role',
                                yearsExperience: '2-3',
                                expectedSalary: '50000',
                                availabilityDate: '2025-07-01',
                                noticePeriod: '2-weeks',
                                whyInterested: 'Sample reason',
                                additionalInfo: 'Sample info',
                                resume: 'sample_resume.pdf',
                                dataConsent: 'Yes',
                                marketingConsent: 'No',
                                termsAccept: 'Yes'
                            }
                        ];
                    }
                } catch (error) {
                    console.error('Error fetching applicants from archives:', error);
                    
                    // Fallback to mock data on error
                    return [
                        {
                            id: 'error_fallback',
                            name: 'Error Loading from Archives',
                            firstName: 'Error',
                            lastName: 'Loading',
                            email: 'error@example.com',
                            phone: 'N/A',
                            address: 'N/A',
                            status: 'error',
                            appliedDate: new Date().toISOString(),
                            jobTitle: 'N/A',
                            department: 'N/A',
                            currentCompany: 'N/A',
                            currentPosition: 'N/A',
                            yearsExperience: 'N/A',
                            expectedSalary: 'N/A',
                            availabilityDate: 'N/A',
                            noticePeriod: 'N/A',
                            whyInterested: 'Unable to load from archives',
                            additionalInfo: 'Error occurred',
                            resume: 'N/A',
                            dataConsent: 'N/A',
                            marketingConsent: 'N/A',
                            termsAccept: 'N/A'
                        }
                    ];
                }
            }            // Format applicants list for email template
            function formatApplicantsList(applicants) {
                if (!applicants || applicants.length === 0) {
                    return 'No applications were received for this position.';
                }
                
                return applicants.map((applicant, index) => {
                    const statusIcon = {
                        'pending': '⏳',
                        'shortlisted': '✅',
                        'rejected': '❌',
                        'interviewed': '🎤',
                        'hired': '🎉',
                        'archived': '📁',
                        'error': '⚠️',
                        'selected': '⭐',
                        'withdrawn': '🚫',
                        'declined': '👎'
                    }[applicant.status] || '📋';
                    
                    // Ensure we have a name to display
                    const applicantName = applicant.name || `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim() || `Applicant #${index + 1}`;
                    const applicationDate = applicant.appliedDate ? new Date(applicant.appliedDate).toLocaleDateString() : 'Unknown';
                    const availabilityDate = applicant.availabilityDate ? new Date(applicant.availabilityDate).toLocaleDateString() : 'N/A';
                    
                    return `${index + 1}. ${applicantName}
================================================================================
PERSONAL INFORMATION:
--------------------------------------------------------------------------------
📧 Email Address        : ${applicant.email || 'N/A'}
📞 Phone Number         : ${applicant.phone || 'N/A'}
🏠 Address             : ${applicant.address || 'N/A'}
� First Name          : ${applicant.firstName || 'N/A'}
👤 Last Name           : ${applicant.lastName || 'N/A'}

APPLICATION DETAILS:
--------------------------------------------------------------------------------
💼 Applied Position     : ${applicant.jobTitle || 'N/A'}
🏢 Department          : ${applicant.department || 'N/A'}
📅 Application Date    : ${applicationDate}
🆔 Application ID      : ${applicant.applicationId || applicant.id || 'N/A'}
${statusIcon} Application Status : ${(applicant.status || 'pending').toUpperCase()}

PROFESSIONAL BACKGROUND:
--------------------------------------------------------------------------------
� Current Company     : ${applicant.currentCompany || 'N/A'}
💼 Current Position    : ${applicant.currentPosition || 'N/A'}
⏰ Years of Experience : ${applicant.yearsExperience || 'N/A'}
💰 Expected Salary     : ${applicant.expectedSalary ? `$${applicant.expectedSalary}` : 'N/A'}
📅 Available From      : ${availabilityDate}
⏳ Notice Period       : ${applicant.noticePeriod || 'N/A'}

APPLICATION RESPONSES:
--------------------------------------------------------------------------------
💭 Why Interested      : ${applicant.whyInterested || 'N/A'}
📝 Additional Info     : ${applicant.additionalInfo || 'N/A'}

DOCUMENTS & FILES:
--------------------------------------------------------------------------------
📄 Resume/CV           : ${applicant.resume || 'Not provided'}
${applicant.files && Object.keys(applicant.files).length > 0 ? 
    `� Other Files        : ${Object.keys(applicant.files).join(', ')}` : 
    '📁 Other Files        : None'}

CONSENT & COMPLIANCE:
--------------------------------------------------------------------------------
✅ Data Consent        : ${applicant.dataConsent || 'N/A'}
📧 Marketing Consent   : ${applicant.marketingConsent || 'N/A'}
📋 Terms Accepted      : ${applicant.termsAccept || 'N/A'}

TECHNICAL INFORMATION:
--------------------------------------------------------------------------------
🌐 Application IP     : ${applicant.applicantIP || 'N/A'}
💻 Browser Info       : ${applicant.browserInfo ? applicant.browserInfo.substring(0, 80) + '...' : 'N/A'}

================================================================================`;
                }).join('\n\n');
            }// Calculate applicant statistics
            function calculateApplicantStats(applicants) {
                if (!applicants || applicants.length === 0) {
                    return {
                        total: 0,
                        pending: 0,
                        underReview: 0,
                        shortlisted: 0,
                        interviewed: 0,
                        rejected: 0,
                        hired: 0,
                        archived: 0,
                        selected: 0,
                        withdrawn: 0,
                        declined: 0
                    };
                }
                
                const stats = {
                    total: applicants.length,
                    pending: 0,
                    underReview: 0,
                    shortlisted: 0,
                    interviewed: 0,
                    rejected: 0,
                    hired: 0,
                    archived: 0,
                    selected: 0,
                    withdrawn: 0,
                    declined: 0
                };
                
                applicants.forEach(applicant => {
                    const status = applicant.status || 'pending';
                    
                    // Direct status mapping
                    if (stats.hasOwnProperty(status)) {
                        stats[status]++;
                    }
                    
                    // Map some statuses to underReview
                    if (['pending', 'reviewing', 'under_review', 'screening'].includes(status)) {
                        stats.underReview++;
                    }
                    
                    // Count final selected candidates (hired + selected)
                    if (['hired', 'selected'].includes(status)) {
                        stats.finalSelectedCount = (stats.finalSelectedCount || 0) + 1;
                    }
                });
                
                // Add calculated field for final selected count
                stats.finalSelectedCount = stats.hired + stats.selected;
                
                return stats;
            }
            
            // Send notification to individual approver
            async function sendRecruitmentNotificationToApprover(approver, templateData) {
                try {
                    // Get the recruitment interview template
                    const template = getTemplate('recruitment-interview');
                    
                    // Replace template variables
                    let subject = template.subject;
                    let body = template.body;
                    
                    // Add approver-specific data
                    const approverData = {
                        ...templateData,
                        approverName: approver.name || approver.email.split('@')[0]
                    };
                    
                    // Replace all template variables
                    Object.keys(approverData).forEach(key => {
                        const regex = new RegExp(`{{${key}}}`, 'g');
                        subject = subject.replace(regex, approverData[key]);
                        body = body.replace(regex, approverData[key]);
                    });
                    
                    const emailData = {
                        to: approver.email,
                        subject: subject,
                        body: body,
                        type: 'recruitment-approval',
                        metadata: {
                            approverRole: approver.role,
                            jobId: templateData.referenceNumber,
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    const response = await fetch('http://localhost:3001/send/recruitment-notification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'dreemex_hse_email_service_2025'
                        },
                        body: JSON.stringify(emailData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`Recruitment notification sent to ${approver.email}:`, result.messageId);
                        return result;
                    } else {
                        throw new Error(`Email send failed: ${response.status}`);
                    }
                } catch (error) {
                    console.error(`Failed to send recruitment notification to ${approver.email}:`, error);
                    throw error;
                }
            }
            
            // Helper function to get template by type
            function getTemplate(templateType) {                const templates = {
                    'recruitment-interview': {
                        subject: 'Position Closed - {{jobPosition}} - Final Report with {{totalApplicants}} Applications',
                        body: `================================================================================
                               DREAMEX DATALAB HSE SYSTEM
                            POSITION CLOSURE NOTIFICATION & APPLICANT SUMMARY
================================================================================

Dear {{approverName}},

This notification confirms that the recruitment process for the position below has been officially closed. Please find the complete summary of all applications received during the recruitment period.

POSITION CLOSURE DETAILS:
--------------------------------------------------------------------------------
Reference Number : {{referenceNumber}}
Job Position     : {{jobPosition}}
Department       : {{department}}
Employment Type  : {{employmentType}}
Location         : {{workLocation}}
Position Start Date : {{startDate}}
Recruitment Period  : {{recruitmentStartDate}} to {{recruitmentEndDate}}
Closure Date        : {{closureDate}}
Closed By           : {{closedBy}}

FINAL RECRUITMENT STATISTICS:
--------------------------------------------------------------------------------
Total Applications Received : {{totalApplicants}}
Applications Under Review    : {{applicationsUnderReview}}
Applications Shortlisted     : {{applicationsShortlisted}}
Applications Interviewed     : {{applicationsInterviewed}}
Applications Rejected        : {{applicationsRejected}}
Final Candidates Selected    : {{finalSelectedCount}}

COMPLETE APPLICANT ROSTER:
================================================================================
{{applicantsList}}

POSITION REQUIREMENTS SUMMARY:
--------------------------------------------------------------------------------
Salary Range     : {{salaryMin}} - {{salaryMax}}
Working Hours    : {{workingHours}} hours/week
Required Education : {{requiredEducation}}
Required Experience: {{requiredExperience}}
Required Skills    : {{requiredSkills}}

JOB DESCRIPTION:
--------------------------------------------------------------------------------
{{jobDescription}}

CLOSURE SUMMARY & OUTCOMES:
--------------------------------------------------------------------------------
✓ Position has been officially closed
✓ All applications have been reviewed and processed
✓ Final candidate selection has been completed
✓ Recruitment metrics have been documented
✓ All applicants have been notified of their status
✓ Position closure documentation has been filed

RECRUITMENT PROCESS COMPLETION:
--------------------------------------------------------------------------------
1. ✅ Position posted and advertised
2. ✅ Applications received and reviewed
3. ✅ Initial screening completed
4. ✅ Interviews conducted for qualified candidates
5. ✅ Reference checks completed
6. ✅ Final selection made
7. ✅ All applicants notified
8. ✅ Position officially closed

POST-CLOSURE ACTIONS:
--------------------------------------------------------------------------------
• Final recruitment report generated
• Unsuccessful candidates added to talent pool
• Recruitment metrics updated in HR system
• Position closure documented for audit trail
• Feedback collected for process improvement

CONTACT INFORMATION:
--------------------------------------------------------------------------------
For questions about this closure or applicant information, please contact:
- HR Team: {{hrEmail}}
- Recruitment Manager: {{recruitmentManagerEmail}}
- Direct Supervisor: {{supervisorEmail}}

IMPORTANT NOTES:
--------------------------------------------------------------------------------
- This position is now officially closed to new applications
- All applicant data is maintained per company retention policy
- Recruitment materials have been archived
- Position may be reopened if business needs change
- Feedback on recruitment process is welcome

COMPLIANCE & DOCUMENTATION:
--------------------------------------------------------------------------------
✓ Equal opportunity compliance verified
✓ Interview documentation completed
✓ Reference check records maintained
✓ Rejection reasons documented appropriately
✓ Selection criteria applied consistently
✓ Audit trail maintained throughout process

Thank you for your participation in this recruitment process.

Best regards,
Dreamex Datalab HR System
Recruitment Management Division

================================================================================
This position closure notification was sent to all recruitment stakeholders.
For technical support, contact: it-support@dreamexdatalab.com
================================================================================`
                    }
                };
                
                return templates[templateType] || { subject: '', body: '' };
            }            // Test function for recruitment notifications
            async function testRecruitmentNotification() {
                try {
                    addLogEntry('Testing position closure notification...', 'info');
                    
                    // Use the actual job ID from the Firebase structure
                    const testJobId = '-OSeQpCGGgMj1IDLhTtc';
                    const testRecruitmentData = {
                        position: 'Fuel Manager',
                        department: 'Fuel Management',
                        employmentType: 'Full-time',
                        location: 'Office-based',
                        startDate: '2025-07-01',
                        priority: 'High',
                        referenceNumber: 'REC-2025-FUEL-001',
                        closedBy: 'HR Manager',
                        closureDate: new Date().toLocaleDateString(),
                        recruitmentStartDate: '2025-06-01',
                        recruitmentEndDate: '2025-06-13',
                        salaryMin: '$40,000',
                        salaryMax: '$60,000',
                        workingHours: '40',
                        description: 'Fuel Manager position responsible for overseeing fuel operations and management within the organization...',
                        education: 'Bachelor\'s degree in Engineering or related field',
                        experience: '2-3 years of fuel management experience',
                        skills: 'Fuel Operations, Safety Protocols, Team Management, Regulatory Compliance',
                        supervisorEmail: 'fuel.supervisor@dreamexdatalab.com',
                        finalSelectedCount: 1
                    };
                    
                    const result = await sendRecruitmentApprovalNotification(testJobId, testRecruitmentData);
                    
                    addLogEntry(`Test successful! Position closure notification sent to ${result.total} stakeholders (${result.successful} successful, ${result.failed} failed)`, 'success');
                    
                } catch (error) {
                    addLogEntry(`Test failed: ${error.message}`, 'error');
                    console.error('Position closure notification test error:', error);
                }
            }
              // Test function to verify Firebase archives connection and display applicant names
            async function testArchivesConnection() {
                try {
                    console.log('Testing Firebase archives connection...');
                    addLogEntry('Testing Firebase archives connection...', 'info');
                    
                    // Test with the specific job ID from the URL structure
                    const testJobId = '-OSeQpCGGgMj1IDLhTtc';
                    
                    addLogEntry('Fetching applicants from archives...', 'info');
                    const applicants = await fetchJobApplicants(testJobId);
                    
                    if (applicants && applicants.length > 0) {
                        addLogEntry(`Successfully fetched ${applicants.length} applicants from archives`, 'success');
                        
                        // Display detailed information for the first few applicants
                        const firstThreeApplicants = applicants.slice(0, 3);
                        firstThreeApplicants.forEach((applicant, index) => {
                            const name = applicant.name || `${applicant.firstName || ''} ${applicant.lastName || ''}`.trim() || 'Unknown';
                            addLogEntry(`Applicant ${index + 1}: ${name}`, 'info');
                            addLogEntry(`  - Email: ${applicant.email || 'N/A'}`, 'info');
                            addLogEntry(`  - Phone: ${applicant.phone || 'N/A'}`, 'info');
                            addLogEntry(`  - Position: ${applicant.jobTitle || 'N/A'}`, 'info');
                            addLogEntry(`  - Current Company: ${applicant.currentCompany || 'N/A'}`, 'info');
                            addLogEntry(`  - Experience: ${applicant.yearsExperience || 'N/A'}`, 'info');
                            addLogEntry(`  - Expected Salary: ${applicant.expectedSalary ? `$${applicant.expectedSalary}` : 'N/A'}`, 'info');
                            addLogEntry(`  - Status: ${applicant.status || 'pending'}`, 'info');
                            addLogEntry(`  - Resume: ${applicant.resume || 'Not provided'}`, 'info');
                            addLogEntry(`  - Application ID: ${applicant.applicationId || applicant.id}`, 'info');
                        });
                        
                        if (applicants.length > 3) {
                            addLogEntry(`... and ${applicants.length - 3} more applicants with full details`, 'info');
                        }
                        
                        // Test the formatting function with enhanced details
                        addLogEntry('Testing enhanced applicants list formatting...', 'info');
                        const formattedList = formatApplicantsList(applicants.slice(0, 1)); // Show first 1 fully formatted
                        console.log('Enhanced formatted applicants list sample:', formattedList);
                        addLogEntry('Enhanced applicants list formatted successfully', 'success');
                        
                        // Test statistics calculation
                        const stats = calculateApplicantStats(applicants);
                        addLogEntry(`Statistics - Total: ${stats.total}, Archived: ${stats.archived}, Pending: ${stats.pending}, Selected: ${stats.finalSelectedCount}`, 'info');
                        
                        // Display sample of actual data structure
                        if (applicants[0]) {
                            addLogEntry('Sample applicant data structure loaded successfully', 'success');
                            console.log('Sample applicant object:', applicants[0]);
                        }
                        
                    } else {
                        addLogEntry('No applicants found in archives or archives are empty', 'warning');
                        addLogEntry('Trying to fetch from general archives...', 'info');
                        
                        // Try with a generic search
                        const genericApplicants = await fetchJobApplicants('any');
                        if (genericApplicants && genericApplicants.length > 0) {
                            addLogEntry(`Found ${genericApplicants.length} general archive entries`, 'success');
                        } else {
                            addLogEntry('No data found in archives at all', 'warning');
                        }
                    }
                    
                    addLogEntry('Archives connection test completed successfully', 'success');
                    
                } catch (error) {
                    addLogEntry(`Archives connection test failed: ${error.message}`, 'error');
                    console.error('Archives connection test error:', error);
                }
            }
              // Make recruitment notification function globally available
            window.sendRecruitmentApprovalNotification = sendRecruitmentApprovalNotification;
            window.testRecruitmentNotification = testRecruitmentNotification;
            window.testArchivesConnection = testArchivesConnection;
            window.testApplicantNamesFormatting = testApplicantNamesFormatting;
            
            // Function to trigger recruitment notification from external systems
            window.triggerRecruitmentNotification = async function(jobId, recruitmentData = {}) {
                try {
                    console.log('Triggering recruitment notification for job:', jobId);
                    
                    // Use the specific job ID provided, or fallback to the one from the URL
                    const actualJobId = jobId || '-OSeQpCGGgMj1IDLhTtc';
                    
                    // Merge provided data with defaults
                    const defaultData = {
                        position: 'Position To Be Filled',
                        department: 'Various',
                        employmentType: 'Full-time',
                        location: 'Office',
                        priority: 'Normal',
                        referenceNumber: `REC-${Date.now()}`,
                        approvedBy: 'System',
                        salaryMin: 'TBD',
                        salaryMax: 'TBD',
                        workingHours: '40',
                        description: 'Job description to be provided.',
                        education: 'As per requirements',
                        experience: 'As per job posting',
                        skills: 'As specified in job requirements'
                    };
                    
                    const finalData = { ...defaultData, ...recruitmentData };
                    
                    const result = await sendRecruitmentApprovalNotification(actualJobId, finalData);
                    
                    console.log('Recruitment notification result:', result);
                    return result;
                    
                } catch (error) {                    console.error('Error triggering recruitment notification:', error);
                    throw error;
                }
            };
    </script>
            </div>
        </div>
    </main>
    </div>
    
</body>
</html>

