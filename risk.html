<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Risk Submission - Dreamex Datalab HSE</title>
	<!-- Firebase v8 CDN (match other pages) -->
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<meta name="robots" content="noindex, nofollow">
	<style>
		/* === Core Variables / Layout (derived from accessboard.html) === */
		:root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --orange:#e67e22; --red:#e74c3c; --purple:#9b59b6; --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem; --font-scale:1; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333; --text-secondary:#666; --border-color:#e0e0e0; --spacing-unit:.9rem; --padding-sm:.45rem; --padding-md:.75rem; --padding-lg:1.2rem; --transition-speed:.2s; }
		*{margin:0;padding:0;box-sizing:border-box;} body{font-family:var(--font-family);font-size:var(--base-font-size);line-height:1.4;color:var(--text-primary);background:#f8f9fa;}
		.app-container{display:flex;min-height:100vh;}
		.sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;height:100vh;overflow-y:auto;transition:transform .3s ease;}
		.sidebar.collapsed{transform:translateX(-100%);} .logo h2{text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.05rem;}
		.menu{list-style:none;margin-top:1.5rem;} .menu li{margin-bottom:.45rem;} .menu a{color:#fff;text-decoration:none;display:flex;align-items:center;padding:.65rem .9rem;border-radius:6px;font-size:.78rem;gap:.55rem;letter-spacing:.25px;transition:background .25s;} .menu a:hover,.menu a.active{background:var(--secondary-color);} .menu-dropdown .submenu{display:none;list-style:none;margin-left:1.2rem;margin-top:.35rem;} .menu-dropdown:hover .submenu{display:block;}
		/* Feature-based visibility */
		[data-feature]:not(.menu-visible){display:none !important;} .menu-dropdown:not(.menu-visible){display:none !important;} 
		
		/* Hide ALL menu items by default during loading */
		.sidebar.menu-loading .menu-item, .sidebar.menu-loading .menu-dropdown, .sidebar.menu-loading li[data-feature], .sidebar.menu-loading [data-feature] {display:none !important;} .menu-loading [data-feature]{display:none !important;} .menu-loading .menu-dropdown{display:none !important;}
		.main-content{flex:1;margin-left:var(--sidebar-width);padding:.45rem;width:calc(100% - var(--sidebar-width));box-sizing:border-box;display:flex;flex-direction:column;transition:margin-left .3s ease,width .3s ease;}
		.main-content.sidebar-collapsed{margin-left:0;width:100%;}
		/* Top Nav (copied style approach from accessboard.html) */
		.top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:.35rem;position:fixed;top:.25rem;right:.5rem;left:calc(var(--sidebar-width) + .5rem);height:50px;min-height:50px;z-index:100;transition:left .3s ease;}
		.top-nav-left{display:flex;align-items:center;gap:1rem;font-size:.8rem;font-weight:600;color:var(--text-secondary);} .sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;padding:.45rem;color:#666;border-radius:6px;display:flex;align-items:center;justify-content:center;} .sidebar-toggle-btn:hover{background:rgba(0,0,0,.06);}
		#headerCompanyLogo{width:44px;height:44px;border-radius:6px;object-fit:cover;display:none;background:#fff;border:1px solid #d0d7de;box-shadow:0 1px 2px rgba(0,0,0,.08);} #headerCompanyLogo.visible{display:block;} #headerCompanyName{font-size:.8rem;font-weight:600;letter-spacing:.5px;color:var(--primary-color);max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
		.top-nav-right{display:flex;align-items:center;gap:1.2rem;margin-left:auto;}
		.notifications{position:relative;display:flex;align-items:center;} .notification-btn{background:none;border:none;cursor:pointer;position:relative;font-size:1.1rem;padding:.45rem;display:flex;align-items:center;justify-content:center;} .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--accent-color);color:#fff;border-radius:50%;padding:.15rem .45rem;font-size:.6rem;}
		.notification-dropdown{display:none;position:absolute;right:0;top:100%;width:280px;background:#fff;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,.12);z-index:1000;}
		.notification-dropdown.show{display:block;} .notification-list{max-height:280px;overflow-y:auto;}
		.profile-btn{background:none;border:none;cursor:pointer;padding:.25rem;display:flex;align-items:center;position:relative;} 
		.profile-btn img{width:40px;height:40px;border-radius:50%;object-fit:cover;}
		.avatar-initials{width:40px;height:40px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px;font-family:Arial,sans-serif;}
		.profile-dropdown{display:none;position:absolute;top:100%;right:0;background:#fff;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,.12);min-width:200px;z-index:1000;} .profile-dropdown.show{display:block;} .profile-dropdown ul{list-style:none;margin:0;padding:0;} .profile-dropdown ul li a{display:flex;align-items:center;padding:12px 16px;color:#333;text-decoration:none;font-size:.78rem;gap:.6rem;transition:background .2s;} .profile-dropdown ul li a:hover{background:#f5f7fa;}
		.avatar-initials{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1rem;}
		/* Page Header */
		.page-header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;padding:.55rem .75rem;border-radius:8px;margin:.35rem 0 .5rem 0;display:flex;align-items:center;justify-content:space-between;box-shadow:0 10px 28px rgba(0,0,0,.18),0 6px 16px rgba(0,0,0,.14);font-size:.9rem;}
		.page-header i{font-size:1rem;}
		/* Content styles */
		.content{padding:.45rem;flex:1;}
		.content-header{margin-bottom:1.5rem;}
		.content-header h1{font-size:1.8rem;color:var(--primary-color);margin-bottom:.5rem;}
		
		/* Risk Form Specific Styles */
        .form-row {
            display: flex;
            margin-right: -15px;
            margin-left: -15px;
            flex-wrap: wrap;
        }
        
        .col-md-3 {
            flex: 0 0 25%;
            max-width: 25%;
            padding-right: 15px;
            padding-left: 15px;
        }
        
        .form-control.risk-extreme { background-color: #dc3545; color: white; }
        .form-control.risk-high { background-color: #fd7e14; color: white; }
        .form-control.risk-medium { background-color: #ffc107; color: black; }
        .form-control.risk-low { background-color: #28a745; color: white; }
        
        #existingControlsList, #actionsList {
            margin-bottom: 10px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .control-number {
            min-width: 30px;
            text-align: center;
        }
        
        .delete-control-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
        }
        
        .no-controls-message {
            font-style: italic;
            color: #666;
            margin: 10px 0;
        }

        /* Full width form container styles */
        .form-container {
            background:#fff;
            padding:1.5rem;
            border-radius:8px;
            box-shadow:0 1px 3px rgba(0,0,0,.08);
            margin-bottom:1rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label{
            display:block;
            margin-bottom:.5rem;
            font-weight:600;
            color:var(--text-primary);
            font-size:.85rem;
        }
        
        .form-group input, .form-group select, .form-group textarea{
            width:100%;
            padding:.65rem;
            border:1px solid var(--border-color);
            border-radius:6px;
            font-size:.85rem;
            transition:border-color .2s,box-shadow .2s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
            outline:none;
            border-color:var(--secondary-color);
            box-shadow:0 0 0 2px rgba(52,152,219,.1);
        }
        
        .form-group textarea{
            min-height:80px;
            resize:vertical;
        }
        
        .form-actions{
            display:flex;
            gap:.75rem;
            justify-content:flex-end;
            margin-top:2rem;
            padding-top:1.5rem;
            border-top:1px solid var(--border-color);
        }
        
        .btn{
            padding:.65rem 1.2rem;
            border:none;
            border-radius:6px;
            font-size:.85rem;
            font-weight:600;
            cursor:pointer;
            transition:all .2s;
            display:inline-flex;
            align-items:center;
            gap:.5rem;
            text-decoration:none;
        }
        
        .btn:hover{
            transform:translateY(-1px);
            box-shadow:0 2px 4px rgba(0,0,0,.1);
        }
        
        .btn-approve{
            background:var(--green);
            color:#fff;
        }
        
        .btn-approve:hover{
            background:#27ae60;
        }
        
        .btn{
            background:#6c757d;
            color:#fff;
        }
        
        .btn:hover{
            background:#5a6268;
        }

        /* File input styling */
        .form-group input[type="file"] {
            padding: 0.5rem;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            align-items: center;
        }
        
        .form-group input[type="file"]:hover {
            border-color: var(--secondary-color);
            background: #f0f8ff;
        }
        
        .form-group input[type="file"]:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52,152,219,.1);
        }
        
        /* File list styling */
        #fileList {
            margin-top: 0.75rem;
        }
        
        .selected-file {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.35rem 0;
            padding: 0.4rem 0.55rem;
            border: 1px solid #d4edda;
            border-radius: 4px;
            background: #d1ecf1;
            transition: background-color 0.2s;
        }
        
        .selected-file i {
            color: #0c5460;
        }
        
        .selected-file .file-name {
            flex: 1;
            font-size: 0.75rem;
            color: #0c5460;
            font-weight: 500;
        }
        
        .selected-file .file-size {
            font-size: 0.7rem;
            color: #6c757d;
        }
        
        .remove-file-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .remove-file-btn:hover {
            background: rgba(220, 53, 69, 0.1);
        }
        
        .existing-attachment {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.35rem 0;
            padding: 0.4rem 0.55rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
            transition: background-color 0.2s;
        }
        
        .existing-attachment:hover {
            background: #f0f8ff;
        }
        
        .existing-attachment i {
            color: #3498db;
        }
        
        .existing-attachment a {
            flex: 1;
            text-decoration: none;
            color: #2563eb;
            font-size: 0.75rem;
            word-break: break-all;
        }
        
        .existing-attachment a:hover {
            text-decoration: underline;
        }
        
        .attachments-header {
            margin-top: 0.5rem;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 0.5rem;
        }
        
        .attachments-header i {
            color: var(--secondary-color);
        }

        .file-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .file-status.pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .file-status.uploading {
            background-color: #cce5ff;
            color: #0066cc;
            border: 1px solid #99d3ff;
        }

        .file-status.uploaded {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .file-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .no-files-message {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .no-files-message i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #adb5bd;
        }

        .no-files-message p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* Better responsive styling for the form */
        @media (max-width: 768px) {
            .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .main-content{margin-left:0;width:100%;}
            .sidebar{position:fixed;z-index:1500;}
            .top-nav{left:.5rem;}
            .sidebar.collapsed{transform:translateX(-100%);}
        }
	</style>
</head>
<body>
	<div class="app-container">
		<!-- Sidebar (copied from accessboard.html with risk menu active) -->
		<nav class="sidebar menu-loading" id="sideNav">
			<div class="logo"><h2>Dreamex Datalab</h2></div>
			<ul class="menu" id="roleBasedMenu">
				<li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
					<a href="index.html"><i class="fas fa-home"></i> Home</a>
				</li>
				<li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
					<a href="#"><i class="fas fa-medkit"></i> Health</a>
					<ul class="submenu">
						<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
							<a href="health-assessment.html">Assessment</a>
						</li>
						<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
							<a href="health-consultation.html">Consultation</a>
						</li>
						<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
							<a href="medical-folder.html">Medical Folder</a>
						</li>
					</ul>
				</li>
				<li class="menu-dropdown active" data-feature="safety_view" data-requires-permission="safety_view">
					<a href="#" class="active"><i class="fas fa-shield-alt"></i> Safety</a>
					<ul class="submenu">
						<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
						<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html" class="active">Risk Management</a></li>
						<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
						<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
						<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
						<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
						<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
					<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
					<ul class="submenu">
						<li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
						<li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
						<li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
						<li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
						<li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
						<li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
						<li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
					<a href="#"><i class="fas fa-leaf"></i> Environment</a>
					<ul class="submenu">
						<li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
					<a href="#"><i class="fas fa-lock"></i> Security</a>
					<ul class="submenu">
						<li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
						<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
						<li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
					<a href="#"><i class="fas fa-truck"></i> Logistics</a>
					<ul class="submenu">
						<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
					<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
					<ul class="submenu">
						<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
						<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
					<a href="#"><i class="fas fa-users"></i> HR</a>
					<ul class="submenu">
						<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
						<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
						<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
						<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
						<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
						<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
						<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
						<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
						<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
						<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
						<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
						<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
						<li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
					<a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
					<ul class="submenu">
						<li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
						<li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
						<li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
						<li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
						<li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
						<li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
						<li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
						<li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
					</ul>
				</li>
				<li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
				<li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
					<a href="#"><i class="fas fa-cog"></i> Settings</a>
					<ul class="submenu">
						<li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
						<li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
						<li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
						<li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
						<li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
						<li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
						<li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
						<li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
						<li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
					</ul>
				</li>
			</ul>
		</nav>
		<!-- Main Content -->
		<main class="main-content">
			<header class="top-nav">
				<div class="top-nav-left">
					<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
					<img id="headerCompanyLogo" alt="Company Logo">
					<span id="headerCompanyName"></span>
				</div>
				<div class="top-nav-right">
					<div class="notifications">
						<button id="notificationBtn" class="notification-btn" aria-label="Notifications"><i class="fas fa-bell"></i><span class="notification-badge" style="display:none;">0</span></button>
						<div class="notification-dropdown">
							<div style="padding:.75rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
								<strong style="font-size:.7rem;color:#2c3e50;">Notifications</strong>
								<button class="mark-all-read" style="background:none;border:none;font-size:.6rem;color:var(--secondary-color);cursor:pointer;">Mark all read</button>
							</div>
							<div class="notification-list"></div>
						</div>
					</div>
					<div class="user-profile">
						<button id="userProfileBtn" class="profile-btn" aria-label="Profile">
							<img id="userAvatarImg" src="" alt="User Avatar" style="display: none;">
							<div id="userInitials" class="avatar-initials">U</div>
						</button>
						<div class="profile-dropdown"><ul></ul></div>
					</div>
				</div>
			</header>
			<div style="padding-top:3.4rem;"></div>
			<div class="page-header">
				<div style="display: flex; align-items: center; gap: 0.6rem;">
					<i class="fas fa-exclamation-triangle"></i>
					<span>Submit Risk Report</span>
				</div>
				<button type="button" class="btn-add-new" onclick="window.location.href='riskboard.html'" title="View Risk Dashboard">
					<i class="fas fa-table"></i>
				</button>
			</div>

			<!-- Form Content -->
			<div class="content">
				<div class="form-container">
					<form id="riskForm">
						<div class="form-group">
							<label for="riskID">Risk ID</label>
							<input type="text" id="riskID" name="riskID" readonly>
						</div>
						
						<div class="form-group">
							<label for="riskTitle">Risk Title*</label>
							<input type="text" id="riskTitle" name="riskTitle" required>
						</div>

						<div class="form-group">
							<label for="hazard">Hazard*</label>
							<input type="text" id="hazard" name="hazard" required>
						</div>

						<div class="form-group">
							<label for="hazardType">Hazard Type*</label>
							<select id="hazardType" name="hazardType" required>
								<option value="">Select Hazard Type</option>
							</select>
						</div>

						<div class="form-group">
							<label for="riskCategory">Risk Category*</label>
							<select id="riskCategory" name="riskCategory" required>
								<option value="">Select Risk Category</option>
							</select>
						</div>

						<div class="form-group">
							<label for="department">Department*</label>
							<select id="department" name="department" required>
								<option value="">Select Department</option>
							</select>
						</div>

						<div class="form-group">
							<label for="location">Location*</label>
							<select id="location" name="location" required>
								<option value="">Select Location</option>
							</select>
						</div>

						<div class="form-group">
							<label for="dateIdentified">Date Identified*</label>
							<input type="date" id="dateIdentified" name="dateIdentified" required>
						</div>

						<div class="form-group">
							<label for="description">Risk Description*</label>
							<textarea id="description" name="description" required></textarea>
						</div>                        
						
						<div class="form-group">
							<label for="requestor">Requestor</label>
							<input type="text" id="requestor" name="requestor" class="form-control" required readonly>
						</div>

						<h3>Inherent Risk Assessment (Before Controls)</h3>
						<div class="form-row">
							<div class="form-group col-md-3">
								<label for="inherentLikelihood">Likelihood*</label>
								<select id="inherentLikelihood" name="inherentLikelihood" required>
									<option value="">Select</option>
									<option value="1">1 - Rare</option>
									<option value="2">2 - Unlikely</option>
									<option value="3">3 - Possible</option>
									<option value="4">4 - Likely</option>
									<option value="5">5 - Almost Certain</option>
								</select>
							</div>
							<div class="form-group col-md-3">
								<label for="inherentImpact">Impact*</label>
								<select id="inherentImpact" name="inherentImpact" required>
									<option value="">Select</option>
									<option value="1">1 - Negligible</option>
									<option value="2">2 - Minor</option>
									<option value="3">3 - Moderate</option>
									<option value="4">4 - Major</option>
									<option value="5">5 - Catastrophic</option>
								</select>
							</div>
							<div class="form-group col-md-3">
								<label for="inherentRating">Rating</label>
								<input type="text" id="inherentRating" readonly>
							</div>
							<div class="form-group col-md-3">
								<label for="inherentLevel">Risk Level</label>
								<input type="text" id="inherentLevel" readonly>
							</div>
						</div>

						<h3>Controls and Mitigation</h3>
						<div class="form-group">
							<label for="riskStrategy">Risk Strategy*</label>
							<select id="riskStrategy" name="riskStrategy" required>
								<option value="">Select Strategy</option>
								<option value="avoid">Avoid</option>
								<option value="transfer">Transfer</option>
								<option value="mitigate">Mitigate</option>
								<option value="accept">Accept</option>
							</select>
						</div>

						<div class="form-group">
							<label>Existing Controls</label>
							<div id="existingControlsList"></div>
							<button type="button" class="btn btn-secondary" id="addControlBtn">
								<i class="fas fa-plus"></i> Add Control
							</button>
						</div>

						<div class="form-group">
							<label>Action Plan</label>
							<div id="actionsList"></div>
							<button type="button" class="btn btn-secondary" id="addActionBtn">
								<i class="fas fa-plus"></i> Add Action
							</button>
						</div>

						<h3>Residual Risk Assessment (After Controls)</h3>
						<div class="form-row">
							<div class="form-group col-md-3">
								<label for="residualLikelihood">Likelihood*</label>
								<select id="residualLikelihood" name="residualLikelihood" required>
									<option value="">Select</option>
									<option value="1">1 - Rare</option>
									<option value="2">2 - Unlikely</option>
									<option value="3">3 - Possible</option>
									<option value="4">4 - Likely</option>
									<option value="5">5 - Almost Certain</option>
								</select>
							</div>
							<div class="form-group col-md-3">
								<label for="residualImpact">Impact*</label>
								<select id="residualImpact" name="residualImpact" required>
									<option value="">Select</option>
									<option value="1">1 - Negligible</option>
									<option value="2">2 - Minor</option>
									<option value="3">3 - Moderate</option>
									<option value="4">4 - Major</option>
									<option value="5">5 - Catastrophic</option>
								</select>
							</div>
							<div class="form-group col-md-3">
								<label for="residualRating">Rating</label>
								<input type="text" id="residualRating" readonly>
							</div>
							<div class="form-group col-md-3">
								<label for="residualLevel">Risk Level</label>
								<input type="text" id="residualLevel" readonly>
							</div>
						</div>

						<div class="form-group">
							<label for="attachments">
								<i class="fas fa-paperclip"></i> Attachments
							</label>
							<input type="file" id="attachments" name="attachments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif">
							<small style="color: #666; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
								Choose files to upload (PDF, Word, Excel, Images). You can select multiple files.
							</small>
							<div id="fileList"></div>
						</div>

						<div class="form-actions">
							<button type="button" id="resetBtn" class="btn">Reset</button>
							<button type="button" class="btn" onclick="window.location.href='riskboard.html'">Cancel</button>
							<button type="submit" id="submitBtn" class="btn btn-approve">Submit Risk Report</button>
						</div>
					</form>
				</div>
			</div>
		</main>
	</div>	<!-- Utility: Sidebar persistence -->
	<script>
		function toggleSidebar(){
			const sb=document.querySelector('.sidebar');
			const mc=document.querySelector('.main-content');
			const top=document.querySelector('.top-nav');
			if(!sb||!mc)return;
			const collapsed=sb.classList.toggle('collapsed');
			mc.classList.toggle('sidebar-collapsed',collapsed);
			if(top){ top.style.left= collapsed? '.5rem': 'calc(var(--sidebar-width) + .5rem)'; }
			localStorage.setItem('sidebarCollapsed',collapsed);
		}
		function restoreSidebarState(){
			const collapsed=localStorage.getItem('sidebarCollapsed')==='true';
			const sb=document.querySelector('.sidebar');
			const mc=document.querySelector('.main-content');
			const top=document.querySelector('.top-nav');
			if(collapsed && sb && mc){ sb.classList.add('collapsed'); mc.classList.add('sidebar-collapsed'); if(top){top.style.left='.5rem';} }
		}
		document.addEventListener('DOMContentLoaded',()=>{
			restoreSidebarState();
			document.getElementById('sidebarToggle')?.addEventListener('click',toggleSidebar);
		});
	</script>
	<!-- Core Logic -->
	<script>
	/**************** Firebase Initialization ****************/ (function(){ const firebaseConfig={ apiKey:"AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc", authDomain:"users-8be65.firebaseapp.com", databaseURL:"https://users-8be65-default-rtdb.firebaseio.com", projectId:"users-8be65", storageBucket:"users-8be65.firebasestorage.app", messagingSenderId:"829083030831", appId:"1:829083030831:web:36a370e62691e560bc3dda" }; if(!window.firebase?.apps?.length){ firebase.initializeApp(firebaseConfig); console.log('✅ Firebase initialized (risk form)'); } window.db=firebase.database(); window.auth=firebase.auth(); window.storage=firebase.storage(); })();

	/**************** Notification Manager (light) ****************/ class NotificationManager{ constructor(){this.notifications=this.load();this.init();} load(){try{return JSON.parse(localStorage.getItem('notifications')||'[]');}catch{return[];}} save(){localStorage.setItem('notifications',JSON.stringify(this.notifications));this.updateBadge();this.render();} addNotification(n){this.notifications.unshift({id:Date.now(),timestamp:new Date().toISOString(),read:false,...n});this.save();} init(){this.bindUI();this.updateBadge();this.render();if(this.notifications.length===0){this.addNotification({type:'System',message:'Welcome to Risk Management'});} } bindUI(){const btn=document.getElementById('notificationBtn'); if(btn){btn.onclick=()=>document.querySelector('.notification-dropdown')?.classList.toggle('show');} document.addEventListener('click',e=>{if(!e.target.closest('.notifications')) document.querySelector('.notification-dropdown')?.classList.remove('show');}); const mark=document.querySelector('.mark-all-read'); if(mark){mark.onclick=()=>{this.notifications.forEach(n=>n.read=true); this.save();};}} updateBadge(){const badge=document.querySelector('.notification-badge'); if(!badge)return; const unread=this.notifications.filter(n=>!n.read).length; badge.textContent=unread; badge.style.display= unread? 'inline-block':'none';} render(){const list=document.querySelector('.notification-list'); if(!list)return; list.innerHTML=''; if(this.notifications.length===0){ list.innerHTML='<div style="padding:.9rem;font-size:.65rem;">No notifications</div>'; return;} this.notifications.slice(0,25).forEach(n=>{ const d=new Date(n.timestamp); const div=document.createElement('div'); div.className='notification-item'+(n.read?' read':''); div.style.cssText='padding:.65rem .75rem;border-bottom:1px solid #eee;font-size:.62rem;cursor:pointer;'+(n.read?'opacity:.6;':''); div.innerHTML=`<div style="display:flex;justify-content:space-between;font-weight:600;margin-bottom:2px;"><span>${n.type||'Info'}</span><span style="font-weight:400;color:#555;">${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span></div><div style="line-height:1.2;">${n.message||''}</div>`; div.onclick=()=>{n.read=true; this.save(); if(n.link) location.href=n.link;}; list.appendChild(div); }); }} window.notificationManager=new NotificationManager();

	/**************** AuthManager (adapted from accessboard.html) ****************/ class AuthManager{ constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; console.log('🔐 AuthManager(init) risk form'); this.initializeAuth(); }
		getCurrentUser(){ try{return JSON.parse(localStorage.getItem('currentUser')||'null');}catch{return null;} }
		setCurrentUser(u){ localStorage.setItem('currentUser',JSON.stringify(u)); localStorage.setItem('user',JSON.stringify(u)); this.currentUser=u; }
		async logout(){ try{ await firebase.auth().signOut(); }catch(e){ console.warn('Logout error',e);} ['currentUser','user'].forEach(k=>{localStorage.removeItem(k);sessionStorage.removeItem(k);}); location.href='index.html'; }
		initializeAuth(){ 
			if(!this.currentUser){ 
				console.warn('No user -> redirect login'); 
				location.href='login.html'; 
				return; 
			} 
			console.log('✅ User:',this.currentUser.email); 
			this.loadUserRole(this.currentUser); 
			this.loadUserCompany(); 
			this.updateUIForAuthenticatedUser(); 
			this.updateMenuVisibility(); 
			this.bindProfileDropdown(); 
		}
		bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn && dd){ btn.addEventListener('click',e=>{e.stopPropagation(); dd.classList.toggle('show');}); document.addEventListener('click',e=>{ if(!btn.contains(e.target)) dd.classList.remove('show');}); const logoutLink=dd.querySelector('a[href="#"]:has(.fa-sign-out-alt)')||dd.querySelector('.fa-sign-out-alt')?.closest('a'); if(logoutLink){ logoutLink.addEventListener('click',e=>{e.preventDefault(); this.logout();}); } } }
		resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=>d.classList.remove('menu-visible')); }
		async updateMenuVisibility(){ 
			console.log('🎯 Starting feature-based menu authorization for risk form...');
			const sidebar=document.querySelector('.sidebar'); 
			if(!this.currentUser){ 
				this.resetMenuVisibility(); 
				sidebar?.classList.remove('menu-loading');
				return; 
			} 
			const companyId=this.currentUser.companyId; 
			const userRole=this.currentUser.role; 
			console.log('👤 User:', this.currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
			if(!companyId){ 
				this.resetMenuVisibility(); 
				sidebar?.classList.remove('menu-loading');
				return; 
			} 
			// STEP 1: Apply company feature-based authorization
			console.log('🏢 STEP 1: Applying company feature authorization...');
			const authorizedPages = await this.applyFeatureBasedMenuVisibility(companyId);
			
			// STEP 2: Filter by user role permissions within authorized features
			if (userRole && authorizedPages && authorizedPages.length > 0) {
				console.log('👤 STEP 2: Applying role-based filtering within authorized features...');
				await this.applyRoleBasedFiltering(companyId, userRole, authorizedPages);
			} else {
				console.log('⚠️ STEP 2: Skipping role-based filtering (no role found or no authorized pages)');
				sidebar?.classList.remove('menu-loading');
			}
		}
		async applyFeatureBasedMenuVisibility(companyId){ 
			try{ 
				console.log('🔧 Applying feature-based menu visibility for company:', companyId);
				const database=firebase.database(); 
				const featuresSnapshot=await database.ref('/platformFeatures').once('value'); 
				if(!featuresSnapshot.exists()){ 
					console.log('⚠️ No platform features found');
					this.resetMenuVisibility(); 
					return [];
				} 
				const featuresData=featuresSnapshot.val(); 
				const companySnapshot=await database.ref(`/companies/${companyId}`).once('value'); 
				const companyData=companySnapshot.val(); 
				if(!companyData){ 
					console.error('❌ Company data not found');
					this.resetMenuVisibility(); 
					return [];
				} 
				const subscribed=companyData.selectedFeatures||[]; 
				console.log('🏢 Company subscribed features:', subscribed);
				if (subscribed.length === 0) {
					console.log('⚠️ Company has no subscribed features');
					this.resetMenuVisibility();
					return [];
				}
				const authorizedPages=[]; 
				subscribed.forEach(fid=>{
					const f=featuresData[fid]; 
					if(f && f.status==='active' && f.authorizedPages) {
						console.log(`📦 Adding pages from feature "${f.name}":`, f.authorizedPages);
						authorizedPages.push(...f.authorizedPages);
					} else {
						console.log(`⚠️ Feature ${fid} not found or inactive`);
					}
				}); 
				console.log('🔐 All authorized pages from company features:', authorizedPages);
				const authorizedFeatures=new Set(); 
				authorizedPages.forEach(p=>{ 
					if(p.feature) authorizedFeatures.add(p.feature); 
				}); 
				console.log('🎯 Authorized features for risk form:', Array.from(authorizedFeatures));
				this.resetMenuVisibility(); 
				let visibleCount = 0;
				document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(item=>{ 
					const feature=item.getAttribute('data-feature'); 
					const isDropdownContainer = item.classList.contains('menu-dropdown');
					
					if (isDropdownContainer) {
						return; // Handle dropdowns separately after all items are processed
					}
					
					if(authorizedFeatures.has(feature)){ 
						item.classList.add('menu-visible'); 
						visibleCount++;
						console.log(`✅ Feature authorized - showing menu item: ${feature}`);
					} else {
						console.log(`❌ Feature not authorized - hiding menu item: ${feature}`);
					}
				}); 
				// Handle dropdown menus - show if they have visible children
				document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{ 
					const feature=drop.getAttribute('data-feature'); 
					const hasVisible=[...drop.querySelectorAll('.submenu li[data-feature]')].some(li=>li.classList.contains('menu-visible')); 
					if(hasVisible || authorizedFeatures.has(feature)) {
						drop.classList.add('menu-visible'); 
						console.log(`✅ Showing dropdown menu: ${feature} (has visible children or directly authorized)`);
					} else {
						console.log(`❌ Hiding dropdown menu: ${feature} (no visible children and not authorized)`);
					}
				}); 
				console.log(`🎯 Company feature authorization completed - ${visibleCount} items initially visible`);
				// Return authorized pages for role-based filtering
				return authorizedPages;
			}catch(e){ 
				console.error('❌ Error applying feature-based menu visibility:', e); 
				this.resetMenuVisibility(); 
				return [];
			} 
		}
		
		// Apply role-based filtering within company authorized features
		async applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
			try {
				console.log('👤 Applying role-based filtering for role:', userRole);
				
				// Get user role permissions from company
				const database = firebase.database();
				const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
				const permissionsSnapshot = await permissionsRef.once('value');
				
				if (!permissionsSnapshot.exists()) {
					console.log(`⚠️ No permissions found for role ${userRole} in company ${companyId}`);
					
					// CRITICAL: If user is administrator but no permissions found, provide full access as fallback
					if (userRole === 'administrator') {
						console.log('🔑 ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
						this.showSidebarAfterAuth();
						return;
					}
					
					// For other roles without permissions, hide all items with permission requirements
					console.log('❌ No valid permissions found - filtering out items requiring permissions');
					this.hideItemsRequiringPermissions();
					this.showSidebarAfterAuth();
					return;
				}
				
				const permissions = permissionsSnapshot.val();
				console.log('✅ Loaded role permissions:', permissions);
				
				// Apply permission-based filtering
				this.filterMenuByPermissions(permissions);
				
			} catch (error) {
				console.error('❌ Error applying role-based filtering:', error);
				// Don't hide everything on error - keep company features visible
				this.showSidebarAfterAuth();
			}
		}

		// Filter currently visible menu items by role permissions
		filterMenuByPermissions(permissions) {
			console.log('🔍 Filtering visible menu items by role permissions...');
			
			if (!permissions) {
				console.log('⚠️ No permissions object provided');
				this.hideItemsRequiringPermissions();
				this.showSidebarAfterAuth();
				return;
			}
			
			// Only check items that are already visible from company features
			const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			console.log(`🎯 Found ${visibleMenuItems.length} visible menu items requiring permissions to check`);
			
			let hiddenCount = 0;
			
			visibleMenuItems.forEach(item => {
				const requiresPermission = item.getAttribute('data-requires-permission');
				const feature = item.getAttribute('data-feature');
				
				if (requiresPermission) {
					const hasPermission = permissions[requiresPermission];
					const hasViewPermission = hasPermission === true || 
											 (hasPermission && hasPermission.view === true);
					
					if (!hasViewPermission) {
						item.classList.remove('menu-visible');
						hiddenCount++;
						console.log(`❌ Hiding menu item (no permission): ${feature} (requires: ${requiresPermission})`);
					} else {
						console.log(`✅ Keeping menu item visible: ${feature} (has permission: ${requiresPermission})`);
					}
				}
			});
			
			// Re-check dropdown menus after permission filtering
			const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
			dropdownMenus.forEach(dropdown => {
				const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
				const dropdownFeature = dropdown.getAttribute('data-feature');
				
				if (submenuItems.length === 0) {
					dropdown.classList.remove('menu-visible');
					console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
				} else {
					console.log(`✅ Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
				}
			});
			
			console.log(`🎯 Role-based filtering completed - ${hiddenCount} items hidden due to lack of permissions`);
			
			// Show sidebar after all filtering is complete
			this.showSidebarAfterAuth();
		}

		// Hide menu items that require permissions (for users without role permissions)
		hideItemsRequiringPermissions() {
			console.log('🔒 Hiding all menu items that require permissions...');
			
			const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			let hiddenCount = 0;
			
			itemsRequiringPermissions.forEach(item => {
				const feature = item.getAttribute('data-feature');
				const requiresPermission = item.getAttribute('data-requires-permission');
				
				item.classList.remove('menu-visible');
				hiddenCount++;
				console.log(`❌ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
			});
			
			console.log(`🔒 Hidden ${hiddenCount} items requiring permissions`);
		}

		// Show sidebar and remove loading state after authentication and filtering
		showSidebarAfterAuth() {
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
				console.log('✅ Sidebar loading state removed - menu authorization complete');
			}
		}
		
		async loadUserRole(user){ if(user.role||!user.uid) return; try{ const snap=await firebase.database().ref(`users/${user.uid}`).once('value'); if(snap.exists()){ user.role=snap.val().role||'user'; this.setCurrentUser(user);} }catch(e){ console.warn('Role load error',e);} }
		async loadUserCompany(){ 
			if(!this.currentUser) return; 
			try{ 
				const snap=await firebase.database().ref('companies').once('value'); 
				if(!snap.exists()) { 
					this.resetMenuVisibility(); 
					return;
				} 
				const companies=snap.val(); 
				for(const [cid,comp] of Object.entries(companies)){ 
					if(comp.status!=='active') continue; 
					if(comp.users){ 
						for(const [uid,u] of Object.entries(comp.users)){ 
							if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ 
								this.currentUser.companyId=cid; 
								this.currentUser.companyName=comp.companyName; 
								this.currentUser.role=u.role || u.userRole || 'user'; // Set user role from company user record
								this.currentCompany=comp; 
								this.setCurrentUser(this.currentUser); 
								console.log('✅ Found user in company:', cid, 'with role:', this.currentUser.role);
								this.updateCompanyBranding(); 
								await this.updateMenuVisibility(); 
								return; 
							}
						}
					} 
				} 
				this.resetMenuVisibility(); 
			}catch(e){ 
				console.error('Company load error',e); 
				this.resetMenuVisibility(); 
			} 
		}
		updateCompanyBranding(){ if(!this.currentCompany){ this.showFallbackBranding(); return;} const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.classList.add('visible'); } else { const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.src=svg; logoEl.classList.add('visible'); }} if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color',this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color',this.currentCompany.branding.secondaryColor); }}
		showFallbackBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); if(logoEl){ const svg=this.generateCompanyInitialsSVG('DX'); logoEl.src=svg; logoEl.classList.add('visible'); }} getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
		generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
		getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=> typeof v==='string'? v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){const cleaned=n(c); if(cleaned) return cleaned;} if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
		getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
		async getUserAvatarUrl(){ 
			if(!this.currentUser) return null; 
			const companyId = this.currentUser.companyId || 'default';
			try{ 
				const possiblePaths = [
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,
					`avatars/${this.currentUser.uid}/profile.jpg`,
					`avatars/${this.currentUser.uid}/profile.png`,
					`avatars/${this.currentUser.uid}/avatar.jpg`,
					`avatars/${this.currentUser.uid}/avatar.png`,
					`profiles/${this.currentUser.uid}/profile.jpg`,
					`profiles/${this.currentUser.uid}/profile.png`
				];
				
				for(const path of possiblePaths) {
					try {
						const ref = firebase.storage().ref(path);
						const url = await ref.getDownloadURL();
						console.log(`✅ Found profile picture at: ${path}`);
						return url;
					} catch(err) {
						continue;
					}
				}
				return null;
			} catch(error) { 
				console.error('Error getting user avatar:', error);
				return null; 
			}
		}
		async updateUIForAuthenticatedUser(){ 
			console.log('🔄 updateUIForAuthenticatedUser called');
			const btn=document.getElementById('userProfileBtn'); 
			const list=document.querySelector('.profile-dropdown ul'); 
			const userAvatarImg=document.getElementById('userAvatarImg');
			const userInitials=document.getElementById('userInitials');
			
			if(!btn||!list||!this.currentUser) return; 
			
			const displayName=this.getUserDisplayName(); 
			const email=this.currentUser.email||''; 
			
			// Set user initials first as fallback
			if(userInitials) {
				userInitials.textContent = this.getUserInitials();
			}
			
			// Try to get avatar URL
			let avatarUrl = null;
			try {
				avatarUrl = await this.getUserAvatarUrl();
			} catch(error) {
				console.error('❌ Error getting avatar URL:', error);
			}
			
			// Update header avatar display
			if(avatarUrl && userAvatarImg) { 
				userAvatarImg.src = avatarUrl; 
				userAvatarImg.alt = displayName + ' Avatar';
				userAvatarImg.style.display = 'block';
				if(userInitials) userInitials.style.display = 'none';
				
				// Handle image load error
				userAvatarImg.onerror = () => {
					userAvatarImg.style.display = 'none';
					if(userInitials) userInitials.style.display = 'flex';
				};
			} else { 
				if(userAvatarImg) userAvatarImg.style.display = 'none';
				if(userInitials) userInitials.style.display = 'flex';
			}
			
			// Update dropdown content
			const avatarHtml= avatarUrl? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`; 
			list.innerHTML=`<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`; 
			list.querySelector('#logoutLink')?.addEventListener('click',e=>{e.preventDefault(); this.logout();}); 
		}
	}
	window.authManager=new AuthManager();

	/**************** Risk Form Functionality ****************/
	// Basic form initialization
	document.addEventListener('DOMContentLoaded', function() {
		// Initialize form
		initializeRiskForm();
		
		// Check if we're in edit mode and load existing data
		loadEditDataIfPresent();
		
		// Set today's date as default (only if not editing)
		if (!isEditMode()) {
			document.getElementById('dateIdentified').value = new Date().toISOString().split('T')[0];
			// Auto-generate risk ID (only for new risks)
			generateRiskID();
		}
		
		// Set requestor name (only if not editing)
		if (!isEditMode()) {
			setRequestorName();
		}
		
		// Initialize risk calculations
		setupRiskCalculations();
		
		// Initialize dynamic lists
		initializeDynamicLists();
		
		// Form submission handler
		document.getElementById('riskForm').addEventListener('submit', handleFormSubmission);
	});

	// Check if we're in edit mode
	function isEditMode() {
		const urlParams = new URLSearchParams(window.location.search);
		// Only consider it edit mode if the URL explicitly has edit parameter
		return urlParams.has('edit');
	}

	// Load edit data from localStorage and populate form
	function loadEditDataIfPresent() {
		try {
			// Only load edit data if we're explicitly in edit mode (URL has edit parameter)
			const urlParams = new URLSearchParams(window.location.search);
			if (!urlParams.has('edit')) {
				// If not in edit mode, clear any stale edit data
				localStorage.removeItem('riskEditData');
				return;
			}

			const editDataString = localStorage.getItem('riskEditData');
			if (!editDataString) return;

			const editData = JSON.parse(editDataString);
			if (!editData || !editData.data) return;

			console.log('Loading edit data:', editData);

			const data = editData.data;

			// Helper to safely set select value (if option not yet loaded, defer)
			function setSelectValue(id, value) {
				if (!value) return;
				const el = document.getElementById(id);
				if (!el) return;
				if ([...el.options].some(o => o.value === value)) {
					el.value = value;
				} else {
					// Store pending selection to apply after dropdown population
					window._pendingSelectValues = window._pendingSelectValues || {};
					window._pendingSelectValues[id] = value;
				}
			}

			// Populate basic fields
			if (data.riskTitle) document.getElementById('riskTitle').value = data.riskTitle;
			if (data.description) document.getElementById('description').value = data.description;
			if (data.hazard) document.getElementById('hazard').value = data.hazard;
			setSelectValue('hazardType', data.hazardType);
			setSelectValue('riskCategory', data.riskCategory);
			setSelectValue('department', data.department);
			setSelectValue('location', data.location);
			if (data.dateIdentified) document.getElementById('dateIdentified').value = data.dateIdentified.split('T')[0];
			if (data.requestor) document.getElementById('requestor').value = data.requestor;
			setSelectValue('riskStrategy', data.riskStrategy);
			
			// Set the risk ID (from editing data) - display human-readable ID
			if (editData.riskId) {
				document.getElementById('riskID').value = editData.riskId;
			} else if (data.riskID) {
				// Fallback to data.riskID if editData.riskId is not available
				document.getElementById('riskID').value = data.riskID;
			}

			// Populate inherent assessment
			if (data.inherentLikelihood) document.getElementById('inherentLikelihood').value = data.inherentLikelihood;
			if (data.inherentImpact) document.getElementById('inherentImpact').value = data.inherentImpact;
			if (data.inherentRating) document.getElementById('inherentRating').value = data.inherentRating;
			if (data.inherentLevel) document.getElementById('inherentLevel').value = data.inherentLevel;

			// Populate residual assessment
			if (data.residualLikelihood) document.getElementById('residualLikelihood').value = data.residualLikelihood;
			if (data.residualImpact) document.getElementById('residualImpact').value = data.residualImpact;
			if (data.residualRating) document.getElementById('residualRating').value = data.residualRating;
			if (data.residualLevel) document.getElementById('residualLevel').value = data.residualLevel;

			// Populate controls list
			if (Array.isArray(data.controls) && data.controls.length > 0) {
				const controlsContainer = document.getElementById('existingControlsList');
				if (controlsContainer) {
					// Clear existing controls
					controlsContainer.innerHTML = '';
					// Add each control
					data.controls.forEach((control, index) => {
						if (control.trim()) {
							const controlDiv = document.createElement('div');
							controlDiv.className = 'control-item';
							controlDiv.innerHTML = `
								<span class="control-number">${index + 1}.</span>
								<input type="text" value="${control}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
								<button type="button" class="delete-control-btn" onclick="this.parentElement.remove(); updateControlNumbers();">
									<i class="fas fa-trash"></i>
								</button>
							`;
							controlsContainer.appendChild(controlDiv);
						}
					});
				}
			}

			// Populate actions list
			if (Array.isArray(data.actions) && data.actions.length > 0) {
				const actionsContainer = document.getElementById('actionsList');
				if (actionsContainer) {
					// Clear existing actions
					actionsContainer.innerHTML = '';
					// Add each action
					data.actions.forEach((action, index) => {
						if (action.trim()) {
							const actionDiv = document.createElement('div');
							actionDiv.className = 'control-item';
							actionDiv.innerHTML = `
								<span class="control-number">${index + 1}.</span>
								<input type="text" value="${action}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
								<button type="button" class="delete-control-btn" onclick="this.parentElement.remove(); updateActionNumbers();">
									<i class="fas fa-trash"></i>
								</button>
							`;
							actionsContainer.appendChild(actionDiv);
						}
					});
				}
			}

			// Populate existing attachments (read-only list for now)
			if (data.attachments && typeof data.attachments === 'object') {
				const fileList = document.getElementById('fileList');
				if (fileList) {
					fileList.innerHTML = `
						<div class="attachments-header">
							<i class="fas fa-paperclip"></i>
							Existing Attachments
						</div>
					` + Object.entries(data.attachments).map(([key, value]) => {
						// Handle both old format (key: url) and new format (key: {url, originalName})
						const isNewFormat = typeof value === 'object' && value.url;
						const url = isNewFormat ? value.url : value;
						const displayName = isNewFormat ? value.originalName : decodeFirebaseSafeKey(key);
						
						return `
							<div class="existing-attachment" data-attachment-key="${key}">
								<i class="fas fa-file"></i>
								<a href="${url}" target="_blank">${displayName}</a>
							</div>
						`;
					}).join('');
				}
				// Store a reference so submission preserves attachments
				window._existingAttachments = data.attachments;
			}

			// Update page title to indicate edit mode
			const pageTitle = document.querySelector('.page-header h1');
			if (pageTitle) {
				pageTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Risk Assessment';
			}

			// Update submit button text
			const submitBtn = document.querySelector('button[type="submit"]');
			if (submitBtn) {
				submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Risk Assessment';
			}

			// Store edit mode flag
			window.isEditingRisk = true;
			window.editingRiskId = editData.firebaseKey || editData.riskId; // Use firebaseKey for DB operations

			console.log('Edit data loaded successfully');

		} catch (error) {
			console.error('Error loading edit data:', error);
			// Clear corrupted data
			localStorage.removeItem('riskEditData');
		}
	}
	
	function generateRiskID() {
		const now = new Date();
		const year = now.getFullYear();
		const month = String(now.getMonth() + 1).padStart(2, '0');
		const day = String(now.getDate()).padStart(2, '0');
		const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
		const riskID = `RISK-${year}${month}${day}-${time}`;
		document.getElementById('riskID').value = riskID;
	}
	
	function setRequestorName() {
		// Set requestor from current user
		const currentUser = window.authManager?.currentUser;
		if (currentUser) {
			const displayName = currentUser.displayName || currentUser.name || currentUser.email || 'Unknown User';
			document.getElementById('requestor').value = displayName;
		}
	}
	
	function setupRiskCalculations() {
		// Risk matrix calculations
		const inherentLikelihood = document.getElementById('inherentLikelihood');
		const inherentImpact = document.getElementById('inherentImpact');
		const inherentRating = document.getElementById('inherentRating');
		const inherentLevel = document.getElementById('inherentLevel');
		
		const residualLikelihood = document.getElementById('residualLikelihood');
		const residualImpact = document.getElementById('residualImpact');
		const residualRating = document.getElementById('residualRating');
		const residualLevel = document.getElementById('residualLevel');
		
		function calculateRisk(likelihood, impact, ratingField, levelField) {
			const l = parseInt(likelihood.value) || 0;
			const i = parseInt(impact.value) || 0;
			const rating = l * i;
			
			ratingField.value = rating || '';
			
			let level = '';
			let className = '';
			if (rating >= 20) { level = 'Extreme'; className = 'risk-extreme'; }
			else if (rating >= 12) { level = 'High'; className = 'risk-high'; }
			else if (rating >= 6) { level = 'Medium'; className = 'risk-medium'; }
			else if (rating >= 1) { level = 'Low'; className = 'risk-low'; }
			
			levelField.value = level;
			levelField.className = 'form-control ' + className;
			ratingField.className = 'form-control ' + className;
		}
		
		[inherentLikelihood, inherentImpact].forEach(field => {
			field.addEventListener('change', () => calculateRisk(inherentLikelihood, inherentImpact, inherentRating, inherentLevel));
		});
		
		[residualLikelihood, residualImpact].forEach(field => {
			field.addEventListener('change', () => calculateRisk(residualLikelihood, residualImpact, residualRating, residualLevel));
		});
	}
	
	function initializeDynamicLists() {
		// Initialize controls list
		document.getElementById('addControlBtn').addEventListener('click', addControl);
		
		// Initialize actions list  
		document.getElementById('addActionBtn').addEventListener('click', addAction);
		
		// Reset button
		document.getElementById('resetBtn').addEventListener('click', resetForm);
	}
	
	function addControl() {
		const controlsList = document.getElementById('existingControlsList');
		const controlNumber = controlsList.children.length + 1;
		
		const controlDiv = document.createElement('div');
		controlDiv.className = 'control-item';
		controlDiv.innerHTML = `
			<span class="control-number">${controlNumber}.</span>
			<input type="text" placeholder="Control measure..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
			<button type="button" class="delete-control-btn" onclick="this.parentElement.remove(); updateControlNumbers();">
				<i class="fas fa-trash"></i>
			</button>
		`;
		
		controlsList.appendChild(controlDiv);
	}
	
	function addAction() {
		const actionsList = document.getElementById('actionsList');
		const actionNumber = actionsList.children.length + 1;
		
		const actionDiv = document.createElement('div');
		actionDiv.className = 'control-item';
		actionDiv.innerHTML = `
			<span class="control-number">${actionNumber}.</span>
			<input type="text" placeholder="Action item..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
			<button type="button" class="delete-control-btn" onclick="this.parentElement.remove(); updateActionNumbers();">
				<i class="fas fa-trash"></i>
			</button>
		`;
		
		actionsList.appendChild(actionDiv);
	}
	
	function updateControlNumbers() {
		const controls = document.querySelectorAll('#existingControlsList .control-item');
		controls.forEach((control, index) => {
			control.querySelector('.control-number').textContent = `${index + 1}.`;
		});
	}
	
	function updateActionNumbers() {
		const actions = document.querySelectorAll('#actionsList .control-item');
		actions.forEach((action, index) => {
			action.querySelector('.control-number').textContent = `${index + 1}.`;
		});
	}
	
	function resetForm() {
		if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
			document.getElementById('riskForm').reset();
			document.getElementById('existingControlsList').innerHTML = '';
			document.getElementById('actionsList').innerHTML = '';
			generateRiskID();
			setRequestorName();
		}
	}
	
	function initializeRiskForm() {
		// Load dropdown options from Firebase
		loadDropdownOptions();
		
		// Initialize file input handler
		initializeFileInput();
		
		// Initialize real-time updates for edit mode
		initializeRealtimeUpdates();
	}
	
	function initializeRealtimeUpdates() {
		// Only set up real-time listener if in edit mode
		if (!window.isEditingRisk || !window.editingRiskId) return;
		
		const currentUser = window.authManager?.currentUser;
		if (!currentUser?.companyId) return;
		
		console.log('🔄 Setting up real-time updates for risk:', window.editingRiskId);
		
		// Listen for changes to the current risk
		const riskRef = firebase.database().ref(`companies/${currentUser.companyId}/risks/${window.editingRiskId}`);
		riskRef.on('value', (snapshot) => {
			if (!snapshot.exists()) return;
			
			const updatedRisk = snapshot.val();
			console.log('📡 Risk data updated in real-time:', updatedRisk);
			
			// Update existing attachments if they changed
			if (updatedRisk.attachments && JSON.stringify(updatedRisk.attachments) !== JSON.stringify(window._existingAttachments)) {
				console.log('📎 Attachments updated, refreshing display');
				window._existingAttachments = updatedRisk.attachments;
				displayFileList();
			}
		});
		
		// Clean up listener when leaving the page
		window.addEventListener('beforeunload', () => {
			riskRef.off();
		});
	}
	
	function initializeFileInput() {
		const fileInput = document.getElementById('attachments');
		const fileList = document.getElementById('fileList');
		
		if (!fileInput || !fileList) return;
		
		fileInput.addEventListener('change', function(e) {
			const files = Array.from(e.target.files);
			
			if (files.length === 0) {
				displayFileList();
				return;
			}
			
			// Display newly selected files with upload status
			displayFileList(files);
		});
		
		// Initial display
		displayFileList();
	}
	
	function displayFileList(newFiles = []) {
		const fileList = document.getElementById('fileList');
		if (!fileList) return;
		
		let html = '';
		
		// Show existing attachments if in edit mode
		if (window.isEditingRisk && window._existingAttachments) {
			const attachmentCount = Object.keys(window._existingAttachments).length;
			html += `
				<div class="attachments-header">
					<i class="fas fa-paperclip"></i>
					Existing Attachments (${attachmentCount})
				</div>
			` + Object.entries(window._existingAttachments).map(([key, value]) => {
				// Handle both old format (key: url) and new format (key: {url, originalName})
				const isNewFormat = typeof value === 'object' && value.url;
				const url = isNewFormat ? value.url : value;
				const displayName = isNewFormat ? value.originalName : decodeFirebaseSafeKey(key);
				
				return `
					<div class="existing-attachment" data-attachment-key="${key}">
						<i class="fas fa-file"></i>
						<a href="${url}" target="_blank" title="Click to download">${displayName}</a>
						<span class="file-status uploaded">
							<i class="fas fa-check-circle"></i>
							Uploaded
						</span>
					</div>
				`;
			}).join('');
		}
		
		// Show newly selected files
		if (newFiles.length > 0) {
			html += `
				<div class="attachments-header" style="margin-top: ${window._existingAttachments ? '1rem' : '0.5rem'};">
					<i class="fas fa-plus-circle"></i>
					New Files Selected (${newFiles.length})
				</div>
			` + newFiles.map((file, index) => `
				<div class="selected-file" data-file-index="${index}">
					<i class="fas fa-file"></i>
					<span class="file-name">${file.name}</span>
					<span class="file-size">(${formatFileSize(file.size)})</span>
					<span class="file-status pending">
						<i class="fas fa-clock"></i>
						Ready to upload
					</span>
					<button type="button" class="remove-file-btn" onclick="removeSelectedFile(${index})" title="Remove file">
						<i class="fas fa-times"></i>
					</button>
				</div>
			`).join('');
		}
		
		if (!html) {
			html = `
				<div class="no-files-message">
					<i class="fas fa-file-upload"></i>
					<p>No files selected. Click "Choose files" to upload attachments.</p>
				</div>
			`;
		}
		
		fileList.innerHTML = html;
	}
	
	function formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}
	
	function decodeFirebaseSafeKey(encodedKey) {
		// Decode Firebase-safe key back to original filename
		return encodedKey
			.replace(/_DOT_/g, '.')
			.replace(/_HASH_/g, '#')
			.replace(/_DOLLAR_/g, '$')
			.replace(/_SLASH_/g, '/')
			.replace(/_LBRACKET_/g, '[')
			.replace(/_RBRACKET_/g, ']');
	}
	
	function updateFileStatus(fileIndex, status, message) {
		const fileElement = document.querySelector(`[data-file-index="${fileIndex}"] .file-status`);
		if (!fileElement) return;
		
		// Remove all status classes
		fileElement.classList.remove('pending', 'uploading', 'uploaded', 'error');
		
		// Add new status class
		fileElement.classList.add(status);
		
		// Update icon and text
		let icon = 'fas fa-clock';
		switch (status) {
			case 'uploading':
				icon = 'fas fa-spinner fa-spin';
				break;
			case 'uploaded':
				icon = 'fas fa-check-circle';
				break;
			case 'error':
				icon = 'fas fa-exclamation-triangle';
				break;
		}
		
		fileElement.innerHTML = `<i class="${icon}"></i> ${message}`;
	}
	
	function removeSelectedFile(index) {
		const fileInput = document.getElementById('attachments');
		if (!fileInput) return;
		
		// Create a new FileList without the removed file
		const dt = new DataTransfer();
		const files = Array.from(fileInput.files);
		
		files.forEach((file, i) => {
			if (i !== index) {
				dt.items.add(file);
			}
		});
		
		fileInput.files = dt.files;
		
		// Trigger change event to update display
		fileInput.dispatchEvent(new Event('change'));
	}
	
	async function loadDropdownOptions() {
		try {
			const currentUser = window.authManager?.currentUser;
			if (!currentUser?.companyId) {
				console.warn('❌ No user or company ID found for loading dropdown options');
				return;
			}
			
			console.log('🔄 Loading dropdown options for company:', currentUser.companyId);
			
			const companyRef = firebase.database().ref(`companies/${currentUser.companyId}`);
			const snapshot = await companyRef.once('value');
			const companyData = snapshot.val();
			
			if (!companyData) {
				console.warn('❌ No company data found');
				return;
			}
			
			console.log('✅ Company data loaded:', companyData);
			console.log('🔍 Available company data keys:', Object.keys(companyData));
			console.log('🔍 fieldOptions available:', !!companyData.fieldOptions);
			console.log('🔍 formFields available:', !!companyData.formFields);
			console.log('🔍 fieldSetup available:', !!companyData.fieldSetup);
			
			// Track what has been loaded to avoid duplicates
			let departmentsLoaded = false;
			let locationsLoaded = false;
			let riskCategoriesLoaded = false;
			
			if (companyData) {
				// Load departments from fieldOptions first, then fallback to departments array
				if (companyData.fieldOptions && companyData.fieldOptions['department']) {
					const departments = companyData.fieldOptions['department']
						.filter(item => item.enabled !== false)
						.map(item => ({ value: item.value, label: item.label }));
					populateDropdown('department', departments);
					console.log('✅ Loaded departments from fieldOptions:', departments);
					departmentsLoaded = true;
				} else if (companyData.departments) {
					populateDropdown('department', companyData.departments);
					console.log('✅ Loaded departments from legacy departments array');
					departmentsLoaded = true;
				}
				
				// Load locations from fieldOptions first, then fallback to locations array
				if (companyData.fieldOptions && companyData.fieldOptions['area']) {
					const locations = companyData.fieldOptions['area']
						.filter(item => item.enabled !== false)
						.map(item => ({ value: item.value, label: item.label }));
					populateDropdown('location', locations);
					console.log('✅ Loaded locations from fieldOptions/area:', locations);
					locationsLoaded = true;
				} else if (companyData.fieldOptions && companyData.fieldOptions['location']) {
					const locations = companyData.fieldOptions['location']
						.filter(item => item.enabled !== false)
						.map(item => ({ value: item.value, label: item.label }));
					populateDropdown('location', locations);
					console.log('✅ Loaded locations from fieldOptions/location:', locations);
					locationsLoaded = true;
				} else if (companyData.locations) {
					populateDropdown('location', companyData.locations);
					console.log('✅ Loaded locations from legacy locations array');
					locationsLoaded = true;
				}
				
				// Load hazard types and other field options from company fieldOptions
				if (companyData.fieldOptions) {
					// Load hazard types from fieldOptions
					if (companyData.fieldOptions['hazard-type']) {
						const hazardTypes = companyData.fieldOptions['hazard-type']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('hazardType', hazardTypes);
						console.log('✅ Loaded hazard types from fieldOptions:', hazardTypes);
					}
					
					// Load risk categories from fieldOptions  
					if (companyData.fieldOptions['risk-category']) {
						const riskCategories = companyData.fieldOptions['risk-category']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('riskCategory', riskCategories);
						console.log('✅ Loaded risk categories from fieldOptions:', riskCategories);
						riskCategoriesLoaded = true;
					}
					
					// Load risk strategies from fieldOptions
					if (companyData.fieldOptions['risk-strategy']) {
						const riskStrategies = companyData.fieldOptions['risk-strategy']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('riskStrategy', riskStrategies);
						console.log('✅ Loaded risk strategies from fieldOptions:', riskStrategies);
					}
				}
				
				// Fallback: Try formFields structure if fieldOptions not available
				else if (companyData.formFields) {
					// Load hazard types from form fields
					if (companyData.formFields['hazard-type']) {
						const hazardTypes = companyData.formFields['hazard-type']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('hazardType', hazardTypes);
					}
					
					// Load risk categories from form fields  
					if (companyData.formFields['risk-category'] && !riskCategoriesLoaded) {
						const riskCategories = companyData.formFields['risk-category']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('riskCategory', riskCategories);
						console.log('✅ Loaded risk categories from formFields fallback:', riskCategories);
						riskCategoriesLoaded = true;
					}
					
					// Load risk strategies from form fields
					if (companyData.formFields['risk-strategy']) {
						const riskStrategies = companyData.formFields['risk-strategy']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('riskStrategy', riskStrategies);
					}
				}
				
				// Direct fetch from fieldOptions path if not found in company data
				if (!companyData.fieldOptions) {
					console.log('🔄 Trying direct fetch from fieldOptions path...');
					try {
						const fieldOptionsRef = firebase.database().ref(`companies/${currentUser.companyId}/fieldOptions`);
						const fieldOptionsSnapshot = await fieldOptionsRef.once('value');
						const fieldOptions = fieldOptionsSnapshot.val();
						
						if (fieldOptions) {
							console.log('✅ Direct fieldOptions loaded:', fieldOptions);
							
							// Load departments
							if (fieldOptions['department'] && !departmentsLoaded) {
								const departments = fieldOptions['department']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('department', departments);
								console.log('✅ Loaded departments from direct fetch:', departments);
							}
							
							// Load locations (try area first, then location)
							if (fieldOptions['area'] && !locationsLoaded) {
								const locations = fieldOptions['area']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('location', locations);
								console.log('✅ Loaded locations from direct fetch fieldOptions/area:', locations);
							} else if (fieldOptions['location'] && !locationsLoaded) {
								const locations = fieldOptions['location']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('location', locations);
								console.log('✅ Loaded locations from direct fetch fieldOptions/location:', locations);
							}
							
							// Load hazard types
							if (fieldOptions['hazard-type']) {
								const hazardTypes = fieldOptions['hazard-type']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('hazardType', hazardTypes);
								console.log('✅ Loaded hazard types from direct fetch:', hazardTypes);
							}
							
							// Load risk categories
							if (fieldOptions['risk-category'] && !riskCategoriesLoaded) {
								const riskCategories = fieldOptions['risk-category']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('riskCategory', riskCategories);
								console.log('✅ Loaded risk categories from direct fetch:', riskCategories);
							}
							
							// Load risk categories
							if (fieldOptions['risk-category']) {
								const riskCategories = fieldOptions['risk-category']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('riskCategory', riskCategories);
								console.log('✅ Loaded risk categories from direct fetch:', riskCategories);
							}
							
							// Load risk strategies
							if (fieldOptions['risk-strategy']) {
								const riskStrategies = fieldOptions['risk-strategy']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('riskStrategy', riskStrategies);
								console.log('✅ Loaded risk strategies from direct fetch:', riskStrategies);
							}
						} else {
							console.warn('❌ No fieldOptions found at direct path');
						}
					} catch (directFetchError) {
						console.error('❌ Error in direct fieldOptions fetch:', directFetchError);
					}
				}
				
				// Fallback: Load from legacy fieldSetup structure if formFields not available
				if (!companyData.fieldOptions && !companyData.formFields && companyData.fieldSetup?.risk) {
					const riskSetup = companyData.fieldSetup.risk;
					if (riskSetup.riskCategories && !riskCategoriesLoaded) {
						populateDropdown('riskCategory', riskSetup.riskCategories);
						console.log('✅ Loaded risk categories from legacy fieldSetup:', riskSetup.riskCategories);
					}
					if (riskSetup.hazardTypes) {
						populateDropdown('hazardType', riskSetup.hazardTypes);
						console.log('✅ Loaded hazard types from legacy fieldSetup:', riskSetup.hazardTypes);
					}
				}

				// After all dropdowns filled, apply any pending selections from edit mode
				if (window._pendingSelectValues) {
					Object.entries(window._pendingSelectValues).forEach(([id, val]) => {
						const el = document.getElementById(id);
						if (el && [...el.options].some(o => o.value === val)) {
							el.value = val;
						}
					});
					// Clear pending once applied
					delete window._pendingSelectValues;
				}
			}
		} catch (error) {
			console.error('Error loading dropdown options:', error);
		}
	}
	
	function populateDropdown(fieldId, options) {
		const select = document.getElementById(fieldId);
		if (!select) return;
		
		// Clear existing options except the first one
		while (select.children.length > 1) {
			select.removeChild(select.lastChild);
		}
		
		// Add options
		if (Array.isArray(options)) {
			options.forEach(option => {
				const optionElement = document.createElement('option');
				
				// Handle different option formats
				if (typeof option === 'object' && option !== null) {
					// Object format: { value: 'key', label: 'Display Name' }
					optionElement.value = option.value || option.key || '';
					optionElement.textContent = option.label || option.name || option.value || option.key || '';
				} else {
					// Simple string format
					optionElement.value = option;
					optionElement.textContent = option;
				}
				
				select.appendChild(optionElement);
			});
		} else if (typeof options === 'object') {
			Object.entries(options).forEach(([key, value]) => {
				const optionElement = document.createElement('option');
				optionElement.value = key;
				optionElement.textContent = value.name || value || key;
				select.appendChild(optionElement);
			});
		}
	}
	
	async function handleFormSubmission(event) {
		event.preventDefault();
		
		console.log('🚀 Form submission started');
		
		// Check Firebase initialization
		if (!window.firebase || !window.db || !window.storage) {
			console.error('❌ Firebase not properly initialized');
			alert('System not ready. Please refresh the page and try again.');
			return;
		}
		
		const currentUser = window.authManager?.currentUser;
		if (!currentUser?.companyId) {
			console.error('❌ No user session or company ID found');
			alert('No user session found. Please log in again.');
			return;
		}
		
		console.log('👤 Current user:', {
			uid: currentUser.uid,
			companyId: currentUser.companyId,
			email: currentUser.email
		});
		
		// Show loading state
		const submitBtn = document.getElementById('submitBtn');
		const originalBtnText = submitBtn.innerHTML;
		submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
		submitBtn.disabled = true;
		
		try {
			// Collect form data
			const formData = collectFormData();
			
			// Validate required fields
			if (!validateForm(formData)) {
				submitBtn.innerHTML = originalBtnText;
				submitBtn.disabled = false;
				return;
			}
			
			// Upload files if any are selected
			const fileInput = document.getElementById('attachments');
			let attachments = {};
			
			// Start with existing attachments if in edit mode
			if (window.isEditingRisk && window._existingAttachments) {
				attachments = { ...window._existingAttachments };
			}
			
			// Upload new files if selected
			if (fileInput && fileInput.files.length > 0) {
				submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt fa-spin"></i> Uploading files...';
				console.log('🔄 Uploading', fileInput.files.length, 'files...');
				
				const uploadPromises = Array.from(fileInput.files).map(async (file, index) => {
					try {
						console.log(`📤 Starting upload for file ${index + 1}:`, file.name);
						
						// Update status to uploading
						updateFileStatus(index, 'uploading', 'Uploading...');
						
						const fileName = `${Date.now()}_${file.name}`;
						const riskId = window.editingRiskId || 'temp_' + Date.now();
						const filePath = `companies/${currentUser.companyId}/risks/${riskId}/attachments/${fileName}`;
						
						console.log(`📂 Upload path:`, filePath);
						
						// Upload to Firebase Storage
						const storageRef = firebase.storage().ref(filePath);
						
						// Create upload task with progress monitoring
						const uploadTask = storageRef.put(file);
						
						// Monitor upload progress
						uploadTask.on('state_changed', 
							(snapshot) => {
								const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
								console.log(`📊 Upload progress for ${file.name}: ${Math.round(progress)}%`);
								updateFileStatus(index, 'uploading', `Uploading... ${Math.round(progress)}%`);
							},
							(error) => {
								console.error('❌ Upload error for file:', file.name, error);
								updateFileStatus(index, 'error', 'Upload failed');
								throw error; // Re-throw to be caught in the outer try-catch
							}
						);
						
						// Wait for upload completion
						const uploadResult = await uploadTask;
						const downloadURL = await uploadResult.ref.getDownloadURL();
						
						console.log('✅ File uploaded successfully:', file.name, 'URL:', downloadURL);
						
						// Update status to uploaded
						updateFileStatus(index, 'uploaded', 'Uploaded');
						
						// Create Firebase-safe key by encoding problematic characters
						const firebaseSafeKey = file.name
							.replace(/\./g, '_DOT_')
							.replace(/#/g, '_HASH_')
							.replace(/\$/g, '_DOLLAR_')
							.replace(/\//g, '_SLASH_')
							.replace(/\[/g, '_LBRACKET_')
							.replace(/\]/g, '_RBRACKET_');
						
						// Store both the safe key and original filename for display
						attachments[firebaseSafeKey] = {
							url: downloadURL,
							originalName: file.name,
							uploadedAt: new Date().toISOString(),
							uploadedBy: currentUser.uid
						};
						
						console.log('💾 Added to attachments with safe key:', firebaseSafeKey, attachments[firebaseSafeKey]);
						
						return { success: true, fileName: file.name, url: downloadURL, safeKey: firebaseSafeKey };
					} catch (error) {
						console.error('❌ Failed to upload file:', file.name, error);
						updateFileStatus(index, 'error', `Upload failed: ${error.message}`);
						return { success: false, fileName: file.name, error: error.message };
					}
				});
				
				console.log('⏳ Waiting for all file uploads to complete...');
				const uploadResults = await Promise.all(uploadPromises);
				const failedUploads = uploadResults.filter(result => !result.success);
				
				if (failedUploads.length > 0) {
					console.warn('⚠️ Some files failed to upload:', failedUploads);
					const failedNames = failedUploads.map(f => f.fileName).join(', ');
					if (!confirm(`Some files failed to upload: ${failedNames}. Continue anyway?`)) {
						submitBtn.innerHTML = originalBtnText;
						submitBtn.disabled = false;
						return;
					}
				}
				
				console.log('📎 Final attachments object:', attachments);
			}
			
			// Add attachments to form data
			if (Object.keys(attachments).length > 0) {
				formData.attachments = attachments;
			}
			
			submitBtn.innerHTML = '<i class="fas fa-database fa-spin"></i> Saving...';
			
			// Check if we're in edit mode
			if (window.isEditingRisk && window.editingRiskId) {
				console.log('📝 Updating existing risk:', window.editingRiskId);
				
				// Update existing risk - first fetch current to preserve immutable fields
				const riskRef = firebase.database().ref(`companies/${currentUser.companyId}/risks/${window.editingRiskId}`);
				let existing = {};
				try {
					console.log('🔍 Fetching existing risk data...');
					const snap = await riskRef.once('value');
					if (snap.exists()) {
						existing = snap.val();
						console.log('✅ Existing risk data loaded:', existing);
					} else {
						console.warn('⚠️ Risk not found in database:', window.editingRiskId);
					}
				} catch(fetchErr){ 
					console.warn('⚠️ Could not fetch existing risk for preservation', fetchErr); 
				}
				
				const riskData = {
					...existing, // start with existing so we keep submittedBy, submittedAt, approval data etc.
					...formData,  // overwrite editable form fields
					id: window.editingRiskId,
					riskID: formData.riskID || existing.riskID, // Preserve Risk ID from form or existing data
					updatedAt: new Date().toISOString(),
					updatedBy: currentUser.uid,
					companyId: currentUser.companyId
				};
				
				console.log('💾 Saving updated risk data:', riskData);
				await riskRef.set(riskData);
				console.log('✅ Risk updated successfully');
				
				// Clear edit data from localStorage
				localStorage.removeItem('riskEditData');
				
				// Show success message
				window.notificationManager?.addNotification({
					type: 'Success',
					message: 'Risk assessment updated successfully!'
				});
				
				// Redirect to dashboard
				setTimeout(() => {
					window.location.href = 'riskboard.html';
				}, 1500);
				
			} else {
				console.log('➕ Creating new risk');
				
				// Create new risk
				const riskRef = firebase.database().ref(`companies/${currentUser.companyId}/risks`).push();
				
				const riskData = {
					...formData,
					id: riskRef.key,
					riskID: formData.riskID, // Preserve the generated Risk ID from the form
					submittedBy: currentUser.uid,
					submittedAt: new Date().toISOString(),
					status: 'pending',
					companyId: currentUser.companyId
				};
				
				console.log('💾 Saving new risk data:', riskData);
				await riskRef.set(riskData);
				console.log('✅ New risk created successfully:', riskRef.key);
				
				// Show success message
				window.notificationManager?.addNotification({
					type: 'Success',
					message: 'Risk report submitted successfully!'
				});
				
				// Redirect to dashboard
				setTimeout(() => {
					window.location.href = 'riskboard.html';
				}, 1500);
			}
			
		} catch (error) {
			console.error('❌ Error submitting risk report:', error);
			console.error('❌ Error details:', {
				message: error.message,
				code: error.code,
				stack: error.stack,
				currentUser: currentUser,
				isEditMode: window.isEditingRisk,
				editingRiskId: window.editingRiskId
			});
			
			// Provide more specific error messages
			let errorMessage = 'Error submitting risk report. ';
			if (error.code === 'PERMISSION_DENIED') {
				errorMessage += 'Permission denied. Please check your access rights.';
			} else if (error.message?.includes('storage')) {
				errorMessage += 'File upload failed. Please try again.';
			} else if (error.message?.includes('database')) {
				errorMessage += 'Database error. Please check your connection.';
			} else {
				errorMessage += `Details: ${error.message || 'Unknown error'}`;
			}
			
			alert(errorMessage);
			submitBtn.innerHTML = originalBtnText;
			submitBtn.disabled = false;
		}
	}
	
	function collectFormData() {
		const form = document.getElementById('riskForm');
		const formData = new FormData(form);
		const data = {};
		
		// Collect basic form fields
		for (let [key, value] of formData.entries()) {
			// Skip the file input since we handle attachments separately
			if (key !== 'attachments') {
				data[key] = value;
			}
		}
		
		// Collect controls
		const controls = [];
		document.querySelectorAll('#existingControlsList .control-item input').forEach(input => {
			if (input.value.trim()) {
				controls.push(input.value.trim());
			}
		});
		data.controls = controls;
		
		// Collect actions
		const actions = [];
		document.querySelectorAll('#actionsList .control-item input').forEach(input => {
			if (input.value.trim()) {
				actions.push(input.value.trim());
			}
		});
		data.actions = actions;
		
		// Note: attachments are handled separately in handleFormSubmission
		return data;
	}
	
	function validateForm(data) {
		const required = ['riskTitle', 'hazard', 'hazardType', 'riskCategory', 'department', 'location', 'dateIdentified', 'description', 'inherentLikelihood', 'inherentImpact', 'riskStrategy', 'residualLikelihood', 'residualImpact'];
		
		console.log('🔍 Validating form data:', data);
		
		for (let field of required) {
			const value = data[field];
			console.log(`📋 Checking field '${field}':`, value);
			
			if (!value || value.trim() === '') {
				console.error(`❌ Validation failed for field: ${field}`);
				alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.`);
				document.getElementById(field)?.focus();
				return false;
			}
		}
		
		console.log('✅ All required fields validated successfully');
		return true;
	}
	
	// Make functions globally accessible
	window.updateControlNumbers = updateControlNumbers;
	window.updateActionNumbers = updateActionNumbers;
	</script>
</body>
</html>
