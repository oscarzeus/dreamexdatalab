<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Risk Submission - Dreamex Datalab HSE</title>
	<!-- Firebase v8 CDN (match other pages) -->
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
	<!-- EmailJS for notifications -->
	<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<meta name="robots" content="noindex, nofollow">
	<style>
		/* === Core Variables / Layout (derived from accessboard.html) === */
		:root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --orange:#e67e22; --red:#e74c3c; --purple:#9b59b6; --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem; --font-scale:1; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333; --text-secondary:#666; --border-color:#e0e0e0; --spacing-unit:.9rem; --padding-sm:.45rem; --padding-md:.75rem; --padding-lg:1.2rem; --transition-speed:.2s; }
		*{margin:0;padding:0;box-sizing:border-box;} body{font-family:var(--font-family);font-size:var(--base-font-size);line-height:1.4;color:var(--text-primary);background:#f8f9fa;}
		.app-container{display:flex;min-height:100vh;}
		.sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;height:100vh;overflow-y:auto;transition:transform .3s ease;}
		.sidebar.collapsed{transform:translateX(-100%);} .logo h2{text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.05rem;letter-spacing:.5px;}
		.menu{list-style:none;margin-top:2rem;} .menu li{margin-bottom:0.5rem;} .menu a{color:#fff;text-decoration:none;display:flex;align-items:center;padding:0.75rem 1rem;border-radius:5px;font-size:0.82rem;font-weight:500;gap:10px;transition:background .25s;} .menu a:hover,.menu a.active{background:var(--secondary-color);} .menu-dropdown .submenu{display:none;list-style:none;margin-left:2rem;margin-top:0.5rem;} .menu-dropdown:hover .submenu{display:block;} .submenu a{font-size:0.75rem;padding:0.45rem 0.65rem;}
		/* Feature-based visibility */
		[data-feature]:not(.menu-visible){display:none !important;} .menu-dropdown:not(.menu-visible){display:none !important;} 
		
		/* Hide ALL menu items by default during loading */
		.sidebar.menu-loading .menu-item, .sidebar.menu-loading .menu-dropdown, .sidebar.menu-loading li[data-feature], .sidebar.menu-loading [data-feature] {display:none !important;} .menu-loading [data-feature]{display:none !important;} .menu-loading .menu-dropdown{display:none !important;}
		.main-content{flex:1;margin-left:var(--sidebar-width);padding:.45rem;width:calc(100% - var(--sidebar-width));box-sizing:border-box;display:flex;flex-direction:column;transition:margin-left .3s ease,width .3s ease;}
		.main-content.sidebar-collapsed{margin-left:0;width:100%;}
		/* Top Nav (copied style approach from accessboard.html) */
		.top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:.35rem;position:fixed;top:.25rem;right:.5rem;left:calc(var(--sidebar-width) + .5rem);height:50px;min-height:50px;z-index:100;transition:left .3s ease;}
		.top-nav-left{display:flex;align-items:center;gap:1rem;font-size:.8rem;font-weight:600;color:var(--text-secondary);} .sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;padding:.45rem;color:#666;border-radius:6px;display:flex;align-items:center;justify-content:center;} .sidebar-toggle-btn:hover{background:rgba(0,0,0,.06);}
		#headerCompanyLogo{width:44px;height:44px;border-radius:6px;object-fit:contain;display:none;} #headerCompanyLogo.visible{display:block;} #headerCompanyName{font-size:.8rem;font-weight:600;letter-spacing:.5px;color:var(--primary-color);max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
		.top-nav-right{display:flex;align-items:center;gap:1.2rem;margin-left:auto;}
		.notifications{position:relative;display:flex;align-items:center;} .notification-btn{background:none;border:none;cursor:pointer;position:relative;font-size:1.1rem;padding:.45rem;display:flex;align-items:center;justify-content:center;} .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--accent-color);color:#fff;border-radius:50%;padding:.15rem .45rem;font-size:.6rem;}
		.notification-dropdown{display:none;position:absolute;right:0;top:100%;width:280px;background:#fff;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,.12);z-index:1000;}
		.notification-dropdown.show{display:block;} .notification-list{max-height:280px;overflow-y:auto;}
		.profile-btn{background:none;border:none;cursor:pointer;padding:.25rem;display:flex;align-items:center;position:relative;} 
		.profile-btn img{width:40px;height:40px;border-radius:50%;object-fit:cover;}
		.avatar-initials{width:40px;height:40px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px;font-family:Arial,sans-serif;}
		.profile-dropdown{display:none;position:absolute;top:100%;right:0;background:#fff;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,.12);min-width:200px;z-index:1000;} .profile-dropdown.show{display:block;} .profile-dropdown ul{list-style:none;margin:0;padding:0;} .profile-dropdown ul li a{display:flex;align-items:center;padding:12px 16px;color:#333;text-decoration:none;font-size:.78rem;gap:.6rem;transition:background .2s;} .profile-dropdown ul li a:hover{background:#f5f7fa;}
		.avatar-initials{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1rem;}
		/* Page Header */
		.page-header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;padding:.55rem .75rem;border-radius:0;margin:.35rem 0 .5rem 0;display:flex;align-items:center;justify-content:space-between;box-shadow:0 10px 28px rgba(0,0,0,.18),0 6px 16px rgba(0,0,0,.14);font-size:.9rem;}
		.page-header i{font-size:1rem;}
		/* Content styles */
		.content{padding:.45rem;flex:1;}
		.content-header{margin-bottom:1.5rem;}
		.content-header h1{font-size:1.8rem;color:var(--primary-color);margin-bottom:.5rem;}
		
		/* Risk Form Specific Styles */
		.form-row {
			display: flex;
			flex-wrap: wrap;
			gap: .75rem;
			margin: 0;
			width: 100%;
		}

		/* Make all form-group items equal width */
		.form-row .form-group {
			flex: 1 1 0;
			min-width: 120px;
		}
        
        .col-md-3 {
            flex: 0 0 25%;
            max-width: 25%;
            padding-right: 15px;
            padding-left: 15px;
        }
        
        .form-control.risk-extreme { background-color: #dc3545; color: white; }
        .form-control.risk-high { background-color: #fd7e14; color: white; }
        .form-control.risk-medium { background-color: #ffc107; color: black; }
        .form-control.risk-low { background-color: #28a745; color: white; }
        
        #existingControlsList, #actionsList {
            margin-bottom: 10px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .control-number {
            min-width: 30px;
            text-align: center;
        }
        
        .delete-control-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
        }
        
        /* Corrective Actions Styles (matching incident.html) */
        .corrective-actions-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .corrective-actions-header h4{margin:0;font-size:1rem;color:var(--primary-color)}
        .btn-add-action{background:var(--primary-color);color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;gap:6px;transition:background .2s}
        .btn-add-action:hover{background:#1a252f}
        .corrective-action-item{background:#f8f9fa;border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin-bottom:12px;position:relative}
        .corrective-action-item .action-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .corrective-action-item .action-number{font-weight:600;color:var(--primary-color);font-size:.9rem}
        .btn-remove-action{background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:.8rem;display:flex;align-items:center;gap:4px}
        .btn-remove-action:hover{background:#c0392b}
        .corrective-action-item .form-row{margin-bottom:10px}
        .corrective-action-item .form-group{margin-bottom:0}
        .no-actions-msg{color:#666;font-style:italic;text-align:center;padding:20px}
        .search-container{position:relative}
        .search-dropdown{display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:4px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .search-dropdown.show{display:block}
        .search-dropdown-item{padding:8px 12px;cursor:pointer;font-size:.85rem}
        .search-dropdown-item:hover{background:#f0f0f0}
        
        /* Info tooltip button styles */
        .info-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: none;
            color: #3b82f6;
            font-size: 14px;
            cursor: pointer;
            border: none;
            margin-left: 4px;
            position: relative;
            vertical-align: middle;
            padding: 0;
        }
        .info-btn:hover {
            color: #1d4ed8;
        }
        .info-tooltip {
            display: none;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            color: #1a1a1a;
            padding: 0;
            border-radius: 0;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.5;
            width: 280px;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left;
            overflow: hidden;
        }
        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: #f8f9fa;
        }
        .info-btn:hover .info-tooltip,
        .info-btn:focus .info-tooltip {
            display: block;
        }
        .info-tooltip strong {
            display: block;
            padding: 12px 16px 8px;
            margin: 0;
            color: #1a1a1a;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.95);
            position: relative;
        }
        .info-tooltip strong::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 16px;
            width: 40px;
            height: 3px;
            background: #3b82f6;
            border-radius: 0;
        }
        .info-tooltip ul {
            margin: 0;
            padding: 12px 16px 12px 30px;
        }
        .info-tooltip li {
            margin-bottom: 4px;
            color: #4b5563;
        }
        /* Impact criteria table styles */
        .info-tooltip.wide-tooltip {
            width: 780px;
            left: 50%;
            transform: translateX(-50%);
            max-height: 450px;
            overflow: hidden;
        }
        .info-tooltip.wide-tooltip .tooltip-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 12px 16px 16px;
            scrollbar-width: thin;
            scrollbar-color: #ddd transparent;
        }
        .info-tooltip.wide-tooltip .tooltip-content::-webkit-scrollbar { width: 6px; }
        .info-tooltip.wide-tooltip .tooltip-content::-webkit-scrollbar-track { background: transparent; }
        .info-tooltip.wide-tooltip .tooltip-content::-webkit-scrollbar-thumb { background-color: #ddd; border-radius: 3px; }
        .info-tooltip.wide-tooltip .tooltip-content::-webkit-scrollbar-thumb:hover { background-color: #bbb; }
        .info-tooltip.wide-tooltip::after {
            left: 20px;
            transform: none;
        }
        .impact-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-top: 0;
            border-radius: 0;
            overflow: hidden;
        }
        .impact-table th, .impact-table td {
            border: 1px solid rgba(0, 0, 0, 0.08);
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        .impact-table th {
            background: #2c3e50;
            color: #fff;
            font-weight: 600;
            white-space: nowrap;
        }
        .impact-table td:first-child {
            font-weight: 600;
            white-space: nowrap;
            background: rgba(44, 62, 80, 0.1);
            color: #2c3e50;
        }
        .impact-table tr:nth-child(even) td:not(:first-child) {
            background: rgba(0, 0, 0, 0.02);
        }
        .impact-table tr:hover td {
            background: rgba(44, 62, 80, 0.08);
        }
        
        .no-controls-message {
            font-style: italic;
            color: #666;
            margin: 10px 0;
        }

        /* Full width form container styles */
        .form-container {
            background:#fff;
            padding:1.5rem;
            border-radius:8px;
            box-shadow:0 1px 3px rgba(0,0,0,.08);
            margin-bottom:1rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }
        
        .form-group label{
            display:block;
            margin-bottom:.5rem;
            font-weight:600;
            color:var(--text-primary);
            font-size:.85rem;
        }
        
        .form-group input, .form-group select, .form-group textarea{
            width:100%;
            padding:.65rem;
            border:1px solid var(--border-color);
            border-radius:6px;
            font-size:.85rem;
            transition:border-color .2s,box-shadow .2s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus{
            outline:none;
            border-color:var(--secondary-color);
            box-shadow:0 0 0 2px rgba(52,152,219,.1);
        }
        
        .form-group textarea{
            min-height:80px;
            resize:vertical;
        }
        
        .form-actions{
            display:flex;
            gap:.75rem;
            justify-content:flex-end;
            margin-top:2rem;
            padding-top:1.5rem;
            border-top:1px solid var(--border-color);
        }
        
        .btn{
            padding:.65rem 1.2rem;
            border:none;
            border-radius:6px;
            font-size:.85rem;
            font-weight:600;
            cursor:pointer;
            transition:all .2s;
            display:inline-flex;
            align-items:center;
            gap:.5rem;
            text-decoration:none;
        }
        
        .btn:hover{
            transform:translateY(-1px);
            box-shadow:0 2px 4px rgba(0,0,0,.1);
        }
        
        .btn-approve{
            background:var(--green);
            color:#fff;
        }
        
        .btn-approve:hover{
            background:#27ae60;
        }
        
        .btn{
            background:#6c757d;
            color:#fff;
        }
        
        .btn:hover{
            background:#5a6268;
        }

        /* File input styling */
        .form-group input[type="file"] {
            padding: 0.5rem;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: #fafafa;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            align-items: center;
        }
        
        .form-group input[type="file"]:hover {
            border-color: var(--secondary-color);
            background: #f0f8ff;
        }
        
        .form-group input[type="file"]:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52,152,219,.1);
        }
        
        /* File list styling */
        #fileList {
            margin-top: 0.75rem;
        }
        
        .selected-file {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.35rem 0;
            padding: 0.4rem 0.55rem;
            border: 1px solid #d4edda;
            border-radius: 4px;
            background: #d1ecf1;
            transition: background-color 0.2s;
        }
        
        .selected-file i {
            color: #0c5460;
        }
        
        .selected-file .file-name {
            flex: 1;
            font-size: 0.75rem;
            color: #0c5460;
            font-weight: 500;
        }
        
        .selected-file .file-size {
            font-size: 0.7rem;
            color: #6c757d;
        }
        
        .remove-file-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .remove-file-btn:hover {
            background: rgba(220, 53, 69, 0.1);
        }
        
        .existing-attachment {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.35rem 0;
            padding: 0.4rem 0.55rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background: #fafafa;
            transition: background-color 0.2s;
        }
        
        .existing-attachment:hover {
            background: #f0f8ff;
        }
        
        .existing-attachment i {
            color: #3498db;
        }
        
        .existing-attachment a {
            flex: 1;
            text-decoration: none;
            color: #2563eb;
            font-size: 0.75rem;
            word-break: break-all;
        }
        
        .existing-attachment a:hover {
            text-decoration: underline;
        }
        
        .attachments-header {
            margin-top: 0.5rem;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 0.5rem;
        }
        
        .attachments-header i {
            color: var(--secondary-color);
        }

        .file-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .file-status.pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .file-status.uploading {
            background-color: #cce5ff;
            color: #0066cc;
            border: 1px solid #99d3ff;
        }

        .file-status.uploaded {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .file-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .no-files-message {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            margin-top: 0.5rem;
        }

        .no-files-message i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #adb5bd;
        }

        .no-files-message p {
            margin: 0;
            font-size: 0.9rem;
        }

        /* Better responsive styling for the form */
        @media (max-width: 768px) {
            .col-md-3 {
                flex: 0 0 100%;
                max-width: 100%;
            }
            .main-content{margin-left:0;width:100%;}
            .sidebar{position:fixed;z-index:1500;}
            .top-nav{left:.5rem;}
            .sidebar.collapsed{transform:translateX(-100%);}
        }
	</style>
</head>
<body>
	<div class="app-container">
		<!-- Sidebar (copied from accessboard.html with risk menu active) -->
		<nav class="sidebar menu-loading" id="sidebar">
			<div class="logo"><h2>Dreamex Datalab</h2></div>
			<ul class="menu" id="roleBasedMenu">
            <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view">
				<a href="#"><i class="fas fa-medkit"></i> Health</a>
				<ul class="submenu">
					<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
					<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
					<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
				</ul>
			</li>
            <!-- Risk Management (separate section) -->
            <li class="menu-dropdown active" data-feature="risk_view" data-requires-permission="risk_view">
                <a href="#" class="active"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
            <ul class="submenu">
                <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
            </ul>
            </li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
				<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
				<ul class="submenu">
					<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
					<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
					<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
					<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
					<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
					<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
				<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
				<ul class="submenu">
					<li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
					<li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
					<li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
				<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
				<ul class="submenu">
                    <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                    <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="environment_view">
				<a href="#"><i class="fas fa-leaf"></i> Environment</a>
				<ul class="submenu">
                    <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
				<a href="#"><i class="fas fa-lock"></i> Security</a>
				<ul class="submenu">
                    <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
						<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
				<a href="#"><i class="fas fa-truck"></i> Logistics</a>
				<ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
				<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
				<ul class="submenu">
					<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
				<a href="#"><i class="fas fa-users"></i> HR</a>
				<ul class="submenu">
					<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
					<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
					<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
					<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
					<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
					<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
					<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
					<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                    <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
					<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
					<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
					<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                    <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
				</ul>
			</li>
            <!-- Project Management as section button with submenu -->
            <li class="menu-dropdown" data-feature="project_management_section">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                </ul>
            </li>
            <!-- Inventory Management as section button with submenu -->
            <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                <ul class="submenu">
                    <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                    <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                    <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                    <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                </ul>
            </li>
            <!-- Workspaces: Catering -->
            <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
                <a href="#"><i class="fas fa-utensils"></i> Workspaces — Catering</a>
                <ul class="submenu">
                    <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
                    <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
                    <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
                    <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
                    <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                </ul>
            </li>
            <li data-feature="requests_view" data-requires-permission="requests_view"><a href="tickboard.html"><i class="fas fa-ticket-alt"></i> Requests</a></li>
            <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view">
				<a href="#"><i class="fas fa-cog"></i> Settings</a>
				<ul class="submenu">
                    <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                    <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
				</ul>
			</li>
		</ul>
		</nav>
		<!-- Main Content -->
		<main class="main-content">
			<header class="top-nav">
				<div class="top-nav-left">
					<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
					<img id="headerCompanyLogo" alt="Company Logo">
					<span id="headerCompanyName"></span>
				</div>
				<div class="top-nav-right">
					<div class="lang-switcher" style="display:flex;align-items:center;gap:.5rem;">
						<button id="langToggleBtn" type="button" title="Language" aria-label="Language"
							style="width:36px;height:36px;border-radius:50%;border:1px solid #e5e7eb;background:#ffffff;color:#111827;display:inline-flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;box-shadow:0 1px 2px rgba(0,0,0,0.06);cursor:pointer;transition:background .15s,transform .05s;">
							EN
						</button>
						<select id="langSelect" title="Language" style="display:none;">
							<option value="en">English</option>
							<option value="fr">Français</option>
						</select>
					</div>
					<div class="notifications">
						<button id="notificationBtn" class="notification-btn" aria-label="Notifications"><i class="fas fa-bell"></i><span class="notification-badge" style="display:none;">0</span></button>
						<div class="notification-dropdown">
							<div style="padding:.75rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
								<strong style="font-size:.7rem;color:#2c3e50;">Notifications</strong>
								<button class="mark-all-read" style="background:none;border:none;font-size:.6rem;color:var(--secondary-color);cursor:pointer;">Mark all read</button>
							</div>
							<div class="notification-list"></div>
						</div>
					</div>
					<div class="user-profile">
						<button id="userProfileBtn" class="profile-btn" aria-label="Profile">
							<img id="userAvatarImg" src="" alt="User Avatar" style="display: none;">
							<div id="userInitials" class="avatar-initials">U</div>
						</button>
						<div class="profile-dropdown"><ul></ul></div>
					</div>
				</div>
			</header>
			<div style="padding-top:3.4rem;"></div>
			<div class="page-header">
				<div style="display: flex; align-items: center; gap: 0.6rem;">
					<i class="fas fa-exclamation-triangle"></i>
					<span>Submit Risk Report</span>
				</div>
				<button type="button" class="btn-add-new" onclick="window.location.href='riskboard.html'" title="View Risk Dashboard">
					<i class="fas fa-table"></i>
				</button>
			</div>

			<!-- Form Content -->
			<div class="content">
				<div class="form-container">
					<form id="riskForm">
						<!-- Row 1: Risk ID, Hazard, Hazard Type, Risk Title -->
						<div class="form-row" style="gap:.75rem;">
							<div class="form-group">
								<label for="riskID">Risk ID</label>
								<input type="text" id="riskID" name="riskID" readonly>
							</div>
							<div class="form-group">
								<label for="hazard">Hazard*</label>
								<input type="text" id="hazard" name="hazard" required>
							</div>
							<div class="form-group">
								<label for="hazardType">Hazard Type*</label>
								<select id="hazardType" name="hazardType" required>
									<option value="">Select Hazard Type</option>
								</select>
							</div>
							<div class="form-group">
								<label for="riskTitle">Risk Title*</label>
								<input type="text" id="riskTitle" name="riskTitle" required>
							</div>
						</div>
						


						<!-- Row 3: Risk Category, Department, Date Identified -->
						<div class="form-row" style="gap:.75rem;">
							<div class="form-group">
								<label for="riskCategory">Risk Category*</label>
								<select id="riskCategory" name="riskCategory" required>
									<option value="">Select Risk Category</option>
								</select>
							</div>
							<div class="form-group">
								<label for="department">Department*</label>
								<select id="department" name="department" required>
									<option value="">Select Department</option>
								</select>
							</div>
							<div class="form-group">
								<label for="dateIdentified">Date Identified*</label>
								<input type="date" id="dateIdentified" name="dateIdentified" required>
							</div>
							<div class="form-group">
								<label for="requestor">Requestor</label>
								<input type="text" id="requestor" name="requestor" class="form-control" required readonly>
							</div>
						</div>

						<!-- Row 4: Location, Latitude, Longitude, GPS Button -->
						<div class="form-row" style="gap:.75rem;">
							<div class="form-group">
								<label for="location">Location*</label>
								<select id="location" name="location" required>
									<option value="">Select Location</option>
								</select>
							</div>
							<div class="form-group">
								<label for="latitude">Latitude (optional)</label>
								<input type="number" id="latitude" name="latitude" step="0.000001" min="-90" max="90" placeholder="e.g., 25.276987">
							</div>
							<div class="form-group">
								<label for="longitude">Longitude (optional)</label>
								<input type="number" id="longitude" name="longitude" step="0.000001" min="-180" max="180" placeholder="e.g., 55.296249">
							</div>
							<div class="form-group" style="display:flex;align-items:flex-end;">
								<label>&nbsp;</label>
								<button type="button" id="useCurrentLocationBtn" class="btn" title="Use current browser location" style="width:100%;"><i class="fas fa-location-crosshairs"></i> GPS</button>
							</div>
						</div>

						<!-- Row 5: Description (full width) -->
						<div class="form-group">
							<label for="description">Risk Description*</label>
							<textarea id="description" name="description" required></textarea>
						</div>                        
						


						<h3>Inherent Risk Assessment (Before Controls)</h3>
						<div class="form-row" style="gap:.75rem;">
							<div class="form-group">
								<label for="inherentLikelihood"><span class="label-text">Likelihood*</span>
									<button type="button" class="info-btn" title="Likelihood criteria">
										<i class="fas fa-info-circle"></i>
										<div class="info-tooltip">
											<strong>Likelihood Criteria</strong>
											<ul>
												<li><b>1 - Rare:</b> Once in 10+ years</li>
												<li><b>2 - Unlikely:</b> Once in 5-10 years</li>
												<li><b>3 - Possible:</b> Once in 1-5 years</li>
												<li><b>4 - Likely:</b> Once per year or more</li>
												<li><b>5 - Almost Certain:</b> Multiple times per year</li>
											</ul>
										</div>
									</button>
								</label>
								<select id="inherentLikelihood" name="inherentLikelihood" required>
									<option value="">Select</option>
									<option value="1">1 - Rare</option>
									<option value="2">2 - Unlikely</option>
									<option value="3">3 - Possible</option>
									<option value="4">4 - Likely</option>
									<option value="5">5 - Almost Certain</option>
								</select>
							</div>
							<div class="form-group">
								<label for="inherentImpact"><span class="label-text">Impact*</span>
									<button type="button" class="info-btn" title="Impact criteria">
										<i class="fas fa-info-circle"></i>
										<div class="info-tooltip wide-tooltip">
											<strong>Impact Criteria Matrix</strong>
											<div class="tooltip-content">
											<table class="impact-table">
												<thead>
													<tr>
														<th>Level</th>
														<th>Health & Safety</th>
														<th>Environment</th>
														<th>Financial</th>
														<th>Reputation</th>
														<th>Legal/Compliance</th>
														<th>Operational</th>
														<th>Community</th>
													</tr>
												</thead>
												<tbody>
													<tr>
														<td>1 - Negligible</td>
														<td>No injury</td>
														<td>No impact</td>
														<td>&lt;$10K</td>
														<td>No media</td>
														<td>No breach</td>
														<td>&lt;1 hr downtime</td>
														<td>No effect</td>
													</tr>
													<tr>
														<td>2 - Minor</td>
														<td>First aid only</td>
														<td>Minor spill, contained</td>
														<td>$10K - $100K</td>
														<td>Local complaint</td>
														<td>Minor non-compliance</td>
														<td>1-4 hrs downtime</td>
														<td>Minor nuisance</td>
													</tr>
													<tr>
														<td>3 - Moderate</td>
														<td>Medical treatment</td>
														<td>Moderate spill, remediation</td>
														<td>$100K - $1M</td>
														<td>Local media</td>
														<td>Regulatory warning</td>
														<td>1 day downtime</td>
														<td>Formal complaints</td>
													</tr>
													<tr>
														<td>4 - Major</td>
														<td>Hospitalization</td>
														<td>Major spill, long-term</td>
														<td>$1M - $10M</td>
														<td>National media</td>
														<td>Prosecution, fines</td>
														<td>1 week downtime</td>
														<td>Community protest</td>
													</tr>
													<tr>
														<td>5 - Catastrophic</td>
														<td>Fatality/disability</td>
														<td>Ecosystem damage</td>
														<td>&gt;$10M</td>
														<td>Int'l media, inquiry</td>
														<td>License revoked</td>
														<td>&gt;1 month downtime</td>
														<td>Widespread outrage</td>
													</tr>
												</tbody>
											</table>
											</div>
										</div>
									</button>
								</label>
								<select id="inherentImpact" name="inherentImpact" required>
									<option value="">Select</option>
									<option value="1">1 - Negligible</option>
									<option value="2">2 - Minor</option>
									<option value="3">3 - Moderate</option>
									<option value="4">4 - Major</option>
									<option value="5">5 - Catastrophic</option>
								</select>
							</div>
							<div class="form-group">
								<label for="inherentRating">Rating</label>
								<input type="text" id="inherentRating" readonly>
							</div>
							<div class="form-group">
								<label for="inherentLevel">Risk Level</label>
								<input type="text" id="inherentLevel" readonly>
							</div>
						</div>

						<h3>Controls and Mitigation</h3>
						<div class="form-group">
							<label for="riskStrategy">Risk Strategy*</label>
							<select id="riskStrategy" name="riskStrategy" required>
								<option value="">Select Strategy</option>
								<option value="avoid">Avoid</option>
								<option value="transfer">Transfer</option>
								<option value="mitigate">Mitigate</option>
								<option value="accept">Accept</option>
							</select>
						</div>

						<div class="form-group">
							<label>Existing Controls</label>
							<div id="existingControlsList"></div>
							<button type="button" class="btn btn-secondary" id="addControlBtn">
								<i class="fas fa-plus"></i> Add Control
							</button>
						</div>

<!-- Corrective Actions Dynamic Section -->
										<div class="corrective-actions-section">
											<div class="corrective-actions-header">
												<h4><i class="fas fa-tasks"></i> Action Plan</h4>
												<button type="button" class="btn-add-action" id="addActionBtn">
													<i class="fas fa-plus"></i> Add Action
												</button>
											</div>
											<div id="actionsList">
												<div class="no-actions-msg">No actions added. Click "Add Action" to create one.</div>
											</div>
						</div>

						<h3>Residual Risk Assessment (After Controls)</h3>
						<div class="form-row" style="gap:.75rem;">
							<div class="form-group">
								<label for="residualLikelihood">Likelihood</label>
								<select id="residualLikelihood" name="residualLikelihood">
									<option value="">Select</option>
									<option value="1">1 - Rare</option>
									<option value="2">2 - Unlikely</option>
									<option value="3">3 - Possible</option>
									<option value="4">4 - Likely</option>
									<option value="5">5 - Almost Certain</option>
								</select>
							</div>
							<div class="form-group">
								<label for="residualImpact">Impact</label>
								<select id="residualImpact" name="residualImpact">
									<option value="">Select</option>
									<option value="1">1 - Negligible</option>
									<option value="2">2 - Minor</option>
									<option value="3">3 - Moderate</option>
									<option value="4">4 - Major</option>
									<option value="5">5 - Catastrophic</option>
								</select>
							</div>
							<div class="form-group">
								<label for="residualRating">Rating</label>
								<input type="text" id="residualRating" readonly>
							</div>
							<div class="form-group">
								<label for="residualLevel">Risk Level</label>
								<input type="text" id="residualLevel" readonly>
							</div>
						</div>

						<div class="form-group">
							<label for="attachments">
								<i class="fas fa-paperclip"></i> Attachments
							</label>
							<input type="file" id="attachments" name="attachments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif">
							<small style="color: #666; font-size: 0.75rem; margin-top: 0.25rem; display: block;">
								Choose files to upload (PDF, Word, Excel, Images). You can select multiple files.
							</small>
							<div id="fileList"></div>
						</div>

						<div class="form-actions">
							<button type="button" id="resetBtn" class="btn">Reset</button>
							<button type="button" class="btn" onclick="window.location.href='riskboard.html'">Cancel</button>
							<button type="submit" id="submitBtn" class="btn btn-approve">Submit Risk Report</button>
						</div>
					</form>
				</div>
			</div>
		</main>
	</div>	<!-- Utility: Sidebar persistence -->
	<script>
		function toggleSidebar(){
			const sb=document.querySelector('.sidebar');
			const mc=document.querySelector('.main-content');
			const top=document.querySelector('.top-nav');
			if(!sb||!mc)return;
			const collapsed=sb.classList.toggle('collapsed');
			mc.classList.toggle('sidebar-collapsed',collapsed);
			if(top){ top.style.left= collapsed? '.5rem': 'calc(var(--sidebar-width) + .5rem)'; }
			localStorage.setItem('sidebarCollapsed',collapsed);
		}
		function restoreSidebarState(){
			const collapsed=localStorage.getItem('sidebarCollapsed')==='true';
			const sb=document.querySelector('.sidebar');
			const mc=document.querySelector('.main-content');
			const top=document.querySelector('.top-nav');
			if(collapsed && sb && mc){ sb.classList.add('collapsed'); mc.classList.add('sidebar-collapsed'); if(top){top.style.left='.5rem';} }
		}
		document.addEventListener('DOMContentLoaded',()=>{
			restoreSidebarState();
			document.getElementById('sidebarToggle')?.addEventListener('click',toggleSidebar);
		});
	</script>
	<!-- Core Logic -->
	<script>
	/**************** Firebase Initialization ****************/ (function(){ const firebaseConfig={ apiKey:"AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc", authDomain:"users-8be65.firebaseapp.com", databaseURL:"https://users-8be65-default-rtdb.firebaseio.com", projectId:"users-8be65", storageBucket:"users-8be65.firebasestorage.app", messagingSenderId:"829083030831", appId:"1:829083030831:web:36a370e62691e560bc3dda" }; if(!window.firebase?.apps?.length){ firebase.initializeApp(firebaseConfig); console.log('✅ Firebase initialized (risk form)'); } window.db=firebase.database(); window.auth=firebase.auth(); window.storage=firebase.storage(); })();

	/**************** Notification Manager (light) ****************/ class NotificationManager{ constructor(){this.notifications=this.load();this.init();} load(){try{return JSON.parse(localStorage.getItem('notifications')||'[]');}catch{return[];}} save(){localStorage.setItem('notifications',JSON.stringify(this.notifications));this.updateBadge();this.render();} addNotification(n){this.notifications.unshift({id:Date.now(),timestamp:new Date().toISOString(),read:false,...n});this.save();} init(){this.bindUI();this.updateBadge();this.render();if(this.notifications.length===0){this.addNotification({type:'System',message:'Welcome to Risk Management'});} } bindUI(){const btn=document.getElementById('notificationBtn'); if(btn){btn.onclick=()=>document.querySelector('.notification-dropdown')?.classList.toggle('show');} document.addEventListener('click',e=>{if(!e.target.closest('.notifications')) document.querySelector('.notification-dropdown')?.classList.remove('show');}); const mark=document.querySelector('.mark-all-read'); if(mark){mark.onclick=()=>{this.notifications.forEach(n=>n.read=true); this.save();};}} updateBadge(){const badge=document.querySelector('.notification-badge'); if(!badge)return; const unread=this.notifications.filter(n=>!n.read).length; badge.textContent=unread; badge.style.display= unread? 'inline-block':'none';} render(){const list=document.querySelector('.notification-list'); if(!list)return; list.innerHTML=''; if(this.notifications.length===0){ list.innerHTML='<div style="padding:.9rem;font-size:.65rem;">No notifications</div>'; return;} this.notifications.slice(0,25).forEach(n=>{ const d=new Date(n.timestamp); const div=document.createElement('div'); div.className='notification-item'+(n.read?' read':''); div.style.cssText='padding:.65rem .75rem;border-bottom:1px solid #eee;font-size:.62rem;cursor:pointer;'+(n.read?'opacity:.6;':''); div.innerHTML=`<div style="display:flex;justify-content:space-between;font-weight:600;margin-bottom:2px;"><span>${n.type||'Info'}</span><span style="font-weight:400;color:#555;">${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span></div><div style="line-height:1.2;">${n.message||''}</div>`; div.onclick=()=>{n.read=true; this.save(); if(n.link) location.href=n.link;}; list.appendChild(div); }); }} window.notificationManager=new NotificationManager();

	/**************** EmailJS Configuration for Risk Notifications ****************/
	const RISK_EMAILJS_CONFIG = {
		publicKey: 'fHs6oaqQgkcPoUwpv',
		serviceId: 'service_p2e9swy',
		templateId: 'template_zreahgt'
	};

	// Initialize EmailJS
	if (typeof emailjs !== 'undefined') {
		emailjs.init(RISK_EMAILJS_CONFIG.publicKey);
		console.log('✅ EmailJS initialized for risk notifications');
	}

	// Send risk notification email
	async function sendRiskNotificationEmail(companyId, risk, isUpdate = false) {
		if (!companyId || !risk) return;
		
		try {
			// Try server-side function first (production-safe)
			try {
				const projectId = firebase.app().options.projectId || 'users-8be65';
				const endpoint = `https://us-central1-${projectId}.cloudfunctions.net/sendRiskNotification`;
				const notificationType = isUpdate ? 'update' : 'submission';
				const resp = await fetch(endpoint, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ companyId, risk, notificationType })
				});
				if (resp.ok) {
					const data = await resp.json();
					console.log('✅ Server-side risk notification response:', data);
					if (data && data.success && (data.sent || 0) > 0) {
						return; // done
					}
					console.warn('Server responded but did not send any emails; falling back to client EmailJS');
				} else {
					console.warn('Server send failed, falling back to client EmailJS:', await resp.text());
				}
			} catch (srvErr) {
				console.warn('Server function call failed, using client EmailJS:', srvErr);
			}

			// Check if notifications are enabled for this action
			const settingsSnap = await firebase.database().ref(`companies/${companyId}/riskSettings/notifications`).once('value');
			const settings = settingsSnap.val() || {};
			
			// Check if notification should be sent based on submission/update setting
			const settingKey = isUpdate ? 'riskOnUpdate' : 'riskOnSubmission';
			const isEnabled = isUpdate ? (settings[settingKey] === true) : (settings[settingKey] !== false);
			
			if (!isEnabled) {
				console.log(`Risk notifications disabled for ${isUpdate ? 'updates' : 'submissions'}`);
				return;
			}
			
			// Get recipients from notification settings (keep name + email for Outlook template)
			const recipients = settings.riskRecipients || {};
			const recipientList = Object.values(recipients)
				.map(r => ({ email: r?.email || '', name: r?.name || 'Risk Management Team' }))
				.filter(r => !!r.email);

			const byEmail = new Map();
			for (const r of recipientList) {
				if (!byEmail.has(r.email)) byEmail.set(r.email, r.name);
			}

			// Add corrective action owners (responsibleId) to recipients
			try {
				const actions = Array.isArray(risk.correctiveActions)
					? risk.correctiveActions
					: (risk.correctiveActions ? Object.values(risk.correctiveActions) : []);
				for (const action of actions) {
					const uid = action?.responsibleId;
					if (!uid) continue;
					try {
						const userSnap = await firebase.database().ref(`companies/${companyId}/users/${uid}`).once('value');
						const u = userSnap.val();
						if (u?.email && !byEmail.has(u.email)) {
							const nm = u?.name || `${u?.firstName || ''} ${u?.lastName || ''}`.trim() || 'Risk Action Owner';
							byEmail.set(u.email, nm);
							console.log('Added action owner to notification recipients:', u.email);
						}
					} catch (err) {
						console.warn('Could not fetch action owner for notification:', err);
					}
				}
			} catch (err) {
				console.warn('Error processing corrective action recipients:', err);
			}
			
			// Also add the risk owner (responsible person) to the notification list
			if (risk.riskOwner) {
				try {
					const ownerSnap = await firebase.database().ref(`companies/${companyId}/users/${risk.riskOwner}`).once('value');
					const ownerUser = ownerSnap.val();
					if (ownerUser && ownerUser.email && !byEmail.has(ownerUser.email)) {
						const nm = ownerUser?.name || `${ownerUser?.firstName || ''} ${ownerUser?.lastName || ''}`.trim() || 'Risk Owner';
						byEmail.set(ownerUser.email, nm);
						console.log('Added risk owner to notification recipients:', ownerUser.email);
					}
				} catch (err) {
					console.warn('Could not fetch risk owner for notification:', err);
				}
			}
			
			// Always add submitter (matches incident-style behavior)
			try {
				if (risk.submittedBy) {
					const submitterSnap = await firebase.database().ref(`companies/${companyId}/users/${risk.submittedBy}`).once('value');
					const submitter = submitterSnap.val();
					if (submitter?.email && !byEmail.has(submitter.email)) {
						const nm = submitter?.name || `${submitter?.firstName || ''} ${submitter?.lastName || ''}`.trim() || 'Submitter';
						byEmail.set(submitter.email, nm);
						console.log('Added submitter to notification recipients:', submitter.email);
					}
				}
			} catch (fbErr) {
				console.warn('Submitter recipient fetch failed:', fbErr);
			}

			const emails = Array.from(byEmail.keys());
			if (emails.length === 0) {
				console.log('No notification recipients available for risks');
				return;
			}
			
			// Get company info
			const companySnap = await firebase.database().ref(`companies/${companyId}`).once('value');
			const company = companySnap.val() || {};
			const companyName = company.companyName || 'Company';
			
			if (typeof emailjs === 'undefined') {
				console.warn('EmailJS not loaded, cannot send notification');
				return;
			}

			console.log('Preparing to send risk email notifications:', {
				notificationType: isUpdate ? 'update' : 'submission',
				enabled: isEnabled,
				recipientCount: emails.length,
				riskId: risk.riskID || risk.id
			});
			
			// Send to each recipient individually
			for (const email of emails) {
				try {
					const reporterName = risk.reportedByName || risk.submittedByName || 'HSE System';
					const riskDate = risk.date || risk.submittedAt?.split('T')[0] || new Date().toLocaleDateString();
					const refNumber = risk.riskID || risk.id || 'N/A';
					const riskRating = risk.riskRating || risk.inherentRiskRating || 'Not Assessed';
					
					// Determine action text based on submission/update
					const actionText = isUpdate ? 'has been updated' : 'has been submitted';
					const subjectPrefix = isUpdate ? 'Updated' : 'New';
					const notificationContext = isUpdate ? 'Risk Assessment Update Notification' : 'New Risk Assessment Notification';
					
					// Format message
					const messageBody = `Dear Risk Management Team,

${isUpdate ? 'An existing' : 'A new'} risk assessment ${actionText} and requires your attention.

RISK DETAILS:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Risk ID: ${refNumber}
Title: ${risk.riskTitle || risk.title || 'Untitled'}
Category: ${risk.riskCategory || 'Not specified'}
Department: ${risk.department || 'Not specified'}
Location: ${risk.location || 'Not specified'}
Risk Rating: ${riskRating}
Status: ${risk.status || (isUpdate ? 'Updated' : 'Pending')}
Date: ${riskDate}
Reported By: ${reporterName}

DESCRIPTION:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${risk.riskDescription || risk.description || 'No description provided'}

${risk.hazardDescription ? `HAZARD DESCRIPTION:\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n${risk.hazardDescription}\n\n` : ''}${risk.existingControls ? `EXISTING CONTROLS:\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n${risk.existingControls}\n\n` : ''}Please review this risk assessment through the HSE System and take appropriate action.

Review Link: ${window.location.origin}/riskboard.html

Best regards,
${companyName} HSE System

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
This is an automated notification from the HSE Management System.
If you have questions, please contact your HSE department.`;

					// EmailJS template variables
					const emailData = {
						to_email: email,
						to_name: byEmail.get(email) || 'Risk Management Team',
						from_name: companyName + ' HSE System',
						subject: `[Risk Alert] ${subjectPrefix} Risk Assessment: ${risk.riskTitle || risk.title || 'Untitled'} - ${refNumber}`,
						message: messageBody,
						position_title: `Risk: ${risk.riskTitle || risk.title || 'Untitled'}`,
						position_code: refNumber,
						department: risk.department || 'Risk Management',
						requesting_manager: reporterName,
						request_date: riskDate,
						employment_type: 'Risk Assessment',
						work_location: risk.location || 'Not specified',
						working_hours: riskDate,
						contract_duration: riskRating,
						reporting_manager: reporterName,
						budget_code: refNumber,
						salary_min: riskRating,
						salary_max: risk.status || (isUpdate ? 'Updated' : 'Pending'),
						annual_budget_impact: 'Risk Assessment',
						benefits_package: risk.department || 'HSE',
						department_budget: isUpdate ? 'Risk Updated' : 'New Risk',
						current_stage: '1',
						total_stages: '1',
						approver_role: 'Risk Reviewer',
						approval_type: 'Review Required',
						notification_context: notificationContext,
						business_need: risk.riskDescription || risk.description || 'No description provided',
						key_responsibilities: risk.existingControls || 'Review and assess risk controls',
						required_skills: `Location: ${risk.location || 'Not specified'}`,
						required_experience: `Risk Rating: ${riskRating}`,
						priority_level: risk.riskRating === 'High' || risk.riskRating === 'Extreme' ? 'high' : 'medium',
						approval_link: `${window.location.origin}/riskboard.html`,
						system_link: `${window.location.origin}/riskboard.html`,
						company_name: companyName,
						company_email: 'info@dreamexdatalab.com',
						company_initial: companyName.charAt(0).toUpperCase(),
						hr_email: 'hse@dreamexdatalab.com',
						budget_team_email: 'hse@dreamexdatalab.com',
						request_id: refNumber,
						generation_timestamp: new Date().toLocaleString(),
						submission_date: riskDate,
						risk_id: refNumber,
						risk_title: risk.riskTitle || risk.title || 'Untitled',
						risk_category: risk.riskCategory || 'Not specified',
						risk_rating: riskRating,
						risk_description: risk.riskDescription || risk.description || 'No description provided',
						risk_status: risk.status || (isUpdate ? 'Updated' : 'Pending'),
						risk_location: risk.location || 'Not specified',
						risk_department: risk.department || 'Not specified',
						risk_reporter: reporterName,
						hazard_description: risk.hazardDescription || 'N/A',
						existing_controls: risk.existingControls || 'N/A',
						is_update: isUpdate ? 'Yes' : 'No',
						event_action: isUpdate ? 'Updated' : 'New Submission'
					};
					
					const response = await emailjs.send(RISK_EMAILJS_CONFIG.serviceId, RISK_EMAILJS_CONFIG.templateId, emailData);
					console.log('Risk notification sent to:', email, response);
				} catch (err) {
					console.error('Failed to send risk notification to:', email, err);
				}
			}
			
			console.log(`Risk notification emails sent for ${isUpdate ? 'update' : 'submission'}`);
		} catch (error) {
			console.error('Error sending risk notification:', error);
		}
	}

	/**************** AuthManager (adapted from accessboard.html) ****************/ class AuthManager{ constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; console.log('🔐 AuthManager(init) risk form'); this.initializeAuth(); }
		getCurrentUser(){ try{return JSON.parse(localStorage.getItem('currentUser')||'null');}catch{return null;} }
		setCurrentUser(u){ localStorage.setItem('currentUser',JSON.stringify(u)); localStorage.setItem('user',JSON.stringify(u)); this.currentUser=u; }
		async logout(){ try{ await firebase.auth().signOut(); }catch(e){ console.warn('Logout error',e);} ['currentUser','user'].forEach(k=>{localStorage.removeItem(k);sessionStorage.removeItem(k);}); location.href='index.html'; }
		initializeAuth(){ 
			if(!this.currentUser){ 
				console.warn('No user -> redirect login'); 
				location.href='login.html'; 
				return; 
			} 
			console.log('✅ User:',this.currentUser.email); 
			this.loadUserRole(this.currentUser); 
			this.loadUserCompany(); 
			this.updateUIForAuthenticatedUser(); 
			this.updateMenuVisibility(); 
			this.bindProfileDropdown(); 
		}
		bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn && dd){ btn.addEventListener('click',e=>{e.stopPropagation(); dd.classList.toggle('show');}); document.addEventListener('click',e=>{ if(!btn.contains(e.target)) dd.classList.remove('show');}); const logoutLink=dd.querySelector('a[href="#"]:has(.fa-sign-out-alt)')||dd.querySelector('.fa-sign-out-alt')?.closest('a'); if(logoutLink){ logoutLink.addEventListener('click',e=>{e.preventDefault(); this.logout();}); } } }
		resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=>d.classList.remove('menu-visible')); }
		async updateMenuVisibility(){ 
			console.log('🎯 Starting feature-based menu authorization for risk form...');
			const sidebar=document.querySelector('.sidebar'); 
			if(!this.currentUser){ 
				this.resetMenuVisibility(); 
				sidebar?.classList.remove('menu-loading');
				return; 
			} 
			const companyId=this.currentUser.companyId; 
			const userRole=this.currentUser.role; 
			console.log('👤 User:', this.currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
			if(!companyId){ 
				this.resetMenuVisibility(); 
				sidebar?.classList.remove('menu-loading');
				return; 
			} 
			// STEP 1: Apply company feature-based authorization
			console.log('🏢 STEP 1: Applying company feature authorization...');
			const authorizedPages = await this.applyFeatureBasedMenuVisibility(companyId);
			
			// STEP 2: Filter by user role permissions within authorized features
			if (userRole && authorizedPages && authorizedPages.length > 0) {
				console.log('👤 STEP 2: Applying role-based filtering within authorized features...');
				await this.applyRoleBasedFiltering(companyId, userRole, authorizedPages);
			} else {
				console.log('⚠️ STEP 2: Skipping role-based filtering (no role found or no authorized pages)');
				sidebar?.classList.remove('menu-loading');
			}
		}
		async applyFeatureBasedMenuVisibility(companyId){ 
			try{ 
				console.log('🔧 Applying feature-based menu visibility for company:', companyId);
				const database=firebase.database(); 
				const featuresSnapshot=await database.ref('/platformFeatures').once('value'); 
				if(!featuresSnapshot.exists()){ 
					console.log('⚠️ No platform features found');
					this.resetMenuVisibility(); 
					return [];
				} 
				const featuresData=featuresSnapshot.val(); 
				const companySnapshot=await database.ref(`/companies/${companyId}`).once('value'); 
				const companyData=companySnapshot.val(); 
				if(!companyData){ 
					console.error('❌ Company data not found');
					this.resetMenuVisibility(); 
					return [];
				} 
				const subscribed=companyData.selectedFeatures||[]; 
				console.log('🏢 Company subscribed features:', subscribed);
				if (subscribed.length === 0) {
					console.log('⚠️ Company has no subscribed features');
					this.resetMenuVisibility();
					return [];
				}
				const authorizedPages=[]; 
				subscribed.forEach(fid=>{
					const f=featuresData[fid]; 
					if(f && f.status==='active' && f.authorizedPages) {
						console.log(`📦 Adding pages from feature "${f.name}":`, f.authorizedPages);
						authorizedPages.push(...f.authorizedPages);
					} else {
						console.log(`⚠️ Feature ${fid} not found or inactive`);
					}
				}); 
				console.log('🔐 All authorized pages from company features:', authorizedPages);
				const authorizedFeatures=new Set(); 
				const authorizedHrefs=new Set();
				const featureAlias=(k)=>{
					if(!k) return k;
					if(k==='risk_view') return 'risk_management_section';
					if(k==='risk_management_section') return 'risk_view';
					return null;
				};
				const normalizeHref=(href)=>{
					if(!href) return '';
					try{ const u=new URL(href, window.location.origin); return (u.pathname||'').replace(/^\//,''); }catch{ return String(href).replace(/^\//,''); }
				};
				authorizedPages.forEach(p=>{ 
					if(p.feature) { authorizedFeatures.add(p.feature); const a=featureAlias(p.feature); if(a) authorizedFeatures.add(a);} 
					if(p.href) authorizedHrefs.add(normalizeHref(p.href));
					if(p.page) authorizedHrefs.add(normalizeHref(p.page));
					if(p.url) authorizedHrefs.add(normalizeHref(p.url));
				}); 
				console.log('🎯 Authorized features for risk form:', Array.from(authorizedFeatures));
				console.log('🔗 Authorized hrefs for risk form:', Array.from(authorizedHrefs));
				this.resetMenuVisibility(); 
				let visibleCount = 0;
				document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(item=>{ 
					const feature=item.getAttribute('data-feature'); 
					const isDropdownContainer = item.classList.contains('menu-dropdown');
					const anchor=item.querySelector('a[href]');
					const href=anchor?anchor.getAttribute('href'):'';
					const normalized=normalizeHref(href);
					const isAuthorized = authorizedFeatures.has(feature) || (normalized && authorizedHrefs.has(normalized));
					
					if (isDropdownContainer) {
						return; // Handle dropdowns separately after all items are processed
					}
					
					if(isAuthorized){ 
						item.classList.add('menu-visible'); 
						visibleCount++;
						console.log(`✅ Authorized - showing: feature=${feature} href=${normalized||'—'}`);
					} else {
						console.log(`❌ Not authorized - hiding: feature=${feature} href=${normalized||'—'}`);
					}
				}); 
				// Handle dropdown menus - show if they have visible children
				document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{ 
					const feature=drop.getAttribute('data-feature'); 
					const hasVisible=[...drop.querySelectorAll('.submenu li[data-feature]')].some(li=>li.classList.contains('menu-visible')); 
					if(hasVisible || authorizedFeatures.has(feature)) {
						drop.classList.add('menu-visible'); 
						console.log(`✅ Showing dropdown menu: ${feature} (has visible children or directly authorized)`);
					} else {
						console.log(`❌ Hiding dropdown menu: ${feature} (no visible children and not authorized)`);
					}
				}); 
				console.log(`🎯 Company feature authorization completed - ${visibleCount} items initially visible`);
				// Return authorized pages for role-based filtering
				return authorizedPages;
			}catch(e){ 
				console.error('❌ Error applying feature-based menu visibility:', e); 
				this.resetMenuVisibility(); 
				return [];
			} 
		}
		
		// Apply role-based filtering within company authorized features
		async applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
			try {
				console.log('👤 Applying role-based filtering for role:', userRole);
				
				// Get user role permissions from company
				const database = firebase.database();
				const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
				const permissionsSnapshot = await permissionsRef.once('value');
				
				if (!permissionsSnapshot.exists()) {
					console.log(`⚠️ No permissions found for role ${userRole} in company ${companyId}`);
					
					// CRITICAL: If user is administrator but no permissions found, provide full access as fallback
					if (userRole === 'administrator') {
						console.log('🔑 ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
						this.showSidebarAfterAuth();
						return;
					}
					
					// For other roles without permissions, hide all items with permission requirements
					console.log('❌ No valid permissions found - filtering out items requiring permissions');
					this.hideItemsRequiringPermissions();
					this.showSidebarAfterAuth();
					return;
				}
				
				const permissions = permissionsSnapshot.val();
				console.log('✅ Loaded role permissions:', permissions);
				
				// Apply permission-based filtering
				this.filterMenuByPermissions(permissions);
				
			} catch (error) {
				console.error('❌ Error applying role-based filtering:', error);
				// Don't hide everything on error - keep company features visible
				this.showSidebarAfterAuth();
			}
		}

		// Filter menu items by role permissions (can add visibility and honors aliases)
		filterMenuByPermissions(permissions) {
			console.log('🔍 Filtering menu items by role permissions (add-visibility enabled)...');
			if (!permissions) {
				console.log('⚠️ No permissions object provided');
				this.hideItemsRequiringPermissions();
				this.showSidebarAfterAuth();
				return;
			}

			// Support alias between risk_view and risk_management_section
			const hasView = (permKey) => {
				if (!permKey) return false;
				const p = permissions[permKey];
				const direct = p === true || (p && p.view === true);
				if (direct) return true;
				if (permKey === 'risk_view') {
					const a = permissions['risk_management_section'];
					return a === true || (a && a.view === true);
				}
				if (permKey === 'risk_management_section') {
					const a = permissions['risk_view'];
					return a === true || (a && a.view === true);
				}
				return false;
			};

			let changedCount = 0;
			// Evaluate ALL permission-gated items, not just those already visible
			const permItems = document.querySelectorAll('#roleBasedMenu li[data-requires-permission]');
			permItems.forEach(item => {
				const requiresPermission = item.getAttribute('data-requires-permission');
				const feature = item.getAttribute('data-feature');
				const allowed = hasView(requiresPermission);
				if (allowed) {
					if (!item.classList.contains('menu-visible')) {
						item.classList.add('menu-visible');
						changedCount++;
						console.log(`✅ Showing by permission: feature=${feature} requires=${requiresPermission}`);
					} else {
						console.log(`✅ Keeping visible by permission: feature=${feature} requires=${requiresPermission}`);
					}
				} else {
					if (item.classList.contains('menu-visible')) {
						item.classList.remove('menu-visible');
						changedCount++;
						console.log(`❌ Hiding (no permission): feature=${feature} requires=${requiresPermission}`);
					}
				}
			});

			// Re-check dropdown menus after permission filtering: show if has visible children OR dropdown itself permitted
			document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(dropdown => {
				const dropdownFeature = dropdown.getAttribute('data-feature');
				const dropdownPerm = dropdown.getAttribute('data-requires-permission');
				const hasVisibleChildren = dropdown.querySelectorAll('.submenu li.menu-visible').length > 0;
				const dropdownAllowed = hasView(dropdownPerm);
				if (hasVisibleChildren || dropdownAllowed) {
					dropdown.classList.add('menu-visible');
					console.log(`✅ Dropdown visible: ${dropdownFeature} (children=${hasVisibleChildren} perm=${dropdownPerm||'—'})`);
				} else {
					dropdown.classList.remove('menu-visible');
					console.log(`❌ Dropdown hidden: ${dropdownFeature} (no visible children and no dropdown permission)`);
				}
			});

			console.log(`🎯 Role-based filtering completed - ${changedCount} items changed by permissions`);
			this.showSidebarAfterAuth();
		}

		// Hide menu items that require permissions (for users without role permissions)
		hideItemsRequiringPermissions() {
			console.log('🔒 Hiding all menu items that require permissions...');
			
			const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			let hiddenCount = 0;
			
			itemsRequiringPermissions.forEach(item => {
				const feature = item.getAttribute('data-feature');
				const requiresPermission = item.getAttribute('data-requires-permission');
				
				item.classList.remove('menu-visible');
				hiddenCount++;
				console.log(`❌ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
			});
			
			console.log(`🔒 Hidden ${hiddenCount} items requiring permissions`);
		}

		// Show sidebar and remove loading state after authentication and filtering
		showSidebarAfterAuth() {
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
				console.log('✅ Sidebar loading state removed - menu authorization complete');
			}
		}
		
		async loadUserRole(user){ if(user.role||!user.uid) return; try{ const snap=await firebase.database().ref(`users/${user.uid}`).once('value'); if(snap.exists()){ user.role=snap.val().role||'user'; this.setCurrentUser(user);} }catch(e){ console.warn('Role load error',e);} }
		async loadUserCompany(){ 
			if(!this.currentUser) return; 
			try{ 
				const snap=await firebase.database().ref('companies').once('value'); 
				if(!snap.exists()) { 
					this.resetMenuVisibility(); 
					return;
				} 
				const companies=snap.val(); 
				for(const [cid,comp] of Object.entries(companies)){ 
					if(comp.status!=='active') continue; 
					if(comp.users){ 
						for(const [uid,u] of Object.entries(comp.users)){ 
							if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ 
								this.currentUser.companyId=cid; 
								this.currentUser.companyName=comp.companyName; 
								this.currentUser.role=u.role || u.userRole || 'user'; // Set user role from company user record
								this.currentCompany=comp; 
								this.setCurrentUser(this.currentUser); 
								console.log('✅ Found user in company:', cid, 'with role:', this.currentUser.role);
								this.updateCompanyBranding(); 
								await this.updateMenuVisibility(); 
								return; 
							}
						}
					} 
				} 
				this.resetMenuVisibility(); 
			}catch(e){ 
				console.error('Company load error',e); 
				this.resetMenuVisibility(); 
			} 
		}
		updateCompanyBranding(){ if(!this.currentCompany){ this.showFallbackBranding(); return;} const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.classList.add('visible'); } else { const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.src=svg; logoEl.classList.add('visible'); }} if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color',this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color',this.currentCompany.branding.secondaryColor); }}
		showFallbackBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); if(logoEl){ const svg=this.generateCompanyInitialsSVG('DX'); logoEl.src=svg; logoEl.classList.add('visible'); }} getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
		generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
		getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=> typeof v==='string'? v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){const cleaned=n(c); if(cleaned) return cleaned;} if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
		getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
		async getUserAvatarUrl(){ 
			if(!this.currentUser) return null; 
			const companyId = this.currentUser.companyId || 'default';
			try{ 
				const possiblePaths = [
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,
					`avatars/${this.currentUser.uid}/profile.jpg`,
					`avatars/${this.currentUser.uid}/profile.png`,
					`avatars/${this.currentUser.uid}/avatar.jpg`,
					`avatars/${this.currentUser.uid}/avatar.png`,
					`profiles/${this.currentUser.uid}/profile.jpg`,
					`profiles/${this.currentUser.uid}/profile.png`
				];
				
				for(const path of possiblePaths) {
					try {
						const ref = firebase.storage().ref(path);
						const url = await ref.getDownloadURL();
						console.log(`✅ Found profile picture at: ${path}`);
						return url;
					} catch(err) {
						continue;
					}
				}
				return null;
			} catch(error) { 
				console.error('Error getting user avatar:', error);
				return null; 
			}
		}
		async updateUIForAuthenticatedUser(){ 
			console.log('🔄 updateUIForAuthenticatedUser called');
			const btn=document.getElementById('userProfileBtn'); 
			const list=document.querySelector('.profile-dropdown ul'); 
			const userAvatarImg=document.getElementById('userAvatarImg');
			const userInitials=document.getElementById('userInitials');
			
			if(!btn||!list||!this.currentUser) return; 
			
			const displayName=this.getUserDisplayName(); 
			const email=this.currentUser.email||''; 
			
			// Set user initials first as fallback
			if(userInitials) {
				userInitials.textContent = this.getUserInitials();
			}
			
			// Try to get avatar URL
			let avatarUrl = null;
			try {
				avatarUrl = await this.getUserAvatarUrl();
			} catch(error) {
				console.error('❌ Error getting avatar URL:', error);
			}
			
			// Update header avatar display
			if(avatarUrl && userAvatarImg) { 
				userAvatarImg.src = avatarUrl; 
				userAvatarImg.alt = displayName + ' Avatar';
				userAvatarImg.style.display = 'block';
				if(userInitials) userInitials.style.display = 'none';
				
				// Handle image load error
				userAvatarImg.onerror = () => {
					userAvatarImg.style.display = 'none';
					if(userInitials) userInitials.style.display = 'flex';
				};
			} else { 
				if(userAvatarImg) userAvatarImg.style.display = 'none';
				if(userInitials) userInitials.style.display = 'flex';
			}
			
			// Update dropdown content
			const avatarHtml= avatarUrl? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`; 
			list.innerHTML=`<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`; 
			list.querySelector('#logoutLink')?.addEventListener('click',e=>{e.preventDefault(); this.logout();}); 
		}
	}
	window.authManager=new AuthManager();

	/**************** Risk Form Functionality ****************/
	// Basic form initialization
	document.addEventListener('DOMContentLoaded', function() {
		// Initialize form
		initializeRiskForm();
		
		// Check if we're in edit mode and load existing data
		loadEditDataIfPresent();
		
		// Set today's date as default (only if not editing)
		if (!isEditMode()) {
			document.getElementById('dateIdentified').value = new Date().toISOString().split('T')[0];
			// Auto-generate risk ID (only for new risks)
			generateRiskID();
		}
		
		// Set requestor name (only if not editing)
		if (!isEditMode()) {
			setRequestorName();
		}
		
		// Initialize risk calculations
		setupRiskCalculations();
		
		// Initialize dynamic lists
		initializeDynamicLists();
		
		// Form submission handler
		document.getElementById('riskForm').addEventListener('submit', handleFormSubmission);

		// Language toggle initialization
		(function initLangToggle(){
			const LANG_STORAGE_KEY = 'incidentboard_lang';
			const langBtn = document.getElementById('langToggleBtn');
			const langSelect = document.getElementById('langSelect');
			const getLang = () => {
				const stored = localStorage.getItem(LANG_STORAGE_KEY);
				return stored === 'fr' ? 'fr' : 'en';
			};
			const setLang = (lang) => {
				localStorage.setItem(LANG_STORAGE_KEY, lang);
				document.documentElement.setAttribute('lang', lang);
				if (langBtn) langBtn.textContent = lang === 'fr' ? 'FR' : 'EN';
				if (langSelect) langSelect.value = lang;
			};
			const current = getLang();
			setLang(current);
			if (langBtn){
				langBtn.addEventListener('mouseenter', ()=>{ langBtn.style.background = '#f9fafb'; });
				langBtn.addEventListener('mouseleave', ()=>{ langBtn.style.background = '#ffffff'; });
				langBtn.addEventListener('mousedown', ()=>{ langBtn.style.background = '#f3f4f6'; });
				langBtn.addEventListener('mouseup', ()=>{ langBtn.style.background = '#ffffff'; });
				langBtn.addEventListener('click', ()=>{
					const next = getLang() === 'en' ? 'fr' : 'en';
					setLang(next);
					window.dispatchEvent(new CustomEvent('languageChanged', { detail: { lang: next } }));
				});
			}
		})();

		// Translations dictionary
		const translations = {
			en: {
				pageTitle: 'Submit Risk Report',
				riskID: 'Risk ID',
				hazard: 'Hazard*',
				hazardType: 'Hazard Type*',
				selectHazardType: 'Select Hazard Type',
				riskTitle: 'Risk Title*',
				riskCategory: 'Risk Category*',
				selectRiskCategory: 'Select Risk Category',
				department: 'Department*',
				selectDepartment: 'Select Department',
				dateIdentified: 'Date Identified*',
				requestor: 'Requestor',
				location: 'Location*',
				selectLocation: 'Select Location',
				latitude: 'Latitude (optional)',
				longitude: 'Longitude (optional)',
				gps: 'GPS',
				description: 'Risk Description*',
				inherentTitle: 'Inherent Risk Assessment (Before Controls)',
				likelihood: 'Likelihood*',
				likelihoodResidual: 'Likelihood',
				impact: 'Impact*',
				impactResidual: 'Impact',
				rating: 'Rating',
				riskLevel: 'Risk Level',
				select: 'Select',
				rare: '1 - Rare',
				unlikely: '2 - Unlikely',
				possible: '3 - Possible',
				likely: '4 - Likely',
				almostCertain: '5 - Almost Certain',
				negligible: '1 - Negligible',
				minor: '2 - Minor',
				moderate: '3 - Moderate',
				major: '4 - Major',
				catastrophic: '5 - Catastrophic',
				controlsTitle: 'Controls and Mitigation',
				riskStrategy: 'Risk Strategy*',
				selectStrategy: 'Select Strategy',
				avoid: 'Avoid',
				transfer: 'Transfer',
				mitigate: 'Mitigate',
				accept: 'Accept',
				existingControls: 'Existing Controls',
				addControl: 'Add Control',
				actionPlan: 'Action Plan',
				addAction: 'Add Action',
				residualTitle: 'Residual Risk Assessment (After Controls)',
				attachments: 'Attachments',
				attachmentsHelp: 'Choose files to upload (PDF, Word, Excel, Images). You can select multiple files.',
				reset: 'Reset',
				cancel: 'Cancel',
				submit: 'Submit Risk Report',
				// Tooltip translations
				likelihoodCriteriaTitle: 'Likelihood Criteria',
				likelihood1: '1 - Rare:',
				likelihood1Desc: 'Once in 10+ years',
				likelihood2: '2 - Unlikely:',
				likelihood2Desc: 'Once in 5-10 years',
				likelihood3: '3 - Possible:',
				likelihood3Desc: 'Once in 1-5 years',
				likelihood4: '4 - Likely:',
				likelihood4Desc: 'Once per year or more',
				likelihood5: '5 - Almost Certain:',
				likelihood5Desc: 'Multiple times per year',
				impactCriteriaTitle: 'Impact Criteria Matrix',
				thLevel: 'Level',
				thHealthSafety: 'Health & Safety',
				thEnvironment: 'Environment',
				thFinancial: 'Financial',
				thReputation: 'Reputation',
				thLegal: 'Legal/Compliance',
				thOperational: 'Operational',
				thCommunity: 'Community',
				impact1Level: '1 - Negligible',
				impact1HS: 'No injury',
				impact1Env: 'No impact',
				impact1Fin: '<$10K',
				impact1Rep: 'No media',
				impact1Legal: 'No breach',
				impact1Op: '<1 hr downtime',
				impact1Com: 'No effect',
				impact2Level: '2 - Minor',
				impact2HS: 'First aid only',
				impact2Env: 'Minor spill, contained',
				impact2Fin: '$10K - $100K',
				impact2Rep: 'Local complaint',
				impact2Legal: 'Minor non-compliance',
				impact2Op: '1-4 hrs downtime',
				impact2Com: 'Minor nuisance',
				impact3Level: '3 - Moderate',
				impact3HS: 'Medical treatment',
				impact3Env: 'Moderate spill, remediation',
				impact3Fin: '$100K - $1M',
				impact3Rep: 'Local media',
				impact3Legal: 'Regulatory warning',
				impact3Op: '1 day downtime',
				impact3Com: 'Formal complaints',
				impact4Level: '4 - Major',
				impact4HS: 'Hospitalization',
				impact4Env: 'Major spill, long-term',
				impact4Fin: '$1M - $10M',
				impact4Rep: 'National media',
				impact4Legal: 'Prosecution, fines',
				impact4Op: '1 week downtime',
				impact4Com: 'Community protest',
				impact5Level: '5 - Catastrophic',
				impact5HS: 'Fatality/disability',
				impact5Env: 'Ecosystem damage',
				impact5Fin: '>$10M',
				impact5Rep: "Int'l media, inquiry",
				impact5Legal: 'License revoked',
				impact5Op: '>1 month downtime',
				impact5Com: 'Widespread outrage'
			},
			fr: {
				pageTitle: 'Soumettre un Rapport de Risque',
				riskID: 'ID du Risque',
				hazard: 'Danger*',
				hazardType: 'Type de Danger*',
				selectHazardType: 'Sélectionner le Type de Danger',
				riskTitle: 'Titre du Risque*',
				riskCategory: 'Catégorie de Risque*',
				selectRiskCategory: 'Sélectionner la Catégorie',
				department: 'Département*',
				selectDepartment: 'Sélectionner le Département',
				dateIdentified: 'Date d\'Identification*',
				requestor: 'Demandeur',
				location: 'Emplacement*',
				selectLocation: 'Sélectionner l\'Emplacement',
				latitude: 'Latitude (optionnel)',
				longitude: 'Longitude (optionnel)',
				gps: 'GPS',
				description: 'Description du Risque*',
				inherentTitle: 'Évaluation du Risque Inhérent (Avant Contrôles)',
				likelihood: 'Probabilité*',
				likelihoodResidual: 'Probabilité',
				impact: 'Impact*',
				impactResidual: 'Impact',
				rating: 'Note',
				riskLevel: 'Niveau de Risque',
				select: 'Sélectionner',
				rare: '1 - Rare',
				unlikely: '2 - Improbable',
				possible: '3 - Possible',
				likely: '4 - Probable',
				almostCertain: '5 - Presque Certain',
				negligible: '1 - Négligeable',
				minor: '2 - Mineur',
				moderate: '3 - Modéré',
				major: '4 - Majeur',
				catastrophic: '5 - Catastrophique',
				controlsTitle: 'Contrôles et Atténuation',
				riskStrategy: 'Stratégie de Risque*',
				selectStrategy: 'Sélectionner la Stratégie',
				avoid: 'Éviter',
				transfer: 'Transférer',
				mitigate: 'Atténuer',
				accept: 'Accepter',
				existingControls: 'Contrôles Existants',
				addControl: 'Ajouter un Contrôle',
				actionPlan: 'Plan d\'Action',
				addAction: 'Ajouter une Action',
				residualTitle: 'Évaluation du Risque Résiduel (Après Contrôles)',
				attachments: 'Pièces Jointes',
				attachmentsHelp: 'Choisir les fichiers à télécharger (PDF, Word, Excel, Images). Vous pouvez sélectionner plusieurs fichiers.',
				reset: 'Réinitialiser',
				cancel: 'Annuler',
				submit: 'Soumettre le Rapport de Risque',
				// Tooltip translations
				likelihoodCriteriaTitle: 'Critères de Probabilité',
				likelihood1: '1 - Rare:',
				likelihood1Desc: 'Une fois en 10+ ans',
				likelihood2: '2 - Improbable:',
				likelihood2Desc: 'Une fois en 5-10 ans',
				likelihood3: '3 - Possible:',
				likelihood3Desc: 'Une fois en 1-5 ans',
				likelihood4: '4 - Probable:',
				likelihood4Desc: 'Une fois par an ou plus',
				likelihood5: '5 - Presque Certain:',
				likelihood5Desc: 'Plusieurs fois par an',
				impactCriteriaTitle: 'Matrice des Critères d\'Impact',
				thLevel: 'Niveau',
				thHealthSafety: 'Santé & Sécurité',
				thEnvironment: 'Environnement',
				thFinancial: 'Financier',
				thReputation: 'Réputation',
				thLegal: 'Juridique/Conformité',
				thOperational: 'Opérationnel',
				thCommunity: 'Communauté',
				impact1Level: '1 - Négligeable',
				impact1HS: 'Aucune blessure',
				impact1Env: 'Aucun impact',
				impact1Fin: '<10K$',
				impact1Rep: 'Pas de média',
				impact1Legal: 'Aucune violation',
				impact1Op: '<1h d\'arrêt',
				impact1Com: 'Aucun effet',
				impact2Level: '2 - Mineur',
				impact2HS: 'Premiers soins',
				impact2Env: 'Déversement mineur, contenu',
				impact2Fin: '10K$ - 100K$',
				impact2Rep: 'Plainte locale',
				impact2Legal: 'Non-conformité mineure',
				impact2Op: '1-4h d\'arrêt',
				impact2Com: 'Nuisance mineure',
				impact3Level: '3 - Modéré',
				impact3HS: 'Traitement médical',
				impact3Env: 'Déversement modéré, remédiation',
				impact3Fin: '100K$ - 1M$',
				impact3Rep: 'Média local',
				impact3Legal: 'Avertissement réglementaire',
				impact3Op: '1 jour d\'arrêt',
				impact3Com: 'Plaintes formelles',
				impact4Level: '4 - Majeur',
				impact4HS: 'Hospitalisation',
				impact4Env: 'Déversement majeur, long terme',
				impact4Fin: '1M$ - 10M$',
				impact4Rep: 'Média national',
				impact4Legal: 'Poursuites, amendes',
				impact4Op: '1 semaine d\'arrêt',
				impact4Com: 'Protestation communautaire',
				impact5Level: '5 - Catastrophique',
				impact5HS: 'Décès/invalidité',
				impact5Env: 'Dommages écosystème',
				impact5Fin: '>10M$',
				impact5Rep: 'Média int\'l, enquête',
				impact5Legal: 'Licence révoquée',
				impact5Op: '>1 mois d\'arrêt',
				impact5Com: 'Indignation généralisée'
			}
		};

		// Apply translations function
		function applyRiskI18n() {
			const lang = localStorage.getItem('incidentboard_lang') === 'fr' ? 'fr' : 'en';
			const t = translations[lang];

			// Page header
			const pageHeaderSpan = document.querySelector('.page-header span');
			if (pageHeaderSpan) pageHeaderSpan.textContent = t.pageTitle;

			// Field labels
			document.querySelector('label[for="riskID"]').textContent = t.riskID;
			document.querySelector('label[for="hazard"]').textContent = t.hazard;
			document.querySelector('label[for="hazardType"]').textContent = t.hazardType;
			document.querySelector('label[for="riskTitle"]').textContent = t.riskTitle;
			document.querySelector('label[for="riskCategory"]').textContent = t.riskCategory;
			document.querySelector('label[for="department"]').textContent = t.department;
			document.querySelector('label[for="dateIdentified"]').textContent = t.dateIdentified;
			document.querySelector('label[for="requestor"]').textContent = t.requestor;
			document.querySelector('label[for="location"]').textContent = t.location;
			document.querySelector('label[for="latitude"]').textContent = t.latitude;
			document.querySelector('label[for="longitude"]').textContent = t.longitude;
			document.querySelector('label[for="description"]').textContent = t.description;

			// GPS button
			const gpsBtn = document.getElementById('useCurrentLocationBtn');
			if (gpsBtn) gpsBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i> ' + t.gps;

			// Section titles (h3)
			const h3s = document.querySelectorAll('#riskForm h3');
			if (h3s[0]) h3s[0].textContent = t.inherentTitle;
			if (h3s[1]) h3s[1].textContent = t.controlsTitle;
			if (h3s[2]) h3s[2].textContent = t.residualTitle;

			// Inherent assessment labels (preserve info button by updating span only)
			const inhLikLabel = document.querySelector('label[for="inherentLikelihood"] .label-text');
			if (inhLikLabel) inhLikLabel.textContent = t.likelihood + '*';
			const inhImpLabel = document.querySelector('label[for="inherentImpact"] .label-text');
			if (inhImpLabel) inhImpLabel.textContent = t.impact + '*';
			document.querySelector('label[for="inherentRating"]').textContent = t.rating;
			document.querySelector('label[for="inherentLevel"]').textContent = t.riskLevel;

			// Residual assessment labels
			document.querySelector('label[for="residualLikelihood"]').textContent = t.likelihoodResidual;
			document.querySelector('label[for="residualImpact"]').textContent = t.impactResidual;
			document.querySelector('label[for="residualRating"]').textContent = t.rating;
			document.querySelector('label[for="residualLevel"]').textContent = t.riskLevel;

			// Risk strategy
			document.querySelector('label[for="riskStrategy"]').textContent = t.riskStrategy;

			// Controls and Actions labels
			const controlsLabel = document.querySelector('#existingControlsList')?.previousElementSibling;
			if (controlsLabel && controlsLabel.tagName === 'LABEL') controlsLabel.textContent = t.existingControls;
			const actionsLabel = document.querySelector('#actionsList')?.previousElementSibling;
			if (actionsLabel && actionsLabel.tagName === 'LABEL') actionsLabel.textContent = t.actionPlan;

			// Buttons
			const addControlBtn = document.getElementById('addControlBtn');
			if (addControlBtn) addControlBtn.innerHTML = '<i class="fas fa-plus"></i> ' + t.addControl;
			const addActionBtn = document.getElementById('addActionBtn');
			if (addActionBtn) addActionBtn.innerHTML = '<i class="fas fa-plus"></i> ' + t.addAction;

			// Attachments
			const attachLabel = document.querySelector('label[for="attachments"]');
			if (attachLabel) attachLabel.innerHTML = '<i class="fas fa-paperclip"></i> ' + t.attachments;
			const attachHelp = document.querySelector('#attachments + small');
			if (attachHelp) attachHelp.textContent = t.attachmentsHelp;

			// Form action buttons
			const resetBtn = document.getElementById('resetBtn');
			if (resetBtn) resetBtn.textContent = t.reset;
			const cancelBtn = document.querySelector('.form-actions .btn:nth-child(2)');
			if (cancelBtn && cancelBtn.textContent.includes('Cancel')) cancelBtn.textContent = t.cancel;
			if (cancelBtn && cancelBtn.textContent.includes('Annuler')) cancelBtn.textContent = t.cancel;
			const submitBtn = document.getElementById('submitBtn');
			if (submitBtn) submitBtn.textContent = t.submit;

			// Select dropdowns - first options (placeholders)
			const hazardTypeSelect = document.getElementById('hazardType');
			if (hazardTypeSelect && hazardTypeSelect.options[0]) hazardTypeSelect.options[0].text = t.selectHazardType;
			const riskCategorySelect = document.getElementById('riskCategory');
			if (riskCategorySelect && riskCategorySelect.options[0]) riskCategorySelect.options[0].text = t.selectRiskCategory;
			const departmentSelect = document.getElementById('department');
			if (departmentSelect && departmentSelect.options[0]) departmentSelect.options[0].text = t.selectDepartment;
			const locationSelect = document.getElementById('location');
			if (locationSelect && locationSelect.options[0]) locationSelect.options[0].text = t.selectLocation;
			const riskStrategySelect = document.getElementById('riskStrategy');
			if (riskStrategySelect) {
				if (riskStrategySelect.options[0]) riskStrategySelect.options[0].text = t.selectStrategy;
				if (riskStrategySelect.options[1]) riskStrategySelect.options[1].text = t.avoid;
				if (riskStrategySelect.options[2]) riskStrategySelect.options[2].text = t.transfer;
				if (riskStrategySelect.options[3]) riskStrategySelect.options[3].text = t.mitigate;
				if (riskStrategySelect.options[4]) riskStrategySelect.options[4].text = t.accept;
			}

			// Likelihood/Impact options translation
			const likelihoodOpts = [t.select, t.rare, t.unlikely, t.possible, t.likely, t.almostCertain];
			const impactOpts = [t.select, t.negligible, t.minor, t.moderate, t.major, t.catastrophic];

			['inherentLikelihood', 'residualLikelihood'].forEach(id => {
				const sel = document.getElementById(id);
				if (sel) {
					for (let i = 0; i < sel.options.length && i < likelihoodOpts.length; i++) {
						sel.options[i].text = likelihoodOpts[i];
					}
				}
			});

			['inherentImpact', 'residualImpact'].forEach(id => {
				const sel = document.getElementById(id);
				if (sel) {
					for (let i = 0; i < sel.options.length && i < impactOpts.length; i++) {
						sel.options[i].text = impactOpts[i];
					}
				}
			});

			// Translate Likelihood tooltip
			const likelihoodTooltip = document.querySelector('label[for="inherentLikelihood"] .info-tooltip');
			if (likelihoodTooltip) {
				const strong = likelihoodTooltip.querySelector('strong');
				if (strong) strong.textContent = t.likelihoodCriteriaTitle;
				const lis = likelihoodTooltip.querySelectorAll('li');
				if (lis[0]) lis[0].innerHTML = '<b>' + t.likelihood1 + '</b> ' + t.likelihood1Desc;
				if (lis[1]) lis[1].innerHTML = '<b>' + t.likelihood2 + '</b> ' + t.likelihood2Desc;
				if (lis[2]) lis[2].innerHTML = '<b>' + t.likelihood3 + '</b> ' + t.likelihood3Desc;
				if (lis[3]) lis[3].innerHTML = '<b>' + t.likelihood4 + '</b> ' + t.likelihood4Desc;
				if (lis[4]) lis[4].innerHTML = '<b>' + t.likelihood5 + '</b> ' + t.likelihood5Desc;
			}

			// Translate Impact tooltip
			const impactTooltip = document.querySelector('label[for="inherentImpact"] .info-tooltip');
			if (impactTooltip) {
				const strong = impactTooltip.querySelector('strong');
				if (strong) strong.textContent = t.impactCriteriaTitle;
				// Headers
				const ths = impactTooltip.querySelectorAll('.impact-table th');
				if (ths[0]) ths[0].textContent = t.thLevel;
				if (ths[1]) ths[1].textContent = t.thHealthSafety;
				if (ths[2]) ths[2].textContent = t.thEnvironment;
				if (ths[3]) ths[3].textContent = t.thFinancial;
				if (ths[4]) ths[4].textContent = t.thReputation;
				if (ths[5]) ths[5].textContent = t.thLegal;
				if (ths[6]) ths[6].textContent = t.thOperational;
				if (ths[7]) ths[7].textContent = t.thCommunity;
				// Rows
				const rows = impactTooltip.querySelectorAll('.impact-table tbody tr');
				if (rows[0]) {
					const tds = rows[0].querySelectorAll('td');
					if (tds[0]) tds[0].textContent = t.impact1Level;
					if (tds[1]) tds[1].textContent = t.impact1HS;
					if (tds[2]) tds[2].textContent = t.impact1Env;
					if (tds[3]) tds[3].textContent = t.impact1Fin;
					if (tds[4]) tds[4].textContent = t.impact1Rep;
					if (tds[5]) tds[5].textContent = t.impact1Legal;
					if (tds[6]) tds[6].textContent = t.impact1Op;
					if (tds[7]) tds[7].textContent = t.impact1Com;
				}
				if (rows[1]) {
					const tds = rows[1].querySelectorAll('td');
					if (tds[0]) tds[0].textContent = t.impact2Level;
					if (tds[1]) tds[1].textContent = t.impact2HS;
					if (tds[2]) tds[2].textContent = t.impact2Env;
					if (tds[3]) tds[3].textContent = t.impact2Fin;
					if (tds[4]) tds[4].textContent = t.impact2Rep;
					if (tds[5]) tds[5].textContent = t.impact2Legal;
					if (tds[6]) tds[6].textContent = t.impact2Op;
					if (tds[7]) tds[7].textContent = t.impact2Com;
				}
				if (rows[2]) {
					const tds = rows[2].querySelectorAll('td');
					if (tds[0]) tds[0].textContent = t.impact3Level;
					if (tds[1]) tds[1].textContent = t.impact3HS;
					if (tds[2]) tds[2].textContent = t.impact3Env;
					if (tds[3]) tds[3].textContent = t.impact3Fin;
					if (tds[4]) tds[4].textContent = t.impact3Rep;
					if (tds[5]) tds[5].textContent = t.impact3Legal;
					if (tds[6]) tds[6].textContent = t.impact3Op;
					if (tds[7]) tds[7].textContent = t.impact3Com;
				}
				if (rows[3]) {
					const tds = rows[3].querySelectorAll('td');
					if (tds[0]) tds[0].textContent = t.impact4Level;
					if (tds[1]) tds[1].textContent = t.impact4HS;
					if (tds[2]) tds[2].textContent = t.impact4Env;
					if (tds[3]) tds[3].textContent = t.impact4Fin;
					if (tds[4]) tds[4].textContent = t.impact4Rep;
					if (tds[5]) tds[5].textContent = t.impact4Legal;
					if (tds[6]) tds[6].textContent = t.impact4Op;
					if (tds[7]) tds[7].textContent = t.impact4Com;
				}
				if (rows[4]) {
					const tds = rows[4].querySelectorAll('td');
					if (tds[0]) tds[0].textContent = t.impact5Level;
					if (tds[1]) tds[1].textContent = t.impact5HS;
					if (tds[2]) tds[2].textContent = t.impact5Env;
					if (tds[3]) tds[3].textContent = t.impact5Fin;
					if (tds[4]) tds[4].textContent = t.impact5Rep;
					if (tds[5]) tds[5].textContent = t.impact5Legal;
					if (tds[6]) tds[6].textContent = t.impact5Op;
					if (tds[7]) tds[7].textContent = t.impact5Com;
				}
			}
		}

		// Apply on load
		applyRiskI18n();

		// Apply when language changes
		window.addEventListener('languageChanged', applyRiskI18n);
	});

	// Check if we're in edit mode
	function isEditMode() {
		const urlParams = new URLSearchParams(window.location.search);
		// Only consider it edit mode if the URL explicitly has edit parameter
		return urlParams.has('edit');
	}

	// Load edit data from localStorage and populate form
	function loadEditDataIfPresent() {
		try {
			// Only load edit data if we're explicitly in edit mode (URL has edit parameter)
			const urlParams = new URLSearchParams(window.location.search);
			if (!urlParams.has('edit')) {
				// If not in edit mode, clear any stale edit data
				localStorage.removeItem('riskEditData');
				return;
			}

			const editDataString = localStorage.getItem('riskEditData');
			if (!editDataString) return;

			const editData = JSON.parse(editDataString);
			if (!editData || !editData.data) return;

			console.log('Loading edit data:', editData);

			const data = editData.data;

			// Helper to safely set select value (if option not yet loaded, defer)
			function setSelectValue(id, value) {
				if (!value) return;
				const el = document.getElementById(id);
				if (!el) return;
				if ([...el.options].some(o => o.value === value)) {
					el.value = value;
				} else {
					// Store pending selection to apply after dropdown population
					window._pendingSelectValues = window._pendingSelectValues || {};
					window._pendingSelectValues[id] = value;
				}
			}

			// Populate basic fields
			// Populate GPS coordinates if present
			if (data.latitude != null) document.getElementById('latitude').value = data.latitude;
			if (data.longitude != null) document.getElementById('longitude').value = data.longitude;
			// Backward-compatible keys
			if (!document.getElementById('latitude').value && (data.lat != null)) document.getElementById('latitude').value = data.lat;
			if (!document.getElementById('longitude').value && (data.lng != null)) document.getElementById('longitude').value = data.lng;
			if ((!document.getElementById('latitude').value || !document.getElementById('longitude').value) && typeof data.coordinates === 'string'){
				const parts = data.coordinates.split(',').map(s=>parseFloat(s.trim()));
				if (parts.length===2 && isFinite(parts[0]) && isFinite(parts[1])){
					document.getElementById('latitude').value = parts[0];
					document.getElementById('longitude').value = parts[1];
				}
			}
			if (data.riskTitle) document.getElementById('riskTitle').value = data.riskTitle;
			if (data.description) document.getElementById('description').value = data.description;
			if (data.hazard) document.getElementById('hazard').value = data.hazard;
			setSelectValue('hazardType', data.hazardType);
			setSelectValue('riskCategory', data.riskCategory);
			setSelectValue('department', data.department);
			setSelectValue('location', data.location);
			if (data.dateIdentified) document.getElementById('dateIdentified').value = data.dateIdentified.split('T')[0];
			if (data.requestor) document.getElementById('requestor').value = data.requestor;
			setSelectValue('riskStrategy', data.riskStrategy);
			
			// Set the risk ID (from editing data) - display human-readable ID
			if (editData.riskId) {
				document.getElementById('riskID').value = editData.riskId;
			} else if (data.riskID) {
				// Fallback to data.riskID if editData.riskId is not available
				document.getElementById('riskID').value = data.riskID;
			}

			// Populate inherent assessment
			if (data.inherentLikelihood) document.getElementById('inherentLikelihood').value = data.inherentLikelihood;
			if (data.inherentImpact) document.getElementById('inherentImpact').value = data.inherentImpact;
			if (data.inherentRating) document.getElementById('inherentRating').value = data.inherentRating;
			if (data.inherentLevel) document.getElementById('inherentLevel').value = data.inherentLevel;

			// Populate residual assessment
			if (data.residualLikelihood) document.getElementById('residualLikelihood').value = data.residualLikelihood;
			if (data.residualImpact) document.getElementById('residualImpact').value = data.residualImpact;
			if (data.residualRating) document.getElementById('residualRating').value = data.residualRating;
			if (data.residualLevel) document.getElementById('residualLevel').value = data.residualLevel;

			// Populate controls list
			if (Array.isArray(data.controls) && data.controls.length > 0) {
				const controlsContainer = document.getElementById('existingControlsList');
				if (controlsContainer) {
					// Clear existing controls
					controlsContainer.innerHTML = '';
					// Add each control
					data.controls.forEach((control, index) => {
						if (control.trim()) {
							const controlDiv = document.createElement('div');
							controlDiv.className = 'control-item';
							controlDiv.innerHTML = `
								<span class="control-number">${index + 1}.</span>
								<input type="text" value="${control}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
								<button type="button" class="delete-control-btn" onclick="this.parentElement.remove(); updateControlNumbers();">
									<i class="fas fa-trash"></i>
								</button>
							`;
							controlsContainer.appendChild(controlDiv);
						}
					});
				}
			}

			// Populate actions list
			if (Array.isArray(data.actions) && data.actions.length > 0) {
				const actionsContainer = document.getElementById('actionsList');
				if (actionsContainer) {
					// Clear existing actions
					actionsContainer.innerHTML = '';
					// Add each action
					data.actions.forEach((action, index) => {
						if (action.trim()) {
							const actionDiv = document.createElement('div');
							actionDiv.className = 'control-item';
							actionDiv.innerHTML = `
								<span class="control-number">${index + 1}.</span>
								<input type="text" value="${action}" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
								<button type="button" class="delete-control-btn" onclick="this.parentElement.remove(); updateActionNumbers();">
									<i class="fas fa-trash"></i>
								</button>
							`;
							actionsContainer.appendChild(actionDiv);
						}
					});
				}
			}

			// Populate existing attachments (read-only list for now)
			if (data.attachments && typeof data.attachments === 'object') {
				const fileList = document.getElementById('fileList');
				if (fileList) {
					fileList.innerHTML = `
						<div class="attachments-header">
							<i class="fas fa-paperclip"></i>
							Existing Attachments
						</div>
					` + Object.entries(data.attachments).map(([key, value]) => {
						// Handle both old format (key: url) and new format (key: {url, originalName})
						const isNewFormat = typeof value === 'object' && value.url;
						const url = isNewFormat ? value.url : value;
						const displayName = isNewFormat ? value.originalName : decodeFirebaseSafeKey(key);
						
						return `
							<div class="existing-attachment" data-attachment-key="${key}">
								<i class="fas fa-file"></i>
								<a href="${url}" target="_blank">${displayName}</a>
							</div>
						`;
					}).join('');
				}
				// Store a reference so submission preserves attachments
				window._existingAttachments = data.attachments;
			}

			// Update page title to indicate edit mode
			const pageTitle = document.querySelector('.page-header h1');
			if (pageTitle) {
				pageTitle.innerHTML = '<i class="fas fa-edit"></i> Edit Risk Assessment';
			}

			// Update submit button text
			const submitBtn = document.querySelector('button[type="submit"]');
			if (submitBtn) {
				submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Risk Assessment';
			}

			// Store edit mode flag
			window.isEditingRisk = true;
			window.editingRiskId = editData.firebaseKey || editData.riskId; // Use firebaseKey for DB operations

			console.log('Edit data loaded successfully');

		} catch (error) {
			console.error('Error loading edit data:', error);
			// Clear corrupted data
			localStorage.removeItem('riskEditData');
		}
	}
	
	function generateRiskID() {
		const now = new Date();
		const year = now.getFullYear();
		const month = String(now.getMonth() + 1).padStart(2, '0');
		const day = String(now.getDate()).padStart(2, '0');
		const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
		const riskID = `RISK-${year}${month}${day}-${time}`;
		document.getElementById('riskID').value = riskID;
	}
	
	function setRequestorName() {
		// Set requestor from current user
		const currentUser = window.authManager?.currentUser;
		if (currentUser) {
			const displayName = currentUser.displayName || currentUser.name || currentUser.email || 'Unknown User';
			document.getElementById('requestor').value = displayName;
		}
	}
	
	function setupRiskCalculations() {
		// Risk matrix calculations
		const inherentLikelihood = document.getElementById('inherentLikelihood');
		const inherentImpact = document.getElementById('inherentImpact');
		const inherentRating = document.getElementById('inherentRating');
		const inherentLevel = document.getElementById('inherentLevel');
		
		const residualLikelihood = document.getElementById('residualLikelihood');
		const residualImpact = document.getElementById('residualImpact');
		const residualRating = document.getElementById('residualRating');
		const residualLevel = document.getElementById('residualLevel');
		
		function calculateRisk(likelihood, impact, ratingField, levelField) {
			const l = parseInt(likelihood.value) || 0;
			const i = parseInt(impact.value) || 0;
			const rating = l * i;
			
			ratingField.value = rating || '';
			
			let level = '';
			let className = '';
			if (rating >= 20) { level = 'Extreme'; className = 'risk-extreme'; }
			else if (rating >= 12) { level = 'High'; className = 'risk-high'; }
			else if (rating >= 6) { level = 'Medium'; className = 'risk-medium'; }
			else if (rating >= 1) { level = 'Low'; className = 'risk-low'; }
			
			levelField.value = level;
			levelField.className = 'form-control ' + className;
			ratingField.className = 'form-control ' + className;
		}
		
		[inherentLikelihood, inherentImpact].forEach(field => {
			field.addEventListener('change', () => calculateRisk(inherentLikelihood, inherentImpact, inherentRating, inherentLevel));
		});
		
		[residualLikelihood, residualImpact].forEach(field => {
			field.addEventListener('change', () => calculateRisk(residualLikelihood, residualImpact, residualRating, residualLevel));
		});
	}
	
	function initializeDynamicLists() {
		// Initialize controls list
		document.getElementById('addControlBtn').addEventListener('click', addControl);
		
		// Initialize actions list  
		document.getElementById('addActionBtn').addEventListener('click', addAction);
		
		// Reset button
		document.getElementById('resetBtn').addEventListener('click', resetForm);
	}
	
	function addControl() {
		const controlsList = document.getElementById('existingControlsList');
		const controlNumber = controlsList.children.length + 1;
		
		const controlDiv = document.createElement('div');
		controlDiv.className = 'control-item';
		controlDiv.innerHTML = `
			<span class="control-number">${controlNumber}.</span>
			<input type="text" placeholder="Control measure..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
			<button type="button" class="delete-control-btn" onclick="this.parentElement.remove(); updateControlNumbers();">
				<i class="fas fa-trash"></i>
			</button>
		`;
		
		controlsList.appendChild(controlDiv);
	}
	
	let correctiveActionsCounter = 0;
	const correctiveActions = [];
	
	function addAction(data = null) {
		correctiveActionsCounter++;
		const actionId = correctiveActionsCounter;
		
		const container = document.getElementById('actionsList');
		const noActionsMsg = container.querySelector('.no-actions-msg');
		if (noActionsMsg) noActionsMsg.remove();
		
		const actionDiv = document.createElement('div');
		actionDiv.className = 'corrective-action-item';
		actionDiv.id = `correctiveAction_${actionId}`;
		actionDiv.innerHTML = `
			<div class="action-header">
				<span class="action-number">Action #${actionId}</span>
				<button type="button" class="btn-remove-action" onclick="removeCorrectiveAction(${actionId})">
					<i class="fas fa-trash"></i> Remove
				</button>
			</div>
			<div class="form-row">
				<div class="form-group" style="flex:1 1 100%">
					<label>Action Description *</label>
					<textarea class="form-control action-description" placeholder="Describe the action to be taken..." required>${data?.description || ''}</textarea>
				</div>
			</div>
			<div class="form-row">
				<div class="form-group">
					<label>Responsible Person *</label>
					<div class="search-container">
						<input type="text" class="form-control action-responsible-search" placeholder="Type to search employee..." autocomplete="off" value="${data?.responsibleName || ''}">
						<input type="hidden" class="action-responsible-id" value="${data?.responsibleId || ''}">
						<div class="search-dropdown action-search-results"></div>
					</div>
				</div>
				<div class="form-group">
					<label>Due Date *</label>
					<input type="date" class="form-control action-due-date" required value="${data?.dueDate || ''}">
				</div>
				<div class="form-group">
					<label>Status *</label>
					<select class="form-control action-status" required>
						<option value="">Select</option>
						<option value="pending" ${data?.status === 'pending' ? 'selected' : ''}>Pending</option>
						<option value="in-progress" ${data?.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
						<option value="completed" ${data?.status === 'completed' ? 'selected' : ''}>Completed</option>
						<option value="overdue" ${data?.status === 'overdue' ? 'selected' : ''}>Overdue</option>
					</select>
				</div>
			</div>
		`;
		
		container.appendChild(actionDiv);
		
		// Initialize search for responsible person
		initializeActionResponsibleSearch(actionDiv, actionId);
		
		// Store action reference
		correctiveActions.push({ id: actionId });
	}
	
	function removeCorrectiveAction(actionId) {
		const actionDiv = document.getElementById(`correctiveAction_${actionId}`);
		if (actionDiv) {
			actionDiv.remove();
			const idx = correctiveActions.findIndex(a => a.id === actionId);
			if (idx > -1) correctiveActions.splice(idx, 1);
			
			// Show "no actions" message if empty
			const container = document.getElementById('actionsList');
			if (container.querySelectorAll('.corrective-action-item').length === 0) {
				container.innerHTML = '<div class="no-actions-msg">No actions added. Click "Add Action" to create one.</div>';
			}
		}
	}
	
	function initializeActionResponsibleSearch(actionDiv, actionId) {
		const searchInput = actionDiv.querySelector('.action-responsible-search');
		const hiddenInput = actionDiv.querySelector('.action-responsible-id');
		const resultsDiv = actionDiv.querySelector('.action-search-results');
		
		searchInput.addEventListener('input', async (e) => {
			const query = e.target.value.trim().toLowerCase();
			if (query.length >= 2) {
				const results = await searchUsersForAction(query);
				showActionSearchResults(results, resultsDiv, searchInput, hiddenInput);
			} else {
				resultsDiv.classList.remove('show');
			}
		});
		
		document.addEventListener('click', (e) => {
			if (!actionDiv.contains(e.target)) {
				resultsDiv.classList.remove('show');
			}
		});
	}
	
	async function searchUsersForAction(query) {
		const user = authManager?.currentUser;
		if (!user || !user.companyId) return [];
		
		try {
			const snap = await db.ref(`companies/${user.companyId}/users`).once('value');
			const users = snap.val() || {};
			const results = [];
			
			Object.entries(users).forEach(([uid, userData]) => {
				const name = `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
				const email = userData.email || '';
				if (name.toLowerCase().includes(query) || email.toLowerCase().includes(query)) {
					results.push({ uid, name: name || email, email });
				}
			});
			
			return results.slice(0, 10);
		} catch (error) {
			console.error('Error searching users:', error);
			return [];
		}
	}
	
	function showActionSearchResults(users, resultsDiv, searchInput, hiddenInput) {
		if (users.length === 0) {
			resultsDiv.classList.remove('show');
			return;
		}
		
		resultsDiv.innerHTML = users.map(u => `
			<div class="search-dropdown-item" data-uid="${u.uid}" data-name="${u.name}">
				${u.name} <small style="color:#666">(${u.email})</small>
			</div>
		`).join('');
		
		resultsDiv.querySelectorAll('.search-dropdown-item').forEach(item => {
			item.addEventListener('click', () => {
				searchInput.value = item.dataset.name;
				hiddenInput.value = item.dataset.uid;
				resultsDiv.classList.remove('show');
			});
		});
		
		resultsDiv.classList.add('show');
	}
	
	function updateControlNumbers() {
		const controls = document.querySelectorAll('#existingControlsList .control-item');
		controls.forEach((control, index) => {
			control.querySelector('.control-number').textContent = `${index + 1}.`;
		});
	}
	
	function updateActionNumbers() {
		const actions = document.querySelectorAll('#actionsList .corrective-action-item');
		actions.forEach((action, index) => {
			const numberSpan = action.querySelector('.action-number');
			if (numberSpan) numberSpan.textContent = `Action #${index + 1}`;
		});
	}
	
	function resetForm() {
		if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
			document.getElementById('riskForm').reset();
			document.getElementById('existingControlsList').innerHTML = '';
			document.getElementById('actionsList').innerHTML = '<div class="no-actions-msg">No actions added. Click "Add Action" to create one.</div>';
			correctiveActionsCounter = 0;
			correctiveActions.length = 0;
			generateRiskID();
			setRequestorName();
		}
	}
	
	function initializeRiskForm() {
		// Load dropdown options from Firebase
		loadDropdownOptions();
		
		// Initialize file input handler
		initializeFileInput();
		
		// Initialize real-time updates for edit mode
		initializeRealtimeUpdates();

		// Bind geolocation button
		const geoBtn = document.getElementById('useCurrentLocationBtn');
		if (geoBtn && 'geolocation' in navigator) {
			geoBtn.addEventListener('click', ()=>{
				geoBtn.disabled = true; const orig = geoBtn.innerHTML; geoBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
				navigator.geolocation.getCurrentPosition((pos)=>{
					const { latitude, longitude } = pos.coords || {};
					document.getElementById('latitude').value = latitude?.toFixed(6) || '';
					document.getElementById('longitude').value = longitude?.toFixed(6) || '';
					geoBtn.innerHTML = orig; geoBtn.disabled = false;
				}, (err)=>{
					alert('Unable to get location: ' + (err?.message || 'Unknown error'));
					geoBtn.innerHTML = orig; geoBtn.disabled = false;
				}, { enableHighAccuracy:true, timeout:10000 });
			});
		} else if (geoBtn) {
			geoBtn.disabled = true; geoBtn.title = 'Geolocation not supported by this browser';
		}
	}
	
	function initializeRealtimeUpdates() {
		// Only set up real-time listener if in edit mode
		if (!window.isEditingRisk || !window.editingRiskId) return;
		
		const currentUser = window.authManager?.currentUser;
		if (!currentUser?.companyId) return;
		
		console.log('🔄 Setting up real-time updates for risk:', window.editingRiskId);
		
		// Listen for changes to the current risk
		const riskRef = firebase.database().ref(`companies/${currentUser.companyId}/risks/${window.editingRiskId}`);
		riskRef.on('value', (snapshot) => {
			if (!snapshot.exists()) return;
			
			const updatedRisk = snapshot.val();
			console.log('📡 Risk data updated in real-time:', updatedRisk);
			
			// Update existing attachments if they changed
			if (updatedRisk.attachments && JSON.stringify(updatedRisk.attachments) !== JSON.stringify(window._existingAttachments)) {
				console.log('📎 Attachments updated, refreshing display');
				window._existingAttachments = updatedRisk.attachments;
				displayFileList();
			}
		});
		
		// Clean up listener when leaving the page
		window.addEventListener('beforeunload', () => {
			riskRef.off();
		});
	}
	
	function initializeFileInput() {
		const fileInput = document.getElementById('attachments');
		const fileList = document.getElementById('fileList');
		
		if (!fileInput || !fileList) return;
		
		fileInput.addEventListener('change', function(e) {
			const files = Array.from(e.target.files);
			
			if (files.length === 0) {
				displayFileList();
				return;
			}
			
			// Display newly selected files with upload status
			displayFileList(files);
		});
		
		// Initial display
		displayFileList();
	}
	
	function displayFileList(newFiles = []) {
		const fileList = document.getElementById('fileList');
		if (!fileList) return;
		
		let html = '';
		
		// Show existing attachments if in edit mode
		if (window.isEditingRisk && window._existingAttachments) {
			const attachmentCount = Object.keys(window._existingAttachments).length;
			html += `
				<div class="attachments-header">
					<i class="fas fa-paperclip"></i>
					Existing Attachments (${attachmentCount})
				</div>
			` + Object.entries(window._existingAttachments).map(([key, value]) => {
				// Handle both old format (key: url) and new format (key: {url, originalName})
				const isNewFormat = typeof value === 'object' && value.url;
				const url = isNewFormat ? value.url : value;
				const displayName = isNewFormat ? value.originalName : decodeFirebaseSafeKey(key);
				
				return `
					<div class="existing-attachment" data-attachment-key="${key}">
						<i class="fas fa-file"></i>
						<a href="${url}" target="_blank" title="Click to download">${displayName}</a>
						<span class="file-status uploaded">
							<i class="fas fa-check-circle"></i>
							Uploaded
						</span>
					</div>
				`;
			}).join('');
		}
		
		// Show newly selected files
		if (newFiles.length > 0) {
			html += `
				<div class="attachments-header" style="margin-top: ${window._existingAttachments ? '1rem' : '0.5rem'};">
					<i class="fas fa-plus-circle"></i>
					New Files Selected (${newFiles.length})
				</div>
			` + newFiles.map((file, index) => `
				<div class="selected-file" data-file-index="${index}">
					<i class="fas fa-file"></i>
					<span class="file-name">${file.name}</span>
					<span class="file-size">(${formatFileSize(file.size)})</span>
					<span class="file-status pending">
						<i class="fas fa-clock"></i>
						Ready to upload
					</span>
					<button type="button" class="remove-file-btn" onclick="removeSelectedFile(${index})" title="Remove file">
						<i class="fas fa-times"></i>
					</button>
				</div>
			`).join('');
		}
		
		if (!html) {
			html = `
				<div class="no-files-message">
					<i class="fas fa-file-upload"></i>
					<p>No files selected. Click "Choose files" to upload attachments.</p>
				</div>
			`;
		}
		
		fileList.innerHTML = html;
	}
	
	function formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}
	
	function decodeFirebaseSafeKey(encodedKey) {
		// Decode Firebase-safe key back to original filename
		return encodedKey
			.replace(/_DOT_/g, '.')
			.replace(/_HASH_/g, '#')
			.replace(/_DOLLAR_/g, '$')
			.replace(/_SLASH_/g, '/')
			.replace(/_LBRACKET_/g, '[')
			.replace(/_RBRACKET_/g, ']');
	}
	
	function updateFileStatus(fileIndex, status, message) {
		const fileElement = document.querySelector(`[data-file-index="${fileIndex}"] .file-status`);
		if (!fileElement) return;
		
		// Remove all status classes
		fileElement.classList.remove('pending', 'uploading', 'uploaded', 'error');
		
		// Add new status class
		fileElement.classList.add(status);
		
		// Update icon and text
		let icon = 'fas fa-clock';
		switch (status) {
			case 'uploading':
				icon = 'fas fa-spinner fa-spin';
				break;
			case 'uploaded':
				icon = 'fas fa-check-circle';
				break;
			case 'error':
				icon = 'fas fa-exclamation-triangle';
				break;
		}
		
		fileElement.innerHTML = `<i class="${icon}"></i> ${message}`;
	}
	
	function removeSelectedFile(index) {
		const fileInput = document.getElementById('attachments');
		if (!fileInput) return;
		
		// Create a new FileList without the removed file
		const dt = new DataTransfer();
		const files = Array.from(fileInput.files);
		
		files.forEach((file, i) => {
			if (i !== index) {
				dt.items.add(file);
			}
		});
		
		fileInput.files = dt.files;
		
		// Trigger change event to update display
		fileInput.dispatchEvent(new Event('change'));
	}
	
	async function loadDropdownOptions() {
		try {
			const currentUser = window.authManager?.currentUser;
			if (!currentUser?.companyId) {
				console.warn('❌ No user or company ID found for loading dropdown options');
				return;
			}
			
			console.log('🔄 Loading dropdown options for company:', currentUser.companyId);
			
			const companyRef = firebase.database().ref(`companies/${currentUser.companyId}`);
			const snapshot = await companyRef.once('value');
			const companyData = snapshot.val();
			
			if (!companyData) {
				console.warn('❌ No company data found');
				return;
			}
			
			console.log('✅ Company data loaded:', companyData);
			console.log('🔍 Available company data keys:', Object.keys(companyData));
			console.log('🔍 fieldOptions available:', !!companyData.fieldOptions);
			console.log('🔍 formFields available:', !!companyData.formFields);
			console.log('🔍 fieldSetup available:', !!companyData.fieldSetup);
			
			// Track what has been loaded to avoid duplicates
			let departmentsLoaded = false;
			let locationsLoaded = false;
			let riskCategoriesLoaded = false;
			
			if (companyData) {
				// Load departments from fieldOptions first, then fallback to departments array
				if (companyData.fieldOptions && companyData.fieldOptions['department']) {
					const departments = companyData.fieldOptions['department']
						.filter(item => item.enabled !== false)
						.map(item => ({ value: item.value, label: item.label }));
					populateDropdown('department', departments);
					console.log('✅ Loaded departments from fieldOptions:', departments);
					departmentsLoaded = true;
				} else if (companyData.departments) {
					populateDropdown('department', companyData.departments);
					console.log('✅ Loaded departments from legacy departments array');
					departmentsLoaded = true;
				}
				
				// Load locations from fieldOptions first, then fallback to locations array
				if (companyData.fieldOptions && companyData.fieldOptions['area']) {
					const locations = companyData.fieldOptions['area']
						.filter(item => item.enabled !== false)
						.map(item => ({ value: item.value, label: item.label }));
					populateDropdown('location', locations);
					console.log('✅ Loaded locations from fieldOptions/area:', locations);
					locationsLoaded = true;
				} else if (companyData.fieldOptions && companyData.fieldOptions['location']) {
					const locations = companyData.fieldOptions['location']
						.filter(item => item.enabled !== false)
						.map(item => ({ value: item.value, label: item.label }));
					populateDropdown('location', locations);
					console.log('✅ Loaded locations from fieldOptions/location:', locations);
					locationsLoaded = true;
				} else if (companyData.locations) {
					populateDropdown('location', companyData.locations);
					console.log('✅ Loaded locations from legacy locations array');
					locationsLoaded = true;
				}
				
				// Load hazard types and other field options from company fieldOptions
				if (companyData.fieldOptions) {
					// Load hazard types from fieldOptions
					if (companyData.fieldOptions['hazard-type']) {
						const hazardTypes = companyData.fieldOptions['hazard-type']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('hazardType', hazardTypes);
						console.log('✅ Loaded hazard types from fieldOptions:', hazardTypes);
					}
					
					// Load risk categories from fieldOptions  
					if (companyData.fieldOptions['risk-category']) {
						const riskCategories = companyData.fieldOptions['risk-category']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('riskCategory', riskCategories);
						console.log('✅ Loaded risk categories from fieldOptions:', riskCategories);
						riskCategoriesLoaded = true;
					}
					
					// Load risk strategies from fieldOptions
					if (companyData.fieldOptions['risk-strategy']) {
						const riskStrategies = companyData.fieldOptions['risk-strategy']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('riskStrategy', riskStrategies);
						console.log('✅ Loaded risk strategies from fieldOptions:', riskStrategies);
					}
				}
				
				// Fallback: Try formFields structure if fieldOptions not available
				else if (companyData.formFields) {
					// Load hazard types from form fields
					if (companyData.formFields['hazard-type']) {
						const hazardTypes = companyData.formFields['hazard-type']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('hazardType', hazardTypes);
					}
					
					// Load risk categories from form fields  
					if (companyData.formFields['risk-category'] && !riskCategoriesLoaded) {
						const riskCategories = companyData.formFields['risk-category']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('riskCategory', riskCategories);
						console.log('✅ Loaded risk categories from formFields fallback:', riskCategories);
						riskCategoriesLoaded = true;
					}
					
					// Load risk strategies from form fields
					if (companyData.formFields['risk-strategy']) {
						const riskStrategies = companyData.formFields['risk-strategy']
							.filter(item => item.enabled !== false)
							.map(item => ({ value: item.value, label: item.label }));
						populateDropdown('riskStrategy', riskStrategies);
					}
				}
				
				// Direct fetch from fieldOptions path if not found in company data
				if (!companyData.fieldOptions) {
					console.log('🔄 Trying direct fetch from fieldOptions path...');
					try {
						const fieldOptionsRef = firebase.database().ref(`companies/${currentUser.companyId}/fieldOptions`);
						const fieldOptionsSnapshot = await fieldOptionsRef.once('value');
						const fieldOptions = fieldOptionsSnapshot.val();
						
						if (fieldOptions) {
							console.log('✅ Direct fieldOptions loaded:', fieldOptions);
							
							// Load departments
							if (fieldOptions['department'] && !departmentsLoaded) {
								const departments = fieldOptions['department']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('department', departments);
								console.log('✅ Loaded departments from direct fetch:', departments);
							}
							
							// Load locations (try area first, then location)
							if (fieldOptions['area'] && !locationsLoaded) {
								const locations = fieldOptions['area']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('location', locations);
								console.log('✅ Loaded locations from direct fetch fieldOptions/area:', locations);
							} else if (fieldOptions['location'] && !locationsLoaded) {
								const locations = fieldOptions['location']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('location', locations);
								console.log('✅ Loaded locations from direct fetch fieldOptions/location:', locations);
							}
							
							// Load hazard types
							if (fieldOptions['hazard-type']) {
								const hazardTypes = fieldOptions['hazard-type']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('hazardType', hazardTypes);
								console.log('✅ Loaded hazard types from direct fetch:', hazardTypes);
							}
							
							// Load risk categories
							if (fieldOptions['risk-category'] && !riskCategoriesLoaded) {
								const riskCategories = fieldOptions['risk-category']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('riskCategory', riskCategories);
								console.log('✅ Loaded risk categories from direct fetch:', riskCategories);
							}
							
							// Load risk categories
							if (fieldOptions['risk-category']) {
								const riskCategories = fieldOptions['risk-category']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('riskCategory', riskCategories);
								console.log('✅ Loaded risk categories from direct fetch:', riskCategories);
							}
							
							// Load risk strategies
							if (fieldOptions['risk-strategy']) {
								const riskStrategies = fieldOptions['risk-strategy']
									.filter(item => item.enabled !== false)
									.map(item => ({ value: item.value, label: item.label }));
								populateDropdown('riskStrategy', riskStrategies);
								console.log('✅ Loaded risk strategies from direct fetch:', riskStrategies);
							}
						} else {
							console.warn('❌ No fieldOptions found at direct path');
						}
					} catch (directFetchError) {
						console.error('❌ Error in direct fieldOptions fetch:', directFetchError);
					}
				}
				
				// Fallback: Load from legacy fieldSetup structure if formFields not available
				if (!companyData.fieldOptions && !companyData.formFields && companyData.fieldSetup?.risk) {
					const riskSetup = companyData.fieldSetup.risk;
					if (riskSetup.riskCategories && !riskCategoriesLoaded) {
						populateDropdown('riskCategory', riskSetup.riskCategories);
						console.log('✅ Loaded risk categories from legacy fieldSetup:', riskSetup.riskCategories);
					}
					if (riskSetup.hazardTypes) {
						populateDropdown('hazardType', riskSetup.hazardTypes);
						console.log('✅ Loaded hazard types from legacy fieldSetup:', riskSetup.hazardTypes);
					}
				}

				// After all dropdowns filled, apply any pending selections from edit mode
				if (window._pendingSelectValues) {
					Object.entries(window._pendingSelectValues).forEach(([id, val]) => {
						const el = document.getElementById(id);
						if (el && [...el.options].some(o => o.value === val)) {
							el.value = val;
						}
					});
					// Clear pending once applied
					delete window._pendingSelectValues;
				}
			}
		} catch (error) {
			console.error('Error loading dropdown options:', error);
		}
	}
	
	function populateDropdown(fieldId, options) {
		const select = document.getElementById(fieldId);
		if (!select) return;
		
		// Clear existing options except the first one
		while (select.children.length > 1) {
			select.removeChild(select.lastChild);
		}
		
		// Add options
		if (Array.isArray(options)) {
			options.forEach(option => {
				const optionElement = document.createElement('option');
				
				// Handle different option formats
				if (typeof option === 'object' && option !== null) {
					// Object format: { value: 'key', label: 'Display Name' }
					optionElement.value = option.value || option.key || '';
					optionElement.textContent = option.label || option.name || option.value || option.key || '';
				} else {
					// Simple string format
					optionElement.value = option;
					optionElement.textContent = option;
				}
				
				select.appendChild(optionElement);
			});
		} else if (typeof options === 'object') {
			Object.entries(options).forEach(([key, value]) => {
				const optionElement = document.createElement('option');
				optionElement.value = key;
				optionElement.textContent = value.name || value || key;
				select.appendChild(optionElement);
			});
		}
	}
	
	async function handleFormSubmission(event) {
		event.preventDefault();
		
		console.log('🚀 Form submission started');
		
		// Check Firebase initialization
		if (!window.firebase || !window.db || !window.storage) {
			console.error('❌ Firebase not properly initialized');
			alert('System not ready. Please refresh the page and try again.');
			return;
		}
		
		const currentUser = window.authManager?.currentUser;
		if (!currentUser?.companyId) {
			console.error('❌ No user session or company ID found');
			alert('No user session found. Please log in again.');
			return;
		}
		
		console.log('👤 Current user:', {
			uid: currentUser.uid,
			companyId: currentUser.companyId,
			email: currentUser.email
		});
		
		// Show loading state
		const submitBtn = document.getElementById('submitBtn');
		const originalBtnText = submitBtn.innerHTML;
		submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
		submitBtn.disabled = true;
		
		try {
			// Collect form data
			const formData = collectFormData();
			
			// Validate required fields
			if (!validateForm(formData)) {
				submitBtn.innerHTML = originalBtnText;
				submitBtn.disabled = false;
				return;
			}
			
			// Upload files if any are selected
			const fileInput = document.getElementById('attachments');
			let attachments = {};
			
			// Start with existing attachments if in edit mode
			if (window.isEditingRisk && window._existingAttachments) {
				attachments = { ...window._existingAttachments };
			}
			
			// Upload new files if selected
			if (fileInput && fileInput.files.length > 0) {
				submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt fa-spin"></i> Uploading files...';
				console.log('🔄 Uploading', fileInput.files.length, 'files...');
				
				const uploadPromises = Array.from(fileInput.files).map(async (file, index) => {
					try {
						console.log(`📤 Starting upload for file ${index + 1}:`, file.name);
						
						// Update status to uploading
						updateFileStatus(index, 'uploading', 'Uploading...');
						
						const fileName = `${Date.now()}_${file.name}`;
						const riskId = window.editingRiskId || 'temp_' + Date.now();
						const filePath = `companies/${currentUser.companyId}/risks/${riskId}/attachments/${fileName}`;
						
						console.log(`📂 Upload path:`, filePath);
						
						// Upload to Firebase Storage
						const storageRef = firebase.storage().ref(filePath);
						
						// Create upload task with progress monitoring
						const uploadTask = storageRef.put(file);
						
						// Monitor upload progress
						uploadTask.on('state_changed', 
							(snapshot) => {
								const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
								console.log(`📊 Upload progress for ${file.name}: ${Math.round(progress)}%`);
								updateFileStatus(index, 'uploading', `Uploading... ${Math.round(progress)}%`);
							},
							(error) => {
								console.error('❌ Upload error for file:', file.name, error);
								updateFileStatus(index, 'error', 'Upload failed');
								throw error; // Re-throw to be caught in the outer try-catch
							}
						);
						
						// Wait for upload completion
						const uploadResult = await uploadTask;
						const downloadURL = await uploadResult.ref.getDownloadURL();
						
						console.log('✅ File uploaded successfully:', file.name, 'URL:', downloadURL);
						
						// Update status to uploaded
						updateFileStatus(index, 'uploaded', 'Uploaded');
						
						// Create Firebase-safe key by encoding problematic characters
						const firebaseSafeKey = file.name
							.replace(/\./g, '_DOT_')
							.replace(/#/g, '_HASH_')
							.replace(/\$/g, '_DOLLAR_')
							.replace(/\//g, '_SLASH_')
							.replace(/\[/g, '_LBRACKET_')
							.replace(/\]/g, '_RBRACKET_');
						
						// Store both the safe key and original filename for display
						attachments[firebaseSafeKey] = {
							url: downloadURL,
							originalName: file.name,
							uploadedAt: new Date().toISOString(),
							uploadedBy: currentUser.uid
						};
						
						console.log('💾 Added to attachments with safe key:', firebaseSafeKey, attachments[firebaseSafeKey]);
						
						return { success: true, fileName: file.name, url: downloadURL, safeKey: firebaseSafeKey };
					} catch (error) {
						console.error('❌ Failed to upload file:', file.name, error);
						updateFileStatus(index, 'error', `Upload failed: ${error.message}`);
						return { success: false, fileName: file.name, error: error.message };
					}
				});
				
				console.log('⏳ Waiting for all file uploads to complete...');
				const uploadResults = await Promise.all(uploadPromises);
				const failedUploads = uploadResults.filter(result => !result.success);
				
				if (failedUploads.length > 0) {
					console.warn('⚠️ Some files failed to upload:', failedUploads);
					const failedNames = failedUploads.map(f => f.fileName).join(', ');
					if (!confirm(`Some files failed to upload: ${failedNames}. Continue anyway?`)) {
						submitBtn.innerHTML = originalBtnText;
						submitBtn.disabled = false;
						return;
					}
				}
				
				console.log('📎 Final attachments object:', attachments);
			}
			
			// Add attachments to form data
			if (Object.keys(attachments).length > 0) {
				formData.attachments = attachments;
			}
			
			submitBtn.innerHTML = '<i class="fas fa-database fa-spin"></i> Saving...';
			
			// Check if we're in edit mode
			if (window.isEditingRisk && window.editingRiskId) {
				console.log('📝 Updating existing risk:', window.editingRiskId);
				
				// Update existing risk - first fetch current to preserve immutable fields
				const riskRef = firebase.database().ref(`companies/${currentUser.companyId}/risks/${window.editingRiskId}`);
				let existing = {};
				try {
					console.log('🔍 Fetching existing risk data...');
					const snap = await riskRef.once('value');
					if (snap.exists()) {
						existing = snap.val();
						console.log('✅ Existing risk data loaded:', existing);
					} else {
						console.warn('⚠️ Risk not found in database:', window.editingRiskId);
					}
				} catch(fetchErr){ 
					console.warn('⚠️ Could not fetch existing risk for preservation', fetchErr); 
				}
				
				const riskData = {
					...existing, // start with existing so we keep submittedBy, submittedAt, approval data etc.
					...formData,  // overwrite editable form fields
					id: window.editingRiskId,
					riskID: formData.riskID || existing.riskID, // Preserve Risk ID from form or existing data
					updatedAt: new Date().toISOString(),
					updatedBy: currentUser.uid,
					companyId: currentUser.companyId
				};
				
				console.log('💾 Saving updated risk data:', riskData);
				await riskRef.set(riskData);
				console.log('✅ Risk updated successfully');
				
				// Send notification email for update
				try {
					await sendRiskNotificationEmail(currentUser.companyId, riskData, true);
				} catch (notifErr) {
					console.error('Notification error:', notifErr);
				}
				
				// Clear edit data from localStorage
				localStorage.removeItem('riskEditData');
				
				// Show success message
				window.notificationManager?.addNotification({
					type: 'Success',
					message: 'Risk assessment updated successfully!'
				});
				
				// Redirect to dashboard
				setTimeout(() => {
					window.location.href = 'riskboard.html';
				}, 1500);
				
			} else {
				console.log('➕ Creating new risk');
				
				// Create new risk
				const riskRef = firebase.database().ref(`companies/${currentUser.companyId}/risks`).push();
				
				const riskData = {
					...formData,
					id: riskRef.key,
					riskID: formData.riskID, // Preserve the generated Risk ID from the form
					submittedBy: currentUser.uid,
					submittedAt: new Date().toISOString(),
					status: 'pending',
					companyId: currentUser.companyId
				};
				
				console.log('💾 Saving new risk data:', riskData);
				await riskRef.set(riskData);
				console.log('✅ New risk created successfully:', riskRef.key);
				
				// Send notification email for new submission
				try {
					await sendRiskNotificationEmail(currentUser.companyId, riskData, false);
				} catch (notifErr) {
					console.error('Notification error:', notifErr);
				}
				
				// Show success message
				window.notificationManager?.addNotification({
					type: 'Success',
					message: 'Risk report submitted successfully!'
				});
				
				// Redirect to dashboard
				setTimeout(() => {
					window.location.href = 'riskboard.html';
				}, 1500);
			}
			
		} catch (error) {
			console.error('❌ Error submitting risk report:', error);
			console.error('❌ Error details:', {
				message: error.message,
				code: error.code,
				stack: error.stack,
				currentUser: currentUser,
				isEditMode: window.isEditingRisk,
				editingRiskId: window.editingRiskId
			});
			
			// Provide more specific error messages
			let errorMessage = 'Error submitting risk report. ';
			if (error.code === 'PERMISSION_DENIED') {
				errorMessage += 'Permission denied. Please check your access rights.';
			} else if (error.message?.includes('storage')) {
				errorMessage += 'File upload failed. Please try again.';
			} else if (error.message?.includes('database')) {
				errorMessage += 'Database error. Please check your connection.';
			} else {
				errorMessage += `Details: ${error.message || 'Unknown error'}`;
			}
			
			alert(errorMessage);
			submitBtn.innerHTML = originalBtnText;
			submitBtn.disabled = false;
		}
	}
	
	function collectFormData() {
		const form = document.getElementById('riskForm');
		const formData = new FormData(form);
		const data = {};
		
		// Collect basic form fields
		for (let [key, value] of formData.entries()) {
			// Skip the file input since we handle attachments separately
			if (key !== 'attachments') {
				data[key] = value;
			}
		}
		
		// Collect controls
		const controls = [];
		document.querySelectorAll('#existingControlsList .control-item input').forEach(input => {
			if (input.value.trim()) {
				controls.push(input.value.trim());
			}
		});
		data.controls = controls;
		
		// Collect corrective actions (new structure matching incident.html)
		const correctiveActionsData = [];
		document.querySelectorAll('#actionsList .corrective-action-item').forEach(actionDiv => {
			const description = actionDiv.querySelector('.action-description')?.value?.trim() || '';
			const responsibleName = actionDiv.querySelector('.action-responsible-search')?.value?.trim() || '';
			const responsibleId = actionDiv.querySelector('.action-responsible-id')?.value || '';
			const dueDate = actionDiv.querySelector('.action-due-date')?.value || '';
			const status = actionDiv.querySelector('.action-status')?.value || 'pending';
			
			if (description) {
				correctiveActionsData.push({
					description,
					responsibleName,
					responsibleId,
					dueDate,
					status
				});
			}
		});
		data.correctiveActions = correctiveActionsData;
		
		// Normalize GPS coordinates if provided
		if (data.latitude !== undefined || data.longitude !== undefined) {
			const lat = parseFloat(data.latitude);
			const lng = parseFloat(data.longitude);
			if (isFinite(lat) && isFinite(lng)) {
				data.latitude = lat;
				data.longitude = lng;
			} else {
				delete data.latitude;
				delete data.longitude;
			}
		}

		// Note: attachments are handled separately in handleFormSubmission
		return data;
	}
	
	function validateForm(data) {
		const required = ['riskTitle', 'hazard', 'hazardType', 'riskCategory', 'department', 'location', 'dateIdentified', 'description', 'inherentLikelihood', 'inherentImpact', 'riskStrategy'];
		
		console.log('🔍 Validating form data:', data);
		
		for (let field of required) {
			const value = data[field];
			console.log(`📋 Checking field '${field}':`, value);
			
			if (!value || value.trim() === '') {
				console.error(`❌ Validation failed for field: ${field}`);
				alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field.`);
				document.getElementById(field)?.focus();
				return false;
			}
		}
		
		console.log('✅ All required fields validated successfully');
		return true;
	}
	
	// Make functions globally accessible
	window.updateControlNumbers = updateControlNumbers;
	window.updateActionNumbers = updateActionNumbers;
	</script>
</body>
</html>
