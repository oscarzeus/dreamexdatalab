<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Details - Dreamex Datalab HSE</title>
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- EmailJS CDN for production email service -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <!-- All external dependencies embedded below -->
    <style>
        /* Font Awesome Icons - Embedded Core Icons */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
        
        /* CSS Variables - Complete Framework from Dashboard */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.8rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        /* Enhanced submenu hover visibility - Multiple specificity levels */
        .menu-dropdown:hover .submenu {
            display: block !important;
        }

        .menu-dropdown:hover > .submenu {
            display: block !important;
        }

        li.menu-dropdown:hover .submenu {
            display: block !important;
        }

        li.menu-dropdown:hover > .submenu {
            display: block !important;
        }

        /* Ensure submenu items are properly displayed when authorized */
        .menu-dropdown:hover .submenu li.menu-visible {
            display: list-item !important;
        }

        .menu-dropdown:hover .submenu li[data-feature].menu-visible {
            display: list-item !important;
        }

        /* Override any hidden states during hover */
        .menu-dropdown:hover .submenu li {
            display: list-item;
        }

        /* Maintain visibility states while still allowing hover override */
        .menu-dropdown:hover .submenu li:not(.menu-visible) {
            display: none !important;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            padding-top: 4.5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.3rem;
            position: fixed;
            top: 0.25rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            height: 50px;
            min-height: 50px;
            z-index: 1500; /* ensure header and its dropdowns sit above main content */
            overflow: visible; /* allow dropdowns to overflow header bounds */
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
            z-index: 2002; /* ensure dropdown sits on top */
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #f8f9fa;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Show menu items by default until permissions are loaded */
        .menu-loading [data-feature] {
            display: block !important;
        }

        .menu-loading .menu-dropdown {
            display: block !important;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 200px;
            }
            
            .main-content {
                margin-left: 200px;
                width: calc(100% - 200px);
            }
            
            .top-nav {
                left: calc(200px + 0.5rem);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                padding-top: 6rem;
            }
            
            .top-nav {
                left: 0.5rem;
                right: 0.5rem;
                padding: 0.75rem 1rem;
                border-radius: 0;
                overflow: visible; /* keep dropdown visible on small screens */
            }
            
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 48px;
                height: 48px;
            }
        }

        /* Button Styles - Complete Framework */
        .btn {
            padding: var(--padding-sm) var(--padding-md);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all var(--transition-speed);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .btn-edit {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-edit:hover {
            background-color: #2980b9;
        }

        /* Content Styles */
        .content {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .content-header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin: 0;
        }

        /* Job Details Specific Styles (Preserved) */
        .job-details-container {
            padding: 0;
            width: 100%;
            margin: 0 auto;
        }

        /* Tab Styles */
        .tab-navigation {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .tab-button:hover {
            background: #e9ecef;
        }

        .tab-button.active {
            background: #007bff;
            color: white;
        }        .tab-content {
            display: none;
            width: 100%;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Job Card Styles */        .job-card-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.75rem;
            width: 100%;
        }        .form-grid {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .form-grid-row {
            display: flex;
            gap: 0.75rem;
            align-items: end;
        }

        .form-grid-row .form-group {
            flex: 1;
        }

        .form-grid-row .form-group:first-child {
            flex: 2;
        }

        @media (max-width: 768px) {
            .form-grid-row {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .form-grid-row .form-group:first-child {
                flex: 1;
            }
        }

        /* Page Header Styles */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 0.55rem 0.75rem;
            border-radius: 0;
            margin: 0.35rem 0 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.8rem;
        }

        .page-header i {
            font-size: 0.9rem;
        }

        .header-main {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .page-title {
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.8rem;
            margin: 0;
            font-weight: 600;
        }

        .page-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            flex-shrink: 0;
        }

        /* Responsive adjustments for header */
        @media (max-width: 768px) {
            .page-header {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            
            .page-title {
                font-size: 0.75rem;
                gap: 0.5rem;
            }
            
            .header-main {
                gap: 0.5rem;
            }
        }

        .form-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }        .section-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.95rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .settings-btn {
            margin-left: auto;
            background: #6c757d;
            color: white;
            border: none;
        }

        .settings-btn:hover {
            background: #5a6268;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            color: #495057;
            font-size: 0.8rem;
        }

        .form-control {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.8rem;
            background-color: #fff;
        }

        .form-control[readonly] {
            background-color: #f8f9fa;
            cursor: default;
        }

        textarea.form-control {
            resize: none;
            min-height: 80px;
        }

        .required {
            color: #dc3545;
            margin-left: 0.25rem;
        }

        .job-header {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .job-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .job-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
        }        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .application-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .detail-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .detail-section h3 {
            margin-bottom: 1rem;
            color: #495057;
            font-size: 1.1rem;
        }

        .detail-list {
            display: grid;
            gap: 1rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .detail-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .detail-value {
            color: #212529;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Create Button Section */
        .create-button-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 0;
            margin-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .job-action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .job-action-buttons .btn {
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            min-width: 150px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .job-action-buttons .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        .job-action-buttons .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
            transform: translateY(-1px);
        }

        .job-action-buttons .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .job-action-buttons .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
            transform: translateY(-1px);
        }

        .create-button-section .text-muted {
            text-align: center;
            margin: 0;
            font-size: 0.875rem;
        }

        .create-button-section .text-warning {
            color: #856404 !important;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 1rem;
            max-width: 400px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .notification-success {
            border-left: 4px solid #28a745;
        }

        .notification-error {
            border-left: 4px solid #dc3545;
        }

        .notification-info {
            border-left: 4px solid #17a2b8;
        }

        .notification-success .fas {
            color: #28a745;
        }

        .notification-error .fas {
            color: #dc3545;
        }

        .notification-info .fas {
            color: #17a2b8;
        }

        /* Job Board Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .settings-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .settings-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 12px 12px 0 0;
        }

        .settings-modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .settings-modal-body {
            padding: 1.5rem;
        }

        .job-board-config {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .job-board-config:last-child {
            margin-bottom: 0;
        }

        .config-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #495057;
        }

        .config-form-group {
            margin-bottom: 1rem;
        }

        .config-form-group:last-child {
            margin-bottom: 0;
        }

        .config-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .config-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .config-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .settings-modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-dropdown {
            display: none !important;
            position: absolute;
            right: 0;
            top: 100%;
            width: 320px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 2001; /* above settings modal and header */
            border: 1px solid #e9ecef;
            max-height: 400px;
            overflow: hidden;
        }

        .notification-dropdown.show {
            display: block !important;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .clear-all-notifications {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .clear-all-notifications:hover {
            background: #fdf2f2;
            color: #c0392b;
        }

        .notification-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 4px;
        }

        .notification-item:hover .notification-actions {
            display: flex;
        }

        .mark-read-btn, .delete-notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .mark-read-btn {
            color: #3498db;
        }

        .mark-read-btn:hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .delete-notification-btn {
            color: #e74c3c;
        }

        .delete-notification-btn:hover {
            background: #fdf2f2;
            color: #c0392b;
        }

        .notification-item.read .mark-read-btn {
            color: #95a5a6;
            cursor: default;
        }

        .notification-item.read .mark-read-btn:hover {
            background: none;
            color: #95a5a6;
        }

        .notification-list {
            max-height: 320px;
            overflow-y: auto;
            padding: 0;
        }

        .notification-list::-webkit-scrollbar {
            width: 4px;
        }

        .notification-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .notification-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f1f1;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-item:hover {
            background: #f8f9fa;
        }

        .notification-item.unread {
            background: #e8f4fd;
            border-left: 3px solid #3498db;
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            top: 16px;
            right: 16px;
            width: 8px;
            height: 8px;
            background: #3498db;
            border-radius: 50%;
        }

        .notification-dot {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 8px;
            height: 8px;
            background: #3498db;
            border-radius: 50%;
        }

        .notification-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .notification-icon.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .notification-icon.success {
            background: #e8f5e8;
            color: #2e7d2e;
        }

        .notification-icon.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .notification-icon.error {
            background: #ffebee;
            color: #d32f2f;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
        }

        .notification-title {
            font-weight: 600;
            font-size: 13px;
            color: #333;
            margin-bottom: 2px;
            line-height: 1.3;
        }

        .notification-message {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .notification-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .notification-empty i {
            font-size: 32px;
            margin-bottom: 12px;
            color: #ddd;
        }

        .notification-empty-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #666;
        }

        .notification-empty-message {
            font-size: 12px;
            color: #999;
        }
        
        /* Permission-based menu visibility relies on JavaScript only */
        /* No CSS rules needed - menu visibility controlled by permission system */
    </style>
</head>
<body>
    <!-- Authentication Status Indicator -->
    <div id="authStatus" style="display: none; position: fixed; top: 10px; right: 10px; background: #10b981; color: white; padding: 8px 15px; border-radius: 5px; font-size: 12px; z-index: 1000;">
        <i class="fas fa-shield-alt"></i> Authenticated
    </div>
    
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header">Loading...</span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn" onclick="
                            const notifDropdown = document.querySelector('.notification-dropdown');
                            notifDropdown.classList.toggle('show');
                        ">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3><i class="fas fa-bell" style="margin-right: 6px; color: #3498db;"></i>Notifications</h3>
                                <div>
                                    <button class="mark-all-read">Mark all as read</button>
                                    <button class="clear-all-notifications">Clear all</button>
                                </div>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <!-- Empty state -->
                                <div class="notification-empty" id="notificationEmpty">
                                    <i class="fas fa-bell-slash"></i>
                                    <div class="notification-empty-title">No notifications</div>
                                    <div class="notification-empty-message">You're all caught up!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="https://via.placeholder.com/40x40/3498db/ffffff?text=U" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="#"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>            <!-- Job Details Content -->
            <!-- Page Header -->
            <div class="page-header">
                <div style="display: flex; align-items: center; gap: 0.6rem;">
                    <i class="fas fa-bullhorn"></i>
                    <span>Job advertising form</span>
                </div>
                <div class="page-actions">
                    <!-- Future action buttons can be added here -->
                </div>
            </div>

            <div class="job-details-container">
                <!-- Job Card Content -->
                <div id="jobcardTab" class="tab-content active">
                    <div class="job-card-container">
                        <form id="jobCardForm" class="form-grid">
                            <!-- Position Information -->
                            <div class="form-section">
                                <div class="section-title">
                                    <i class="fas fa-briefcase"></i> Position Information
                                </div>
                                <div class="form-grid">
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">Job Title</label>
                                            <input type="text" class="form-control" id="jobCardTitle" placeholder="Enter job title">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Position Code</label>
                                            <input type="text" class="form-control" id="positionCode" placeholder="Auto-generated">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Department</label>
                                            <input type="text" class="form-control" id="department" placeholder="Enter department">
                                        </div>
                                    </div>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">Employment Type</label>
                                            <input type="text" class="form-control" id="employmentType" placeholder="e.g., Full-time, Part-time">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Employment Status</label>
                                            <input type="text" class="form-control" id="employmentStatus" placeholder="e.g., Permanent, Contract">
                                        </div>
                                        <div class="form-group" style="display: none;">
                                            <label class="form-label">Working Hours/Week</label>
                                            <input type="text" class="form-control" id="workingHours" placeholder="e.g., 40 hours/week">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Line Manager</label>
                                            <input type="text" class="form-control" id="lineManager" placeholder="Enter line manager name">
                                        </div>
                                    </div>
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">Primary Work Location</label>
                                            <input type="text" class="form-control" id="workLocation" placeholder="Enter primary work location">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Minimum Salary (Annual)</label>
                                            <input type="number" class="form-control" id="salaryMin" placeholder="Enter minimum salary">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Maximum Salary (Annual)</label>
                                            <input type="number" class="form-control" id="salaryMax" placeholder="Enter maximum salary">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Job Description & Requirements -->
                            <div class="form-section">
                                <div class="section-title">
                                    <i class="fas fa-clipboard-list"></i> Job Description & Requirements
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Job Description</label>
                                    <textarea class="form-control" id="jobDescription" rows="4" placeholder="Enter detailed job description"></textarea>
                                </div>
                                <div class="form-grid">
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">Required Education</label>
                                            <input type="text" class="form-control" id="requiredEducation" placeholder="e.g., Bachelor's degree">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Required Experience</label>
                                            <input type="text" class="form-control" id="requiredExperience" placeholder="e.g., 3-5 years">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Required Skills</label>
                                    <textarea class="form-control" id="requiredSkills" rows="3" placeholder="Enter required skills and competencies"></textarea>
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <div class="form-section">
                                <div class="section-title">
                                    <i class="fas fa-info-circle"></i> Additional Information
                                </div>
                                <div class="form-grid">
                                    <div class="form-grid-row">
                                        <div class="form-group">
                                            <label class="form-label">Hiring Urgency</label>
                                            <input type="text" class="form-control" id="urgency" placeholder="e.g., High, Medium, Low">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="startDate">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Job Advertising Closing Date</label>
                                            <input type="date" class="form-control" id="advertisingClosingDate" placeholder="Select closing date for job advertising">
                                        </div>
                                    </div>
                                </div><div class="form-group">
                                    <label class="form-label">Additional Notes</label>
                                    <textarea class="form-control" id="notes" rows="3" placeholder="Enter additional notes or comments"></textarea>                                </div>                            </div>                        </form>

                        <!-- Create Button Section -->
                        <div class="create-button-section">
                            <div class="job-action-buttons">
                                <button class="btn btn-secondary" id="saveDraftBtn" onclick="createJob('draft')">
                                    <i class="fas fa-save"></i> Save as Draft
                                </button>
                                <button class="btn btn-success" id="publishJobBtn" onclick="createJob('published')">
                                    <i class="fas fa-bullhorn"></i> Publish Job
                                </button>
                            </div>
                            <p class="text-muted mt-2">
                                <small>
                                    <i class="fas fa-info-circle"></i>
                                    Save as draft to review later, or publish immediately to display on job board
                                </small>
                            </p>
                        </div>
                    </div>                </div>
            </div>
        </main>
    </div>    <!-- Job Board Settings Modal -->
    <div class="settings-modal" id="jobBoardSettingsModal">
        <div class="settings-modal-content">
            <div class="settings-modal-header">
                <h3 class="settings-modal-title">
                    <i class="fas fa-cog"></i> Job Board Settings
                </h3>
                <button class="close-btn" onclick="closeJobBoardSettings()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="settings-modal-body">
                <!-- LinkedIn Configuration -->
                <div class="job-board-config">
                    <div class="config-header">
                        <i class="fab fa-linkedin" style="color: #0077b5;"></i>
                        LinkedIn
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Company Page URL</label>
                        <input type="url" class="config-input" id="linkedin-url" 
                               placeholder="https://www.linkedin.com/company/your-company" 
                               value="https://www.linkedin.com/company/dreamex-lab">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">API Key</label>
                        <input type="password" class="config-input" id="linkedin-api" 
                               placeholder="Enter LinkedIn API key">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Auto-publish</label>
                        <select class="config-input" id="linkedin-auto">
                            <option value="manual">Manual approval required</option>
                            <option value="auto">Auto-publish immediately</option>
                            <option value="scheduled">Schedule for optimal times</option>
                        </select>
                    </div>
                </div>

                <!-- Indeed Configuration -->
                <div class="job-board-config">
                    <div class="config-header">
                        <i class="fas fa-search" style="color: #2557a7;"></i>
                        Indeed
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Employer Account URL</label>
                        <input type="url" class="config-input" id="indeed-url" 
                               placeholder="https://secure.indeed.com/account" 
                               value="https://secure.indeed.com/account/dreamex-lab">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">API Token</label>
                        <input type="password" class="config-input" id="indeed-api" 
                               placeholder="Enter Indeed API token">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Job Posting Budget (per job)</label>
                        <input type="number" class="config-input" id="indeed-budget" 
                               placeholder="0" value="150" min="0">
                    </div>
                </div>

                <!-- Seek Configuration -->
                <div class="job-board-config">
                    <div class="config-header">
                        <i class="fas fa-briefcase" style="color: #0d7377;"></i>
                        Seek
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Employer Profile URL</label>
                        <input type="url" class="config-input" id="seek-url" 
                               placeholder="https://www.seek.com.au/companies/your-company" 
                               value="https://www.seek.com.au/companies/dreamex-lab">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Integration Key</label>
                        <input type="password" class="config-input" id="seek-api" 
                               placeholder="Enter Seek integration key">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Default Job Duration</label>
                        <select class="config-input" id="seek-duration">
                            <option value="7">7 days</option>
                            <option value="14">14 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="60">60 days</option>
                        </select>
                    </div>
                </div>

                <!-- Facebook Configuration -->
                <div class="job-board-config">
                    <div class="config-header">
                        <i class="fab fa-facebook" style="color: #1877f2;"></i>
                        Facebook Jobs
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Business Page URL</label>
                        <input type="url" class="config-input" id="facebook-url" 
                               placeholder="https://www.facebook.com/your-business-page" 
                               value="https://www.facebook.com/dreamexlab">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Page Access Token</label>
                        <input type="password" class="config-input" id="facebook-token" 
                               placeholder="Enter Facebook page access token">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Post to Timeline</label>
                        <select class="config-input" id="facebook-timeline">
                            <option value="false">Jobs section only</option>
                            <option value="true">Jobs section + Timeline post</option>
                        </select>
                    </div>
                </div>

                <!-- Instagram Configuration -->
                <div class="job-board-config">
                    <div class="config-header">
                        <i class="fab fa-instagram" style="color: #e4405f;"></i>
                        Instagram Business
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Business Account</label>
                        <input type="text" class="config-input" id="instagram-handle" 
                               placeholder="@your_business_account" 
                               value="@dreamexlab">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Access Token</label>
                        <input type="password" class="config-input" id="instagram-token" 
                               placeholder="Enter Instagram Business API token">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Post Type</label>
                        <select class="config-input" id="instagram-type">
                            <option value="story">Story only</option>
                            <option value="feed" selected>Feed post</option>
                            <option value="both">Story + Feed post</option>
                        </select>
                    </div>
                </div>

                <!-- Google Jobs Configuration -->
                <div class="job-board-config">
                    <div class="config-header">
                        <i class="fab fa-google" style="color: #4285f4;"></i>
                        Google for Jobs
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Company Website</label>
                        <input type="url" class="config-input" id="google-website" 
                               placeholder="https://your-company-website.com" 
                               value="https://www.dreamexlab.com">
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Structured Data Format</label>
                        <select class="config-input" id="google-format">
                            <option value="json-ld" selected>JSON-LD</option>
                            <option value="microdata">Microdata</option>
                            <option value="rdfa">RDFa</option>
                        </select>
                    </div>
                    <div class="config-form-group">
                        <label class="config-label">Auto-generate Schema</label>
                        <select class="config-input" id="google-schema">
                            <option value="true" selected>Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="settings-modal-footer">
                <button class="btn btn-secondary" onclick="closeJobBoardSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveJobBoardSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase v8 if not already initialized
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('✅ Firebase v8 initialized successfully');
            }
            
            // Verify Firebase Storage is available
            if (window.firebase && window.firebase.storage) {
                console.log('✅ Firebase Storage is available');
                
                // Test storage configuration
                try {
                    const storage = window.firebase.storage();
                    console.log('✅ Firebase Storage initialized successfully');
                    console.log('📁 Storage bucket:', firebaseConfig.storageBucket);
                } catch (storageError) {
                    console.error('❌ Firebase Storage initialization failed:', storageError);
                }
            } else {
                console.error('❌ Firebase Storage is not available - check if firebase-storage.js is loaded');
            }
            
            return window.firebase;
        }

        // Authentication functions using Firebase v8
        function loginWithEmail(email, password) {
            return new Promise((resolve, reject) => {
                const firebase = initializeFirebase();
                const auth = firebase.auth();
                
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        resolve(userCredential.user);
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }

        function logoutUser() {
            return new Promise((resolve, reject) => {
                const firebase = initializeFirebase();
                const auth = firebase.auth();
                
                auth.signOut()
                    .then(() => {
                        resolve(true);
                    })
                    .catch((error) => {
                        console.error('Logout error:', error);
                        resolve(false);
                    });
            });
        }

        // Database functions using Firebase v8
        function getDatabase() {
            const firebase = initializeFirebase();
            return firebase.database();
        }

        function ref(database, path) {
            return database.ref(path);
        }

        function get(reference) {
            return reference.once('value');
        }

        function set(reference, value) {
            return reference.set(value);
        }

        function update(reference, values) {
            return reference.update(values);
        }

        function onValue(reference, callback, options = {}) {
            if (options.onlyOnce) {
                return reference.once('value', callback);
            } else {
                return reference.on('value', callback);
            }
        }

        // Authentication Manager Class - Centralized from Dashboard.html
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.db = getDatabase();
                this.currentCompany = null;
                
                // Debug log
                console.log('🔐 AuthManager initialized');
                console.log('Current user:', this.currentUser);
                
                this.initializeAuth();
            }

            initializeAuth() {
                // Check if user is logged in
                if (!this.currentUser) {
                    // Check if this is a redirect from login
                    if (window.location.pathname.includes('dashboard.html')) {
                        window.location.href = 'login.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                    return;
                }
                
                console.log('✅ User authenticated successfully');
                
                // Load user data and update UI
                this.loadUserRole(this.currentUser);
                this.loadUserCompany();
                this.updateUIForAuthenticatedUser();
                this.updateMenuVisibility();

                // Add event listeners for user profile dropdown
                const userProfileBtn = document.getElementById('userProfileBtn');
                const profileDropdown = document.querySelector('.profile-dropdown');
                
                if (userProfileBtn && profileDropdown) {
                    userProfileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                    });

                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!userProfileBtn.contains(e.target)) {
                            profileDropdown.classList.remove('show');
                        }
                    });
                }

                // Handle logout
                const logoutBtn = document.querySelector('.profile-dropdown a[href="#"]');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.logout();
                    });
                }
            }

            getCurrentUser() {
                try {
                    return JSON.parse(localStorage.getItem('currentUser') || 'null');
                } catch (error) {
                    console.error('Error parsing current user:', error);
                    return null;
                }
            }

            setCurrentUser(userData) {
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('user', JSON.stringify(userData));
                this.currentUser = userData;
            }

            async logout() {
                const success = await logoutUser();
                if (success) {
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    sessionStorage.removeItem('currentUser');
                    sessionStorage.removeItem('user');
                    this.currentUser = null;
                    window.location.href = 'index.html';
                }
            }

            // Enhanced Menu System - Feature-based Authorization with Fallback
            resetMenuVisibility() {
                console.log('🔄 Resetting menu visibility for jobdetails.html');
                document.querySelectorAll('[data-feature]').forEach(item => {
                    item.classList.remove('menu-visible');
                });
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('menu-visible');
                });
            }

            showBasicMenu() {
                console.log('📋 Showing basic menu for jobdetails.html - no items (strict feature authorization)');
                this.resetMenuVisibility();
                
                // Show nothing by default - let platform features control everything
                // This ensures strict compliance with feature-based authorization
                console.log('🔒 No basic features shown - platform features control all visibility');
            }

            async updateMenuVisibility() {
                console.log('🎯 Starting enhanced menu visibility update for jobdetails.html...');
                
                // Remove loading class
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                try {
                    // Step 1: Try feature-based authorization first
                    console.log('📋 Step 1: Attempting feature-based authorization');
                    const featureBasedSuccess = await this.updateMenuWithFeatureAuthorization();
                    
                    if (featureBasedSuccess) {
                        console.log('✅ Feature-based authorization applied successfully');
                        return;
                    }
                    
                    console.log('⚠️ Feature-based authorization failed, falling back to role-based permissions');
                    
                    // Step 2: Fallback to role-based permissions
                    if (!this.currentUser) {
                        console.log('❌ No authenticated user found');
                        this.showBasicMenu();
                        return;
                    }
                    
                    // Get user's company ID and role
                    const companyId = this.currentUser.companyId;
                    const userRole = this.currentUser.role;
                    
                    if (!companyId || !userRole) {
                        console.log('❌ Missing company ID or user role');
                        this.showBasicMenu();
                        return;
                    }
                    
                    console.log(`👤 User: role=${userRole}, companyId=${companyId}`);
                    
                    // Get company role permissions
                    const permissionsRef = ref(this.db, `companies/${companyId}/roles/${userRole}/permissions`);
                    console.log(`🔍 Checking permissions at: companies/${companyId}/roles/${userRole}/permissions`);
                    
                    const permissionsSnapshot = await get(permissionsRef);
                    
                    if (!permissionsSnapshot.exists()) {
                        console.log(`❌ No permissions found for role ${userRole} in company ${companyId}`);
                        
                        // Try to get all roles to see what's available
                        const allRolesRef = ref(this.db, `companies/${companyId}/roles`);
                        const allRolesSnapshot = await get(allRolesRef);
                        
                        if (allRolesSnapshot.exists()) {
                            const allRoles = allRolesSnapshot.val();
                            console.log('🔍 Available roles in company:', Object.keys(allRoles));
                            
                            // Check if the role exists with different casing or format
                            const roleKeys = Object.keys(allRoles);
                            const matchingRole = roleKeys.find(key => 
                                key.toLowerCase() === userRole.toLowerCase() ||
                                key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                            );
                            
                            if (matchingRole && allRoles[matchingRole].permissions) {
                                console.log(`✅ Found matching role: ${matchingRole}`);
                                const permissions = allRoles[matchingRole].permissions;
                                this.updateMenuWithPermissions(permissions);
                                return;
                            }
                        }
                        
                        console.log('❌ No valid permissions found - showing basic menu');
                        this.showBasicMenu();
                        return;
                    }
                    
                    const permissions = permissionsSnapshot.val();
                    console.log('✅ Loaded permissions:', permissions);
                    this.updateMenuWithPermissions(permissions);
                    
                } catch (error) {
                    console.error('❌ Error updating menu visibility:', error);
                    this.showBasicMenu();
                }
            }

            /**
             * Update sidebar menu visibility based on platform features' authorized pages
             * This system takes priority over role-based permissions
             */
            async updateMenuWithFeatureAuthorization() {
                console.log('🎯 Loading feature-based menu authorization for jobdetails.html...');
                
                try {
                    // Get platform features from Firebase
                    const featuresSnapshot = await this.db.ref('/platformFeatures').once('value');
                    const featuresData = featuresSnapshot.val();
                    
                    if (!featuresData) {
                        console.log('⚠️ No platform features found, falling back to role-based permissions');
                        return false; // Indicates fallback to role-based system
                    }
                    
                    // Get company ID using the same method as other functions
                    let currentUser = this.currentUser;
                    let companyId = currentUser?.companyId;
                    
                    // If we don't have company ID, try to find it by searching companies
                    if (!companyId && currentUser) {
                        console.log('🔍 Company ID not available, searching for user in companies...');
                        const companiesRef = this.db.ref('companies');
                        const companiesSnapshot = await companiesRef.once('value');
                        
                        if (companiesSnapshot.exists()) {
                            const companies = companiesSnapshot.val();
                            
                            // Search through all companies for the current user
                            for (const [cId, company] of Object.entries(companies)) {
                                if (company.status !== 'active') continue;
                                
                                if (company.users && company.users[currentUser.uid]) {
                                    companyId = cId;
                                    console.log(`✅ Found user in company: ${companyId}`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (!companyId) {
                        console.log('⚠️ No company ID found, falling back to role-based permissions');
                        return false;
                    }
                    
                    console.log(`🏢 Using company ID: ${companyId}`);
                    
                    const companySnapshot = await this.db.ref(`/companies/${companyId}`).once('value');
                    const companyData = companySnapshot.val();
                    const subscribedFeatureIds = companyData?.selectedFeatures || [];
                    
                    console.log('🔍 Company subscribed features:', subscribedFeatureIds);
                    
                    // Collect all authorized pages from active subscribed features
                    const authorizedPages = [];
                    subscribedFeatureIds.forEach(featureId => {
                        const feature = featuresData[featureId];
                        if (feature && feature.status === 'active' && feature.authorizedPages) {
                            authorizedPages.push(...feature.authorizedPages);
                            console.log(`✅ Added authorized pages from feature: ${feature.name}`, feature.authorizedPages);
                        }
                    });
                    
                    console.log('📋 All authorized pages from subscribed features:', authorizedPages);
                    
                    // Apply feature-based menu visibility
                    this.applyFeatureBasedMenuVisibility(authorizedPages);
                    
                    return true; // Indicates feature-based system was applied
                    
                } catch (error) {
                    console.error('❌ Error loading feature-based menu authorization:', error);
                    return false; // Fallback to role-based system
                }
            }

            /**
             * Apply menu visibility based on feature authorized pages
             */
            applyFeatureBasedMenuVisibility(authorizedPages) {
                console.log('🎯 Applying feature-based menu visibility for jobdetails.html...');
                
                // Reset all menu items to hidden first
                this.resetMenuVisibility();
                
                // Create a set of authorized feature data attributes for quick lookup
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                // Do NOT add always visible features - let platform features control everything
                console.log('🔐 Authorized features from subscribed platform features only:', Array.from(authorizedFeatures));
                
                // Get all menu items in the sidebar
                const allMenuItems = document.querySelectorAll('[data-feature]');
                let visibleCount = 0;
                
                // Update visibility for each menu item
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    // Skip dropdown containers initially - they will be handled later
                    if (isDropdownContainer) {
                        return;
                    }
                    
                    if (isAuthorized) {
                        // Show the menu item
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${featureAttribute} (authorized by platform features)`);
                    } else {
                        // Hide the menu item
                        menuItem.classList.remove('menu-visible');
                        console.log(`❌ Hiding menu item: ${featureAttribute} (not authorized by platform features)`);
                    }
                });
                
                // Handle dropdown menus - show dropdown if any children are visible
                const dropdownMenus = document.querySelectorAll('.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children)`);
                    }
                });
                
                console.log(`🎯 Feature-based menu visibility applied for jobdetails.html - ${visibleCount} items visible`);
            }

            updateMenuWithPermissions(permissions) {
                console.log('🎯 Updating menu with permissions for jobdetails.html...');
                console.log('🎯 Permissions object:', permissions);
                
                // Reset menu visibility first
                this.resetMenuVisibility();
                
                if (!permissions) {
                    console.log('⚠️ No permissions object provided');
                    return;
                }
                
                // Update menu visibility based on permissions
                const menuItems = document.querySelectorAll('[data-feature]');
                console.log(`🎯 Found ${menuItems.length} menu items to check`);
                let visibleCount = 0;
                
                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    const isSubmenuItem = item.closest('.submenu') !== null;
                    const isDropdownContainer = item.classList.contains('menu-dropdown');
                    const parentDropdown = item.closest('.menu-dropdown');
                    const parentFeature = parentDropdown ? parentDropdown.getAttribute('data-feature') : 'none';
                    
                    console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission}) [Submenu: ${isSubmenuItem}, Dropdown: ${isDropdownContainer}, Parent: ${parentFeature}]`);
                    
                    // Skip dropdown containers - they will be handled separately
                    if (isDropdownContainer) {
                        console.log(`⏭️ Skipping dropdown container: ${feature} (will be handled by dropdown logic)`);
                        return;
                    }
                    
                    // If item doesn't require permission, check if user has permission for this feature
                    if (!requiresPermission) {
                        // Check if user has permission for this feature
                        if (feature && permissions[feature]) {
                            const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                            if (hasViewPermission) {
                                item.classList.add('menu-visible');
                                visibleCount++;
                                console.log(`✅ Showing menu item: ${feature}`);
                            } else {
                                console.log(`❌ No view permission for: ${feature}`);
                            }
                        } else {
                            // For basic features like home, show by default
                            if (feature === 'home_view' || feature === 'settings_view' || feature === 'company_management_view') {
                                item.classList.add('menu-visible');
                                visibleCount++;
                                console.log(`✅ Showing basic menu item: ${feature}`);
                            } else {
                                console.log(`⚪ Feature not found in permissions: ${feature}`);
                            }
                        }
                        return;
                    }
                    
                    // If item requires permission, check if user has it using the requiresPermission value
                    const permissionKey = requiresPermission;
                    if (permissionKey && permissions[permissionKey]) {
                        console.log(`🔍 Found permission for ${permissionKey}:`, permissions[permissionKey]);
                        
                        // Check if the permission has a 'view' property or if it's a boolean true
                        const hasViewPermission = permissions[permissionKey].view === true || permissions[permissionKey] === true;
                        
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature} (permission: ${permissionKey})`);
                        } else {
                            console.log(`❌ No view permission for: ${feature} (permission: ${permissionKey})`, permissions[permissionKey]);
                        }
                    } else {
                        console.log(`⚪ Permission not found: ${permissionKey} for feature: ${feature}`);
                        console.log(`⚪ Available permissions:`, Object.keys(permissions));
                    }
                });
                
                // Handle dropdown menus - show dropdown if any children are visible
                const dropdownMenus = document.querySelectorAll('.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    const hasVisibleChildren = visibleSubmenuItems.length > 0;
                    
                    console.log(`🔍 Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
                    
                    if (hasVisibleChildren) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown ${dropdownFeature} (no visible children)`);
                    }
                });
                
                console.log(`🎯 Menu update with permissions completed for jobdetails.html - ${visibleCount} items visible`);
                
                // Remove loading state from sidebar
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
            }

            async loadUserRole(userData) {
                // Load user role from Firebase if not available
                if (!userData.role && userData.uid) {
                    try {
                        const userRef = ref(this.db, `users/${userData.uid}`);
                        const userSnapshot = await get(userRef);
                        if (userSnapshot.exists()) {
                            const userRole = userSnapshot.val().role || 'user';
                            userData.role = userRole;
                            this.setCurrentUser(userData);
                        }
                    } catch (error) {
                        console.error('Error loading user role:', error);
                    }
                }
            }

            async loadUserCompany() {
                if (!this.currentUser) return;

                try {
                    const companiesRef = ref(this.db, 'companies');
                    const companiesSnapshot = await get(companiesRef);
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === this.currentUser.uid || userId === this.currentUser.uid) {
                                        foundCompany = company;
                                        this.currentUser.companyId = companyId;
                                        this.currentUser.companyName = company.companyName;
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            this.currentCompany = foundCompany;
                            this.updateCompanyBranding();
                        }
                    }
                } catch (error) {
                    console.error('Error loading user company:', error);
                }
            }

            updateCompanyBranding() {
                console.log('🏢 Updating company branding in header...');
                
                // Update header logo and name
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const companyNameHeader = document.getElementById('headerCompanyName');

                // Get company name from various sources
                const companyName = this.currentCompany?.companyName || 
                                  this.currentUser?.companyName || 
                                  'Company';

                // Update company logo
                if (this.currentCompany && this.currentCompany.logo && headerLogo) {
                    headerLogo.src = this.currentCompany.logo;
                    headerLogo.classList.add('visible');
                    headerLogo.style.display = 'block';
                    if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'none';
                    console.log('✅ Company logo displayed in header');
                } else {
                    // Show placeholder when no logo is available
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                    }
                    if (headerLogo) {
                        headerLogo.classList.remove('visible');
                        headerLogo.style.display = 'none';
                    }
                    console.log('✅ Company logo placeholder displayed in header');
                }

                // Update company name
                if (companyNameHeader) {
                    companyNameHeader.textContent = companyName;
                    companyNameHeader.style.display = 'inline-block';
                    console.log('✅ Company name updated in header:', companyName);
                }

                // Update page title if needed
                const title = document.title;
                if (title.includes('Dreamex Datalab HSE')) {
                    document.title = title.replace('Dreamex Datalab HSE', `${companyName} HSE`);
                }

                // Apply company branding colors if available
                if (this.currentCompany && this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) {
                        root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    }
                    if (this.currentCompany.branding.secondaryColor) {
                        root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                    }
                }
                
                console.log('🏢 Company branding update completed');
            }

            async updateUIForAuthenticatedUser() {
                const profileBtn = document.querySelector('.profile-btn');
                const profileDropdown = document.querySelector('.profile-dropdown ul');
                
                if (profileBtn && profileDropdown) {
                    if (this.currentUser) {
                        // Use centralized display methods
                        const initials = this.getUserInitials();
                        const displayName = this.getUserDisplayName();
                        const email = this.getUserEmail();
                        
                        // Preload avatar URL to avoid showing initials first
                        const avatarUrl = await this.getUserAvatarUrl();
                        
                        // Update profile image - now show the correct image immediately
                        const profileImg = profileBtn.querySelector('img');
                        if (profileImg) {
                            if (avatarUrl) {
                                profileImg.src = avatarUrl;
                                profileImg.alt = displayName + ' Avatar';
                            } else {
                                // Generate initials avatar
                                this.generateInitialsAvatar(displayName, profileImg);
                            }
                        }
                        
                        // Create avatar for dropdown (either real avatar or initials)
                        let dropdownAvatarHtml;
                        if (avatarUrl) {
                            dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                        }
                        
                        // Update profile dropdown with user info
                        const userInfoHtml = `
                            <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${dropdownAvatarHtml}
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                            ${displayName}
                                        </div>
                                        <div style="color: #666; font-size: 12px;">
                                            ${email}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="#"><i class="fas fa-user"></i> Account Settings</a></li>
                            <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        `;
                        
                        profileDropdown.innerHTML = userInfoHtml;
                        
                        // Re-attach logout event listener
                        const logoutBtn = profileDropdown.querySelector('a[href="#"]');
                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                this.logout();
                            });
                        }
                        
                        // Update menu visibility based on user permissions
                        await this.updateMenuVisibility();
                    }
                }
            }

            // Get user display name
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                
                const cleanName = (name) => {
                    if (!name || typeof name !== 'string') return '';
                    return name.trim().replace(/\s+/g, ' ');
                };
                
                const potentialNames = [
                    this.currentUser.displayName,
                    this.currentUser.name,
                    this.currentUser.username
                ];
                
                for (const name of potentialNames) {
                    const cleaned = cleanName(name);
                    if (cleaned) return cleaned;
                }
                
                if (this.currentUser.email) {
                    const emailUsername = this.currentUser.email.split('@')[0];
                    const cleaned = cleanName(emailUsername);
                    if (cleaned) return cleaned;
                }
                
                return 'User';
                
                // Load notifications after authentication is complete
                setTimeout(() => {
                    this.refreshNotifications();
                    console.log('🔔 Notifications refreshed after authentication');
                }, 1000);
            }

            // Get user initials for avatar display
            getUserInitials() {
                const displayName = this.getUserDisplayName();
                
                if (!displayName || displayName === 'User') return 'U';
                
                const words = displayName.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            // Get user email
            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Generate initials avatar
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Get user avatar URL or null if not available
            async getUserAvatarUrl() {
                if (!this.currentUser) {
                    console.log('❌ No current user for avatar loading');
                    return null;
                }
                
                console.log('🔍 Loading avatar for user:', this.currentUser.uid);
                
                try {
                    // First try to get from user profile data
                    if (this.currentUser.photoURL) {
                        console.log('✅ Using photoURL from user profile:', this.currentUser.photoURL);
                        return this.currentUser.photoURL;
                    }
                    
                    if (this.currentUser.profilePicture) {
                        console.log('✅ Using profilePicture from user profile:', this.currentUser.profilePicture);
                        return this.currentUser.profilePicture;
                    }
                    
                    // Then try Firebase Storage
                    console.log('🔍 Checking Firebase Storage for avatar...');
                    
                    if (!window.firebase) {
                        console.error('❌ Firebase not available');
                        return null;
                    }
                    
                    if (!window.firebase.storage) {
                        console.error('❌ Firebase Storage not available');
                        return null;
                    }
                    
                    const firebase = window.firebase;
                    const storage = firebase.storage();
                    console.log('✅ Firebase Storage initialized for avatar search');
                    
                    const avatarPaths = [
                        `avatars/${this.currentUser.uid}/profile.jpg`,
                        `avatars/${this.currentUser.uid}/profile.png`,
                        `avatars/${this.currentUser.uid}/avatar.jpg`,
                        `avatars/${this.currentUser.uid}/avatar.png`,
                        `users/${this.currentUser.uid}/profile.jpg`,
                        `users/${this.currentUser.uid}/avatar.jpg`
                    ];
                    
                    console.log('🔍 Searching for avatar in paths:', avatarPaths);
                    
                    for (const path of avatarPaths) {
                        try {
                            console.log(`🔍 Checking path: ${path}`);
                            const avatarRef = storage.ref(path);
                            const url = await avatarRef.getDownloadURL();
                            console.log(`✅ Found user avatar at: ${path}`);
                            console.log(`✅ Avatar URL: ${url}`);
                            return url;
                        } catch (pathError) {
                            console.log(`❌ Path not found: ${path} - ${pathError.code || pathError.message}`);
                            // Continue to next path
                            continue;
                        }
                    }
                    
                    console.log('ℹ️ No avatar found in Firebase Storage for user:', this.currentUser.uid);
                    return null;
                } catch (error) {
                    console.log('ℹ️ Avatar loading failed, will use initials:', error.message);
                    console.error('Full error:', error);
                    return null;
                }
            }
        }

        // Initialize Firebase when this script loads
        initializeFirebase();

        // Initialize authentication manager
        let authManager = null;

        // Job Published Notification Service Class - Enhanced with EmailJS
        class JobPublishedNotificationService {
            constructor() {
                this.emailServiceUrl = this.getEmailServiceUrl();
                this.apiKey = 'dreemex_hse_email_service_2025';
                
                // EmailJS Configuration for Production
                this.emailJSConfig = {
                    serviceId: 'service_p2e9swy',
                    templateId: 'template_9beph7t', // Using the specified EmailJS template
                    publicKey: 'fHs6oaqQgkcPoUwpv'
                };
                
                // Initialize EmailJS
                this.initializeEmailJS();
                
                console.log('📧 JobPublishedNotificationService initialized with EmailJS template_9beph7t');
            }

            // Initialize EmailJS for production email delivery
            initializeEmailJS() {
                try {
                    if (typeof emailjs !== 'undefined') {
                        emailjs.init(this.emailJSConfig.publicKey);
                        console.log('✅ EmailJS initialized successfully with template_9beph7t');
                        this.emailJSReady = true;
                    } else {
                        console.warn('⚠️ EmailJS library not loaded, falling back to SMTP');
                        this.emailJSReady = false;
                    }
                } catch (error) {
                    console.error('❌ Failed to initialize EmailJS:', error);
                    this.emailJSReady = false;
                }
            }

            // Get email service URL based on environment
            getEmailServiceUrl() {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:3001';
                } else {
                    // Production: use domain with port 3001
                    return `http://${hostname}:3001`;
                }
            }

            // Get submitter and approvers for a position based on position code
            async getPositionRecipients(positionCode, companyId) {
                try {
                    console.log(`📧 Getting recipients for position code: ${positionCode} in company: ${companyId}`);
                    
                    const database = getDatabase();
                    const recipients = [];

                    // Get position data from staff collection to find submitter and approvers
                    const staffRef = ref(database, `companies/${companyId}/staff`);
                    console.log('📧 Fetching staff data from:', `companies/${companyId}/staff`);
                    
                    const staffSnapshot = await get(staffRef);

                    if (!staffSnapshot.exists()) {
                        console.error('❌ No staff data found for company:', companyId);
                        return [];
                    }

                    const allStaff = staffSnapshot.val();
                    console.log('📧 Staff data loaded. Total positions:', Object.keys(allStaff).length);
                    
                    // Debug: Log all available position codes
                    const availablePositionCodes = Object.values(allStaff)
                        .map(s => s.positionCode || s.jobCode)
                        .filter(Boolean);
                    console.log('📧 Available position codes:', availablePositionCodes);
                    
                    // Find the staff position with matching position code
                    let positionFound = false;
                    for (const [staffId, staffData] of Object.entries(allStaff)) {
                        console.log(`📧 Checking staff position: ${staffData.jobTitle} (codes: ${staffData.positionCode}, ${staffData.jobCode})`);
                        
                        if (staffData.positionCode === positionCode || staffData.jobCode === positionCode) {
                            console.log(`📧 ✅ Found matching staff position:`, staffData.jobTitle);
                            positionFound = true;

                            // Add submitter
                            if (staffData.submittedBy) {
                                console.log(`📧 Processing submitter: ${staffData.submittedBy}`);
                                try {
                                    const submitterInfo = await this.getUserInfo(staffData.submittedBy, companyId);
                                    if (submitterInfo && submitterInfo.email) {
                                        recipients.push({
                                            email: submitterInfo.email,
                                            name: submitterInfo.name || submitterInfo.firstName + ' ' + submitterInfo.lastName || 'Position Submitter',
                                            type: 'submitter',
                                            role: 'Position Submitter'
                                        });
                                        console.log(`📧 ✅ Added submitter: ${submitterInfo.email}`);
                                    } else {
                                        console.warn(`📧 ⚠️ Submitter found but no email: ${staffData.submittedBy}`, submitterInfo);
                                    }
                                } catch (error) {
                                    console.warn(`📧 ⚠️ Could not get submitter info for ${staffData.submittedBy}:`, error.message);
                                }
                            } else {
                                console.warn('📧 ⚠️ No submitter found in position data');
                            }

                            // Add approvers from approval history
                            if (staffData.approvalHistory && Array.isArray(staffData.approvalHistory)) {
                                console.log(`📧 Processing ${staffData.approvalHistory.length} approval entries`);
                                
                                for (const [index, approval] of staffData.approvalHistory.entries()) {
                                    console.log(`📧 Processing approval ${index + 1}:`, approval);
                                    
                                    if (approval.status === 'approved' && approval.approvedBy) {
                                        try {
                                            const approverInfo = await this.getUserInfo(approval.approvedBy, companyId);
                                            if (approverInfo && approverInfo.email) {
                                                // Check for duplicates
                                                const isDuplicate = recipients.some(r => r.email === approverInfo.email);
                                                if (!isDuplicate) {
                                                    recipients.push({
                                                        email: approverInfo.email,
                                                        name: approverInfo.name || approverInfo.firstName + ' ' + approverInfo.lastName || approval.approverName || 'Approver',
                                                        type: 'approver',
                                                        role: approval.level || 'Approver',
                                                        approvedAt: approval.approvedAt
                                                    });
                                                    console.log(`📧 ✅ Added approver: ${approverInfo.email} (${approval.level})`);
                                                } else {
                                                    console.log(`📧 ⚠️ Duplicate approver skipped: ${approverInfo.email}`);
                                                }
                                            } else {
                                                console.warn(`📧 ⚠️ Approver found but no email: ${approval.approvedBy}`, approverInfo);
                                            }
                                        } catch (error) {
                                            console.warn(`📧 ⚠️ Could not get approver info for ${approval.approvedBy}:`, error.message);
                                        }
                                    } else {
                                        console.log(`📧 ⚠️ Skipping approval ${index + 1}: status=${approval.status}, approvedBy=${approval.approvedBy}`);
                                    }
                                }
                            } else {
                                console.warn('📧 ⚠️ No approval history found in position data');
                            }

                            break; // Found the position, no need to continue
                        }
                    }
                    
                    if (!positionFound) {
                        console.error(`📧 ❌ No matching position found for code: ${positionCode}`);
                        console.log('📧 Available position codes:', availablePositionCodes);
                    }

                    console.log(`📧 ✅ Found ${recipients.length} recipients for job published notification:`, recipients);
                    return recipients;

                } catch (error) {
                    console.error('📧 ❌ Error getting position recipients:', error);
                    return [];
                }
            }

            // Get user information by user ID
            async getUserInfo(userId, companyId) {
                try {
                    const database = getDatabase();
                    
                    // Try to get from company users first
                    const userRef = ref(database, `companies/${companyId}/users/${userId}`);
                    const userSnapshot = await get(userRef);
                    
                    if (userSnapshot.exists()) {
                        return userSnapshot.val();
                    }

                    // Fallback: try to get from global users
                    const globalUserRef = ref(database, `users/${userId}`);
                    const globalUserSnapshot = await get(globalUserRef);
                    
                    if (globalUserSnapshot.exists()) {
                        return globalUserSnapshot.val();
                    }

                    console.warn(`⚠️ User ${userId} not found in company or global users`);
                    return null;

                } catch (error) {
                    console.error(`❌ Error getting user info for ${userId}:`, error);
                    return null;
                }
            }

            // Send job published notification to all recipients using EmailJS
            async sendJobPublishedNotification(jobData, metadata = {}) {
                try {
                    console.log('📧 Starting job published notification process with EmailJS template_9beph7t...');

                    // Get recipients (submitter and approvers)
                    const recipients = await this.getPositionRecipients(jobData.positionCode, jobData.companyId);

                    if (recipients.length === 0) {
                        console.warn('⚠️ No recipients found for job published notification');
                        return {
                            success: false,
                            message: 'No recipients found for notification',
                            recipients: []
                        };
                    }

                    // Prepare job board URL
                    const jobBoardUrl = metadata.jobBoardUrl || `${window.location.origin}/jobpost.html?companyId=${encodeURIComponent(jobData.companyId)}&jobId=${encodeURIComponent(metadata.jobId || 'unknown')}`;

                    let results = [];
                    let successCount = 0;
                    let failureCount = 0;

                    // Try EmailJS first (Production)
                    if (this.emailJSReady) {
                        console.log('📧 Using EmailJS for production email delivery...');
                        
                        for (const recipient of recipients) {
                            try {
                                // Prepare template parameters for EmailJS template_9beph7t
                                const templateParams = {
                                    // Recipient information
                                    to_name: recipient.name,
                                    to_email: recipient.email,
                                    recipient_type: recipient.type || 'stakeholder',
                                    
                                    // Job details
                                    job_title: jobData.jobTitle,
                                    department: jobData.department || 'Not specified',
                                    position_code: jobData.positionCode || 'N/A',
                                    employment_type: jobData.employmentType || 'Not specified',
                                    work_location: jobData.workLocation || 'Not specified',
                                    published_date: new Date().toLocaleDateString(),
                                    application_deadline: jobData.advertisingClosingDate ? new Date(jobData.advertisingClosingDate).toLocaleDateString() : 'Not specified',
                                    
                                    // Metadata
                                    job_id: metadata.jobId || jobData.positionCode || 'N/A',
                                    job_board_url: jobBoardUrl,
                                    published_timestamp: new Date().toLocaleString(),
                                    
                                    // Company information
                                    company_name: 'Dreamex Datalab',
                                    hr_email: 'hr@dreamexdatalab.com',
                                    
                                    // Dynamic content flags
                                    is_submitter: recipient.type === 'submitter',
                                    is_approver: recipient.type === 'approver',
                                    
                                    // Additional context
                                    notification_type: 'job_published',
                                    system_name: 'Dreamex Datalab HSE System'
                                };

                                console.log(`📧 Sending EmailJS notification to ${recipient.name} (${recipient.email})`);

                                // Send via EmailJS
                                const emailResponse = await emailjs.send(
                                    this.emailJSConfig.serviceId,
                                    this.emailJSConfig.templateId,
                                    templateParams
                                );

                                console.log(`✅ EmailJS sent successfully to ${recipient.email}:`, emailResponse.text);
                                
                                results.push({
                                    email: recipient.email,
                                    name: recipient.name,
                                    status: 'sent_emailjs',
                                    messageId: emailResponse.text,
                                    service: 'EmailJS'
                                });
                                successCount++;

                            } catch (error) {
                                console.error(`❌ EmailJS failed for ${recipient.email}:`, error);
                                results.push({
                                    email: recipient.email,
                                    name: recipient.name,
                                    status: 'failed_emailjs',
                                    error: error.message,
                                    service: 'EmailJS'
                                });
                                failureCount++;
                            }
                        }

                        console.log(`📧 EmailJS delivery complete: ${successCount} sent, ${failureCount} failed`);

                        return {
                            success: successCount > 0,
                            service: 'EmailJS',
                            templateId: 'template_9beph7t',
                            totalRecipients: recipients.length,
                            successCount: successCount,
                            failureCount: failureCount,
                            recipients: recipients.map(r => ({ email: r.email, name: r.name, type: r.type })),
                            results: results,
                            message: `Job published notification sent via EmailJS to ${successCount} of ${recipients.length} recipients`
                        };

                    } else {
                        // Fallback to SMTP email service
                        console.log('📧 EmailJS not available, falling back to SMTP service...');
                        return await this.sendJobPublishedNotificationSMTP(jobData, metadata, recipients, jobBoardUrl);
                    }

                } catch (error) {
                    console.error('❌ Error sending job published notification:', error);
                    return {
                        success: false,
                        error: error.message,
                        message: 'Failed to send job published notification'
                    };
                }
            }

            // SMTP Fallback method
            async sendJobPublishedNotificationSMTP(jobData, metadata, recipients, jobBoardUrl) {
                try {
                    console.log('📧 Using SMTP fallback for email delivery...');

                    // Send notification via SMTP email service
                    const response = await fetch(`${this.emailServiceUrl}/send/job-published-notification`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': this.apiKey
                        },
                        body: JSON.stringify({
                            recipients: recipients,
                            jobData: {
                                jobTitle: jobData.jobTitle,
                                department: jobData.department,
                                positionCode: jobData.positionCode,
                                employmentType: jobData.employmentType,
                                workLocation: jobData.workLocation,
                                advertisingClosingDate: jobData.advertisingClosingDate
                            },
                            metadata: {
                                jobId: metadata.jobId,
                                jobBoardUrl: jobBoardUrl,
                                publishedBy: metadata.publishedBy,
                                timestamp: new Date().toISOString()
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Email service responded with status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('📧 SMTP job published notification result:', result);

                    return {
                        success: result.success,
                        service: 'SMTP',
                        totalRecipients: result.totalRecipients,
                        successCount: result.successCount,
                        failureCount: result.failureCount,
                        recipients: recipients.map(r => ({ email: r.email, name: r.name, type: r.type })),
                        message: `Job published notification sent via SMTP to ${result.successCount} of ${result.totalRecipients} recipients`
                    };

                } catch (error) {
                    console.error('❌ SMTP fallback failed:', error);
                    throw error;
                }
            }

            // Health check for email service
            async checkEmailServiceHealth() {
                try {
                    const response = await fetch(`${this.emailServiceUrl}/health`, {
                        method: 'GET',
                        headers: {
                            'X-API-Key': this.apiKey
                        }
                    });

                    if (response.ok) {
                        const health = await response.json();
                        console.log('📧 Email service health check:', health);
                        return health;
                    } else {
                        console.warn('⚠️ Email service health check failed:', response.status);
                        return { status: 'unhealthy', emailServiceAvailable: false };
                    }
                } catch (error) {
                    console.warn('⚠️ Email service not reachable:', error.message);
                    return { status: 'unreachable', emailServiceAvailable: false };
                }
            }

            // Notification management methods
            async loadNotifications() {
                try {
                    if (!this.currentUser) {
                        console.log('No authenticated user for notifications');
                        return [];
                    }

                    const notificationsRef = this.db.ref(`notifications/${this.currentUser.uid}`);
                    const snapshot = await notificationsRef.once('value');
                    
                    if (snapshot.exists()) {
                        const notificationsData = snapshot.val();
                        const notifications = Object.keys(notificationsData).map(key => ({
                            id: key,
                            ...notificationsData[key]
                        }));
                        
                        // Sort by timestamp (newest first)
                        return notifications.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    }
                    
                    return [];
                } catch (error) {
                    console.error('Error loading notifications:', error);
                    return [];
                }
            }

            async markAllNotificationsAsRead() {
                try {
                    if (!this.currentUser) {
                        console.log('No authenticated user for notifications');
                        return;
                    }

                    const notificationsRef = this.db.ref(`notifications/${this.currentUser.uid}`);
                    const snapshot = await notificationsRef.once('value');
                    
                    if (snapshot.exists()) {
                        const notificationsData = snapshot.val();
                        const updates = {};
                        
                        Object.keys(notificationsData).forEach(key => {
                            updates[`${key}/read`] = true;
                        });

                        await notificationsRef.update(updates);
                        console.log('All notifications marked as read');
                        this.updateNotificationBadge();
                    }
                } catch (error) {
                    console.error('Error marking notifications as read:', error);
                }
            }

            async clearAllNotifications() {
                try {
                    if (!this.currentUser) {
                        console.log('No authenticated user for notifications');
                        return;
                    }

                    const notificationsRef = this.db.ref(`notifications/${this.currentUser.uid}`);
                    await notificationsRef.remove();
                    console.log('All notifications cleared');
                    this.updateNotificationBadge();
                } catch (error) {
                    console.error('Error clearing notifications:', error);
                }
            }

            async markNotificationAsRead(notificationId) {
                try {
                    if (!this.currentUser) {
                        console.log('No authenticated user for notifications');
                        return;
                    }

                    const notificationRef = this.db.ref(`notifications/${this.currentUser.uid}/${notificationId}`);
                    await notificationRef.update({ read: true });
                    console.log(`Notification ${notificationId} marked as read`);
                    this.updateNotificationBadge();
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }

            async deleteNotification(notificationId) {
                try {
                    if (!this.currentUser) {
                        console.log('No authenticated user for notifications');
                        return;
                    }

                    const notificationRef = this.db.ref(`notifications/${this.currentUser.uid}/${notificationId}`);
                    await notificationRef.remove();
                    console.log(`Notification ${notificationId} deleted`);
                    this.updateNotificationBadge();
                } catch (error) {
                    console.error('Error deleting notification:', error);
                }
            }

            updateNotificationBadge() {
                this.loadNotifications().then(notifications => {
                    this.updateNotificationBadgeCount(notifications);
                }).catch(error => {
                    console.error('Error updating notification badge:', error);
                });
            }

            updateNotificationBadgeCount(notifications) {
                const badge = document.querySelector('.notification-badge');
                if (!badge) return;

                const unreadCount = notifications.filter(n => !n.read).length;
                
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }

            async refreshNotifications() {
                try {
                    const notifications = await this.loadNotifications();
                    this.populateNotificationDropdown(notifications);
                    // Ensure badge is updated even if dropdown population has issues
                    this.updateNotificationBadgeCount(notifications);
                    console.log('Notifications refreshed, count:', notifications.filter(n => !n.read).length);
                } catch (error) {
                    console.error('Error refreshing notifications:', error);
                }
            }

            populateNotificationDropdown(notifications) {
                const notificationList = document.getElementById('notificationList');
                const notificationEmpty = document.getElementById('notificationEmpty');
                
                if (!notificationList) return;

                // Clear existing notifications (except empty state)
                const existingNotifications = notificationList.querySelectorAll('.notification-item');
                existingNotifications.forEach(item => item.remove());

                if (notifications.length === 0) {
                    if (notificationEmpty) notificationEmpty.style.display = 'block';
                    return;
                }

                if (notificationEmpty) notificationEmpty.style.display = 'none';

                notifications.forEach(notification => {
                    const notificationItem = this.createNotificationElement(notification);
                    notificationList.appendChild(notificationItem);
                });

                this.updateNotificationBadgeCount(notifications);
            }

            createNotificationElement(notification) {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                
                const iconClass = notification.type === 'success' ? 'fa-check-circle' : 
                                notification.type === 'warning' ? 'fa-exclamation-triangle' :
                                notification.type === 'error' ? 'fa-times-circle' : 'fa-info-circle';
                
                const iconType = notification.type || 'info';
                
                const timeAgo = this.formatTimeAgo(notification.timestamp);
                
                notificationItem.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon ${iconType}">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="notification-title">${notification.title || 'Notification'}</div>
                            <div class="notification-message">${notification.message || ''}</div>
                            <div class="notification-time">${timeAgo}</div>
                        </div>
                    </div>
                    <div class="notification-actions">
                        ${!notification.read ? `<button class="mark-read-btn" onclick="window.authManager.markNotificationAsRead('${notification.id}').then(() => window.authManager.refreshNotifications())">
                            <i class="fas fa-check"></i>
                        </button>` : ''}
                        <button class="delete-notification-btn" onclick="window.authManager.deleteNotification('${notification.id}').then(() => window.authManager.refreshNotifications())">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                return notificationItem;
            }

            formatTimeAgo(timestamp) {
                if (!timestamp) return 'Unknown time';
                
                const now = Date.now();
                const diff = now - timestamp;
                const seconds = Math.floor(diff / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
                if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                return 'Just now';
            }

            setupNotificationEventListeners() {
                const notificationBtn = document.getElementById('notificationBtn');
                const notificationDropdown = document.querySelector('.notification-dropdown');
                
                console.log('🔔 Setting up notification event listeners');
                console.log('notificationBtn:', notificationBtn);
                console.log('notificationDropdown:', notificationDropdown);
                
                if (notificationBtn && notificationDropdown) {
                    console.log('✅ Both notification elements found, adding click listener');
                    
                    // Remove any existing listeners by cloning the button
                    const newNotificationBtn = notificationBtn.cloneNode(true);
                    notificationBtn.parentNode.replaceChild(newNotificationBtn, notificationBtn);
                    
                    newNotificationBtn.addEventListener('click', async (e) => {
                        console.log('🔔 Notification bell clicked!');
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Toggle dropdown visibility
                        const isVisible = notificationDropdown.classList.contains('show');
                        console.log('Current dropdown visibility:', isVisible);
                        console.log('Dropdown classes before toggle:', notificationDropdown.className);
                        
                        if (!isVisible) {
                            console.log('📂 Opening dropdown...');
                            // Load fresh notifications when opening
                            const notifications = await this.loadNotifications();
                            this.populateNotificationDropdown(notifications);
                            notificationDropdown.classList.add('show');
                            console.log('Dropdown classes after adding show:', notificationDropdown.className);
                            console.log('Dropdown display style:', window.getComputedStyle(notificationDropdown).display);
                            console.log('Dropdown z-index:', window.getComputedStyle(notificationDropdown).zIndex);
                        } else {
                            console.log('📁 Closing dropdown...');
                            notificationDropdown.classList.remove('show');
                            console.log('Dropdown classes after removing show:', notificationDropdown.className);
                        }
                    });
                } else {
                    console.error('❌ Missing notification elements!');
                    console.log('notificationBtn found:', !!notificationBtn);
                    console.log('notificationDropdown found:', !!notificationDropdown);
                }

                if (newNotificationBtn && notificationDropdown) {
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!newNotificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                            notificationDropdown.classList.remove('show');
                        }
                    });

                    // Mark all as read button
                    const markAllReadBtn = document.querySelector('.mark-all-read');
                    if (markAllReadBtn) {
                        markAllReadBtn.addEventListener('click', async () => {
                            await this.markAllNotificationsAsRead();
                            const notifications = await this.loadNotifications();
                            this.populateNotificationDropdown(notifications);
                        });
                    }

                    // Clear all notifications button
                    const clearAllBtn = document.querySelector('.clear-all-notifications');
                    if (clearAllBtn) {
                        clearAllBtn.addEventListener('click', async () => {
                            await this.clearAllNotifications();
                            this.populateNotificationDropdown([]);
                        });
                    }
                }
            }

            // Create in-app notification for a user
            async createNotification(userId, title, message, type = 'info', additionalData = {}) {
                try {
                    if (!userId) {
                        console.warn('Cannot create notification: No user ID provided');
                        return false;
                    }

                    const notificationData = {
                        title: title,
                        message: message,
                        type: type, // 'info', 'success', 'warning', 'error'
                        timestamp: Date.now(),
                        read: false,
                        ...additionalData
                    };

                    const notificationRef = this.db.ref(`notifications/${userId}`).push();
                    await notificationRef.set(notificationData);
                    
                    console.log(`✅ Notification created for user ${userId}:`, notificationData);
                    
                    // If this is for the current user, update the badge
                    if (userId === this.currentUser?.uid) {
                        this.updateNotificationBadge();
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Error creating notification:', error);
                    return false;
                }
            }

            // Find user ID by email or line manager name
            async findUserByEmailOrName(companyId, emailOrName) {
                try {
                    if (!companyId || !emailOrName) {
                        console.warn('Missing companyId or emailOrName for user search');
                        return null;
                    }

                    // First try to find by email in company users
                    const usersRef = this.db.ref(`companies/${companyId}/users`);
                    const usersSnapshot = await usersRef.once('value');
                    
                    if (usersSnapshot.exists()) {
                        const users = usersSnapshot.val();
                        
                        // Search by email first
                        for (const [userId, userData] of Object.entries(users)) {
                            if (userData.email && userData.email.toLowerCase() === emailOrName.toLowerCase()) {
                                console.log(`Found user by email: ${emailOrName} -> ${userId}`);
                                return userId;
                            }
                        }
                        
                        // If not found by email, try by display name
                        for (const [userId, userData] of Object.entries(users)) {
                            const displayName = userData.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
                            if (displayName.toLowerCase() === emailOrName.toLowerCase()) {
                                console.log(`Found user by name: ${emailOrName} -> ${userId}`);
                                return userId;
                            }
                        }
                    }

                    // If not found in company users, try in staff collection
                    const staffRef = this.db.ref(`companies/${companyId}/staff`);
                    const staffSnapshot = await staffRef.once('value');
                    
                    if (staffSnapshot.exists()) {
                        const staff = staffSnapshot.val();
                        
                        for (const [staffId, staffData] of Object.entries(staff)) {
                            if (staffData.email && staffData.email.toLowerCase() === emailOrName.toLowerCase()) {
                                console.log(`Found staff by email: ${emailOrName} -> userId from staff record`);
                                return staffData.userId || null; // Staff records might have userId field
                            }
                            
                            const fullName = `${staffData.firstName || ''} ${staffData.lastName || ''}`.trim();
                            if (fullName.toLowerCase() === emailOrName.toLowerCase()) {
                                console.log(`Found staff by name: ${emailOrName} -> userId from staff record`);
                                return staffData.userId || null;
                            }
                        }
                    }

                    console.warn(`User not found: ${emailOrName}`);
                    return null;
                } catch (error) {
                    console.error('Error finding user:', error);
                    return null;
                }
            }
        }

        // Debug function to trace notification issues
        async function debugJobNotificationIssue() {
            console.log('🔍 Starting notification debug process...');
            
            try {
                // Get current user's company information
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const companyId = currentUser.companyId;
                
                if (!companyId) {
                    console.error('❌ No company ID found');
                    alert('❌ No company ID found. Please ensure you are logged in properly.');
                    return;
                }
                
                console.log('🏢 Company ID:', companyId);
                
                // Get position code from form
                const positionCode = document.getElementById('positionCode')?.value?.trim();
                if (!positionCode) {
                    console.error('❌ No position code in form');
                    alert('❌ No position code found. Please enter a position code to debug.');
                    return;
                }
                
                console.log('📝 Position Code:', positionCode);
                
                const database = getDatabase();
                
                // Check staff collection for matching positions
                console.log('📊 Checking staff collection...');
                const staffRef = ref(database, `companies/${companyId}/staff`);
                const staffSnapshot = await get(staffRef);
                
                if (!staffSnapshot.exists()) {
                    console.error('❌ No staff data found for company');
                    alert('❌ No staff data found for this company.');
                    return;
                }
                
                const allStaff = staffSnapshot.val();
                console.log('👥 Staff data found:', Object.keys(allStaff).length, 'positions');
                
                // Find matching position
                let matchingPosition = null;
                let staffId = null;
                
                for (const [id, staffData] of Object.entries(allStaff)) {
                    if (staffData.positionCode === positionCode || staffData.jobCode === positionCode) {
                        matchingPosition = staffData;
                        staffId = id;
                        break;
                    }
                }
                
                if (!matchingPosition) {
                    console.error('❌ No matching position found in staff data');
                    console.log('Available position codes:', 
                        Object.values(allStaff)
                            .map(s => s.positionCode || s.jobCode)
                            .filter(Boolean)
                    );
                    alert(`❌ No matching position found for code "${positionCode}".\nAvailable codes: ${Object.values(allStaff).map(s => s.positionCode || s.jobCode).filter(Boolean).join(', ')}`);
                    return;
                }
                
                console.log('✅ Found matching position:', matchingPosition.jobTitle);
                console.log('📋 Position data:', matchingPosition);
                
                // Check submitter
                if (!matchingPosition.submittedBy) {
                    console.warn('⚠️ No submitter found in position data');
                } else {
                    console.log('👤 Submitter ID:', matchingPosition.submittedBy);
                    
                    // Get submitter info
                    const submitterInfo = await jobPublishedNotificationService.getUserInfo(matchingPosition.submittedBy, companyId);
                    if (submitterInfo) {
                        console.log('✅ Submitter info:', submitterInfo);
                        if (!submitterInfo.email) {
                            console.warn('⚠️ Submitter has no email address');
                        }
                    } else {
                        console.error('❌ Could not find submitter user data');
                    }
                }
                
                // Check approvers
                if (!matchingPosition.approvalHistory || !Array.isArray(matchingPosition.approvalHistory)) {
                    console.warn('⚠️ No approval history found');
                } else {
                    console.log('👨‍💼 Approval history:', matchingPosition.approvalHistory.length, 'entries');
                    
                    for (const [index, approval] of matchingPosition.approvalHistory.entries()) {
                        console.log(`📋 Approval ${index + 1}:`, approval);
                        
                        if (approval.status !== 'approved') {
                            console.log(`⚠️ Approval ${index + 1} status is not 'approved': ${approval.status}`);
                            continue;
                        }
                        
                        if (!approval.approvedBy) {
                            console.warn(`⚠️ Approval ${index + 1} has no approver ID`);
                            continue;
                        }
                        
                        // Get approver info
                        const approverInfo = await jobPublishedNotificationService.getUserInfo(approval.approvedBy, companyId);
                        if (approverInfo) {
                            console.log(`✅ Approver ${index + 1} info:`, approverInfo);
                            if (!approverInfo.email) {
                                console.warn(`⚠️ Approver ${index + 1} has no email address`);
                            }
                        } else {
                            console.error(`❌ Could not find approver ${index + 1} user data`);
                        }
                    }
                }
                
                // Test notification system
                console.log('📧 Testing notification system...');
                const recipients = await jobPublishedNotificationService.getPositionRecipients(positionCode, companyId);
                console.log('📧 Recipients found:', recipients);
                
                if (recipients.length === 0) {
                    console.error('❌ No recipients found for notification');
                    alert('❌ No recipients found for notification. Check if position has submitter and approvers with email addresses.');
                } else {
                    console.log('✅ Found recipients:', recipients.length);
                    
                    // Test EmailJS availability
                    if (typeof emailjs === 'undefined') {
                        console.error('❌ EmailJS library not loaded');
                        alert('❌ EmailJS library not loaded. Email notifications will fall back to SMTP.');
                    } else {
                        console.log('✅ EmailJS library is available');
                        
                        // Test EmailJS configuration
                        if (jobPublishedNotificationService.emailJSReady) {
                            console.log('✅ EmailJS is initialized and ready');
                            console.log('🔧 EmailJS Config:', jobPublishedNotificationService.emailJSConfig);
                        } else {
                            console.warn('⚠️ EmailJS is not ready, will use SMTP fallback');
                        }
                    }
                    
                    // Test email service health
                    const healthCheck = await jobPublishedNotificationService.checkEmailServiceHealth();
                    console.log('🏥 Email service health:', healthCheck);
                    
                    alert(`✅ Debug complete!\n\nRecipients found: ${recipients.length}\n${recipients.map(r => `- ${r.name} (${r.email}) - ${r.type}`).join('\n')}\n\nCheck console for detailed logs.`);
                }
                
            } catch (error) {
                console.error('❌ Debug error:', error);
                alert('❌ Debug error: ' + error.message);
            }
        }

        // Test function for EmailJS template_9beph7t integration
        async function testEmailJSJobNotification() {
            console.log('🧪 Testing EmailJS job notification with template_9beph7t...');
            
            try {
                // Check EmailJS availability
                if (!jobPublishedNotificationService.emailJSReady) {
                    console.error('❌ EmailJS not ready for testing');
                    return;
                }

                // Test job data
                const testJobData = {
                    jobTitle: 'Senior Software Engineer',
                    department: 'IT Department',
                    positionCode: 'TEST-001',
                    employmentType: 'Full-time',
                    workLocation: 'Lagos, Nigeria',
                    advertisingClosingDate: '2025-08-20',
                    companyId: 'dreamex_test'
                };

                // Test metadata
                const testMetadata = {
                    jobId: 'test-job-001',
                    publishedBy: 'Test User',
                    jobBoardUrl: 'https://dreamexdatalab.com/jobs/test-001'
                };

                // Test with a single recipient to verify template_9beph7t
                const testRecipient = {
                    email: 'test@dreamexdatalab.com', // Replace with a real test email
                    name: 'Test Recipient',
                    type: 'submitter'
                };

                console.log('📧 Sending test email via EmailJS template_9beph7t...');

                // Prepare template parameters
                const templateParams = {
                    to_name: testRecipient.name,
                    to_email: testRecipient.email,
                    recipient_type: testRecipient.type,
                    job_title: testJobData.jobTitle,
                    department: testJobData.department,
                    position_code: testJobData.positionCode,
                    employment_type: testJobData.employmentType,
                    work_location: testJobData.workLocation,
                    published_date: new Date().toLocaleDateString(),
                    application_deadline: new Date(testJobData.advertisingClosingDate).toLocaleDateString(),
                    job_id: testMetadata.jobId,
                    job_board_url: testMetadata.jobBoardUrl,
                    published_timestamp: new Date().toLocaleString(),
                    company_name: 'Dreamex Datalab',
                    hr_email: 'hr@dreamexdatalab.com',
                    is_submitter: testRecipient.type === 'submitter',
                    is_approver: testRecipient.type === 'approver',
                    notification_type: 'job_published',
                    system_name: 'Dreamex Datalab HSE System'
                };

                // Send test email via EmailJS
                const result = await emailjs.send(
                    jobPublishedNotificationService.emailJSConfig.serviceId,
                    jobPublishedNotificationService.emailJSConfig.templateId,
                    templateParams
                );

                console.log('✅ EmailJS test email sent successfully:', result);
                console.log('📧 Template ID used: template_9beph7t');
                console.log('📧 Service ID used:', jobPublishedNotificationService.emailJSConfig.serviceId);

                alert('✅ Test email sent successfully via EmailJS template_9beph7t!\nCheck the recipient email for delivery.');

            } catch (error) {
                console.error('❌ EmailJS test failed:', error);
                alert('❌ EmailJS test failed: ' + error.message);
            }
        }

        const jobPublishedNotificationService = new JobPublishedNotificationService();

        // Test function for job published notifications (for development/testing)
        async function testJobPublishedNotification() {
            console.log('🧪 Testing job published notification system...');
            
            try {
                // Check email service health first
                const healthCheck = await jobPublishedNotificationService.checkEmailServiceHealth();
                console.log('📧 Email service health:', healthCheck);
                
                if (!healthCheck.emailServiceAvailable) {
                    console.warn('⚠️ Email service not available for testing');
                    showNotification('Email service not available for testing', 'warning');
                    return;
                }

                // Test with sample data
                const testJobData = {
                    jobTitle: 'Test Position - Senior Developer',
                    department: 'Information Technology',
                    positionCode: 'TEST-DEV-001',
                    employmentType: 'Full-time',
                    workLocation: 'Main Office',
                    advertisingClosingDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 days from now
                    companyId: getCompanyId()
                };

                const testMetadata = {
                    jobId: 'test-job-' + Date.now(),
                    publishedBy: 'test-user',
                    jobBoardUrl: window.location.origin + '/jobpost.html?test=true'
                };

                console.log('🧪 Sending test notification with data:', testJobData);

                const result = await jobPublishedNotificationService.sendJobPublishedNotification(testJobData, testMetadata);
                
                if (result.success) {
                    showNotification(`✅ Test notification sent successfully to ${result.successCount} recipients!`, 'success');
                    console.log('🧪 ✅ Test notification result:', result);
                } else {
                    showNotification(`❌ Test notification failed: ${result.message}`, 'error');
                    console.log('🧪 ❌ Test notification failed:', result);
                }

            } catch (error) {
                console.error('🧪 ❌ Test notification error:', error);
                showNotification(`❌ Test notification error: ${error.message}`, 'error');
            }
        }

        // Make test function available globally for console testing
        window.testJobPublishedNotification = testJobPublishedNotification;

        // Global variables
        let currentJobId = null;
        
        // Initialize currentJobId from URL parameter once
        const urlParams = new URLSearchParams(window.location.search);
        currentJobId = urlParams.get('jobId');        // Initialize on page load
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Initializing Job Details page...');
            
            try {
                // Initialize Firebase first
                initializeFirebase();
                
                // Initialize centralized authentication from dashboard.html
                authManager = new AuthManager();
                window.authManager = authManager;
                
                console.log('✅ Authentication system initialized');
                
                // Setup notification event listeners immediately
                console.log('🔔 Setting up notification listeners immediately...');
                if (authManager && authManager.setupNotificationEventListeners) {
                    authManager.setupNotificationEventListeners();
                    console.log('🔔 Notification system initialized');
                } else {
                    console.error('❌ authManager or setupNotificationEventListeners not available');
                }
                
                // Initial badge update and real-time sync like staff.html
                if (window.authManager && window.authManager.currentUser) {
                    // Initial load
                    try {
                        const notifications = await window.authManager.loadNotifications();
                        window.authManager.updateNotificationBadgeCount(notifications);
                    } catch (e) { console.warn('Initial notification load failed', e); }

                    // Periodic refresh every 30s
                    setInterval(async () => {
                        try {
                            if (window.authManager && window.authManager.currentUser) {
                                const updated = await window.authManager.loadNotifications();
                                window.authManager.updateNotificationBadgeCount(updated);
                            }
                        } catch (err) { console.warn('Periodic notification refresh failed', err); }
                    }, 30000);

                    // Real-time listener
                    try {
                        const notificationsRef = window.authManager.db.ref(`notifications/${window.authManager.currentUser.uid}`);
                        notificationsRef.on('value', (snapshot) => {
                            const list = [];
                            if (snapshot.exists()) {
                                snapshot.forEach(child => list.push({ id: child.key, ...child.val() }));
                            }
                            list.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
                            window.authManager.updateNotificationBadgeCount(list);

                            // Cross-tab broadcast
                            try {
                                const unread = list.filter(n => !n.read).length;
                                localStorage.setItem('notificationCount', unread.toString());
                                window.dispatchEvent(new CustomEvent('notificationUpdate', { detail: { count: unread, notifications: list } }));
                            } catch(_) {}
                        });
                    } catch (err) { console.warn('Real-time notification listener failed', err); }

                    // Cross-tab listeners
                    window.addEventListener('notificationUpdate', (event) => {
                        const badge = document.querySelector('.notification-badge');
                        if (!badge) return;
                        const count = event.detail.count;
                        if (count > 0) {
                            badge.textContent = count > 99 ? '99+' : count.toString();
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    });

                    window.addEventListener('storage', (event) => {
                        if (event.key === 'notificationCount') {
                            const badge = document.querySelector('.notification-badge');
                            if (!badge || event.newValue === null) return;
                            const count = parseInt(event.newValue);
                            if (count > 0) {
                                badge.textContent = count > 99 ? '99+' : count.toString();
                                badge.style.display = 'block';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    });
                }
                
                // Add immediate visual feedback for profile loading
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar) {
                    // Show loading state
                    userAvatar.style.border = '2px solid #ffc107';
                    userAvatar.title = 'Loading user profile...';
                    console.log('🔄 Profile picture loading indicator set');
                }
                
                // Force immediate avatar update after authentication
                setTimeout(async () => {
                    if (authManager && authManager.currentUser) {
                        const userAvatar = document.getElementById('userAvatar');
                        if (userAvatar) {
                            console.log('🎨 Updating user avatar immediately...');
                            console.log('Current user:', authManager.currentUser);
                            
                            const displayName = authManager.getUserDisplayName();
                            const avatarUrl = await authManager.getUserAvatarUrl();
                            
                            console.log('Display name:', displayName);
                            console.log('Avatar URL:', avatarUrl);
                            console.log('Current avatar src before update:', userAvatar.src);
                            
                            if (avatarUrl) {
                                userAvatar.src = avatarUrl;
                                userAvatar.alt = displayName + ' Avatar';
                                userAvatar.style.border = '2px solid #28a745'; // Green border for success
                                userAvatar.title = `${displayName}'s profile picture`;
                                console.log('✅ User avatar loaded from Firebase Storage');
                                console.log('New avatar src:', userAvatar.src);
                            } else {
                                // Generate initials avatar as fallback
                                authManager.generateInitialsAvatar(displayName, userAvatar);
                                userAvatar.style.border = '2px solid #17a2b8'; // Blue border for initials
                                userAvatar.title = `${displayName} (initials)`;
                                console.log('✅ User avatar generated from initials:', displayName);
                                console.log('Generated avatar src:', userAvatar.src);
                            }
                        } else {
                            console.log('❌ userAvatar element not found');
                        }
                    } else {
                        console.log('❌ authManager or currentUser not available');
                        console.log('authManager:', authManager);
                        console.log('currentUser:', authManager?.currentUser);
                    }
                }, 1000);
                
                // Load job details from URL parameters after authentication
                loadJobDetailsFromParams();
                
                if (currentJobId) {
                    const editMode = urlParams.get('edit');
                    
                    if (editMode === 'true') {
                        // Load job data for editing
                        loadJobForEditing(currentJobId);
                        switchTab('jobcard');
                        // Update button text to indicate editing
                        const createBtn = document.getElementById('createJobBtn');
                        if (createBtn) {
                            createBtn.innerHTML = '<i class="fas fa-edit"></i> Update Job';
                        }
                    } else {
                        // Load job data for viewing
                        checkInternalPortalStatus(currentJobId);
                        loadJobDetails(currentJobId);
                        loadJobCard(currentJobId);
                        // Switch to job card tab by default when coming from job listings
                        switchTab('jobcard');
                    }
                } else {
                    // No job ID provided - this is a new job creation form
                    console.log('No job ID provided - enabling job creation mode');
                    
                    // Enable all form fields for new job creation
                    const formElements = document.querySelectorAll('#jobCardForm input, #jobCardForm textarea, #jobCardForm select');
                    formElements.forEach(element => {
                        element.removeAttribute('readonly');
                        element.removeAttribute('disabled');
                    });
                    
                    // Update button text to indicate creation
                    const createBtn = document.getElementById('createJobBtn');
                    if (createBtn) {
                        createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Job';
                    }
                    
                    // Set default values
                    if (document.getElementById('urgency')) document.getElementById('urgency').value = 'Medium';
                    
                    // Auto-generate position code when job title changes
                    const jobTitleField = document.getElementById('jobCardTitle');
                    const positionCodeField = document.getElementById('positionCode');
                    
                    if (jobTitleField && positionCodeField) {
                        jobTitleField.addEventListener('input', function() {
                            const title = this.value.trim();
                            if (title) {
                                // Generate position code: first 3 letters of each word + timestamp
                                const words = title.split(' ').filter(word => word.length > 0);
                                const initials = words.map(word => word.substring(0, 3).toUpperCase()).join('');
                                const timestamp = Date.now().toString().slice(-4); // Last 4 digits
                                const positionCode = `${initials}-${timestamp}`;
                                positionCodeField.value = positionCode;
                                console.log('Auto-generated position code:', positionCode);
                            } else {
                                positionCodeField.value = '';
                            }
                        });
                        
                        // Check for existing jobs when position code changes
                        positionCodeField.addEventListener('input', function() {
                            checkForExistingJob(this.value.trim());
                        });
                    }
                    document.getElementById('employmentType').value = 'full-time';
                    document.getElementById('employmentStatus').value = 'permanent';
                }
                
                // Add backup event listener for create job button
                const createJobBtn = document.getElementById('createJobBtn');
                if (createJobBtn) {
                    createJobBtn.addEventListener('click', function(e) {
                        console.log('Create job button clicked via event listener');
                        e.preventDefault();
                        createJob();
                    });
                    console.log('✅ Create job button event listener added');
                }
                
                // Auto-generate position code when department changes
                const departmentField = document.getElementById('department');
                if (departmentField) {
                    departmentField.addEventListener('input', function() {
                        const department = this.value.trim();
                        const positionCodeField = document.getElementById('positionCode');
                        
                        if (department && !positionCodeField.value) {
                            const timestamp = Date.now().toString().slice(-6);
                            positionCodeField.value = `${department.toUpperCase().slice(0,4)}-${timestamp}`;
                        }
                    });
                }
                
                console.log('✅ Job Details page initialization completed');
                
            } catch (error) {
                console.error('❌ Error during page initialization:', error);
            }
        });
        
        // Global notification refresh function for consistency with other pages
        window.refreshNotifications = async () => {
            if (window.authManager) {
                console.log('🔄 Manually refreshing notifications...');
                await window.authManager.refreshNotifications();
                console.log('✅ Notifications refreshed');
            }
        };
        
        // Function to get URL parameters
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                id: params.get('id'),
                positionCode: params.get('positionCode'),
                jobTitle: params.get('jobTitle'),
                department: params.get('department'),
                employmentType: params.get('employmentType'),
                status: params.get('status'),
                urgency: params.get('urgency'),
                postedDate: params.get('postedDate'),
                sourceIndicator: params.get('sourceIndicator'),
                salary: params.get('salary'),
                location: params.get('location'),
                description: params.get('description'),
                jobDescription: params.get('jobDescription'), // Alternative mapping
                skills: params.get('skills'),
                requiredSkills: params.get('requiredSkills'), // Alternative mapping
                education: params.get('education'),
                requiredEducation: params.get('requiredEducation'), // Alternative mapping
                experience: params.get('experience'),
                requiredExperience: params.get('requiredExperience'), // Alternative mapping
                lineManager: params.get('lineManager'),
                workingHours: params.get('workingHours'),
                startDate: params.get('startDate'),
                notes: params.get('notes'),
                advertisingClosingDate: params.get('advertisingClosingDate'),
                salaryMin: params.get('salaryMin'),
                salaryMax: params.get('salaryMax')
            };
        }        // Function to load job details from URL parameters
        function loadJobDetailsFromParams() {
            const params = getUrlParams();
            
            // Debug: Log all available parameters
            console.log('Available URL parameters:', params);
            
            if (params.id) {
                // Update page title and header
                document.title = `${params.jobTitle} - Job Status`;                  // Populate job card form fields with improved field mapping
                if (params.jobTitle) document.getElementById('jobCardTitle').value = params.jobTitle;
                if (params.positionCode) document.getElementById('positionCode').value = params.positionCode;
                if (params.department) document.getElementById('department').value = params.department;
                if (params.employmentType) document.getElementById('employmentType').value = params.employmentType;
                if (params.status) document.getElementById('employmentStatus').value = params.status;
                if (params.workingHours) document.getElementById('workingHours').value = params.workingHours;
                if (params.lineManager) document.getElementById('lineManager').value = params.lineManager;
                if (params.location) document.getElementById('workLocation').value = params.location;                  // Parse and set salary range with debug logging
                if (params.salary && params.salary !== 'Not specified') {
                    console.log('Processing salary parameter:', params.salary);
                    const salaryParts = params.salary.replace(/[\$,]/g, '').split(' - ');
                    if (salaryParts.length === 2) {
                        const minSal = parseInt(salaryParts[0]) || '';
                        const maxSal = parseInt(salaryParts[1]) || '';
                        document.getElementById('salaryMin').value = minSal;
                        document.getElementById('salaryMax').value = maxSal;
                        console.log('Set salary range:', minSal, 'to', maxSal);
                    } else if (salaryParts.length === 1) {
                        const salaryValue = parseInt(salaryParts[0]) || '';
                        document.getElementById('salaryMin').value = salaryValue;
                        document.getElementById('salaryMax').value = salaryValue;
                        console.log('Set single salary value:', salaryValue);
                    }
                }// Set job description and requirements with improved mapping
                if (params.description) document.getElementById('jobDescription').value = params.description;
                if (params.jobDescription) document.getElementById('jobDescription').value = params.jobDescription;
                if (params.education) document.getElementById('requiredEducation').value = params.education;
                if (params.requiredEducation) document.getElementById('requiredEducation').value = params.requiredEducation;
                if (params.experience) document.getElementById('requiredExperience').value = params.experience;
                if (params.requiredExperience) document.getElementById('requiredExperience').value = params.requiredExperience;
                if (params.skills) document.getElementById('requiredSkills').value = params.skills;
                if (params.requiredSkills) document.getElementById('requiredSkills').value = params.requiredSkills;
                if (params.urgency) document.getElementById('urgency').value = params.urgency;                if (params.postedDate) {
                    // Convert date to YYYY-MM-DD format for date input
                    const startDate = new Date(params.postedDate);
                    if (!isNaN(startDate.getTime())) {
                        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                    }
                }
                
                // Handle startDate parameter separately if provided
                if (params.startDate) {
                    const startDate = new Date(params.startDate);
                    if (!isNaN(startDate.getTime())) {
                        document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                    }
                }
                
                // Handle advertising closing date
                if (params.advertisingClosingDate) {
                    const closingDate = new Date(params.advertisingClosingDate);
                    if (!isNaN(closingDate.getTime())) {
                        document.getElementById('advertisingClosingDate').value = closingDate.toISOString().split('T')[0];
                    }
                }
                
                if (params.notes) {
                    document.getElementById('notes').value = params.notes;
                }
                  // Handle additional salary parameters that might come from recruitment board
                if (params.salaryMin) {
                    const minSal = parseInt(params.salaryMin) || '';
                    document.getElementById('salaryMin').value = minSal;
                    console.log('Set salaryMin from direct parameter:', minSal);
                }
                if (params.salaryMax) {
                    const maxSal = parseInt(params.salaryMax) || '';
                    document.getElementById('salaryMax').value = maxSal;
                    console.log('Set salaryMax from direct parameter:', maxSal);
                }
                if (params.minSalary) {
                    const minSal = parseInt(params.minSalary) || '';
                    document.getElementById('salaryMin').value = minSal;
                    console.log('Set salaryMin from minSalary parameter:', minSal);
                }
                if (params.maxSalary) {
                    const maxSal = parseInt(params.maxSalary) || '';
                    document.getElementById('salaryMax').value = maxSal;
                    console.log('Set salaryMax from maxSalary parameter:', maxSal);
                }
                
                // Load the job information into the page header/details section
                const tabContent = document.getElementById('detailsContent');
                if (tabContent) {
                    tabContent.innerHTML = `
                        <div class="detail-section">
                            <div class="detail-item">
                                <div class="detail-label">Position ID:</div>
                                <div class="detail-value">${params.id}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Job Title:</div>
                                <div class="detail-value">${params.jobTitle}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Department:</div>
                                <div class="detail-value">${params.department}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Employment Type:</div>
                                <div class="detail-value">${params.employmentType}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Current Status:</div>
                                <div class="detail-value">
                                    <span class="badge badge-${params.status ? params.status.toLowerCase() : 'unknown'}">${params.status || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Urgency Level:</div>
                                <div class="detail-value">
                                    <span class="badge badge-${params.urgency ? params.urgency.toLowerCase() : 'medium'}">${params.urgency || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Posted Date:</div>
                                <div class="detail-value">${params.postedDate || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Source:</div>
                                <div class="detail-value">${params.sourceIndicator === 'recruit' ? 'Recruitment Board' : 'Staff Management'}</div>
                            </div>
                        </div>
                    `;
                }

                // Update other sections with available data
                console.log('Job details loaded from URL parameters:', params);
            }
        }        // Initialize page        // Load job details
        function loadJobDetails(jobId) {
            // Get company ID from auth or company data service
            let companyId = getCompanyId();
            
            const jobRef = firebase.database().ref(`companies/${companyId}/jobs/${jobId}`);
            jobRef.once('value').then((snapshot) => {
                const jobData = snapshot.val();
                if (jobData) {
                    document.getElementById('jobTitle').textContent = jobData.title;
                    document.getElementById('department').textContent = jobData.department;
                    document.getElementById('employmentType').textContent = jobData.employmentType;
                    document.getElementById('salaryRange').textContent = formatSalaryRange(jobData.salaryMin, jobData.salaryMax);
                    document.getElementById('postedDate').textContent = formatDate(jobData.postedDate);
                } else {
                    console.warn('Job not found in company scope, trying global scope...');
                    // Fallback to global scope for backward compatibility
                    const globalJobRef = firebase.database().ref(`jobs/${jobId}`);
                    globalJobRef.once('value').then((globalSnapshot) => {
                        const globalJobData = globalSnapshot.val();
                        if (globalJobData) {
                            document.getElementById('jobTitle').textContent = globalJobData.title;
                            document.getElementById('department').textContent = globalJobData.department;
                            document.getElementById('employmentType').textContent = globalJobData.employmentType;
                            document.getElementById('salaryRange').textContent = formatSalaryRange(globalJobData.salaryMin, globalJobData.salaryMax);
                            document.getElementById('postedDate').textContent = formatDate(globalJobData.postedDate);
                        } else {
                            showError('Job not found');
                        }
                    }).catch((error) => {
                        console.error('Error loading job from global scope:', error);
                        showError('Job not found');
                    });
                }
            }).catch((error) => {
                console.error('Error loading job details:', error);
                showError('Error loading job details');
            });
        }        // Load job card details
        function loadJobCard(jobId) {
            // Get company ID from auth or company data service
            let companyId = getCompanyId();
            
            const jobRef = firebase.database().ref(`companies/${companyId}/recruit/${jobId}`);
            jobRef.once('value').then((snapshot) => {
                const job = snapshot.val();
                if (job) {
                    // Position Information
                    document.getElementById('jobCardTitle').value = job.jobTitle || '';
                    document.getElementById('positionCode').value = job.positionCode || '';
                    document.getElementById('department').value = job.department || '';                    // Employment Details
                    document.getElementById('employmentType').value = job.employmentType || '';
                    document.getElementById('employmentStatus').value = job.employmentStatus || job.status || '';
                    document.getElementById('workingHours').value = job.workingHours || '';
                    document.getElementById('lineManager').value = job.lineManager || '';// Location & Compensation
                    document.getElementById('workLocation').value = job.workLocation || job.location || '';
                    document.getElementById('salaryMin').value = job.salaryMin || '';
                    document.getElementById('salaryMax').value = job.salaryMax || '';                    // Job Description & Requirements
                    document.getElementById('jobDescription').value = job.jobDescription || job.description || '';
                    document.getElementById('requiredEducation').value = job.requiredEducation || job.education || '';
                    document.getElementById('requiredExperience').value = job.requiredExperience || job.experience || '';
                    document.getElementById('requiredSkills').value = job.requiredSkills || job.skills || '';

                    // Additional Information with improved date handling
                    document.getElementById('urgency').value = job.urgency || '';
                    
                    // Handle start date
                    if (job.startDate) {
                        const startDate = new Date(job.startDate);
                        if (!isNaN(startDate.getTime())) {
                            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                        }
                    }
                    
                    document.getElementById('notes').value = job.notes || '';
                } else {
                    console.warn('Job not found in company recruit scope, trying global scope...');
                    // Fallback to global scope for backward compatibility
                    const globalJobRef = firebase.database().ref(`recruit/${jobId}`);
                    globalJobRef.once('value').then((globalSnapshot) => {
                        const globalJob = globalSnapshot.val();
                        if (globalJob) {
                            // Load from global scope with same mapping
                            document.getElementById('jobCardTitle').value = globalJob.jobTitle || '';
                            document.getElementById('positionCode').value = globalJob.positionCode || '';
                            document.getElementById('department').value = globalJob.department || '';
                            document.getElementById('employmentType').value = globalJob.employmentType || '';
                            document.getElementById('employmentStatus').value = globalJob.employmentStatus || globalJob.status || '';
                            document.getElementById('workingHours').value = globalJob.workingHours || '';
                            document.getElementById('lineManager').value = globalJob.lineManager || '';
                            document.getElementById('workLocation').value = globalJob.workLocation || globalJob.location || '';
                            document.getElementById('salaryMin').value = globalJob.salaryMin || '';
                            document.getElementById('salaryMax').value = globalJob.salaryMax || '';
                            document.getElementById('jobDescription').value = globalJob.jobDescription || globalJob.description || '';
                            document.getElementById('requiredEducation').value = globalJob.requiredEducation || globalJob.education || '';
                            document.getElementById('requiredExperience').value = globalJob.requiredExperience || globalJob.experience || '';
                            document.getElementById('requiredSkills').value = globalJob.requiredSkills || globalJob.skills || '';
                            document.getElementById('urgency').value = globalJob.urgency || '';
                            
                            if (globalJob.startDate) {
                                const startDate = new Date(globalJob.startDate);
                                if (!isNaN(startDate.getTime())) {
                                    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                                }
                            }
                            
                            document.getElementById('notes').value = globalJob.notes || '';
                        }
                    }).catch((error) => {
                        console.error('Error loading job from global recruit scope:', error);
                    });
                }
            }).catch((error) => {
                console.error('Error loading job card details:', error);
            });
        }        // Switch to job card tab (simplified since we only have one tab)
        function switchTab(tabName) {
            // Always ensure jobcard tab is active
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.add('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('active');
            });

            // Load job card data
            if (currentJobId) {
                loadJobCard(currentJobId);
            }
        }

        // Helper functions
        function getCompanyId() {
            let companyId = null;
            
            // Try to get company ID from company data service
            if (window.companyDataService && typeof window.companyDataService.getCurrentCompanyId === 'function') {
                try {
                    companyId = window.companyDataService.getCurrentCompanyId();
                    console.log('Company ID retrieved from companyDataService:', companyId);
                } catch (error) {
                    console.warn('Error getting company ID from companyDataService:', error);
                }
            }
            
            // If no company ID from service, try to get from localStorage
            if (!companyId) {
                try {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        const userData = JSON.parse(storedUser);
                        companyId = userData.companyId;
                        console.log('Company ID retrieved from localStorage:', companyId);
                    }
                } catch (error) {
                    console.warn('Error getting company ID from localStorage:', error);
                }
            }
            
            // Fallback to current user ID if no company ID found
            if (!companyId) {
                const currentUser = firebase.auth().currentUser;
                if (currentUser) {
                    companyId = currentUser.uid;
                    console.log('Company ID retrieved from current user:', companyId);
                } else {
                    console.warn('No authenticated user found, using specific company ID');
                    // Use the specific company ID you mentioned as fallback
                    companyId = '-OUuYJ2TBZebiL0ciPq-';
                }
            }
            
            // Ensure we never use an undefined or null company ID
            if (!companyId) {
                companyId = '-OUuYJ2TBZebiL0ciPq-'; // Use your specific company ID
                console.warn('Fallback to specific company ID:', companyId);
            }
            
            return companyId;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatStatus(status) {
            return status.charAt(0).toUpperCase() + status.slice(1);
        }

        function formatSalaryRange(min, max) {
            return `$${min.toLocaleString()} - $${max.toLocaleString()}`;
        }

        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        function showError(message) {
            // Implement your error display logic here
            console.error(message);
            alert(message); // Temporary fallback for debugging
        }        function formatCurrency(amount) {
            if (!amount) return '';
            return '$' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatEmploymentType(type) {
            if (!type) return '';
            const types = {
                'direct': 'Direct Employee',
                'indirect': 'Indirect Employee',
                'contract': 'Contract Worker',
                'temporary': 'Temporary Worker',
                'intern': 'Intern',
                'consultant': 'Consultant'
            };
            return types[type] || type;
        }        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString; // Return original if invalid date
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }        function formatUrgency(urgency) {
            if (!urgency) return '';
            const urgencies = {
                'low': 'Low',
                'medium': 'Medium',
                'high': 'High',
                'critical': 'Critical'
            };
            return urgencies[urgency] || urgency;        }

        // Create new job function - Save to Firebase and redirect to jobpost.html
        async function createJob(status = 'published') {
            console.log('createJob function called with status:', status);
            
            try {
                // Show loading notification
                const actionText = status === 'draft' ? 'Saving job as draft...' : 'Publishing job...';
                showNotification(actionText, 'info');
                
                // Get current user's company information
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                console.log('Current user from localStorage:', currentUser);
                const companyId = currentUser.companyId;
                const userId = currentUser.uid;
                
                if (!companyId) {
                    console.error('No company ID found in currentUser');
                    showNotification('Unable to determine company context. Please ensure you are logged in properly.', 'error');
                    return;
                }
                
                // Collect all form data
                const jobData = {
                    // Position Information
                    jobTitle: document.getElementById('jobCardTitle')?.value?.trim() || '',
                    positionCode: document.getElementById('positionCode')?.value?.trim() || '',
                    department: document.getElementById('department')?.value?.trim() || '',
                    
                    // Employment Details
                    employmentType: document.getElementById('employmentType')?.value?.trim() || '',
                    employmentStatus: document.getElementById('employmentStatus')?.value?.trim() || '',
                    workingHours: document.getElementById('workingHours')?.value?.trim() || '',
                    lineManager: document.getElementById('lineManager')?.value?.trim() || '',
                    
                    // Location & Compensation
                    workLocation: document.getElementById('workLocation')?.value?.trim() || '',
                    salaryMin: parseFloat(document.getElementById('salaryMin')?.value) || 0,
                    salaryMax: parseFloat(document.getElementById('salaryMax')?.value) || 0,
                    
                    // Job Description & Requirements
                    jobDescription: document.getElementById('jobDescription')?.value?.trim() || '',
                    requiredEducation: document.getElementById('requiredEducation')?.value?.trim() || '',
                    requiredExperience: document.getElementById('requiredExperience')?.value?.trim() || '',
                    requiredSkills: document.getElementById('requiredSkills')?.value?.trim() || '',
                    
                    // Additional Information
                    urgency: document.getElementById('urgency')?.value?.trim() || '',
                    startDate: document.getElementById('startDate')?.value || '',
                    advertisingClosingDate: document.getElementById('advertisingClosingDate')?.value || '',
                    notes: document.getElementById('notes')?.value?.trim() || '',
                    
                    // Metadata
                    companyId: companyId,
                    status: status // Use the provided status (draft or published)
                };
                
                console.log('Job data collected:', jobData);
                
                // Validate required fields
                const requiredFields = ['jobTitle', 'department', 'workLocation'];
                const missingFields = requiredFields.filter(field => !jobData[field]);
                
                if (missingFields.length > 0) {
                    showNotification(`Please fill in required fields: ${missingFields.join(', ')}`, 'error');
                    return;
                }
                
                // Generate position code if empty
                if (!jobData.positionCode) {
                    const words = jobData.jobTitle.split(' ').filter(word => word.length > 0);
                    const initials = words.map(word => word.substring(0, 3).toUpperCase()).join('');
                    const timestamp = Date.now().toString().slice(-4);
                    jobData.positionCode = `${initials}-${timestamp}`;
                    document.getElementById('positionCode').value = jobData.positionCode;
                }
                
                // Initialize Firebase
                const firebase = initializeFirebase();
                const database = getDatabase();
                
                // Check if a job with the same position code already exists
                const companyJobsRef = ref(database, `companies/${companyId}/jobs`);
                const existingJobsSnapshot = await get(companyJobsRef);
                
                let existingJobId = null;
                let existingJob = null;
                
                if (existingJobsSnapshot.exists()) {
                    const allJobs = existingJobsSnapshot.val();
                    
                    // Look for existing job with same position code
                    for (const [jobId, job] of Object.entries(allJobs)) {
                        if (job.positionCode === jobData.positionCode) {
                            existingJobId = jobId;
                            existingJob = job;
                            console.log('Found existing job with same position code:', existingJobId, job);
                            break;
                        }
                    }
                }
                
                let finalJobId;
                let isUpdate = false;
                
                if (existingJobId) {
                    // Update existing job
                    finalJobId = existingJobId;
                    isUpdate = true;
                    
                    // Preserve original creation data and application count
                    jobData.createdBy = existingJob.createdBy || userId;
                    jobData.createdAt = existingJob.createdAt || new Date().toISOString();
                    jobData.applications = existingJob.applications || 0;
                    
                    // Update modification metadata
                    jobData.lastModifiedBy = userId;
                    jobData.lastModifiedAt = new Date().toISOString();
                    
                    // Add published date only if publishing and it's not already published
                    if (status === 'published') {
                        jobData.publishedDate = existingJob.publishedDate || new Date().toISOString();
                        // If this was previously a draft and now being published, update published date
                        if (existingJob.status === 'draft') {
                            jobData.publishedDate = new Date().toISOString();
                        }
                    }
                    
                    console.log('Updating existing job...');
                    showNotification('Updating existing job...', 'info');
                    
                } else {
                    // Create new job
                    finalJobId = 'job_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    // Set creation metadata for new job
                    jobData.createdBy = userId;
                    jobData.createdAt = new Date().toISOString();
                    jobData.applications = 0;
                    
                    // Add published date only if publishing
                    if (status === 'published') {
                        jobData.publishedDate = new Date().toISOString();
                    }
                    
                    console.log('Creating new job with ID:', finalJobId);
                }
                
                // Save job to Firebase
                const jobRef = ref(database, `companies/${companyId}/jobs/${finalJobId}`);
                await set(jobRef, jobData);
                
                console.log('✅ Job saved successfully to Firebase');
                
                // Create in-app notifications for job publishing
                if (status === 'published') {
                    try {
                        const currentUserDisplayName = window.authManager?.getUserDisplayName() || 'User';
                        
                        // Create notification for the current user (publisher)
                        const publisherNotificationTitle = 'Job Published Successfully';
                        const publisherNotificationMessage = `Your job posting "${jobData.jobTitle}" has been published successfully and is now visible on the job board.`;
                        
                        await window.authManager.createNotification(
                            userId,
                            publisherNotificationTitle,
                            publisherNotificationMessage,
                            'success',
                            {
                                jobId: finalJobId,
                                jobTitle: jobData.jobTitle,
                                action: 'job_published_publisher',
                                relatedUser: currentUserDisplayName
                            }
                        );
                        
                        console.log('✅ Publisher notification created');
                        
                        // Create notification for line manager if specified
                        if (jobData.lineManager && jobData.lineManager.trim()) {
                            const lineManagerUserId = await window.authManager.findUserByEmailOrName(companyId, jobData.lineManager.trim());
                            
                            if (lineManagerUserId && lineManagerUserId !== userId) {
                                const lineManagerNotificationTitle = 'New Job Position Published';
                                const lineManagerNotificationMessage = `A new job position "${jobData.jobTitle}" in ${jobData.department || 'your department'} has been published. You are listed as the line manager for this position.`;
                                
                                await window.authManager.createNotification(
                                    lineManagerUserId,
                                    lineManagerNotificationTitle,
                                    lineManagerNotificationMessage,
                                    'info',
                                    {
                                        jobId: finalJobId,
                                        jobTitle: jobData.jobTitle,
                                        action: 'job_published_line_manager',
                                        publishedBy: currentUserDisplayName,
                                        department: jobData.department
                                    }
                                );
                                
                                console.log(`✅ Line manager notification created for: ${jobData.lineManager}`);
                            } else if (lineManagerUserId === userId) {
                                console.log('ℹ️ Line manager is the same as publisher, skipping duplicate notification');
                            } else {
                                console.warn(`⚠️ Could not find user ID for line manager: ${jobData.lineManager}`);
                            }
                        } else {
                            console.log('ℹ️ No line manager specified, skipping line manager notification');
                        }
                        
                    } catch (notificationError) {
                        console.error('❌ Error creating in-app notifications:', notificationError);
                        // Don't fail the job creation if notifications fail
                    }
                }
                
                // Update recruitment board status if job is published
                if (status === 'published' && jobData.positionCode) {
                    await updateRecruitmentBoardStatus(companyId, jobData.positionCode, database);
                }

                // Send job published notification if job is published
                if (status === 'published') {
                    try {
                        console.log('📧 Sending job published notifications...');
                        
                        const notificationResult = await jobPublishedNotificationService.sendJobPublishedNotification(
                            {
                                jobTitle: jobData.jobTitle,
                                department: jobData.department,
                                positionCode: jobData.positionCode,
                                employmentType: jobData.employmentType,
                                workLocation: jobData.workLocation,
                                advertisingClosingDate: jobData.advertisingClosingDate,
                                companyId: companyId
                            },
                            {
                                jobId: finalJobId,
                                publishedBy: userId,
                                jobBoardUrl: `${window.location.origin}/jobpost.html?companyId=${encodeURIComponent(companyId)}&jobId=${encodeURIComponent(finalJobId)}`
                            }
                        );

                        if (notificationResult.success) {
                            console.log('📧 ✅ Job published notifications sent successfully:', notificationResult);
                            showNotification(`📧 Job published notifications sent to ${notificationResult.successCount} recipients (submitter and approvers)`, 'info');
                        } else {
                            console.warn('📧 ⚠️ Job published notifications failed:', notificationResult);
                            showNotification(`⚠️ Job published but notifications failed: ${notificationResult.message}`, 'warning');
                        }

                    } catch (notificationError) {
                        console.error('📧 ❌ Error sending job published notifications:', notificationError);
                        showNotification(`⚠️ Job published but notification error: ${notificationError.message}`, 'warning');
                    }
                }
                
                // Show appropriate success notification
                let successMessage;
                if (isUpdate) {
                    successMessage = status === 'draft' 
                        ? 'Job updated and saved as draft successfully!' 
                        : 'Job updated and published successfully! Redirecting to job board...';
                } else {
                    successMessage = status === 'draft' 
                        ? 'New job saved as draft successfully!' 
                        : 'New job published successfully! Redirecting to job board...';
                }
                
                showNotification(successMessage, 'success');
                
                // Handle redirect based on status
                if (status === 'published') {
                    // If published, redirect to job board to see the published job
                    const redirectUrl = `jobpost.html?companyId=${encodeURIComponent(companyId)}&jobId=${encodeURIComponent(finalJobId)}`;
                    console.log('Redirecting to job board:', redirectUrl);
                    
                    // Wait a moment for the user to see the success message, then redirect
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1500);
                } else {
                    // If draft, just show success and maybe clear form or stay on page
                    console.log('Job saved as draft, staying on current page');
                    
                    // Optionally clear the form after saving as draft (only for new jobs)
                    if (!isUpdate) {
                        setTimeout(() => {
                            if (confirm('Job saved as draft. Would you like to create another job?')) {
                                // Clear the form for new job
                                document.getElementById('jobCardForm').reset();
                                // Reset position code
                                document.getElementById('positionCode').value = '';
                                // Reset default values
                                if (document.getElementById('urgency')) document.getElementById('urgency').value = 'Medium';
                            }
                        }, 2000);
                    }
                }
                
            } catch (error) {
                console.error('Error creating/updating job:', error);
                showNotification('Error saving job: ' + error.message, 'error');
            }
        }

        // Function to update recruitment board status when job is published
        async function updateRecruitmentBoardStatus(companyId, positionCode, database) {
            try {
                console.log(`Updating recruitment board status for position code: ${positionCode}`);
                
                let updatesCount = 0;
                let transfersCount = 0;
                
                // Check both staff and recruit paths for matching position code
                const staffRef = ref(database, `companies/${companyId}/staff`);
                const recruitRef = ref(database, `companies/${companyId}/recruit`);
                
                // Check staff positions
                const staffSnapshot = await get(staffRef);
                if (staffSnapshot.exists()) {
                    const staffData = staffSnapshot.val();
                    for (const [staffId, staff] of Object.entries(staffData)) {
                        if (staff.positionCode === positionCode) {
                            console.log(`Found matching staff position: ${staffId}`);
                            await update(ref(database, `companies/${companyId}/staff/${staffId}`), {
                                status: 'published',
                                approvalStatus: 'approved', // Keep as approved so it stays in approved tab
                                publishedDate: new Date().toISOString(),
                                lastUpdated: new Date().toISOString()
                            });
                            console.log(`Updated staff position ${staffId} status to published`);
                            updatesCount++;
                        }
                    }
                }
                
                // Check recruit positions and move them to published jobs path
                const recruitSnapshot = await get(recruitRef);
                if (recruitSnapshot.exists()) {
                    const recruitData = recruitSnapshot.val();
                    for (const [recruitId, recruit] of Object.entries(recruitData)) {
                        if (recruit.positionCode === positionCode) {
                            console.log(`Found matching recruitment request: ${recruitId}`);
                            
                            // Update the recruitment request status to published first
                            await update(ref(database, `companies/${companyId}/recruit/${recruitId}`), {
                                status: 'published',
                                approvalStatus: 'approved', // Keep as approved for consistency
                                publishedDate: new Date().toISOString(),
                                lastUpdated: new Date().toISOString(),
                                transferredToJobs: true // Mark as transferred
                            });
                            
                            console.log(`Updated recruitment request ${recruitId} status to published and marked for transfer`);
                            updatesCount++;
                            transfersCount++;
                        }
                    }
                }
                
                console.log('✅ Recruitment board status update completed');
                
                // Show notification if any updates were made
                if (updatesCount > 0) {
                    const transferMsg = transfersCount > 0 ? ` ${transfersCount} position(s) moved from pending to published.` : '';
                    showNotification(`Recruitment board synchronized! Updated ${updatesCount} position(s).${transferMsg}`, 'success');
                }
                
            } catch (error) {
                console.error('Error updating recruitment board status:', error);
                // Don't throw error as this is supplementary functionality
            }
        }

        // Function to check for existing job with same position code
        async function checkForExistingJob(positionCode) {
            if (!positionCode || positionCode.length < 3) {
                updateButtonsForNewJob();
                return;
            }
            
            try {
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const companyId = currentUser.companyId;
                
                if (!companyId) return;
                
                // Initialize Firebase
                const firebase = initializeFirebase();
                const database = getDatabase();
                
                // Check if a job with the same position code already exists
                const companyJobsRef = ref(database, `companies/${companyId}/jobs`);
                const existingJobsSnapshot = await get(companyJobsRef);
                
                let existingJob = null;
                
                if (existingJobsSnapshot.exists()) {
                    const allJobs = existingJobsSnapshot.val();
                    
                    // Look for existing job with same position code
                    for (const [jobId, job] of Object.entries(allJobs)) {
                        if (job.positionCode === positionCode) {
                            existingJob = { id: jobId, ...job };
                            break;
                        }
                    }
                }
                
                if (existingJob) {
                    updateButtonsForExistingJob(existingJob);
                } else {
                    updateButtonsForNewJob();
                }
                
            } catch (error) {
                console.error('Error checking for existing job:', error);
                updateButtonsForNewJob();
            }
        }

        // Update buttons for existing job
        function updateButtonsForExistingJob(existingJob) {
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            const publishJobBtn = document.getElementById('publishJobBtn');
            const infoText = document.querySelector('.create-button-section .text-muted small');
            
            if (saveDraftBtn) {
                saveDraftBtn.innerHTML = '<i class="fas fa-edit"></i> Update Draft';
            }
            
            if (publishJobBtn) {
                publishJobBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Update & Publish';
            }
            
            if (infoText) {
                const statusText = existingJob.status === 'published' ? 'published' : 'draft';
                const lastModified = existingJob.lastModifiedAt || existingJob.createdAt;
                const formattedDate = lastModified ? new Date(lastModified).toLocaleDateString() : 'Unknown';
                
                infoText.innerHTML = `
                    <i class="fas fa-info-circle text-warning"></i>
                    A job with this position code already exists (${statusText}, last modified: ${formattedDate}). 
                    Actions will update the existing job instead of creating a new one.
                `;
            }
        }

        // Update buttons for new job
        function updateButtonsForNewJob() {
            const saveDraftBtn = document.getElementById('saveDraftBtn');
            const publishJobBtn = document.getElementById('publishJobBtn');
            const infoText = document.querySelector('.create-button-section .text-muted small');
            
            if (saveDraftBtn) {
                saveDraftBtn.innerHTML = '<i class="fas fa-save"></i> Save as Draft';
            }
            
            if (publishJobBtn) {
                publishJobBtn.innerHTML = '<i class="fas fa-bullhorn"></i> Publish Job';
            }
            
            if (infoText) {
                infoText.innerHTML = `
                    <i class="fas fa-info-circle"></i>
                    Save as draft to review later, or publish immediately to display on job board
                `;
            }
        }

        // Notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }        // Function to load existing job data for editing
        async function loadJobForEditing(jobId) {
            try {
                // Get company ID from auth or company data service
                let companyId = getCompanyId();
                
                const jobRef = firebase.database().ref(`companies/${companyId}/jobs/${jobId}`);
                const snapshot = await jobRef.once('value');
                
                if (snapshot.exists()) {
                    const jobData = snapshot.val();
                    
                    // Populate form fields with existing job data
                    document.getElementById('jobCardTitle').value = jobData.jobTitle || jobData.title || '';
                    document.getElementById('positionCode').value = jobData.positionCode || '';
                    document.getElementById('department').value = jobData.department || '';
                    document.getElementById('employmentType').value = jobData.employmentType || '';
                    document.getElementById('employmentStatus').value = jobData.employmentStatus || '';
                    document.getElementById('workingHours').value = jobData.workingHours || '';
                    document.getElementById('lineManager').value = jobData.lineManager || '';
                    document.getElementById('workLocation').value = jobData.workLocation || jobData.location || '';
                    document.getElementById('salaryMin').value = jobData.salaryMin || '';
                    document.getElementById('salaryMax').value = jobData.salaryMax || '';
                    document.getElementById('jobDescription').value = jobData.jobDescription || jobData.description || '';
                    document.getElementById('requiredEducation').value = jobData.requiredEducation || '';
                    document.getElementById('requiredExperience').value = jobData.requiredExperience || '';
                    document.getElementById('requiredSkills').value = jobData.requiredSkills || '';
                    document.getElementById('urgency').value = jobData.urgency || '';
                    document.getElementById('startDate').value = jobData.startDate || '';
                    document.getElementById('advertisingClosingDate').value = jobData.advertisingClosingDate || '';
                    document.getElementById('notes').value = jobData.notes || '';
                    
                    // Store the job ID for updating
                    window.currentEditJobId = jobId;
                    
                    showNotification('Job data loaded for editing', 'info');
                } else {
                    console.warn('Job not found in company scope, trying global scope...');
                    // Fallback to global scope for backward compatibility
                    const globalJobRef = firebase.database().ref(`jobs/${jobId}`);
                    const globalSnapshot = await globalJobRef.once('value');
                    
                    if (globalSnapshot.exists()) {
                        const jobData = globalSnapshot.val();
                        
                        // Populate form fields with existing job data from global scope
                        document.getElementById('jobCardTitle').value = jobData.jobTitle || jobData.title || '';
                        document.getElementById('positionCode').value = jobData.positionCode || '';
                        document.getElementById('department').value = jobData.department || '';
                        document.getElementById('employmentType').value = jobData.employmentType || '';
                        document.getElementById('employmentStatus').value = jobData.employmentStatus || '';
                        document.getElementById('workingHours').value = jobData.workingHours || '';
                        document.getElementById('lineManager').value = jobData.lineManager || '';
                        document.getElementById('workLocation').value = jobData.workLocation || jobData.location || '';
                        document.getElementById('salaryMin').value = jobData.salaryMin || '';
                        document.getElementById('salaryMax').value = jobData.salaryMax || '';
                        document.getElementById('jobDescription').value = jobData.jobDescription || jobData.description || '';
                        document.getElementById('requiredEducation').value = jobData.requiredEducation || '';
                        document.getElementById('requiredExperience').value = jobData.requiredExperience || '';
                        document.getElementById('requiredSkills').value = jobData.requiredSkills || '';
                        document.getElementById('urgency').value = jobData.urgency || '';
                        document.getElementById('startDate').value = jobData.startDate || '';
                        document.getElementById('advertisingClosingDate').value = jobData.advertisingClosingDate || '';
                        document.getElementById('notes').value = jobData.notes || '';
                        
                        // Store the job ID for updating
                        window.currentEditJobId = jobId;
                        
                        showNotification('Job data loaded for editing (from global scope)', 'info');
                    } else {
                        showNotification('Job not found for editing', 'error');
                    }
                }
            } catch (error) {
                console.error('Error loading job for editing:', error);
                showNotification('Error loading job data: ' + error.message, 'error');
            }
        }

        // Utility Functions
        function showError(message) {
            showNotification(message, 'error');
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type} show`;
            
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas ${getNotificationIcon(type)}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 5000);
        }

        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-exclamation-circle';
                case 'warning': return 'fa-exclamation-triangle';
                default: return 'fa-info-circle';
            }
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Modal functions
        function closeJobBoardSettings() {
            const modal = document.getElementById('jobBoardSettingsModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        function saveJobBoardSettings() {
            showNotification('Job board settings saved successfully', 'success');
            closeJobBoardSettings();
        }

        // Make menu functions globally available
        window.resetMenuVisibility = function() {
            if (window.authManager) {
                return window.authManager.resetMenuVisibility();
            }
        };

        window.showBasicMenu = function() {
            if (window.authManager) {
                return window.authManager.showBasicMenu();
            }
        };

        window.updateMenuWithFeatureAuthorization = function() {
            if (window.authManager) {
                return window.authManager.updateMenuWithFeatureAuthorization();
            }
        };

        window.applyFeatureBasedMenuVisibility = function(authorizedPages) {
            if (window.authManager) {
                return window.authManager.applyFeatureBasedMenuVisibility(authorizedPages);
            }
        };

        window.updateMenuWithPermissions = function(permissions) {
            if (window.authManager) {
                return window.authManager.updateMenuWithPermissions(permissions);
            }
        };

        window.updateMenuVisibility = function() {
            if (window.authManager) {
                return window.authManager.updateMenuVisibility();
            }
        };

        // Enhanced initialization to use feature-based authorization by default
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(async () => {
                try {
                    if (window.authManager && window.authManager.updateMenuWithFeatureAuthorization) {
                        console.log('🎯 Initializing feature-based menu authorization for jobdetails.html');
                        await window.authManager.updateMenuWithFeatureAuthorization();
                    } else {
                        console.log('⚠️ AuthManager or feature authorization not available, using fallback');
                        if (window.authManager && window.authManager.showBasicMenu) {
                            window.authManager.showBasicMenu();
                        }
                    }
                } catch (error) {
                    console.error('❌ Error initializing feature-based menu for jobdetails.html:', error);
                    if (window.authManager && window.authManager.showBasicMenu) {
                        window.authManager.showBasicMenu();
                    }
                }
            }, 1500);
        });

        // Check if functions exist, if not create placeholders
        if (typeof loadJobForEditing !== 'function') {
            window.loadJobForEditing = function(jobId) {
                console.log('Loading job for editing:', jobId);
            };
        }

        if (typeof checkInternalPortalStatus !== 'function') {
            window.checkInternalPortalStatus = function(jobId) {
                console.log('Checking internal portal status for:', jobId);
            };
        }

        if (typeof loadJobDetails !== 'function') {
            window.loadJobDetails = function(jobId) {
                console.log('Loading job details for:', jobId);
            };
        }

        if (typeof loadJobCard !== 'function') {
            window.loadJobCard = function(jobId) {
                console.log('Loading job card for:', jobId);
            };
        }
    </script>

</body>
</html>

