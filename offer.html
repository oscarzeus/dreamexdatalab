<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offer Management - Dreamex Datalab HSE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Inlined CSS from css/styles.css */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            /* Theme Colors */
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            
            /* Default Values */
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem; /* Standardized, reduced from 14px */
            --font-scale: 1;
            
            /* Theme-specific variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #404040;
        }

        /* High contrast mode */
        [data-contrast="high"] {
            --text-primary: #000000;
            --text-secondary: #000000;
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --border-color: #000000;
        }

        [data-theme="dark"][data-contrast="high"] {
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --bg-primary: #000000;
            --bg-secondary: #000000;
            --border-color: #ffffff;
        }

        /* Layout density */
        [data-density="comfortable"] {
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
        }

        [data-density="compact"] {
            --spacing-unit: 0.75rem;
            --padding-sm: 0.25rem;
            --padding-md: 0.75rem;
            --padding-lg: 1rem;
        }

        [data-density="spacious"] {
            --spacing-unit: 1.5rem;
            --padding-sm: 0.75rem;
            --padding-md: 1.5rem;
            --padding-lg: 2rem;
        }

        /* Animation settings */
        [data-reduced-motion="none"] {
            --transition-speed: 0.2s;
        }

        [data-reduced-motion="reduced"] {
            --transition-speed: 0.4s;
        }

        [data-reduced-motion="minimal"] {
            --transition-speed: 0s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
        }

        /* Form Container Styles */
        .form-container {
            width: 100%;
            max-width: none;
            padding: 1.5rem;
            margin: 0;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Content Container */
        .content {
            width: 100%;
            margin: 0;
            padding: 1.5rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .top-nav {
            display: flex;
            justify-content: space-between;  /* Changed from flex-end to space-between */
            align-items: center;
            padding: 1rem;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
            position: relative;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        /* Responsive styles for company header */
        @media (max-width: 768px) {
            .company-name-header {
                font-size: 0.9rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 32px;
                height: 32px;
            }
        }

        @media (max-width: 480px) {
            .company-name-header {
                display: none;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 28px;
                height: 28px;
            }
        }

        /* Menu Visibility Control */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        .sidebar.menu-loading .menu,
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature],
        .sidebar.menu-loading li,
        .sidebar.menu-loading .menu li {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .menu-visible,
        li.menu-visible,
        [data-feature].menu-visible {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .search-bar {
            position: absolute;
            left: 1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;  /* Increased from 1rem for better spacing */
            margin-left: auto;
        }

        /* Sidebar collapse behavior (match project-list.html) */
        .sidebar { transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .main-content { transition: margin-left 0.3s ease; }
        .main-content.sidebar-collapsed { margin-left: 0; }
        .main-content.sidebar-collapsed .top-nav { left: 0.5rem; }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .notification-actions h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .notification-link {
            text-decoration: none;
            color: #3498db;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .notification-link:hover {
            background: #f8f9fa;
            color: #2980b9;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #f8f9fa;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #f5f5f5;
        }

        /* User Profile Styles */
        .user-profile { position:relative; }

        .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }

        .profile-btn img { width:100%; height:100%; object-fit:cover; }

        .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; }

        .profile-dropdown.show { display:block; }

        .profile-dropdown ul { list-style:none; }

        .profile-dropdown ul li {
            padding: 0;
        }

        .profile-dropdown ul li a {
            display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500;
        }

        .profile-dropdown ul li a:hover { background:#f1f5f9; }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* User Profile Dropdown Styles */
        .user-info {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .admin-crown-icon {
            color: #ffd700; /* Gold color for the crown */
            margin-left: 0.5rem;
            font-size: 0.9rem;
            vertical-align: middle;
            animation: crown-glow 2s ease-in-out infinite alternate;
        }

        @keyframes crown-glow {
            from {
                text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
            to {
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            }
        }

        .user-email {
            font-size: 0.9rem;
            color: #666;
        }

        .user-status {
            margin-top: 0.25rem;
        }

        .divider {
            height: 1px;
            background-color: #eee;
            margin: 0.5rem 0;
        }

        /* Profile Dropdown Status Badge */
        .user-status .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        /* Content Styles */
        .content {
            margin-top: 1rem; /* Reduced from 2rem */
            padding: 0.75rem; /* Reduced from 1rem */
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem; /* Reduced from 1rem */
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem 0.75rem; /* Reduced from 0.75rem 1rem */
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .btn {
            padding: var(--padding-sm) var(--padding-md);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
        }

        .btn-edit {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-approve {
            background-color: #27ae60;
            color: white;
        }

        .btn-decline {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: white;
        }

        .btn-icon i {
            font-size: 0.9rem;
        }

        .btn-icon.btn-approve {
            background-color: #2ecc71;
        }

        .btn-icon.btn-approve:hover {
            background-color: #27ae60;
        }

        .btn-icon.btn-decline {
            background-color: #e74c3c;
        }

        .btn-icon.btn-decline:hover {
            background-color: #c0392b;
        }

        .btn-icon.btn-export {
            background-color: #9b59b6;
        }

        .btn-icon.btn-export:hover {
            background-color: #8e44ad;
        }

        .btn-icon.btn-delete {
            background-color: #e74c3c;
        }

        .btn-icon.btn-delete:hover {
            background-color: #c0392b;
        }

        .btn-icon:not(:last-child) {
            margin-right: 0.25rem;
        }

        /* Form Styles */
        .form-container {
            width: 100%;
            max-width: none;
            margin: 1.5rem 0; /* Removed auto centering */
            padding: 1.5rem; /* Reduced from 2rem */
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: var(--spacing-unit);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .login-box {
            background-color: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-color);
            opacity: 0.8;
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon input {
            padding-left: 40px;
            width: 100%;
            height: 45px;
        }

        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.5;
        }

        .btn-login {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            height: 45px;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn-login:hover {
            background-color: var(--secondary-color);
        }

        .error-message {
            color: var(--accent-color);
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Role Badge Styles */
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-guest {
            background-color: #95a5a6;
            color: white;
        }

        .role-standard {
            background-color: #3498db;
            color: white;
        }

        .role-editor {
            background-color: #2ecc71;
            color: white;
        }

        .role-admin {
            background-color: #e67e22;
            color: white;
        }

        .role-superuser {
            background-color: #9b59b6;
            color: white;
        }

        /* Form Hint Style */
        .form-hint {
            color: #666;
            font-size: 0.8rem;
            margin-top: 4px;
            display: block;
        }

        /* Content Header with Button */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* User Table Status Styles */
        .status-active {
            background-color: #2ecc71;
            color: white;
        }

        .status-inactive {
            background-color: #95a5a6;
            color: white;
        }

        /* Modal Header Styles */
        .modal-header {
            border-bottom: 1px solid #ddd;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        /* Modal Footer Styles */
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 0.85rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end; /* Align buttons to the right */
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            bottom: 0;
            z-index: 2;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
        }

        .modal-footer .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        /* Color coding for different action buttons */
        .btn-edit {
            background-color: #3b82f6; /* Blue */
            color: white;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        .btn-edit:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background-color: #10b981; /* Green */
            color: white;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        .btn-delete {
            background-color: #f43f5e; /* Pink/Red */
            color: white;
            box-shadow: 0 2px 5px rgba(244, 63, 94, 0.3);
        }

        .btn-delete:hover {
            background-color: #e11d48;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(244, 63, 94, 0.4);
        }

        .btn-secondary {
            background-color: #6b7280; /* Gray */
            color: white;
            box-shadow: 0 2px 5px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
        }

        /* New warning color button - Yellow/Amber */
        .btn-warning {
            background-color: #f59e0b;
            color: white;
            box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }

        /* New info color button - Light blue */
        .btn-info {
            background-color: #0ea5e9;
            color: white;
            box-shadow: 0 2px 5px rgba(14, 165, 233, 0.3);
        }

        .btn-info:hover {
            background-color: #0284c7;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.4);
        }

        /* Disabled button styling */
        .btn:disabled,
        .btn.btn-disabled {
            opacity: 1; /* Changed from 0.6 */
            cursor: pointer; /* Changed from not-allowed */
            pointer-events: auto; /* Changed from none */
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled:hover,
        .btn.btn-disabled:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn.btn-success:disabled,
        .btn.btn-success.btn-disabled {
            background-color: #10b981; /* Changed from #92d3b5 to full color */
            color: #ffffff;
        }

        /* Add tooltip styling for disabled buttons */
        .btn.btn-disabled::before {
            content: attr(title);
            position: absolute;
            background-color: rgba(51, 51, 51, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn.btn-disabled::after {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: rgba(51, 51, 51, 0.9) transparent transparent transparent;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* Settings Navigation Styles */
        .settings-navigation {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }

        .settings-nav-item {
            background: white;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .settings-nav-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .settings-nav-item a {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 1.5rem;
            text-decoration: none;
            color: inherit;
            height: 100%;
        }

        .settings-nav-item i {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .settings-nav-item span {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .settings-description {
            font-size: 0.9rem;
            color: #666;
            margin: 0;
        }

        /* Settings Section Styles */
        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .settings-section h2 {
            margin-bottom: 1.5rem;
            color: var(--primary-color);
        }

        /* Role Management Styles */
        .roles-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .role-card {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .role-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .role-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .role-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .role-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #888;
        }

        .permission-section {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .permission-header {
            margin-bottom: 1rem;
        }

        .permission-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .permission-table {
            width: 100%;
            border-collapse: collapse;
        }

        .permission-table th,
        .permission-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .permission-table th:first-child,
        .permission-table td:first-child {
            text-align: left;
        }

        .permission-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Checkbox styling */
        .checkbox-container {
            display: inline-block;
            position: relative;
            padding-left: 25px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 18px;
            width: 18px;
            background-color: #eee;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .checkbox-container:hover input ~ .checkmark {
            background-color: #ccc;
        }

        .checkbox-container input:checked ~ .checkmark {
            background-color: #2196F3;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }

        .checkbox-container .checkmark:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        /* Role modal specific styles */
        #roleModal .modal-content {
            max-width: 500px;
        }

        /* Enhanced Role Management Styles */
        .roles-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
        }

        .roles-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .role-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            border: 1px solid #eee;
        }

        .role-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }

        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .role-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .role-actions {
            display: flex;
            gap: 0.5rem;
        }

        .role-actions .btn {
            padding: 0.4rem;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .role-actions .btn-edit {
            background: #e3f2fd;
            color: #2196f3;
        }

        .role-actions .btn-delete {
            background: #ffebee;
            color: #f44336;
        }

        .role-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.4;
        }

        .role-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.8rem;
            color: #888;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }

        .permissions-section {
            margin-top: 2rem;
        }

        .permissions-container {
            display: grid;
            gap: 1.5rem;
        }

        .permission-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
        }

        .permission-header {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f5f5f5;
        }

        .permission-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .permission-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        /* Approval Flow Table Styles */
        .approval-flow-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            margin: 1rem 0;
        }

        .approval-flow-table th {
            text-align: left;
            padding: 12px;
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .approval-flow-table td {
            padding: 12px;
            vertical-align: middle;
            background-color: #fff;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
        }

        .approval-flow-table td:first-child {
            border-left: 1px solid #e9ecef;
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
        }

        .approval-flow-table td:last-child {
            border-right: 1px solid #e9ecef;
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .approval-flow-table .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
        }

        .approval-flow-table .name-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .approval-flow-table .title-department {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .approval-flow-table .approval-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .approval-flow-table .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .approval-flow-table .status-approved {
            background-color: #d4edda;
            color: #155724;
        }

        .approval-flow-table .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .approval-flow-table .status-locked {
            background-color: #e9ecef;
            color: #495057;
        }

        .approval-flow-table .approval-date {
            color: #6c757d;
            font-size: 0.875rem;
        }

        .approval-flow-table .comments {
            color: #495057;
            font-size: 0.875rem;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .approval-flow-table tr.clickable {
            cursor: pointer;
        }

        .approval-flow-table tr.clickable:hover td {
            background-color: #f8f9fa;
        }

        /* Level divider */
        .approval-flow-table tr.level-divider td {
            padding: 8px 12px;
            background-color: #f8f9fa;
            color: #495057;
            font-weight: 600;
        }

        /* Many more CSS rules continue here... */
        /* Due to length constraints, I'm including the key styles. The complete CSS from styles.css has been inlined. */

        /* File Preview Modal Styles */
        /* File Preview Modal Styles */
        .file-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .file-preview-content {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            width: auto;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .file-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }

        .file-preview-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .close-preview {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-preview:hover {
            color: #dc3545;
            background: #f8f9fa;
        }

        .file-preview-body {
            flex: 1;
            overflow: auto;
            min-height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            min-height: 500px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }

        .preview-error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
        }

        .file-preview-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
            margin-top: 1rem;
        }

        .preview-action-btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .preview-download-btn {
            background: #28a745;
            color: white;
            border: none;
        }

        .preview-download-btn:hover {
            background: #218838;
        }

        .preview-open-btn {
            background: #007bff;
            color: white;
            border: none;        }        .preview-open-btn:hover {
            background: #0056b3;
        }        .salary-display {
            font-size: 0.9rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            text-align: center;
        }

        /* Offer Letter Preview Modal Styles */
        .offer-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .offer-preview-content {
            background: white;
            padding: 0;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .offer-preview-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .offer-preview-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .close-offer-preview {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .close-offer-preview:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .offer-preview-body {
            flex: 1;
            overflow: auto;
            padding: 2rem;
            background: #f8f9fa;
        }

        .offer-letter-content {
            background: white;
            padding: 3rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
            color: #333;
        }

        .letterhead {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid #007bff;
        }

        .company-logo {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 0.5rem;
        }

        .company-logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .company-logo-img {
            max-height: 80px;
            max-width: 200px;
            object-fit: contain;
        }

        .company-name {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }

        .company-address {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .letter-date {
            text-align: right;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .recipient-info {
            margin-bottom: 2rem;
        }

        .letter-body {
            margin-bottom: 2rem;
        }

        .letter-body h3 {
            color: #007bff;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .compensation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border: 1px solid #ddd;
        }

        .compensation-table th,
        .compensation-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .compensation-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .benefits-list {
            columns: 2;
            column-gap: 2rem;
            margin: 1rem 0;
        }

        .benefits-list li {
            margin-bottom: 0.5rem;
            break-inside: avoid;
        }

        .signature-section {
            margin-top: 3rem;
            display: flex;
            justify-content: space-between;
        }

        .signature-block {
            text-align: center;
            width: 45%;
        }

        .signature-line {
            border-top: 1px solid #333;
            margin-top: 2rem;
            padding-top: 0.5rem;
        }

        .offer-preview-actions {
            background: #f8f9fa;
            padding: 1.5rem 2rem;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-action-buttons {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 0.85rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            bottom: 0;
            z-index: 2;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
        }

        .preview-action-buttons .btn {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            min-width: 2.5rem;
            min-height: 2.5rem;
            justify-content: center;
            white-space: nowrap;
        }

        /* Icon-only buttons get square styling */
        .preview-action-buttons .btn:not(:has(span)):not(:has(div)) {
            padding: 0.5rem;
            border-radius: 6px;
            width: 2.5rem;
            height: 2.5rem;
        }

        .preview-action-buttons .btn i {
            font-size: 0.875rem;
        }

        .preview-action-buttons .btn-secondary {
            background-color: transparent;
            color: #6b7280;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-secondary:hover {
            background-color: #f9fafb;
            color: #374151;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-primary {
            background-color: transparent;
            color: #3b82f6;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-primary:hover {
            background-color: #dbeafe;
            color: #2563eb;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-success {
            background-color: transparent;
            color: #10b981;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-success:hover {
            background-color: #d1fae5;
            color: #059669;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-approve {
            background-color: transparent;
            color: #10b981;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-approve:hover {
            background-color: #d1fae5;
            color: #059669;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-decline {
            background-color: transparent;
            color: #ef4444;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-decline:hover {
            background-color: #fee2e2;
            color: #dc2626;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-accept {
            background-color: transparent;
            color: #3b82f6;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-accept:hover {
            background-color: #dbeafe;
            color: #2563eb;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-download {
            background-color: transparent;
            color: #6b7280;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-download:hover {
            background-color: #f9fafb;
            color: #374151;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-danger {
            background-color: transparent;
            color: #ef4444;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-danger:hover {
            background-color: #fee2e2;
            color: #dc2626;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-warning {
            background-color: transparent;
            color: #f59e0b;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-warning:hover {
            background-color: #fef3c7;
            color: #d97706;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .preview-action-buttons .btn-info {
            background-color: transparent;
            color: #3b82f6;
            border: none;
            box-shadow: none;
        }

        .preview-action-buttons .btn-info:hover {
            background-color: #dbeafe;
            color: #2563eb;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        @media (max-width: 768px) {
            .offer-preview-content {
                width: 95%;
                max-height: 95vh;
            }
            
            .offer-letter-content {
                padding: 1.5rem;
            }
            
            .benefits-list {
                columns: 1;
            }
            
            .signature-section {
                flex-direction: column;
                gap: 2rem;
            }
            
            .preview-action-buttons {
                padding: 0.75rem 1rem;
                gap: 0.5rem;
                justify-content: flex-end;
            }
            
            .preview-action-buttons .btn {
                padding: 0.5rem;
                font-size: 0.875rem;
                min-width: 2.25rem;
                min-height: 2.25rem;
                width: 2.25rem;
                height: 2.25rem;
            }
            
            .preview-action-buttons .btn i {
                font-size: 0.875rem;
            }
            
            .preview-action-buttons .btn:not(:has(span)):not(:has(div)) {
                padding: 0.5rem;
                width: 2.25rem;
                height: 2.25rem;
            }
            
            .signature-block {
                width: 100%;
            }
        }

        /* Approval Flow Section Styles */
        .approval-flow-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .approval-flow-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: #495057;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .approval-flow-header i {
            color: #007bff;
        }

        /* Approval Flow Display Styles - Matching staff.html */
        .approval-flow-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .approval-flow-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .approval-flow-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: #495057;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .approval-flow-header i {
            color: #007bff;
        }

        .approval-flow-title {
            color: #2c3e50;
            font-size: 1.2rem;
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .approval-flow-status {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .approval-flow-status.enabled {
            background: #d4edda;
            color: #155724;
        }

        .approval-flow-status.disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .approval-stages {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .approval-stage {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            position: relative;
        }

        .approval-stage:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 25px;
            width: 2px;
            height: 0.5rem;
            background: #dee2e6;
        }

        .stage-number {
            width: 35px;
            height: 35px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .stage-number.completed {
            background: #28a745;
        }

        .stage-number.pending {
            background: #ffc107;
            color: #000;
        }

        .stage-number.rejected {
            background: #dc3545;
        }

        .stage-number.waiting {
            background: #6c757d;
            color: white;
        }

        .stage-number.current {
            background: #ffc107;
            color: #000;
            animation: pulse 2s infinite;
        }

        .stage-number.disabled {
            background: #e9ecef;
            color: #adb5bd;
        }

        .stage-info {
            flex: 1;
        }

        .stage-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .approver-info {
            margin-bottom: 0.25rem;
        }

        .approver-name {
            color: #007bff;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .stage-timestamp {
            color: #6c757d;
            font-size: 0.75rem;
        }

        .stage-comments {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
        }

        .stage-status-text {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .stage-status-text.completed {
            color: #28a745;
        }

        .stage-status-text.current {
            color: #ffc107;
        }

        .stage-status-text.waiting {
            color: #6c757d;
        }

        .stage-status-text.disabled {
            color: #adb5bd;
        }

        .stage-status-text.pending {
            color: #ffc107;
        }

        .stage-status-text.rejected {
            color: #dc3545;
        }

        /* Sequential approval flow styles */
        .approval-stage.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .approval-stage.current {
            background: linear-gradient(135deg, #fff3cd, #fef7e0);
            border: 2px solid #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .approval-stage.waiting {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .sequential-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #1976d2;
        }

        .sequential-info i {
            margin-right: 0.5rem;
            color: #2196f3;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .approval-flow-empty {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .approval-flow-empty i {
            font-size: 2rem;
            color: #dee2e6;
            margin-bottom: 0.5rem;
        }

        .no-approval-flow {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .no-approval-flow i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #dee2e6;
        }

        .approval-flow-loading {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
        }

        .approval-flow-error {
            text-align: center;
            padding: 1rem;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 4px;
        }

        .approval-loading {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
        }

        .approval-error {
            text-align: center;
            padding: 1rem;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .no-approval-flow {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
        }

        /* User Profile Avatar and Dropdown Styles */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .profile-btn:hover {
            transform: scale(1.05);
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color, #3498db);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            user-select: none;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .profile-dropdown.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .profile-dropdown li {
            padding: 0;
        }

        .profile-dropdown li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
        }

        .profile-dropdown li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown li a i {
            margin-right: 12px;
            width: 16px;
            color: #666;
            font-size: 0.9rem;
        }

        .profile-dropdown li:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }

        /* User profile responsive adjustments */
        @media (max-width: 768px) {
            .user-profile {
                position: relative;
            }
            
            .profile-dropdown {
                right: -10px;
                min-width: 180px;
                max-width: 200px;
            }
            
            .user-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.8rem;
            }

            .profile-btn {
                width: 36px;
                height: 36px;
            }
        }

        @media (max-width: 480px) {
            .profile-dropdown {
                right: -20px;
                min-width: 160px;
            }
            
            .profile-dropdown li a {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
        }        .interview-container { /* Renamed to offer-container conceptually, but class kept for CSS consistency */
            width: 100%;
            margin: 0;
            max-width: none;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.25rem;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            margin-bottom: 2rem;
            margin: 0 2rem 2rem 2rem;
            transition: box-shadow 0.3s ease;
        }

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        .page-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }

        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #495057;
            font-weight: 500;
        }

        .stat-number {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            flex-shrink: 0;
        }

        /* Professional stats cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin: 0 2rem 1.5rem 2rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .stat-card .stat-number {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            line-height: 1;
            background: none;
            padding: 0;
            border-radius: 0;
        }

        .stat-card div:last-child {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
            line-height: 1.2;
        }

        .loading-container {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-container {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }        .candidates-table-container { /* Reused class name for offers table container */
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: none;
            margin: 0;
            display: block;
        }

        .table-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background: #0056b3;
        }

        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }        .candidates-table { /* Reused class name for offers table */
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }        .candidates-table th,
        .candidates-table td {
            padding: 1rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            word-wrap: break-word;
        }

        .candidates-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .candidates-table tbody tr:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        /* Enhanced styling for clickable offer rows */
        .candidates-table tbody tr {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .candidates-table tbody tr:hover .candidate-name {
            color: #007bff;
        }

        .candidate-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        .candidate-info {
            display: flex;
            align-items: center;
        }

        .candidate-details {
            flex: 1;
        }

        .candidate-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .candidate-email {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Offer Statuses (example) */
        .status-offer-pending { background: #fff3cd; color: #856404; }
        .status-offer-sent { background: #d1ecf1; color: #0c5460; }
        .status-offer-viewed { background: #cce5ff; color: #004085; }
        .status-offer-accepted { background: #d4edda; color: #155724; }
        .status-offer-declined { background: #f8d7da; color: #721c24; }
        .status-offer-rescinded { background: #e9ecef; color: #495057; }
        .status-offer-expired { background: #f5c6cb; color: #721c24; }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-draft {
            background: #e9ecef;
            color: #495057;
        }

        .status-submitted {
            background: #cce5ff;
            color: #004085;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-declined {
            background: #f8d7da;
            color: #721c24;
        }

        .status-accepted {
            background: #d1f2eb;
            color: #0c5460;
        }

        .status-interviewed {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-hired {
            background: #d1ecf1;
            color: #0c5460;
        }        .action-buttons {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
        }

        .files-column {
            max-width: 150px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
            border: 1px solid #dee2e6;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-icon {
            color: #007bff;
            font-size: 0.9rem;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #2c3e50;
        }

        .file-link {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
        }

        .file-link:hover {
            color: #007bff;
        }

        .download-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .download-btn:hover {
            background: #e9ecef;
        }

        .no-files {
            color: #6c757d;
            font-style: italic;
            font-size: 0.85rem;
            text-align: center;
        }        .btn-action {
            padding: 0.4rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            margin: 0 1px;
            flex-shrink: 0;
        }

        .btn-view {
            background: #007bff;
            color: white;
        }

        .btn-view:hover {
            background: #0056b3;
        }

        .btn-edit {
            background: #28a745;
            color: white;
        }

        .btn-edit:hover {
            background: #1e7e34;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }        .btn-delete:hover {
            background: #c82333;
        }

        .btn-accept {
            background: #28a745;
            color: white;
        }

        .btn-accept:hover {
            background: #218838;
        }

        .btn-approve {
            background: #17a2b8;
            color: white;
        }

        .btn-approve:hover {
            background: #138496;
        }

        .btn-decline {
            background: #dc3545;
            color: white;
        }

        .btn-decline:hover {
            background: #c82333;
        }

        /* Disabled button states for sequential approval */
        .btn-approve:disabled,
        .btn-decline:disabled {
            background: #6c757d !important;
            color: #ffffff !important;
            opacity: 0.6;
            cursor: not-allowed;
            border-color: #6c757d !important;
        }

        .btn-approve:disabled:hover,
        .btn-decline:disabled:hover {
            background: #6c757d !important;
            transform: none;
        }

        /* Approval stage waiting state */
        .approval-stage.waiting {
            opacity: 0.7;
        }

        .approval-stage.waiting .stage-number {
            background: #e9ecef;
            color: #6c757d;
            border-color: #dee2e6;
        }

        .approval-stage.waiting .stage-status-text {
            color: #6c757d;
            font-style: italic;
        }

        /* Highlight rows with submitted offers awaiting approval */
        .submitted-offer-row {
            background: linear-gradient(90deg, #f8f9fa 0%, #e3f2fd 100%);
            border-left: 4px solid #2196f3;
        }

        .submitted-offer-row:hover {
            background: linear-gradient(90deg, #f1f3f4 0%, #e1f5fe 100%);
        }

        /* Make approval buttons more prominent for submitted offers */
        .submitted-offer-row .btn-approve,
        .submitted-offer-row .btn-decline {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }        .candidates-table th:last-child,
        .candidates-table td:last-child {
            width: 220px;
            min-width: 220px;
        }        /* Distribute remaining columns evenly */
        .candidates-table th:nth-child(1),
        .candidates-table td:nth-child(1) {
            width: 18%;
        }

        .candidates-table th:nth-child(2),
        .candidates-table td:nth-child(2) {
            width: 18%;
        }

        .candidates-table th:nth-child(3),
        .candidates-table td:nth-child(3) {
            width: 12%;
        }

        .candidates-table th:nth-child(4),
        .candidates-table td:nth-child(4) {
            width: 15%;
        }

        .candidates-table th:nth-child(5),
        .candidates-table td:nth-child(5) {
            width: 12%;
        }

        .candidates-table th:nth-child(6),
        .candidates-table td:nth-child(6) {
            width: 10%;
        }

        /* Specific styles for pending offers table (8 columns - added Offer Document) */
        #pendingOffersTable th:nth-child(1),
        #pendingOffersTable td:nth-child(1) {
            width: 16%;
        }

        #pendingOffersTable th:nth-child(2),
        #pendingOffersTable td:nth-child(2) {
            width: 16%;
        }

        #pendingOffersTable th:nth-child(3),
        #pendingOffersTable td:nth-child(3) {
            width: 11%;
        }

        #pendingOffersTable th:nth-child(4),
        #pendingOffersTable td:nth-child(4) {
            width: 13%;
        }

        #pendingOffersTable th:nth-child(5),
        #pendingOffersTable td:nth-child(5) {
            width: 11%;
        }

        #pendingOffersTable th:nth-child(6),
        #pendingOffersTable td:nth-child(6) {
            width: 9%;
        }

        #pendingOffersTable th:nth-child(7),
        #pendingOffersTable td:nth-child(7) {
            width: 15%;
            min-width: 180px;
        }

        #pendingOffersTable th:nth-child(8),
        #pendingOffersTable td:nth-child(8) {
            width: 15%;
            min-width: 200px;
        }.actions-cell {
            text-align: center;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            flex-wrap: nowrap;
        }

        /* Hide Actions column */
        th:has-text("Actions"),
        th:contains("Actions"),
        .actions-cell,
        td.actions-cell {
            display: none !important;
        }

        /* Hide Actions column headers by position for pending offers (8th column) */
        #pendingOffersTable th:nth-child(8),
        #pendingOffersTable td:nth-child(8) {
            display: none !important;
        }

        /* Hide Actions column headers by position for accepted offers (7th column) */
        #acceptedOffersTable th:nth-child(7),
        #acceptedOffersTable td:nth-child(7) {
            display: none !important;
        }

        /* Hide Actions column headers by position for declined offers (6th column) */
        #declinedOffersTable th:nth-child(6),
        #declinedOffersTable td:nth-child(6) {
            display: none !important;
        }

        /* Hide Offer Document column for pending offers (7th column) */
        #pendingOffersTable th:nth-child(7),
        #pendingOffersTable td:nth-child(7) {
            display: none !important;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        .real-time-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #28a745;
            font-size: 0.9rem;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        .last-updated {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }        /* Responsive Design */
        @media (min-width: 1200px) {
            .candidates-table-container {
                width: 100%;
                max-width: none;
            }
            
            .candidates-table {
                width: 100%;
                min-width: 1000px;
            }
        }

        @media (max-width: 768px) {
            .page-header {
                padding: 1.5rem;
            }

            .stats-bar {
                flex-direction: column;
                gap: 0.75rem;
            }

            .candidates-table {
                font-size: 0.9rem;
            }

            .candidates-table th,
            .candidates-table td {
                padding: 0.75rem 0.5rem;
            }

            .files-column {
                max-width: 120px;
            }

            .file-item {
                font-size: 0.75rem;
            }            /* Hide phone column on very small screens */
            .candidates-table th:nth-child(4),
            .candidates-table td:nth-child(4) {
                display: none;
            }

            /* Ensure actions remain horizontal on mobile */
            .actions-cell {
                min-width: 200px;
                overflow-x: auto;
            }

            .btn-action {
                min-width: 28px;
                height: 28px;
                padding: 0.3rem;
                margin: 0;
                flex-shrink: 0;
            }
        }

        /* Tab Layout Styles */
        .content-tabs {
            margin: 0 2rem;
            width: calc(100% - 4rem);
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-nav-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            transition: all 0.2s;
            border-radius: 0;
        }

        .tab-nav-btn:hover {
            color: #28a745;
            background: #f8f9fa;
        }

        /* Default active tab styling */
        .tab-nav-btn.active {
            color: #ffffff;
            background: #28a745;
        }

        /* Specific tab colors when active */
        #pendingOffersTabBtn.active {
            color: #ffffff;
            background: #28a745; /* Green for pending offers */
        }

        #sentOffersTabBtn.active {
            color: #ffffff;
            background: #ffc107; /* Yellow for sent offers */
        }

        #completedOffersTabBtn.active {
            color: #ffffff;
            background: #dc3545; /* Red for completed offers */
        }        .tab-content {
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-controls {
            margin-bottom: 1.5rem;
        }

        .search-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 1rem;
        }

        /* Responsive tab styles */
        @media (max-width: 768px) {
            .tab-nav-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                flex-direction: column;
                gap: 0.25rem;
            }

            .tab-nav-btn i {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .tab-navigation {
                flex-direction: column;
            }

            .tab-nav-btn {
                flex-direction: row;
                justify-content: flex-start;
                padding: 1rem;
                border-radius: 0;
            }

            .tab-nav-btn.active {
                border-bottom: none;
                border-left: 3px solid #007bff;
            }
        }        /* Button styles for job management placeholder */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }        /* Jobs specific styles (reused for offers) */
        .job-title-cell { /* Offer specific: Candidate Name cell */
            min-width: 200px;
        }

        .job-salary { /* Offer specific: Offered Salary */
            color: #28a745;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .application-count { /* Offer specific: e.g. Offer Version Count */
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .application-count-badge {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .job-actions { /* Offer Actions */
            display: flex;
            gap: 0.25rem;
        }

        /* Status badges for jobs (reused for offers) */
        .status-active { /* e.g. status-offer-pending */
            background: #d4edda;
            color: #155724;
        }

        .status-closed { /* e.g. status-offer-accepted / status-offer-declined */
            background: #f8d7da;
            color: #721c24;
        }

        .status-draft { /* e.g. status-offer-draft */
            background: #fff3cd;
            color: #856404;
        }        /* Job filter indicator styles (reused for offers) */
        .job-filter-indicator {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .job-filter-indicator button {
            background: none;
            border: none;
            color: #1976d2;
            cursor: pointer;
            padding: 0;
            margin-left: 0.25rem;
            font-size: 0.9rem;
        }        .job-filter-indicator button:hover {
            color: #1565c0;
        }

        /* Applicants Tab Styles (reused for Accepted/Declined Offers) */
        .applicant-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .selected-job-info { /* Reused for selected offer info */
            flex: 1;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
        }

        .selected-job-title { /* Reused for selected offer title */
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 0.5rem 0;
        }

        .selected-job-details { /* Reused for selected offer details */
            color: #6c757d;
            margin: 0;
            font-size: 0.9rem;
        }

        .applicants-table { /* Reused for accepted/declined offers table */
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .applicants-table th {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
            font-size: 0.85rem;
        }

        .applicants-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
            font-size: 0.85rem;
        }

        .applicants-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .applicant-name { /* Candidate Name in offer context */
            font-weight: 600;
            color: #2c3e50;
        }

        .no-applicants { /* Reused for no offers message */
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .no-applicants i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .no-applicants h3 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        .no-applicants p {
            margin: 0;
            opacity: 0.8;
        }

        .status-reviewed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-shortlisted {
            background: #fff3cd;
            color: #856404;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .action-btn {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 0.125rem;
        }

        /* Action button variants */
        .btn-view {
            background-color: #e6f3ff;
            color: #0066cc;
        }

        .btn-view:hover {
            background-color: #cce6ff;
            transform: translateY(-1px);
        }

        .btn-edit {
            background-color: #fff3e0;
            color: #ff9800;
        }

        .btn-edit:hover {
            background-color: #ffe0b3;
            transform: translateY(-1px);
        }

        .btn-info {
            background-color: #e8f5e8;
            color: #4caf50;
        }

        .btn-info:hover {
            background-color: #d4f3d4;
            transform: translateY(-1px);
        }

        .btn-mail {
            background-color: #f3e5f5;
            color: #9c27b0;
        }

        .btn-mail:hover {
            background-color: #e1bee7;
            transform: translateY(-1px);
        }

        .btn-hire {
            background-color: #e8f5e8;
            color: #2e7d32;
            font-weight: bold;
        }

        .btn-hire:hover {
            background-color: #c8e6c9;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
        }

        .btn-hire:disabled {
            background-color: #f5f5f5;
            color: #9e9e9e;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
        }

        /* Mobile responsive for applicant controls */
        @media (max-width: 768px) {
            .applicant-controls-row {
                flex-direction: column;
                gap: 1rem;
            }

            .selected-job-info {
                order: 1;
            }

            .applicants-table {
                font-size: 0.8rem;
            }

            .applicants-table th,
            .applicants-table td {
                padding: 0.5rem 0.25rem;
            }            /* Stack action buttons vertically on mobile */
            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }
        }

        /* Applicant Modal Styles (reused for Offer Modal, needs adaptation) */
        .applicant-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .applicant-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .applicant-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .applicant-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-modal:hover {
            color: #dc3545;
            background: #f8f9fa;
        }

        .applicant-modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .applicant-info-section {
            margin-bottom: 1.5rem;
        }

        .applicant-info-section h4 {
            color: #495057;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .applicant-info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .applicant-info-label {
            font-weight: 500;
            color: #6c757d;
        }

        .applicant-info-value {
            color: #2c3e50;
        }        .status-update-section {
            grid-column: 1 / -1;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .form-control {
            padding: 0.5rem;
            border: 1px solid #ced4da;            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
        }

        .form-control:focus {
            border-color: #007bff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Schedule Modal Form Styles (reused, may need adaptation for offers) */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #007bff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }        /* Interviewer Dropdown Styling (reused, may need adaptation) */
        #interviewerSelect {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
        }

        #interviewerSelect:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%230066cc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Multi-Interviewer Selection Styles (reused, may need adaptation) */
        .interviewer-selection-container {
            width: 100%;
        }

        .interviewer-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .selected-interviewers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 20px;
        }

        .interviewer-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            color: #1565c0;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid #bbdefb;
            gap: 0.5rem;
        }

        .interviewer-tag .remove-interviewer {
            background: none;
            border: none;
            color: #1565c0;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            margin: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .interviewer-tag .remove-interviewer:hover {
            background: #1565c0;
            color: white;
        }        .empty-interviewers-message {
            color: #6c757d;
            font-style: italic;
            font-size: 0.875rem;
            padding: 0.5rem 0;
        }

        /* Existing Interviews Display (reused, may need adaptation) */
        .loading-interviews {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
        }

        .no-existing-interviews {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #dee2e6;
        }

        .existing-interview-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .existing-interview-item:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }

        .interview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .interview-date-time {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .interview-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .interview-status.scheduled {
            background: #d4edda;
            color: #155724;
        }

        .interview-status.completed {
            background: #cce5ff;
            color: #004085;
        }

        .interview-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .interview-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .interview-detail-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.25rem;
        }

        .interview-detail-label {
            font-weight: 500;
            min-width: 80px;
        }

        .interview-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 4px;
        }

        /* Schedule Status Badges (reused, may need adaptation) */
        .schedule-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }        .schedule-status.scheduled {
            background: #d4edda;
            color: #155724;
        }

        .schedule-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .schedule-status.expired {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .schedule-status.completed {
            background: #cce5ff;
            color: #004085;
        }

        /* Schedule Column Styles (reused, may need adaptation) */
        .schedule-column {
            min-width: 150px;
        }

        .schedule-column .btn {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-column .btn-primary {
            background: #007bff;
            color: white;
        }        .schedule-column .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        /* Evaluation Modal Styles (reused, may need adaptation) */
        .evaluation-form {
            margin-top: 1rem;
        }

        .evaluation-criteria {
            margin: 1.5rem 0;
        }

        .criteria-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .criteria-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .rating-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .rating-stars {
            display: flex;
            gap: 0.25rem;
            margin-right: 1rem;
        }

        .star {
            font-size: 1.5rem;
            color: #dee2e6;
            cursor: pointer;
            transition: color 0.2s;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: #ffc107;
        }

        .star.active ~ .star {
            color: #dee2e6;
        }

        .rating-label {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .criteria-notes {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .evaluation-candidate-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Button Styles for Evaluation */
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-info {
            background-color: #4A90E2;
            border: none;
            color: white;
            transition: background-color 0.2s ease;
        }

        .btn-info:hover {
            background-color: #357ABD;
        }

        /* Custom Table Styles for Offer Management */
        .offers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .jobs-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .jobs-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .jobs-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }        .jobs-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .jobs-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .job-title-cell { /* Candidate Name for offers */
            font-weight: 600;
            color: #2c3e50;
        }

        .job-code { /* Offer ID or Code */
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
        }

        .search-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }

        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .d-none {
            display: none !important;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem;
            gap: 1rem;
        }

        .pagination-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .urgency-critical {
            color: #dc3545;
            font-weight: 600;
        }

        .urgency-high {
            color: #fd7e14;
            font-weight: 600;
        }

        .urgency-medium {
            color: #ffc107;
            font-weight: 600;
        }

        .urgency-normal {
            color: #28a745;
            font-weight: 500;
        }

        .urgency-low {
            color: #6c757d;
            font-weight: 400;
        }        .salary-range {
            color: #28a745;
            font-weight: 500;
        }

        .employment-type {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .applications-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
        }

        .count-badge {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .urgency-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .text-muted {
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .applicant-modal-body {
                grid-template-columns: 1fr;
            }
            
            .search-export-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-wrapper {
                min-width: auto;
            }
            
            .jobs-table {
                font-size: 0.8rem;
            }
            
            .jobs-table th,
            .jobs-table td {
                padding: 0.5rem 0.25rem;
            }
              .pagination {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        /* Evaluation Rank Modal Styles (reused, may need adaptation) */
        .evaluation-rank-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
        }

        .evaluation-rank-content {
            position: relative;
            background: white;
            max-width: 900px;
            margin: 2rem auto;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .evaluation-rank-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank-header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .evaluation-rank-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .rank-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .rank-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .evaluation-rank-body {
            padding: 2rem;
        }

        .applicant-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
        }

        .applicant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .applicant-info h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.3rem;
        }

        .applicant-info p {
            margin: 0.5rem 0 0 0;
            color: #6c757d;
        }

        .overall-rank {
            text-align: center;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .rank-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .rank-excellent {
            background: #d4edda;
            color: #155724;
        }

        .rank-good {
            background: #d1ecf1;
            color: #0c5460;
        }

        .rank-average {
            background: #fff3cd;
            color: #856404;
        }

        .rank-below-average {
            background: #f8d7da;
            color: #721c24;
        }

        .rank-poor {
            background: #dc3545;
            color: white;
        }

        .evaluation-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .metrics-section {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .metrics-section h5 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metrics-section h5 i {
            color: #007bff;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .metric-item:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #495057;
        }

        .metric-value {
            font-weight: 600;
            color: #007bff;
        }

        .notes-section {
            margin-top: 2rem;
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .notes-section h5 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .note-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }

        .note-item:last-child {
            margin-bottom: 0;
        }

        .note-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .note-evaluator {
            font-weight: 600;
            color: #2c3e50;
        }

        .note-date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .note-content {
            color: #495057;
            line-height: 1.5;
        }

        .no-evaluations {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .no-evaluations i {
            font-size: 3rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }

        .no-evaluations h4 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }        /* Create New Offer Modal Styles */
        #createOfferModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        /* Create Offer Modal Form Styles */
        #createOfferModal .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        #createOfferModal .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        #createOfferModal .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        #createOfferModal .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        #createOfferModal .close-btn:hover {
            color: #dc3545;
            background: #f8f9fa;
        }

        /* Template Selection Styles */
        .template-preview-container {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            background: #f8f9fa;
        }

        .template-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .template-preview-header h4 {
            margin: 0;
            color: #495057;
            font-size: 1rem;
        }

        .template-preview-content {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Times New Roman', serif;
            line-height: 1.6;
        }

        .btn-link {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .btn-link:hover {
            background: #e9ecef;
            text-decoration: none;
        }

        .loading-templates {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
        }

        .loading-templates i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* File Upload Column Styles */
        .file-upload-cell {
            position: relative;
            min-width: 180px;
            max-width: 200px;
        }

        .file-upload-container {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 0.25rem;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            min-height: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .file-upload-container:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .file-upload-container.dragover {
            border-color: #2ecc71;
            background: #d4edda;
            transform: scale(1.02);
        }

        .file-upload-icon {
            font-size: 1.5rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .file-upload-text {
            font-size: 0.8rem;
            color: #6c757d;
            line-height: 1.2;
        }

        .file-input {
            display: none;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .uploaded-file-info {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .uploaded-file-icon {
            color: #dc3545;
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }

        .uploaded-file-name {
            font-size: 0.8rem;
            font-weight: 500;
            color: #2c3e50;
            white-space: nowrap;
            overflow: hidden;
            text-decoration: none;
            cursor: pointer;
        }

        .uploaded-file-name:hover {
            text-decoration: underline;
            color: #3498db;
        }

        .uploaded-file-actions {
            display: flex;
            gap: 0.25rem;
            margin-left: 0.5rem;
        }

        .file-action-btn {
            background: none;
            border: none;
            padding: 0.25rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            color: #6c757d;
            transition: all 0.2s;
        }

        .file-action-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .file-action-btn.download:hover {
            color: #28a745;
        }

        .file-action-btn.delete:hover {
            color: #dc3545;
        }

        .file-upload-progress {
            width: 100%;
            background: #e9ecef;
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .file-upload-progress-bar {
            height: 4px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
        }

        .file-upload-error {
            color: #dc3545;
            font-size: 0.7rem;
            margin-top: 0.25rem;
            text-align: center;
        }

        /* Mobile responsive file upload */
        @media (max-width: 768px) {
            .file-upload-container {
                min-height: 60px;
                padding: 0.75rem;
            }
            
            .file-upload-icon {
                font-size: 1.2rem;
                margin-bottom: 0.25rem;
            }
            
            .file-upload-text {
                font-size: 0.7rem;
            }
            
            .uploaded-file {
                padding: 0.5rem;
            }
            
            .uploaded-file-name {
                font-size: 0.7rem;
            }
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .form-section h3 {
            color: #495057;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            flex: 1;
            margin-bottom: 1rem;
        }

        .form-group.half-width {
            flex: 0 0 calc(50% - 0.5rem);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #007bff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .form-group input[readonly] {
            background-color: #e9ecef;
            opacity: 1;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 0.5rem;
            width: auto;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            min-width: 150px;
        }

        .applicant-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .applicant-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .applicant-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-modal:hover {
            color: #dc3545;
            background: #f8f9fa;
        }

        .applicant-modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .applicant-info-section {
            margin-bottom: 1.5rem;
        }

        .applicant-info-section h4 {
            color: #495057;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .applicant-info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .applicant-info-label {
            font-weight: 500;
            color: #6c757d;
        }

        .applicant-info-value {
            color: #2c3e50;
        }        .status-update-section {
            grid-column: 1 / -1;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #dee2e6;
        }

        .form-control {
            padding: 0.5rem;
            border: 1px solid #ced4da;            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
        }

        .form-control:focus {
            border-color: #007bff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Schedule Modal Form Styles (reused, may need adaptation for offers) */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
            background: white;
            color: #495057;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #007bff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }        /* Interviewer Dropdown Styling (reused, may need adaptation) */
        #interviewerSelect {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            appearance: none;
        }

        #interviewerSelect:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%230066cc' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Multi-Interviewer Selection Styles (reused, may need adaptation) */
        .interviewer-selection-container {
            width: 100%;
        }

        .interviewer-input-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .selected-interviewers {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            min-height: 20px;
        }

        .interviewer-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            color: #1565c0;
            padding: 0.375rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid #bbdefb;
            gap: 0.5rem;
        }

        .interviewer-tag .remove-interviewer {
            background: none;
            border: none;
            color: #1565c0;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            margin: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .interviewer-tag .remove-interviewer:hover {
            background: #1565c0;
            color: white;
        }        .empty-interviewers-message {
            color: #6c757d;
            font-style: italic;
            font-size: 0.875rem;
            padding: 0.5rem 0;
        }

        /* Existing Interviews Display (reused, may need adaptation) */
        .loading-interviews {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
        }

        .no-existing-interviews {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px dashed #dee2e6;
        }

        .existing-interview-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .existing-interview-item:hover {
            background: #e9ecef;
            border-color: #ced4da;
        }

        .interview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .interview-date-time {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .interview-status {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .interview-status.scheduled {
            background: #d4edda;
            color: #155724;
        }

        .interview-status.completed {
            background: #cce5ff;
            color: #004085;
        }

        .interview-status.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .interview-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .interview-detail-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.25rem;
        }

        .interview-detail-label {
            font-weight: 500;
            min-width: 80px;
        }

        .interview-actions {
            margin-top: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 4px;
        }

        /* Schedule Status Badges (reused, may need adaptation) */
        .schedule-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }        .schedule-status.scheduled {
            background: #d4edda;
            color: #155724;
        }

        .schedule-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .schedule-status.expired {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .schedule-status.completed {
            background: #cce5ff;
            color: #004085;
        }

        /* Schedule Column Styles (reused, may need adaptation) */
        .schedule-column {
            min-width: 150px;
        }

        .schedule-column .btn {
            font-size: 0.8rem;
            padding: 0.375rem 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-column .btn-primary {
            background: #007bff;
            color: white;
        }        .schedule-column .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        /* Evaluation Modal Styles (reused, may need adaptation) */
        .evaluation-form {
            margin-top: 1rem;
        }

        .evaluation-criteria {
            margin: 1.5rem 0;
        }

        .criteria-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .criteria-item label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .rating-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .rating-stars {
            display: flex;
            gap: 0.25rem;
            margin-right: 1rem;
        }

        .star {
            font-size: 1.5rem;
            color: #dee2e6;
            cursor: pointer;
            transition: color 0.2s;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: #ffc107;
        }

        .star.active ~ .star {
            color: #dee2e6;
        }

        .rating-label {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .criteria-notes {
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .evaluation-candidate-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Button Styles for Evaluation */
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }

        .btn-info {
            background-color: #4A90E2;
            border: none;
            color: white;
            transition: background-color 0.2s ease;
        }

        .btn-info:hover {
            background-color: #357ABD;
        }

        /* Custom Table Styles for Offer Management */
        .offers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .jobs-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
        }

        .jobs-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .jobs-table td {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }        .jobs-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .jobs-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .job-title-cell { /* Candidate Name for offers */
            font-weight: 600;
            color: #2c3e50;
        }

        .job-code { /* Offer ID or Code */
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
        }

        .search-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }

        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .d-none {
            display: none !important;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1.5rem;
            gap: 1rem;
        }

        .pagination-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 0.5rem 0.75
        }

        .metric-value {
            font-weight: 600;
            color: #007bff;
        }

        .notes-section {
            margin-top: 2rem;
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .notes-section h5 {
            margin: 0 0 1rem 0;
            color: #495057;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .note-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }

        .note-item:last-child {
            margin-bottom: 0;
        }

        .note-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .note-evaluator {
            font-weight: 600;
            color: #2c3e50;
        }

        .note-date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .note-content {
            color: #495057;
            line-height: 1.5;
        }

        .no-evaluations {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .no-evaluations i {
            font-size: 3rem;
            color: #dee2e6;
            margin-bottom: 1rem;
        }

        .no-evaluations h4 {
            margin: 0 0 0.5rem 0;
            color: #495057;
        }

        @media (max-width: 768px) {
            .evaluation-rank-content {
                margin: 1rem;
                max-width: calc(100% - 2rem);
            }
            
            .evaluation-metrics {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .applicant-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }

        /* Edit Offer Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: #f8f9fa;
        }

        .modal-footer {
            background: #f8f9fa;
            padding: 1.5rem 2rem;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-section h3 {
            margin: 0 0 1.5rem 0;
            color: #2c3e50;
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-section h3 i {
            color: #007bff;
        }

        .form-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            flex: 1;
        }

        .form-group.half-width {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #495057;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .form-group input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 1rem;
            }

            .form-row {
                flex-direction: column;
                gap: 1rem;
            }

            .modal-header {
                padding: 1rem 1.5rem;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .modal-footer {
                padding: 1rem 1.5rem;
                flex-direction: column;
                align-items: flex-end;
            }
        }
    </style>
</head>
<body>
    <!-- File Preview Modal (reused) -->
    <div id="filePreviewModal" class="file-preview-modal">
        <div class="file-preview-content">
            <div class="file-preview-header">
                <h3 class="file-preview-title" id="previewTitle">File Preview</h3>
                <button class="close-preview" onclick="closeFilePreview()">&times;</button>
            </div>
            <div class="file-preview-body" id="previewBody">
                <!-- Preview content will be inserted here -->
            </div>
            <div class="file-preview-actions">
                <button class="preview-action-btn preview-download-btn" id="previewDownloadBtn">
                    <i class="fas fa-download"></i>
                    Download
                </button>
                <button class="preview-action-btn preview-open-btn" id="previewOpenBtn">
                    <i class="fas fa-external-link-alt"></i>
                    Open in New Tab
                </button>
            </div>
        </div>
    </div>

    <!-- Offer Details Modal (adapted from Applicant Modal) -->
    <div id="offerModal" class="applicant-modal"> <!-- ID changed to offerModal -->
        <div class="applicant-modal-content">
            <div class="applicant-modal-header">
                <h3 class="applicant-modal-title">Offer Details</h3> <!-- Title changed -->
                <button class="close-modal" onclick="closeOfferModal()">&times;</button> <!-- JS function to be created -->
            </div>
            <div class="applicant-modal-body">
                <!-- Sections to be adapted for Offer Details -->
                <div class="applicant-info-section">
                    <h4>Candidate Information</h4>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Full Name:</span>
                        <span class="applicant-info-value" id="modalOfferCandidateName">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Email:</span>
                        <span class="applicant-info-value" id="modalOfferCandidateEmail">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Job Title:</span>
                        <span class="applicant-info-value" id="modalOfferJobTitle">-</span>
                    </div>
                </div>

                <div class="applicant-info-section">
                    <h4>Offer Information</h4>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Offer Date:</span>
                        <span class="applicant-info-value" id="modalOfferDate">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Offered Salary:</span>
                        <span class="applicant-info-value" id="modalOfferSalary">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Expiry Date:</span>
                        <span class="applicant-info-value" id="modalOfferExpiryDate">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Status:</span>
                        <span class="applicant-info-value" id="modalOfferStatus">-</span>
                    </div>
                    <div class="applicant-info-item">
                        <span class="applicant-info-label">Offer Letter:</span>
                        <span class="applicant-info-value" id="modalOfferLetterLink">-</span>
                    </div>
                </div>

                <div class="status-update-section">
                    <h4>Update Offer Status</h4>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="offerStatusSelect" class="form-control">
                            <option value="pending">Pending</option>
                            <option value="sent">Sent</option>
                            <option value="viewed">Viewed</option>
                            <option value="accepted">Accepted</option>
                            <option value="declined">Declined</option>
                            <option value="rescinded">Rescinded</option>
                            <option value="expired">Expired</option>
                        </select>
                        <button class="btn btn-primary" onclick="updateOfferStatusFromModal()"> <!-- JS function to be created -->
                            Update Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Offer Modal -->
    <div id="editOfferModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; width: 95%;">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> Edit Offer</h2>
                <button class="close-btn" onclick="closeEditOfferModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editOfferForm">
                    <!-- Candidate Information Section (Read-only) -->
                    <div class="form-section">
                        <h3><i class="fas fa-user"></i> Candidate Information</h3>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editCandidateName">Candidate Name</label>
                                <input type="text" id="editCandidateName" name="editCandidateName" readonly>
                            </div>
                            <div class="form-group half-width">
                                <label for="editCandidateEmail">Email</label>
                                <input type="email" id="editCandidateEmail" name="editCandidateEmail" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editCandidatePhone">Phone</label>
                                <input type="tel" id="editCandidatePhone" name="editCandidatePhone" readonly>
                            </div>
                            <div class="form-group half-width">
                                <label for="editCandidateAddress">Address</label>
                                <input type="text" id="editCandidateAddress" name="editCandidateAddress" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Job Information Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-briefcase"></i> Job Information</h3>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editJobTitle">Job Title</label>
                                <input type="text" id="editJobTitle" name="editJobTitle" readonly>
                            </div>
                            <div class="form-group half-width">
                                <label for="editDepartment">Department</label>
                                <input type="text" id="editDepartment" name="editDepartment" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editLocation">Work Location</label>
                                <input type="text" id="editLocation" name="editLocation" readonly>
                            </div>
                            <div class="form-group half-width">
                                <label for="editEmploymentType">Employment Type</label>
                                <input type="text" id="editEmploymentType" name="editEmploymentType" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Offer Details Section (Editable) -->
                    <div class="form-section">
                        <h3><i class="fas fa-money-bill-wave"></i> Offer Details</h3>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editOfferedSalary">Offered Salary *</label>
                                <input type="number" id="editOfferedSalary" name="editOfferedSalary" step="0.01" required>
                            </div>
                            <div class="form-group half-width">
                                <label for="editSalaryType">Salary Type</label>
                                <select id="editSalaryType" name="editSalaryType">
                                    <option value="annual">Annual</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="hourly">Hourly</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editStartDate">Start Date</label>
                                <input type="date" id="editStartDate" name="editStartDate">
                            </div>
                            <div class="form-group half-width">
                                <label for="editOfferExpiryDate">Offer Expiry Date *</label>
                                <input type="date" id="editOfferExpiryDate" name="editOfferExpiryDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editProbationPeriod">Probation Period (months)</label>
                                <select id="editProbationPeriod" name="editProbationPeriod">
                                    <option value="">No Probation</option>
                                    <option value="3">3 months</option>
                                    <option value="6">6 months</option>
                                    <option value="12">12 months</option>
                                </select>
                            </div>
                            <div class="form-group half-width">
                                <label for="editWorkSchedule">Work Schedule</label>
                                <select id="editWorkSchedule" name="editWorkSchedule">
                                    <option value="full-time">Full-time (40 hours/week)</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="flexible">Flexible Hours</option>
                                    <option value="shift">Shift Work</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Compensation Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-dollar-sign"></i> Compensation & Benefits</h3>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editBonus">Performance Bonus (%)</label>
                                <input type="number" id="editBonus" name="editBonus" placeholder="e.g., 10" min="0" max="100">
                            </div>
                            <div class="form-group half-width">
                                <label for="editCurrency">Currency</label>
                                <select id="editCurrency" name="editCurrency">
                                    <option value="USD">USD ($)</option>
                                    <option value="EUR">EUR ()</option>
                                    <option value="GBP">GBP ()</option>
                                    <option value="CAD">CAD ($)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editSigningBonus">Signing Bonus</label>
                                <input type="number" id="editSigningBonus" name="editSigningBonus" placeholder="e.g., 5000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editBenefits">Benefits</label>
                                <textarea id="editBenefits" name="editBenefits" rows="3" placeholder="List benefits (health insurance, retirement plan, vacation days, etc.)"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editSpecialTerms">Special Terms & Conditions</label>
                                <textarea id="editSpecialTerms" name="editSpecialTerms" rows="3" placeholder="Any special conditions, relocation assistance, training requirements, etc."></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editTermsConditions">Additional Terms & Conditions</label>
                                <textarea id="editTermsConditions" name="editTermsConditions" rows="4" placeholder="Additional terms and conditions"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Offer Status Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-chart-line"></i> Offer Status</h3>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="editOfferStatus">Status</label>
                                <select id="editOfferStatus" name="editOfferStatus">
                                    <option value="pending">Pending</option>
                                    <option value="sent">Sent</option>
                                    <option value="viewed">Viewed</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="declined">Declined</option>
                                    <option value="rescinded">Rescinded</option>
                                    <option value="expired">Expired</option>
                                </select>
                            </div>
                            <div class="form-group half-width">
                                <label for="editOfferNotes">Internal Notes</label>
                                <textarea id="editOfferNotes" name="editOfferNotes" rows="3" placeholder="Internal notes about this offer"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden field to store offer ID -->
                    <input type="hidden" id="editOfferId" name="editOfferId">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditOfferModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveOfferChanges()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" class="btn btn-success" onclick="previewUpdatedOffer()">
                    <i class="fas fa-eye"></i> Preview Offer Letter
                </button>
            </div>
        </div>
    </div>

    <!-- Other Modals (Schedule, Evaluation, Rank) are kept for structural similarity but would need significant adaptation or replacement for an Offer Management context -->
    <!-- Schedule Interview Modal (placeholder, might be "Schedule Offer Discussion Modal") -->
    <div id="scheduleModal" class="applicant-modal">
        </div>

    <!-- Interview Evaluation Modal (placeholder, might be "Offer Feedback Modal") -->
    <div id="evaluationModal" class="applicant-modal">
        </div>

    <!-- Evaluation Rank Modal (placeholder, might be "Offer Comparison Modal") -->    <div id="evaluationRankModal" class="evaluation-rank-modal">
        </div>    <!-- Create New Offer Modal -->
    <div id="createOfferModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 90%;">
            <div class="modal-header">
                <h2><i class="fas fa-handshake"></i> Create New Offer</h2>
                <button class="close-btn" onclick="closeCreateOfferModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createOfferForm">
                    <!-- Template Selection Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-file-alt"></i> Offer Letter Template</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="offerTemplate">Select Template (Optional)</label>
                                <select id="offerTemplate" name="offerTemplate" onchange="handleTemplateSelection()">
                                    <option value="">Use Default Offer Letter</option>
                                    <!-- Templates will be populated dynamically -->
                                </select>
                                <div class="form-text">
                                    Choose a custom template from the Document Creator or use the default offer letter format.
                                </div>
                            </div>
                        </div>
                        <div id="templatePreview" class="template-preview-container" style="display: none;">
                            <div class="template-preview-header">
                                <h4><i class="fas fa-eye"></i> Template Preview</h4>
                                <button type="button" class="btn-link" onclick="clearTemplateSelection()">
                                    <i class="fas fa-times"></i> Clear Template
                                </button>
                            </div>
                            <div class="template-preview-content" id="templatePreviewContent">
                                <!-- Template preview will be shown here -->
                            </div>
                        </div>
                    </div>

                    <!-- Candidate Information Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-user"></i> Candidate Information</h3>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="candidateName">Candidate Name *</label>
                                <select id="candidateName" name="candidateName" required>
                                    <option value="">Select Candidate</option>
                                    <option value="john-doe">John Doe</option>
                                    <option value="jane-smith">Jane Smith</option>
                                    <option value="michael-johnson">Michael Johnson</option>
                                    <option value="sarah-wilson">Sarah Wilson</option>
                                </select>
                            </div>
                            <div class="form-group half-width">
                                <label for="candidateEmail">Email</label>
                                <input type="email" id="candidateEmail" name="candidateEmail" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="candidatePhone">Phone</label>
                                <input type="tel" id="candidatePhone" name="candidatePhone" readonly>
                            </div>
                            <div class="form-group half-width">
                                <label for="candidateAddress">Address</label>
                                <input type="text" id="candidateAddress" name="candidateAddress" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Job Information Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-briefcase"></i> Job Information</h3>                        <div class="form-row">                            <div class="form-group half-width">
                                <label for="jobTitle">Job Title *</label>
                                <select id="jobTitle" name="jobTitle" required>
                                    <option value="">Select Job Title</option>
                                </select>
                            </div>
                            <div class="form-group half-width">
                                <label for="department">Department</label>
                                <input type="text" id="department" name="department" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="location">Work Location</label>
                                <input type="text" id="location" name="location" readonly>
                            </div>
                            <div class="form-group half-width">
                                <label for="employmentType">Employment Type</label>
                                <input type="text" id="employmentType" name="employmentType" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Offer Details Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-file-contract"></i> Offer Details</h3>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="startDate">Start Date *</label>
                                <input type="date" id="startDate" name="startDate" required>
                            </div>
                            <div class="form-group half-width">
                                <label for="offerExpiryDate">Offer Expiry Date *</label>
                                <input type="date" id="offerExpiryDate" name="offerExpiryDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="probationPeriod">Probation Period (months)</label>
                                <select id="probationPeriod" name="probationPeriod">
                                    <option value="">No Probation</option>
                                    <option value="3">3 months</option>
                                    <option value="6">6 months</option>
                                    <option value="12">12 months</option>
                                </select>
                            </div>
                            <div class="form-group half-width">
                                <label for="workSchedule">Work Schedule</label>
                                <select id="workSchedule" name="workSchedule">
                                    <option value="full-time">Full-time (40 hours/week)</option>
                                    <option value="part-time">Part-time</option>
                                    <option value="flexible">Flexible Hours</option>
                                    <option value="shift">Shift Work</option>
                                </select>
                            </div>
                        </div>
                    </div>                    <!-- Compensation Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-dollar-sign"></i> Compensation & Benefits</h3>
                        <div class="form-row">                            <div class="form-group half-width">
                                <label for="baseSalary">Base Salary (Annual) *</label>
                                <select id="baseSalary" name="baseSalary" required>
                                    <option value="">Select Salary Level</option>
                                    <option value="min">Min Salary</option>
                                    <option value="mid">Mid Salary</option>
                                    <option value="max">Max Salary</option>
                                </select>
                                <div id="salaryDisplay" class="salary-display" style="margin-top: 0.5rem; font-weight: 600; color: #28a745;"></div>
                            </div>
                            <div class="form-group half-width">
                                <label for="salary">Salary Amount *</label>
                                <input type="text" id="salary" name="salary" readonly 
                                       style="background-color: #f8f9fa; border: 1px solid #dee2e6; color: #495057; font-weight: 600;"
                                       placeholder="Select base salary level first">
                            </div>
                        </div>                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="bonus">Performance Bonus (%)</label>
                                <input type="number" id="bonus" name="bonus" placeholder="e.g., 10" min="0" max="100">
                            </div>
                            <div class="form-group half-width">
                                <label for="currency">Currency</label>
                                <select id="currency" name="currency">
                                    <option value="USD">USD ($)</option>
                                    <option value="EUR">EUR ()</option>
                                    <option value="GBP">GBP ()</option>
                                    <option value="CAD">CAD ($)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label for="signingBonus">Signing Bonus</label>
                                <input type="number" id="signingBonus" name="signingBonus" placeholder="e.g., 5000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="benefits">Benefits Package</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="benefits" value="health-insurance"> Health Insurance
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="benefits" value="dental"> Dental Coverage
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="benefits" value="vision"> Vision Coverage
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="benefits" value="retirement"> 401(k) / Retirement Plan
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="benefits" value="pto"> Paid Time Off
                                    </label>
                                    <label class="checkbox-item">
                                        <input type="checkbox" name="benefits" value="flexible-work"> Flexible Work Arrangements
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Terms Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-clipboard-list"></i> Additional Terms</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="specialTerms">Special Terms & Conditions</label>
                                <textarea id="specialTerms" name="specialTerms" rows="3" placeholder="Any special conditions, relocation assistance, training requirements, etc."></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="internalNotes">Internal Notes</label>
                                <textarea id="internalNotes" name="internalNotes" rows="2" placeholder="Notes for internal use only (not visible to candidate)"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-paper-plane"></i> Actions</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary" onclick="createAndSendOffer()">
                                        <i class="fas fa-paper-plane"></i> Submit for Approval
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="saveOfferAsDraft()">
                                        <i class="fas fa-save"></i> Save as Draft
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="previewOffer()">
                                        <i class="fas fa-eye"></i> Preview
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeCreateOfferModal()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Offer Letter Preview Modal -->
    <div id="offerPreviewModal" class="offer-preview-modal">
        <div class="offer-preview-content">
            <div class="offer-preview-header">
                <h3 class="offer-preview-title">
                    <i class="fas fa-file-contract"></i>
                    Offer Letter Preview
                </h3>
                <button class="close-offer-preview" onclick="closeOfferPreview()">&times;</button>
            </div>            <div class="offer-preview-body">
                <div class="offer-letter-content" id="offerLetterContent">
                    <!-- Offer letter content will be dynamically generated here -->
                </div>
                
                <!-- Approval Flow Section -->
                <div class="approval-flow-section" id="approvalFlowSection">
                    <div class="approval-flow-header">
                        <i class="fas fa-tasks"></i>
                        <span>Approval Flow</span>
                    </div>
                    <div id="approvalFlowContent">
                        <div class="approval-loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading approval flow...
                        </div>
                    </div>
                </div>
            </div>
            <div class="offer-preview-actions">
                <div class="real-time-indicator">
                    <div class="pulse-dot"></div>
                    <span>Real-time preview</span>
                </div>
            </div>
            <div class="preview-action-buttons">
                <!-- Action buttons will be dynamically populated based on offer status -->
                <button class="btn btn-secondary" onclick="closeOfferPreview()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar Menu (structure reused) -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    <!-- Risk Management (separate section) -->
<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
<ul class="submenu">
<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
<li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
</ul>
</li></ul>
                </li>
                    <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    	<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    	<ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                    	</ul>
                    </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management_view">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading_view"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer_view"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading_view"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis_view"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                            <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution_view"><a href="fueldist.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis_view"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report_view"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
						<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
</ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation (reused) -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                <div class="user-profile" style="position:relative;">
                    <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                    <div class="profile-dropdown"><ul></ul></div>
                </div>
                </div>
            </header>
            <!-- Page Content -->
            <div class="content">
                <div class="interview-container"> <!-- Class name kept for CSS consistency -->
                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-top-row">
                            <div class="header-left">
                                <h1 class="page-title">
                                    <i class="fas fa-file-signature"></i>
                                    Offer Management
                                </h1>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-number" id="totalOffers">0</div>
                            <div>Total Offers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pendingOffers">0</div>
                            <div>Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="acceptedOffers">0</div>
                            <div>Accepted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="declinedOffers">0</div>
                            <div>Declined</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="expiredOffers">0</div>
                            <div>Expired</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="archivedOffersCount">0</div>
                            <div>Archived</div>
                        </div>
                    </div>

                    <!-- Content Tabs Layout -->
                    <div class="content-tabs">
                        <!-- Tab Navigation -->
                        <div class="tab-navigation">
                            <button class="tab-nav-btn active" id="pendingOffersTabBtn" onclick="switchToTab('pendingOffers')">
                                <i class="fas fa-hourglass-half"></i>
                                Pending & Approved Offers
                            </button>
                            <button class="tab-nav-btn" id="acceptedOffersTabBtn" onclick="switchToTab('acceptedOffers')">
                                <i class="fas fa-check-circle"></i>
                                Accepted Offers
                            </button>
                            <button class="tab-nav-btn" id="declinedOffersTabBtn" onclick="switchToTab('declinedOffers')">
                                <i class="fas fa-times-circle"></i>
                                Declined Offers
                            </button>
                            <button class="tab-nav-btn" id="archivedOffersTabBtn" onclick="switchToTab('archivedOffers')">
                                <i class="fas fa-archive"></i>
                                Archived Offers
                            </button>
                        </div>

                        <!-- Pending Offers Tab Content -->
                        <div class="tab-content active" id="pendingOffersTabContent">
                            <div class="tab-controls">
                                <div class="search-export-row">
                                    <div class="search-wrapper">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="pendingOffersSearchInput" placeholder="Search by candidate, job title...">
                                    </div>
                                    <div>
                                        <button class="btn btn-primary" id="createNewOfferBtn" onclick="(async () => await openCreateOfferModal())()"> <!-- Async wrapper for modal opening -->
                                            <i class="fas fa-plus"></i> Create New Offer
                                        </button>
                                        <button class="btn btn-secondary" id="exportPendingOffersBtn" style="margin-left: 0.5rem;">
                                            <i class="fas fa-download"></i> Export Pending
                                        </button>
                                    </div>
                                </div>
                            </div>                            <div class="candidates-table-container">
                                <div class="loading-state" id="pendingOffersLoadingState">
                                    <div class="spinner"></div>
                                    <p>Loading pending offers...</p>
                                </div>
                                <table class="candidates-table" id="pendingOffersTable" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Candidate Name</th>
                                            <th>Job Title</th>
                                            <th>Offer Date</th>
                                            <th>Offered Salary</th>
                                            <th>Expiry Date</th>
                                            <th>Status</th>
                                            <th>Offer Document</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendingOffersTableBody">
                                        <!-- Pending offers will be populated here -->
                                    </tbody>
                                </table>
                                <div class="empty-state d-none" id="pendingOffersEmptyState">
                                    <i class="fas fa-hourglass-half"></i>
                                    <h3>No Pending or Approved Offers Found</h3>
                                    <p>There are currently no pending or approved offers matching your criteria.</p>
                                </div>
                                <div class="pagination d-none" id="pendingOffersPagination">
                                    </div>
                            </div>
                        </div>

                        <!-- Accepted Offers Tab Content -->
                        <div class="tab-content" id="acceptedOffersTabContent">
                            <div class="tab-controls">
                                <div class="search-export-row">
                                     <div class="search-wrapper">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="acceptedOffersSearchInput" placeholder="Search accepted offers...">
                                    </div>
                                    <button class="btn btn-primary" id="exportAcceptedOffersBtn">
                                        <i class="fas fa-download"></i> Export Accepted
                                    </button>
                                </div>                            </div>
                            <div class="candidates-table-container">
                                <div class="loading-state" id="acceptedOffersLoadingState" style="display:none;">
                                    <div class="spinner"></div>
                                    <p>Loading accepted offers...</p>
                                </div>
                                <table class="candidates-table" id="acceptedOffersTable" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Candidate</th>
                                            <th>Job Title</th>
                                            <th>Offer Date</th>
                                            <th>Accepted Date</th>
                                            <th>Status</th>
                                            <th>Offer Document</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="acceptedOffersTableBody">
                                        <!-- Accepted offers will be populated here -->
                                    </tbody>
                                </table>
                                <div class="no-applicants" id="acceptedOffersEmptyState" style="display: block;"> <!-- Reusing .no-applicants -->
                                    <i class="fas fa-check-circle"></i>
                                    <h3>No Accepted Offers</h3>
                                    <p>No offers have been accepted yet.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Declined Offers Tab Content -->
                        <div class="tab-content" id="declinedOffersTabContent">
                            <div class="tab-controls">
                                 <div class="search-export-row">
                                     <div class="search-wrapper">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="declinedOffersSearchInput" placeholder="Search declined offers...">
                                    </div>
                                    <button class="btn btn-primary" id="exportDeclinedOffersBtn">
                                        <i class="fas fa-download"></i> Export Declined
                                    </button>
                                </div>                            </div>
                            <div class="candidates-table-container">
                                <div class="loading-state" id="declinedOffersLoadingState" style="display:none;">
                                    <div class="spinner"></div>
                                    <p>Loading declined offers...</p>
                                </div>
                                <table class="candidates-table" id="declinedOffersTable" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Candidate Name</th>
                                            <th>Job Title</th>
                                            <th>Decline Date</th>
                                            <th>Reason (if provided)</th>
                                            <th>Offer Document</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="declinedOffersTableBody">
                                        <!-- Declined offers will be populated here -->
                                    </tbody>
                                </table>
                                <div id="declinedOffersEmptyState" class="empty-state" style="display: block;">
                                    <i class="fas fa-times-circle"></i>
                                    <h3>No Declined Offers</h3>
                                    <p>No offers have been declined yet.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Archived Offers Tab Content -->
                        <div class="tab-content" id="archivedOffersTabContent">
                            <div id="archivedOffersLoadingState" class="loading-container" style="display:none;">
                                <div class="loading-spinner"></div>
                                <h3>Loading archived offers...</h3>
                            </div>
                            <div id="archivedOffersErrorState" class="error-container" style="display: none;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Error loading archived offers</strong>
                                    <p id="archivedOffersErrorMessage">Unable to connect to Firebase database</p>
                                </div>
                            </div>
                            <div id="archivedOffersContainer" class="candidates-table-container" style="display: none;">
                                <div class="table-header">
                                    <h2 class="table-title">Archived Offers</h2>
                                    <button id="refreshArchivedOffersBtn" class="refresh-btn">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                                <table class="candidates-table" id="archivedOffersTable">
                                    <thead>
                                        <tr>
                                            <th>Candidate Name</th>
                                            <th>Job Title</th>
                                            <th>Offer Date</th>
                                            <th>Final Status</th>
                                            <th>Date Archived</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archivedOffersTableBody">
                                        <!-- Archived offers will be populated here -->
                                    </tbody>
                                </table>
                                <div id="archivedOffersEmptyState" class="empty-state" style="display: none;">
                                    <i class="fas fa-archive"></i>
                                    <h3>No Archived Offers Found</h3>
                                    <p>No offers have been archived yet.</p>
                                </div>
                                <div class="last-updated">
                                    Last updated: <span id="archivedOffersLastUpdated">Never</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase Scripts (reused) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>    <!-- Email Service (reused) -->
    <script type="module">
        // This would need to be adapted or a new service for offer emails
        // import { emailNotificationService } from './js/email-service.js';
        // window.emailNotificationService = emailNotificationService;
    </script>

    <!-- Offer Management Functions -->
    <script src="js/offer-management.js"></script>

    <script>
        // Firebase Configuration (reused)
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase (reused)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const storage = firebase.storage();
        
        // Email Notification System Integration
        // =====================================
        
        /**
         * Send template-based notification email
         * @param {string} templateType - Template type (e.g., 'offer')
         * @param {Object} data - Template data for variable replacement
         * @param {string|Array} recipients - Email recipient(s)
         * @param {Object} context - Additional context for notification rules
         * @returns {Promise<Object>} Result of email sending operation
         */
        async function sendTemplateNotification(templateType, data, recipients, context = {}) {
            try {
                console.log(`?? Attempting to send notification for template: ${templateType}`);
                
                // Prepare recipients array
                let recipientList = Array.isArray(recipients) ? recipients : [recipients];
                console.log(`?? Recipients:`, recipientList);
                
                // Get current company context
                let companyId = null;
                if (window.currentUser && window.currentUser.companyId) {
                    companyId = window.currentUser.companyId;
                } else if (window.companyContext) {
                    companyId = window.companyContext;
                } else {
                    const storedCompanyId = localStorage.getItem('companyId');
                    if (storedCompanyId) {
                        companyId = storedCompanyId;
                    }
                }
                
                if (!companyId) {
                    throw new Error('Company context required for sending notifications');
                }
                
                // Get SMTP configuration from Firebase
                const smtpSnapshot = await database.ref(`companies/${companyId}/smtp-config`).once('value');
                const smtpConfig = smtpSnapshot.val();
                
                if (!smtpConfig || !smtpConfig.host) {
                    throw new Error('SMTP configuration not found. Please configure SMTP settings first.');
                }
                
                // Get email template from Firebase
                const templateSnapshot = await database.ref(`companies/${companyId}/email-templates/${templateType}`).once('value');
                let template = templateSnapshot.val();
                
                if (!template) {
                    // Fallback to default template
                    template = getDefaultTemplate(templateType);
                    if (!template) {
                        throw new Error(`Template '${templateType}' not found and no default available`);
                    }
                }
                
                // Replace template variables with actual data
                let subject = template.subject || 'Notification';
                let body = template.content || template.body || '';
                
                // Replace variables in subject and body
                Object.keys(data).forEach(key => {
                    const value = data[key] || '';
                    const regex = new RegExp(`{{${key}}}`, 'g');
                    subject = subject.replace(regex, value);
                    body = body.replace(regex, value);
                });
                
                // Queue email for sending
                const emailData = {
                    to: recipientList,
                    subject: subject,
                    html: body,
                    templateType: templateType,
                    companyId: companyId,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending',
                    data: data
                };
                
                // Add to email queue
                const queueRef = database.ref(`companies/${companyId}/emailQueue`).push();
                await queueRef.set(emailData);
                
                console.log(`?? Email queued successfully for template: ${templateType}`);
                
                return {
                    success: true,
                    templateType: templateType,
                    recipientCount: recipientList.length,
                    queueId: queueRef.key
                };
                
            } catch (error) {
                console.error(`? Error sending template notification (${templateType}):`, error);
                return {
                    success: false,
                    templateType: templateType,
                    error: error.message
                };
            }
        }
        
        /**
         * Get default template for a given template type
         * @param {string} templateType - Template type
         * @returns {Object|null} Default template object or null
         */
        function getDefaultTemplate(templateType) {
            const templates = {
                'offer': {
                    subject: 'Job Offer - {{positionTitle}} - {{companyName}}',
                    content: `
                        <h2>Congratulations! Job Offer</h2>
                        <p>Dear {{candidateName}},</p>
                        <p>We are pleased to extend you an official job offer for the position of <strong>{{positionTitle}}</strong> at {{companyName}}.</p>
                        <h3>Position Details:</h3>
                        <ul>
                            <li><strong>Position:</strong> {{positionTitle}}</li>
                            <li><strong>Department:</strong> {{department}}</li>
                            <li><strong>Start Date:</strong> {{startDate}}</li>
                            <li><strong>Salary:</strong> {{annualSalary}}</li>
                            <li><strong>Work Location:</strong> {{workLocation}}</li>
                        </ul>
                        <p>Please review the attached offer letter for complete details. To accept this offer, please respond by {{responseDeadline}}.</p>
                        <p>We look forward to welcoming you to our team!</p>
                        <p>Best regards,<br>{{hiringManager}}<br>{{companyName}}</p>
                    `
                }
            };
            
            return templates[templateType] || null;
        }
        
        /**
         * Send job offer notification to candidate
         * @param {Object} offerData - Complete offer data
         * @param {string} candidateEmail - Candidate's email address
         * @returns {Promise<Object>} Result of notification sending
         */
        async function sendJobOfferNotification(offerData, candidateEmail) {
            try {
                console.log('?? Sending job offer notification to:', candidateEmail);
                
                // Use direct email service with job offer template
                const emailServiceUrl = 'http://localhost:3001';
                const apiKey = 'dreemex_hse_email_service_2025';
                
                // Test email service connection first
                console.log('?? Testing email service connection...');
                try {
                    const testResponse = await fetch(`${emailServiceUrl}/health`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!testResponse.ok) {
                        throw new Error(`Email service not available (HTTP ${testResponse.status}). Please ensure the email service is running on port 3001.`);
                    }
                    
                    const healthData = await testResponse.json();
                    console.log('?? Email service health check:', healthData);
                } catch (connectionError) {
                    console.error('?? Email service connection test failed:', connectionError);
                    throw new Error(`Email service connection failed: ${connectionError.message}`);
                }
                
                // Prepare job offer email with proper template from mailnotif.html
                const offerTemplate = {
                    subject: 'Job Offer - {{positionTitle}} - {{companyName}}',
                    body: `================================================================================
                           DREAMEX DATALAB HSE SYSTEM
                               OFFICIAL JOB OFFER LETTER
================================================================================

Dear {{candidateName}},

Congratulations! We are pleased to extend you an official job offer for the position of {{positionTitle}} at {{companyName}}.

PERSONAL INFORMATION:
--------------------------------------------------------------------------------
Candidate Name       : {{candidateName}}
Email Address        : {{candidateEmail}}
Phone Number         : {{candidatePhone}}
Application ID       : {{applicationId}}
Interview Date       : {{interviewDate}}
Interview Score      : {{interviewScore}}

POSITION DETAILS:
--------------------------------------------------------------------------------
Job Title            : {{positionTitle}}
Department           : {{department}}
Division             : {{division}}
Reports To           : {{reportsTo}}
Work Location        : {{workLocation}}
Employment Type      : {{employmentType}}
Contract Duration    : {{contractDuration}}
Start Date           : {{startDate}}
Working Hours        : {{workingHours}} hours per week

COMPENSATION PACKAGE:
--------------------------------------------------------------------------------
Base Salary          : {{baseSalary}}
Annual Salary        : {{annualSalary}}
Payment Frequency    : {{paymentFrequency}}
Currency             : {{currency}}
Bonus Eligibility    : {{bonusEligibility}}
Commission Structure : {{commissionStructure}}
Salary Review Date   : {{salaryReviewDate}}

BENEFITS PACKAGE:
--------------------------------------------------------------------------------
Health Insurance     : {{healthInsurance}}
Dental Coverage      : {{dentalCoverage}}
Vision Coverage      : {{visionCoverage}}
Life Insurance       : {{lifeInsurance}}
Retirement Plan      : {{retirementPlan}}
Paid Time Off        : {{paidTimeOff}} days annually
Sick Leave           : {{sickLeave}} days annually
Holiday Schedule     : {{holidaySchedule}}
Professional Development : {{professionalDevelopment}}

WORKING ARRANGEMENTS:
--------------------------------------------------------------------------------
Remote Work Policy   : {{remoteWorkPolicy}}
Flexible Hours       : {{flexibleHours}}
Office Location      : {{officeLocation}}
Parking              : {{parkingArrangement}}
Equipment Provided   : {{equipmentProvided}}
Software Access      : {{softwareAccess}}
Company Phone        : {{companyPhone}}

JOB RESPONSIBILITIES:
--------------------------------------------------------------------------------
Primary Duties       : {{primaryDuties}}
Key Performance Indicators : {{kpiMetrics}}
Success Metrics      : {{successMetrics}}
Training Program     : {{trainingProgram}}
Probation Period     : {{probationPeriod}}
Performance Reviews  : {{performanceReviews}}

COMPANY POLICIES:
--------------------------------------------------------------------------------
Code of Conduct      : Mandatory compliance required
Confidentiality      : Non-disclosure agreement included
Non-Compete Clause   : {{nonCompeteClause}}
Intellectual Property: {{intellectualProperty}}
Social Media Policy  : {{socialMediaPolicy}}
Travel Requirements  : {{travelRequirements}}

ONBOARDING PROCESS:
--------------------------------------------------------------------------------
Orientation Date     : {{orientationDate}}
Document Requirements: {{documentRequirements}}
Background Check     : {{backgroundCheck}}
Drug Testing         : {{drugTesting}}
Security Clearance   : {{securityClearance}}
First Day Instructions: {{firstDayInstructions}}

OFFER CONDITIONS:
--------------------------------------------------------------------------------
Valid Until          : {{offerExpirationDate}}
Contingent Upon       : {{contingencies}}
References Required   : {{referencesRequired}}
Medical Examination   : {{medicalExamination}}
Educational Verification : {{educationVerification}}

ACCEPTANCE INSTRUCTIONS:
--------------------------------------------------------------------------------
To accept this offer, please:

1. Sign and date the attached employment agreement
2. Complete the acceptance form at: {{acceptanceLink}}
3. Return signed documents by: {{responseDeadline}}
4. Provide required documentation as listed above
5. Confirm your start date availability

You can also accept this offer by clicking: {{acceptOfferLink}}

CONTACT INFORMATION:
--------------------------------------------------------------------------------
HR Representative    : {{hrRepresentative}}
Direct Phone         : {{hrPhone}}
Email                : {{hrEmail}}
Hiring Manager       : {{hiringManager}}
Manager Email        : {{managerEmail}}
Department Head      : {{departmentHead}}

IMPORTANT NOTES:
--------------------------------------------------------------------------------
 This offer is contingent upon successful completion of all pre-employment
  requirements including background checks and reference verification
 Employment is at-will and may be terminated by either party with notice
 Full terms and conditions are detailed in the employment agreement
 This offer supersedes any previous verbal or written communications
 Please review all documents carefully before acceptance

NEXT STEPS:
--------------------------------------------------------------------------------
1. Review this offer and all attached documents thoroughly
2. Discuss with family/advisors if needed
3. Prepare required documentation for submission
4. Sign and return acceptance within the specified timeframe
5. Prepare for your first day and orientation program

We are excited about the possibility of you joining our team and contributing
to our continued success. Your skills and experience make you an excellent
fit for this position, and we look forward to working with you.

If you have any questions about this offer or need clarification on any
terms, please don't hesitate to contact our HR team.

Welcome to the Dreamex Datalab family!

Best regards,

{{hiringManagerName}}
{{hiringManagerTitle}}
{{companyName}}

{{hrRepresentativeName}}
Human Resources Department
{{companyName}}

================================================================================
This is an official job offer. Please retain this document for your records.
Offer ID: {{offerId}} | Generated: {{generationTimestamp}}
================================================================================`
                };

                // Prepare template data with actual offer values
                const templateData = {
                    candidateName: offerData.candidateName || 'Candidate',
                    candidateEmail: candidateEmail,
                    candidatePhone: offerData.candidatePhone || 'Not provided',
                    applicationId: offerData.applicationId || offerData.id || 'N/A',
                    interviewDate: offerData.interviewDate || 'N/A',
                    interviewScore: offerData.interviewScore || 'N/A',
                    positionTitle: offerData.positionTitle || offerData.jobTitle || 'Position',
                    department: offerData.department || 'General',
                    division: offerData.division || offerData.department || 'General',
                    reportsTo: offerData.reportsTo || offerData.hiringManagerName || 'Hiring Manager',
                    workLocation: offerData.workLocation || offerData.location || 'Office',
                    employmentType: offerData.employmentType || 'Full-time',
                    contractDuration: offerData.contractDuration || 'Permanent',
                    startDate: offerData.startDate || 'To be determined',
                    workingHours: offerData.workingHours || '40',
                    baseSalary: offerData.baseSalary || offerData.salary || 'To be discussed',
                    annualSalary: offerData.annualSalary || offerData.salary || 'To be discussed',
                    paymentFrequency: offerData.paymentFrequency || 'Monthly',
                    currency: offerData.currency || 'USD',
                    bonusEligibility: offerData.bonusEligibility || 'Standard company bonus structure',
                    commissionStructure: offerData.commissionStructure || 'Not applicable',
                    salaryReviewDate: offerData.salaryReviewDate || 'Annually',
                    healthInsurance: offerData.healthInsurance || 'Comprehensive health coverage',
                    dentalCoverage: offerData.dentalCoverage || 'Full dental coverage',
                    visionCoverage: offerData.visionCoverage || 'Vision care included',
                    lifeInsurance: offerData.lifeInsurance || 'Company-provided life insurance',
                    retirementPlan: offerData.retirementPlan || 'Company retirement plan',
                    paidTimeOff: offerData.paidTimeOff || '20',
                    sickLeave: offerData.sickLeave || '10',
                    holidaySchedule: offerData.holidaySchedule || 'Standard company holidays',
                    professionalDevelopment: offerData.professionalDevelopment || 'Annual training allowance',
                    remoteWorkPolicy: offerData.remoteWorkPolicy || 'Hybrid work options available',
                    flexibleHours: offerData.flexibleHours || 'Flexible scheduling available',
                    officeLocation: offerData.officeLocation || 'Main office',
                    parkingArrangement: offerData.parkingArrangement || 'Parking available',
                    equipmentProvided: offerData.equipmentProvided || 'Laptop and necessary equipment',
                    softwareAccess: offerData.softwareAccess || 'All required software licenses',
                    companyPhone: offerData.companyPhone || 'Available upon request',
                    primaryDuties: offerData.primaryDuties || offerData.jobDescription || 'As discussed during interview',
                    kpiMetrics: offerData.kpiMetrics || 'Performance metrics to be established',
                    successMetrics: offerData.successMetrics || 'Goal achievement and team contribution',
                    trainingProgram: offerData.trainingProgram || 'Comprehensive onboarding program',
                    probationPeriod: offerData.probationPeriod || '90 days',
                    performanceReviews: offerData.performanceReviews || 'Quarterly and annual reviews',
                    nonCompeteClause: offerData.nonCompeteClause || 'Standard non-compete agreement',
                    intellectualProperty: offerData.intellectualProperty || 'Company IP policy applies',
                    socialMediaPolicy: offerData.socialMediaPolicy || 'Professional social media guidelines',
                    travelRequirements: offerData.travelRequirements || 'Minimal travel required',
                    orientationDate: offerData.orientationDate || 'First day of employment',
                    documentRequirements: offerData.documentRequirements || 'ID, tax forms, banking information',
                    backgroundCheck: offerData.backgroundCheck || 'Standard background verification',
                    drugTesting: offerData.drugTesting || 'Pre-employment screening',
                    securityClearance: offerData.securityClearance || 'Not required',
                    firstDayInstructions: offerData.firstDayInstructions || 'Report to HR at 9:00 AM',
                    offerExpirationDate: offerData.offerExpirationDate || new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString(),
                    contingencies: offerData.contingencies || 'Background check and reference verification',
                    referencesRequired: offerData.referencesRequired || '3 professional references',
                    medicalExamination: offerData.medicalExamination || 'Not required',
                    educationVerification: offerData.educationVerification || 'Degree verification required',
                    acceptanceLink: `${window.location.origin}/offer.html?action=accept&id=${offerData.id}`,
                    responseDeadline: offerData.responseDeadline || new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString(),
                    acceptOfferLink: `${window.location.origin}/offer.html?action=accept&id=${offerData.id}`,
                    hrRepresentative: offerData.hrRepresentativeName || 'HR Department',
                    hrPhone: offerData.hrPhone || 'Contact HR',
                    hrEmail: offerData.hrEmail || 'hr@dreamexdatalab.com',
                    hiringManager: offerData.hiringManagerName || 'Hiring Manager',
                    managerEmail: offerData.managerEmail || 'manager@dreamexdatalab.com',
                    departmentHead: offerData.departmentHead || 'Department Head',
                    hiringManagerName: offerData.hiringManagerName || 'Hiring Manager',
                    hiringManagerTitle: offerData.hiringManagerTitle || 'Hiring Manager',
                    companyName: offerData.companyName || 'Dreamex Datalab HSE',
                    hrRepresentativeName: offerData.hrRepresentativeName || 'HR Department',
                    offerId: offerData.id || `OFFER-${Date.now()}`,
                    generationTimestamp: new Date().toLocaleString()
                };

                // Replace template variables
                let subject = offerTemplate.subject;
                let body = offerTemplate.body;

                Object.keys(templateData).forEach(key => {
                    const regex = new RegExp(`{{${key}}}`, 'g');
                    subject = subject.replace(regex, templateData[key] || 'N/A');
                    body = body.replace(regex, templateData[key] || 'N/A');
                });

                // Prepare email data for sending
                const emailData = {
                    to: candidateEmail,
                    subject: subject,
                    text: body,
                    html: body.replace(/\n/g, '<br>'),
                    priority: 'high'
                };

                console.log('?? Sending job offer email with template:', emailData);

                const response = await fetch(`${emailServiceUrl}/send/job-offer`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(emailData)
                });

                console.log('?? Email service HTTP status:', response.status);

                let result;
                let responseText;
                try {
                    // Clone the response so we can read it multiple times if needed
                    const responseClone = response.clone();
                    result = await response.json();
                    console.log('?? Email service response:', result);
                } catch (parseError) {
                    console.error('?? Failed to parse email service response:', parseError);
                    try {
                        // Use the cloned response to get text
                        responseText = await response.text();
                        console.log('?? Raw response text:', responseText);
                    } catch (textError) {
                        console.error('?? Failed to read response as text:', textError);
                        responseText = 'Unable to read response';
                    }
                    throw new Error(`Email service returned invalid JSON. Status: ${response.status}, Response: ${responseText}`);
                }

                if (response.ok && result.success) {
                    console.log(`? Job offer notification sent successfully to ${candidateEmail}`);
                    return {
                        success: true,
                        message: 'Job offer notification sent to candidate',
                        recipient: candidateEmail,
                        messageId: result.messageId
                    };
                } else {
                    console.error(`? Failed to send job offer notification to ${candidateEmail}:`, result.error || result.message || 'Unknown error');
                    throw new Error(result.error || result.message || 'Failed to send job offer notification');
                }
                
            } catch (error) {
                console.error('? Error sending job offer notification:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Company context for offer management
        let companyContext = null;

        // Initialize company context
        async function initializeCompanyContext() {
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.warn('No authenticated user found for company context');
                    return;
                }

                // Try to get company context from user profile
                const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.companyId) {
                    companyContext = userData.companyId;
                    console.log('? Company context initialized:', companyContext);
                    
                    // Load company data if needed
                    const companySnapshot = await database.ref(`companies/${companyContext}`).once('value');
                    currentCompany = companySnapshot.val();
                } else {
                    // Fallback: try to get from localStorage or use default
                    const storedCompanyId = localStorage.getItem('currentCompanyId');
                    if (storedCompanyId) {
                        companyContext = storedCompanyId;
                        console.log('?? Using stored company context:', companyContext);
                    } else {
                        companyContext = 'default';
                        console.log('?? No company context found, using default');
                    }
                }
            } catch (error) {
                console.error('Error initializing company context:', error);
                companyContext = 'default';
            }
        }

        // DOM Elements for Offer Management (adapted from interview.html)
        const totalOffers = document.getElementById('totalOffers');
        const pendingOffers = document.getElementById('pendingOffers');
        const acceptedOffers = document.getElementById('acceptedOffers');
        const declinedOffers = document.getElementById('declinedOffers');
        const expiredOffers = document.getElementById('expiredOffers');
        const archivedOffersCount = document.getElementById('archivedOffersCount');

        // Pending Offers Tab Elements
        const pendingOffersLoadingState = document.getElementById('pendingOffersLoadingState');
        const pendingOffersTable = document.getElementById('pendingOffersTable');
        const pendingOffersTableBody = document.getElementById('pendingOffersTableBody');
        const pendingOffersEmptyState = document.getElementById('pendingOffersEmptyState');
        const pendingOffersPagination = document.getElementById('pendingOffersPagination');

        // Accepted Offers Tab Elements
        const acceptedOffersLoadingState = document.getElementById('acceptedOffersLoadingState');
        const acceptedOffersTable = document.getElementById('acceptedOffersTable');
        const acceptedOffersTableBody = document.getElementById('acceptedOffersTableBody');
        const acceptedOffersEmptyState = document.getElementById('acceptedOffersEmptyState');

        // Declined Offers Tab Elements
        const declinedOffersLoadingState = document.getElementById('declinedOffersLoadingState');
        const declinedOffersTable = document.getElementById('declinedOffersTable');
        const declinedOffersTableBody = document.getElementById('declinedOffersTableBody');
        const declinedOffersEmptyState = document.getElementById('declinedOffersEmptyState');

        // Archived Offers Tab Elements
        const archivedOffersLoadingState = document.getElementById('archivedOffersLoadingState');
        const archivedOffersTable = document.getElementById('archivedOffersTable');
        const archivedOffersTableBody = document.getElementById('archivedOffersTableBody');
        const archivedOffersEmptyState = document.getElementById('archivedOffersEmptyState');
        const archivedOffersLastUpdated = document.getElementById('archivedOffersLastUpdated');        // State for offers (example)
        let allOffersData = {}; // To store all offers
        let currentTab = 'pendingOffers'; // Default tab
        let hiredCandidatesData = {}; // To store hired candidates
        let salaryGradesData = {}; // To store salary grades from Firebase// Load hired candidates from Firebase (filtered by company scope)
        async function loadHiredCandidates() {
            try {
                console.log('Loading hired candidates from Firebase...');
                showCandidateDropdownLoading();
                
                // Check if user is authenticated and has company context
                if (!currentUser || !currentUser.companyId) {
                    console.log('No authenticated user or company context found');
                    const candidateSelect = document.getElementById('candidateName');
                    if (candidateSelect) {
                        candidateSelect.innerHTML = '<option value="">Please login to view candidates</option>';
                        candidateSelect.disabled = false;
                    }
                    return;
                }
                
                const companyId = currentUser.companyId;
                console.log(`Loading hired candidates for company: ${companyId}`);
                
                // Query hired candidates filtered by company
                const hiredRef = database.ref('hired');
                const snapshot = await hiredRef.once('value');
                
                if (snapshot.exists()) {
                    const allHiredCandidates = snapshot.val();
                    
                    // Filter candidates by company ID
                    hiredCandidatesData = {};
                    Object.entries(allHiredCandidates).forEach(([candidateId, candidate]) => {
                        if (candidate.companyId === companyId) {
                            hiredCandidatesData[candidateId] = candidate;
                        }
                    });
                    
                    console.log(`Hired candidates loaded for company ${companyId}:`, Object.keys(hiredCandidatesData).length);
                    populateCandidateDropdown();
                    enableCandidateDropdown();
                } else {
                    console.log('No hired candidates found in database');
                    hiredCandidatesData = {};
                    populateCandidateDropdown();
                    enableCandidateDropdown();
                }
            } catch (error) {
                console.error('Error loading hired candidates:', error);
                // Show error in dropdown
                const candidateSelect = document.getElementById('candidateName');
                if (candidateSelect) {
                    candidateSelect.innerHTML = '<option value="">Error loading candidates</option>';
                    candidateSelect.disabled = false;
                }
            }        }

        // Load salary grades from Firebase
        async function loadSalaryGrades() {
            try {
                console.log('Loading salary grades from Firebase...');
                
                // Ensure company context is available
                if (!companyContext) {
                    await initializeCompanyContext();
                }
                
                const companyPath = companyContext || 'default';
                
                // Load salary grades from company-specific path
                const snapshot = await database.ref(`companies/${companyPath}/salaryGrades`).once('value');
                salaryGradesData = snapshot.val() || {};
                console.log(`? Salary grades loaded for company ${companyPath}:`, salaryGradesData);
                return salaryGradesData;
            } catch (error) {
                console.error('Error loading salary grades:', error);
                return {};
            }
        }

        // Global variables for job postings and applications
        let jobPostingsData = {}; // To store published job positions
        let applicationsData = {}; // To store applications data

        // Load published job positions from Firebase (filtered by company scope)
        async function loadJobPostings() {
            try {
                console.log('Loading published job positions from Firebase...');
                
                // Check if user is authenticated and has company context
                if (!currentUser || !currentUser.companyId) {
                    console.log('No authenticated user or company context found for job postings');
                    return {};
                }
                
                const companyId = currentUser.companyId;
                console.log(`Loading job postings for company: ${companyId}`);
                
                // Query job postings from company-scoped path
                const jobsRef = database.ref(`companies/${companyId}/jobs`);
                const snapshot = await jobsRef.once('value');
                
                if (snapshot.exists()) {
                    const allJobs = snapshot.val();
                    
                    // Filter jobs by active/published status
                    jobPostingsData = {};
                    Object.entries(allJobs).forEach(([jobId, job]) => {
                        if (job.status === 'active' || job.status === 'published' || job.status === 'open') {
                            jobPostingsData[jobId] = job;
                        }
                    });
                    
                    console.log(`Job postings loaded for company ${companyId}:`, Object.keys(jobPostingsData).length);
                    return jobPostingsData;
                } else {
                    console.log('No job postings found in company scope');
                    
                    // Fallback: try global jobs path if company-scoped doesn't exist
                    console.log('Trying global jobs path as fallback...');
                    const globalJobsRef = database.ref('jobs');
                    const globalSnapshot = await globalJobsRef.once('value');
                    
                    if (globalSnapshot.exists()) {
                        const globalJobs = globalSnapshot.val();
                        
                        // Filter jobs by company ID and active status
                        jobPostingsData = {};
                        Object.entries(globalJobs).forEach(([jobId, job]) => {
                            if (job.companyId === companyId && (job.status === 'active' || job.status === 'published' || job.status === 'open')) {
                                jobPostingsData[jobId] = job;
                            }
                        });
                        
                        console.log(`Job postings loaded from global path for company ${companyId}:`, Object.keys(jobPostingsData).length);
                        return jobPostingsData;
                    } else {
                        console.log('No job postings found in global path either');
                        jobPostingsData = {};
                        return {};
                    }
                }
            } catch (error) {
                console.error('Error loading job postings:', error);
                return {};
            }
        }

        // Get application data by application ID from company-scoped path
        async function getApplicationData(applicationId) {
            try {
                if (!applicationId) {
                    console.log('No application ID provided');
                    return null;
                }
                
                // Check if user is authenticated and has company context
                if (!currentUser || !currentUser.companyId) {
                    console.log('No authenticated user or company context found for application data');
                    return null;
                }
                
                const companyId = currentUser.companyId;
                console.log(`Loading application data for ID: ${applicationId} from company: ${companyId}`);
                
                // Query application from company-scoped Firebase path
                const applicationRef = database.ref(`companies/${companyId}/applications/${applicationId}`);
                const snapshot = await applicationRef.once('value');
                
                if (snapshot.exists()) {
                    const applicationData = snapshot.val();
                    console.log('Application data loaded from company scope:', applicationData);
                    return applicationData;
                } else {
                    console.log(`No application found for ID: ${applicationId} in company ${companyId}`);
                    
                    // Fallback: try to find application in all applications under the company
                    console.log('Attempting to search all applications in company scope...');
                    const allApplicationsRef = database.ref(`companies/${companyId}/applications`);
                    const allSnapshot = await allApplicationsRef.once('value');
                    
                    if (allSnapshot.exists()) {
                        const allApplications = allSnapshot.val();
                        
                        // Search for application by ID
                        for (const [appId, appData] of Object.entries(allApplications)) {
                            if (appId === applicationId || appData.applicationId === applicationId) {
                                console.log(`Found application data via search:`, appData);
                                return appData;
                            }
                        }
                    }
                    
                    console.log(`Application ${applicationId} not found in company scope`);
                    return null;
                }
            } catch (error) {
                console.error('Error loading application data:', error);
                return null;
            }
        }

        // Populate job title dropdown with published positions
        function populateJobTitleFromPostings() {
            const jobTitleField = document.getElementById('job_title');
            if (!jobTitleField || !jobPostingsData) {
                console.log('Job title field not found or no job postings data available');
                return;
            }

            // Clear existing options except the default
            const defaultOption = jobTitleField.querySelector('option[value=""]');
            jobTitleField.innerHTML = '';
            if (defaultOption) {
                jobTitleField.appendChild(defaultOption);
            } else {
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'Select Job Title';
                jobTitleField.appendChild(emptyOption);
            }

            // Add options from published job postings
            const uniqueTitles = new Set();
            
            Object.values(jobPostingsData).forEach(job => {
                if (job.jobTitle && !uniqueTitles.has(job.jobTitle)) {
                    uniqueTitles.add(job.jobTitle);
                    
                    const option = document.createElement('option');
                    option.value = job.jobTitle;
                    option.textContent = job.jobTitle;
                    option.dataset.jobId = job.id || '';
                    option.dataset.department = job.department || '';
                    
                    jobTitleField.appendChild(option);
                }
            });

            console.log(`Added ${uniqueTitles.size} job titles from published positions`);
        }

        // Setup real-time listener for hired candidates (filtered by company scope)
        function setupHiredCandidatesListener() {
            const hiredRef = database.ref('hired');
            
            hiredRef.on('value', (snapshot) => {
                if (snapshot.exists() && currentUser && currentUser.companyId) {
                    const allHiredCandidates = snapshot.val();
                    const companyId = currentUser.companyId;
                    
                    // Filter candidates by company ID
                    hiredCandidatesData = {};
                    Object.entries(allHiredCandidates).forEach(([candidateId, candidate]) => {
                        if (candidate.companyId === companyId) {
                            hiredCandidatesData[candidateId] = candidate;
                        }
                    });
                    
                    console.log(`Hired candidates updated via real-time listener for company ${companyId}:`, Object.keys(hiredCandidatesData).length);
                    populateCandidateDropdown();
                    populateJobTitleDropdown();
                } else {
                    hiredCandidatesData = {};
                    populateCandidateDropdown();
                    populateJobTitleDropdown();
                }
            }, (error) => {
                console.error('Error in hired candidates real-time listener:', error);
            });
        }
        
        // Populate candidate dropdown with hired candidates (company-filtered)
        function populateCandidateDropdown() {
            const candidateSelect = document.getElementById('candidateName');
            if (!candidateSelect) return;

            // Clear existing options
            candidateSelect.innerHTML = '<option value="">Select Candidate</option>';

            // Check authentication and company context
            if (!currentUser || !currentUser.companyId) {
                candidateSelect.innerHTML = '<option value="">Please login to view candidates</option>';
                return;
            }

            if (!hiredCandidatesData || Object.keys(hiredCandidatesData).length === 0) {
                candidateSelect.innerHTML = '<option value="">No hired candidates in your company</option>';
                return;
            }

            // Add hired candidates to dropdown
            const candidateEntries = Object.entries(hiredCandidatesData);
              // Sort candidates by name for better UX
            candidateEntries.sort(([,a], [,b]) => {
                const nameA = a.fullName || `${a.firstName || ''} ${a.lastName || ''}`.trim() || 'Unknown';
                const nameB = b.fullName || `${b.firstName || ''} ${b.lastName || ''}`.trim() || 'Unknown';
                return nameA.localeCompare(nameB);
            });candidateEntries.forEach(([hiredId, candidate]) => {
                // Use fullName if available, otherwise construct from firstName/lastName
                const fullName = candidate.fullName || 
                                `${candidate.firstName || ''} ${candidate.lastName || ''}`.trim() || 
                                'Unknown Candidate';
                const position = candidate.position || candidate.jobTitle || 'Unknown Position';
                const hiredDate = candidate.hiredDate ? new Date(candidate.hiredDate).toLocaleDateString() : '';
                
                const option = document.createElement('option');
                option.value = hiredId;
                option.textContent = `${fullName} - ${position}${hiredDate ? ` (Hired: ${hiredDate})` : ''}`;
                option.dataset.candidateData = JSON.stringify(candidate);
                candidateSelect.appendChild(option);
            });

            console.log(`Populated dropdown with ${candidateEntries.length} hired candidates for company ${currentUser.companyId}`);
        }

        // Show loading state in candidate dropdown
        function showCandidateDropdownLoading() {
            const candidateSelect = document.getElementById('candidateName');
            if (candidateSelect) {
                candidateSelect.innerHTML = '<option value="">Loading hired candidates...</option>';
                candidateSelect.disabled = true;
            }
        }        // Enable candidate dropdown
        function enableCandidateDropdown() {
            const candidateSelect = document.getElementById('candidateName');
            if (candidateSelect) {
                candidateSelect.disabled = false;
            }
        }

        // Populate job title dropdown with unique job titles from hired candidates
        function populateJobTitleDropdown() {
            const jobTitleSelect = document.getElementById('jobTitle');
            if (!jobTitleSelect) return;

            // Clear existing options
            jobTitleSelect.innerHTML = '<option value="">Select Job Title</option>';

            if (!hiredCandidatesData || Object.keys(hiredCandidatesData).length === 0) {
                jobTitleSelect.innerHTML = '<option value="">No job titles available</option>';
                return;
            }

            // Extract unique job titles from hired candidates
            const jobTitles = new Set();
            Object.values(hiredCandidatesData).forEach(candidate => {
                const jobTitle = candidate.position || candidate.jobTitle;
                if (jobTitle && jobTitle.trim()) {
                    jobTitles.add(jobTitle.trim());
                }
            });

            // Sort job titles alphabetically
            const sortedJobTitles = Array.from(jobTitles).sort();

            // Add job titles to dropdown
            sortedJobTitles.forEach(jobTitle => {
                const option = document.createElement('option');
                option.value = jobTitle;
                option.textContent = jobTitle;
                jobTitleSelect.appendChild(option);
            });

            console.log(`Populated job title dropdown with ${sortedJobTitles.length} unique job titles`);
        }        // Initialize the page
        async function initializeOfferPage() {
            showLoadingState(currentTab);
            
            // Load hired candidates from Firebase
            await loadHiredCandidates();
            
            // Load published job postings from Firebase (for job title reference)
            await loadJobPostings();
            
            // Load salary grades from Firebase
            await loadSalaryGrades();
            
            // Setup real-time listener for hired candidates
            setupHiredCandidatesListener();
            
            // Don't load offers here - they will be loaded after authentication
            // in updateUIForAuthenticatedUser when currentUser.companyId is available
            console.log('? Offer loading deferred until authentication completes');
            
            initializeUserProfile(); // Reused from interview.html
            setupOfferFormListeners(); // Setup form auto-population listeners
        }

        function showLoadingState(tabName) {
            document.getElementById(`${tabName}LoadingState`).style.display = 'block';
            document.getElementById(`${tabName}Table`).style.display = 'none';
            document.getElementById(`${tabName}EmptyState`).classList.add('d-none');
            if(document.getElementById(`${tabName}Pagination`)) document.getElementById(`${tabName}Pagination`).classList.add('d-none');
        }

        function hideLoadingState(tabName) {
            document.getElementById(`${tabName}LoadingState`).style.display = 'none';
        }

        function showEmptyState(tabName, show = true) {
             const emptyStateEl = document.getElementById(`${tabName}EmptyState`);
             const tableEl = document.getElementById(`${tabName}Table`);
             if (show) {
                emptyStateEl.classList.remove('d-none');
                emptyStateEl.style.display = 'block'; // Ensure it's block if d-none was removed
                tableEl.style.display = 'none';
             } else {
                emptyStateEl.classList.add('d-none');
                emptyStateEl.style.display = 'none';
                tableEl.style.display = 'table';
             }
        }        // Tab switching functionality (adapted)
        function switchToTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.getElementById(`${tabName}TabBtn`).classList.add('active');
            document.getElementById(`${tabName}TabContent`).classList.add('active');

            // Load data for the selected tab
            if (tabName === 'pendingOffers') {
                loadPendingOffers();
            } else if (tabName === 'acceptedOffers') {
                loadAcceptedOffers();
            } else if (tabName === 'declinedOffers') {
                loadRejectedOffers();
            } else {
                // For other tabs, show loading then empty state
                showLoadingState(tabName);
                setTimeout(() => {
                    hideLoadingState(tabName);
                    showEmptyState(tabName, true);
                }, 500);
            }
        }

        // Placeholder for loading data functions
        // async function loadPendingOffers() { /* ... */ }
        // async function loadAcceptedOffers() { /* ... */ }
        // async function loadDeclinedOffers() { /* ... */ }
        // async function loadArchivedOffers() { /* ... */ }

        // Placeholder for rendering data functions
        // function renderPendingOffers(data) {
        //    pendingOffersTableBody.innerHTML = '';
        //    if (Object.keys(data).length === 0) {
        //        showEmptyState('pendingOffers', true); return;
        //    }
        //    showEmptyState('pendingOffers', false);
        //    Object.values(data).forEach(offer => { /* create row and append */ });
        //    // update pagination for pendingOffers
        // }        // Update offer statistics
        function updateOfferStats() {
            // Check if user has company context
            if (!currentUser || !currentUser.companyId) {
                console.log('No company context found for updating offer stats');
                // Set default values when no company context
                totalOffers.textContent = 0;
                pendingOffers.textContent = 0;
                acceptedOffers.textContent = 0;
                declinedOffers.textContent = 0;
                expiredOffers.textContent = 0;
                archivedOffersCount.textContent = 0;
                return;
            }
            
            const companyId = currentUser.companyId;
            
            // Get all offers from company-scoped Firebase path and count by status
            database.ref(`companies/${companyId}/offers`).once('value', (snapshot) => {
                const allOffers = snapshot.val() || {};
                
                let totalCount = 0;
                let pendingCount = 0;
                let acceptedCount = 0;
                let declinedCount = 0;
                let expiredCount = 0;
                let archivedCount = 0;
                
                Object.values(allOffers).forEach(offer => {
                    totalCount++;
                    
                    switch (offer.status) {
                        case 'pending':
                        case 'sent':
                        case 'viewed':
                        case 'draft': // Include draft offers in pending count
                        case 'submitted': // Include submitted offers in pending count
                        case 'approved': // Include approved offers in pending count
                            pendingCount++;
                            break;
                        case 'accepted':
                            acceptedCount++;
                            break;
                        case 'declined':
                        case 'rejected':
                            declinedCount++;
                            break;
                        case 'expired':
                            expiredCount++;
                            break;
                        case 'archived':
                            archivedCount++;
                            break;
                    }
                });
                
                // Update the UI
                totalOffers.textContent = totalCount;
                pendingOffers.textContent = pendingCount;
                acceptedOffers.textContent = acceptedCount;
                declinedOffers.textContent = declinedCount;
                expiredOffers.textContent = expiredCount;
                archivedOffersCount.textContent = archivedCount;
                
                console.log('Offer stats updated for company:', companyId, {
                    total: totalCount,
                    pending: pendingCount,
                    accepted: acceptedCount,
                    declined: declinedCount,
                    expired: expiredCount,
                    archived: archivedCount
                });
            }).catch((error) => {
                console.error('Error updating offer stats:', error);
                // Set default values on error
                totalOffers.textContent = 0;
                pendingOffers.textContent = 0;
                acceptedOffers.textContent = 0;
                declinedOffers.textContent = 0;
                expiredOffers.textContent = 0;
                archivedOffersCount.textContent = 0;
            });
        }
        
        // Function to populate job title dropdown from company scope
        async function populateJobTitlesDropdown() {
            const jobTitleSelect = document.getElementById('jobTitle');
            
            try {
                // Show loading state
                jobTitleSelect.innerHTML = '<option value="">Loading job titles...</option>';
                jobTitleSelect.disabled = true;
                
                // Ensure company context is available
                if (!companyContext) {
                    await initializeCompanyContext();
                }
                
                const companyPath = companyContext || 'default';
                
                // Try company-specific job titles first from job-title field options
                const companyJobTitlesSnapshot = await database.ref(`companies/${companyPath}/fieldOptions/job-title`).once('value');
                if (companyJobTitlesSnapshot.exists()) {
                    jobTitleSelect.innerHTML = '<option value="">Select Job Title</option>';
                    companyJobTitlesSnapshot.forEach(childSnapshot => {
                        const job = childSnapshot.val();
                        if (job.enabled !== false && job.label) {
                             const option = document.createElement('option');
                             option.value = job.label;
                             option.textContent = job.label;
                             jobTitleSelect.appendChild(option);
                        }
                    });
                    console.log(`? Loaded job titles for offer modal from company: ${companyPath} (job-title field options)`);
                } else {
                    // Fallback to user-role if job-title doesn't exist
                    const userRoleJobTitlesSnapshot = await database.ref(`companies/${companyPath}/fieldOptions/user-role`).once('value');
                    if (userRoleJobTitlesSnapshot.exists()) {
                        jobTitleSelect.innerHTML = '<option value="">Select Job Title</option>';
                        userRoleJobTitlesSnapshot.forEach(childSnapshot => {
                            const job = childSnapshot.val();
                            if (job.enabled !== false && job.label) {
                                 const option = document.createElement('option');
                                 option.value = job.label;
                                 option.textContent = job.label;
                                 jobTitleSelect.appendChild(option);
                            }
                        });
                        console.log(`?? Loaded job titles for offer modal from company user-role (fallback for ${companyPath})`);
                    } else {
                        // Final fallback to global job titles
                        const globalJobTitlesSnapshot = await database.ref('fieldOptions/job-title').once('value');
                        if (globalJobTitlesSnapshot.exists()) {
                            jobTitleSelect.innerHTML = '<option value="">Select Job Title</option>';
                            globalJobTitlesSnapshot.forEach(childSnapshot => {
                                const job = childSnapshot.val();
                                if (job.enabled !== false && job.label) {
                                     const option = document.createElement('option');
                                     option.value = job.label;
                                     option.textContent = job.label;
                                     jobTitleSelect.appendChild(option);
                                }
                            });
                            console.log(`?? Loaded job titles for offer modal from global job-title (final fallback for ${companyPath})`);
                        } else {
                            jobTitleSelect.innerHTML = '<option value="">No job titles available</option>';
                            console.log(`?? No job titles found for company: ${companyPath}`);
                        }
                    }
                }
            } catch (error) { 
                console.error("Error loading job titles for offer modal:", error);
                jobTitleSelect.innerHTML = '<option value="">Error loading job titles</option>';
            } finally {
                // Re-enable the dropdown
                jobTitleSelect.disabled = false;
            }
        }
        
        // Offer Modal functions
        async function openCreateOfferModal() {
            document.getElementById('createOfferModal').style.display = 'flex';
            
            // Load job titles from company scope
            await populateJobTitlesDropdown();
            
            // Load templates from dochtml.html Firebase collection
            await loadOfferTemplates();
            
            // Ensure hired candidates are loaded for current company
            if (currentUser && currentUser.companyId && (!hiredCandidatesData || Object.keys(hiredCandidatesData).length === 0)) {
                console.log('?? Loading hired candidates for create offer modal...');
                await loadHiredCandidates();
            }
            
            // Set default expiry date to 30 days from now
            const today = new Date();
            const defaultExpiry = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
            document.getElementById('offerExpiryDate').valueAsDate = defaultExpiry;
            
            // Set default start date to next Monday (or configurable date)
            const nextWeek = new Date(today.getTime() + (7 * 24 * 60 * 60 * 1000));
            document.getElementById('startDate').valueAsDate = nextWeek;
              // Close modal when clicking outside of it
            const modal = document.getElementById('createOfferModal');
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeCreateOfferModal();
                }
            });
        }
          function closeCreateOfferModal() {
            document.getElementById('createOfferModal').style.display = 'none';
            // Reset form
            document.getElementById('createOfferForm').reset();
            
            // Clear template selection
            clearTemplateSelection();
            
            // Clear salary field and reset its styling
            const salaryField = document.getElementById('salary');
            salaryField.value = '';
            salaryField.placeholder = 'Select base salary level first';
            salaryField.style.color = '#6c757d';
            salaryField.style.fontWeight = 'normal';
              // Clear salary display as well
            document.getElementById('salaryDisplay').textContent = '';
            
            // Reset job title field
            resetJobTitleField();
        }          // Reset job title field (now a dropdown)
        function resetJobTitleField() {
            const jobTitleField = document.getElementById('jobTitle');
            jobTitleField.value = '';
            // Clear dependent fields
            document.getElementById('department').value = '';
            document.getElementById('location').value = '';
            document.getElementById('employmentType').value = '';
        }

        // Template loading and selection functions
        let availableTemplates = [];
        let selectedOfferTemplate = null;

        // Load templates from Firebase Firestore (dochtml.html collection)
        async function loadOfferTemplates() {
            const templateSelect = document.getElementById('offerTemplate');
            
            try {
                if (!window.firebaseAvailable || !firebase.firestore) {
                    console.warn('?? Firebase Firestore not available - template selection disabled');
                    templateSelect.innerHTML = '<option value="">Firebase not available</option>';
                    templateSelect.disabled = true;
                    return;
                }

                // Show loading state
                templateSelect.innerHTML = '<option value="">Loading templates...</option>';
                templateSelect.disabled = true;

                // Load templates from Firebase Firestore
                const firestore = firebase.firestore();
                const templatesSnapshot = await firestore.collection('documentTemplates').get();
                
                availableTemplates = [];
                templatesSnapshot.forEach(doc => {
                    const templateData = doc.data();
                    availableTemplates.push({
                        id: doc.id,
                        ...templateData
                    });
                });

                // Also try to load from localStorage as fallback
                const localTemplates = JSON.parse(localStorage.getItem('documentTemplates') || '[]');
                if (localTemplates.length > 0) {
                    // Merge local templates, avoiding duplicates
                    localTemplates.forEach(localTemplate => {
                        if (!availableTemplates.find(t => t.id === localTemplate.id)) {
                            availableTemplates.push(localTemplate);
                        }
                    });
                }

                // Populate the dropdown
                populateTemplateDropdown();
                
                console.log(`? Loaded ${availableTemplates.length} templates for offer modal`);
                
            } catch (error) {
                console.error('? Error loading templates:', error);
                templateSelect.innerHTML = '<option value="">Error loading templates</option>';
                templateSelect.disabled = true;
            }
        }

        // Populate template dropdown
        function populateTemplateDropdown() {
            const templateSelect = document.getElementById('offerTemplate');
            
            // Reset dropdown
            templateSelect.innerHTML = '<option value="">Use Default Offer Letter</option>';
            templateSelect.disabled = false;

            if (availableTemplates.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No templates available';
                option.disabled = true;
                templateSelect.appendChild(option);
                return;
            }

            // Add templates to dropdown
            availableTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name} (${template.category || 'Uncategorized'})`;
                templateSelect.appendChild(option);
            });
        }

        // Handle template selection
        function handleTemplateSelection() {
            const templateSelect = document.getElementById('offerTemplate');
            const selectedTemplateId = templateSelect.value;
            
            if (!selectedTemplateId) {
                // Clear template selection
                clearTemplateSelection();
                return;
            }

            // Find the selected template
            const template = availableTemplates.find(t => t.id === selectedTemplateId);
            if (!template) {
                console.error('? Selected template not found:', selectedTemplateId);
                return;
            }

            selectedOfferTemplate = template;
            showTemplatePreview(template);
        }

        // Show template preview
        function showTemplatePreview(template) {
            const previewContainer = document.getElementById('templatePreview');
            const previewContent = document.getElementById('templatePreviewContent');
            
            if (!template || !template.sections) {
                console.error('? Invalid template data for preview');
                return;
            }

            // Generate template content preview
            let templateHtml = '';
            
            // Add template header if available
            if (template.name) {
                templateHtml += `<div style="text-align: center; margin-bottom: 2rem;">`;
                if (template.logo) {
                    templateHtml += `<img src="${template.logo}" alt="Template Logo" style="max-height: 60px; margin-bottom: 1rem;"><br>`;
                }
                templateHtml += `<h2 style="margin: 0; color: #2c3e50;">${template.name}</h2>`;
                templateHtml += `</div>`;
            }

            // Add template sections
            template.sections.forEach(section => {
                templateHtml += `<div style="margin-bottom: 1.5rem;">`;
                templateHtml += `<h3 style="color: #495057; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">${section.title}</h3>`;
                templateHtml += `<div>${section.content}</div>`;
                templateHtml += `</div>`;
            });

            previewContent.innerHTML = templateHtml;
            previewContainer.style.display = 'block';
            
            console.log('? Template preview displayed:', template.name);
        }

        // Clear template selection
        function clearTemplateSelection() {
            const templateSelect = document.getElementById('offerTemplate');
            const previewContainer = document.getElementById('templatePreview');
            
            templateSelect.value = '';
            selectedOfferTemplate = null;
            previewContainer.style.display = 'none';
            
            console.log('?? Template selection cleared');
        }

        // Get selected template content for offer generation
        function getSelectedTemplateContent() {
            if (!selectedOfferTemplate) {
                return null;
            }
            
            return {
                template: selectedOfferTemplate,
                content: selectedOfferTemplate.sections || []
            };
        }

        function resetJobTitleField() {
            const jobTitleField = document.getElementById('jobTitle');
            jobTitleField.value = '';
            // Clear dependent fields
            document.getElementById('department').value = '';
            document.getElementById('location').value = '';
            document.getElementById('employmentType').value = '';
        }
          // Auto-populate form data when selections change
        function setupOfferFormListeners() {            // Candidate selection change
            document.getElementById('candidateName').addEventListener('change', async function() {
                const candidateData = getCandidateData(this.value);
                if (candidateData) {
                    console.log('Autofilling candidate data:', candidateData);
                    
                    // Enhanced email autofill - try to get original application email first
                    let candidateEmail = candidateData.email || '';
                    
                    // Enhanced phone autofill - try to get original application phone first
                    let candidatePhone = candidateData.phone || '';
                    
                    // Enhanced address autofill - try to get original application address first
                    let candidateAddress = candidateData.address || '';
                    
                    if (candidateData.originalApplicationId) {
                        console.log('Attempting to load original application data...');
                        try {
                            const applicationData = await getApplicationData(candidateData.originalApplicationId);
                            if (applicationData) {
                                // Use application email if available
                                if (applicationData.email) {
                                    candidateEmail = applicationData.email;
                                    console.log('Using original application email:', candidateEmail);
                                }
                                
                                // Use application phone if available (check multiple possible field names)
                                const phoneFields = ['phone', 'phoneNumber', 'contactNumber', 'mobileNumber', 'mobile'];
                                for (const field of phoneFields) {
                                    if (applicationData[field]) {
                                        candidatePhone = applicationData[field];
                                        console.log(`Using original application phone from ${field}:`, candidatePhone);
                                        break;
                                    }
                                }
                                
                                // Use application address if available (check multiple possible field names)
                                const addressFields = ['address', 'homeAddress', 'residentialAddress', 'location', 'fullAddress', 'street', 'streetAddress'];
                                for (const field of addressFields) {
                                    if (applicationData[field]) {
                                        candidateAddress = applicationData[field];
                                        console.log(`Using original application address from ${field}:`, candidateAddress);
                                        break;
                                    }
                                }
                            }
                        } catch (error) {
                            console.log('Could not load application data, using candidate data:', error);
                        }
                    }
                    
                    // If still no phone from application, try additional candidate fields
                    if (!candidatePhone) {
                        const candidatePhoneFields = ['phone', 'phoneNumber', 'contactNumber', 'mobileNumber', 'mobile', 'telephone'];
                        const rawCandidate = hiredCandidatesData[this.value];
                        if (rawCandidate) {
                            for (const field of candidatePhoneFields) {
                                if (rawCandidate[field]) {
                                    candidatePhone = rawCandidate[field];
                                    console.log(`Using candidate phone from ${field}:`, candidatePhone);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // If still no address from application, try additional candidate fields
                    if (!candidateAddress) {
                        const candidateAddressFields = ['address', 'homeAddress', 'residentialAddress', 'location', 'fullAddress', 'street', 'streetAddress', 'permanentAddress', 'currentAddress'];
                        const rawCandidate = hiredCandidatesData[this.value];
                        if (rawCandidate) {
                            for (const field of candidateAddressFields) {
                                if (rawCandidate[field]) {
                                    candidateAddress = rawCandidate[field];
                                    console.log(`Using candidate address from ${field}:`, candidateAddress);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Auto-fill candidate contact information
                    document.getElementById('candidateEmail').value = candidateEmail;
                    document.getElementById('candidatePhone').value = candidatePhone;
                    document.getElementById('candidateAddress').value = candidateAddress;
                    
                    console.log('Contact info filled - Email:', candidateEmail, 'Phone:', candidatePhone, 'Address:', candidateAddress);
                    
                    // Enhanced job title autofill - get job title from application data
                    let jobTitle = '';
                    
                    if (candidateData.originalApplicationId) {
                        console.log('Attempting to get job title from application data...');
                        try {
                            const applicationData = await getApplicationData(candidateData.originalApplicationId);
                            if (applicationData) {
                                // Try multiple possible job title fields in application data
                                const jobTitleFields = ['jobTitle', 'positionTitle', 'position', 'role', 'jobPosition', 'appliedPosition'];
                                for (const field of jobTitleFields) {
                                    if (applicationData[field]) {
                                        jobTitle = applicationData[field];
                                        console.log(`Using application job title from ${field}:`, jobTitle);
                                        break;
                                    }
                                }
                            }
                        } catch (error) {
                            console.log('Could not load application job title:', error);
                        }
                    }
                    
                    // Fallback: try to get job title from candidate data if not found in application
                    if (!jobTitle && (candidateData.position || candidateData.jobTitle)) {
                        jobTitle = candidateData.position || candidateData.jobTitle;
                        console.log('Using candidate job title as fallback:', jobTitle);
                    }
                    
                    // Fallback: try to get job title from raw candidate data with multiple field names
                    if (!jobTitle) {
                        const candidateJobTitleFields = ['jobTitle', 'position', 'positionTitle', 'role', 'designation'];
                        const rawCandidate = hiredCandidatesData[this.value];
                        if (rawCandidate) {
                            for (const field of candidateJobTitleFields) {
                                if (rawCandidate[field]) {
                                    jobTitle = rawCandidate[field];
                                    console.log(`Using candidate job title from ${field}:`, jobTitle);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // Auto-fill job-related fields
                    if (jobTitle) {
                        document.getElementById('jobTitle').value = jobTitle;
                        console.log('Auto-filled job title from application data:', jobTitle);
                    }
                    
                    // Auto-populate salary dropdown if candidate has salary data
                    if (candidateData.minSalary || candidateData.maxSalary || candidateData.salary) {
                        console.log('Populating salary dropdown from candidate data');
                        populateSalaryDropdown(candidateData);
                    }
                    
                    if (candidateData.department || candidateData.jobDepartment) {
                        document.getElementById('department').value = candidateData.department || candidateData.jobDepartment || '';
                    }
                    
                    if (candidateData.jobLocation) {
                        document.getElementById('location').value = candidateData.jobLocation || '';
                    }
                    
                    // Auto-fill employment type if available
                    const employmentTypeField = document.getElementById('employmentType');
                    if (employmentTypeField && candidateData.employmentType) {
                        employmentTypeField.value = candidateData.employmentType;
                    } else if (employmentTypeField) {
                        // Default to Full-time if not specified
                        employmentTypeField.value = 'Full-time';
                    }
                    
                    // Auto-fill work schedule if available
                    const workScheduleField = document.getElementById('workSchedule');
                    if (workScheduleField && candidateData.workSchedule) {
                        workScheduleField.value = candidateData.workSchedule;
                    } else if (workScheduleField) {
                        // Default to full-time if not specified
                        workScheduleField.value = 'full-time';
                    }
                    
                    console.log('Enhanced candidate data autofilled successfully');
                } else {
                    // Clear fields if no valid candidate selected
                    console.log('Clearing candidate fields - no valid selection');
                    document.getElementById('candidateEmail').value = '';
                    document.getElementById('candidatePhone').value = '';
                    document.getElementById('candidateAddress').value = '';
                    document.getElementById('jobTitle').value = '';
                    document.getElementById('department').value = '';
                    document.getElementById('location').value = '';
                    
                    // Clear employment type
                    const employmentTypeField = document.getElementById('employmentType');
                    if (employmentTypeField) {
                        employmentTypeField.value = '';
                    }
                    
                    // Clear work schedule
                    const workScheduleField = document.getElementById('workSchedule');
                    if (workScheduleField) {
                        workScheduleField.value = '';
                    }
                    
                    clearSalaryDropdown();
                }
            });
            
            // Job title selection change
            document.getElementById('jobTitle').addEventListener('change', async function() {
                const jobTitle = this.value;
                if (jobTitle) {
                    // Load salary data from Firebase for the selected job title
                    await loadSalaryForJobTitle(jobTitle);
                    
                    // Try to get additional job data from local mock data if available
                    const jobData = getJobData(jobTitle.toLowerCase().replace(/\s+/g, '-'));
                    if (jobData) {
                        document.getElementById('department').value = jobData.department || '';
                        document.getElementById('location').value = jobData.location || '';
                        document.getElementById('employmentType').value = jobData.employmentType || '';
                    }
                } else {
                    // Clear salary dropdown if no job title selected
                    clearSalaryDropdown();
                }
            });
            
            // Base salary dropdown change
            document.getElementById('baseSalary').addEventListener('change', function() {
                updateSalaryDisplay();
            });
        }// Get candidate data from hired candidates
        function getCandidateData(candidateId) {
            if (!candidateId || !hiredCandidatesData || !hiredCandidatesData[candidateId]) {
                return null;
            }
              const candidate = hiredCandidatesData[candidateId];
            return {
                fullName: candidate.fullName || `${candidate.firstName || ''} ${candidate.lastName || ''}`.trim(),
                email: candidate.email || '',
                phone: candidate.phone || candidate.contactNumber || '',
                address: candidate.address || candidate.location || '',
                position: candidate.position || candidate.jobTitle || '',
                department: candidate.department || candidate.jobDepartment || '',
                jobLocation: candidate.jobLocation || candidate.workLocation || '',
                employmentType: candidate.employmentType || candidate.jobType || 'Full-time',
                salary: candidate.salary || '',
                minSalary: candidate.minSalary || candidate.salary || '',
                midSalary: candidate.midSalary || candidate.salary || '',
                maxSalary: candidate.maxSalary || candidate.salary || '',
                firstName: candidate.firstName || '',
                lastName: candidate.lastName || '',
                hiredDate: candidate.hiredDate || '',
                originalApplicationId: candidate.originalApplicationId || '',
                jobId: candidate.jobId || '',
                companyId: candidate.companyId || '',
                workSchedule: candidate.workSchedule || '',
                startDate: candidate.startDate || ''
            };
        }        // Populate salary dropdown with min, mid, max values
        function populateSalaryDropdown(candidateData) {
            const salarySelect = document.getElementById('baseSalary');
            const salaryDisplay = document.getElementById('salaryDisplay');
            const salaryField = document.getElementById('salary');
            
            // Clear existing options except the first one
            salarySelect.innerHTML = '<option value="">Select Salary Level</option>';
            
            // Add salary options based on candidate data
            if (candidateData.minSalary || candidateData.salary) {
                const minSalary = candidateData.minSalary || candidateData.salary;
                const midSalary = candidateData.midSalary || candidateData.salary;
                const maxSalary = candidateData.maxSalary || candidateData.salary;
                  // Add min salary option
                const minOption = document.createElement('option');
                minOption.value = 'min';
                minOption.text = `Min Salary ($${minSalary.toLocaleString()})`;
                minOption.setAttribute('data-amount', minSalary);
                minOption.setAttribute('data-source', 'local');
                salarySelect.appendChild(minOption);
                
                // Add mid salary option (if different from min)
                if (midSalary && midSalary !== minSalary) {
                    const midOption = document.createElement('option');
                    midOption.value = 'mid';
                    midOption.text = `Mid Salary ($${parseInt(midSalary).toLocaleString()})`;
                    midOption.setAttribute('data-amount', midSalary);
                    midOption.setAttribute('data-source', 'local');
                    salarySelect.appendChild(midOption);
                }
                
                // Add max salary option (if different from min and mid)
                if (maxSalary && maxSalary !== minSalary && maxSalary !== midSalary) {
                    const maxOption = document.createElement('option');
                    maxOption.value = 'max';
                    maxOption.text = `Max Salary ($${parseInt(maxSalary).toLocaleString()})`;
                    maxOption.setAttribute('data-amount', maxSalary);
                    maxOption.setAttribute('data-source', 'local');
                    salarySelect.appendChild(maxOption);
                }
            }
            
            // Clear salary display and field
            salaryDisplay.textContent = '';
            salaryField.value = '';
            salaryField.placeholder = 'Select base salary level first';
            salaryField.style.color = '#6c757d';
            salaryField.style.fontWeight = 'normal';
        }        // Update salary dropdown from job data (deprecated - now uses Firebase only)
        function updateSalaryDropdownFromJob(jobData) {
            const salarySelect = document.getElementById('baseSalary');
            const salaryDisplay = document.getElementById('salaryDisplay');
            const salaryField = document.getElementById('salary');
            
            // Since we removed hardcoded salary data, this function now just clears the salary fields
            // All salary data should come from Firebase via loadSalaryForJobTitle()
            console.log('updateSalaryDropdownFromJob called - salary data now comes from Firebase only');
            
            // Clear salary display and field - Firebase data will populate them
            salaryDisplay.textContent = '';
            salaryField.value = '';
            salaryField.placeholder = 'Select base salary level first';
            salaryField.style.color = '#6c757d';
            salaryField.style.fontWeight = 'normal';
        }
          // Clear salary dropdown
        function clearSalaryDropdown() {
            const salarySelect = document.getElementById('baseSalary');
            const salaryDisplay = document.getElementById('salaryDisplay');
            const salaryField = document.getElementById('salary');
            
            salarySelect.innerHTML = '<option value="">Select Salary Level</option><option value="min">Min Salary</option><option value="mid">Mid Salary</option><option value="max">Max Salary</option>';
            salaryDisplay.textContent = '';
            
            // Clear salary field
            salaryField.value = '';
            salaryField.placeholder = 'Select base salary level first';
            salaryField.style.color = '#6c757d';
            salaryField.style.fontWeight = 'normal';
        }        // Update salary display based on selection
        function updateSalaryDisplay() {
            const salarySelect = document.getElementById('baseSalary');
            const salaryDisplay = document.getElementById('salaryDisplay');
            const salaryField = document.getElementById('salary');
            const selectedOption = salarySelect.options[salarySelect.selectedIndex];
            
            if (selectedOption && selectedOption.getAttribute('data-amount')) {
                const amount = parseInt(selectedOption.getAttribute('data-amount'));
                const source = selectedOption.getAttribute('data-source') || 'local';
                const recordId = selectedOption.getAttribute('data-record-id') || '';
                const salaryType = selectedOption.getAttribute('data-salary-type') || '';
                
                // Update the salary field with the selected amount
                salaryField.value = `$${amount.toLocaleString()}`;
                salaryField.style.color = '#28a745';
                salaryField.style.fontWeight = '600';
                
                // Display the salary amount with detailed source information
                salaryDisplay.innerHTML = `
                    <div style="font-weight: 600; color: #28a745;">
                        $${amount.toLocaleString()} annually
                    </div>
                    <div style="font-size: 0.8rem; color: #6c757d; margin-top: 0.25rem;">
                        ${source === 'firebase' ? 
                            `?? From salary grid (${salaryType})` : 
                            '?? Estimated range'
                        }
                    </div>
                    ${recordId ? `<div style="font-size: 0.7rem; color: #adb5bd; margin-top: 0.25rem;">Record: ${recordId}</div>` : ''}
                `;
                
                console.log(`Salary displayed: $${amount.toLocaleString()} (source: ${source}, type: ${salaryType}, record: ${recordId})`);
            } else {
                // Clear both salary field and display
                salaryField.value = '';
                salaryField.placeholder = 'Select base salary level first';
                salaryField.style.color = '#6c757d';
                salaryField.style.fontWeight = 'normal';
                salaryDisplay.textContent = '';
            }
        }
        
        // Load salary data for a specific job title from Firebase
        async function loadSalaryForJobTitle(jobTitle) {
            const salarySelect = document.getElementById('baseSalary');
            const salaryDisplay = document.getElementById('salaryDisplay');
            const salaryField = document.getElementById('salary');
            
            try {
                // Show loading state
                salarySelect.innerHTML = '<option value="">Loading salary data...</option>';
                salarySelect.disabled = true;
                salaryDisplay.textContent = 'Loading...';
                salaryField.value = 'Loading...';
                salaryField.style.color = '#6c757d';
                salaryField.style.fontWeight = 'normal';
                
                // Check if we already have salary grades data, otherwise load it
                if (!salaryGradesData || Object.keys(salaryGradesData).length === 0) {
                    console.log('Salary grades not loaded, fetching from Firebase...');
                    await loadSalaryGrades();
                }
                
                // Look for salary data matching the job title
                let salaryData = null;
                let salaryRecordId = null;
                
                // Search through all salary grade records
                for (const [recordId, recordData] of Object.entries(salaryGradesData)) {
                    if (recordData && typeof recordData === 'object') {
                        // Check if this record matches the job title
                        const recordJobTitle = recordData.jobTitle || recordData.position || recordData.title || '';
                        
                        // Try exact match first
                        if (recordJobTitle.toLowerCase() === jobTitle.toLowerCase()) {
                            salaryData = recordData;
                            salaryRecordId = recordId;
                            break;
                        }
                        
                        // Try partial match
                        const normalizedJobTitle = jobTitle.toLowerCase().replace(/[-\s]/g, '');
                        const normalizedRecordTitle = recordJobTitle.toLowerCase().replace(/[-\s]/g, '');
                        
                        if (normalizedRecordTitle.includes(normalizedJobTitle) || 
                            normalizedJobTitle.includes(normalizedRecordTitle)) {
                            salaryData = recordData;
                            salaryRecordId = recordId;
                            break;
                        }
                    }
                }
                
                // Populate salary dropdown with Firebase data
                if (salaryData && (salaryData.minSalary || salaryData.maxSalary)) {
                    console.log('Found salary data for', jobTitle, ':', salaryData, 'Record ID:', salaryRecordId);
                    populateSalaryDropdownFromFirebase(salaryData, salaryRecordId);
                } else {
                    console.log('No salary data found for job title:', jobTitle, '- clearing salary dropdown');
                    clearSalaryDropdown();
                }
                  } catch (error) {
                console.error('Error loading salary for job title:', error);
                clearSalaryDropdown();
            } finally {
                // Re-enable the dropdown
                salarySelect.disabled = false;
            }
        }
        
        // Populate salary dropdown with data from Firebase salary grades
        function populateSalaryDropdownFromFirebase(salaryData, recordId) {
            const salarySelect = document.getElementById('baseSalary');
            const salaryDisplay = document.getElementById('salaryDisplay');
            const salaryField = document.getElementById('salary');
            
            // Clear existing options
            salarySelect.innerHTML = '<option value="">Select Salary Level</option>';
            
            const minSalary = parseFloat(salaryData.minSalary) || 0;
            const maxSalary = parseFloat(salaryData.maxSalary) || 0;
            const midSalary = salaryData.midSalary ? parseFloat(salaryData.midSalary) : Math.round((minSalary + maxSalary) / 2);
              // Add min salary option
            if (minSalary > 0) {
                const minOption = document.createElement('option');
                minOption.value = 'min';
                minOption.text = `Min Salary ($${minSalary.toLocaleString()})`;
                minOption.setAttribute('data-amount', minSalary);
                minOption.setAttribute('data-source', 'firebase');
                minOption.setAttribute('data-record-id', recordId);
                minOption.setAttribute('data-salary-type', 'minSalary');
                salarySelect.appendChild(minOption);
            }
            
            // Add mid salary option
            if (midSalary > 0) {
                const midOption = document.createElement('option');
                midOption.value = 'mid';
                midOption.text = `Mid Salary ($${midSalary.toLocaleString()})`;
                midOption.setAttribute('data-amount', midSalary);
                midOption.setAttribute('data-source', 'firebase');
                midOption.setAttribute('data-record-id', recordId);
                midOption.setAttribute('data-salary-type', 'midSalary');
                salarySelect.appendChild(midOption);
            }
            
            // Add max salary option
            if (maxSalary > 0) {
                const maxOption = document.createElement('option');
                maxOption.value = 'max';
                maxOption.text = `Max Salary ($${maxSalary.toLocaleString()})`;
                maxOption.setAttribute('data-amount', maxSalary);
                maxOption.setAttribute('data-source', 'firebase');
                maxOption.setAttribute('data-record-id', recordId);
                maxOption.setAttribute('data-salary-type', 'maxSalary');
                salarySelect.appendChild(maxOption);
            }
            
            // Clear salary display and field
            salaryDisplay.textContent = '';
            salaryField.value = '';
            salaryField.placeholder = 'Select base salary level first';
            salaryField.style.color = '#6c757d';
            salaryField.style.fontWeight = 'normal';
            
            console.log('Salary dropdown populated with Firebase data:', {
                min: minSalary,
                mid: midSalary,
                max: maxSalary,                recordId: recordId
            });
        }
        
        // Mock data for job positions (salary data comes from Firebase)
        function getJobData(jobId) {
            const jobs = {
                'hse-manager': {
                    department: 'Health, Safety & Environment',
                    location: 'Corporate Office - Main Campus',
                    employmentType: 'Full-time'
                },
                'environmental-specialist': {
                    department: 'Environmental Compliance',
                    location: 'Field Office - Site A',
                    employmentType: 'Full-time'
                },
                'safety-officer': {
                    department: 'Safety Operations',
                    location: 'Field Office - Site B',
                    employmentType: 'Full-time'
                },
                'compliance-analyst': {
                    department: 'Regulatory Compliance',
                    location: 'Corporate Office - Compliance Division',
                    employmentType: 'Full-time'
                }
            };
            return jobs[jobId];
        }        // Create Offer Action Functions
        function createAndSendOffer() {
            if (validateOfferForm()) {
                const formData = collectOfferFormData();
                
                // Check if user has company context
                if (!currentUser || !currentUser.companyId) {
                    showNotification('Error: No company context found. Please login again.', 'error');
                    return;
                }
                
                const companyId = currentUser.companyId;
                
                // Generate unique offer ID
                const offerId = database.ref().child(`companies/${companyId}/offers`).push().key;
                formData.offerId = offerId;
                formData.companyId = companyId;
                formData.createdBy = firebase.auth().currentUser ? firebase.auth().currentUser.uid : 'anonymous';
                formData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                formData.status = 'submitted'; // Set as submitted for approval workflow
                formData.submittedAt = firebase.database.ServerValue.TIMESTAMP;
                formData.submittedBy = firebase.auth().currentUser ? firebase.auth().currentUser.uid : 'anonymous';
                
                // Save to company-scoped Firebase path
                database.ref(`companies/${companyId}/offers/${offerId}`).set(formData)
                    .then(() => {
                        console.log('Offer submitted for approval and saved to Firebase for company:', companyId, formData);
                        
                        // Show success message
                        showNotification('Offer submitted for approval successfully!', 'success');
                        closeCreateOfferModal();
                        
                        // Clear the form
                        document.getElementById('createOfferForm').reset();
                          // Switch to pending offers tab to show the new offer
                        switchToTab('pendingOffers');
                    })
                    .catch((error) => {
                        console.error('Error saving offer to Firebase:', error);
                        showNotification('Error creating offer. Please try again.', 'error');
                    });
            }
        }        function saveOfferAsDraft() {
            if (validateOfferForm(false)) { // Don't require all fields for draft
                const formData = collectOfferFormData();
                formData.status = 'draft';
                
                // Check if user has company context
                if (!currentUser || !currentUser.companyId) {
                    showNotification('Error: No company context found. Please login again.', 'error');
                    return;
                }
                
                const companyId = currentUser.companyId;
                
                // Generate unique offer ID
                const offerId = database.ref().child(`companies/${companyId}/offers`).push().key;
                formData.offerId = offerId;
                formData.companyId = companyId;
                formData.createdBy = firebase.auth().currentUser ? firebase.auth().currentUser.uid : 'anonymous';
                formData.createdAt = firebase.database.ServerValue.TIMESTAMP;
                
                // Save to company-scoped Firebase path
                database.ref(`companies/${companyId}/offers/${offerId}`).set(formData)
                    .then(() => {
                        console.log('Offer saved as draft to Firebase for company:', companyId, formData);
                        showNotification('Offer saved as draft!', 'success');
                        closeCreateOfferModal();
                        
                        // Clear the form
                        document.getElementById('createOfferForm').reset();
                    })
                    .catch((error) => {
                        console.error('Error saving draft offer to Firebase:', error);
                        showNotification('Error saving draft. Please try again.', 'error');
                    });
            }
        }        function previewOffer() {
            if (validateOfferForm()) {
                const formData = collectOfferFormData();
                
                // Generate the offer letter content
                const offerLetterHTML = generateOfferPreview(formData);
                
                // Display the offer letter in the preview modal
                document.getElementById('offerLetterContent').innerHTML = offerLetterHTML;
                
                // Update preview modal buttons for new offer (not approved yet)
                updatePreviewModalButtons({ status: 'draft' }, null);
                
                // Load approval flow
                loadApprovalFlow();
                
                // Show the modal
                document.getElementById('offerPreviewModal').style.display = 'flex';
            }
        }

        function validateOfferForm(requireAll = true) {
            const requiredFields = ['candidateName', 'jobTitle', 'startDate', 'offerExpiryDate', 'baseSalary'];
            
            for (let fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (requireAll && (!field.value || field.value.trim() === '')) {
                    alert(`Please fill in the ${field.previousElementSibling.textContent.replace(' *', '')}.`);
                    field.focus();
                    return false;
                }
            }
            
            // Validate dates
            const startDate = new Date(document.getElementById('startDate').value);
            const expiryDate = new Date(document.getElementById('offerExpiryDate').value);
            const today = new Date();
            
            if (startDate < today) {
                alert('Start date cannot be in the past.');
                document.getElementById('startDate').focus();
                return false;
            }
            
            if (expiryDate < today) {
                alert('Offer expiry date cannot be in the past.');
                document.getElementById('offerExpiryDate').focus();
                return false;
            }
            
            return true;
        }        function collectOfferFormData() {
            const salarySelect = document.getElementById('baseSalary');
            const selectedSalaryOption = salarySelect.options[salarySelect.selectedIndex];
            const salaryAmount = selectedSalaryOption && selectedSalaryOption.getAttribute('data-amount') 
                ? selectedSalaryOption.getAttribute('data-amount') 
                : '';
            
            // Also get the salary field value as a fallback
            const salaryFieldValue = document.getElementById('salary').value || '';
            
            // Get candidate information
            const candidateSelect = document.getElementById('candidateName');
            const candidateId = candidateSelect.value;
            const candidateFullName = candidateId && hiredCandidatesData[candidateId] 
                ? (hiredCandidatesData[candidateId].fullName || 
                   `${hiredCandidatesData[candidateId].firstName || ''} ${hiredCandidatesData[candidateId].lastName || ''}`.trim() || 
                   'Unknown Candidate')
                : candidateSelect.options[candidateSelect.selectedIndex]?.textContent?.split(' - ')[0] || '';
            
            const formData = {
                candidateId: candidateId,
                candidateName: candidateFullName,
                candidateEmail: document.getElementById('candidateEmail').value,
                candidatePhone: document.getElementById('candidatePhone').value,
                candidateAddress: document.getElementById('candidateAddress').value,
                jobTitle: document.getElementById('jobTitle').value,
                department: document.getElementById('department').value,
                location: document.getElementById('location').value,
                employmentType: document.getElementById('employmentType').value,
                startDate: document.getElementById('startDate').value,
                offerExpiryDate: document.getElementById('offerExpiryDate').value,
                probationPeriod: document.getElementById('probationPeriod').value,
                workSchedule: document.getElementById('workSchedule').value,
                baseSalaryLevel: document.getElementById('baseSalary').value, // min, mid, or max
                baseSalary: salaryAmount, // actual dollar amount from dropdown
                salary: salaryFieldValue, // salary field value
                currency: document.getElementById('currency').value,
                bonus: document.getElementById('bonus').value,
                signingBonus: document.getElementById('signingBonus').value,
                specialTerms: document.getElementById('specialTerms').value,
                internalNotes: document.getElementById('internalNotes').value,
                benefits: Array.from(document.querySelectorAll('input[name="benefits"]:checked')).map(cb => cb.value),
                createdDate: new Date().toISOString(),
                status: 'pending'
            };
            
            return formData;
        }function generateOfferPreview(formData) {
            // Check if a custom template is selected
            const templateContent = getSelectedTemplateContent();
            
            if (templateContent && templateContent.template) {
                return generateTemplateBasedOffer(formData, templateContent);
            }
            
            // Use default offer letter format
            return generateDefaultOfferPreview(formData);
        }

        // Generate offer using selected template from dochtml.html
        function generateTemplateBasedOffer(formData, templateContent) {
            const { template } = templateContent;
            
            // Get current date for the letter
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Prepare template variables for substitution
            const templateVars = {
                // Candidate information
                candidateName: formData.candidateName || '[Candidate Name]',
                candidateEmail: formData.candidateEmail || '[Email Address]',
                candidatePhone: formData.candidatePhone || '[Phone Number]',
                candidateAddress: formData.candidateAddress || '[Address]',
                
                // Job information
                jobTitle: formData.jobTitle || '[Job Title]',
                department: formData.department || '[Department]',
                location: formData.location || '[Work Location]',
                employmentType: formData.employmentType || '[Employment Type]',
                
                // Offer details
                startDate: formData.startDate ? new Date(formData.startDate).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                }) : '[Start Date]',
                offerExpiryDate: formData.offerExpiryDate ? new Date(formData.offerExpiryDate).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                }) : '[Expiry Date]',
                
                // Compensation
                salary: formData.baseSalary ? `$${parseInt(formData.baseSalary).toLocaleString()}` : '[Salary Amount]',
                currency: formData.currency || 'USD',
                bonus: formData.bonus ? `${formData.bonus}%` : 'As per company policy',
                signingBonus: formData.signingBonus ? `$${parseInt(formData.signingBonus).toLocaleString()}` : 'None',
                
                // Company information
                companyName: currentCompany?.companyName || 'DREAMEX DATALAB HSE',
                currentDate: currentDate,
                
                // Additional fields
                probationPeriod: formData.probationPeriod ? `${formData.probationPeriod} months` : 'As per company policy',
                workSchedule: formData.workSchedule || 'Full-time',
                specialTerms: formData.specialTerms || 'Standard terms and conditions apply.',
                
                // Benefits
                benefits: generateBenefitsList(formData.benefits)
            };
            
            let templateHtml = '';
            
            // Add template header with logo if available
            if (template.logo || currentCompany?.logoUrl) {
                const logoUrl = template.logo || currentCompany?.logoUrl || currentCompany?.logo;
                templateHtml += `
                    <div class="letterhead" style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #dee2e6;">
                        <img src="${logoUrl}" alt="Company Logo" style="max-height: 80px; margin-bottom: 1rem; object-fit: contain;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #2c3e50;">${templateVars.companyName}</div>
                    </div>
                `;
            }
            
            // Add date
            templateHtml += `
                <div class="letter-date" style="text-align: right; margin-bottom: 2rem; font-weight: 500;">
                    ${templateVars.currentDate}
                </div>
            `;
            
            // Process template sections
            template.sections.forEach(section => {
                let sectionContent = section.content;
                
                // Replace template variables with actual values
                Object.keys(templateVars).forEach(key => {
                    const placeholder = new RegExp(`\\{\\{${key}\\}\\}|\\$\\{${key}\\}|\\[${key}\\]`, 'gi');
                    sectionContent = sectionContent.replace(placeholder, templateVars[key]);
                });
                
                templateHtml += `
                    <div class="template-section" style="margin-bottom: 2rem;">
                        <h3 style="color: #495057; margin-bottom: 1rem; border-bottom: 1px solid #dee2e6; padding-bottom: 0.5rem;">
                            ${section.title}
                        </h3>
                        <div style="line-height: 1.6;">
                            ${sectionContent}
                        </div>
                    </div>
                `;
            });
            
            // Add template footer
            templateHtml += `
                <div class="template-footer" style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #dee2e6; text-align: center; color: #6c757d;">
                    <p>This offer letter was generated using the "${template.name}" template.</p>
                    <p>Please respond by ${templateVars.offerExpiryDate}.</p>
                </div>
            `;
            
            return templateHtml;
        }

        // Helper function to generate benefits list
        function generateBenefitsList(benefits) {
            if (!benefits) {
                return 'Standard benefits package as per company policy';
            }
            
            let benefitsArray = [];
            
            // Handle different data types for benefits
            if (Array.isArray(benefits)) {
                benefitsArray = benefits;
            } else if (typeof benefits === 'string') {
                // If it's a string, try to split it or use as-is
                if (benefits.includes(',')) {
                    benefitsArray = benefits.split(',').map(b => b.trim());
                } else if (benefits.trim()) {
                    benefitsArray = [benefits.trim()];
                }
            }
            
            // Generate the benefits list if we have valid data
            if (benefitsArray.length > 0) {
                const benefitNames = {
                    'health-insurance': 'Comprehensive Health Insurance',
                    'dental': 'Dental Coverage',
                    'vision': 'Vision Coverage',
                    'retirement': '401(k) Retirement Plan with Company Matching',
                    'pto': 'Paid Time Off (PTO)',
                    'flexible-work': 'Flexible Work Arrangements'
                };
                
                return benefitsArray.map(benefit => {
                    return benefitNames[benefit] || benefit;
                }).join(', ');
            }
            
            return 'Standard benefits package as per company policy';
        }

        // Generate default offer letter (existing functionality)
        function generateDefaultOfferPreview(formData) {
            // Get current date for the letter
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Format salary amount
            const salaryAmount = formData.baseSalary ? parseInt(formData.baseSalary).toLocaleString() : 'TBD';
            const currency = formData.currency || 'USD';
            const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '' : currency === 'GBP' ? '' : '$';
            
            // Format start date
            const startDate = formData.startDate ? new Date(formData.startDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'TBD';
            
            // Format expiry date
            const expiryDate = formData.offerExpiryDate ? new Date(formData.offerExpiryDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'TBD';
            
            // Generate benefits list with proper type checking
            let benefitsList = '<li>Standard benefits package as per company policy</li>';
            
            if (formData.benefits) {
                let benefitsArray = [];
                
                // Handle different data types for benefits
                if (Array.isArray(formData.benefits)) {
                    benefitsArray = formData.benefits;
                } else if (typeof formData.benefits === 'string') {
                    // If it's a string, try to split it or use as-is
                    if (formData.benefits.includes(',')) {
                        benefitsArray = formData.benefits.split(',').map(b => b.trim());
                    } else if (formData.benefits.trim()) {
                        benefitsArray = [formData.benefits.trim()];
                    }
                }
                
                // Generate the benefits list if we have valid data
                if (benefitsArray.length > 0) {
                    const benefitNames = {
                        'health-insurance': 'Comprehensive Health Insurance',
                        'dental': 'Dental Coverage',
                        'vision': 'Vision Coverage',
                        'retirement': '401(k) Retirement Plan with Company Matching',
                        'pto': 'Paid Time Off (PTO)',
                        'flexible-work': 'Flexible Work Arrangements'
                    };
                    
                    benefitsList = benefitsArray.map(benefit => {
                        return `<li>${benefitNames[benefit] || benefit}</li>`;
                    }).join('');
                }
            }
            
            // Generate company logo section
            let companyLogoSection = '';
            const companyName = currentCompany?.companyName || 'DREAMEX DATALAB HSE';
            
            if (currentCompany && (currentCompany.logoUrl || currentCompany.logo)) {
                const logoUrl = currentCompany.logoUrl || currentCompany.logo;
                companyLogoSection = `
                    <div class="company-logo-container">
                        <img src="${logoUrl}" alt="${companyName} Logo" class="company-logo-img" style="max-height: 80px; max-width: 200px; object-fit: contain;">
                        <div class="company-name">${companyName}</div>
                    </div>
                `;
            } else {
                companyLogoSection = `<div class="company-logo">${companyName}</div>`;
            }
            
            return `
                <div class="letterhead">
                    ${companyLogoSection}
                    <div class="company-address">
                        Health, Safety & Environmental Solutions<br>
                        1234 Corporate Drive, Suite 100<br>
                        Business City, State 12345<br>
                        Phone: (555) 123-4567 | Email: hr@dreamexdatalab.com
                    </div>
                </div>
                
                <div class="letter-date">
                    ${currentDate}
                </div>
                
                <div class="recipient-info">
                    <strong>${formData.candidateName || '[Candidate Name]'}</strong><br>
                    ${formData.candidateAddress || '[Candidate Address]'}<br>
                    ${formData.candidateEmail || '[Email Address]'}
                </div>
                
                <div class="letter-body">
                    <p><strong>Subject: Job Offer - ${formData.jobTitle || '[Job Title]'}</strong></p>
                    
                    <p>Dear ${formData.candidateName || '[Candidate Name]'},</p>
                    
                    <p>We are delighted to extend an offer of employment to you for the position of <strong>${formData.jobTitle || '[Job Title]'}</strong> with Dreamex Datalab HSE. After careful consideration of your qualifications and interview performance, we believe you will be an excellent addition to our team.</p>
                    
                    <h3>Position Details</h3>
                    <table class="compensation-table">
                        <tr>
                            <th>Job Title:</th>
                            <td>${formData.jobTitle || 'TBD'}</td>
                        </tr>
                        <tr>
                            <th>Department:</th>
                            <td>${formData.department || 'TBD'}</td>
                        </tr>
                        <tr>
                            <th>Work Location:</th>
                            <td>${formData.location || 'TBD'}</td>
                        </tr>
                        <tr>
                            <th>Employment Type:</th>
                            <td>${formData.employmentType || 'Full-time'}</td>
                        </tr>
                        <tr>
                            <th>Work Schedule:</th>
                            <td>${formData.workSchedule || 'Standard business hours'}</td>
                        </tr>
                        <tr>
                            <th>Start Date:</th>
                            <td>${startDate}</td>
                        </tr>
                        ${formData.probationPeriod ? `<tr><th>Probation Period:</th><td>${formData.probationPeriod} months</td></tr>` : ''}
                    </table>
                    
                    <h3>Compensation Package</h3>
                    <table class="compensation-table">
                        <tr>
                            <th>Base Salary:</th>
                            <td><strong>${currencySymbol}${salaryAmount} annually</strong></td>
                        </tr>
                        ${formData.bonus ? `<tr><th>Performance Bonus:</th><td>Up to ${formData.bonus}% of base salary</td></tr>` : ''}
                        ${formData.signingBonus ? `<tr><th>Signing Bonus:</th><td>${currencySymbol}${parseInt(formData.signingBonus).toLocaleString()}</td></tr>` : ''}
                        <tr>
                            <th>Pay Frequency:</th>
                            <td>Bi-weekly</td>
                        </tr>
                    </table>
                    
                    <h3>Benefits Package</h3>
                    <p>In addition to your base compensation, you will be eligible for our comprehensive benefits package, which includes:</p>
                    <ul class="benefits-list">
                        ${benefitsList}
                    </ul>
                    
                    ${formData.specialTerms ? `
                    <h3>Special Terms & Conditions</h3>
                    <p>${formData.specialTerms}</p>
                    ` : ''}
                    
                    <h3>Next Steps</h3>
                    <p>This offer is contingent upon:</p>
                    <ul>
                        <li>Successful completion of background verification</li>
                        <li>Verification of employment eligibility</li>
                        <li>Satisfactory reference checks</li>
                        <li>Any required medical examinations or drug screening</li>
                    </ul>
                    
                    <p><strong>Please note that this offer expires on ${expiryDate}.</strong> To accept this offer, please sign and return this letter by the expiration date.</p>
                    
                    <p>We are excited about the possibility of you joining our team and look forward to your positive response. If you have any questions about this offer, please don't hesitate to contact me.</p>
                    
                    <p>Welcome to the Dreamex Datalab HSE family!</p>
                    
                    <div class="signature-section">
                        <div class="signature-block">
                            <div class="signature-line">
                                <strong>HR Manager</strong><br>
                                Dreamex Datalab HSE<br>
                                Date: ${currentDate}
                            </div>
                        </div>
                        <div class="signature-block">
                            <div class="signature-line">
                                <strong>Candidate Acceptance</strong><br>
                                ${formData.candidateName || '[Candidate Name]'}<br>
                                Date: _________________
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }        function closeOfferModal() {
            document.getElementById('offerModal').style.display = 'none';
        }

        function updateOfferStatusFromModal() {
            alert('Update offer status from modal - to be implemented.');
            closeOfferModal();
        }
        
        // Offer Preview Modal functions
        function closeOfferPreview() {
            document.getElementById('offerPreviewModal').style.display = 'none';
        }
        
        function editOfferFromPreview() {
            // Get the offer ID from the preview modal
            const previewModal = document.getElementById('offerPreviewModal');
            const offerId = previewModal ? previewModal.getAttribute('data-offer-id') : '';
            
            // Close preview modal
            closeOfferPreview();
            
            if (offerId && offerId !== '') {
                // Existing offer - open edit modal with offer data
                console.log('?? Opening edit modal for existing offer:', offerId);
                editOffer(offerId);
            } else {
                // New offer - open create offer modal
                console.log('?? Opening create offer modal for new offer');
                openCreateOfferModal();
            }
        }
        
        function sendOfferFromPreview(offerId = '') {
            // Close preview modal first
            closeOfferPreview();
            
            if (offerId) {
                // Existing offer - send directly
                sendExistingOffer(offerId);
            } else {
                // New offer - use create and send
                createAndSendOffer();
            }
        }
        
        // Update preview modal buttons based on offer status and context
        function updatePreviewModalButtons(offer, offerId = null) {
            const previewButtonsContainer = document.querySelector('.preview-action-buttons');
            if (!previewButtonsContainer) return;
            
            const isExistingOffer = offerId !== null;
            const offerStatus = offer ? offer.status : 'draft';
            
            // Store the offerId in the modal for later use
            const previewModal = document.getElementById('offerPreviewModal');
            if (previewModal) {
                previewModal.setAttribute('data-offer-id', offerId || '');
            }
            
            let buttons = [];
            
            // Always include Close and Edit buttons
            buttons.push(`<button class="btn btn-secondary" onclick="closeOfferPreview()" title="Close">
                <i class="fas fa-times"></i>
            </button>`);
            
            if (isExistingOffer) {
                buttons.push(`<button class="btn btn-primary" onclick="editOfferFromPreview()" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>`);
                
                // Download button for all existing offers
                buttons.push(`<button class="btn btn-download" onclick="downloadOfferLetter('${offerId}')" title="Download">
                    <i class="fas fa-download"></i>
                </button>`);
            }
            
            // Status-specific action buttons
            switch (offerStatus) {
                case 'pending':
                    if (isExistingOffer) {
                        // Approve/Decline buttons hidden per user request
                        // buttons.push(`<button class="btn btn-approve" onclick="approveOfferDirect('${offerId}')" title="Approve">
                        //     <i class="fas fa-check"></i>
                        // </button>`);
                        
                        // buttons.push(`<button class="btn btn-decline" onclick="declineOfferDirect('${offerId}')" title="Decline">
                        //     <i class="fas fa-times-circle"></i>
                        // </button>`);
                    }
                    break;
                    
                case 'approved':
                    if (isExistingOffer) {
                        buttons.push(`<button class="btn btn-success" onclick="sendOfferFromPreview('${offerId}')" title="Send Offer">
                            <i class="fas fa-paper-plane"></i>
                        </button>`);
                        
                        buttons.push(`<button class="btn btn-accept" onclick="markAsAccepted('${offerId}')" title="Mark as Accepted">
                            <i class="fas fa-handshake"></i>
                        </button>`);
                        
                        buttons.push(`<button class="btn btn-decline" onclick="declineOfferDirect('${offerId}')" title="Mark as Declined">
                            <i class="fas fa-times-circle"></i>
                        </button>`);
                    }
                    break;
                    
                case 'sent':
                    if (isExistingOffer) {
                        buttons.push(`<button class="btn btn-accept" onclick="markAsAccepted('${offerId}')" title="Mark as Accepted">
                            <i class="fas fa-handshake"></i>
                        </button>`);
                        
                        // Decline button hidden per user request
                        // buttons.push(`<button class="btn btn-decline" onclick="declineOfferDirect('${offerId}')" title="Decline">
                        //     <i class="fas fa-times-circle"></i>
                        // </button>`);
                    }
                    break;
                    
                case 'accepted':
                    // For accepted offers, mainly view and download options
                    break;
                    
                case 'declined':
                    // For declined offers, mainly view and download options
                    break;
                    
                case 'submitted':
                    // For submitted offers, approval flow handles the approval process
                    // No approve/decline buttons in modal footer
                    break;
                    
                case 'draft':
                default:
                    // For draft offers (new offers being created)
                    if (!isExistingOffer) {
                        buttons.push(`<button class="btn btn-primary" onclick="editOfferFromPreview()" title="Continue Editing">
                            <i class="fas fa-edit"></i>
                        </button>`);
                    }
                    break;
            }
            
            // Add delete button for existing offers (except accepted ones)
            if (isExistingOffer && offerStatus !== 'accepted') {
                buttons.push(`<button class="btn btn-danger" onclick="deleteOffer('${offerId}')" style="margin-left: auto;" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>`);
            }
            
            // Update the buttons container
            previewButtonsContainer.innerHTML = buttons.join('');
        }
        
        // Approval Flow Functions
        async function loadApprovalFlow() {
            console.log('?? Loading approval flow...');
            const approvalFlowContent = document.getElementById('approvalFlowContent');
            
            try {
                // Show loading state
                approvalFlowContent.innerHTML = `
                    <div class="approval-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading approval flow...
                    </div>
                `;
                
                // Get current company context with multiple fallbacks
                let companyId = null;
                
                if (currentUser && currentUser.companyId) {
                    companyId = currentUser.companyId;
                    console.log('? Got company ID from currentUser:', companyId);
                } else if (window.companyContext) {
                    companyId = window.companyContext;
                    console.log('? Got company ID from window.companyContext:', companyId);
                } else if (localStorage.getItem('currentCompanyId')) {
                    companyId = localStorage.getItem('currentCompanyId');
                    console.log('? Got company ID from localStorage:', companyId);
                } else {
                    console.log('? No company context found');
                }
                
                if (!companyId) {
                    approvalFlowContent.innerHTML = `
                        <div class="approval-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            Company context not found. Please refresh the page.
                        </div>
                    `;
                    return;
                }
                
                console.log('?? Fetching approval flow from:', `companies/${companyId}/approvalFlows/offer_approval`);
                
                // Fetch approval flow from company-specific path
                const snapshot = await database.ref(`companies/${companyId}/approvalFlows/offer_approval`).once('value');
                const approvalFlow = snapshot.val();
                
                console.log('?? Approval flow data received:', approvalFlow);
                
                if (!approvalFlow) {
                    approvalFlowContent.innerHTML = `
                        <div class="no-approval-flow">
                            <i class="fas fa-info-circle"></i>
                            No approval flow configured for offers in this company
                        </div>
                    `;
                    return;
                }
                
                // Render approval flow
                await renderApprovalFlow(approvalFlow, companyId);
                
            } catch (error) {
                console.error('? Error loading approval flow:', error);
                approvalFlowContent.innerHTML = `
                    <div class="approval-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading approval flow: ${error.message}
                    </div>
                `;
            }
        }
        
        async function renderApprovalFlow(approvalFlow, companyId) {
            console.log('?? Rendering approval flow for company:', companyId);
            console.log('?? Approval flow data:', approvalFlow);
            
            const approvalFlowContent = document.getElementById('approvalFlowContent');
            
            if (!approvalFlow.levels || Object.keys(approvalFlow.levels).length === 0) {
                console.log('?? No approval levels found');
                approvalFlowContent.innerHTML = `
                    <div class="no-approval-flow">
                        <i class="fas fa-info-circle"></i>
                        <h4>No Approval Flow Configured</h4>
                        <p>Offer approval flow is not configured. Please set it up in the Approval Flow Settings.</p>
                    </div>
                `;
                return;
            }
            
            const approvalOrder = approvalFlow.approvalOrder || 'sequential';
            const levels = approvalFlow.levels;
            const selectedRoles = approvalFlow.selectedRoles || {};
            
            console.log('?? Found', Object.keys(levels).length, 'approval levels');
            console.log('?? Approval order:', approvalOrder);
            console.log('?? Selected roles:', selectedRoles);
            
            // Get offer ID from preview modal to check approval status
            const previewModal = document.getElementById('offerPreviewModal');
            const offerId = previewModal ? previewModal.getAttribute('data-offer-id') : '';
            
            // Get current offer's approval status if it exists
            let offerApprovalStatus = {};
            if (offerId && companyId) {
                try {
                    const offerSnapshot = await database.ref(`companies/${companyId}/offers/${offerId}/approvalStatus`).once('value');
                    offerApprovalStatus = offerSnapshot.val() || {};
                    console.log('?? Current offer approval status:', offerApprovalStatus);
                } catch (error) {
                    console.log('?? Could not load offer approval status:', error);
                }
            }
            
            // Create the approval flow HTML structure matching staff.html
            let approvalHTML = `
                <div class="approval-flow-section">
                    <div class="approval-flow-header">
                        <h4 class="approval-flow-title">
                            <i class="fas fa-route"></i>
                            Approval Flow ${approvalOrder === 'sequential' ? '(Sequential)' : '(Parallel)'}
                        </h4>
                        <span class="approval-flow-status enabled">
                            Enabled
                        </span>
                    </div>
            `;
            
            // Add sequential info if needed
            if (approvalOrder === 'sequential') {
                approvalHTML += `
                    <div class="sequential-info">
                        <i class="fas fa-info-circle"></i>
                        Sequential approval: Each level must be approved before the next can act.
                    </div>
                `;
            }
            
            approvalHTML += `<div class="approval-stages">`;
            
            // Sort levels by level number
            const sortedLevels = Object.entries(levels).sort(([a], [b]) => {
                const levelA = parseInt(a.replace('level', ''));
                const levelB = parseInt(b.replace('level', ''));
                return levelA - levelB;
            });
            
            console.log('?? Sorted levels:', sortedLevels.map(([key, level]) => key));
            
            // Create individual approval stages for each level
            for (let i = 0; i < sortedLevels.length; i++) {
                const [levelKey, level] = sortedLevels[i];
                console.log('?? Processing level:', levelKey, level);
                
                // Extract the numeric part - this should match the Firebase data structure
                const levelNumeric = parseInt(levelKey.replace('level', ''));
                // Always display levels starting from 1, regardless of how Firebase stores them
                const displayLevelNumber = levelNumeric + 1;
                // For data lookup, use levelNumeric + 1 to match selectedRoles structure (level1, level2, etc.)
                const dataLookupLevel = levelNumeric + 1;
                
                console.log('?? Level key:', levelKey, 'Numeric:', levelNumeric, 'Display as Level:', displayLevelNumber, 'Data lookup level:', dataLookupLevel);
                
                try {
                    // Combine level data with selectedRoles for processing
                    const enhancedLevel = {
                        ...level,
                        selectedRoles: selectedRoles
                    };
                    
                    const approverText = await getApproverDisplayText(enhancedLevel, companyId, dataLookupLevel);
                    console.log('? Approver text for', levelKey, ':', approverText);
                    
                    // Check if current user is an approver for this level
                    const isCurrentUserApprover = await checkIfCurrentUserIsApprover(enhancedLevel, companyId, dataLookupLevel);
                    console.log('?? Is current user approver for', levelKey, ':', isCurrentUserApprover);
                    console.log('?? Current user check details:', {
                        levelKey,
                        dataLookupLevel,
                        displayLevelNumber,
                        isCurrentUserApprover,
                        currentUserEmail: firebase.auth().currentUser?.email,
                        approverText: approverText
                    });
                    
                    // Additional debugging for authorization issue
                    if (levelKey === 'level1' && approverText.toLowerCase().includes('oussein')) {
                        console.log('?? AUTHORIZATION DEBUG: Level 2 (assigned to Oussein) - Current user should NOT have access if they are aminata');
                        console.log('?? Current user email:', firebase.auth().currentUser?.email);
                        console.log('?? isCurrentUserApprover result:', isCurrentUserApprover);
                        console.log('?? Expected result: FALSE if current user is aminata');
                    }
                    
                    // Determine stage status based on approval status
                    const levelStatus = offerApprovalStatus[levelKey];
                    let stageStatus = 'waiting';
                    let stageClass = 'waiting';
                    let stageTitle = `Level ${displayLevelNumber}`;
                    let stageStatusText = 'Waiting for previous level';
                    
                    // Check if this level has been approved or rejected
                    if (levelStatus === 'approved') {
                        stageStatus = 'completed';
                        stageClass = 'completed';
                        stageStatusText = 'Approved';
                    } else if (levelStatus === 'rejected') {
                        stageStatus = 'rejected';
                        stageClass = 'rejected';
                        stageStatusText = 'Declined';
                    } else {
                        // For sequential approval, check if previous levels are approved
                        if (approvalOrder === 'sequential') {
                            // Check if all previous levels are approved
                            let canActOnThisLevel = true;
                            for (let j = 0; j < i; j++) {
                                const [prevLevelKey] = sortedLevels[j];
                                const prevLevelStatus = offerApprovalStatus[prevLevelKey];
                                if (prevLevelStatus !== 'approved') {
                                    canActOnThisLevel = false;
                                    break;
                                }
                            }
                            
                            if (canActOnThisLevel) {
                                stageStatus = 'current';
                                stageClass = 'current';
                                stageStatusText = 'Pending Review';
                            } else {
                                stageStatus = 'waiting';
                                stageClass = 'waiting';
                                stageStatusText = 'Waiting for previous level';
                            }
                        } else {
                            // For parallel approval, all levels can act simultaneously
                            stageStatus = 'current';
                            stageClass = 'current';
                            stageStatusText = 'Pending Review';
                        }
                    }
                    
                    // Generate approval buttons if current user is an approver AND can act on this level
                    let approvalButtons = '';
                    const canShowButtons = isCurrentUserApprover && 
                                         (stageStatus === 'current') && 
                                         (levelStatus !== 'approved' && levelStatus !== 'rejected');
                    
                    if (canShowButtons) {
                        approvalButtons = `
                            <div class="approval-actions" style="margin-top: 8px;">
                                <button class="btn btn-approve btn-sm" onclick="approveOffer('${levelKey}', '${displayLevelNumber}')" title="Approve">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-decline btn-sm" onclick="declineOffer('${levelKey}', '${displayLevelNumber}')" title="Decline" style="margin-left: 5px;">
                                    <i class="fas fa-times"></i> Decline
                                </button>
                            </div>
                        `;
                    } else if (isCurrentUserApprover && stageStatus === 'waiting') {
                        // Show disabled buttons with explanation for waiting state
                        approvalButtons = `
                            <div class="approval-actions" style="margin-top: 8px;">
                                <button class="btn btn-approve btn-sm" disabled title="Cannot approve until previous levels are approved">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-decline btn-sm" disabled title="Cannot decline until previous levels are approved" style="margin-left: 5px;">
                                    <i class="fas fa-times"></i> Decline
                                </button>
                            </div>
                        `;
                    }
                    
                    // Get approval history details for completed/rejected levels
                    let approvalHistory = '';
                    if (offerId && companyId && (levelStatus === 'approved' || levelStatus === 'rejected')) {
                        try {
                            const detailsSnapshot = await database.ref(`companies/${companyId}/offers/${offerId}/approvalDetails/${levelKey}`).once('value');
                            const details = detailsSnapshot.val();
                            
                            if (details) {
                                const actionDate = details.approvedAt || details.rejectedAt;
                                const actionBy = details.approvedByName || details.rejectedByName || details.approvedByEmail || details.rejectedByEmail;
                                const actionTime = actionDate ? new Date(actionDate).toLocaleString() : 'Unknown time';
                                
                                if (levelStatus === 'approved') {
                                    approvalHistory = `
                                        <div class="approval-history" style="margin-top: 8px; padding: 8px; background: #d4edda; border-radius: 4px; font-size: 12px;">
                                            <div style="color: #155724; font-weight: 500;">
                                                <i class="fas fa-check-circle"></i> Approved by ${actionBy}
                                            </div>
                                            <div style="color: #6c757d; margin-top: 2px;">
                                                ${actionTime}
                                            </div>
                                        </div>
                                    `;
                                } else if (levelStatus === 'rejected') {
                                    const reason = details.reason || 'No reason provided';
                                    approvalHistory = `
                                        <div class="approval-history" style="margin-top: 8px; padding: 8px; background: #f8d7da; border-radius: 4px; font-size: 12px;">
                                            <div style="color: #721c24; font-weight: 500;">
                                                <i class="fas fa-times-circle"></i> Declined by ${actionBy}
                                            </div>
                                            <div style="color: #6c757d; margin-top: 2px;">
                                                ${actionTime}
                                            </div>
                                            <div style="color: #721c24; margin-top: 4px; font-style: italic;">
                                                Reason: ${reason}
                                            </div>
                                        </div>
                                    `;
                                }
                            }
                        } catch (error) {
                            console.error('? Error loading approval details for', levelKey, ':', error);
                        }
                    }
                    
                    approvalHTML += `
                        <div class="approval-stage ${stageClass}">
                            <div class="stage-number ${stageStatus}">
                                ${stageStatus === 'completed' ? '<i class="fas fa-check"></i>' : 
                                  stageStatus === 'rejected' ? '<i class="fas fa-times"></i>' : 
                                  stageStatus === 'current' ? '<i class="fas fa-clock"></i>' :
                                  stageStatus === 'waiting' ? '<i class="fas fa-pause"></i>' : displayLevelNumber}
                            </div>
                            <div class="stage-info">
                                <div class="stage-title">
                                    ${stageTitle}
                                </div>
                                <div class="approver-info">
                                    <div class="approver-name">${approverText}</div>
                                    ${approvalButtons}
                                    ${approvalHistory}
                                </div>
                                <div class="stage-status-text ${stageStatus}">
                                    ${stageStatusText}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('? Error processing level', levelKey, ':', error);
                    approvalHTML += `
                        <div class="approval-stage">
                            <div class="stage-number rejected">
                                !
                            </div>
                            <div class="stage-info">
                                <div class="stage-title">
                                    Level ${displayLevelNumber} - Error
                                </div>
                                <div class="approver-info">
                                    <div class="approver-name" style="color: #dc3545;">Error loading approver details</div>
                                </div>
                                <div class="stage-status-text rejected">
                                    ${error.message}
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            approvalHTML += `
                    </div>
                </div>
            `;
            
            console.log('? Approval flow rendered successfully');
            approvalFlowContent.innerHTML = approvalHTML;
        }
        
        async function getApproverDisplayText(level, companyId, levelNumber = null) {
            console.log('?? Getting approver display text for level:', level, 'companyId:', companyId, 'levelNumber:', levelNumber);
            
            if (!level.approver && !level.selectedRoles) {
                console.log('?? No approver or selectedRoles found in level');
                return 'No approver selected';
            }
            
            const approverType = level.approverType;
            const approver = level.approver;
            
            console.log('?? Approver type:', approverType, 'Approver:', approver);
            console.log('?? Selected roles:', level.selectedRoles);
            
            try {
                // Check if we have selectedRoles structure (new format)
                if (level.selectedRoles) {
                    const selectedRoles = level.selectedRoles;
                    
                    // If we have a specific level number, look for that level only
                    if (levelNumber !== null) {
                        const levelKey = `level${levelNumber}`;
                        const levelData = selectedRoles[levelKey];
                        
                        console.log(`?? Looking for specific level ${levelKey}:`, levelData);
                        
                        if (levelData) {
                            // Get the first approver from this specific level
                            let approverName = null;
                            
                            if (Array.isArray(levelData)) {
                                // Handle array of approvers - take first one only
                                const firstApprover = levelData[0];
                                if (firstApprover && firstApprover.text) {
                                    approverName = firstApprover.text;
                                }
                            } else if (levelData && typeof levelData === 'object') {
                                // Handle object structure - take first approver only
                                const firstKey = Object.keys(levelData)[0];
                                const firstApprover = levelData[firstKey];
                                if (firstApprover && firstApprover.text) {
                                    approverName = firstApprover.text;
                                }
                            }
                            
                            if (approverName) {
                                console.log('? Found single approver for level:', approverName);
                                return approverName;
                            }
                        }
                    } else {
                        // Fallback: look through all levels and take the first approver found
                        for (const [levelKey, levelData] of Object.entries(selectedRoles)) {
                            console.log(`?? Processing ${levelKey}:`, levelData);
                            
                            let approverName = null;
                            
                            if (Array.isArray(levelData)) {
                                // Handle array of approvers - take first one only
                                const firstApprover = levelData[0];
                                if (firstApprover && firstApprover.text) {
                                    approverName = firstApprover.text;
                                }
                            } else if (levelData && typeof levelData === 'object') {
                                // Handle object structure - take first approver only
                                const firstKey = Object.keys(levelData)[0];
                                const firstApprover = levelData[firstKey];
                                if (firstApprover && firstApprover.text) {
                                    approverName = firstApprover.text;
                                }
                            }
                            
                            if (approverName) {
                                console.log('? Found single approver:', approverName);
                                return approverName;
                            }
                        }
                    }
                }
                
                // Fallback to original logic for backward compatibility
                switch (approverType) {
                    case 'function':
                        console.log('? Function approver:', approver);
                        return `Function: ${approver}`;
                    
                    case 'name':
                    case 'user':
                        // Fetch actual user name from Firebase
                        console.log('?? Fetching user data for:', approver);
                        const userSnapshot = await database.ref(`users/${approver}`).once('value');
                        const userData = userSnapshot.val();
                        
                        if (userData) {
                            const userName = userData.displayName || userData.fullName || userData.email || approver;
                            console.log('? User found:', userName);
                            return `User: ${userName}`;
                        } else {
                            console.log('?? User not found for ID:', approver);
                            return `User: ${approver} (User not found)`;
                        }
                    
                    case 'level':
                        console.log('? Level approver:', approver);
                        return `Level: ${approver}`;
                    
                    case 'role':
                        // If it's a role-based approval, fetch role name
                        console.log('??? Fetching role data for:', approver);
                        const roleSnapshot = await database.ref(`companies/${companyId}/roles/${approver}`).once('value');
                        const roleData = roleSnapshot.val();
                        
                        if (roleData) {
                            const roleName = roleData.name || roleData.roleName || approver;
                            console.log('? Role found:', roleName);
                            return `Role: ${roleName}`;
                        } else {
                            console.log('?? Role not found for:', approver);
                            return `Role: ${approver}`;
                        }
                    
                    case 'department':
                        console.log('?? Department approver:', approver);
                        return `Department: ${approver}`;
                    
                    default:
                        console.log('?? Unknown approver type, trying to fetch as user ID:', approver);
                        // If it's a user ID, try to fetch the user name
                        if (approver && typeof approver === 'string' && approver.length > 10) {
                            const userSnapshot = await database.ref(`users/${approver}`).once('value');
                            const userData = userSnapshot.val();
                            
                            if (userData) {
                                const userName = userData.displayName || userData.fullName || userData.email || approver;
                                console.log('? User found by ID:', userName);
                                return userName;
                            }
                        }
                        console.log('?? Using fallback approver text:', approver);
                        return approver || 'No approver specified';
                }
            } catch (error) {
                console.error('? Error fetching approver details:', error);
                return `Error loading approver details: ${error.message}`;
            }
        }
        
        // Check if current logged-in user is an approver for a specific level
        async function checkIfCurrentUserIsApprover(level, companyId, levelNumber = null) {
            console.log('?? Checking if current user is approver for level:', levelNumber);
            console.log('?? Level data:', level);
            
            // Get current user
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('?? No current user found');
                return false;
            }
            
            const currentUserId = currentUser.uid;
            const currentUserEmail = currentUser.email;
            console.log('?? Current user:', { uid: currentUserId, email: currentUserEmail });
            
            try {
                // Check if we have selectedRoles structure (new format)
                if (level.selectedRoles && levelNumber !== null) {
                    const levelKey = `level${levelNumber}`;
                    const levelData = level.selectedRoles[levelKey];
                    
                    console.log(`?? Checking level ${levelKey} data:`, levelData);
                    
                    if (levelData) {
                        // Check if current user is in this level's approvers
                        if (Array.isArray(levelData)) {
                            console.log('?? Processing array of approvers:', levelData);
                            // Handle array of approvers
                            for (let i = 0; i < levelData.length; i++) {
                                const approverItem = levelData[i];
                                console.log(`?? Checking approver ${i}:`, approverItem);
                                const isMatch = await isCurrentUserMatch(approverItem, currentUserId, currentUserEmail, companyId);
                                console.log(`?? User match result for approver ${i}:`, isMatch);
                                if (isMatch) {
                                    console.log('? User match found in array!');
                                    return true;
                                }
                            }
                            console.log('? No user match found in array of approvers');
                        } else if (levelData && typeof levelData === 'object') {
                            console.log('?? Processing object of approvers:', levelData);
                            // Handle object structure
                            for (const [key, approverItem] of Object.entries(levelData)) {
                                console.log(`?? Checking approver key ${key}:`, approverItem);
                                const isMatch = await isCurrentUserMatch(approverItem, currentUserId, currentUserEmail, companyId);
                                console.log(`?? User match result for key ${key}:`, isMatch);
                                if (isMatch) {
                                    console.log('? User match found in object!');
                                    return true;
                                }
                            }
                            console.log('? No user match found in object of approvers');
                        }
                    } else {
                        console.log(`?? No data found for level ${levelKey}`);
                    }
                }
                
                console.log('?? Checking legacy approver format...');
                // Fallback: check legacy approver format
                const approverType = level.approverType;
                const approver = level.approver;
                
                console.log('?? Legacy format - Type:', approverType, 'Approver:', approver);
                
                switch (approverType) {
                    case 'user':
                        if (approver === currentUserId || approver === currentUserEmail) {
                            console.log('? User match found in legacy user format!');
                            return true;
                        }
                        break;
                        
                    case 'role':
                        console.log('?? Checking role-based approval:', approver);
                        const roleMatch = await checkUserHasRole(currentUserId, approver, companyId);
                        if (roleMatch) {
                            console.log('? User match found via role!');
                            return true;
                        }
                        break;
                        
                    default:
                        console.log('?? Unknown approver type:', approverType);
                }
                
                console.log('? No authorization found for current user');
                return false;
                
            } catch (error) {
                console.error('? Error checking if current user is approver:', error);
                return false;
            }
        }
        
        // Helper function to check if current user matches an approver item
        async function isCurrentUserMatch(approverItem, currentUserId, currentUserEmail, companyId) {
            if (!approverItem) {
                console.log('? No approver item provided');
                return false;
            }
            
            console.log('?? ========== USER MATCH CHECK START ==========');
            console.log('?? Checking user match:', {
                approverItem,
                currentUserId,
                currentUserEmail
            });
            
            // Check if approver item has user ID or email
            if (approverItem.userId) {
                console.log('?? Matching by userId:', approverItem.userId, 'vs', currentUserId);
                const match = approverItem.userId === currentUserId;
                console.log('?? UserId match result:', match);
                if (match) {
                    console.log('? ========== USER MATCH SUCCESS (userId) ==========');
                    return true;
                }
            }
            
            if (approverItem.email) {
                console.log('?? Matching by email:', approverItem.email, 'vs', currentUserEmail);
                const match = approverItem.email === currentUserEmail;
                console.log('?? Email match result:', match);
                if (match) {
                    console.log('? ========== USER MATCH SUCCESS (email) ==========');
                    return true;
                }
            }
            
            // Check if approver item has text that matches user info
            if (approverItem.text) {
                console.log('?? Matching by text/name:', approverItem.text);
                console.log('?? Current user email for comparison:', currentUserEmail);
                
                // Get current user data from Firebase to check displayName/fullName
                try {
                    const currentUserData = await database.ref(`users/${currentUserId}`).once('value');
                    const userData = currentUserData.val();
                    
                    if (userData) {
                        const userDisplayName = userData.displayName || userData.fullName || '';
                        const userFirstName = userData.firstName || '';
                        const userLastName = userData.lastName || '';
                        const userEmail = userData.email || currentUserEmail || '';
                        
                        console.log('?? Current user data from Firebase:', {
                            displayName: userDisplayName,
                            firstName: userFirstName,
                            lastName: userLastName,
                            email: userEmail
                        });
                        
                        // Try multiple matching strategies
                        const nameToMatch = approverItem.text.toLowerCase().trim();
                        console.log('?? Name to match (lowercased):', nameToMatch);
                        
                        // 1. Exact match with display name or full name
                        if (userDisplayName.toLowerCase() === nameToMatch) {
                            console.log('? Matched by display name');
                            console.log('? ========== USER MATCH SUCCESS (displayName) ==========');
                            return true;
                        }
                        
                        // 2. Match with first name
                        if (userFirstName.toLowerCase() === nameToMatch) {
                            console.log('? Matched by first name');
                            console.log('? ========== USER MATCH SUCCESS (firstName) ==========');
                            return true;
                        }
                        
                        // 3. Match with last name
                        if (userLastName.toLowerCase() === nameToMatch) {
                            console.log('? Matched by last name');
                            console.log('? ========== USER MATCH SUCCESS (lastName) ==========');
                            return true;
                        }
                        
                        // 4. Match with email (before @ symbol)
                        const emailUsername = userEmail.split('@')[0].toLowerCase();
                        console.log('?? Email username:', emailUsername);
                        if (emailUsername === nameToMatch) {
                            console.log('? Matched by email username');
                            console.log('? ========== USER MATCH SUCCESS (emailUsername) ==========');
                            return true;
                        }
                        
                        // 5. Direct email match
                        if (userEmail.toLowerCase() === nameToMatch) {
                            console.log('? Matched by email');
                            console.log('? ========== USER MATCH SUCCESS (email) ==========');
                            return true;
                        }
                        
                        console.log('? No direct match found in user data');
                    } else {
                        console.log('?? No user data found in Firebase');
                    }
                } catch (error) {
                    console.error('? Error fetching current user data:', error);
                }
                
                // Fallback: try to find user by name in users collection
                console.log('?? Fallback: searching for user by name in users collection...');
                const userData = await getUserByName(approverItem.text, companyId);
                if (userData && userData.uid === currentUserId) {
                    console.log('? Matched by user lookup');
                    console.log('? ========== USER MATCH SUCCESS (userLookup) ==========');
                    return true;
                } else {
                    console.log('? No match found in user lookup');
                }
            }
            
            console.log('? No match found for any criteria');
            console.log('? ========== USER MATCH FAILED ==========');
            return false;
        }
        
        // Helper function to get user by name
        async function getUserByName(name, companyId) {
            try {
                // Search for user by name in company users
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val();
                
                if (users) {
                    for (const [userId, userData] of Object.entries(users)) {
                        const userName = userData.displayName || userData.fullName || userData.email || '';
                        if (userName.toLowerCase() === name.toLowerCase()) {
                            return { ...userData, uid: userId };
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('? Error getting user by name:', error);
                return null;
            }
        }
        
        // Helper function to check if user has a specific role
        async function checkUserHasRole(userId, roleName, companyId) {
            try {
                // Check user roles in company context
                const userRoleSnapshot = await database.ref(`companies/${companyId}/userRoles/${userId}`).once('value');
                const userRoles = userRoleSnapshot.val();
                
                if (userRoles && Array.isArray(userRoles)) {
                    return userRoles.includes(roleName);
                }
                
                return false;
            } catch (error) {
                console.error('? Error checking user role:', error);
                return false;
            }
        }
        
        // Approval action functions
        async function approveOffer(levelKey, levelNumber) {
            console.log('? Approving offer at level:', levelKey, levelNumber);
            
            // Get the offer ID from the preview modal
            const previewModal = document.getElementById('offerPreviewModal');
            const offerId = previewModal ? previewModal.getAttribute('data-offer-id') : '';
            
            if (!offerId) {
                alert('Error: Could not find offer ID. Please close and reopen the preview.');
                return;
            }
            
            // Get current user and company context
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                alert('Error: You must be logged in to approve offers.');
                return;
            }
            
            // Get company ID using the same pattern as other functions
            let companyId = null;
            if (window.currentUser && window.currentUser.companyId) {
                companyId = window.currentUser.companyId;
            } else if (window.companyContext) {
                companyId = window.companyContext;
            } else {
                // Try to get from stored data
                const storedCompanyId = localStorage.getItem('companyId');
                if (storedCompanyId) {
                    companyId = storedCompanyId;
                }
            }
            
            if (!companyId) {
                alert('Error: Could not determine company context. Please refresh and try again.');
                return;
            }
            
            console.log('?? Using company ID for approval:', companyId);
            
            // Additional validation: Verify current user is actually an approver for this level
            try {
                const approvalFlowSnapshot = await database.ref(`companies/${companyId}/approvalFlows/offer_approval`).once('value');
                const approvalFlow = approvalFlowSnapshot.val();
                
                if (approvalFlow && approvalFlow.levels) {
                    const level = approvalFlow.levels[levelKey];
                    if (level) {
                        // Create enhanced level object with selectedRoles
                        const enhancedLevel = {
                            ...level,
                            selectedRoles: approvalFlow.selectedRoles
                        };
                        
                        // Extract level number for validation
                        const levelNumeric = parseInt(levelKey.replace('level', ''));
                        const dataLookupLevel = levelNumeric + 1;
                        
                        const isAuthorized = await checkIfCurrentUserIsApprover(enhancedLevel, companyId, dataLookupLevel);
                        
                        if (!isAuthorized) {
                            console.log('? User not authorized to approve this level');
                            alert('Error: You are not authorized to approve this level. Only designated approvers can approve offers.');
                            return;
                        }
                        
                        console.log('? User authorization confirmed for level:', levelKey);
                    } else {
                        console.log('? Level not found in approval flow:', levelKey);
                        alert('Error: Invalid approval level. Please contact an administrator.');
                        return;
                    }
                } else {
                    console.log('? No approval flow configuration found');
                    alert('Error: No approval flow configuration found. Please contact an administrator.');
                    return;
                }
            } catch (error) {
                console.error('? Error validating user authorization:', error);
                alert('Error: Could not validate authorization. Please try again.');
                return;
            }
            
            try {
                // Get current user data for detailed approval history
                const userSnapshot = await database.ref(`users/${currentUser.uid}`).once('value');
                const userData = userSnapshot.val() || {};
                
                // Update the approval status in Firebase
                const approvalData = {
                    status: 'approved',
                    approvedBy: currentUser.uid,
                    approvedByEmail: currentUser.email,
                    approvedByName: userData.displayName || userData.fullName || currentUser.email,
                    approvedAt: firebase.database.ServerValue.TIMESTAMP,
                    level: levelKey,
                    levelNumber: levelNumber,
                    comments: '' // Could add approval comments in the future
                };
                
                // Save to offer's approval status
                await database.ref(`companies/${companyId}/offers/${offerId}/approvalStatus/${levelKey}`).set('approved');
                
                // Save detailed approval information
                await database.ref(`companies/${companyId}/offers/${offerId}/approvalDetails/${levelKey}`).set(approvalData);
                
                console.log('? Offer approved successfully');
                
                // Show success message
                alert(`Offer approved at Level ${levelNumber}!`);
                
                // Reload the approval flow to show updated status and unlock next level
                await loadApprovalFlow();
                
                // Check if all levels are approved to update offer status
                await checkAndUpdateOfferStatus(offerId, companyId);
                
            } catch (error) {
                console.error('? Error approving offer:', error);
                alert('Error approving offer: ' + error.message);
            }
        }
        
        async function declineOffer(levelKey, levelNumber) {
            console.log('? Declining offer at level:', levelKey, levelNumber);
            
            // Get the offer ID from the preview modal
            const previewModal = document.getElementById('offerPreviewModal');
            const offerId = previewModal ? previewModal.getAttribute('data-offer-id') : '';
            
            if (!offerId) {
                alert('Error: Could not find offer ID. Please close and reopen the preview.');
                return;
            }
            
            // Ask for decline reason
            const reason = prompt('Please provide a reason for declining this offer:');
            if (reason === null) return; // User cancelled
            if (!reason.trim()) {
                alert('A reason is required to decline an offer.');
                return;
            }
            
            // Get current user and company context
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                alert('Error: You must be logged in to decline offers.');
                return;
            }
            
            // Get company ID using the same pattern as other functions
            let companyId = null;
            if (window.currentUser && window.currentUser.companyId) {
                companyId = window.currentUser.companyId;
            } else if (window.companyContext) {
                companyId = window.companyContext;
            } else {
                // Try to get from stored data
                const storedCompanyId = localStorage.getItem('companyId');
                if (storedCompanyId) {
                    companyId = storedCompanyId;
                }
            }
            
            if (!companyId) {
                alert('Error: Could not determine company context. Please refresh and try again.');
                return;
            }
            
            console.log('?? Using company ID for decline:', companyId);
            
            // Additional validation: Verify current user is actually an approver for this level
            try {
                const approvalFlowSnapshot = await database.ref(`companies/${companyId}/approvalFlows/offer_approval`).once('value');
                const approvalFlow = approvalFlowSnapshot.val();
                
                if (approvalFlow && approvalFlow.levels) {
                    const level = approvalFlow.levels[levelKey];
                    if (level) {
                        // Create enhanced level object with selectedRoles
                        const enhancedLevel = {
                            ...level,
                            selectedRoles: approvalFlow.selectedRoles
                        };
                        
                        // Extract level number for validation
                        const levelNumeric = parseInt(levelKey.replace('level', ''));
                        const dataLookupLevel = levelNumeric + 1;
                        
                        const isAuthorized = await checkIfCurrentUserIsApprover(enhancedLevel, companyId, dataLookupLevel);
                        
                        if (!isAuthorized) {
                            console.log('? User not authorized to decline this level');
                            alert('Error: You are not authorized to decline this level. Only designated approvers can decline offers.');
                            return;
                        }
                        
                        console.log('? User authorization confirmed for level:', levelKey);
                    } else {
                        console.log('? Level not found in approval flow:', levelKey);
                        alert('Error: Invalid approval level. Please contact an administrator.');
                        return;
                    }
                } else {
                    console.log('? No approval flow configuration found');
                    alert('Error: No approval flow configuration found. Please contact an administrator.');
                    return;
                }
            } catch (error) {
                console.error('? Error validating user authorization:', error);
                alert('Error: Could not validate authorization. Please try again.');
                return;
            }
            
            try {
                // Get current user data for detailed approval history
                const userSnapshot = await database.ref(`users/${currentUser.uid}`).once('value');
                const userData = userSnapshot.val() || {};
                
                // Update the approval status in Firebase
                const declineData = {
                    status: 'rejected',
                    rejectedBy: currentUser.uid,
                    rejectedByEmail: currentUser.email,
                    rejectedByName: userData.displayName || userData.fullName || currentUser.email,
                    rejectedAt: firebase.database.ServerValue.TIMESTAMP,
                    reason: reason.trim(),
                    level: levelKey,
                    levelNumber: levelNumber
                };
                
                // Save to offer's approval status
                await database.ref(`companies/${companyId}/offers/${offerId}/approvalStatus/${levelKey}`).set('rejected');
                
                // Save detailed decline information
                await database.ref(`companies/${companyId}/offers/${offerId}/approvalDetails/${levelKey}`).set(declineData);
                
                // Update overall offer status to declined immediately when any level declines
                await database.ref(`companies/${companyId}/offers/${offerId}/status`).set('declined');
                await database.ref(`companies/${companyId}/offers/${offerId}/declinedAt`).set(firebase.database.ServerValue.TIMESTAMP);
                
                console.log('? Offer declined successfully');
                
                // Show success message
                alert(`Offer declined at Level ${levelNumber}. Reason: ${reason}`);
                
                // Reload the approval flow to show updated status
                await loadApprovalFlow();
                
            } catch (error) {
                console.error('? Error declining offer:', error);
                alert('Error declining offer: ' + error.message);
            }
        }
        
        // Check if all approval levels are approved and update offer status accordingly
        async function checkAndUpdateOfferStatus(offerId, companyId) {
            try {
                console.log('?? Checking approval status for offer:', offerId);
                
                // Get the approval flow configuration
                const approvalFlowSnapshot = await database.ref(`companies/${companyId}/approvalFlows/offer_approval`).once('value');
                const approvalFlow = approvalFlowSnapshot.val();
                
                if (!approvalFlow || !approvalFlow.levels) {
                    console.log('?? No approval flow found');
                    return;
                }
                
                // Get current approval status
                const approvalStatusSnapshot = await database.ref(`companies/${companyId}/offers/${offerId}/approvalStatus`).once('value');
                const approvalStatus = approvalStatusSnapshot.val() || {};
                
                // Get all required levels
                const allLevels = Object.keys(approvalFlow.levels);
                console.log('?? All required approval levels:', allLevels);
                console.log('?? Current approval status:', approvalStatus);
                
                // Check if all levels are approved
                const allApproved = allLevels.every(levelKey => {
                    const status = approvalStatus[levelKey];
                    console.log(`?? Level ${levelKey} status:`, status);
                    return status === 'approved';
                });
                
                // Check if any level is rejected
                const anyRejected = allLevels.some(levelKey => approvalStatus[levelKey] === 'rejected');
                
                console.log('?? Approval check results:', {
                    allLevels,
                    approvalStatus,
                    allApproved,
                    anyRejected
                });
                
                if (allApproved) {
                    // Update offer status to approved only when ALL levels are approved
                    await database.ref(`companies/${companyId}/offers/${offerId}/status`).set('approved');
                    await database.ref(`companies/${companyId}/offers/${offerId}/fullyApprovedAt`).set(firebase.database.ServerValue.TIMESTAMP);
                    
                    console.log('? Offer fully approved - status updated to approved');
                    
                    // Get complete offer data for email notification
                    const offerSnapshot = await database.ref(`companies/${companyId}/offers/${offerId}`).once('value');
                    const fullOfferData = offerSnapshot.val();
                    
                    // Send job offer notification to candidate if email is available
                    if (fullOfferData && fullOfferData.candidateEmail) {
                        console.log('?? Sending job offer notification to candidate:', fullOfferData.candidateEmail);
                        
                        // Show notification that email is being sent
                        showNotification('Sending job offer email to candidate...', 'info');
                        
                        try {
                            const notificationResult = await sendJobOfferNotification(fullOfferData, fullOfferData.candidateEmail);
                            
                            if (notificationResult.success) {
                                console.log('? Job offer notification sent successfully to candidate');
                                
                                // Record the notification in the offer data
                                await database.ref(`companies/${companyId}/offers/${offerId}/notificationSent`).set({
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    recipient: fullOfferData.candidateEmail,
                                    messageId: notificationResult.messageId,
                                    status: 'sent'
                                });
                                
                                // Show success message including email notification
                                showNotification(`? Offer approved and email sent to ${fullOfferData.candidateEmail}`, 'success');
                                alert('?? Offer has been fully approved by all levels! The offer status is now "Approved" and a job offer email has been sent to the candidate.');
                            } else {
                                console.error('? Failed to send job offer notification:', notificationResult.error);
                                
                                // Record the failed notification
                                await database.ref(`companies/${companyId}/offers/${offerId}/notificationSent`).set({
                                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                                    recipient: fullOfferData.candidateEmail,
                                    status: 'failed',
                                    error: notificationResult.error
                                });
                                
                                // Show success message with warning about email
                                showNotification(`? Offer approved but email failed: ${notificationResult.error}`, 'error');
                                alert('?? Offer has been fully approved by all levels! The offer status is now "Approved".\n\n?? Warning: Could not send job offer email to candidate. Please send manually.\n\nError: ' + notificationResult.error);
                            }
                        } catch (emailError) {
                            console.error('? Error in job offer notification process:', emailError);
                            
                            // Show error notification
                            showNotification(`? Email error: ${emailError.message}`, 'error');
                            
                            // Show success message with warning about email
                            alert('?? Offer has been fully approved by all levels! The offer status is now "Approved".\n\n?? Warning: Could not send job offer email to candidate. Please send manually.\n\nError: ' + emailError.message);
                        }
                    } else {
                        // No candidate email available
                        console.log('?? No candidate email found - skipping job offer notification');
                        showNotification('?? No candidate email found', 'warning');
                        alert('?? Offer has been fully approved by all levels! The offer status is now "Approved".\n\n?? Note: No candidate email found. Please send job offer manually.');
                    }
                    
                    // Refresh the offers table to show updated status
                    await loadOffers();
                    
                    // Refresh the modal if it's open to show updated status
                    const previewModal = document.getElementById('offerPreviewModal');
                    if (previewModal && previewModal.style.display !== 'none') {
                        // Get the updated offer data and refresh the modal
                        const offerSnapshot = await database.ref(`companies/${companyId}/offers/${offerId}`).once('value');
                        const updatedOffer = offerSnapshot.val();
                        if (updatedOffer) {
                            // Update preview modal buttons to reflect new status
                            updatePreviewModalButtons(updatedOffer, offerId);
                        }
                    }
                    
                } else if (anyRejected) {
                    // If any level is rejected, ensure offer status is declined
                    await database.ref(`companies/${companyId}/offers/${offerId}/status`).set('declined');
                    console.log('? Offer has rejections - status confirmed as declined');
                    
                    // Refresh the offers table to show updated status
                    await loadOffers();
                    
                    // Refresh the modal if it's open to show updated status
                    const previewModal = document.getElementById('offerPreviewModal');
                    if (previewModal && previewModal.style.display !== 'none') {
                        // Get the updated offer data and refresh the modal
                        const offerSnapshot = await database.ref(`companies/${companyId}/offers/${offerId}`).once('value');
                        const updatedOffer = offerSnapshot.val();
                        if (updatedOffer) {
                            // Update preview modal buttons to reflect new status
                            updatePreviewModalButtons(updatedOffer, offerId);
                        }
                    }
                    
                } else {
                    // Keep offer in submitted status until all levels approve or any level rejects
                    await database.ref(`companies/${companyId}/offers/${offerId}/status`).set('submitted');
                    console.log('? Offer still has pending approvals - status remains submitted');
                }
                
            } catch (error) {
                console.error('? Error checking approval status:', error);
            }
        }
        
        // Debug function to test authorization for specific user and level
        async function debugAuthorization(testUserEmail = 'aminata@example.com', testLevelNumber = 2) {
            console.log('?? ========== AUTHORIZATION DEBUG TEST ==========');
            console.log('?? Testing authorization for:', testUserEmail, 'on level:', testLevelNumber);
            
            try {
                // Get company ID
                const companyId = '-OVdOmV_CnbwZ0d7JrkB'; // Your test company ID
                
                // Get approval flow
                const approvalFlowSnapshot = await database.ref(`companies/${companyId}/approvalFlows/offer_approval`).once('value');
                const approvalFlow = approvalFlowSnapshot.val();
                
                if (approvalFlow && approvalFlow.levels && approvalFlow.selectedRoles) {
                    console.log('?? Approval flow structure:', {
                        levels: Object.keys(approvalFlow.levels),
                        selectedRoles: approvalFlow.selectedRoles
                    });
                    
                    // Get the level we want to test
                    const levelKey = `level${testLevelNumber - 1}`; // Convert display level to storage level
                    const dataLookupLevel = testLevelNumber; // For selectedRoles lookup
                    
                    console.log('?? Testing level key:', levelKey, 'data lookup level:', dataLookupLevel);
                    
                    if (approvalFlow.levels[levelKey]) {
                        const level = approvalFlow.levels[levelKey];
                        const enhancedLevel = {
                            ...level,
                            selectedRoles: approvalFlow.selectedRoles
                        };
                        
                        console.log('?? Enhanced level data:', enhancedLevel);
                        
                        // Check who is assigned to this level
                        const selectedRolesKey = `level${dataLookupLevel}`;
                        if (approvalFlow.selectedRoles[selectedRolesKey]) {
                            console.log('?? Assigned approvers for', selectedRolesKey, ':', approvalFlow.selectedRoles[selectedRolesKey]);
                        }
                        
                        // Get approver display text
                        const approverText = await getApproverDisplayText(enhancedLevel, companyId, dataLookupLevel);
                        console.log('?? Approver display text:', approverText);
                        
                        // Check authorization for test user
                        // Note: This won't work perfectly since we need the actual current user, but it shows the data
                        console.log('?? This would check if', testUserEmail, 'is authorized for level', testLevelNumber);
                        console.log('?? Expected result: FALSE if approver is someone else (like oussein)');
                        
                    } else {
                        console.log('? Level not found:', levelKey);
                    }
                } else {
                    console.log('? Approval flow not found or incomplete');
                }
                
            } catch (error) {
                console.error('? Debug test error:', error);
            }
            
            console.log('?? ========== DEBUG TEST COMPLETE ==========');
        }
        
        // Test function to debug approval flow loading
        async function testApprovalFlowLoading() {
            console.log('?? Testing approval flow loading...');
            
            // Set test company ID from your URL
            const testCompanyId = '-OVdOmV_CnbwZ0d7JrkB';
            
            try {
                console.log('?? Testing Firebase connection to:', `companies/${testCompanyId}/approvalFlows/offer_approval`);
                
                const snapshot = await database.ref(`companies/${testCompanyId}/approvalFlows/offer_approval`).once('value');
                const approvalFlow = snapshot.val();
                
                console.log('?? Raw approval flow data:', approvalFlow);
                
                if (approvalFlow) {
                    // Check for selectedRoles structure
                    if (approvalFlow.selectedRoles) {
                        console.log('?? Selected roles found:', approvalFlow.selectedRoles);
                        
                        // Test specific path you mentioned
                        if (approvalFlow.selectedRoles.level1 && approvalFlow.selectedRoles.level1[0]) {
                            console.log('?? Level1[0] data:', approvalFlow.selectedRoles.level1[0]);
                            console.log('?? Text at level1[0]:', approvalFlow.selectedRoles.level1[0].text);
                        }
                    }
                    
                    // Check for levels structure
                    if (approvalFlow.levels) {
                        console.log('?? Levels found:', Object.keys(approvalFlow.levels));
                        
                        for (const [levelKey, level] of Object.entries(approvalFlow.levels)) {
                            console.log(`?? ${levelKey}:`, level);
                            
                            // Create a test level object with selectedRoles
                            const testLevel = {
                                ...level,
                                selectedRoles: approvalFlow.selectedRoles
                            };
                            
                            const approverText = await getApproverDisplayText(testLevel, testCompanyId);
                            console.log(`? ${levelKey} approver text:`, approverText);
                        }
                    }
                } else {
                    console.log('? No approval flow data found');
                }
                
                // Test rendering with the actual data structure
                if (approvalFlow) {
                    await renderApprovalFlow(approvalFlow, testCompanyId);
                    console.log('? Approval flow rendered successfully');
                } else {
                    console.log('? No approval flow data to render');
                }
                
            } catch (error) {
                console.error('? Error testing approval flow:', error);
            }
        }
        
        // File Preview Modal functions (reused from interview.html)
        function openFile(url, fileName, fileType) {
            // ... (implementation from interview.html can be reused or adapted)
            alert(`Preview file: ${fileName}`);
        }
        function closeFilePreview() {
            document.getElementById('filePreviewModal').style.display = 'none';
        }
        function downloadFile(url, fileName) {
            // ... (implementation from interview.html can be reused or adapted)
            alert(`Download file: ${fileName}`);
        }

        // User Profile Dropdown functionality (reused from interview.html)
        function initializeUserProfile() {
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });
                document.addEventListener('click', () => {
                    profileDropdown.classList.remove('show');
                });
                profileDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }
            loadUserInitials();
        }

        async function loadUserProfile() {
            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    await updateUIForAuthenticatedUser(user);
                    await loadCompanyBranding(); // Load company logo and name
                } else {
                    // Reset to default avatar
                    const userAvatar = document.getElementById('userAvatar');
                    if (userAvatar) {
                        userAvatar.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K";
                        userAvatar.alt = "User Avatar";
                    }
                    // Show fallback branding when not authenticated
                    showFallbackBranding();
                }
            });
        }

        async function updateUIForAuthenticatedUser(user) {
            const profileBtn = document.querySelector('.profile-btn');
            const profileDropdown = document.querySelector('.profile-dropdown ul');
            
            if (profileBtn && profileDropdown) {
                if (user) {
                    // Load user data from Firebase to get role and company info
                    try {
                        const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                        const userData = userSnapshot.val();
                        
                        if (userData) {
                            // Store current user with role and company info
                            currentUser = {
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName,
                                role: userData.role,
                                companyId: userData.companyId,
                                ...userData
                            };
                            
                            console.log('? User data loaded:', currentUser);
                            
                            // Update menu visibility based on user role
                            await updateMenuVisibility();
                        } else {
                            console.log('?? No user data found in database');
                            currentUser = {
                                uid: user.uid,
                                email: user.email,
                                displayName: user.displayName
                            };
                        }
                    } catch (error) {
                        console.error('? Error loading user data:', error);
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName
                        };
                    }
                    
                    // Use centralized display methods
                    const initials = getUserInitials(user);
                    const displayName = getUserDisplayName(user);
                    const email = getUserEmail(user);
                    
                    // Update profile image
                    const profileImg = profileBtn.querySelector('img');
                    let avatarUrl = null;
                    if (profileImg) {
                        // Try to get custom avatar or use initials
                        avatarUrl = await getUserAvatarUrl(user);
                        if (avatarUrl) {
                            profileImg.src = avatarUrl;
                            profileImg.alt = displayName + ' Avatar';
                        } else {
                            // Generate initials avatar
                            generateInitialsAvatar(displayName, profileImg);
                        }
                    }
                    
                    const safeDisplayName = escapeHtml(displayName);
                    const safeEmail = escapeHtml(email);
                    const avatarHtml = avatarUrl
                        ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`
                        : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${initials}</div>`;

                    // Update profile dropdown with user info
                    const userInfoHtml = `
                        <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${avatarHtml}
                                <div>
                                    <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                        ${safeDisplayName}
                                    </div>
                                    <div style="color: #666; font-size: 12px;">
                                        ${safeEmail}
                                    </div>
                                </div>
                            </div>
                        </li>
                        <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                        <li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>
                    `;
                    
                    profileDropdown.innerHTML = userInfoHtml;
                    const logoutLink = profileDropdown.querySelector('#logoutLink');
                    if (logoutLink) {
                        logoutLink.addEventListener('click', (event) => {
                            event.preventDefault();
                            logout();
                        });
                    }
                    
                    // Reload hired candidates now that we have company context
                    if (currentUser && currentUser.companyId) {
                        console.log('?? Reloading hired candidates for company:', currentUser.companyId);
                        await loadHiredCandidates();
                        
                        // Also reload offers for the current tab now that we have company context
                        console.log('?? Reloading offers for current tab:', currentTab);
                        if (currentTab === 'pendingOffers') {
                            loadPendingOffers();
                        } else if (currentTab === 'acceptedOffers') {
                            loadAcceptedOffers();
                        } else if (currentTab === 'declinedOffers') {
                            loadRejectedOffers();
                        }
                        
                        // Update offer statistics
                        updateOfferStats();
                    }
                }
            }
        }

        function getUserInitials(user) {
            if (!user) return 'U';
            const displayName = user.displayName || user.email || 'User';
            const words = displayName.split(' ').filter(word => word.length > 0);
            if (words.length === 1) {
                return words[0].substring(0, 2).toUpperCase();
            } else {
                return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
            }
        }

        function getUserDisplayName(user) {
            const candidates = [];

            if (currentUser) {
                const firstLast = [currentUser.firstName, currentUser.lastName]
                    .filter(Boolean)
                    .join(' ')
                    .trim();

                candidates.push(
                    currentUser.fullName,
                    currentUser.name,
                    currentUser.displayName,
                    firstLast,
                    currentUser.username,
                    currentUser.preferredName
                );
            }

            if (user) {
                const firstLast = [user.firstName, user.lastName]
                    .filter(Boolean)
                    .join(' ')
                    .trim();

                candidates.push(
                    user.fullName,
                    user.name,
                    user.displayName,
                    firstLast,
                    user.username
                );
            }

            for (const value of candidates) {
                const cleaned = sanitizeName(value);
                if (cleaned) {
                    return cleaned;
                }
            }

            const fallbackEmail = user?.email || currentUser?.email;
            if (fallbackEmail) {
                const localPart = fallbackEmail.split('@')[0];
                const cleaned = sanitizeName(localPart);
                if (cleaned) {
                    return cleaned;
                }
            }

            return 'User';
        }

        function sanitizeName(value) {
            if (!value || typeof value !== 'string') {
                return null;
            }
            const trimmed = value.trim();
            return trimmed.length ? trimmed : null;
        }

        function getUserEmail(user) {
            return user?.email || 'No email';
        }

        // Get user avatar URL from Firebase Storage
        async function getUserAvatarUrl(user) {
            if (!user) return null;
            
            try {
                const storage = firebase.storage();
                const avatarPath = `avatars/${user.uid}/profile.jpg`;
                const avatarRef = storage.ref(avatarPath);
                
                return await avatarRef.getDownloadURL();
            } catch (error) {
                // No custom avatar found
                return null;
            }
        }

        function generateInitialsAvatar(name, imgElement) {
            if (!imgElement || !name) return;
            
            const initials = name.split(' ').filter(word => word.length > 0)
                .slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase() || 'U';
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const backgroundColor = colors[name.length % colors.length];
            
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                </svg>
            `;
            
            imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
            imgElement.alt = name + ' Avatar';
        }

        function loadUserInitials() {
            // This function is now replaced by loadUserProfile
            loadUserProfile();
        }

        // Utility function to escape HTML (reused)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Company branding functions
        let currentCompany = null;

        async function loadCompanyBranding() {
            console.log('?? loadCompanyBranding() called');
            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.log('? No authenticated user found');
                    showFallbackBranding();
                    return;
                }

                // Get user's company info from Firebase
                const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                const userData = userSnapshot.val();
                
                if (!userData || !userData.companyId) {
                    console.log('? No company ID found for user');
                    showFallbackBranding();
                    return;
                }

                // Get company data
                const companySnapshot = await database.ref(`companies/${userData.companyId}`).once('value');
                currentCompany = companySnapshot.val();
                
                if (!currentCompany) {
                    console.log('? Company data not found');
                    showFallbackBranding();
                    return;
                }

                console.log('? Company data loaded:', currentCompany.companyName);
                updateCompanyBranding();
                
            } catch (error) {
                console.error('? Error loading company branding:', error);
                showFallbackBranding();
            }
        }

        function updateCompanyBranding() {
            console.log('?? updateCompanyBranding() called');
            if (!currentCompany) {
                console.log('? No company data available for branding');
                showFallbackBranding();
                return;
            }

            console.log('? Company data found:', currentCompany.companyName);

            // Update company logo and name in header
            const headerLogo = document.getElementById('headerCompanyLogo');
            const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
            const headerCompanyName = document.getElementById('headerCompanyName');

            console.log('Header elements found:', {
                logo: headerLogo ? '?' : '?',
                placeholder: headerLogoPlaceholder ? '?' : '?',
                companyName: headerCompanyName ? '?' : '?'
            });

            // Update company name
            if (headerCompanyName) {
                headerCompanyName.textContent = currentCompany.companyName || '';
                console.log('? Company name updated:', headerCompanyName.textContent);
            }

            // Update logo or show placeholder
            if (currentCompany.logoUrl || currentCompany.logo) {
                const logoUrl = currentCompany.logoUrl || currentCompany.logo;
                console.log('? Company logo URL found:', logoUrl);
                
                if (headerLogo) {
                    headerLogo.src = logoUrl;
                    headerLogo.style.display = 'block';
                    headerLogo.classList.add('visible');
                    console.log('? Company logo displayed');
                }
                
                if (headerLogoPlaceholder) {
                    headerLogoPlaceholder.style.display = 'none';
                }
            } else {
                console.log('?? No company logo found, showing placeholder');
                if (headerLogoPlaceholder) {
                    headerLogoPlaceholder.style.display = 'flex';
                }
                if (headerLogo) {
                    headerLogo.style.display = 'none';
                }
            }

            // Update page title
            if (currentCompany.companyName) {
                const title = document.title;
                if (title.includes('Dreamex Datalab')) {
                    document.title = title.replace('Dreamex Datalab HSE', `${currentCompany.companyName} HSE`);
                    console.log('? Page title updated');
                }
            }
        }

        function showFallbackBranding() {
            console.log('?? Showing fallback branding');
            const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
            const headerCompanyName = document.getElementById('headerCompanyName');
            const headerLogo = document.getElementById('headerCompanyLogo');
            
            // Show placeholder logo
            if (headerLogoPlaceholder) {
                headerLogoPlaceholder.style.display = 'flex';
                console.log('? Fallback logo placeholder shown');
            }
            
            // Hide company logo
            if (headerLogo) {
                headerLogo.style.display = 'none';
                console.log('? Company logo hidden (fallback)');
            }
            
            // Set fallback company name
            if (headerCompanyName) {
                headerCompanyName.textContent = '';
                console.log('? Fallback company name cleared');
            }
        }

        // Role and permissions management functions
        let currentUser = null;

        async function updateMenuVisibility() {
            console.log('?? Starting menu visibility update...');
            
            // Add loading class to sidebar
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.add('menu-loading');
            }
            
            try {
                if (!currentUser) {
                    console.log('? No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // Get user's company ID and role
                const companyId = currentUser.companyId;
                const userRole = currentUser.role;
                
                if (!companyId || !userRole) {
                    console.log('? Missing company ID or user role');
                    resetMenuVisibility();
                    return;
                }
                
                console.log(`?? User: role=${userRole}, companyId=${companyId}`);
                
                // Special handling for administrator role
                if (userRole === 'administrator') {
                    console.log('?? ADMINISTRATOR ROLE DETECTED - Enhanced debugging');
                    console.log('?? Checking for administrator permissions in company roles');
                }
                
                // Get company role permissions
                const permissionsSnapshot = await database.ref(`companies/${companyId}/roles/${userRole}/permissions`).once('value');
                console.log(`?? Checking permissions at: companies/${companyId}/roles/${userRole}/permissions`);
                
                if (!permissionsSnapshot.exists()) {
                    console.log('?? No permissions found for user role in company');
                    
                    if (userRole === 'administrator') {
                        // For administrator, try to get default admin permissions
                        try {
                            const allRolesSnapshot = await database.ref(`companies/${companyId}/roles`).once('value');
                            const allRoles = allRolesSnapshot.val();
                            
                            if (allRoles && allRoles.administrator && allRoles.administrator.permissions) {
                                console.log('?? Found administrator permissions in company roles');
                                updateMenuWithPermissions(allRoles.administrator.permissions);
                                return;
                            } else {
                                console.log('?? No administrator permissions found, checking default roles');
                                const defaultRolesSnapshot = await database.ref('default-roles').once('value');
                                const defaultRoles = defaultRolesSnapshot.val();
                                
                                if (defaultRoles && defaultRoles.administrator && defaultRoles.administrator.permissions) {
                                    console.log('?? Using default administrator permissions');
                                    updateMenuWithPermissions(defaultRoles.administrator.permissions);
                                    return;
                                }
                            }
                        } catch (error) {
                            console.error('? Error checking administrator permissions:', error);
                        }
                        
                        // Final fallback for administrator
                        console.log('?? ADMINISTRATOR - Using full admin permissions as fallback');
                        const fullAdminPermissions = createDefaultAdministratorRole().permissions;
                        updateMenuWithPermissions(fullAdminPermissions);
                        return;
                    }
                    
                    // For non-admin roles, reset menu visibility
                    resetMenuVisibility();
                    return;
                }
                
                const permissions = permissionsSnapshot.val();
                console.log('? User permissions loaded:', permissions);
                
                // Special check for administrator with insufficient permissions
                if (userRole === 'administrator') {
                    const permissionCount = Object.keys(permissions || {}).length;
                    console.log(`?? Administrator has ${permissionCount} permissions`);
                    
                    if (permissionCount < 5) {
                        console.log('?? ADMINISTRATOR - Insufficient permissions found, using full admin permissions');
                        const fullAdminPermissions = createDefaultAdministratorRole().permissions;
                        updateMenuWithPermissions(fullAdminPermissions);
                        return;
                    }
                }
                
                updateMenuWithPermissions(permissions);
                
            } catch (error) {
                console.error('? Error updating menu visibility:', error);
                resetMenuVisibility();
            } finally {
                // Remove loading class
                showSidebarAfterAuth();
                
                // Refresh hired candidates when menu permissions are updated (company context is established)
                if (currentUser && currentUser.companyId) {
                    console.log('?? Refreshing hired candidates after menu update...');
                    loadHiredCandidates().catch(error => {
                        console.error('Error refreshing hired candidates:', error);
                    });
                }
            }
        }

        function updateMenuWithPermissions(permissions) {
            console.log('?? Updating menu with permissions...');
            console.log('?? Permissions object:', permissions);
            
            // Reset menu visibility first
            resetMenuVisibility();
            
            if (!permissions) {
                console.log('?? No permissions object provided');
                return;
            }
            
            // Update menu visibility based on permissions
            const menuItems = document.querySelectorAll('[data-feature]');
            console.log(`?? Found ${menuItems.length} menu items to check`);
            let visibleCount = 0;
            
            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                
                console.log(`?? Checking menu item: ${feature} (requires: ${requiresPermission})`);
                
                // If item doesn't require permission, show it
                if (!requiresPermission) {
                    item.classList.add('menu-visible');
                    visibleCount++;
                    console.log(`? Showing menu item (no permission required): ${feature}`);
                    return;
                }
                
                // If item requires permission, check if user has it
                if (feature && permissions[feature]) {
                    const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                    
                    if (hasViewPermission) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`? Showing menu item: ${feature}`);
                    } else {
                        console.log(`? No view permission for: ${feature}`);
                    }
                } else {
                    console.log(`? Feature not found in permissions: ${feature}`);
                }
            });
            
            // Handle parent dropdowns - show if they have visible children
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleSubmenuItems.length > 0) {
                    dropdown.classList.add('menu-visible');
                    console.log(`? Showing parent dropdown (has visible children)`);
                }
            });
            
            console.log(`?? Menu update complete. ${visibleCount} items visible.`);
        }

        function resetMenuVisibility() {
            console.log('?? Resetting menu visibility...');
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        function showSidebarAfterAuth() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar && sidebar.classList.contains('menu-loading')) {
                sidebar.classList.remove('menu-loading');
            }
        }

        function createDefaultAdministratorRole() {
            return {
                permissions: {
                    // Basic navigation
                    home_view: { view: true },
                    
                    // Health module
                    health_view: { view: true },
                    health_assessment_view: { view: true, create: true, edit: true, delete: true },
                    health_consultation_view: { view: true, create: true, edit: true, delete: true },
                    medical_folder_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Safety module
                    safety_view: { view: true },
                    training_view: { view: true, create: true, edit: true, delete: true },
                    risk_view: { view: true, create: true, edit: true, delete: true },
                    jsa_view: { view: true, create: true, edit: true, delete: true },
                    ptw_view: { view: true, create: true, edit: true, delete: true },
                    incident_view: { view: true, create: true, edit: true, delete: true },
                    inspection_view: { view: true, create: true, edit: true, delete: true },
                    audit_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Environment module (features exist but no permission required for parent)
                    environment_view: { view: true },
                    water_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Security module (features exist but no permission required for parent)
                    security_view: { view: true },
                    access_view: { view: true, create: true, edit: true, delete: true },
                    removal_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Logistics module
                    logistics_view: { view: true },
                    fleet_view: { view: true, create: true, edit: true, delete: true },
                    
                    // HR module
                    hr_view: { view: true },
                    human_hr_view: { view: true, create: true, edit: true, delete: true },
                    staff_management_view: { view: true, create: true, edit: true, delete: true },
                    authority_to_recruit_view: { view: true, create: true, edit: true, delete: true },
                    job_advertising_view: { view: true, create: true, edit: true, delete: true },
                    screening_view: { view: true, create: true, edit: true, delete: true },
                    interview_view: { view: true, create: true, edit: true, delete: true },
                    offer_view: { view: true, create: true, edit: true, delete: true },
                    contract_view: { view: true, create: true, edit: true, delete: true },
                    onboarding_view: { view: true, create: true, edit: true, delete: true },
                    kpi_dashboard_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Communication (feature exists but no permission required)
                    communication_view: { view: true, create: true, edit: true, delete: true },
                    
                    // Settings module (features exist but no permission required for most)
                    settings_view: { view: true },
                    account_settings_view: { view: true, edit: true },
                    company_management_view: { view: true, create: true, edit: true, delete: true },
                    approval_settings_view: { view: true, create: true, edit: true, delete: true },
                    field_setup_view: { view: true, create: true, edit: true, delete: true },
                    preferences_view: { view: true, edit: true },
                    notification_settings_view: { view: true, edit: true },
                    audit_log_view: { view: true },
                    user_management_view: { view: true, create: true, edit: true, delete: true },
                    role_permissions_view: { view: true, create: true, edit: true, delete: true }
                }
            };
        }

        // Logout function
        function logout() {
            console.log('?? User logging out...');
            
            // Clear current user data
            currentUser = null;
            
            // Reset menu visibility
            resetMenuVisibility();
            
            // Sign out from Firebase
            firebase.auth().signOut().then(() => {
                console.log('? User signed out successfully');
                // Redirect to login page
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error('? Error signing out:', error);
                // Still redirect to login even if there's an error
                window.location.href = 'login.html';
            });
        }        // Load and display offers from Firebase
        function loadOffers() {
            loadPendingOffers();
        }

        function loadPendingOffers() {
            console.log('?? Loading pending offers - currentUser:', currentUser);
            
            // Check if user has company context
            if (!currentUser || !currentUser.companyId) {
                console.warn('? No company context found for loading pending offers');
                document.getElementById('pendingOffersTable').style.display = 'none';
                document.getElementById('pendingOffersEmptyState').classList.remove('d-none');
                document.getElementById('pendingOffersLoadingState').style.display = 'none';
                return;
            }
            
            const companyId = currentUser.companyId;
            console.log('?? Querying pending offers for company:', companyId);
            console.log('?? Firebase path:', `companies/${companyId}/offers`);
            console.log('?? Full URL:', `https://users-8be65-default-rtdb.firebaseio.com/companies/${companyId}/offers`);
            
            // Load all offers from company scope and filter for pending/draft status
            const offersRef = database.ref(`companies/${companyId}/offers`);
            const tableBody = document.getElementById('pendingOffersTableBody');
            
            offersRef.on('value', (snapshot) => {
                const allOffers = snapshot.val();
                console.log('?? All offers query result:', allOffers ? Object.keys(allOffers).length : 0, 'total offers found');
                
                // Filter for pending, draft, and approved offers
                const pendingOffers = {};
                if (allOffers) {
                    Object.entries(allOffers).forEach(([id, offer]) => {
                        if (offer.status === 'pending' || offer.status === 'draft' || offer.status === 'sent' || offer.status === 'submitted' || offer.status === 'approved') {
                            pendingOffers[id] = offer;
                        }
                    });
                }
                
                console.log('?? Filtered pending/draft/approved offers:', Object.keys(pendingOffers).length, 'offers');
                
                tableBody.innerHTML = '';
                
                if (Object.keys(pendingOffers).length > 0) {
                    console.log('? Processing', Object.keys(pendingOffers).length, 'pending/draft/approved offers');
                    Object.entries(pendingOffers).forEach(([id, offer]) => {
                        console.log('?? Processing offer:', id, 'with candidate:', offer.candidateName);
                        const row = createPendingOfferRow(id, offer);
                        tableBody.appendChild(row);
                    });
                    document.getElementById('pendingOffersTable').style.display = 'table';
                    document.getElementById('pendingOffersEmptyState').classList.add('d-none');
                } else {
                    console.log('?? No pending/draft/approved offers found for company');
                    document.getElementById('pendingOffersTable').style.display = 'none';
                    document.getElementById('pendingOffersEmptyState').classList.remove('d-none');
                }
                document.getElementById('pendingOffersLoadingState').style.display = 'none';
            });
        }        // Helper function to get candidate full name from offer data
        function getCandidateFullName(offer) {
            console.log('?? Getting candidate name for offer:', offer);
            
            // First, check if we have a direct candidate full name in the offer
            if (offer.candidateName && typeof offer.candidateName === 'string') {
                // If candidateName contains a space, it's likely a full name
                if (offer.candidateName.includes(' ')) {
                    console.log('? Found full name in candidateName:', offer.candidateName);
                    return offer.candidateName;
                }
            }
            
            // Check if we have separate first and last names
            if (offer.candidateFirstName || offer.candidateLastName) {
                const fullName = `${offer.candidateFirstName || ''} ${offer.candidateLastName || ''}`.trim();
                if (fullName) {
                    console.log('? Constructed name from first/last:', fullName);
                    return fullName;
                }
            }
            
            // Try to look up from hired candidates data using candidateId
            const candidateId = offer.candidateId || offer.candidateName;
            if (candidateId && hiredCandidatesData && hiredCandidatesData[candidateId]) {
                const candidate = hiredCandidatesData[candidateId];
                const fullName = candidate.fullName || 
                       `${candidate.firstName || ''} ${candidate.lastName || ''}`.trim();
                if (fullName) {
                    console.log('? Found name in hired candidates data:', fullName);
                    return fullName;
                }
            }
            
            // Final fallback - try any name-related field
            const fallbackName = offer.candidateName || offer.applicantName || offer.name || 'N/A';
            console.log('?? Using fallback name:', fallbackName);
            return fallbackName;
        }        function createPendingOfferRow(offerId, offer) {
            const row = document.createElement('tr');
            const offerDate = offer.createdAt ? new Date(offer.createdAt).toLocaleDateString() : 'N/A';
            const expiryDate = offer.offerExpiryDate ? new Date(offer.offerExpiryDate).toLocaleDateString() : 'N/A';
            const salaryAmount = offer.baseSalary ? parseInt(offer.baseSalary).toLocaleString() : 'N/A';
            const currency = offer.currency || 'USD';
            const currencySymbol = currency === 'USD' ? '$' : '';
            
            // Get candidate full name using helper function
            const candidateFullName = getCandidateFullName(offer);
            console.log('?? Displaying candidate name in row:', candidateFullName, 'for offer:', offerId);
            
            // Determine status badge based on offer status
            let statusBadge = '<span class="status-badge status-pending">Pending</span>';
            switch (offer.status) {
                case 'draft':
                    statusBadge = '<span class="status-badge status-draft">Draft</span>';
                    break;
                case 'submitted':
                    statusBadge = '<span class="status-badge status-submitted">Submitted</span>';
                    break;
                case 'approved':
                    statusBadge = '<span class="status-badge status-approved">Approved</span>';
                    break;
                case 'declined':
                    statusBadge = '<span class="status-badge status-declined">Declined</span>';
                    break;
                case 'accepted':
                    statusBadge = '<span class="status-badge status-accepted">Accepted</span>';
                    break;
                case 'pending':
                case 'sent':
                    statusBadge = '<span class="status-badge status-pending">Pending</span>';
                    break;
                default:
                    statusBadge = `<span class="status-badge status-pending">${offer.status || 'Pending'}</span>`;
            }
            
            // Generate action buttons based on offer status
            let actionButtons = '';
            
            // Always show view and edit buttons
            actionButtons += `
                <button class="btn-action btn-view" onclick="viewOffer('${offerId}')" title="View Offer">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn-action btn-edit" onclick="editOffer('${offerId}')" title="Edit Offer">
                    <i class="fas fa-edit"></i>
                </button>`;
            
            // Show different buttons based on offer status
            switch (offer.status) {
                case 'submitted':
                    // Show approval buttons for submitted offers
                    actionButtons += `
                        <button class="btn-action btn-approve" onclick="approveOfferDirect('${offerId}')" title="Approve Offer">
                            <i class="fas fa-thumbs-up"></i>
                        </button>
                        <button class="btn-action btn-decline" onclick="declineOfferDirect('${offerId}')" title="Decline Offer">
                            <i class="fas fa-times"></i>
                        </button>`;
                    break;
                    
                case 'approved':
                    // Show "Mark as Accepted" button for approved offers
                    actionButtons += `
                        <button class="btn-action btn-accept" onclick="markAsAccepted('${offerId}')" title="Mark as Accepted">
                            <i class="fas fa-check"></i>
                        </button>`;
                    break;
                    
                case 'draft':
                case 'pending':
                    // For draft and pending offers, no special action buttons needed
                    break;
            }
            
            // Always show delete button for non-accepted offers
            if (offer.status !== 'accepted') {
                actionButtons += `
                    <button class="btn-action btn-delete" onclick="deleteOffer('${offerId}')" title="Delete Offer">
                        <i class="fas fa-trash"></i>
                    </button>`;
            }
            
            row.innerHTML = `
                <td><strong>${candidateFullName}</strong></td>
                <td>${offer.jobTitle || 'N/A'}</td>
                <td>${offerDate}</td>
                <td>${currencySymbol}${salaryAmount}</td>
                <td>${expiryDate}</td>
                <td>${statusBadge}</td>
                ${createFileUploadCell(offerId, offer.document)}
                <td class="actions-cell">
                    ${actionButtons}
                </td>
            `;
            
            // Add special styling for submitted offers awaiting approval
            if (offer.status === 'submitted') {
                row.classList.add('submitted-offer-row');
            }
            
            // Add click event listener to row (excluding actions cell)
            row.addEventListener('click', function(event) {
                // Don't trigger row click if clicking on buttons in actions cell
                if (!event.target.closest('.actions-cell')) {
                    console.log('??? Pending offer row clicked for offer ID:', offerId);
                    viewOffer(offerId);
                } else {
                    console.log('?? Click ignored - clicked on actions cell');
                }
            });
            
            // Add hover cursor style
            row.style.cursor = 'pointer';
            
            // Initialize drag and drop functionality after DOM is ready
            setTimeout(() => setupFileDragAndDrop(), 100);
            
            return row;
        }

        function viewOffer(offerId) {
            console.log('?? viewOffer called with offerId:', offerId);
            console.log('?? Firebase database object:', database);
            
            if (!database) {
                console.error('? Firebase database not initialized!');
                alert('Firebase database not initialized. Please refresh the page.');
                return;
            }
            
            // Check if user has company context
            if (!currentUser || !currentUser.companyId) {
                console.error('? No company context found!');
                alert('No company context found. Please login again.');
                return;
            }
            
            const companyId = currentUser.companyId;
            database.ref(`companies/${companyId}/offers/${offerId}`).once('value').then((snapshot) => {
                const offer = snapshot.val();
                console.log('?? Offer data retrieved for company:', companyId, offer);
                
                if (offer) {
                    console.log('?? Generating offer preview...');
                    const offerLetterHTML = generateOfferPreview(offer);
                    console.log('?? Generated offer preview HTML (length):', offerLetterHTML.length);
                    
                    const contentElement = document.getElementById('offerLetterContent');
                    console.log('?? offerLetterContent element found:', contentElement);
                    
                    if (contentElement) {
                        contentElement.innerHTML = offerLetterHTML;
                        console.log('? Updated offerLetterContent');
                    } else {
                        console.error('? offerLetterContent element not found!');
                        // Try to find it by class or other selector
                        const altElement = document.querySelector('.offer-letter-content');
                        console.log('?? Alternative content element:', altElement);
                        return;
                    }
                    
                    // Update preview modal buttons based on offer status
                    console.log('?? Updating preview modal buttons...');
                    updatePreviewModalButtons(offer, offerId);
                    console.log('? Updated preview modal buttons');
                    
                    // Load approval flow for the offer
                    console.log('?? Loading approval flow...');
                    loadApprovalFlow();
                    
                    const modal = document.getElementById('offerPreviewModal');
                    console.log('?? Modal element found:', modal);
                    console.log('?? Modal current display style:', modal ? modal.style.display : 'N/A');
                    console.log('?? Modal computed style:', modal ? window.getComputedStyle(modal).display : 'N/A');
                    
                    if (modal) {
                        // Clear any previous styles that might interfere
                        modal.style.display = 'flex';
                        modal.style.visibility = 'visible';
                        modal.style.opacity = '1';
                        modal.style.pointerEvents = 'auto';
                        modal.style.zIndex = '2000';
                        
                        console.log('? Modal display set to flex');
                        console.log('?? Modal display after setting:', modal.style.display);
                        console.log('?? Modal visibility after setting:', modal.style.visibility);
                        console.log('?? Modal opacity after setting:', modal.style.opacity);
                        
                        // Final check
                        setTimeout(() => {
                            console.log('?? Final modal check after 100ms:');
                            console.log('  - Display:', modal.style.display);
                            console.log('  - Visibility:', modal.style.visibility);
                            console.log('  - Opacity:', modal.style.opacity);
                            console.log('  - Z-index:', modal.style.zIndex);
                            console.log('  - Modal visible in DOM:', modal.offsetParent !== null);
                        }, 100);
                        
                    } else {
                        console.error('? Modal element not found!');
                        // Try alternative selectors
                        const altModal = document.querySelector('.offer-preview-modal');
                        console.log('?? Alternative modal element:', altModal);
                    }
                } else {
                    console.error('? No offer data found for ID:', offerId);
                    alert('Offer not found. The offer may have been deleted or moved.');
                }
            }).catch((error) => {
                console.error('? Error retrieving offer data:', error);
                alert('Error loading offer data: ' + error.message);
            });
        }

        // Test function to verify modal functionality
        function testModal() {
            console.log('?? Testing modal functionality...');
            
            const modal = document.getElementById('offerPreviewModal');
            const contentElement = document.getElementById('offerLetterContent');
            
            console.log('Modal element:', modal);
            console.log('Content element:', contentElement);
            
            if (modal && contentElement) {
                contentElement.innerHTML = '<h2>Test Modal Content</h2><p>This is a test to verify the modal is working.</p>';
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                console.log('? Test modal should now be visible');
                return true;
            } else {
                console.error('? Modal or content element not found');
                return false;
            }
        }

        // Test function specifically for row click debugging
        function testRowClick(testOfferId = 'test-123') {
            console.log('?? Testing row click functionality with test offer ID:', testOfferId);
            
            // Create a minimal test offer data
            const testOffer = {
                candidateName: 'John Test Candidate',
                jobTitle: 'Test Position',
                baseSalary: '75000',
                currency: 'USD',
                startDate: '2025-08-01',
                offerExpiryDate: '2025-08-15',
                status: 'pending',
                department: 'Test Department',
                location: 'Test Location',
                employmentType: 'Full-time'
            };
            
            console.log('?? Using test offer data:', testOffer);
            
            // Directly call viewOffer functionality
            const offerLetterHTML = generateOfferPreview(testOffer);
            console.log('?? Generated test offer preview HTML');
            
            const contentElement = document.getElementById('offerLetterContent');
            if (contentElement) {
                contentElement.innerHTML = offerLetterHTML;
                console.log('? Updated offerLetterContent with test data');
            } else {
                console.error('? offerLetterContent element not found!');
                return false;
            }
            
            // Update preview modal buttons
            updatePreviewModalButtons(testOffer, testOfferId);
            console.log('? Updated preview modal buttons');
            
            const modal = document.getElementById('offerPreviewModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                console.log('? Test modal should now be visible with test offer data');
                return true;
            } else {
                console.error('? Modal element not found!');
                return false;
            }
        }

        // Test function to verify all action buttons for different offer statuses
        function testAllActionButtons() {
            console.log('?? Testing all action buttons for different offer statuses...');
            
            const testStatuses = ['pending', 'approved', 'sent', 'accepted', 'declined', 'draft'];
            const testOfferId = 'test-action-buttons-123';
            
            testStatuses.forEach((status, index) => {
                setTimeout(() => {
                    console.log(`?? Testing buttons for status: ${status}`);
                    
                    const testOffer = {
                        candidateName: `Test Candidate ${index + 1}`,
                        jobTitle: `Test Position - ${status}`,
                        baseSalary: '75000',
                        currency: 'USD',
                        startDate: '2025-08-01',
                        offerExpiryDate: '2025-08-15',
                        status: status,
                        department: 'Test Department',
                        location: 'Test Location',
                        employmentType: 'Full-time'
                    };
                    
                    // Generate offer preview
                    const offerLetterHTML = generateOfferPreview(testOffer);
                    const contentElement = document.getElementById('offerLetterContent');
                    if (contentElement) {
                        contentElement.innerHTML = offerLetterHTML;
                    }
                    
                    // Update buttons for this status
                    updatePreviewModalButtons(testOffer, testOfferId);
                    
                    // Show modal
                    const modal = document.getElementById('offerPreviewModal');
                    if (modal) {
                        modal.style.display = 'flex';
                        modal.style.visibility = 'visible';
                        modal.style.opacity = '1';
                    }
                    
                    console.log(`? Buttons updated for ${status} status. Check the modal!`);
                    
                    // Log which buttons should be visible
                    const buttonsContainer = document.querySelector('.preview-action-buttons');
                    if (buttonsContainer) {
                        const visibleButtons = buttonsContainer.querySelectorAll('.btn');
                        console.log(`?? Visible buttons for ${status}:`, Array.from(visibleButtons).map(btn => btn.textContent.trim()));
                    }
                    
                }, index * 3000); // 3 second delay between each test
            });
            
            return true;
        }

        // Test function to verify staff.html modal button styling match
        function testStaffModalStyling() {
            console.log('?? Testing staff.html modal button styling match...');
            
            const testOffer = {
                candidateName: 'Style Test Candidate',
                jobTitle: 'Style Test Position',
                baseSalary: '75000',
                currency: 'USD',
                startDate: '2025-08-01',
                offerExpiryDate: '2025-08-15',
                status: 'approved',
                department: 'Test Department',
                location: 'Test Location',
                employmentType: 'Full-time'
            };
            
            // Generate offer preview
            const offerLetterHTML = generateOfferPreview(testOffer);
            const contentElement = document.getElementById('offerLetterContent');
            if (contentElement) {
                contentElement.innerHTML = offerLetterHTML;
            }
            
            // Update buttons with full set for approved status
            updatePreviewModalButtons(testOffer, 'style-test-123');
            
            // Show modal
            const modal = document.getElementById('offerPreviewModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
            }
            
            console.log('? Modal with staff.html button styling should now be visible!');
            console.log('?? Button styling features:');
            console.log('  - Transparent backgrounds with colored text');
            console.log('  - Hover effects with subtle background colors');
            console.log('  - Transform translateY(-1px) on hover');
            console.log('  - Consistent spacing and sizing');
            console.log('  - Same padding and border-radius as staff.html');
            
            return true;
        }

        function editOffer(offerId) {
            console.log('?? Opening edit modal for offer:', offerId);
            
            // Check if user has company context
            if (!currentUser || !currentUser.companyId) {
                alert('No company context found. Please login again.');
                return;
            }
            
            const companyId = currentUser.companyId;
            
            // Fetch the offer data from Firebase
            database.ref(`companies/${companyId}/offers/${offerId}`).once('value', (snapshot) => {
                const offerData = snapshot.val();
                if (!offerData) {
                    alert('Offer not found!');
                    return;
                }

                console.log('?? Loaded offer data for editing from company:', companyId, offerData);

                // Populate the edit form with current data
                populateEditForm(offerId, offerData);
                
                // Show the edit modal
                document.getElementById('editOfferModal').style.display = 'flex';
            }).catch((error) => {
                console.error('? Error loading offer data:', error);
                alert('Error loading offer data. Please try again.');
            });
        }

        function populateEditForm(offerId, offerData) {
            // Store offer ID
            document.getElementById('editOfferId').value = offerId;

            // Candidate Information (readonly)
            document.getElementById('editCandidateName').value = offerData.candidateName || '';
            document.getElementById('editCandidateEmail').value = offerData.candidateEmail || '';
            document.getElementById('editCandidatePhone').value = offerData.candidatePhone || '';
            document.getElementById('editCandidateAddress').value = offerData.candidateAddress || '';

            // Job Information (readonly)
            document.getElementById('editJobTitle').value = offerData.jobTitle || '';
            document.getElementById('editDepartment').value = offerData.department || '';
            document.getElementById('editLocation').value = offerData.location || '';
            document.getElementById('editEmploymentType').value = offerData.employmentType || '';

            // Offer Details (editable)
            document.getElementById('editOfferedSalary').value = offerData.offeredSalary || offerData.baseSalary || offerData.salary || '';
            document.getElementById('editSalaryType').value = offerData.salaryType || 'annual';
            document.getElementById('editStartDate').value = offerData.startDate || '';
            document.getElementById('editOfferExpiryDate').value = offerData.offerExpiryDate || '';
            document.getElementById('editProbationPeriod').value = offerData.probationPeriod || '';
            document.getElementById('editWorkSchedule').value = offerData.workSchedule || 'full-time';

            // Compensation & Benefits
            document.getElementById('editBonus').value = offerData.bonus || '';
            document.getElementById('editCurrency').value = offerData.currency || 'USD';
            document.getElementById('editSigningBonus').value = offerData.signingBonus || '';
            document.getElementById('editBenefits').value = offerData.benefits || '';
            document.getElementById('editSpecialTerms').value = offerData.specialTerms || '';
            document.getElementById('editTermsConditions').value = offerData.termsConditions || '';

            // Status and Notes
            document.getElementById('editOfferStatus').value = offerData.status || 'pending';
            document.getElementById('editOfferNotes').value = offerData.internalNotes || '';
            
            // Update edit modal buttons based on offer status
            updateEditModalButtons(offerData, offerId);
        }

        // Update edit modal buttons based on offer status
        function updateEditModalButtons(offer, offerId) {
            const modalFooter = document.querySelector('#editOfferModal .modal-footer');
            if (!modalFooter) return;
            
            const isApproved = offer && offer.status === 'approved';
            
            // Generate send button conditionally
            const sendButton = isApproved ? 
                `<button type="button" class="btn btn-success" onclick="sendExistingOffer('${offerId}')">
                    <i class="fas fa-paper-plane"></i> Send Offer
                </button>` : '';
            
            // Update the modal footer buttons
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" onclick="closeEditOfferModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveOfferChanges()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" class="btn btn-info" onclick="previewUpdatedOffer()">
                    <i class="fas fa-eye"></i> Preview Offer Letter
                </button>
                ${sendButton}
            `;
        }
        
        // Send existing offer (for approved offers only)
        function sendExistingOffer(offerId) {
            if (confirm('Send this offer to the candidate?')) {
                // Add your send offer logic here
                database.ref('offers/' + offerId).update({
                    sentAt: new Date().toISOString(),
                    status: 'sent',
                    updatedAt: new Date().toISOString()
                }).then(() => {
                    console.log('? Offer sent successfully');
                    showNotification('Offer sent successfully!', 'success');
                    closeEditOfferModal();
                    
                    // Refresh the current tab
                    const activeTab = document.querySelector('.tab-nav-btn.active');
                    if (activeTab) {
                        activeTab.click();
                    }
                }).catch((error) => {
                    console.error('? Error sending offer:', error);
                    showNotification('Error sending offer. Please try again.', 'error');
                });
            }
        }

        function closeEditOfferModal() {
            document.getElementById('editOfferModal').style.display = 'none';
            
            // Clear the form
            document.getElementById('editOfferForm').reset();
        }

        function saveOfferChanges() {
            const offerId = document.getElementById('editOfferId').value;
            if (!offerId) {
                alert('Error: Offer ID not found');
                return;
            }

            console.log('?? Saving offer changes for offer ID:', offerId);
            
            // Check if user has company context
            if (!currentUser || !currentUser.companyId) {
                alert('No company context found. Please login again.');
                return;
            }
            
            const companyId = currentUser.companyId;
            
            // Show saving notification
            showNotification('Saving changes...', 'info');

            // Get current data first to preserve any fields not in the edit form
            database.ref(`companies/${companyId}/offers/${offerId}`).once('value', (snapshot) => {
                const currentData = snapshot.val();
                if (!currentData) {
                    alert('Offer not found!');
                    return;
                }

                // Collect ALL updated data from form
                const updatedData = {
                    ...currentData, // Keep existing data as base
                    
                    // Candidate Information (readonly but preserve any updates)
                    candidateName: document.getElementById('editCandidateName').value || currentData.candidateName,
                    candidateEmail: document.getElementById('editCandidateEmail').value || currentData.candidateEmail,
                    candidatePhone: document.getElementById('editCandidatePhone').value || currentData.candidatePhone,
                    candidateAddress: document.getElementById('editCandidateAddress').value || currentData.candidateAddress,

                    // Job Information (readonly but preserve)
                    jobTitle: document.getElementById('editJobTitle').value || currentData.jobTitle,
                    department: document.getElementById('editDepartment').value || currentData.department,
                    location: document.getElementById('editLocation').value || currentData.location,
                    employmentType: document.getElementById('editEmploymentType').value || currentData.employmentType,

                    // Offer Details (editable fields)
                    offeredSalary: document.getElementById('editOfferedSalary').value ? 
                        parseFloat(document.getElementById('editOfferedSalary').value) : currentData.offeredSalary,
                    baseSalary: document.getElementById('editOfferedSalary').value ? 
                        parseFloat(document.getElementById('editOfferedSalary').value) : currentData.baseSalary, // Keep both for compatibility
                    salaryType: document.getElementById('editSalaryType').value || currentData.salaryType,
                    startDate: document.getElementById('editStartDate').value || currentData.startDate,
                    offerExpiryDate: document.getElementById('editOfferExpiryDate').value || currentData.offerExpiryDate,
                    probationPeriod: document.getElementById('editProbationPeriod').value || currentData.probationPeriod,
                    workSchedule: document.getElementById('editWorkSchedule').value || currentData.workSchedule,

                    // Compensation & Benefits
                    bonus: document.getElementById('editBonus').value ? 
                        parseFloat(document.getElementById('editBonus').value) : (currentData.bonus || 0),
                    currency: document.getElementById('editCurrency').value || currentData.currency || 'USD',
                    signingBonus: document.getElementById('editSigningBonus').value ? 
                        parseFloat(document.getElementById('editSigningBonus').value) : (currentData.signingBonus || 0),
                    benefits: document.getElementById('editBenefits').value || currentData.benefits || '',
                    specialTerms: document.getElementById('editSpecialTerms').value || currentData.specialTerms || '',
                    termsConditions: document.getElementById('editTermsConditions').value || currentData.termsConditions || '',

                    // Status and Notes
                    status: document.getElementById('editOfferStatus').value || currentData.status,
                    internalNotes: document.getElementById('editOfferNotes').value || currentData.internalNotes || '',

                    // Metadata
                    lastModified: new Date().toISOString(),
                    updatedAt: new Date().toISOString(), // For compatibility
                    modifiedBy: currentUser ? currentUser.email : 'Unknown'
                };

                // Enhanced validation for required fields
                const requiredFields = [
                    { field: 'offeredSalary', name: 'Offered Salary' },
                    { field: 'offerExpiryDate', name: 'Offer Expiry Date' },
                    { field: 'startDate', name: 'Start Date' }
                ];

                for (const req of requiredFields) {
                    if (!updatedData[req.field]) {
                        alert(`Please fill in the required field: ${req.name}`);
                        document.getElementById(`edit${req.field.charAt(0).toUpperCase() + req.field.slice(1)}`).focus();
                        return;
                    }
                }

                // Date validation
                const startDate = new Date(updatedData.startDate);
                const expiryDate = new Date(updatedData.offerExpiryDate);
                const today = new Date();

                if (expiryDate < today) {
                    alert('Offer expiry date cannot be in the past.');
                    document.getElementById('editOfferExpiryDate').focus();
                    return;
                }

                console.log('?? Updating offer with data:', updatedData);

                // Save to company-scoped Firebase path with real-time update
                database.ref(`companies/${companyId}/offers/${offerId}`).update(updatedData)
                    .then(() => {
                        console.log('? Offer updated successfully in Firebase for company:', companyId);
                        showNotification('Offer updated successfully!', 'success');
                        
                        // Update the edit modal buttons in case status changed
                        updateEditModalButtons(updatedData, offerId);
                        
                        // Close edit modal
                        closeEditOfferModal();
                        
                        // Refresh the current tab to show updated data
                        refreshCurrentOfferView();
                        
                        // Update statistics
                        updateOfferStats();
                    })
                    .catch((error) => {
                        console.error('? Error updating offer in Firebase:', error);
                        showNotification('Error updating offer. Please try again.', 'error');
                    });
            }).catch((error) => {
                console.error('? Error retrieving current offer data:', error);
                alert('Error retrieving offer data. Please try again.');
            });
        }

        // Refresh the current offer view to show updated data
        function refreshCurrentOfferView() {
            console.log('?? Refreshing current offer view...');
            
            // Get the currently active tab
            const activeTabBtn = document.querySelector('.tab-nav-btn.active');
            if (activeTabBtn) {
                const tabName = activeTabBtn.id.replace('TabBtn', '');
                console.log('?? Refreshing tab:', tabName);
                
                // Reload the data for the current tab
                switch (tabName) {
                    case 'pendingOffers':
                        loadPendingOffers();
                        break;
                    case 'acceptedOffers':
                        loadAcceptedOffers();
                        break;
                    case 'declinedOffers':
                        loadRejectedOffers();
                        break;
                    case 'archivedOffers':
                        // Add archived offers loading if it exists
                        if (typeof loadArchivedOffers === 'function') {
                            loadArchivedOffers();
                        }
                        break;
                    default:
                        console.log('?? Unknown tab, refreshing pending offers as default');
                        loadPendingOffers();
                }
            } else {
                // Fallback: refresh pending offers
                console.log('?? No active tab found, refreshing pending offers as fallback');
                loadPendingOffers();
            }
        }

        function previewUpdatedOffer() {
            const offerId = document.getElementById('editOfferId').value;
            if (!offerId) {
                alert('Error: Offer ID not found');
                return;
            }

            console.log('?? Generating preview for updated offer...');
            
            // Get the updated data from the form
            const formData = {
                candidateName: document.getElementById('editCandidateName').value,
                candidateEmail: document.getElementById('editCandidateEmail').value,
                candidatePhone: document.getElementById('editCandidatePhone').value,
                candidateAddress: document.getElementById('editCandidateAddress').value,
                jobTitle: document.getElementById('editJobTitle').value,
                department: document.getElementById('editDepartment').value,
                location: document.getElementById('editLocation').value,
                employmentType: document.getElementById('editEmploymentType').value,
                offeredSalary: parseFloat(document.getElementById('editOfferedSalary').value),
                salaryType: document.getElementById('editSalaryType').value,
                startDate: document.getElementById('editStartDate').value,
                offerExpiryDate: document.getElementById('editOfferExpiryDate').value,
                probationPeriod: document.getElementById('editProbationPeriod').value,
                workSchedule: document.getElementById('editWorkSchedule').value,
                bonus: document.getElementById('editBonus').value,
                currency: document.getElementById('editCurrency').value,
                signingBonus: document.getElementById('editSigningBonus').value,
                benefits: document.getElementById('editBenefits').value,
                specialTerms: document.getElementById('editSpecialTerms').value,
                termsConditions: document.getElementById('editTermsConditions').value,
                status: document.getElementById('editOfferStatus').value
            };

            // Generate offer letter preview with updated data
            const offerLetterHTML = generateOfferPreview(formData);
            document.getElementById('offerLetterContent').innerHTML = offerLetterHTML;
            
            // Update preview modal buttons based on the current offer status
            updatePreviewModalButtons(formData, offerId);
            
            // Show preview modal
            document.getElementById('offerPreviewModal').style.display = 'flex';
        }        function deleteOffer(offerId) {
            if (confirm('Are you sure you want to delete this offer?')) {
                // Check if user has company context
                if (!currentUser || !currentUser.companyId) {
                    alert('No company context found. Please login again.');
                    return;
                }
                
                const companyId = currentUser.companyId;
                database.ref(`companies/${companyId}/offers/${offerId}`).remove()
                    .then(() => {
                        showNotification('Offer deleted successfully', 'success');
                    })
                    .catch((error) => {
                        console.error('Error deleting offer:', error);
                        showNotification('Error deleting offer', 'error');
                    });
            }
        }        function markAsAccepted(offerId) {
            if (confirm('Mark this offer as accepted?')) {
                // Check if user has company context
                if (!currentUser || !currentUser.companyId) {
                    alert('No company context found. Please login again.');
                    return;
                }
                
                const companyId = currentUser.companyId;
                
                // First, get the complete offer data
                database.ref(`companies/${companyId}/offers/${offerId}`).once('value', (snapshot) => {
                    const offerData = snapshot.val();
                    if (!offerData) {
                        showNotification('Offer not found', 'error');
                        return;
                    }

                    // Prepare the accepted offer data
                    const acceptedOfferData = {
                        ...offerData,
                        status: 'accepted',
                        acceptedAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        originalOfferId: offerId // Keep reference to original offer
                    };

                    // Prepare updates for both paths within company scope
                    const updates = {};
                    
                    // Update the original offer status
                    updates[`companies/${companyId}/offers/${offerId}/status`] = 'accepted';
                    updates[`companies/${companyId}/offers/${offerId}/acceptedAt`] = new Date().toISOString();
                    updates[`companies/${companyId}/offers/${offerId}/updatedAt`] = new Date().toISOString();
                    
                    // Store complete data in company-scoped acceptedoffer path
                    updates[`companies/${companyId}/acceptedoffers/${offerId}`] = acceptedOfferData;

                    // Perform atomic update to both paths
                    database.ref().update(updates).then(() => {
                        console.log('Offer accepted and stored in company-scoped acceptedoffer path for company:', companyId);
                        showNotification('Offer marked as accepted successfully!', 'success');
                        
                        // Refresh both current tab and update stats
                        if (currentTab === 'pendingOffers') {
                            loadPendingOffers();
                        } else if (currentTab === 'acceptedOffers') {
                            loadAcceptedOffers();
                        }
                        updateOfferStats(); // Update the statistics
                    }).catch((error) => {
                        console.error('Error updating offer:', error);
                        showNotification('Error updating offer', 'error');
                    });
                }).catch((error) => {
                    console.error('Error retrieving offer data:', error);
                    showNotification('Error retrieving offer data', 'error');
                });
            }
        }
        
        // Simple approval functions for direct offer approve/decline (not approval flow)
        function approveOfferDirect(offerId) {
            if (confirm('Approve this offer? This will mark it as ready for sending to the candidate.')) {
                // Check if user has company context
                if (!currentUser || !currentUser.companyId) {
                    alert('No company context found. Please login again.');
                    return;
                }
                
                const companyId = currentUser.companyId;
                
                // Show processing notification
                showNotification('Processing approval...', 'info');
                
                database.ref(`companies/${companyId}/offers/${offerId}`).update({
                    status: 'approved',
                    approvedAt: new Date().toISOString(),
                    approvedBy: currentUser.uid,
                    updatedAt: new Date().toISOString()
                }).then(() => {
                    showNotification('? Offer approved successfully!', 'success');
                    // Refresh current tab and update stats
                    if (currentTab === 'pendingOffers') {
                        loadPendingOffers();
                    } else if (currentTab === 'acceptedOffers') {
                        loadAcceptedOffers();
                    }
                    updateOfferStats();
                }).catch((error) => {
                    console.error('Error approving offer:', error);
                    showNotification('? Error approving offer: ' + error.message, 'error');
                });
            }
        }
        
        function declineOfferDirect(offerId) {
            const reason = prompt('Please provide a reason for declining this offer:');
            if (reason !== null && reason.trim() !== '') {
                // Check if user has company context
                if (!currentUser || !currentUser.companyId) {
                    alert('No company context found. Please login again.');
                    return;
                }
                
                const companyId = currentUser.companyId;
                
                // Show processing notification
                showNotification('Processing decline...', 'info');
                
                database.ref(`companies/${companyId}/offers/${offerId}`).update({
                    status: 'declined',
                    declinedAt: new Date().toISOString(),
                    declinedBy: currentUser.uid,
                    declineReason: reason.trim(),
                    updatedAt: new Date().toISOString()
                }).then(() => {
                    showNotification('? Offer declined successfully.', 'success');
                    // Refresh current tab and update stats
                    if (currentTab === 'pendingOffers') {
                        loadPendingOffers();
                    } else if (currentTab === 'declinedOffers') {
                        loadRejectedOffers();
                    }
                    updateOfferStats();
                }).catch((error) => {
                    console.error('Error declining offer:', error);
                    showNotification('? Error declining offer: ' + error.message, 'error');
                });
            } else if (reason !== null) {
                alert('A reason must be provided to decline an offer.');
            }
        }
        
        function loadAcceptedOffers() {
            console.log('Loading accepted offers...');
            showLoadingState('acceptedOffers');
            
            // Check if user has company context
            if (!currentUser || !currentUser.companyId) {
                console.log('No company context found for loading accepted offers');
                hideLoadingState('acceptedOffers');
                return;
            }
            
            const companyId = currentUser.companyId;
            
            // Use real-time listener for live updates from company-scoped path
            database.ref(`companies/${companyId}/offers`).orderByChild('status').equalTo('accepted').on('value', (snapshot) => {
                const acceptedOffersData = snapshot.val() || {};
                console.log('Accepted offers data for company:', companyId, acceptedOffersData);
                
                hideLoadingState('acceptedOffers');
                
                if (Object.keys(acceptedOffersData).length === 0) {
                    showEmptyState('acceptedOffers', true);
                    return;
                }
                
                showEmptyState('acceptedOffers', false);
                renderAcceptedOffers(acceptedOffersData);
            }, (error) => {
                console.error('Error loading accepted offers:', error);
                hideLoadingState('acceptedOffers');
                showNotification('Error loading accepted offers', 'error');
            });
        }

        function renderAcceptedOffers(acceptedOffersData) {
            const tableBody = acceptedOffersTableBody;
            const table = acceptedOffersTable;
            
            tableBody.innerHTML = '';
            
            Object.entries(acceptedOffersData).forEach(([offerId, offer]) => {
                const row = createAcceptedOfferRow(offerId, offer);
                tableBody.appendChild(row);
            });
            
            table.style.display = 'table';
        }

        function createAcceptedOfferRow(offerId, offer) {
            const row = document.createElement('tr');
            
            const candidateName = getCandidateFullName(offer);
            const jobTitle = offer.jobTitle || 'N/A';
            const acceptedDate = offer.acceptedAt ? new Date(offer.acceptedAt).toLocaleDateString() : 'N/A';
            const offerDate = offer.createdAt ? new Date(offer.createdAt).toLocaleDateString() : 'N/A';
            
            row.innerHTML = `
                <td>
                    <div class="candidate-info">
                        <div class="candidate-avatar">${candidateName.charAt(0).toUpperCase()}</div>
                        <div class="candidate-details">
                            <div class="candidate-name">${escapeHtml(candidateName)}</div>
                            <div class="candidate-email">${escapeHtml(offer.candidateEmail || 'N/A')}</div>
                        </div>
                    </div>
                </td>
                <td>${escapeHtml(jobTitle)}</td>
                <td>${offerDate}</td>
                <td>${acceptedDate}</td>
                <td>
                    <span class="status-badge status-offer-accepted">Accepted</span>
                </td>
                ${createFileUploadCell(offerId, offer.document)}
                <td class="actions-cell">
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewOffer('${offerId}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-edit" onclick="editOffer('${offerId}')" title="Edit Offer">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-download" onclick="downloadOfferLetter('${offerId}')" title="Download Offer Letter">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // Add click event listener to row (excluding actions cell)
            row.addEventListener('click', function(event) {
                // Don't trigger row click if clicking on buttons in actions cell
                if (!event.target.closest('.actions-cell')) {
                    viewOffer(offerId);
                }
            });
            
            // Add hover cursor style
            row.style.cursor = 'pointer';
            
            // Initialize drag and drop functionality after DOM is ready
            setTimeout(() => setupFileDragAndDrop(), 100);
            
            return row;
        }

        function downloadOfferLetter(offerId) {
            console.log('?? Downloading offer letter PDF for:', offerId);
            
            // Check if user has company context
            if (!currentUser || !currentUser.companyId) {
                alert('No company context found. Please login again.');
                return;
            }
            
            const companyId = currentUser.companyId;
            
            // Show loading notification
            showNotification('Generating PDF...', 'info');
            
            // Ensure company data is loaded before generating PDF
            const loadCompanyDataPromise = currentCompany ? 
                Promise.resolve(currentCompany) : 
                database.ref(`companies/${companyId}`).once('value').then(snapshot => snapshot.val());
            
            // Get offer data from Firebase
            Promise.all([
                database.ref(`companies/${companyId}/offers/${offerId}`).once('value'),
                loadCompanyDataPromise
            ]).then(async ([offerSnapshot, companyData]) => {
                const offer = offerSnapshot.val();
                
                if (!offer) {
                    showNotification('Offer not found', 'error');
                    return;
                }
                
                // Update currentCompany if needed
                if (companyData && !currentCompany) {
                    currentCompany = companyData;
                }
                
                console.log('?? Offer data retrieved for PDF:', offer);
                console.log('?? Company data for PDF:', currentCompany);
                
                try {
                    // Create PDF using jsPDF with A4 format
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Set up PDF styling for A4 format
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    const lineHeight = 7;
                    let currentY = margin;
                    
                    // Helper function to add text with word wrap
                    function addText(text, x, y, options = {}) {
                        const maxWidth = options.maxWidth || (pageWidth - 2 * margin);
                        const fontSize = options.fontSize || 12;
                        const fontStyle = options.fontStyle || 'normal';
                        
                        doc.setFontSize(fontSize);
                        doc.setFont('helvetica', fontStyle);
                        
                        if (text && text.length > 0) {
                            const lines = doc.splitTextToSize(text, maxWidth);
                            lines.forEach((line, index) => {
                                doc.text(line, x, y + (index * lineHeight));
                            });
                            return y + (lines.length * lineHeight);
                        }
                        return y;
                    }
                    
                    // Helper function to add section header
                    function addSectionHeader(title, y) {
                        doc.setFontSize(14);
                        doc.setFont('helvetica', 'bold');
                        doc.text(title, margin, y);
                        // Add underline
                        doc.line(margin, y + 2, pageWidth - margin, y + 2);
                        return y + 12;
                    }
                    
                    // Helper function to add company logo and header
                    async function addCompanyHeader() {
                        console.log('?? Starting company header generation...');
                        console.log('?? Current company data:', currentCompany);
                        
                        const companyName = currentCompany?.companyName || 'DREAMEX DATALAB HSE';
                        
                        // Try to add company logo if available
                        if (currentCompany && (currentCompany.logoUrl || currentCompany.logo)) {
                            try {
                                const logoUrl = currentCompany.logoUrl || currentCompany.logo;
                                console.log('?? Attempting to add company logo to PDF:', logoUrl);
                                
                                // Create a promise to load the image with timeout
                                const loadImage = new Promise((resolve, reject) => {
                                    const img = new Image();
                                    
                                    // Set timeout for image loading
                                    const timeout = setTimeout(() => {
                                        console.warn('? Image loading timeout');
                                        reject(new Error('Image loading timeout'));
                                    }, 10000); // 10 second timeout
                                    
                                    img.onload = () => {
                                        clearTimeout(timeout);
                                        console.log('? Logo image loaded successfully:', {
                                            width: img.width,
                                            height: img.height,
                                            naturalWidth: img.naturalWidth,
                                            naturalHeight: img.naturalHeight
                                        });
                                        resolve(img);
                                    };
                                    
                                    img.onerror = (error) => {
                                        clearTimeout(timeout);
                                        console.error('? Failed to load logo image:', error);
                                        console.error('? Image src:', img.src);
                                        reject(new Error('Failed to load logo image'));
                                    };
                                    
                                    // Try different approaches for loading
                                    img.crossOrigin = 'anonymous';
                                    img.src = logoUrl;
                                });
                                
                                try {
                                    const img = await loadImage;
                                    
                                    // Calculate image dimensions to fit within constraints
                                    const maxWidth = 60; // mm
                                    const maxHeight = 30; // mm
                                    let imgWidth = img.naturalWidth || img.width;
                                    let imgHeight = img.naturalHeight || img.height;
                                    
                                    // Convert pixels to mm (more accurate conversion: 96 DPI)
                                    const pixelToMm = 25.4 / 96; // 25.4mm per inch, 96 pixels per inch
                                    imgWidth *= pixelToMm;
                                    imgHeight *= pixelToMm;
                                    
                                    // Scale to fit within max dimensions
                                    const widthRatio = maxWidth / imgWidth;
                                    const heightRatio = maxHeight / imgHeight;
                                    const scale = Math.min(widthRatio, heightRatio, 1);
                                    
                                    const finalWidth = imgWidth * scale;
                                    const finalHeight = imgHeight * scale;
                                    
                                    // Position logo at left margin
                                    const logoX = margin;
                                    
                                    // Determine image format for jsPDF
                                    let imageFormat = 'JPEG';
                                    const lowerUrl = logoUrl.toLowerCase();
                                    if (lowerUrl.includes('.png') || lowerUrl.includes('png')) {
                                        imageFormat = 'PNG';
                                    } else if (lowerUrl.includes('.jpg') || lowerUrl.includes('.jpeg') || lowerUrl.includes('jpg') || lowerUrl.includes('jpeg')) {
                                        imageFormat = 'JPEG';
                                    } else if (lowerUrl.includes('.gif') || lowerUrl.includes('gif')) {
                                        imageFormat = 'GIF';
                                    }
                                    
                                    console.log('?? Adding logo to PDF with details:', {
                                        format: imageFormat,
                                        originalSize: { width: img.width, height: img.height },
                                        naturalSize: { width: img.naturalWidth, height: img.naturalHeight },
                                        finalSize: { width: finalWidth, height: finalHeight },
                                        position: { x: logoX, y: currentY },
                                        scale: scale
                                    });
                                    
                                    // Add logo to PDF
                                    doc.addImage(img, imageFormat, logoX, currentY, finalWidth, finalHeight);
                                    currentY += finalHeight + 8; // Extra spacing after logo
                                    
                                    console.log('? Company logo added to PDF successfully');
                                } catch (imgError) {
                                    console.warn('?? Failed to process company logo for PDF:', imgError);
                                    console.warn('?? Falling back to text-only header');
                                    // Continue with text-only header
                                }
                            } catch (error) {
                                console.warn('?? Error setting up company logo for PDF:', error);
                                // Continue with text-only header
                            }
                        } else {
                            console.log('?? No company logo available, using text-only header');
                        }
                        
                        // Add company name
                        doc.setFontSize(18);
                        doc.setFont('helvetica', 'bold');
                        doc.text(companyName, margin, currentY);
                        currentY += 10;
                        
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'normal');
                        doc.text('EMPLOYMENT OFFER LETTER', margin, currentY);
                        currentY += 20;
                        
                        console.log('? Company header completed, currentY:', currentY);
                    }
                    
                    // Add company header (with logo if available)
                    await addCompanyHeader();
                    
                    // Add company address section (matching preview)
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    const addressLines = [
                        'Health, Safety & Environmental Solutions',
                        '1234 Corporate Drive, Suite 100',
                        'Business City, State 12345',
                        'Phone: (555) 123-4567 | Email: hr@dreamexdatalab.com'
                    ];
                    addressLines.forEach(line => {
                        doc.text(line, margin, currentY);
                        currentY += 5;
                    });
                    currentY += 10;
                    
                    // Date (matching preview format)
                    const currentDate = new Date().toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    doc.setFontSize(12);
                    doc.text(currentDate, margin, currentY);
                    currentY += 20;
                    
                    // Recipient Information (matching preview)
                    const candidateName = offer.candidateName || '[Candidate Name]';
                    const candidateEmail = offer.candidateEmail || '[Email Address]';
                    const candidateAddress = offer.candidateAddress || '[Candidate Address]';
                    
                    doc.setFont('helvetica', 'bold');
                    currentY = addText(candidateName, margin, currentY) + 5;
                    doc.setFont('helvetica', 'normal');
                    currentY = addText(candidateAddress, margin, currentY) + 5;
                    currentY = addText(candidateEmail, margin, currentY) + 15;
                    
                    // Subject line (matching preview)
                    const jobTitle = offer.jobTitle || '[Job Title]';
                    doc.setFont('helvetica', 'bold');
                    currentY = addText(`Subject: Job Offer - ${jobTitle}`, margin, currentY) + 10;
                    
                    // Greeting and opening paragraph (matching preview)
                    doc.setFont('helvetica', 'normal');
                    currentY = addText(`Dear ${candidateName},`, margin, currentY) + 8;
                    
                    const openingText = `We are delighted to extend an offer of employment to you for the position of ${jobTitle} with Dreamex Datalab HSE. After careful consideration of your qualifications and interview performance, we believe you will be an excellent addition to our team.`;
                    currentY = addText(openingText, margin, currentY) + 15;
                    
                    // Position Details Section (matching preview table format)
                    currentY = addSectionHeader('Position Details', currentY);
                    
                    const department = offer.department || 'TBD';
                    const location = offer.location || 'TBD';
                    const employmentType = offer.employmentType || 'Full-time';
                    const workSchedule = offer.workSchedule || 'Standard business hours';
                    const startDate = offer.startDate ? new Date(offer.startDate).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    }) : 'TBD';
                    
                    // Create table-like structure for position details
                    const positionDetails = [
                        ['Job Title:', jobTitle],
                        ['Department:', department],
                        ['Work Location:', location],
                        ['Employment Type:', employmentType],
                        ['Work Schedule:', workSchedule],
                        ['Start Date:', startDate]
                    ];
                    
                    if (offer.probationPeriod) {
                        positionDetails.push(['Probation Period:', `${offer.probationPeriod} months`]);
                    }
                    
                    positionDetails.forEach(([label, value]) => {
                        doc.setFont('helvetica', 'bold');
                        doc.text(label, margin, currentY);
                        doc.setFont('helvetica', 'normal');
                        doc.text(value, margin + 50, currentY);
                        currentY += 6;
                    });
                    currentY += 10;
                    
                    // Compensation Package Section (matching preview)
                    currentY = addSectionHeader('Compensation Package', currentY);
                    
                    const baseSalary = offer.baseSalary ? parseFloat(offer.baseSalary).toLocaleString() : 'TBD';
                    const currency = offer.currency || 'USD';
                    const currencySymbol = currency === 'USD' ? '$' : currency === 'EUR' ? '' : currency === 'GBP' ? '' : '$';
                    
                    const compensationDetails = [
                        ['Base Salary:', `${currencySymbol}${baseSalary} annually`],
                        ['Pay Frequency:', 'Bi-weekly']
                    ];
                    
                    if (offer.bonus) {
                        compensationDetails.splice(1, 0, ['Performance Bonus:', `Up to ${offer.bonus}% of base salary`]);
                    }
                    
                    if (offer.signingBonus) {
                        const signingBonusFormatted = parseInt(offer.signingBonus).toLocaleString();
                        compensationDetails.splice(-1, 0, ['Signing Bonus:', `${currencySymbol}${signingBonusFormatted}`]);
                    }
                    
                    compensationDetails.forEach(([label, value]) => {
                        doc.setFont('helvetica', 'bold');
                        doc.text(label, margin, currentY);
                        doc.setFont('helvetica', 'normal');
                        if (label === 'Base Salary:') {
                            doc.setFont('helvetica', 'bold');
                        }
                        doc.text(value, margin + 50, currentY);
                        doc.setFont('helvetica', 'normal');
                        currentY += 6;
                    });
                    currentY += 10;
                    
                    // Benefits Package Section (matching preview)
                    currentY = addSectionHeader('Benefits Package', currentY);
                    
                    currentY = addText('In addition to your base compensation, you will be eligible for our comprehensive benefits package, which includes:', margin, currentY) + 8;
                    
                    // Process benefits like in the preview
                    let benefitsList = ['Standard benefits package as per company policy'];
                    
                    if (offer.benefits) {
                        let benefitsArray = [];
                        
                        if (Array.isArray(offer.benefits)) {
                            benefitsArray = offer.benefits;
                        } else if (typeof offer.benefits === 'string') {
                            if (offer.benefits.includes(',')) {
                                benefitsArray = offer.benefits.split(',').map(b => b.trim());
                            } else if (offer.benefits.trim()) {
                                benefitsArray = [offer.benefits.trim()];
                            }
                        }
                        
                        if (benefitsArray.length > 0) {
                            const benefitNames = {
                                'health-insurance': 'Comprehensive Health Insurance',
                                'dental': 'Dental Coverage',
                                'vision': 'Vision Coverage',
                                'retirement': '401(k) Retirement Plan with Company Matching',
                                'pto': 'Paid Time Off (PTO)',
                                'flexible-work': 'Flexible Work Arrangements'
                            };
                            
                            benefitsList = benefitsArray.map(benefit => 
                                benefitNames[benefit] || benefit
                            );
                        }
                    }
                    
                    // Add benefits as bullet points
                    benefitsList.forEach(benefit => {
                        currentY = addText(` ${benefit}`, margin + 5, currentY) + 5;
                    });
                    currentY += 10;
                    
                    // Special Terms & Conditions (if present)
                    if (offer.specialTerms) {
                        currentY = addSectionHeader('Special Terms & Conditions', currentY);
                        currentY = addText(offer.specialTerms, margin, currentY) + 15;
                    }
                    
                    // Next Steps Section (matching preview)
                    currentY = addSectionHeader('Next Steps', currentY);
                    
                    currentY = addText('This offer is contingent upon:', margin, currentY) + 5;
                    
                    const contingencies = [
                        'Successful completion of background verification',
                        'Verification of employment eligibility',
                        'Satisfactory reference checks',
                        'Any required medical examinations or drug screening'
                    ];
                    
                    contingencies.forEach(contingency => {
                        currentY = addText(` ${contingency}`, margin + 5, currentY) + 5;
                    });
                    currentY += 8;
                    
                    // Offer expiry notice
                    const expiryDate = offer.offerExpiryDate ? new Date(offer.offerExpiryDate).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    }) : 'TBD';
                    
                    doc.setFont('helvetica', 'bold');
                    currentY = addText(`Please note that this offer expires on ${expiryDate}.`, margin, currentY) + 5;
                    doc.setFont('helvetica', 'normal');
                    currentY = addText('To accept this offer, please sign and return this letter by the expiration date.', margin, currentY) + 10;
                    
                    // Closing paragraphs (matching preview)
                    currentY = addText('We are excited about the possibility of you joining our team and look forward to your positive response. If you have any questions about this offer, please don\'t hesitate to contact me.', margin, currentY) + 8;
                    
                    currentY = addText('Welcome to the Dreamex Datalab HSE family!', margin, currentY) + 20;
                    
                    // Check if we need a new page for signatures
                    if (currentY > pageHeight - 100) {
                        doc.addPage();
                        currentY = margin;
                    }
                    
                    // Signature Section (matching preview)
                    currentY = addSectionHeader('Signatures', currentY);
                    
                    const signatureY = currentY + 10;
                    
                    // HR Manager signature block
                    doc.setFont('helvetica', 'bold');
                    doc.text('HR Manager', margin, signatureY);
                    doc.setFont('helvetica', 'normal');
                    doc.text('Dreamex Datalab HSE', margin, signatureY + 7);
                    doc.text(`Date: ${currentDate}`, margin, signatureY + 14);
                    doc.line(margin, signatureY + 20, margin + 80, signatureY + 20);
                    
                    // Candidate acceptance signature block
                    doc.setFont('helvetica', 'bold');
                    doc.text('Candidate Acceptance', pageWidth - margin - 80, signatureY);
                    doc.setFont('helvetica', 'normal');
                    doc.text(candidateName, pageWidth - margin - 80, signatureY + 7);
                    doc.text('Date: _________________', pageWidth - margin - 80, signatureY + 14);
                    doc.line(pageWidth - margin - 80, signatureY + 20, pageWidth - margin, signatureY + 20);
                    
                    // Footer
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'italic');
                    doc.text('This is an official employment offer from Dreamex Datalab HSE', margin, pageHeight - 15);
                    
                    // Generate filename
                    const sanitizedCandidateName = candidateName.replace(/[^a-zA-Z0-9]/g, '_');
                    const sanitizedJobTitle = jobTitle.replace(/[^a-zA-Z0-9]/g, '_');
                    const fileName = `Offer_Letter_${sanitizedCandidateName}_${sanitizedJobTitle}_${new Date().toISOString().slice(0, 10)}.pdf`;
                    
                    // Save the PDF
                    doc.save(fileName);
                    
                    console.log('? PDF generated and downloaded successfully:', fileName);
                    showNotification(`PDF downloaded successfully: ${fileName}`, 'success');
                    
                } catch (error) {
                    console.error('? Error generating PDF:', error);
                    showNotification('Error generating PDF: ' + error.message, 'error');
                }
                
            }).catch((error) => {
                console.error('? Error retrieving offer data:', error);
                showNotification('Error retrieving offer data: ' + error.message, 'error');
            });
        }        function loadRejectedOffers() {
            console.log('Loading declined offers...');
            showLoadingState('declinedOffers');
            
            // Check if user has company context
            if (!currentUser || !currentUser.companyId) {
                console.log('No company context found for loading declined offers');
                hideLoadingState('declinedOffers');
                return;
            }
            
            const companyId = currentUser.companyId;
            
            // Use real-time listener for live updates from company-scoped path
            database.ref(`companies/${companyId}/offers`).orderByChild('status').equalTo('declined').on('value', (snapshot) => {
                const declinedOffersData = snapshot.val() || {};
                console.log('Declined offers data for company:', companyId, declinedOffersData);
                
                hideLoadingState('declinedOffers');
                
                if (Object.keys(declinedOffersData).length === 0) {
                    showEmptyState('declinedOffers', true);
                    return;
                }
                
                showEmptyState('declinedOffers', false);
                renderDeclinedOffers(declinedOffersData);
            }, (error) => {
                console.error('Error loading declined offers:', error);
                hideLoadingState('declinedOffers');
                showNotification('Error loading declined offers', 'error');
            });
        }

        function renderDeclinedOffers(declinedOffersData) {
            const tableBody = declinedOffersTableBody;
            const table = declinedOffersTable;
            
            tableBody.innerHTML = '';
            
            Object.entries(declinedOffersData).forEach(([offerId, offer]) => {
                const row = createDeclinedOfferRow(offerId, offer);
                tableBody.appendChild(row);
            });
            
            table.style.display = 'table';
        }

        function createDeclinedOfferRow(offerId, offer) {
            const row = document.createElement('tr');
            
            const candidateName = getCandidateFullName(offer);
            const jobTitle = offer.jobTitle || 'N/A';
            const department = offer.department || 'N/A';
            const salary = offer.salary ? `$${parseFloat(offer.salary).toLocaleString()}` : 'N/A';
            const declinedDate = offer.declinedAt ? new Date(offer.declinedAt).toLocaleDateString() : 'N/A';
            const offerDate = offer.createdAt ? new Date(offer.createdAt).toLocaleDateString() : 'N/A';
            const reason = offer.declineReason || 'No reason provided';
            
            row.innerHTML = `
                <td>
                    <div class="candidate-info">
                        <div class="candidate-avatar">${candidateName.charAt(0).toUpperCase()}</div>
                        <div class="candidate-details">
                            <div class="candidate-name">${escapeHtml(candidateName)}</div>
                            <div class="candidate-email">${escapeHtml(offer.candidateEmail || 'N/A')}</div>
                        </div>
                    </div>
                </td>
                <td>${escapeHtml(jobTitle)}</td>
                <td>${declinedDate}</td>
                <td title="${escapeHtml(reason)}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${escapeHtml(reason)}
                </td>
                ${createFileUploadCell(offerId, offer.document)}
                <td class="actions-cell">
                    <div class="action-buttons">
                        <button class="btn-action btn-view" onclick="viewOffer('${offerId}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-action btn-edit" onclick="editOffer('${offerId}')" title="Edit Offer">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // Add click event listener to row (excluding actions cell)
            row.addEventListener('click', function(event) {
                // Don't trigger row click if clicking on buttons in actions cell
                if (!event.target.closest('.actions-cell')) {
                    viewOffer(offerId);
                }
            });
            
            // Add hover cursor style
            row.style.cursor = 'pointer';
            
            // Initialize drag and drop functionality after DOM is ready
            setTimeout(() => setupFileDragAndDrop(), 100);
            
            return row;
        }function showNotification(message, type) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.custom-notification');
            existingNotifications.forEach(n => n.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `custom-notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                ${type === 'success' ? 'background-color: #28a745;' : 
                  type === 'error' ? 'background-color: #dc3545;' : 
                  'background-color: #17a2b8;'}
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 4000);
        }

        // Reset all menu items to hidden (exactly as in dashboard.html)
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items (exactly as in dashboard.html)
        function showBasicMenu() {
            console.log('?? Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
            showSidebarAfterAuth();
        }

        // Feature-based authorization system that takes priority over role permissions (exactly as in dashboard.html)
        async function updateMenuWithFeatureAuthorization() {
            console.log('?? Starting feature-based menu authorization for offer.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('?? Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('?? Using Firebase auth - will search for company');
                } else {
                    console.log('? No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log('? Searching for user company...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`? Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('? No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                // Get user role
                let userRole = null;
                if (companyId) {
                    const database = firebase.database();
                    const userSnapshot = await database.ref(`companies/${companyId}/users/${currentUser.uid}`).once('value');
                    if (userSnapshot.exists()) {
                        userRole = userSnapshot.val().role;
                    }
                }

                // Apply feature-based authorization
                await applyFeatureBasedMenuVisibility(companyId, userRole);
                
            } catch (error) {
                console.error('? Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            }
        }

        // Apply feature-based menu visibility (exactly as in dashboard.html)
        async function applyFeatureBasedMenuVisibility(companyId, userRole = null) {
            try {
                console.log('?? Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log('?? No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('? Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('?? Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('?? Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`?? Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`?? Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('?? All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log('?? Authorized features for offer.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`? Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`? Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`? Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`? Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`?? Feature-based menu authorization completed for offer.html - ${visibleCount} items visible`);
                
                // Apply role-based filtering after feature filtering
                await applyRoleBasedFiltering(companyId, userRole, authorizedPages);
                
            } catch (error) {
                console.error('? Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
            }
        }

        // Apply role-based filtering after feature authorization
        async function applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
            try {
                console.log('?? Applying role-based filtering...', { companyId, userRole });
                
                if (!userRole || !companyId) {
                    console.log('?? No role or company ID for role filtering');
                    showSidebarAfterAuth();
                    return;
                }
                
                // Get role permissions from Firebase
                const database = firebase.database();
                const permissionsSnapshot = await database.ref(`companies/${companyId}/roles/${userRole}/permissions`).once('value');
                
                if (!permissionsSnapshot.exists()) {
                    console.log('?? No permissions found for role:', userRole);
                    if (userRole === 'administrator') {
                        // Administrator gets all permissions
                        showSidebarAfterAuth();
                        return;
                    }
                    hideItemsRequiringPermissions();
                    showSidebarAfterAuth();
                    return;
                }
                
                const permissions = permissionsSnapshot.val();
                console.log('?? Role permissions loaded:', permissions);
                
                filterMenuByPermissions(permissions);
                showSidebarAfterAuth();
                
            } catch (error) {
                console.error('? Error in role-based filtering:', error);
                showSidebarAfterAuth();
            }
        }
        
        // Filter menu items based on permissions
        function filterMenuByPermissions(permissions) {
            const visibleItemsWithPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            
            visibleItemsWithPermissions.forEach(item => {
                const requiredPermission = item.getAttribute('data-requires-permission');
                const permission = permissions[requiredPermission];
                const hasPermission = permission === true || (permission && permission.view === true);
                
                if (!hasPermission) {
                    item.classList.remove('menu-visible');
                    console.log(`? Removing menu item (no permission): ${requiredPermission}`);
                } else {
                    console.log(`? Keeping menu item (has permission): ${requiredPermission}`);
                }
            });
            
            // Update dropdown visibility based on remaining visible children
            document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(dropdown => {
                const visibleChildren = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleChildren.length === 0) {
                    dropdown.classList.remove('menu-visible');
                }
            });
        }
        
        // Hide items that require permissions but user doesn't have access
        function hideItemsRequiringPermissions() {
            const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
            itemsRequiringPermissions.forEach(item => {
                item.classList.remove('menu-visible');
            });
            
            // Update dropdown visibility
            document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(dropdown => {
                const visibleChildren = dropdown.querySelectorAll('.submenu li.menu-visible');
                if (visibleChildren.length === 0) {
                    dropdown.classList.remove('menu-visible');
                }
            });
            
            // Ensure home is always visible
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem && !homeItem.classList.contains('menu-visible')) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            initializeOfferPage();
            
            // Initialize feature authorization (exactly as in dashboard.html)
            // Wait for auth manager to be ready
            setTimeout(async () => {
                try {
                    await updateMenuWithFeatureAuthorization();
                } catch (error) {
                    console.error('? Error initializing feature-based menu:', error);
                    showBasicMenu();
                }
            }, 1500);
            
            // Add click outside modal to close preview
            document.getElementById('offerPreviewModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeOfferPreview();
                }
            });
            
            // Add keyboard support for modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const previewModal = document.getElementById('offerPreviewModal');
                    if (previewModal && previewModal.style.display === 'flex') {
                        closeOfferPreview();
                    }
                    const editModal = document.getElementById('editOfferModal');
                    if (editModal && editModal.style.display === 'flex') {
                        closeEditOfferModal();
                    }
                }
            });

            // Add click outside modal to close edit modal
            document.getElementById('editOfferModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditOfferModal();
                }
            });

            // Sidebar toggle: hide/unhide sidebar like project-list.html
            const sidebarToggleBtn = document.getElementById('sidebarToggle');
            const sidebarEl = document.querySelector('.sidebar');
            const mainContentEl = document.querySelector('.main-content');
            if (sidebarToggleBtn && sidebarEl && mainContentEl) {
                sidebarToggleBtn.addEventListener('click', () => {
                    sidebarEl.classList.toggle('collapsed');
                    mainContentEl.classList.toggle('sidebar-collapsed');
                });
            }
        });        // Offer Management Functions
        
        /**
         * Accept an offer and move it to acceptedoffers path
         * @param {string} offerId - The ID of the offer to accept
         */
        async function acceptOffer(offerId) {
            try {
                console.log('Accepting offer:', offerId);
                
                // Get the offer data from pending offers
                const offerRef = database.ref(`offers/${offerId}`);
                const snapshot = await offerRef.once('value');
                
                if (!snapshot.exists()) {
                    throw new Error('Offer not found');
                }
                
                const offerData = snapshot.val();
                
                // Prepare accepted offer data
                const acceptedOfferData = {
                    ...offerData,
                    status: 'accepted',
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP,
                    acceptedDate: new Date().toISOString(),
                    originalOfferId: offerId
                };
                
                // Store in acceptedoffers path
                const acceptedOfferRef = database.ref(`acceptedoffers/${offerId}`);
                await acceptedOfferRef.set(acceptedOfferData);
                
                // Update original offer status to accepted
                await offerRef.update({
                    status: 'accepted',
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP,
                    acceptedDate: new Date().toISOString()
                });
                
                console.log('Offer accepted successfully and stored in acceptedoffers');
                showNotification('Offer accepted successfully!', 'success');
                
                // Refresh the current view
                await refreshCurrentTab();
                
                // Update statistics
                await updateOfferStatistics();
                
            } catch (error) {
                console.error('Error accepting offer:', error);                showNotification('Failed to accept offer: ' + error.message, 'error');
            }
        }

        // Initialize offer management when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('Initializing offer management...');
                
                // Initialize company context first
                await initializeCompanyContext();
                
                await updateOfferStatistics();
                console.log('Offer management initialized successfully');
            } catch (error) {
                console.error('Error initializing offer management:', error);
            }
        });
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }
});

// Job Offer Email Notification Test Function
// ==========================================

/**
 * Test function to verify job offer notification system
 * This can be called from browser console: testJobOfferNotification()
 */
window.testJobOfferNotification = async function() {
    console.log('?? Testing job offer notification system...');
    
    // Sample offer data for testing
    const testOfferData = {
        id: 'test-offer-001',
        candidateName: 'John Doe',
        candidateEmail: 'john.doe@example.com',
        candidatePhone: '+1 (555) 123-4567',
        positionTitle: 'Senior Software Engineer',
        companyName: 'Dreamex Datalab HSE',
        department: 'Information Technology',
        division: 'Software Development',
        reportsTo: 'Jane Smith, Engineering Manager',
        workLocation: 'Remote/Hybrid',
        employmentType: 'Full-time',
        contractDuration: 'Permanent',
        startDate: '2025-08-15',
        workingHours: '40',
        baseSalary: '$75,000',
        annualSalary: '$75,000 USD',
        paymentFrequency: 'Bi-weekly',
        currency: 'USD',
        bonusEligibility: 'Performance-based annual bonus up to 15%',
        commissionStructure: 'N/A',
        salaryReviewDate: 'Annual review in January',
        healthInsurance: '100% company-paid medical, dental, and vision',
        dentalCoverage: 'Included in health insurance package',
        visionCoverage: 'Included in health insurance package',
        lifeInsurance: '2x annual salary, company-paid',
        retirementPlan: '401(k) with 6% company match',
        paidTimeOff: '20',
        sickLeave: '10',
        holidaySchedule: 'Standard company holidays plus floating days',
        professionalDevelopment: '$2,000 annual budget for training and conferences',
        remoteWorkPolicy: 'Hybrid - 3 days in office, 2 days remote',
        flexibleHours: 'Core hours 10am-3pm, flexible start/end times',
        officeLocation: '123 Tech Street, Innovation City, TC 12345',
        parkingArrangement: 'Free parking space provided',
        equipmentProvided: 'MacBook Pro, monitor, keyboard, mouse, headset',
        softwareAccess: 'All development tools and cloud services',
        companyPhone: 'Available upon request',
        primaryDuties: 'Full-stack development, code review, mentoring junior developers',
        kpiMetrics: 'Code quality, feature delivery, team collaboration',
        successMetrics: 'Project completion, customer satisfaction, technical innovation',
        trainingProgram: '2-week comprehensive onboarding program',
        probationPeriod: '90 days',
        performanceReviews: 'Quarterly check-ins, annual formal review',
        nonCompeteClause: 'Standard 1-year non-compete in same industry',
        intellectualProperty: 'All work product belongs to company',
        socialMediaPolicy: 'Professional social media guidelines apply',
        travelRequirements: 'Occasional travel for conferences (< 10%)',
        orientationDate: '2025-08-15',
        documentRequirements: 'I-9, tax forms, emergency contacts, direct deposit',
        backgroundCheck: 'Required - criminal and employment verification',
        drugTesting: 'Pre-employment drug screening required',
        securityClearance: 'Not required',
        firstDayInstructions: 'Report to HR at 9:00 AM for orientation',
        offerExpirationDate: '2025-08-01',
        contingencies: 'Background check, reference verification',
        referencesRequired: '3 professional references',
        medicalExamination: 'Not required',
        educationVerification: 'Bachelor\'s degree verification required',
        acceptanceLink: 'https://dreamexdatalab.com/offers/accept/test-offer-001',
        responseDeadline: '2025-08-01',
        acceptOfferLink: 'https://dreamexdatalab.com/offers/accept/test-offer-001',
        hrRepresentative: 'Sarah Johnson',
        hrPhone: '+1 (555) 987-6543',
        hrEmail: 'sarah.johnson@dreamexdatalab.com',
        hiringManager: 'Jane Smith',
        hiringManagerName: 'Jane Smith',
        hiringManagerTitle: 'Engineering Manager',
        managerEmail: 'jane.smith@dreamexdatalab.com',
        departmentHead: 'Mike Wilson, VP of Engineering',
        hrRepresentativeName: 'Sarah Johnson',
        applicationId: 'APP-2025-001',
        interviewDate: '2025-07-20',
        interviewScore: '85/100'
    };
    
    try {
        const result = await sendJobOfferNotification(testOfferData, testOfferData.candidateEmail);
        
        if (result.success) {
            console.log('? Test job offer notification sent successfully!');
            console.log('?? Queue ID:', result.queueId);
            console.log('?? Recipient:', result.recipient);
            alert('? Test job offer notification sent successfully!\n\nCheck the email queue in Firebase to verify delivery.');
        } else {
            console.error('? Test failed:', result.error);
            alert('? Test failed: ' + result.error);
        }
        
        return result;
        
    } catch (error) {
        console.error('? Test error:', error);
        alert('? Test error: ' + error.message);
        return { success: false, error: error.message };
    }
};

console.log('?? Job offer notification system loaded. Test with: testJobOfferNotification()');

// Quick manual test function
window.sendTestOfferEmail = async function(email = 'test@example.com') {
    console.log(`?? Sending test job offer email to: ${email}`);
    
    const simpleOfferData = {
        id: 'MANUAL-TEST-' + Date.now(),
        candidateName: 'Test Candidate',
        candidateEmail: email,
        positionTitle: 'Test Position',
        department: 'Test Department',
        companyName: 'Dreamex Datalab HSE',
        startDate: new Date(Date.now() + 30*24*60*60*1000).toLocaleDateString(),
        baseSalary: '$75,000',
        annualSalary: '$75,000',
        hiringManagerName: 'Test Manager',
        hrRepresentativeName: 'HR Representative'
    };
    
    try {
        const result = await sendJobOfferNotification(simpleOfferData, email);
        console.log('?? Result:', result);
        
        if (result.success) {
            alert('? Test job offer email sent successfully to ' + email);
        } else {
            alert('? Failed to send email: ' + result.error);
        }
        
        return result;
    } catch (error) {
        console.error('? Error:', error);
        alert('? Error: ' + error.message);
        return { success: false, error: error.message };
    }
};

console.log('?? Quick test available: sendTestOfferEmail("your.email@example.com")');

// ==========================================
// FILE UPLOAD FUNCTIONALITY FOR OFFER DOCUMENTS
// ==========================================

/**
 * Create file upload cell for offers table
 * @param {string} offerId - The unique offer ID
 * @param {Object} existingFile - Existing file data if any
 * @returns {string} HTML string for file upload cell
 */
function createFileUploadCell(offerId, existingFile = null) {
    const cellId = `file-upload-${offerId}`;
    
    if (existingFile && existingFile.url) {
        // Show existing file
        return `
            <td class="file-upload-cell">
                <div class="uploaded-file">
                    <div class="uploaded-file-info">
                        <i class="fas fa-file-pdf uploaded-file-icon"></i>
                        <a href="${existingFile.url}" target="_blank" class="uploaded-file-name" title="${existingFile.name}">
                            ${existingFile.name.length > 15 ? existingFile.name.substring(0, 12) + '...' : existingFile.name}
                        </a>
                    </div>
                    <div class="uploaded-file-actions">
                        <button class="file-action-btn download" onclick="downloadOfferFile('${existingFile.url}', '${existingFile.name}')" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="file-action-btn delete" onclick="removeOfferFile('${offerId}')" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <input type="file" class="file-input" id="fileInput-${offerId}" accept=".pdf" onchange="handleFileUpload('${offerId}', this)" />
            </td>
        `;
    } else {
        // Show upload interface
        return `
            <td class="file-upload-cell">
                <div class="file-upload-container" id="${cellId}" onclick="document.getElementById('fileInput-${offerId}').click()">
                    <i class="fas fa-file-pdf file-upload-icon"></i>
                </div>
                <input type="file" class="file-input" id="fileInput-${offerId}" accept=".pdf" onchange="handleFileUpload('${offerId}', this)" />
            </td>
        `;
    }
}

/**
 * Handle file upload for offer documents
 * @param {string} offerId - The unique offer ID
 * @param {HTMLInputElement} input - The file input element
 */
async function handleFileUpload(offerId, input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file type
    if (file.type !== 'application/pdf') {
        alert('Please upload only PDF files.');
        input.value = '';
        return;
    }
    
    // Validate file size (max 10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB
    if (file.size > maxSize) {
        alert('File size must be less than 10MB.');
        input.value = '';
        return;
    }
    
    const cellContainer = document.getElementById(`file-upload-${offerId}`);
    
    try {
        // Show upload progress
        showUploadProgress(cellContainer);
        
        // Get company context for Firebase storage path
        if (!currentUser || !currentUser.companyId) {
            throw new Error('No company context found');
        }
        const companyId = currentUser.companyId;
        
        // Upload to Firebase Storage
        const downloadURL = await uploadFileToFirebase(file, offerId, companyId);
        
        // Save file reference to Firebase Database
        await saveFileReferenceToDatabase(offerId, {
            name: file.name,
            url: downloadURL,
            size: file.size,
            uploadedAt: new Date().toISOString(),
            uploadedBy: firebase.auth().currentUser?.uid || 'unknown'
        }, companyId);
        
        // Update UI with uploaded file
        updateFileUploadCell(offerId, {
            name: file.name,
            url: downloadURL
        });
        
        console.log('? File uploaded successfully:', file.name);
        
    } catch (error) {
        console.error('? File upload error:', error);
        showUploadError(cellContainer, error.message);
        input.value = '';
    }
}

/**
 * Upload file to Firebase Storage
 * @param {File} file - The file to upload
 * @param {string} offerId - The offer ID
 * @param {string} companyId - The company ID
 * @returns {Promise<string>} Download URL
 */
async function uploadFileToFirebase(file, offerId, companyId) {
    if (typeof firebase === 'undefined' || !firebase.storage) {
        throw new Error('Firebase Storage not available');
    }
    
    const storage = firebase.storage();
    const fileName = `${offerId}_${Date.now()}_${file.name}`;
    const filePath = `companies/${companyId}/offers/${offerId}/documents/${fileName}`;
    
    const storageRef = storage.ref(filePath);
    
    // Upload file
    const uploadTask = storageRef.put(file);
    
    // Wait for upload to complete
    await uploadTask;
    
    // Get download URL
    const downloadURL = await storageRef.getDownloadURL();
    return downloadURL;
}

/**
 * Save file reference to Firebase Database
 * @param {string} offerId - The offer ID
 * @param {Object} fileData - File metadata
 * @param {string} companyId - The company ID
 */
async function saveFileReferenceToDatabase(offerId, fileData, companyId) {
    if (typeof firebase === 'undefined' || !firebase.database) {
        throw new Error('Firebase Database not available');
    }
    
    const database = firebase.database();
    const fileRef = database.ref(`companies/${companyId}/offers/${offerId}/document`);
    
    await fileRef.set(fileData);
}

/**
 * Remove offer file
 * @param {string} offerId - The offer ID
 */
async function removeOfferFile(offerId) {
    if (!confirm('Are you sure you want to remove this offer document?')) {
        return;
    }
    
    try {
        if (!currentUser || !currentUser.companyId) {
            throw new Error('No company context found');
        }
        const companyId = currentUser.companyId;
        
        // Remove from Firebase Database
        const database = firebase.database();
        const fileRef = database.ref(`companies/${companyId}/offers/${offerId}/document`);
        await fileRef.remove();
        
        // Update UI to show upload interface
        const cell = document.querySelector(`#file-upload-${offerId}`).closest('td');
        cell.innerHTML = createFileUploadCell(offerId).replace('<td class="file-upload-cell">', '').replace('</td>', '');
        
        // Setup drag and drop for the new upload container
        setupFileDragAndDrop(`file-upload-${offerId}`, offerId);
        
        console.log('? File removed successfully');
        
    } catch (error) {
        console.error('? Error removing file:', error);
        alert('Error removing file: ' + error.message);
    }
}

/**
 * Download offer file
 * @param {string} url - File URL
 * @param {string} fileName - File name
 */
function downloadOfferFile(url, fileName) {
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

/**
 * Show upload progress
 * @param {HTMLElement} container - Container element
 */
function showUploadProgress(container) {
    container.innerHTML = `
        <i class="fas fa-spinner fa-spin file-upload-icon"></i>
        <div class="file-upload-text">Uploading...</div>
        <div class="file-upload-progress">
            <div class="file-upload-progress-bar" style="width: 0%"></div>
        </div>
    `;
    
    // Simulate progress
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 30;
        if (progress > 90) progress = 90;
        
        const progressBar = container.querySelector('.file-upload-progress-bar');
        if (progressBar) {
            progressBar.style.width = progress + '%';
        }
        
        if (progress >= 90) {
            clearInterval(interval);
        }
    }, 200);
}

/**
 * Show upload error
 * @param {HTMLElement} container - Container element
 * @param {string} errorMessage - Error message
 */
function showUploadError(container, errorMessage) {
    container.innerHTML = `
        <i class="fas fa-exclamation-triangle file-upload-icon" style="color: #dc3545;"></i>
        <div class="file-upload-text">Upload failed</div>
        <div class="file-upload-error">${errorMessage}</div>
    `;
    
    // Reset to upload interface after 3 seconds
    setTimeout(() => {
        const offerId = container.id.replace('file-upload-', '');
        container.outerHTML = createFileUploadCell(offerId);
        setupFileDragAndDrop(container.id, offerId);
    }, 3000);
}

/**
 * Update file upload cell with uploaded file
 * @param {string} offerId - The offer ID
 * @param {Object} fileData - File data
 */
function updateFileUploadCell(offerId, fileData) {
    const cell = document.querySelector(`#file-upload-${offerId}`).closest('td');
    cell.innerHTML = createFileUploadCell(offerId, fileData).replace('<td class="file-upload-cell">', '').replace('</td>', '');
}

/**
 * Setup drag and drop functionality for file upload
 * @param {string} containerId - Container element ID
 * @param {string} offerId - Offer ID
 */
function setupFileDragAndDrop(containerId, offerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        container.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        container.addEventListener(eventName, () => container.classList.add('dragover'), false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        container.addEventListener(eventName, () => container.classList.remove('dragover'), false);
    });
    
    container.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const fileInput = document.getElementById(`fileInput-${offerId}`);
            fileInput.files = files;
            handleFileUpload(offerId, fileInput);
        }
    }, false);
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
}

/**
 * Load existing file for an offer from Firebase
 * @param {string} offerId - The offer ID
 * @param {string} companyId - The company ID
 * @returns {Promise<Object|null>} File data or null
 */
async function loadOfferFile(offerId, companyId) {
    try {
        if (typeof firebase === 'undefined' || !firebase.database) {
            return null;
        }
        
        const database = firebase.database();
        const fileRef = database.ref(`companies/${companyId}/offers/${offerId}/document`);
        const snapshot = await fileRef.once('value');
        
        return snapshot.exists() ? snapshot.val() : null;
        
    } catch (error) {
        console.error('Error loading offer file:', error);
        return null;
    }
}

console.log('?? File upload functionality loaded for offer documents');
</script>
</body>
</html>
