<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Management - Dreamex Datalab HSE</title>
    
    <!-- Firebase v8 CDN for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>
    
    <!-- Demo mode: Add ?demo=true to URL or set window.DEMO_MODE = true for testing -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Embedded JavaScript - Firebase Configuration and All Dependencies -->
    <script>
        // Firebase Configuration (converted from ES6 to v8)
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Firebase Authentication Functions
        const loginWithEmail = async (email, password) => {
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Get user role and other data from the database
                const userRef = db.ref(`users/${user.uid}`);
                return new Promise((resolve, reject) => {
                    userRef.once('value', (snapshot) => {
                        const userData = snapshot.val() || {};
                        resolve({
                            uid: user.uid,
                            email: user.email,
                            role: userData.role || 'standard',
                            name: userData.name || user.email.split('@')[0],
                            department: userData.department || 'Unknown'
                        });
                    });
                });
            } catch (error) {
                throw error;
            }
        };

        const logoutUser = async () => {
            try {
                await auth.signOut();
                return true;
            } catch (error) {
                console.error('Logout error:', error);
                return false;
            }
        };

        const resetPassword = async (email) => {
            try {
                await auth.sendPasswordResetEmail(email);
                return { success: true };
            } catch (error) {
                console.error('Password reset error:', error);
                return { success: false, error: error.code };
            }
        };

        // Database Functions
        const saveTrainingRequest = async (trainingRequest) => {
            try {
                await db.ref(`trainingRequests/${trainingRequest.id}`).set(trainingRequest);
                return true;
            } catch (error) {
                console.error('Error saving training request:', error);
                return false;
            }
        };

        const updateTrainingRequest = async (id, updates) => {
            try {
                await db.ref(`trainingRequests/${id}`).update(updates);
                return true;
            } catch (error) {
                console.error('Error updating training request:', error);
                return false;
            }
        };

        const deleteTrainingRequest = async (id) => {
            try {
                await db.ref(`trainingRequests/${id}`).remove();
                return true;
            } catch (error) {
                console.error('Error deleting training request:', error);
                return false;
            }
        };

        const subscribeToTrainingRequests = (callback) => {
            const trainingRequestsRef = db.ref('trainingRequests');
            trainingRequestsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const trainingRequests = data ? Object.values(data) : [];
                callback(trainingRequests.sort((a, b) => b.id - a.id));
            });
        };

        // Access Request Functions
        const saveAccessRequest = async (accessRequest) => {
            try {
                const accessRequestId = Date.now().toString();
                const accessRequestWithId = { ...accessRequest, id: accessRequestId };
                await db.ref(`access/${accessRequestId}`).set(accessRequestWithId);
                return accessRequestId;
            } catch (error) {
                console.error('Error saving access request:', error);
                throw error;
            }
        };

        const updateAccessRequest = async (id, updates) => {
            try {
                await db.ref(`access/${id}`).update(updates);
                return true;
            } catch (error) {
                console.error('Error updating access request:', error);
                return false;
            }
        };

        const deleteAccessRequest = async (id) => {
            try {
                await db.ref(`access/${id}`).remove();
                return true;
            } catch (error) {
                console.error('Error deleting access request:', error);
                return false;
            }
        };

        const subscribeToAccessRequests = (callback) => {
            const accessRequestsRef = db.ref('access');
            accessRequestsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const accessRequests = data ? Object.values(data) : [];
                callback(accessRequests.sort((a, b) => new Date(b.createdAt || b.timestamp) - new Date(a.createdAt || a.timestamp)));
            });
        };

        // KPI Evaluation Functions
        const saveKPIEvaluation = async (employeeId, evaluationType, evaluationData) => {
            try {
                await db.ref(`kpiEvaluations/${employeeId}/${evaluationType}`).set(evaluationData);
                return true;
            } catch (error) {
                console.error('Error saving KPI evaluation:', error);
                return false;
            }
        };

        const updateKPIEvaluation = async (employeeId, evaluationType, updates) => {
            try {
                await db.ref(`kpiEvaluations/${employeeId}/${evaluationType}`).update(updates);
                return true;
            } catch (error) {
                console.error('Error updating KPI evaluation:', error);
                return false;
            }
        };

        const subscribeToKPIEvaluation = (employeeId, evaluationType, callback) => {
            const evaluationRef = db.ref(`kpiEvaluations/${employeeId}/${evaluationType}`);
            const unsubscribe = evaluationRef.on('value', (snapshot) => {
                const data = snapshot.val();
                callback(data);
            }, (error) => {
                console.error('Error subscribing to KPI evaluation:', error);
                callback(null);
            });
            return unsubscribe;
        };

        // Company Data Service
        class CompanyDataService {
            constructor() {
                this.currentUser = null;
                this.currentCompany = null;
                this.userCompanyId = null;
                this.initializeUserContext();
            }

            async initializeUserContext() {
                return new Promise((resolve) => {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) {
                        const userData = JSON.parse(storedUser);
                        this.currentUser = { uid: userData.uid };
                        this.loadUserCompanyContext().then(resolve);
                    } else {
                        auth.onAuthStateChanged(async (user) => {
                            if (user) {
                                this.currentUser = user;
                                await this.loadUserCompanyContext();
                            }
                            resolve();
                        });
                    }
                });
            }

            async loadUserCompanyContext() {
                if (!this.currentUser) return;

                try {
                    const companiesRef = db.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status === 'active') {
                                if (company.users && company.users[this.currentUser.uid]) {
                                    const user = company.users[this.currentUser.uid];
                                    if (user.authUid === this.currentUser.uid) {
                                        this.userCompanyId = companyId;
                                        this.currentCompany = company;
                                        console.log('Company context loaded from company users:', company.companyName);
                                        return;
                                    }
                                }
                                
                                if (company.admin && (company.admin.authUid === this.currentUser.uid || company.admin.userId === this.currentUser.uid)) {
                                    this.userCompanyId = companyId;
                                    this.currentCompany = company;
                                    console.log('Company context loaded from admin:', company.companyName);
                                    return;
                                }
                            }
                        }
                        
                        console.warn('User not found in any company structure');
                    }
                } catch (error) {
                    console.error('Error loading user company context:', error);
                }
            }

            getCurrentCompanyId() {
                return this.userCompanyId;
            }

            getCurrentCompany() {
                return this.currentCompany;
            }

            async hasCompanyAccess() {
                if (!this.userCompanyId && this.currentUser) {
                    await this.loadUserCompanyContext();
                }
                return !!this.userCompanyId;
            }

            async isCompanyAdmin() {
                if (!this.currentUser) return false;
                
                return new Promise(async (resolve) => {
                    try {
                        const userRef = db.ref(`users/${this.currentUser.uid}`);
                        const snapshot = await userRef.once('value');
                        
                        if (snapshot.exists()) {
                            const userData = snapshot.val();
                            resolve(userData.role === 'company-admin' || userData.role === 'administrator' || userData.isCompanyAdmin === true);
                        } else {
                            resolve(false);
                        }
                    } catch (error) {
                        console.error('Error checking admin status:', error);
                        resolve(false);
                    }
                });
            }

            getCompanyRef(path) {
                if (!this.userCompanyId) {
                    throw new Error('User not associated with any company');
                }
                return db.ref(`companies/${this.userCompanyId}/${path}`);
            }

            async getCompanyData(dataType, callback = null) {
                if (!this.userCompanyId) {
                    throw new Error('User not associated with any company');
                }

                const dataRef = db.ref(`companies/${this.userCompanyId}/${dataType}`);
                
                if (callback) {
                    return dataRef.on('value', callback);
                } else {
                    const snapshot = await dataRef.once('value');
                    return snapshot.exists() ? snapshot.val() : null;
                }
            }
        }

        // Initialize Company Data Service
        const companyDataService = new CompanyDataService();
        window.companyDataService = companyDataService;

        // Auth Manager
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.currentCompany = null;
                this.initializeAuth();
            }

            getCurrentUser() {
                const storedUser = localStorage.getItem('currentUser');
                return storedUser ? JSON.parse(storedUser) : null;
            }

            initializeAuth() {
                if (window.location.pathname.includes('login.html')) {
                    this.initializeLoginPage();
                } else if (window.location.pathname.includes('company-complete-registration.html')) {
                    return;
                } else if (window.location.pathname.includes('approval-settings.html')) {
                    console.log('Skipping authentication check for approval-settings.html');
                    if (this.currentUser) {
                        this.loadUserRole(this.currentUser);
                        this.loadUserCompany();
                    }
                    this.updateUIForAuthenticatedUser();
                    return;
                } else {
                    if (!this.currentUser) {
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    this.checkPageAccess().then(hasAccess => {
                        if (!hasAccess) {
                            console.warn('Page access denied; staying on page and disabling restricted actions');
                            // Do not redirect when logged in; optionally disable or hide restricted UI here
                            // e.g., document.body.classList.add('restricted');
                            return;
                        }
                        
                        this.loadUserRole(this.currentUser);
                        this.loadUserCompany();
                        this.updateUIForAuthenticatedUser();
                    }).catch(error => {
                        console.error('Error checking page access:', error);
                        // Stay on page on error; do not redirect to unauthorized
                    });

                    // User profile dropdown functionality
                    const userProfileBtn = document.getElementById('userProfileBtn');
                    const profileDropdown = document.querySelector('.profile-dropdown');
                    
                    if (userProfileBtn && profileDropdown) {
                        userProfileBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            profileDropdown.classList.toggle('show');
                        });

                        document.addEventListener('click', (e) => {
                            if (!userProfileBtn.contains(e.target)) {
                                profileDropdown.classList.remove('show');
                            }
                        });
                    }

                    // Notification dropdown functionality
                    const notificationBtn = document.getElementById('notificationBtn');
                    const notificationDropdown = document.querySelector('.notification-dropdown');
                    
                    if (notificationBtn && notificationDropdown) {
                        notificationBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            notificationDropdown.classList.toggle('show');
                        });

                        document.addEventListener('click', (e) => {
                            if (!notificationBtn.contains(e.target)) {
                                notificationDropdown.classList.remove('show');
                            }
                        });
                    }
                }

                const logoutBtn = document.querySelector('.profile-dropdown a[href="#"]');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.logout();
                    });
                }
            }

            async loadUserCompany() {
                if (!this.currentUser) return;

                try {
                    const companiesRef = ref(this.db, 'companies');
                    const companiesSnapshot = await get(companiesRef);
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === this.currentUser.uid || userId === this.currentUser.uid) {
                                        foundCompany = company;
                                        this.currentUser.companyId = companyId;
                                        this.currentUser.companyName = company.companyName;
                                        
                                        // Also get the user's role from company data
                                        if (user.role && !this.currentUser.role) {
                                            this.currentUser.role = user.role;
                                            console.log('✅ Set user role from company data:', user.role);
                                        }
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            this.currentCompany = foundCompany;
                            this.updateCompanyBranding();
                            console.log('✅ User company loaded:', this.currentUser.companyName);
                        } else {
                            console.warn('No active company found for user');
                        }
                    }
                } catch (error) {
                    console.error('Error loading user company:', error);
                }
            }

            async checkPageAccess() {
                return true; // Simplified for this conversion
            }

            async loadUserRole(userData) {
                if (!userData || !userData.role) {
                    // Load user role from Firebase if not available
                    if (userData && userData.uid) {
                        try {
                            const userRef = ref(this.db, `users/${userData.uid}`);
                            const userSnapshot = await get(userRef);
                            if (userSnapshot.exists()) {
                                const userRole = userSnapshot.val().role || 'user';
                                userData.role = userRole;
                                console.log('✅ Loaded user role from Firebase:', userRole);
                                // Update current user with role
                                if (this.currentUser && this.currentUser.uid === userData.uid) {
                                    this.currentUser.role = userRole;
                                }
                            }
                        } catch (error) {
                            console.error('Error loading user role:', error);
                        }
                    }
                    return;
                }

                try {
                    let roleData = null;
                    
                    // First try to load from company-scoped roles if company ID is available
                    if (userData.companyId || this.currentUser?.companyId) {
                        const companyId = userData.companyId || this.currentUser?.companyId;
                        const companyRoleRef = ref(this.db, `companies/${companyId}/roles/${userData.role}`);
                        const companyRoleSnapshot = await get(companyRoleRef);
                        
                        if (companyRoleSnapshot.exists()) {
                            roleData = companyRoleSnapshot.val();
                            console.log('✅ Loaded company-scoped role:', roleData.name || userData.role);
                        }
                    }
                    
                    // Fallback to global roles if company role not found
                    if (!roleData) {
                        const globalRoleRef = ref(this.db, `roles/${userData.role}`);
                        const globalRoleSnapshot = await get(globalRoleRef);
                        
                        if (globalRoleSnapshot.exists()) {
                            roleData = globalRoleSnapshot.val();
                            console.log('✅ Loaded global role:', roleData.name || userData.role);
                        }
                    }
                    
                    // Set the role in role manager if available
                    if (roleData && window.roleManager?.setRole) {
                        window.roleManager.setRole(roleData);
                    }
                    
                    return roleData;
                    
                } catch (error) {
                    console.error('Error loading user role:', error);
                }
            }

            updateUIForAuthenticatedUser() {
                // Update user profile with proper avatar loading
                this.updateUserProfile();
                
                // Update other UI elements
                const userNameElement = document.getElementById('userName');
                const userEmailElement = document.getElementById('userEmail');
                const userProfileImage = document.getElementById('userProfileImage');
                const userInitials = document.getElementById('userInitials');

                if (this.currentUser) {
                    if (userNameElement) {
                        userNameElement.textContent = this.currentUser.name || this.currentUser.email;
                    }
                    if (userEmailElement) {
                        userEmailElement.textContent = this.currentUser.email;
                    }
                    
                    // Handle profile image or initials in other parts of UI
                    if (this.currentUser.profileImage && userProfileImage) {
                        userProfileImage.src = this.currentUser.profileImage;
                        userProfileImage.style.display = 'block';
                        if (userInitials) userInitials.style.display = 'none';
                    } else if (userInitials) {
                        const initials = this.getInitials(this.currentUser.name || this.currentUser.email);
                        userInitials.textContent = initials;
                        userInitials.style.display = 'flex';
                        if (userProfileImage) userProfileImage.style.display = 'none';
                    }
                }

                // Trigger menu visibility update after UI is updated
                setTimeout(() => {
                    try {
                        updateMenuVisibilityForCompanyManagement();
                    } catch (error) {
                        console.warn('Failed to update menu visibility after authentication:', error);
                    }
                }, 100);
            }

            getInitials(name) {
                return name.split(' ').map(word => word.charAt(0)).join('').toUpperCase().slice(0, 2);
            }

            updateCompanyBranding() {
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const companyNameHeader = document.getElementById('headerCompanyName');

                if (this.currentCompany && this.currentCompany.logo && headerLogo) {
                    headerLogo.src = this.currentCompany.logo;
                    headerLogo.classList.add('visible');
                    if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'none';
                } else {
                    // Show placeholder when no logo is available
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                    }
                    if (headerLogo) {
                        headerLogo.classList.remove('visible');
                    }
                }

                if (companyNameHeader) {
                    const companyName = this.currentCompany?.companyName || 
                                      this.currentUser?.companyName || 
                                      'Company';
                    companyNameHeader.textContent = companyName;
                }

                // Also update the legacy selectors for backward compatibility
                const legacyHeaderLogo = document.querySelector('.header-company-logo');
                const legacyHeaderLogoPlaceholder = document.querySelector('.header-logo-placeholder');
                const legacyCompanyNameHeader = document.querySelector('.company-name-header');

                if (this.currentCompany && this.currentCompany.logo && legacyHeaderLogo) {
                    legacyHeaderLogo.src = this.currentCompany.logo;
                    legacyHeaderLogo.classList.add('visible');
                       if (legacyHeaderLogoPlaceholder) legacyHeaderLogoPlaceholder.style.display = 'none';
                } else {
                    if (legacyHeaderLogoPlaceholder) {
                        legacyHeaderLogoPlaceholder.style.display = 'flex';
                    }
                    if (legacyHeaderLogo) {
                        legacyHeaderLogo.classList.remove('visible');
                    }
                }

                if (legacyCompanyNameHeader) {
                    const companyName = this.currentCompany?.companyName || 
                                      this.currentUser?.companyName || 
                                      'Company';
                    legacyCompanyNameHeader.textContent = companyName;
                }
            }

            // Get user display name
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                
                const cleanName = (name) => {
                    if (!name || typeof name !== 'string') return '';
                    return name.trim().replace(/\s+/g, ' ');
                };
                
                const potentialNames = [
                    this.currentUser.displayName,
                    this.currentUser.name,
                    this.currentUser.username
                ];
                
                for (const name of potentialNames) {
                    const cleaned = cleanName(name);
                    if (cleaned) return cleaned;
                }
                
                if (this.currentUser.email) {
                    const emailUsername = this.currentUser.email.split('@')[0];
                    const cleaned = cleanName(emailUsername);
                    if (cleaned) return cleaned;
                }
                
                return 'User';
            }

            // Get user initials for avatar display
            getUserInitials() {
                const displayName = this.getUserDisplayName();
                
                if (!displayName || displayName === 'User') return 'U';
                
                const words = displayName.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            // Get user email
            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Generate initials avatar
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Get user avatar URL or null if not available
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    return null;
                }
            }

            // Update user profile with proper avatar loading
            async updateUserProfile() {
                const profileBtn = document.getElementById('userProfileBtn');
                const profileDropdown = document.querySelector('.profile-dropdown ul');
                
                if (profileBtn && profileDropdown) {
                    if (this.currentUser) {
                        // Use centralized display methods
                        const initials = this.getUserInitials();
                        const displayName = this.getUserDisplayName();
                        const email = this.getUserEmail();
                        
                        // Preload avatar URL to avoid showing initials first
                        const avatarUrl = await this.getUserAvatarUrl();
                        
                        // Update profile image - now show the correct image immediately
                        const profileImg = profileBtn.querySelector('img');
                        if (profileImg) {
                            if (avatarUrl) {
                                profileImg.src = avatarUrl;
                                profileImg.alt = displayName + ' Avatar';
                            } else {
                                // Generate initials avatar
                                this.generateInitialsAvatar(displayName, profileImg);
                            }
                        }
                        
                        // Create avatar for dropdown (either real avatar or initials)
                        let dropdownAvatarHtml;
                        if (avatarUrl) {
                            dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                        } else {
                            dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                        }
                        
                        // Update profile dropdown with user info (match project-list.html)
                        const userInfoHtml = `
                            <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${dropdownAvatarHtml}
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">${displayName}</div>
                                        <div style="color: #666; font-size: 12px;">${email}</div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                            <li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li>
                            <li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>
                        `;

                        profileDropdown.innerHTML = userInfoHtml;

                        // Re-attach logout event listener
                        profileDropdown.querySelector('#logoutLink')?.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.logout();
                        });
                    }
                }
            }

            async logout() {
                try {
                    await logoutUser();
                    localStorage.removeItem('currentUser');
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
        }

        // Initialize Auth Manager
        const authManager = new AuthManager();
        window.authManager = authManager;

        // Global logout function for HTML onclick handlers
        window.logout = async function() {
            if (authManager) {
                await authManager.logout();
            }
        };

        // Notification Manager
        class NotificationManager {
            constructor() {
                this.notifications = this.loadNotifications();
                this.settings = this.loadSettings();
                this.firebaseInitialized = false;
                this.firebaseListener = null;
                
                this.initializeNotifications();
                this.initializePermissions();
                this.initializeSettings();
                this.initializeFirebase();
            }

            initializePermissions() {
                this.updateSettingsAccessibility();
                window.addEventListener('roleChanged', () => {
                    this.updateSettingsAccessibility();
                });
            }

            updateSettingsAccessibility() {
                const hasEditPermission = window.roleManager?.hasPermission('notification_settings_view', 'edit');
                
                const notifySubmitter = document.getElementById('notifySubmitter');
                const notifyApprovers = document.getElementById('notifyApprovers');
                const notifyOnComplete = document.getElementById('notifyOnComplete');
                const saveButton = document.getElementById('saveNotificationSettings');
                
                [notifySubmitter, notifyApprovers, notifyOnComplete].forEach(checkbox => {
                    if (checkbox) {
                        checkbox.disabled = !hasEditPermission;
                    }
                });

                if (saveButton) {
                    saveButton.style.display = hasEditPermission ? '' : 'none';
                }
            }

            initializeSettings() {
                const form = document.getElementById('notificationSettingsForm');
                if (!form) return;

                Object.entries(this.settings).forEach(([key, value]) => {
                    const input = form[key];
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = value;
                        } else {
                            input.value = value;
                        }
                    }
                });

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSettings(form);
                });
            }

            loadSettings() {
                const defaultSettings = {
                    emailNotifications: true,
                    notifySubmitter: true,
                    notifyApprovers: true,
                    notifyOnComplete: true,
                    systemUpdates: true,
                    securityAlerts: true,
                    notificationDisplay: '30',
                    showReadNotifications: true
                };

                const savedSettings = localStorage.getItem('notificationSettings');
                return savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            }

            saveSettings(form) {
                const settings = {};
                Array.from(form.elements).forEach(input => {
                    if (input.name && input.type !== 'submit') {
                        settings[input.name] = input.type === 'checkbox' ? input.checked : input.value;
                    }
                });

                this.settings = settings;
                localStorage.setItem('notificationSettings', JSON.stringify(settings));

                this.addNotification({
                    type: 'Success',
                    message: 'Notification settings saved successfully.'
                });
            }

            loadNotifications() {
                const saved = localStorage.getItem('notifications');
                return saved ? JSON.parse(saved) : [];
            }

            addNotification(notification) {
                const id = Date.now().toString();
                const newNotification = {
                    id,
                    ...notification,
                    timestamp: new Date().toISOString(),
                    read: false
                };

                this.notifications.unshift(newNotification);
                this.saveNotifications();
                this.displayNotification(newNotification);
            }

            displayNotification(notification) {
                // Create notification toast
                const toast = document.createElement('div');
                toast.className = `notification-toast notification-${notification.type?.toLowerCase() || 'info'}`;
                toast.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${this.getNotificationIcon(notification.type)}"></i>
                        <span>${notification.message}</span>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()">×</button>
                `;

                document.body.appendChild(toast);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }

            getNotificationIcon(type) {
                const icons = {
                    'success': 'check-circle',
                    'error': 'exclamation-circle',
                    'warning': 'exclamation-triangle',
                    'info': 'info-circle'
                };
                return icons[type?.toLowerCase()] || 'info-circle';
            }

            saveNotifications() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
            }

            initializeNotifications() {
                // Initialize notification system
                this.createNotificationStyles();
            }

            createNotificationStyles() {
                const style = document.createElement('style');
                style.textContent = `
                    .notification-toast {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: white;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        padding: 16px;
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        max-width: 400px;
                        border-left: 4px solid #3498db;
                    }
                    .notification-success { border-left-color: #2ecc71; }
                    .notification-error { border-left-color: #e74c3c; }
                    .notification-warning { border-left-color: #f39c12; }
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex: 1;
                    }
                    .notification-close {
                        background: none;
                        border: none;
                        font-size: 18px;
                        cursor: pointer;
                        color: #999;
                    }
                `;
                document.head.appendChild(style);
            }

            initializeFirebase() {
                // Initialize Firebase listeners for real-time notifications
                this.firebaseInitialized = true;
            }
        }

        // Initialize Notification Manager
        const notificationManager = new NotificationManager();
        window.notificationManager = notificationManager;

        // Company Management System
        class CompanyManagement {
            constructor() {
                this.currentUser = null;
                this.companyData = null;
                this.companyId = null;
                this.companyRoles = null;
                this.selectedFeatures = new Set();
                this.currentlySubscribedFeatures = new Set(); // Track original subscribed features
                this.additionalDomains = [];
                this.currentTab = 'profile';
                this.isLoading = true;
                this.users = []; // Initialize users array for dashboard calculations
                
                this.userCreationInProgress = false;
                this.lastSubmissionTime = 0;
                this.DEBOUNCE_DELAY = 2000;
                
                this.basePrices = {
                    enterprise: 25
                };
                
                this.featureCosts = {
                    enterprise: 5
                };

                console.log('🏗️ CompanyManagement constructor initializing...');
                this.showLoadingState();
                
                // Initialize authentication first, then other components
                this.initializeAuth().then(() => {
                    this.initializeEventListeners();
                    // Initialize company branding immediately with fallbacks
                    this.updateCompanyBranding();
                    console.log('✅ CompanyManagement initialization complete');
                }).catch(error => {
                    console.error('❌ CompanyManagement initialization failed:', error);
                    this.hideLoadingState();
                });
            }

            showLoadingState() {
                const loadingHTML = `
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading company data...</p>
                        </div>
                    </div>
                `;
                
                const style = document.createElement('style');
                style.textContent = `
                    .loading-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(255, 255, 255, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10000;
                    }
                    .loading-spinner {
                        text-align: center;
                        color: #667eea;
                    }
                    .loading-spinner i {
                        font-size: 3rem;
                        margin-bottom: 1rem;
                    }
                    .loading-spinner p {
                        font-size: 1.2rem;
                        margin: 0;
                    }
                `;
                document.head.appendChild(style);
                document.body.insertAdjacentHTML('afterbegin', loadingHTML);
            }

            hideLoadingState() {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.remove();
                }
                this.isLoading = false;
                
                // Update menu visibility after loading is complete
                setTimeout(() => {
                    if (typeof window.updateMenuVisibilityForCompanyManagement === 'function') {
                        window.updateMenuVisibilityForCompanyManagement();
                        console.log('✅ Menu visibility updated after loading');
                    }
                }, 500);
            }

            async initializeAuth() {
                console.log('🔐 Initializing Company Management authentication...');
                
                const storedUser = localStorage.getItem('currentUser');
                if (!storedUser) {
                    console.error('❌ No user found in localStorage');
                    this.showNotification('Authentication required. Please log in.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }

                try {
                    this.currentUser = JSON.parse(storedUser);
                    console.log('✅ User loaded from localStorage:', this.currentUser.email);

                    // Load user role if not available
                    if (!this.currentUser.role && this.currentUser.uid) {
                        await this.loadUserRole(this.currentUser);
                    }
                    
                    // Load user company context
                    await this.loadUserCompany();

                    // Initialize user profile display immediately
                    await this.initializeUserProfileDisplay();
                    
                    // Set up AuthManager integration
                    if (window.authManager) {
                        if (!window.authManager.currentUser) {
                            window.authManager.currentUser = this.currentUser;
                        }
                        // Also load company and role in AuthManager
                        await window.authManager.loadUserCompany();
                        if (this.currentUser.role) {
                            await window.authManager.loadUserRole(this.currentUser);
                        }
                        // Update profile elements through AuthManager
                        await window.authManager.updateUserProfile();
                        console.log('✅ AuthManager profile updated');
                    }
                    
                    // Set up profile dropdown functionality
                    this.setupProfileDropdown();
                    
                    // Load company data
                    await this.loadCompanyData();
                    
                    // Set up Firebase auth state listener (with protection against premature redirects)
                    this.setupAuthStateListener();
                    
                    console.log('✅ Authentication initialization complete with role:', this.currentUser.role);
                    console.log('✅ Authentication initialization complete with company:', this.currentUser.companyId);
                    
                } catch (error) {
                    console.error('❌ Error initializing authentication:', error);
                    this.showNotification('Error loading user data. Please try refreshing the page.', 'error');
                }
            }

            async initializeUserProfileDisplay() {
                console.log('👤 Initializing user profile display...');
                
                const userAvatar = document.getElementById('userAvatar');
                const userInitialsFallback = document.getElementById('userInitialsFallback');
                const profileBtn = document.getElementById('userProfileBtn');
                
                if (!userAvatar || !profileBtn) {
                    console.warn('⚠️ User profile elements not found');
                    return;
                }

                // Generate user initials for avatar
                if (this.currentUser) {
                    const displayName = this.currentUser.name || this.currentUser.email;
                    const initials = this.getInitials(displayName);
                    
                    // Update initials fallback element
                    if (userInitialsFallback) {
                        userInitialsFallback.textContent = initials;
                    }
                    
                    // Check if user has a profile image
                    if (this.currentUser.profilePicture || this.currentUser.photoURL) {
                        const profileImageUrl = this.currentUser.profilePicture || this.currentUser.photoURL;
                        userAvatar.src = profileImageUrl;
                        userAvatar.alt = displayName + ' Avatar';
                        userAvatar.style.display = 'block';
                        if (userInitialsFallback) {
                            userInitialsFallback.style.display = 'none';
                        }
                        console.log('✅ Profile picture loaded from URL');
                    } else {
                        // Generate initials avatar
                        this.generateInitialsAvatar(displayName, userAvatar);
                        userAvatar.style.display = 'block';
                        if (userInitialsFallback) {
                            userInitialsFallback.style.display = 'none';
                        }
                        console.log('✅ Generated initials avatar');
                    }
                    
                    // Update profile button title
                    profileBtn.title = `${displayName} - Click for profile options`;
                    
                    console.log('✅ User profile display initialized for:', displayName);
                } else {
                    // Fallback if no user data
                    if (userInitialsFallback) {
                        userInitialsFallback.textContent = 'U';
                        userInitialsFallback.style.display = 'flex';
                        userAvatar.style.display = 'none';
                    }
                    console.log('⚠️ No user data available for profile display');
                }
            }

            generateInitialsAvatar(displayName, imgElement) {
                const initials = this.getInitials(displayName);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = 40;
                
                canvas.width = size;
                canvas.height = size;
                
                // Background circle
                ctx.beginPath();
                ctx.arc(size / 2, size / 2, size / 2, 0, 2 * Math.PI);
                ctx.fillStyle = '#3498db';
                ctx.fill();
                
                // Text
                ctx.fillStyle = '#ffffff';
                ctx.font = `${size / 2.5}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(initials, size / 2, size / 2);
                
                imgElement.src = canvas.toDataURL();
                imgElement.alt = `${displayName} Avatar`;
            }

            getInitials(name) {
                if (!name) return 'U';
                const words = name.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            updateCompanyBranding() {
                console.log('🏢 Updating company branding in header...');
                
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const companyNameHeader = document.getElementById('headerCompanyName');

                // Get company data from various sources
                const companyData = this.companyData || 
                                  window.authManager?.currentCompany || 
                                  null;
                                  
                const companyName = companyData?.companyName || 
                                  this.currentUser?.companyName || 
                                  window.authManager?.currentUser?.companyName ||
                                  'Company';

                // Update company logo
                if (companyData && companyData.logo && headerLogo) {
                    headerLogo.src = companyData.logo;
                    headerLogo.classList.add('visible');
                    headerLogo.style.display = 'block';
                    if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'none';
                    console.log('✅ Company logo displayed');
                } else {
                    // Show placeholder when no logo is available
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                    }
                    if (headerLogo) {
                        headerLogo.classList.remove('visible');
                        headerLogo.style.display = 'none';
                    }
                    console.log('✅ Company logo placeholder displayed');
                }

                // Update company name
                if (companyNameHeader) {
                    companyNameHeader.textContent = companyName;
                    companyNameHeader.style.display = 'block';
                    console.log('✅ Company name updated:', companyName);
                }

                // Also update the legacy selectors for backward compatibility
                const legacyHeaderLogo = document.querySelector('.header-company-logo');
                const legacyHeaderLogoPlaceholder = document.querySelector('.header-logo-placeholder');
                const legacyCompanyNameHeader = document.querySelector('.company-name-header');

                if (companyData && companyData.logo && legacyHeaderLogo) {
                    legacyHeaderLogo.src = companyData.logo;
                    legacyHeaderLogo.classList.add('visible');
                    legacyHeaderLogo.style.display = 'block';
                    if (legacyHeaderLogoPlaceholder) legacyHeaderLogoPlaceholder.style.display = 'none';
                } else {
                    if (legacyHeaderLogoPlaceholder) {
                        legacyHeaderLogoPlaceholder.style.display = 'flex';
                    }
                    if (legacyHeaderLogo) {
                        legacyHeaderLogo.classList.remove('visible');
                        legacyHeaderLogo.style.display = 'none';
                    }
                }

                if (legacyCompanyNameHeader) {
                    legacyCompanyNameHeader.textContent = companyName;
                    legacyCompanyNameHeader.style.display = 'block';
                }
                
                console.log('🏢 Company branding update completed');
            }

            setupProfileDropdown() {
                console.log('🎯 Setting up profile dropdown functionality...');
                
                const userProfileBtn = document.getElementById('userProfileBtn');
                const profileDropdown = document.querySelector('.profile-dropdown');
                
                if (userProfileBtn && profileDropdown) {
                    // Remove any existing event listeners
                    const newProfileBtn = userProfileBtn.cloneNode(true);
                    userProfileBtn.parentNode.replaceChild(newProfileBtn, userProfileBtn);
                    
                    // Add click event for dropdown toggle
                    newProfileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('show');
                        console.log('Profile dropdown toggled');
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!newProfileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                            profileDropdown.classList.remove('show');
                        }
                    });
                    
                    // Prevent dropdown from closing when clicking inside it
                    profileDropdown.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                    
                    console.log('✅ Profile dropdown functionality set up');
                } else {
                    console.warn('⚠️ Profile dropdown elements not found');
                }
            }

            setupAuthStateListener() {
                let hasInitialAuthState = false;
                
                auth.onAuthStateChanged((user) => {
                    if (!hasInitialAuthState) {
                        // First auth state change - don't redirect immediately
                        hasInitialAuthState = true;
                        if (user) {
                            console.log('✅ Firebase auth confirmed for user:', user.email);
                        } else {
                            console.log('⚠️ No Firebase user on initial check - but localStorage has user, continuing...');
                        }
                        return;
                    }
                    
                    // Subsequent auth state changes
                    if (!user) {
                        console.log('🚪 Firebase auth state changed: user logged out');
                        // Clear local storage
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('user');
                        // Redirect after a short delay to allow for proper cleanup
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 1000);
                    }
                });
            }

            async loadUserRole(userData) {
                if (!userData || !userData.role) {
                    // Load user role from Firebase if not available
                    if (userData && userData.uid) {
                        try {
                            const userRef = ref(db, `users/${userData.uid}`);
                            const userSnapshot = await get(userRef);
                            if (userSnapshot.exists()) {
                                const userRole = userSnapshot.val().role || 'user';
                                userData.role = userRole;
                                console.log('✅ CompanyManagement: Loaded user role from Firebase:', userRole);
                                // Update current user with role
                                if (this.currentUser && this.currentUser.uid === userData.uid) {
                                    this.currentUser.role = userRole;
                                }
                            }
                        } catch (error) {
                            console.error('Error loading user role:', error);
                        }
                    }
                    return;
                }

                try {
                    let roleData = null;
                    
                    // First try to load from company-scoped roles if company ID is available
                    if (userData.companyId || this.currentUser?.companyId) {
                        const companyId = userData.companyId || this.currentUser?.companyId;
                        const companyRoleRef = ref(db, `companies/${companyId}/roles/${userData.role}`);
                        const companyRoleSnapshot = await get(companyRoleRef);
                        
                        if (companyRoleSnapshot.exists()) {
                            roleData = companyRoleSnapshot.val();
                            console.log('✅ CompanyManagement: Loaded company-scoped role:', roleData.name || userData.role);
                        }
                    }
                    
                    // Fallback to global roles if company role not found
                    if (!roleData) {
                        const globalRoleRef = ref(db, `roles/${userData.role}`);
                        const globalRoleSnapshot = await get(globalRoleRef);
                        
                        if (globalRoleSnapshot.exists()) {
                            roleData = globalRoleSnapshot.val();
                            console.log('✅ CompanyManagement: Loaded global role:', roleData.name || userData.role);
                        }
                    }
                    
                    return roleData;
                    
                } catch (error) {
                    console.error('CompanyManagement: Error loading user role:', error);
                }
            }

            async loadUserCompany() {
                if (!this.currentUser) return;

                try {
                    const companiesRef = ref(db, 'companies');
                    const companiesSnapshot = await get(companiesRef);
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === this.currentUser.uid || userId === this.currentUser.uid) {
                                        foundCompany = company;
                                        this.currentUser.companyId = companyId;
                                        this.currentUser.companyName = company.companyName;
                                        
                                        // Also get the user's role from company data
                                        if (user.role && !this.currentUser.role) {
                                            this.currentUser.role = user.role;
                                            console.log('✅ CompanyManagement: Set user role from company data:', user.role);
                                        }
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            this.currentCompany = foundCompany;
                            this.companyId = this.currentUser.companyId; // Set the companyId for use in other methods
                            console.log('✅ CompanyManagement: User company loaded:', this.currentUser.companyName);
                            console.log('✅ CompanyManagement: User role:', this.currentUser.role);
                            console.log('✅ CompanyManagement: Company ID:', this.currentUser.companyId);
                        } else {
                            console.warn('CompanyManagement: No active company found for user');
                        }
                    }
                } catch (error) {
                    console.error('CompanyManagement: Error loading user company:', error);
                }
                    await this.loadSubcontractors(); // Load subcontractors for Company Profile tab
                    console.log('✅ CompanyManagement: Subcontractors loaded');
            }

            initializeEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab-nav-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tabId = btn.dataset.tab;
                        if (tabId) {
                            this.switchTab(tabId);
                        }
                    });
                });

                // Form submissions
                document.getElementById('companyProfileForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveCompanyProfile();
                });

                document.getElementById('contactBillingForm')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveContactBilling();
                });

                const addUserForm = document.getElementById('addUserForm');
                if (addUserForm) {
                    addUserForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        
                        try {
                            console.log('Form submission started, checking quota...');
                            
                            if (typeof window.checkUserQuota === 'function') {
                                const quotaInfo = window.checkUserQuota();
                                if (quotaInfo.isQuotaExceeded) {
                                    this.showNotification(`Cannot add user: quota limit reached (${quotaInfo.currentUsers}/${quotaInfo.maxUsers}). Please upgrade your subscription.`, 'error');
                                    return;
                                }
                            }
                            
                            const currentTime = Date.now();
                            if (currentTime - this.lastSubmissionTime < this.DEBOUNCE_DELAY) {
                                this.showNotification(`Please wait ${Math.ceil((this.DEBOUNCE_DELAY - (currentTime - this.lastSubmissionTime)) / 1000)} seconds before submitting again.`, 'warning');
                                return;
                            }
                            
                            if (this.userCreationInProgress) {
                                this.showNotification('User creation is already in progress. Please wait.', 'warning');
                                return;
                            }
                            
                            if (this.validateAddUserForm()) {
                                this.lastSubmissionTime = currentTime;
                                this.addNewUser();
                            } else {
                                this.showNotification('Please fill in all required fields correctly.', 'error');
                            }
                        } catch (error) {
                            console.error('Error in form submission:', error);
                            this.showNotification('An error occurred while processing the form. Please try again.', 'error');
                        }
                    });
                }

                // Feature selection
                document.querySelectorAll('.feature-card').forEach(card => {
                    card.addEventListener('click', () => this.toggleFeature(card));
                });

                // Logo upload
                const logoInput = document.getElementById('logoUpload');
                if (logoInput) {
                    logoInput.addEventListener('change', (e) => this.handleLogoUpload(e));
                }

                // User quota input
                const userQuotaInput = document.getElementById('userQuotaInput');
                if (userQuotaInput) {
                    userQuotaInput.addEventListener('input', () => {
                        this.validateUserQuotaInput();
                        this.updateQuotaButtonStates();
                        this.updatePricingDisplay();
                        this.updateSaveButtonState(); // Update save button when quota changes
                    });
                }

                // Domain management
                const additionalDomainInput = document.getElementById('additionalDomain');
                if (additionalDomainInput) {
                    additionalDomainInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.addDomain();
                        }
                    });
                }

                // Global debug functions
                window.companyManagement = this;
                window.debugCompanyData = () => {
                    console.log('🔍 Debug: Current company data:', this.companyData);
                    console.log('🔍 Debug: Company ID:', this.companyId);
                    console.log('🔍 Debug: Current user:', this.currentUser);
                };

                // Users search handlers (User Management tab)
                const searchInput = document.getElementById('userSearchInput');
                const searchBtn = document.getElementById('userSearchBtn');
                const clearBtn = document.getElementById('userSearchClearBtn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => this.searchUsers());
                }
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearUserSearch());
                }
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.searchUsers();
                        }
                    });
                }
            }

            async loadCompanyData() {
                try {
                    console.log('🔄 Starting loadCompanyData for user:', this.currentUser?.uid);
                    
                    let retries = 0;
                    const maxRetries = 10;
                    while (!window.companyDataService && retries < maxRetries) {
                        console.log('⏳ Waiting for company data service to load...', retries + 1);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        retries++;
                    }
                    
                    if (window.companyDataService) {
                        await window.companyDataService.initializeUserContext();
                        const companyId = window.companyDataService.getCurrentCompanyId();
                        
                        if (!companyId) {
                            console.error('❌ User is not associated with a company');
                            if (this.currentUser?.companyId) {
                                const fallbackCompanyId = this.currentUser.companyId;
                                const companyRef = db.ref(`companies/${fallbackCompanyId}`);
                                const snapshot = await companyRef.once('value');
                                
                                if (snapshot.exists()) {
                                    this.companyData = snapshot.val();
                                    this.companyId = fallbackCompanyId;
                                    console.log('✅ Company data loaded via fallback');
                                    await this.populateCompanyData();
                                    // Ensure brand assets reflect current data
                                    this.updateLogoDisplay();
                                    this.updateHrStampDisplay();
                                    await this.loadUsers();
                                    await this.updateDashboardInfo();
                                    await this.loadCompanyLogo();
                                    this.updateCompanyBranding(); // Update header branding
                                    
                                    // Initialize field options if they don't exist
                                    await this.initializeDefaultFieldOptions();
                                } else {
                                    this.hideLoadingState();
                                    window.location.href = 'company-complete-registration.html';
                                    return;
                                }
                            } else {
                                this.hideLoadingState();
                                window.location.href = 'company-complete-registration.html';
                                return;
                            }
                        } else {
                            console.log('🏢 Loading company data for companyId:', companyId);
                            const companyRef = db.ref(`companies/${companyId}`);
                            const snapshot = await companyRef.once('value');
                            
                            if (snapshot.exists()) {
                                this.companyData = snapshot.val();
                                this.companyId = companyId;
                                console.log('✅ Company data loaded successfully');
                                
                                await new Promise(resolve => setTimeout(resolve, 500));
                                
                                await this.populateCompanyData();
                                this.updateLogoDisplay();
                                this.updateHrStampDisplay();
                                await this.loadUsers();
                                await this.updateDashboardInfo();
                                await this.loadCompanyLogo();
                                this.updateCompanyBranding(); // Update header branding
                                
                                // Initialize field options if they don't exist
                                await this.initializeDefaultFieldOptions();
                            } else {
                                console.error('❌ Company data not found for companyId:', companyId);
                                this.hideLoadingState();
                                window.location.href = 'company-complete-registration.html';
                                return;
                            }
                        }
                    } else {
                        console.error('❌ Company data service not available');
                        this.hideLoadingState();
                        window.location.href = 'company-complete-registration.html';
                        return;
                    }
                } catch (error) {
                    console.error('❌ Error loading company data:', error);
                    this.showNotification('Error loading company data: ' + error.message, 'error');
                } finally {
                    this.hideLoadingState();
                }
            }

            async populateCompanyData() {
                if (!this.companyData) {
                    console.warn('No company data available to populate');
                    return;
                }

                console.log('🚀 Starting to populate company data');

                const setElementValue = (id, value, allowEmpty = true) => {
                    try {
                        const element = document.getElementById(id);
                        if (element) {
                            const finalValue = value || '';
                            element.value = finalValue;
                            console.log(`✓ Set ${id} = "${finalValue}"`);
                            return true;
                        } else {
                            console.warn(`⚠️ Element not found: ${id}`);
                            return false;
                        }
                    } catch (error) {
                        console.error(`❌ Error setting ${id}:`, error);
                        return false;
                    }
                };

                const setTextContent = (id, value) => {
                    try {
                        const element = document.getElementById(id);
                        if (element) {
                            const finalValue = value || '';
                            element.textContent = finalValue;
                            console.log(`✓ Set text ${id} = "${finalValue}"`);
                            return true;
                        } else {
                            console.warn(`⚠️ Element not found: ${id}`);
                            return false;
                        }
                    } catch (error) {
                        console.error(`❌ Error setting text ${id}:`, error);
                        return false;
                    }
                };

                // Profile tab - Company Information
                setElementValue('companyName', this.companyData.companyName);
                setElementValue('companyRegistration', this.companyData.companyRegistration);
                setElementValue('industry', this.companyData.industry);
                setElementValue('companySize', this.companyData.companySize);
                setElementValue('website', this.companyData.website);
                setElementValue('country', this.companyData.country);
                setElementValue('address', this.companyData.address);
                setElementValue('footer', this.companyData.footer);

                // Contact & Billing tab
                setElementValue('contactName', this.companyData.contactName);
                setElementValue('contactEmail', this.companyData.contactEmail);
                setElementValue('contactPhone', this.companyData.contactPhone);
                setElementValue('billingAddress', this.companyData.billingAddress);
                setElementValue('billingEmail', this.companyData.billingEmail);
                setElementValue('billingPhone', this.companyData.billingPhone);
                setElementValue('primaryDomain', this.companyData.primaryDomain);

                // Quota Management tab
                setElementValue('userQuotaInput', this.companyData.userQuota);
                
                // Set minimum value for user quota input to prevent decreasing below current quota
                const userQuotaInput = document.getElementById('userQuotaInput');
                if (userQuotaInput && this.companyData.userQuota) {
                    userQuotaInput.setAttribute('min', this.companyData.userQuota.toString());
                    console.log(`✓ Set userQuotaInput minimum value to ${this.companyData.userQuota}`);
                    
                    // Update button states
                    this.updateQuotaButtonStates();
                }

                // Populate features dropdown and set current value
                await this.populateFeaturesDropdown();
                
                // Set current selected features if available
                if (this.companyData.selectedFeatures && Array.isArray(this.companyData.selectedFeatures)) {
                    // Restore previously selected features
                    this.selectedFeatures = new Set(this.companyData.selectedFeatures);
                    // Track currently subscribed features (cannot be removed)
                    this.currentlySubscribedFeatures = new Set(this.companyData.selectedFeatures);
                    
                    // Check the corresponding checkboxes
                    this.companyData.selectedFeatures.forEach(featureId => {
                        const checkbox = document.querySelector(`input[data-feature-id="${featureId}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            const featureItem = checkbox.closest('.feature-checkbox-item');
                            if (featureItem) {
                                featureItem.classList.add('selected');
                            }
                        }
                    });
                    
                    // Update the display
                    this.updateSelectedFeaturesDisplay();
                    console.log(`✓ Restored ${this.companyData.selectedFeatures.length} selected features`);
                }

                // Update dashboard info
                setTextContent('companyNameDisplay', this.companyData.companyName);
                setTextContent('subscriptionPlan', this.companyData.selectedPlan || 'Enterprise');
                
                // Calculate and display user quota with current count (including administrators)
                let currentUsers = 0;
                if (this.companyData.users) {
                    currentUsers = Object.keys(this.companyData.users).length;
                    
                    // Add administrator to count if they exist but aren't in the users list
                    if (this.companyData.admin && this.companyData.admin.uid) {
                        const adminInUsersList = this.companyData.users[this.companyData.admin.uid];
                        if (!adminInUsersList) {
                            currentUsers += 1;
                        }
                    }
                } else if (this.companyData.admin) {
                    // If no users list but admin exists, count the admin
                    currentUsers = 1;
                }
                
                // Fetch quota directly from Firebase if not available in local data
                let maxUsers = this.companyData.userQuota;
                if (!maxUsers && this.companyId) {
                    console.log('⚠️ User quota not found in local data, fetching from Firebase...');
                    try {
                        const quotaRef = db.ref(`companies/${this.companyId}/userQuota`);
                // Update brand asset previews
                this.updateLogoDisplay();
                this.updateHrStampDisplay();
                        const quotaSnapshot = await quotaRef.once('value');
                        if (quotaSnapshot.exists()) {
                            maxUsers = quotaSnapshot.val();
                            this.companyData.userQuota = maxUsers; // Update local data
                            console.log(`✅ Fetched user quota from Firebase: ${maxUsers}`);
                        } else {
                            maxUsers = 25; // Default fallback
                            console.log('⚠️ No user quota found in Firebase, using default: 25');
                        }
                    } catch (error) {
                        console.error('❌ Error fetching user quota from Firebase:', error);
                        maxUsers = 25; // Default fallback
                    }
                } else {
                    maxUsers = maxUsers || 25; // Use local data or default
                }
                
                // Update both quota display elements
                setTextContent('userQuotaDisplay', `${currentUsers}/${maxUsers}`);
                
                // Also update the main quota display in the header
                const mainQuotaElement = document.getElementById('userQuota');
                if (mainQuotaElement) {
                    mainQuotaElement.textContent = `${currentUsers} / ${maxUsers} Users`;
                    console.log(`📊 Updated main quota display: ${currentUsers} / ${maxUsers} Users`);
                }

                // Update the header plan summary to show plan and quota
                const headerPlanSummaryEl = document.getElementById('headerPlanSummary');
                if (headerPlanSummaryEl) {
                    headerPlanSummaryEl.textContent = `${currentUsers} / ${maxUsers} Users`;
                }
                
                console.log(`📊 Quota display set: ${currentUsers}/${maxUsers} (Company ID: ${this.companyId})`)

                // Load and update selected features from selectedPlan path
                await this.loadSelectedFeatures();

                // Initialize admin data if needed
                await this.initializeAdminFromCurrentUser();

                console.log('✅ Company data population completed');
            }

            async initializeAdminFromCurrentUser() {
                if (!this.currentUser || !this.companyId) {
                    console.log('⚠️ Cannot initialize admin: missing user or company ID');
                    return;
                }

                try {
                    // Get current user's full data from users collection
                    const userRef = db.ref(`users/${this.currentUser.uid}`);
                    const userSnapshot = await userRef.once('value');
                    
                    if (userSnapshot.exists()) {
                        const userData = userSnapshot.val();
                        
                        // Check if this user should be admin (e.g., if they're the company creator)
                        const isCompanyCreator = userData.role === 'company-admin' || userData.role === 'administrator' || 
                                               userData.isCompanyAdmin === true ||
                                               this.companyData?.creatorId === this.currentUser.uid;
                        
                        if (isCompanyCreator) {
                            console.log('🔧 Setting current user as administrator');
                            
                            const adminData = {
                                uid: this.currentUser.uid,
                                name: userData.fullName || userData.name || userData.displayName || this.currentUser.name,
                                email: userData.email || this.currentUser.email,
                                phone: userData.phone || userData.phoneNumber || '',
                                status: 'active',
                                assignedDate: new Date().toISOString(),
                                role: 'administrator'  // Assign the default administrator role from roles.html
                            };

                            // Update company data with admin info
                            await db.ref(`companies/${this.companyId}/admin`).set(adminData);
                            
                            // Also update the user's role in the company users collection
                            await db.ref(`companies/${this.companyId}/users/${this.currentUser.uid}`).update({
                                role: 'administrator',
                                isCompanyAdmin: true,
                                updatedAt: new Date().toISOString()
                            });
                            
                            console.log('✅ Administrator role assigned to company admin user');
                            
                            // Update local data
                            if (!this.companyData.admin) {
                                this.companyData.admin = adminData;
                            }
                            
                            // Update dashboard to reflect new user count including admin
                            await this.updateDashboardInfo();
                            
                            console.log('✅ Administrator set successfully with default administrator role');
                        }
                    } else {
                        console.log('⚠️ User data not found in database');
                    }
                } catch (error) {
                    console.error('❌ Error initializing admin from current user:', error);
                }
            }

            setElementText(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value || 'N/A';
                    return true;
                } else {
                    console.warn(`⚠️ Element not found: ${id}`);
                    return false;
                }
            }

            formatDate(dateInput) {
                try {
                    let date;
                    if (typeof dateInput === 'string') {
                        date = new Date(dateInput);
                    } else if (dateInput instanceof Date) {
                        date = dateInput;
                    } else if (typeof dateInput === 'number') {
                        date = new Date(dateInput);
                    } else {
                        return 'Invalid Date';
                    }

                    if (isNaN(date.getTime())) {
                        return 'Invalid Date';
                    }

                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (error) {
                    console.error('Error formatting date:', error);
                    return 'Invalid Date';
                }
            }

            async switchTab(tabId) {
                console.log('🔄 Switching to tab:', tabId);
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Add active class to selected tab
                const selectedBtn = document.querySelector(`[data-tab="${tabId}"]`);
                const selectedContent = document.getElementById(`${tabId}Tab`);

                if (selectedBtn) {
                    selectedBtn.classList.add('active');
                    console.log('✅ Tab button activated:', selectedBtn);
                } else {
                    console.log('❌ Tab button not found for:', tabId);
                }
                
                if (selectedContent) {
                    selectedContent.classList.add('active');
                    console.log('✅ Tab content activated:', selectedContent);
                } else {
                    console.log('❌ Tab content not found for:', tabId + 'Tab');
                }

                this.currentTab = tabId;

                // Load tab-specific data
                if (tabId === 'users') {
                    await this.loadUsers();
                } else if (tabId === 'billing') {
                    this.loadBillingHistory();
                } else if (tabId === 'subscription') {
                    // Update save button state when switching to subscription tab
                    setTimeout(() => {
                        this.updateSaveButtonState();
                    }, 100); // Small delay to ensure UI is updated
                } else if (tabId === 'profile') {
                    // Refresh subcontractors when returning to profile tab
                    await this.loadSubcontractors();
                }
            }

            async saveCompanyProfile() {
                try {
                    const form = document.getElementById('companyProfileForm');
                    if (!form) return;

                    const formData = new FormData(form);
                    const updateData = {};

                    // Convert FormData to object
                    for (let [key, value] of formData.entries()) {
                        updateData[key] = value;
                    }

                    // Update company data in Firebase
                    await db.ref(`companies/${this.companyId}`).update(updateData);

                    // Update local data
                    Object.assign(this.companyData, updateData);

                    this.showNotification('Company profile updated successfully!', 'success');
                    await this.updateDashboardInfo(); // Update dashboard with any changes
                } catch (error) {
                    console.error('Error saving company profile:', error);
                    this.showNotification('Error updating company profile. Please try again.', 'error');
                }
            }

            async saveContactBilling() {
                try {
                    const form = document.getElementById('contactBillingForm');
                    if (!form) return;

                    const formData = new FormData(form);
                    const updateData = {};

                    for (let [key, value] of formData.entries()) {
                        updateData[key] = value;
                    }

                    await db.ref(`companies/${this.companyId}`).update(updateData);
                    Object.assign(this.companyData, updateData);

                    this.showNotification('Contact and billing information updated successfully!', 'success');
                } catch (error) {
                    console.error('Error saving contact billing:', error);
                    this.showNotification('Error updating contact and billing information. Please try again.', 'error');
                }
            }

            // Subcontractors Management
            async loadSubcontractors() {
                try {
                    if (!this.companyId) {
                        console.warn('No companyId available to load subcontractors');
                        return;
                    }

                    const tbody = document.getElementById('subcontractorsTableBody');
                    if (tbody) tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';

                    const subsRef = db.ref(`companies/${this.companyId}/subcontractors`);
                    const snapshot = await subsRef.once('value');
                    const subs = snapshot.exists() ? snapshot.val() : {};
                    this.subcontractors = subs || {};
                    this.renderSubcontractorsTable(this.subcontractors);
                } catch (error) {
                    console.error('Error loading subcontractors:', error);
                    this.showNotification('Failed to load subcontractors.', 'error');
                }
            }

            renderSubcontractorsTable(subsObj) {
                const tbody = document.getElementById('subcontractorsTableBody');
                if (!tbody) return;

                const subs = Object.entries(subsObj || {});
                if (subs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#6c757d;">No subcontractors yet. Add one using the form above.</td></tr>';
                    return;
                }

                const esc = (v) => (v ? String(v).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])) : '');
                const rows = subs.map(([id, s]) => {
                    const name = esc(s.name);
                    const reg = esc(s.registrationNumber || '');
                    const contact = esc([s.contactName, s.contactEmail, s.contactPhone].filter(Boolean).join(' • '));
                    const addr = esc(s.address || '');
                    return `
                        <tr>
                            <td>${name}</td>
                            <td>${reg}</td>
                            <td>${contact}</td>
                            <td>${addr}</td>
                            <td>
                                <button class="btn btn-secondary" title="Edit" aria-label="Edit" onclick="window.companyManagement?.editModalSubcontractor('${id}'); window.companyManagement?.openSubcontractorModal();">
                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                </button>
                                <button class="btn btn-danger" title="Delete" aria-label="Delete" onclick="window.companyManagement?.deleteSubcontractor('${id}')">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                tbody.innerHTML = rows;
            }

            resetSubcontractorForm() {
                const fields = ['subcontractorId','subcontractorName','subcontractorRegistration','subcontractorContactName','subcontractorContactEmail','subcontractorContactPhone','subcontractorAddress','subcontractorNotes'];
                fields.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            }

            editSubcontractor(id) {
                if (!this.subcontractors || !this.subcontractors[id]) return;
                const s = this.subcontractors[id];
                const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
                set('subcontractorId', id);
                set('subcontractorName', s.name);
                set('subcontractorRegistration', s.registrationNumber);
                set('subcontractorContactName', s.contactName);
                set('subcontractorContactEmail', s.contactEmail);
                set('subcontractorContactPhone', s.contactPhone);
                set('subcontractorAddress', s.address);
                set('subcontractorNotes', s.notes);
                this.showNotification('Loaded subcontractor for editing.', 'info');
            }

            async saveSubcontractor() {
                try {
                    if (!this.companyId) {
                        this.showNotification('Company not loaded yet.', 'error');
                        return;
                    }
                    const get = (id) => document.getElementById(id)?.value?.trim() || '';
                    const id = get('subcontractorId');
                    const name = get('subcontractorName');
                    if (!name) {
                        this.showNotification('Company Name is required.', 'warning');
                        return;
                    }
                    const data = {
                        name,
                        registrationNumber: get('subcontractorRegistration'),
                        contactName: get('subcontractorContactName'),
                        contactEmail: get('subcontractorContactEmail'),
                        contactPhone: get('subcontractorContactPhone'),
                        address: get('subcontractorAddress'),
                        notes: get('subcontractorNotes'),
                        updatedAt: new Date().toISOString()
                    };

                    const baseRef = db.ref(`companies/${this.companyId}/subcontractors`);
                    if (id) {
                        await baseRef.child(id).update(data);
                        this.showNotification('Subcontractor updated.', 'success');
                    } else {
                        const newRef = baseRef.push();
                        await newRef.set({ ...data, createdAt: new Date().toISOString(), id: newRef.key });
                        this.showNotification('Subcontractor added.', 'success');
                    }
                    this.resetSubcontractorForm();
                    await this.loadSubcontractors();
                } catch (error) {
                    console.error('Error saving subcontractor:', error);
                    this.showNotification('Failed to save subcontractor.', 'error');
                }
            }

            async deleteSubcontractor(id) {
                try {
                    if (!this.companyId || !id) return;
                    const confirmed = confirm('Delete this subcontractor? This cannot be undone.');
                    if (!confirmed) return;
                    await db.ref(`companies/${this.companyId}/subcontractors/${id}`).remove();
                    this.showNotification('Subcontractor deleted.', 'success');
                    await this.loadSubcontractors();
                } catch (error) {
                    console.error('Error deleting subcontractor:', error);
                    this.showNotification('Failed to delete subcontractor.', 'error');
                }
            }

            // Subcontractors Modal
            openSubcontractorModal() {
                const modal = document.getElementById('subcontractorsModal');
                if (!modal) return;
                this.resetModalSubForm();
                modal.classList.add('show');
                modal.style.display = 'flex';
            }

            closeSubcontractorModal() {
                const modal = document.getElementById('subcontractorsModal');
                if (modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                }
            }

            resetModalSubForm() {
                ['modalSub_id','modalSub_name','modalSub_reg','modalSub_contactName','modalSub_contactEmail','modalSub_contactPhone','modalSub_address','modalSub_notes']
                    .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            }

            // renderModalSubcontractors removed as table moved to profile tab

            editModalSubcontractor(id) {
                if (!this.subcontractors || !this.subcontractors[id]) return;
                const s = this.subcontractors[id];
                const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
                set('modalSub_id', id);
                set('modalSub_name', s.name);
                set('modalSub_reg', s.registrationNumber);
                set('modalSub_contactName', s.contactName);
                set('modalSub_contactEmail', s.contactEmail);
                set('modalSub_contactPhone', s.contactPhone);
                set('modalSub_address', s.address);
                set('modalSub_notes', s.notes);
            }

            async saveModalSubcontractor() {
                try {
                    if (!this.companyId) return;
                    const get = (id) => document.getElementById(id)?.value?.trim() || '';
                    const id = get('modalSub_id');
                    const name = get('modalSub_name');
                    if (!name) {
                        this.showNotification('Company Name is required.', 'warning');
                        return;
                    }
                    const data = {
                        name,
                        registrationNumber: get('modalSub_reg'),
                        contactName: get('modalSub_contactName'),
                        contactEmail: get('modalSub_contactEmail'),
                        contactPhone: get('modalSub_contactPhone'),
                        address: get('modalSub_address'),
                        notes: get('modalSub_notes'),
                        updatedAt: new Date().toISOString()
                    };
                    const baseRef = db.ref(`companies/${this.companyId}/subcontractors`);
                    if (id) {
                        await baseRef.child(id).update(data);
                    } else {
                        const newRef = baseRef.push();
                        await newRef.set({ ...data, createdAt: new Date().toISOString(), id: newRef.key });
                    }
                    await this.loadSubcontractors();
                    this.showNotification('Subcontractor saved.', 'success');
                    this.resetModalSubForm();
                } catch (e) {
                    console.error('saveModalSubcontractor error:', e);
                    this.showNotification('Failed to save subcontractor.', 'error');
                }
            }

            async updateDashboardInfo() {
                try {
                    console.log('🔄 Updating dashboard info...');
                    
                    if (!this.companyData) {
                        console.warn('⚠️ No company data available');
                        return;
                    }

                    // Update company status
                    const statusElement = document.getElementById('companyStatus');
                    if (statusElement) {
                        statusElement.textContent = this.companyData.status === 'active' ? 'Active' : 'Inactive';
                        statusElement.className = `status-badge ${this.companyData.status === 'active' ? 'status-active' : 'status-inactive'}`;
                    }

                    // Update subscription info
                    const planElement = document.getElementById('subscriptionPlan');
                    if (planElement) {
                        planElement.textContent = this.companyData.selectedPlan || 'Enterprise';
                    }

                    // Fetch userQuota directly from Firebase company scope
                    let userQuota = 50; // Default fallback
                    if (this.companyId) {
                        try {
                            const quotaSnapshot = await db.ref(`companies/${this.companyId}/userQuota`).once('value');
                            if (quotaSnapshot.exists()) {
                                userQuota = quotaSnapshot.val();
                                console.log(`📊 Firebase quota fetched: ${userQuota}`);
                            } else {
                                console.log('⚠️ No userQuota found in Firebase, using default:', userQuota);
                            }
                        } catch (quotaError) {
                            console.error('❌ Error fetching quota from Firebase:', quotaError);
                        }
                    }

                    // Calculate current user count using this.users array (includes both regular users and administrators)
                    let currentUsers = 0;
                    if (this.users && Array.isArray(this.users)) {
                        currentUsers = this.users.length;
                        console.log(`👥 Users from this.users array: ${currentUsers}`);
                    } else if (this.companyData.users) {
                        // Fallback to company data users if this.users is not available
                        currentUsers = Object.keys(this.companyData.users).length;
                        
                        // Add administrator to count if they exist but aren't in the users list
                        if (this.companyData.admin && this.companyData.admin.uid) {
                            const adminInUsersList = this.companyData.users[this.companyData.admin.uid];
                            if (!adminInUsersList) {
                                currentUsers += 1;
                            }
                        }
                        console.log(`👥 Users from company data: ${currentUsers}`);
                    } else if (this.companyData.admin) {
                        // If no users list but admin exists, count the admin
                        currentUsers = 1;
                        console.log(`👥 Only admin exists: ${currentUsers}`);
                    }

                    console.log(`📈 Quota display will show: ${currentUsers}/${userQuota}`);

                    // Update quota display - target the correct element ID
                    const quotaElement = document.getElementById('userQuota');
                    if (quotaElement) {
                        quotaElement.textContent = `${currentUsers} / ${userQuota} Users`;
                        console.log(`✅ Updated userQuota element: ${currentUsers} / ${userQuota} Users`);
                    } else {
                        console.warn('⚠️ userQuota element not found');
                    }
                    
                    // Also update userQuotaDisplay if it exists (for other parts)
                    const userQuotaDisplay = document.getElementById('userQuotaDisplay');
                    if (userQuotaDisplay) {
                        userQuotaDisplay.textContent = `${currentUsers}/${userQuota}`;
                        console.log(`✅ Updated userQuotaDisplay element: ${currentUsers}/${userQuota}`);
                    }
                    
                    // Update features display by reloading from Firebase
                    await this.loadSelectedFeatures();

                    console.log('✅ Dashboard info updated successfully');
                } catch (error) {
                    console.error('❌ Error updating dashboard info:', error);
                }
            }

            async loadUsers() {
                try {
                    console.log('📊 Loading users for company (fresh from DB):', this.companyId);
                    if (!this.companyId) {
                        console.warn('⚠️ Cannot load users: missing companyId');
                        this.users = [];
                        await this.displayUsers([]);
                        return;
                    }

                    // Always fetch fresh users from Firebase to reflect latest changes (including conversion)
                    const usersSnap = await db.ref(`companies/${this.companyId}/users`).once('value');
                    const usersObj = usersSnap.exists() ? usersSnap.val() : {};

                    // Keep local cache in sync
                    if (!this.companyData) this.companyData = {};
                    this.companyData.users = usersObj;

                    const users = Object.entries(usersObj).map(([uid, userData]) => ({ uid, ...userData }));

                    this.users = users; // Store for dashboard computations
                    console.log(`✅ Loaded ${users.length} users from Firebase`);

                    await this.displayUsers(users);
                    await this.updateDashboardInfo(); // Ensure quota and counts update
                    console.log('🔄 Dashboard info updated after loading users');
                } catch (err) {
                    console.error('❌ Failed to load users from Firebase:', err);
                    // Fallback to in-memory if available
                    const fallbackUsers = this.companyData?.users ? Object.entries(this.companyData.users).map(([uid, u]) => ({ uid, ...u })) : [];
                    this.users = fallbackUsers;
                    await this.displayUsers(fallbackUsers);
                }
            }

            async displayUsers(users) {
                const tableBody = document.getElementById('usersTableBody');
                if (!tableBody) return;

                // Enforce company name visibility for current viewer
                const viewerUid = this.currentUser?.uid || this.currentUser?.id;
                const companyId = this.companyId;
                let allowedIdsSet = null;
                try {
                    if (viewerUid && companyId) {
                        const visSnap = await db.ref(`companies/${companyId}/accessControl/companyVisibility/${viewerUid}/allowedIds`).once('value');
                        const allowed = visSnap.val() || null;
                        if (allowed) {
                            allowedIdsSet = new Set(Object.keys(allowed).filter(k => allowed[k]));
                        }
                    }
                } catch (e) { console.warn('Company visibility load failed, defaulting to main company only', e); }
                if (!allowedIdsSet || allowedIdsSet.size === 0) {
                    allowedIdsSet = new Set([companyId]);
                }

                const filteredUsers = users.filter(u => {
                    const employerId = (u && typeof u.employerCompanyId === 'string' && u.employerCompanyId) ? u.employerCompanyId : companyId;
                    return allowedIdsSet.has(employerId);
                });

                // Include all visible users (no filtering out administrators)
                console.log(`🔍 Displaying ${filteredUsers.length} visible users (of ${users.length}) in the table`);
                if (filteredUsers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
                    return;
                }

                // Prepare cache for company names
                if (!this.companyNameCache) this.companyNameCache = {};

                // Resolve role names and company names for all users
                const usersWithResolvedInfo = await Promise.all(filteredUsers.map(async (user) => {
                    let roleName = user.role || 'User';
                    let companyName = '-';
                    
                    if (user.role) {
                        try {
                            const resolvedRoleName = await this.getRoleNameById(user.role);
                            if (resolvedRoleName && resolvedRoleName !== user.role) {
                                roleName = resolvedRoleName;
                            }
                        } catch (error) {
                            console.warn('Error resolving role name for user:', user.uid, error);
                        }
                    }

                    // Resolve company name with preference order:
                    // 1) user.employerCompanyName
                    // 2) lookup by user.employerCompanyId (from cache or Firebase)
                    // 3) current company name (this.companyData.companyName)
                    try {
                        if (user.employerCompanyName && typeof user.employerCompanyName === 'string') {
                            companyName = user.employerCompanyName;
                        } else if (user.employerCompanyId && typeof user.employerCompanyId === 'string') {
                            const cached = this.companyNameCache[user.employerCompanyId];
                            if (cached) {
                                companyName = cached;
                            } else if (window.firebase && window.firebase.database) {
                                const db = window.firebase.database();
                                // Try fetching just the companyName field; fallback to whole object if needed
                                let nameSnap = await db.ref(`companies/${user.employerCompanyId}/companyName`).once('value');
                                let nameVal = nameSnap && nameSnap.val ? nameSnap.val() : null;
                                if (!nameVal) {
                                    const compSnap = await db.ref(`companies/${user.employerCompanyId}`).once('value');
                                    const comp = compSnap && compSnap.val ? compSnap.val() : null;
                                    nameVal = comp && comp.companyName ? comp.companyName : null;
                                }
                                if (nameVal) {
                                    companyName = nameVal;
                                    this.companyNameCache[user.employerCompanyId] = nameVal;
                                }
                            }
                        }
                    } catch (err) {
                        console.warn('Error resolving company name for user:', user.uid, err);
                    }

                    if (!companyName || companyName === '-') {
                        companyName = (this.companyData && this.companyData.companyName) ? this.companyData.companyName : '-';
                    }
                    
                    return { ...user, displayRoleName: roleName, displayCompanyName: companyName };
                }));

                tableBody.innerHTML = usersWithResolvedInfo.map(user => {
                    // Check if user is administrator
                    const isAdmin = user.role === 'company-admin' || user.role === 'administrator' || 
                                   user.isCompanyAdmin === true ||
                                   user.isAdmin === true ||
                                   (this.companyData && this.companyData.admin && this.companyData.admin.uid === user.uid);
                    
                    return `
                    <tr class="user-row ${isAdmin ? 'admin-row' : ''}" data-user-id="${user.uid}" data-user-email="${user.email || ''}" onclick="window.companyManagement.editUser('${user.uid}')" style="cursor: pointer;">
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    ${this.getInitials(user.name || user.email, user.firstName || '', user.lastName || '')}
                                </div>
                                <div class="user-details">
                                    <div class="user-name" style="display: flex; align-items: center; gap: 0.5rem;">
                                        ${isAdmin ? '<i class="fas fa-crown" style="color: #ffd700;" title="Administrator"></i>' : ''}
                                        ${(user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()) || 'Unknown'}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${user.accountType === 'without-account' || user.reportingOnly === true || user.canSignIn === false ? '-' : (user.email || '-')}
                        </td>
                        <td>
                            <span class="company-name">
                                ${user.displayCompanyName || '-'}
                            </span>
                        </td>
                        <td>
                            <span class="role-badge role-${user.role || 'user'}">
                                ${user.displayRoleName}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${user.status === 'active' ? 'status-active' : 'status-inactive'}">
                                ${user.status === 'active' ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>${user.lastLogin ? this.formatDate(user.lastLogin) : 'Never'}</td>
                    </tr>`;
                }).join('');
            }

            // Search users in the users table (by name, email, employee ID, company, role)
            searchUsers() {
                try {
                    const input = document.getElementById('userSearchInput');
                    const q = (input && input.value ? input.value : '').trim().toLowerCase();
                    if (!q) {
                        // Empty query -> show all
                        this.displayUsers(this.users || []);
                        return;
                    }

                    const list = Array.isArray(this.users) ? this.users : [];
                    const filtered = list.filter(u => {
                        const name = ((u.name) || `${u.firstName || ''} ${u.lastName || ''}` || '').toLowerCase();
                        const email = (u.email || '').toLowerCase();
                        const employeeId = (u.employeeId || '').toLowerCase();
                        const dept = (u.department || '').toLowerCase();
                        const role = (u.role || '').toLowerCase();
                        const company = ((u.displayCompanyName) || (u.employerCompanyName) || '').toLowerCase();
                        return (
                            name.includes(q) ||
                            email.includes(q) ||
                            employeeId.includes(q) ||
                            dept.includes(q) ||
                            role.includes(q) ||
                            company.includes(q)
                        );
                    });

                    this.displayUsers(filtered);
                } catch (err) {
                    console.error('User search failed:', err);
                }
            }

            // Clear search and show all users
            clearUserSearch() {
                const input = document.getElementById('userSearchInput');
                if (input) input.value = '';
                this.displayUsers(this.users || []);
            }

            getInitials(name, fallbackFirstName = '', fallbackLastName = '') {
                let base = name && name.trim() ? name : `${fallbackFirstName || ''} ${fallbackLastName || ''}`.trim();
                if (!base) return '?';
                return base.split(' ').filter(Boolean).map(word => word.charAt(0)).join('').toUpperCase().slice(0, 2);
            }

            validateAddUserForm() {
                const form = document.getElementById('addUserForm');
                if (!form) return false;
                // Determine selected user type
                const accountType = form.querySelector('input[name="userAccountType"]:checked')?.value || 'with-account';
                const isWithAccount = accountType === 'with-account';

                // Compose required fields based on user type
                const required = isWithAccount
                    ? ['userFirstName', 'userLastName', 'userRole', 'userEmail', 'userPassword']
                    : ['userFirstName', 'userLastName'];
                let isValid = true;

                required.forEach(fieldName => {
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (!field || !field.value.trim()) {
                        isValid = false;
                        console.error(`Required field missing: ${fieldName}`);
                        
                        // Show visual feedback
                        const formGroup = field?.closest('.form-group');
                        if (formGroup) {
                            formGroup.classList.add('error');
                            const errorDiv = formGroup.querySelector('.form-error');
                            if (errorDiv) {
                                errorDiv.textContent = 'This field is required';
                                errorDiv.style.display = 'block';
                            }
                        }
                    } else {
                        // Remove error styling if field is valid
                        const formGroup = field.closest('.form-group');
                        if (formGroup) {
                            formGroup.classList.remove('error');
                            const errorDiv = formGroup.querySelector('.form-error');
                            if (errorDiv) {
                                errorDiv.style.display = 'none';
                            }
                        }
                    }
                });

                // Validate password length (only if provided or required)
                const passwordField = form.querySelector('[name="userPassword"]');
                if (isWithAccount && (!passwordField || !passwordField.value)) {
                    isValid = false;
                    const formGroup = passwordField?.closest('.form-group') || document.getElementById('userPasswordGroup');
                    if (formGroup) {
                        formGroup.classList.add('error');
                        const errorDiv = formGroup.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.textContent = 'Password is required for account users';
                            errorDiv.style.display = 'block';
                        }
                    }
                } else if (passwordField && passwordField.value && passwordField.value.length < 6) {
                    isValid = false;
                    const formGroup = passwordField.closest('.form-group');
                    if (formGroup) {
                        formGroup.classList.add('error');
                        const errorDiv = formGroup.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.textContent = 'Password must be at least 6 characters long';
                            errorDiv.style.display = 'block';
                        }
                    }
                }

                // Validate email format (only if provided or required)
                const emailField = form.querySelector('[name="userEmail"]');
                if (isWithAccount && (!emailField || !emailField.value)) {
                    isValid = false;
                    const formGroup = emailField?.closest('.form-group') || document.getElementById('userEmailGroup');
                    if (formGroup) {
                        formGroup.classList.add('error');
                        const errorDiv = formGroup.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.textContent = 'Email is required for account users';
                            errorDiv.style.display = 'block';
                        }
                    }
                } else if (emailField && emailField.value) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(emailField.value)) {
                        isValid = false;
                        const formGroup = emailField.closest('.form-group');
                        if (formGroup) {
                            formGroup.classList.add('error');
                            const errorDiv = formGroup.querySelector('.form-error');
                            if (errorDiv) {
                                errorDiv.textContent = 'Please enter a valid email address';
                                errorDiv.style.display = 'block';
                            }
                        }
                    }
                }

                // Validate employee ID uniqueness (if provided)
                const employeeIdField = form.querySelector('[name="userEmployeeId"]');
                if (employeeIdField && employeeIdField.value.trim()) {
                    // Check if employee ID is unique within the company
                    const employeeId = employeeIdField.value.trim();
                    if (this.companyData && this.companyData.users) {
                        const existingUser = Object.values(this.companyData.users).find(user => 
                            user.employeeId && user.employeeId.toLowerCase() === employeeId.toLowerCase()
                        );
                        
                        if (existingUser) {
                            isValid = false;
                            const formGroup = employeeIdField.closest('.form-group');
                            if (formGroup) {
                                formGroup.classList.add('error');
                                const errorDiv = formGroup.querySelector('.form-error');
                                if (errorDiv) {
                                    errorDiv.textContent = 'Employee ID already exists';
                                    errorDiv.style.display = 'block';
                                }
                            }
                        }
                    }
                }

                return isValid;
            }

            async addNewUser() {
                if (this.userCreationInProgress) return;

                this.userCreationInProgress = true;
                
                try {
                    const form = document.getElementById('addUserForm');
                    if (!form) return;

                    const formData = new FormData(form);
                    const firstName = (formData.get('userFirstName') || '').toString().trim();
                    const lastName = (formData.get('userLastName') || '').toString().trim();
                    const fullName = `${firstName} ${lastName}`.trim();
                    
                    // Get line manager name from dropdown text instead of ID
                    let lineManagerName = '';
                    const lineManagerSelect = document.getElementById('userLineManager');
                    if (lineManagerSelect && lineManagerSelect.value) {
                        const selectedOption = lineManagerSelect.options[lineManagerSelect.selectedIndex];
                        if (selectedOption && selectedOption.value !== '') {
                            // Extract just the name part from the display text (remove job title/department in parentheses)
                            const displayText = selectedOption.textContent || selectedOption.text;
                            lineManagerName = displayText.split(' (')[0].trim(); // Get name before any parentheses
                            console.log(`📋 Line manager selected: ID=${lineManagerSelect.value}, Name="${lineManagerName}"`);
                        }
                    }
                    
                    // Determine employing company/subcontractor selection
                    let employerCompanyType = 'main';
                    let employerCompanyId = this.companyId;
                    let employerCompanyName = (this.companyData && this.companyData.companyName) || 'Main Company';

                    const companyAffSelect = document.getElementById('userCompanyAffiliation');
                    if (companyAffSelect && companyAffSelect.value) {
                        try {
                            const parsed = JSON.parse(companyAffSelect.value);
                            if (parsed && parsed.id) {
                                employerCompanyType = parsed.type || 'main';
                                employerCompanyId = parsed.id || this.companyId;
                                employerCompanyName = parsed.name || employerCompanyName;
                            }
                        } catch (e) {
                            console.warn('⚠️ Could not parse userCompanyAffiliation value, using defaults');
                        }
                    }

                    const accountType = form.querySelector('input[name="userAccountType"]:checked')?.value || 'with-account';
                    const isWithAccount = accountType === 'with-account';

                    const userData = {
                        name: fullName,
                        firstName: firstName,
                        lastName: lastName,
                        email: formData.get('userEmail'),
                        employeeId: formData.get('userEmployeeId') || '',
                        role: formData.get('userRole'),
                        department: formData.get('userDepartment') || '',
                        jobTitle: formData.get('userJobTitle') || '',
                        lineManager: lineManagerName, // Store the full name instead of ID
                        lineManagerId: formData.get('userLineManager') || '', // Also store the ID for reference
                        phone: formData.get('userPhone') || '',
                        countryCode: formData.get('userCountryCode') || '',
                        address: formData.get('userAddress') || '',
                        status: formData.get('userStatus') || 'active',
                        isCompanyAdmin: formData.get('userIsCompanyAdmin') === 'on',
                        isAdmin: formData.get('userIsCompanyAdmin') === 'on', // For backward compatibility
                        companyId: this.companyId,
                        employerCompanyType,
                        employerCompanyId,
                        employerCompanyName,
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString(),
                        createdBy: this.currentUser?.uid || 'system',
                        accountType: isWithAccount ? 'with-account' : 'without-account',
                        canSignIn: isWithAccount
                    };
                    let createdUserId = null;
                    if (isWithAccount) {
                        // Get the initial password from form
                        const initialPassword = formData.get('userPassword');
                        if (!initialPassword || initialPassword.trim().length < 6) {
                            this.showNotification('Password must be at least 6 characters long', 'error');
                            this.userCreationInProgress = false;
                            return;
                        }

                        // Create user in Firebase Auth - Firebase handles duplicate email detection
                        const userCredential = await auth.createUserWithEmailAndPassword(userData.email, initialPassword);
                        const newUser = userCredential.user;

                        // Add user to company structure
                        await db.ref(`companies/${this.companyId}/users/${newUser.uid}`).set({
                            ...userData,
                            authUid: newUser.uid,
                            userId: newUser.uid,
                            uid: newUser.uid
                        });

                        // Add user to global users collection
                        await db.ref(`users/${newUser.uid}`).set({
                            ...userData,
                            uid: newUser.uid,
                            authUid: newUser.uid
                        });
                        createdUserId = newUser.uid;
                    } else {
                        // Create reporting-only user without Firebase Auth
                        // Generate a unique key under users path
                        const newUserRef = db.ref('users').push();
                        const generatedUid = newUserRef.key;

                        const dbOnlyUser = {
                            ...userData,
                            uid: generatedUid,
                            userId: generatedUid,
                            authUid: null,
                            emailVerified: false,
                            reportingOnly: true
                        };

                        // Add to global users
                        await newUserRef.set(dbOnlyUser);
                        // Add to company structure
                        await db.ref(`companies/${this.companyId}/users/${generatedUid}`).set(dbOnlyUser);
                        createdUserId = generatedUid;
                    }

                    // Store role name in company path as requested in previous conversations
                    if (userData.role && window.storeRoleNameInCompanyPath) {
                        try {
                            const roleName = await this.getRoleNameById(userData.role);
                            if (roleName) {
                                await window.storeRoleNameInCompanyPath(this.companyId, userData.role, roleName);
                            }
                        } catch (roleError) {
                            console.warn('Failed to store role name in company path:', roleError);
                        }
                    }

                    this.showNotification('User created successfully! Employee ID: ' + (userData.employeeId || 'Auto-generated'), 'success');
                    form.reset();
                    await this.loadUsers();
                    await this.updateDashboardInfo(); // Update quota display after adding user
                    this.hideModal('addUserModal');

                    // Refresh org chart if available
                    if (window.refreshOrgChart) {
                        try {
                            await window.refreshOrgChart();
                            console.log('✅ Org chart refreshed after user creation');
                        } catch (error) {
                            console.warn('⚠️ Failed to refresh org chart:', error);
                        }
                    }

                    // Trigger cross-page communication for org chart refresh
                    try {
                        // Use custom event for same-page communication
                        if (createdUserId) {
                            window.dispatchEvent(new CustomEvent('userDataUpdated', {
                                detail: { action: 'created', userId: createdUserId, userData: userData }
                            }));
                        }

                        // Use localStorage for cross-tab communication
                        localStorage.setItem('orgChartRefreshNeeded', 'true');
                        setTimeout(() => localStorage.removeItem('orgChartRefreshNeeded'), 1000);
                        
                        console.log('✅ Cross-page refresh signals sent');
                    } catch (error) {
                        console.warn('⚠️ Failed to send cross-page refresh signals:', error);
                    }

                } catch (error) {
                    console.error('Error creating user:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    // Provide user-friendly error messages for common Firebase Auth errors
                    let errorMessage = error.message;
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'This email address is already registered. Please use a different email or check if the user already exists.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'The email address format is invalid. Please enter a valid email.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'The password is too weak. Please use at least 6 characters.';
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage = 'Email/password accounts are not enabled. Please contact support.';
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = 'Too many failed attempts. Please try again later.';
                    } else {
                        // For debugging: show the actual error code and message
                        errorMessage = `Error (${error.code}): ${error.message}`;
                    }
                    this.showNotification(errorMessage, 'error');
                } finally {
                    this.userCreationInProgress = false;
                }
            }

            // Helper method to get role name by ID
            async getRoleNameById(roleId) {
                try {
                    if (!roleId || !this.companyId) return null;
                    
                    const roleRef = db.ref(`companies/${this.companyId}/roles/${roleId}/name`);
                    const snapshot = await roleRef.once('value');
                    
                    if (snapshot.exists()) {
                        return snapshot.val();
                    }
                    
                    // Fallback: get name from role object
                    const roleObjRef = db.ref(`companies/${this.companyId}/roles/${roleId}`);
                    const roleSnapshot = await roleObjRef.once('value');
                    
                    if (roleSnapshot.exists()) {
                        const roleData = roleSnapshot.val();
                        return roleData.name || roleId;
                    }
                    
                    return roleId; // Fallback to ID
                } catch (error) {
                    console.error('Error getting role name:', error);
                    return roleId;
                }
            }

            async loadCompanyLogo() {
                if (!this.companyData || !this.companyData.logo) {
                    this.updateLogoDisplay();
                    return;
                }

                const logoPreview = document.getElementById('logoPreview');
                if (logoPreview) {
                    logoPreview.src = this.companyData.logo;
                    logoPreview.classList.add('visible');
                }
                
                this.updateLogoDisplay();
            }

            async handleLogoUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const storageRef = storage.ref(`company-logos/${this.companyId}/${file.name}`);
                    const uploadTask = await storageRef.put(file);
                    const downloadURL = await uploadTask.ref.getDownloadURL();

                    // Update company data with logo URL
                    await db.ref(`companies/${this.companyId}`).update({
                        logo: downloadURL
                    });

                    this.companyData.logo = downloadURL;
                    this.showNotification('Logo uploaded successfully!', 'success');
                    await this.loadCompanyLogo();
                    this.updateLogoDisplay();

                } catch (error) {
                    console.error('Error uploading logo:', error);
                    this.showNotification('Error uploading logo: ' + error.message, 'error');
                }
            }

            async removeLogo() {
                try {
                    // Update company data to remove logo URL
                    await db.ref(`companies/${this.companyId}`).update({
                        logo: null
                    });

                    this.companyData.logo = null;
                    this.showNotification('Logo removed successfully!', 'success');
                    this.updateLogoDisplay();

                } catch (error) {
                    console.error('Error removing logo:', error);
                    this.showNotification('Error removing logo: ' + error.message, 'error');
                }
            }

            updateLogoDisplay() {
                const logoPreview = document.getElementById('logoPreview');
                const logoPlaceholder = document.getElementById('logoPlaceholder');
                const logoActions = document.getElementById('logoActions');
                const uploadText = document.querySelector('.logo-upload-text');

                if (this.companyData && this.companyData.logo) {
                    // Show logo
                    if (logoPreview) {
                        logoPreview.src = this.companyData.logo;
                        logoPreview.classList.add('visible');
                    }
                    if (logoPlaceholder) logoPlaceholder.style.display = 'none';
                    if (logoActions) logoActions.classList.remove('hidden');
                    if (uploadText) uploadText.style.display = 'none';
                } else {
                    // Show placeholder
                    if (logoPreview) logoPreview.classList.remove('visible');
                    if (logoPlaceholder) logoPlaceholder.style.display = 'flex';
                    if (logoActions) logoActions.classList.add('hidden');
                    if (uploadText) uploadText.style.display = 'block';
                }
            }

            // HR Stamp handlers
            async handleHrStampUpload(event) {
                try {
                    const file = event?.target?.files?.[0];
                    if (!file || !this.companyId) return;
                    const storageRef = storage.ref(`company-hr-stamps/${this.companyId}/${file.name}`);
                    const uploadTask = await storageRef.put(file);
                    const downloadURL = await uploadTask.ref.getDownloadURL();
                    await db.ref(`companies/${this.companyId}`).update({ hrStamp: downloadURL });
                    if (!this.companyData) this.companyData = {};
                    this.companyData.hrStamp = downloadURL;
                    this.showNotification('HR stamp uploaded successfully!', 'success');
                    this.updateHrStampDisplay();
                } catch (error) {
                    console.error('Error uploading HR stamp:', error);
                    this.showNotification('Error uploading HR stamp: ' + error.message, 'error');
                }
            }

            async removeHrStamp() {
                try {
                    if (!this.companyId) return;
                    await db.ref(`companies/${this.companyId}`).update({ hrStamp: null });
                    if (!this.companyData) this.companyData = {};
                    this.companyData.hrStamp = null;
                    this.showNotification('HR stamp removed successfully!', 'success');
                    this.updateHrStampDisplay();
                } catch (error) {
                    console.error('Error removing HR stamp:', error);
                    this.showNotification('Error removing HR stamp: ' + error.message, 'error');
                }
            }

            updateHrStampDisplay() {
                const stampPreview = document.getElementById('hrStampPreview');
                const stampPlaceholder = document.getElementById('hrStampPlaceholder');
                const stampActions = document.getElementById('hrStampActions');
                const hasStamp = !!(this.companyData && this.companyData.hrStamp);

                if (stampPreview) {
                    if (hasStamp) {
                        stampPreview.src = this.companyData.hrStamp;
                        stampPreview.classList.add('visible');
                    } else {
                        stampPreview.src = '';
                        stampPreview.classList.remove('visible');
                    }
                }
                if (stampPlaceholder) {
                    stampPlaceholder.style.display = hasStamp ? 'none' : 'flex';
                }
                if (stampActions) {
                    stampActions.classList.toggle('hidden', !hasStamp);
                }
            }

            toggleFeature(card) {
                const feature = card.dataset.feature;
                if (!feature) return;

                if (this.selectedFeatures.has(feature)) {
                    this.selectedFeatures.delete(feature);
                    card.classList.remove('selected');
                } else {
                    this.selectedFeatures.add(feature);
                    card.classList.add('selected');
                }

                this.updatePricingDisplay();
                this.updateSaveButtonState(); // Update save button when features change
            }

            updateFeatureSelection() {
                document.querySelectorAll('.feature-card').forEach(card => {
                    const feature = card.dataset.feature;
                    const isSubscribed = this.currentlySubscribedFeatures.has(feature);
                    const isSelected = this.selectedFeatures.has(feature);
                    
                    if (isSubscribed) {
                        // Locked/Subscribed features
                        card.classList.add('selected', 'active', 'subscribed');
                        const statusBadge = card.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.classList.remove('inactive', 'active');
                            statusBadge.classList.add('locked');
                            statusBadge.innerHTML = '<i class="fas fa-lock"></i> Locked';
                        }
                    } else if (isSelected) {
                        // Selected features
                        card.classList.add('selected', 'active');
                        card.classList.remove('subscribed');
                        const statusBadge = card.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.classList.remove('inactive', 'locked');
                            statusBadge.classList.add('active');
                            statusBadge.innerHTML = '<i class="fas fa-check"></i> Active';
                        }
                    } else {
                        // Unselected features
                        card.classList.remove('selected', 'active', 'subscribed');
                        const statusBadge = card.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.classList.remove('active', 'locked');
                            statusBadge.classList.add('inactive');
                            statusBadge.innerHTML = '<i class="fas fa-times"></i> Inactive';
                        }
                    }
                });
                
                // Also update checkboxes to stay synchronized
                document.querySelectorAll('input[data-feature-id]').forEach(checkbox => {
                    const featureId = checkbox.getAttribute('data-feature-id');
                    const isSubscribed = this.currentlySubscribedFeatures.has(featureId);
                    const isSelected = this.selectedFeatures.has(featureId);
                    
                    if (isSubscribed) {
                        checkbox.checked = true;
                        checkbox.disabled = true;
                    } else {
                        checkbox.checked = isSelected;
                        checkbox.disabled = false;
                    }
                    
                    const featureItem = checkbox.closest('.feature-checkbox-item');
                    if (featureItem) {
                        if (isSelected || isSubscribed) {
                            featureItem.classList.add('selected');
                        } else {
                            featureItem.classList.remove('selected');
                        }
                    }
                });
            }

            updatePricingDisplay() {
                const userQuota = parseInt(document.getElementById('userQuotaInput')?.value) || 25;
                const baseCost = this.basePrices.enterprise * userQuota;
                
                // Calculate feature cost based on individual feature prices
                let totalFeatureCost = 0;
                if (this.selectedFeatures && this.selectedFeatures.size > 0 && this.platformFeatures) {
                    this.selectedFeatures.forEach(selectedFeatureId => {
                        // Find the feature in the platform features array
                        const feature = this.platformFeatures.find(f => f.id === selectedFeatureId);
                        if (feature && feature.price) {
                            totalFeatureCost += parseFloat(feature.price) * userQuota;
                            console.log(`💰 Feature ${feature.name || selectedFeatureId}: $${feature.price}/user × ${userQuota} users = $${(parseFloat(feature.price) * userQuota)}`);
                        }
                    });
                }
                
                const totalCost = baseCost + totalFeatureCost;
                
                // Calculate current cost for comparison
                const currentUserQuota = this.companyData?.userQuota || 25;
                const currentBaseCost = this.basePrices.enterprise * currentUserQuota;
                let currentFeatureCost = 0;
                
                if (this.companyData?.selectedFeatures && this.platformFeatures) {
                    this.companyData.selectedFeatures.forEach(featureId => {
                        const feature = this.platformFeatures.find(f => f.id === featureId);
                        if (feature && feature.price) {
                            currentFeatureCost += parseFloat(feature.price) * currentUserQuota;
                        }
                    });
                }
                
                const currentTotalCost = currentBaseCost + currentFeatureCost;
                const costDifference = totalCost - currentTotalCost;
                
                console.log(`📊 Pricing calculation: Base: $${baseCost}, Features: $${totalFeatureCost}, Total: $${totalCost}, Difference: $${costDifference}`);

                const priceElement = document.getElementById('totalPrice');
                if (priceElement) {
                    priceElement.textContent = `$${totalCost.toLocaleString()}`;
                }
                
                // Show/hide payment button based on cost increase
                this.updatePaymentButtonVisibility(costDifference);
            }

            updatePaymentButtonVisibility(costDifference) {
                const payBalanceBtn = document.getElementById('payBalanceBtn');
                const priceDifferenceElement = document.getElementById('priceDifference');
                
                if (costDifference > 0) {
                    // Show payment button for cost increases
                    if (payBalanceBtn) {
                        payBalanceBtn.style.display = 'inline-flex';
                        payBalanceBtn.innerHTML = `
                            <i class="fas fa-credit-card"></i>
                            Pay Balance (+$${costDifference.toFixed(2)}/month)
                        `;
                    }
                    
                    // Update price difference display
                    if (priceDifferenceElement) {
                        priceDifferenceElement.style.display = 'block';
                        priceDifferenceElement.innerHTML = `
                            <i class="fas fa-arrow-up"></i>
                            <span>+$${costDifference.toFixed(2)}/month from current</span>
                        `;
                        priceDifferenceElement.classList.remove('decrease');
                        priceDifferenceElement.classList.add('increase');
                    }
                } else if (costDifference < 0) {
                    // Hide payment button for cost decreases (credits will be applied)
                    if (payBalanceBtn) {
                        payBalanceBtn.style.display = 'none';
                    }
                    
                    // Update price difference display for decrease
                    if (priceDifferenceElement) {
                        priceDifferenceElement.style.display = 'block';
                        priceDifferenceElement.innerHTML = `
                            <i class="fas fa-arrow-down"></i>
                            <span>-$${Math.abs(costDifference).toFixed(2)}/month from current (Credit Applied)</span>
                        `;
                        priceDifferenceElement.classList.remove('increase');
                        priceDifferenceElement.classList.add('decrease');
                    }
                } else {
                    // Hide payment button for no change
                    if (payBalanceBtn) {
                        payBalanceBtn.style.display = 'none';
                    }
                    
                    // Hide price difference display
                    if (priceDifferenceElement) {
                        priceDifferenceElement.style.display = 'none';
                    }
                }
            }

            async processPayment() {
                try {
                    console.log('🛒 Processing payment for quota increase...');
                    
                    // Get current pricing information
                    const userQuota = parseInt(document.getElementById('userQuotaInput')?.value) || 25;
                    const currentUserQuota = this.companyData?.userQuota || 25;
                    const costDifference = this.calculateCostDifference(userQuota);
                    
                    if (costDifference <= 0) {
                        this.showNotification('No payment required. Cost is same or lower than current.', 'info');
                        return;
                    }
                    
                    // Show payment confirmation
                    const confirmed = await this.showPaymentConfirmation(costDifference, userQuota, currentUserQuota);
                    
                    if (confirmed) {
                        // Simulate payment processing (replace with actual payment gateway)
                        this.showNotification('Processing payment...', 'info');
                        
                        // Show payment modal/gateway (placeholder)
                        this.showPaymentModal(costDifference);
                    }
                    
                } catch (error) {
                    console.error('❌ Error processing payment:', error);
                    this.showNotification('Payment processing failed. Please try again.', 'error');
                }
            }

            calculateCostDifference(newUserQuota) {
                const currentUserQuota = this.companyData?.userQuota || 25;
                
                // New cost calculation
                const newBaseCost = this.basePrices.enterprise * newUserQuota;
                let newFeatureCost = 0;
                
                if (this.selectedFeatures && this.platformFeatures) {
                    this.selectedFeatures.forEach(featureId => {
                        const feature = this.platformFeatures.find(f => f.id === featureId);
                        if (feature && feature.price) {
                            newFeatureCost += parseFloat(feature.price) * newUserQuota;
                        }
                    });
                }
                
                // Current cost calculation
                const currentBaseCost = this.basePrices.enterprise * currentUserQuota;
                let currentFeatureCost = 0;
                
                if (this.companyData?.selectedFeatures && this.platformFeatures) {
                    this.companyData.selectedFeatures.forEach(featureId => {
                        const feature = this.platformFeatures.find(f => f.id === featureId);
                        if (feature && feature.price) {
                            currentFeatureCost += parseFloat(feature.price) * currentUserQuota;
                        }
                    });
                }
                
                const newTotal = newBaseCost + newFeatureCost;
                const currentTotal = currentBaseCost + currentFeatureCost;
                
                return newTotal - currentTotal;
            }

            async showPaymentConfirmation(amount, newQuota, currentQuota) {
                return new Promise((resolve) => {
                    const confirmed = confirm(
                        `Payment Confirmation:\n\n` +
                        `Current Quota: ${currentQuota} users\n` +
                        `New Quota: ${newQuota} users\n` +
                        `Additional Monthly Cost: $${amount.toFixed(2)}\n\n` +
                        `Do you want to proceed with the payment?`
                    );
                    resolve(confirmed);
                });
            }

            showPaymentModal(amount) {
                const modal = document.getElementById('paymentModal');
                const modalPaymentAmount = document.getElementById('modalPaymentAmount');
                const paymentDescription = document.getElementById('paymentDescription');
                
                // Update payment amount and description
                modalPaymentAmount.textContent = `$${amount.toFixed(2)}`;
                paymentDescription.textContent = amount > 0 ? 'Subscription upgrade payment' : 'Subscription downgrade refund';
                
                // Store the amount for processing
                window.currentPaymentAmount = amount;
                
                // Reset form state
                this.resetPaymentForm();
                
                // Show the modal
                modal.classList.add('show');
                modal.style.display = 'flex';
            }

            async completePayment(amount) {
                try {
                    // Simulate payment processing
                    this.showNotification('Processing payment...', 'info');
                    
                    // Close payment modal
                    const paymentModal = document.getElementById('paymentModal');
                    if (paymentModal) {
                        paymentModal.remove();
                    }
                    
                    // Simulate payment delay
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Update quota after successful payment
                    await this.updateUserQuotaLimit();
                    
                    this.showNotification(`Payment of $${amount.toFixed(2)} processed successfully! Quota has been updated.`, 'success');
                    
                    // Hide payment button after successful payment
                    const payBalanceBtn = document.getElementById('payBalanceBtn');
                    if (payBalanceBtn) {
                        payBalanceBtn.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('❌ Payment completion failed:', error);
                    this.showNotification('Payment failed. Please try again.', 'error');
                }
            }

            resetPaymentForm() {
                // Clear payment method selection
                const paymentMethods = document.querySelectorAll('input[name="paymentMethod"]');
                paymentMethods.forEach(method => {
                    method.checked = false;
                    method.closest('.payment-option').classList.remove('selected');
                });
                
                // Hide payment forms
                document.getElementById('orangeMoneyForm').style.display = 'none';
                document.getElementById('paypalForm').style.display = 'none';
                
                // Clear form inputs
                document.getElementById('orangePhoneNumber').value = '';
                
                // Disable process payment button
                document.getElementById('processPaymentBtn').disabled = true;
            }

            selectPaymentMethod(method) {
                // Clear previous selections
                const paymentOptions = document.querySelectorAll('.payment-option');
                paymentOptions.forEach(option => option.classList.remove('selected'));
                
                // Hide all payment forms
                document.getElementById('orangeMoneyForm').style.display = 'none';
                document.getElementById('paypalForm').style.display = 'none';
                
                // Select the clicked option
                const selectedOption = document.querySelector(`input[value="${method}"]`);
                if (selectedOption) {
                    selectedOption.checked = true;
                    selectedOption.closest('.payment-option').classList.add('selected');
                    
                    // Show appropriate form
                    if (method === 'orange-money') {
                        document.getElementById('orangeMoneyForm').style.display = 'block';
                    } else if (method === 'paypal') {
                        document.getElementById('paypalForm').style.display = 'block';
                    }
                    
                    // Enable process payment button
                    document.getElementById('processPaymentBtn').disabled = false;
                }
            }

            closePaymentModal() {
                const modal = document.getElementById('paymentModal');
                modal.classList.remove('show');
                modal.style.display = 'none';
            }

            async processSelectedPayment() {
                const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
                if (!selectedMethod) {
                    this.showNotification('Please select a payment method', 'error');
                    return;
                }

                const amount = window.currentPaymentAmount || 0;
                const method = selectedMethod.value;

                try {
                    if (method === 'orange-money') {
                        await this.processOrangeMoneyPayment(amount);
                    } else if (method === 'paypal') {
                        await this.processPayPalPayment(amount);
                    }
                } catch (error) {
                    console.error('Payment processing error:', error);
                    this.showNotification('Payment failed. Please try again.', 'error');
                }
            }

            async processOrangeMoneyPayment(amount) {
                const phoneNumber = document.getElementById('orangePhoneNumber').value;
                
                if (!phoneNumber || phoneNumber.length !== 10) {
                    this.showNotification('Please enter a valid 10-digit phone number', 'error');
                    return;
                }

                // Close payment modal and show processing
                this.closePaymentModal();
                this.showPaymentProcessingModal('Orange Money');

                try {
                    // Simulate Orange Money API call
                    console.log('Processing Orange Money payment...', { amount, phoneNumber });
                    
                    // Simulate API delay
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // Simulate 90% success rate
                    if (Math.random() > 0.1) {
                        // Success
                        const transactionId = 'OM' + Date.now() + Math.floor(Math.random() * 1000);
                        await this.handlePaymentSuccess({
                            method: 'Orange Money',
                            amount: amount,
                            transactionId: transactionId,
                            phoneNumber: phoneNumber.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/, '$1 $2 $3 $4 $5')
                        });
                    } else {
                        // Failure
                        throw new Error('Orange Money payment failed. Please check your phone number and try again.');
                    }
                } catch (error) {
                    this.closePaymentProcessingModal();
                    this.showNotification(error.message || 'Orange Money payment failed', 'error');
                }
            }

            async processPayPalPayment(amount) {
                // Close payment modal and show processing
                this.closePaymentModal();
                this.showPaymentProcessingModal('PayPal');

                try {
                    // Simulate PayPal redirect and processing
                    console.log('Redirecting to PayPal...', { amount });
                    
                    // Simulate redirect delay
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // Simulate PayPal processing
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // Simulate 95% success rate
                    if (Math.random() > 0.05) {
                        // Success
                        const transactionId = 'PP' + Date.now() + Math.floor(Math.random() * 1000);
                        await this.handlePaymentSuccess({
                            method: 'PayPal',
                            amount: amount,
                            transactionId: transactionId,
                            email: 'user@example.com' // In real implementation, this would come from PayPal
                        });
                    } else {
                        // Failure
                        throw new Error('PayPal payment was cancelled or failed.');
                    }
                } catch (error) {
                    this.closePaymentProcessingModal();
                    this.showNotification(error.message || 'PayPal payment failed', 'error');
                }
            }

            showPaymentProcessingModal(method) {
                const modal = document.getElementById('paymentProcessingModal');
                const message = document.getElementById('processingMessage');
                
                if (method === 'Orange Money') {
                    message.textContent = 'Please check your phone for the Orange Money payment prompt.';
                } else if (method === 'PayPal') {
                    message.textContent = 'Redirecting to PayPal for secure payment processing...';
                }
                
                modal.classList.add('show');
                modal.style.display = 'flex';
            }

            closePaymentProcessingModal() {
                const modal = document.getElementById('paymentProcessingModal');
                modal.classList.remove('show');
                modal.style.display = 'none';
            }

            async handlePaymentSuccess(paymentDetails) {
                try {
                    // Close processing modal
                    this.closePaymentProcessingModal();
                    
                    // Update quota after successful payment
                    await this.updateUserQuotaLimit();
                    
                    // Show success modal
                    this.showPaymentSuccessModal(paymentDetails);
                    
                    // Hide payment button after successful payment
                    const payBalanceBtn = document.getElementById('payBalanceBtn');
                    if (payBalanceBtn) {
                        payBalanceBtn.style.display = 'none';
                    }
                    
                    // Log payment for record keeping
                    console.log('Payment successful:', paymentDetails);
                    
                } catch (error) {
                    console.error('Error handling payment success:', error);
                    this.showNotification('Payment was successful but there was an error updating your account. Please contact support.', 'warning');
                }
            }

            showPaymentSuccessModal(paymentDetails) {
                const modal = document.getElementById('paymentSuccessModal');
                const successDetails = document.getElementById('successDetails');
                
                successDetails.innerHTML = `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                        <div><strong>Payment Method:</strong> ${paymentDetails.method}</div>
                        <div><strong>Amount:</strong> $${paymentDetails.amount.toFixed(2)}</div>
                        <div><strong>Transaction ID:</strong> ${paymentDetails.transactionId}</div>
                        ${paymentDetails.phoneNumber ? `<div><strong>Phone:</strong> ${paymentDetails.phoneNumber}</div>` : ''}
                        ${paymentDetails.email ? `<div><strong>PayPal Email:</strong> ${paymentDetails.email}</div>` : ''}
                        <div><strong>Date:</strong> ${new Date().toLocaleString()}</div>
                    </div>
                `;
                
                modal.classList.add('show');
                modal.style.display = 'flex';
            }

            closePaymentSuccessModal() {
                const modal = document.getElementById('paymentSuccessModal');
                modal.classList.remove('show');
                modal.style.display = 'none';
                
                // Refresh the page or reload company data to reflect changes
                window.location.reload();
            }

            loadBillingHistory() {
                // Placeholder for billing history
                console.log('Loading billing history...');
            }

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('show');
                }
            }

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                }
            }

            viewUser(userId) {
                console.log('View user:', userId);
                // Implement user view functionality
            }

            async editUser(userId) {
                try {
                    console.log('Edit user:', userId);
                    
                    // ALWAYS fetch fresh user data from Firebase to ensure we have the latest saved values
                    console.log('🔄 Fetching fresh user data from Firebase...');
                    const userSnapshot = await db.ref(`companies/${this.companyId}/users/${userId}`).once('value');
                    const userData = userSnapshot.val();
                    
                    if (!userData) {
                        this.showNotification('User not found', 'error');
                        return;
                    }

                    console.log('📊 Fresh user data loaded from Firebase:', userData);

                    // Set currentEditingUser for the form submission handler
                    window.currentEditingUser = {
                        uid: userId,  // Use uid instead of id for Firebase compatibility
                        id: userId,   // Keep id as backup for compatibility
                        ...userData
                    };

                    // FIRST: Populate dropdown fields with same data as add user modal
                    await this.populateEditUserModalDropdowns();
                    console.log('✅ Edit modal dropdowns populated');

                    // Add a delay to ensure DOM is updated and dropdowns are fully populated
                    await new Promise(resolve => setTimeout(resolve, 300));

                    // THEN: Populate the edit modal fields with user data
                    console.log('📝 Populating edit modal fields with user data...');
                    
                    // Basic fields
                    const computedFirstName = userData.firstName || (userData.name ? userData.name.split(' ')[0] : '');
                    const computedLastName = userData.lastName || (userData.name ? userData.name.split(' ').slice(1).join(' ') : '');
                    this.setElementValue('editUserFirstName', computedFirstName);
                    this.setElementValue('editUserLastName', computedLastName);
                    this.setElementValue('editUserEmail', userData.email || '');
                    this.setElementValue('editUserEmployeeId', userData.employeeId || '');
                    this.setElementValue('editUserPhone', userData.phone || '');
                    this.setElementValue('editUserAddress', userData.address || '');
                    
                    // Dropdown fields with robust value setting
                    this.setDropdownValue('editUserJobTitle', userData.jobTitle || '');
                    this.setDropdownValue('editUserDepartment', userData.department || '');
                    this.setDropdownValue('editUserCountryCode', userData.countryCode || '');
                    this.setDropdownValue('editUserLineManager', userData.lineManagerId || userData.lineManager || '');
                    this.setDropdownValue('editUserRole', userData.role || '');
                    this.setDropdownValue('editUserStatus', userData.status || 'active');

                    // Final verification of set values
                    console.log('🔍 Final field verification:', {
                        firstName: document.getElementById('editUserFirstName')?.value,
                        lastName: document.getElementById('editUserLastName')?.value,
                        email: document.getElementById('editUserEmail')?.value,
                        employeeId: document.getElementById('editUserEmployeeId')?.value,
                        jobTitle: document.getElementById('editUserJobTitle')?.value,
                        department: document.getElementById('editUserDepartment')?.value,
                        phone: document.getElementById('editUserPhone')?.value,
                        countryCode: document.getElementById('editUserCountryCode')?.value,
                        address: document.getElementById('editUserAddress')?.value,
                        lineManager: document.getElementById('editUserLineManager')?.value,
                        role: document.getElementById('editUserRole')?.value,
                        status: document.getElementById('editUserStatus')?.value
                    });

                    // Toggle Convert-to-account section visibility for reporting-only users
                    try {
                        const isReportingOnly = (userData.accountType === 'without-account') || (userData.reportingOnly === true) || (userData.canSignIn === false) || !userData.authUid;
                        const convertSection = document.getElementById('convertAccountSection');
                        const convertCheckbox = document.getElementById('convertToWithAccount');
                        const convertFields = document.getElementById('convertFields');
                        const convertEmailInput = document.getElementById('convertEmail');
                        const requiredStars = [
                            document.getElementById('convertEmailRequiredStar'),
                            document.getElementById('convertPasswordRequiredStar'),
                        ];

                        if (convertSection) {
                            convertSection.style.display = isReportingOnly ? '' : 'none';
                        }
                        if (convertCheckbox && convertFields) {
                            convertCheckbox.checked = false;
                            convertFields.style.display = 'none';

                            // Also toggle the main email field visibility to avoid duplicate inputs during conversion
                            const emailGroup = document.getElementById('editUserEmailGroup');
                            const emailInput = document.getElementById('editUserEmail');

                            const applyConvertToggleUI = (enabled) => {
                                convertFields.style.display = enabled ? '' : 'none';
                                requiredStars.forEach(s => { if (s) s.style.visibility = enabled ? 'visible' : 'hidden'; });
                                if (emailGroup) {
                                    emailGroup.style.display = enabled ? 'none' : '';
                                }
                                if (emailInput) {
                                    try { emailInput.required = !enabled; } catch {}
                                }
                            };

                            // Initialize and bind
                            applyConvertToggleUI(false);
                            convertCheckbox.onchange = () => {
                                applyConvertToggleUI(!!convertCheckbox.checked);
                            };
                        }
                        if (convertEmailInput) {
                            convertEmailInput.value = userData.email || '';
                        }
                    } catch (e) {
                        console.warn('⚠️ Failed to init convert-to-account UI:', e);
                    }

                    // Preselect Company/Subcontractor based on existing user data
                    try {
                        const companySelect = document.getElementById('editUserCompanyAffiliation');
                        if (companySelect) {
                            const current = {
                                type: userData.employerCompanyType || 'main',
                                id: userData.employerCompanyId || this.companyId,
                                name: userData.employerCompanyName || (this.companyData?.companyName || 'Main Company')
                            };
                            let matched = false;
                            for (let i = 0; i < companySelect.options.length; i++) {
                                const opt = companySelect.options[i];
                                try {
                                    const v = JSON.parse(opt.value);
                                    if (v && v.id === current.id && v.type === current.type) {
                                        companySelect.selectedIndex = i;
                                        matched = true;
                                        break;
                                    }
                                } catch {}
                            }
                            // Default to main if no match
                            if (!matched && companySelect.options.length > 1) {
                                companySelect.selectedIndex = 1; // after placeholder
                            }
                            console.log('✓ Preselected editUserCompanyAffiliation:', companySelect.value);
                        }
                    } catch (e) {
                        console.warn('⚠️ Failed to preselect company affiliation in edit modal:', e);
                    }
                    
                    // Store the user ID for form submission
                    document.getElementById('editUserForm').setAttribute('data-user-id', userId);
                    
                    // Show the edit modal
                    const modal = document.getElementById('editUserModal');
                    if (modal) {
                        modal.classList.add('show');
                        console.log('✅ Edit modal displayed with all fields populated');
                    }
                    
                } catch (error) {
                    console.error('Error loading user for edit:', error);
                    this.showNotification('Error loading user data: ' + error.message, 'error');
                }
            }

            // Helper method to set element value safely
            setElementValue(elementId, value) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value || '';
                    console.log(`✓ Set ${elementId} = "${value}"`);
                    return true;
                } else {
                    console.warn(`⚠️ Element not found: ${elementId}`);
                    return false;
                }
            }

            async deleteUser(userId) {
                if (!confirm('Are you sure you want to delete this user?')) return;

                try {
                    // Remove from company users
                    await db.ref(`companies/${this.companyId}/users/${userId}`).remove();
                    
                    // Remove from global users
                    await db.ref(`users/${userId}`).remove();

                    this.showNotification('User deleted successfully!', 'success');
                    await this.loadUsers();
                    await this.updateDashboardInfo(); // Update quota display after deleting user
                } catch (error) {
                    console.error('Error deleting user:', error);
                    this.showNotification('Error deleting user: ' + error.message, 'error');
                }
            }

            async deleteUserFromModal() {
                try {
                    // Get the user ID from the currentEditingUser stored in the window
                    const userId = window.currentEditingUser?.id;
                    if (!userId) {
                        this.showNotification('No user selected for deletion', 'error');
                        return;
                    }

                    const userName = window.currentEditingUser?.name || 'this user';
                    if (!confirm(`Are you sure you want to delete ${userName}? This action cannot be undone.`)) {
                        return;
                    }

                    // Remove from company users
                    await db.ref(`companies/${this.companyId}/users/${userId}`).remove();
                    
                    // Remove from global users
                    await db.ref(`users/${userId}`).remove();

                    this.showNotification('User deleted successfully!', 'success');
                    
                    // Close the modal
                    this.hideModal('editUserModal');
                    
                    // Refresh the users table and dashboard
                    await this.loadUsers();
                    await this.updateDashboardInfo();
                    
                } catch (error) {
                    console.error('Error deleting user from modal:', error);
                    this.showNotification('Error deleting user: ' + error.message, 'error');
                }
            }

            showNotification(message, type = 'info') {
                if (window.notificationManager) {
                    window.notificationManager.addNotification({
                        type: type,
                        message: message
                    });
                } else {
                    console.log(`[${type.toUpperCase()}] ${message}`);
                }
            }

            // Load company-scoped field options for dropdowns
            async loadCompanyFieldOptions() {
                try {
                    // Use companyId or fallback to currentUser.companyId
                    const companyId = this.companyId || this.currentUser?.companyId;
                    console.log('🔄 Loading company field options for company:', companyId);
                    
                    if (!companyId) {
                        console.warn('⚠️ No company ID available for loading field options');
                        return {
                            jobTitles: this.getDefaultJobTitles(),
                            departments: [],
                            lineManagers: [],
                            roles: []
                        };
                    }

                    const [jobTitles, departments, lineManagers, roles] = await Promise.all([
                        this.loadJobTitles(),
                        this.loadDepartments(),
                        this.loadLineManagers(),
                        this.loadCompanyRoles()
                    ]);

                    console.log('✅ Company field options loaded:', {
                        jobTitles: jobTitles.length,
                        departments: departments.length,
                        lineManagers: lineManagers.length,
                        roles: roles.length
                    });

                    return {
                        jobTitles,
                        departments,
                        lineManagers,
                        roles
                    };
                } catch (error) {
                    console.error('❌ Error loading company field options:', error);
                    return {
                        jobTitles: [],
                        departments: [],
                        lineManagers: [],
                        roles: []
                    };
                }
            }

            async loadJobTitles() {
                try {
                    console.log('🔄 Loading job titles from company field options and org chart...');
                    
                    // Use companyId or fallback to currentUser.companyId
                    const companyId = this.companyId || this.currentUser?.companyId;
                    if (!companyId) {
                        console.warn('⚠️ No company ID available for loading job titles');
                        return this.getDefaultJobTitles();
                    }
                    
                    const jobTitlesSet = new Set();
                    let isSettingsFormat = false;
                    
                    // Load job titles from field options first
                    const fieldOptionsRef = db.ref(`companies/${companyId}/fieldOptions/job-title`);
                    const snapshot = await fieldOptionsRef.once('value');
                    
                    if (snapshot.exists()) {
                        const jobTitlesData = snapshot.val();
                        console.log('✅ Job titles loaded from field options:', jobTitlesData);
                        
                        // Handle settings.html object format with label/value/enabled properties
                        if (Array.isArray(jobTitlesData)) {
                            if (jobTitlesData.length > 0 && typeof jobTitlesData[0] === 'object' && jobTitlesData[0].label) {
                                // Settings.html format with label/value properties
                                isSettingsFormat = true;
                                return jobTitlesData
                                    .filter(title => title.enabled !== false)
                                    .sort((a, b) => a.label.localeCompare(b.label));
                            } else {
                                // Legacy array format
                                jobTitlesData.forEach(title => jobTitlesSet.add(title));
                            }
                        } else if (typeof jobTitlesData === 'object') {
                            const titleArray = Object.values(jobTitlesData);
                            if (titleArray.length > 0 && typeof titleArray[0] === 'object' && titleArray[0].label) {
                                // Settings.html format with label/value properties
                                isSettingsFormat = true;
                                return titleArray
                                    .filter(title => title.enabled !== false)
                                    .sort((a, b) => a.label.localeCompare(b.label));
                            } else {
                                // Legacy object format
                                Object.values(jobTitlesData).forEach(title => jobTitlesSet.add(title));
                            }
                        }
                    }
                    
                    // If we already found settings format, return early
                    if (isSettingsFormat) {
                        return [];
                    }
                    
                    // Load job titles from organizational chart (chart.html data)
                    const orgChartRef = db.ref(`companies/${companyId}/orgChart`);
                    const orgSnapshot = await orgChartRef.once('value');
                    
                    if (orgSnapshot.exists()) {
                        const orgChartData = orgSnapshot.val();
                        console.log('✅ Org chart data loaded for job titles:', orgChartData);
                        
                        // Extract job titles from org chart positions
                        if (typeof orgChartData === 'object') {
                            Object.values(orgChartData).forEach(position => {
                                if (position.jobTitle && position.jobTitle.trim()) {
                                    jobTitlesSet.add(position.jobTitle.trim());
                                }
                            });
                        }
                    }
                    
                    // If we have job titles from either source, return them in legacy format converted to settings format
                    if (jobTitlesSet.size > 0) {
                        const allJobTitles = Array.from(jobTitlesSet)
                            .map(title => ({
                                label: title,
                                value: title.toLowerCase().replace(/\s+/g, '-'),
                                enabled: true
                            }))
                            .sort((a, b) => a.label.localeCompare(b.label));
                        console.log('✅ Combined job titles from field options and org chart:', allJobTitles);
                        return allJobTitles;
                    }

                    console.log('⚠️ No job titles found in field options or org chart, checking fallback options...');

                    // Fallback: extract unique job titles from existing users
                    if (this.companyData?.users) {
                        Object.values(this.companyData.users).forEach(user => {
                            if (user.jobTitle && user.jobTitle.trim()) {
                                jobTitlesSet.add(user.jobTitle.trim());
                            }
                        });
                        const extractedTitles = Array.from(jobTitlesSet)
                            .map(title => ({
                                label: title,
                                value: title.toLowerCase().replace(/\s+/g, '-'),
                                enabled: true
                            }))
                            .sort((a, b) => a.label.localeCompare(b.label));
                        if (extractedTitles.length > 0) {
                            console.log('✅ Job titles extracted from existing users:', extractedTitles);
                            return extractedTitles;
                        }
                    }

                    // Default job titles if no data available
                    return this.getDefaultJobTitles();
                } catch (error) {
                    console.error('❌ Error loading job titles:', error);
                    return this.getDefaultJobTitles();
                }
            }

            // Get default job titles as fallback (matching settings.html format)
            getDefaultJobTitles() {
                const defaultTitles = [
                    { label: 'Software Engineer', value: 'software-engineer', enabled: true },
                    { label: 'Project Manager', value: 'project-manager', enabled: true },
                    { label: 'Business Analyst', value: 'business-analyst', enabled: true },
                    { label: 'Data Analyst', value: 'data-analyst', enabled: true },
                    { label: 'HR Specialist', value: 'hr-specialist', enabled: true },
                    { label: 'Financial Analyst', value: 'financial-analyst', enabled: true },
                    { label: 'Manager', value: 'manager', enabled: true },
                    { label: 'Senior Manager', value: 'senior-manager', enabled: true },
                    { label: 'Team Lead', value: 'team-lead', enabled: true },
                    { label: 'Senior Developer', value: 'senior-developer', enabled: true },
                    { label: 'Developer', value: 'developer', enabled: true },
                    { label: 'Junior Developer', value: 'junior-developer', enabled: true },
                    { label: 'Safety Officer', value: 'safety-officer', enabled: true },
                    { label: 'Finance Manager', value: 'finance-manager', enabled: true },
                    { label: 'Operations Manager', value: 'operations-manager', enabled: true },
                    { label: 'Quality Assurance', value: 'quality-assurance', enabled: true },
                    { label: 'Technical Lead', value: 'technical-lead', enabled: true },
                    { label: 'Consultant', value: 'consultant', enabled: true }
                ].sort((a, b) => a.label.localeCompare(b.label));
                
                console.log('⚠️ Using default job titles:', defaultTitles);
                return defaultTitles;
            }

            // Initialize default field options for a company if they don't exist
            async initializeDefaultFieldOptions() {
                try {
                    if (!this.companyId) {
                        console.warn('⚠️ No company ID available for initializing field options');
                        return;
                    }

                    const fieldOptionsRef = db.ref(`companies/${this.companyId}/fieldOptions`);
                    const snapshot = await fieldOptionsRef.once('value');
                    
                    if (!snapshot.exists()) {
                        console.log('🔄 Initializing default field options for company');
                        
                        const defaultFieldOptions = {
                            'job-title': {
                                'manager': 'Manager',
                                'senior-manager': 'Senior Manager',
                                'team-lead': 'Team Lead',
                                'senior-developer': 'Senior Developer',
                                'developer': 'Developer',
                                'junior-developer': 'Junior Developer',
                                'business-analyst': 'Business Analyst',
                                'project-manager': 'Project Manager',
                                'hr-specialist': 'HR Specialist',
                                'safety-officer': 'Safety Officer',
                                'finance-manager': 'Finance Manager',
                                'operations-manager': 'Operations Manager',
                                'quality-assurance': 'Quality Assurance',
                                'technical-lead': 'Technical Lead',
                                'consultant': 'Consultant'
                            },
                            department: {
                                'human-resources': 'Human Resources',
                                'information-technology': 'Information Technology',
                                'finance': 'Finance',
                                'operations': 'Operations',
                                'marketing': 'Marketing',
                                'sales': 'Sales',
                                'customer-service': 'Customer Service',
                                'quality-assurance': 'Quality Assurance',
                                'research-development': 'Research & Development',
                                'health-safety': 'Health & Safety',
                                'legal': 'Legal',
                                'administration': 'Administration',
                                'project-management': 'Project Management',
                                'business-development': 'Business Development',
                                'consulting-services': 'Consulting Services'
                            },
                            lastUpdated: new Date().toISOString(),
                            createdBy: this.currentUser?.uid || 'system'
                        };

                        await fieldOptionsRef.set(defaultFieldOptions);
                        console.log('✅ Default field options initialized successfully');
                    }
                    
                } catch (error) {
                    console.error('❌ Error initializing default field options:', error);
                }
            }

            async loadDepartments() {
                try {
                    console.log('🔄 Loading departments from company field options...');
                    
                    // Load departments from the correct Firebase path: department (not departments)
                    const fieldOptionsRef = db.ref(`companies/${this.companyId}/fieldOptions/department`);
                    const snapshot = await fieldOptionsRef.once('value');
                    
                    if (snapshot.exists()) {
                        const departmentsData = snapshot.val();
                        console.log('✅ Departments loaded from Firebase:', departmentsData);
                        
                        // Handle settings.html object format with label/value/enabled properties
                        if (Array.isArray(departmentsData)) {
                            // If it's an array of objects (settings.html format), return as-is
                            return departmentsData
                                .filter(dept => dept.enabled !== false) // Only return enabled departments
                                .sort((a, b) => (a.label || a.name || a.value || '').localeCompare(b.label || b.name || b.value || ''));
                        } else if (typeof departmentsData === 'object') {
                            // If it's an object, convert values to array (settings.html format)
                            const deptArray = Object.values(departmentsData);
                            if (deptArray.length > 0 && typeof deptArray[0] === 'object' && deptArray[0].label) {
                                // Settings.html format with label/value properties
                                return deptArray
                                    .filter(dept => dept.enabled !== false)
                                    .sort((a, b) => a.label.localeCompare(b.label));
                            } else {
                                // Legacy string format - convert to settings.html format
                                return deptArray.map(dept => ({
                                    label: dept,
                                    value: dept.toLowerCase().replace(/\s+/g, '-'),
                                    enabled: true
                                })).sort((a, b) => a.label.localeCompare(b.label));
                            }
                        } else {
                            console.warn('⚠️ Unexpected departments data format:', departmentsData);
                            return [];
                        }
                    }

                    console.log('⚠️ No departments found in Firebase, checking fallback options...');

                    // Fallback: extract unique departments from existing users
                    if (this.companyData?.users) {
                        const departments = new Set();
                        Object.values(this.companyData.users).forEach(user => {
                            if (user.department && user.department.trim()) {
                                departments.add(user.department.trim());
                            }
                        });
                        const extractedDepartments = Array.from(departments)
                            .map(dept => ({
                                label: dept,
                                value: dept.toLowerCase().replace(/\s+/g, '-'),
                                enabled: true
                            }))
                            .sort((a, b) => a.label.localeCompare(b.label));
                        if (extractedDepartments.length > 0) {
                            console.log('✅ Departments extracted from existing users:', extractedDepartments);
                            return extractedDepartments;
                        }
                    }

                    // Default departments if no data available (matching settings.html format)
                    const defaultDepartments = [
                        { label: 'Information Technology', value: 'it', enabled: true },
                        { label: 'Human Resources', value: 'hr', enabled: true },
                        { label: 'Finance', value: 'finance', enabled: true },
                        { label: 'Operations', value: 'operations', enabled: true },
                        { label: 'Marketing', value: 'marketing', enabled: true },
                        { label: 'Sales', value: 'sales', enabled: true },
                        { label: 'Customer Service', value: 'customer-service', enabled: true },
                        { label: 'Quality Assurance', value: 'qa', enabled: true },
                        { label: 'Research & Development', value: 'rd', enabled: true },
                        { label: 'Health & Safety', value: 'health-safety', enabled: true },
                        { label: 'Legal', value: 'legal', enabled: true },
                        { label: 'Administration', value: 'admin', enabled: true },
                        { label: 'Project Management', value: 'project-management', enabled: true },
                        { label: 'Business Development', value: 'business-dev', enabled: true },
                        { label: 'Consulting Services', value: 'consulting', enabled: true }
                    ].sort((a, b) => a.label.localeCompare(b.label));
                    
                    console.log('⚠️ Using default departments:', defaultDepartments);
                    return defaultDepartments;
                } catch (error) {
                    console.error('❌ Error loading departments:', error);
                    return [];
                }
            }

            async loadLineManagers() {
                try {
                    // Load all users from the company to be potential line managers
                    const managers = [];
                    
                    if (this.companyData?.users) {
                        Object.entries(this.companyData.users).forEach(([uid, user]) => {
                            // Include all users as potential line managers
                            managers.push({
                                uid: uid,
                                name: user.name || user.email || 'Unknown User',
                                email: user.email || '',
                                jobTitle: user.jobTitle || '',
                                department: user.department || '',
                                role: user.role || ''
                            });
                        });
                    }
                    
                    return managers.sort((a, b) => a.name.localeCompare(b.name));
                } catch (error) {
                    console.error('❌ Error loading line managers:', error);
                    return [];
                }
            }

            async loadCompanyRoles() {
                try {
                    // Load roles from the company's roles structure
                    const rolesRef = db.ref(`companies/${this.companyId}/roles`);
                    const snapshot = await rolesRef.once('value');
                    
                    const roles = [];
                    
                    // Always include the default Administrator role first
                    const defaultAdminRole = {
                        id: 'administrator',
                        name: 'Administrator',
                        description: 'Default administrator role with full system access. This role cannot be modified or deleted.',
                        isDefault: true,
                        isSystemRole: true,
                        permissions: {} // All permissions are enabled by default for administrators
                    };
                    roles.push(defaultAdminRole);
                    
                    if (snapshot.exists()) {
                        const rolesData = snapshot.val();
                        
                        Object.entries(rolesData).forEach(([roleId, roleData]) => {
                            // Skip if this is the administrator role (already added above)
                            if (roleId === 'administrator') {
                                return;
                            }
                            
                            if (roleData && typeof roleData === 'object') {
                                roles.push({
                                    id: roleId,
                                    name: roleData.name || roleId,
                                    description: roleData.description || '',
                                    permissions: roleData.permissions || {}
                                });
                            }
                        });
                    } else {
                        // Fallback: provide additional default roles if no roles exist
                        roles.push(
                            { id: 'user', name: 'User', description: 'Standard user access' },
                            { id: 'manager', name: 'Manager', description: 'Management level access' }
                        );
                    }
                    
                    // Sort roles but keep Administrator first
                    const adminRole = roles.find(r => r.id === 'administrator');
                    const otherRoles = roles.filter(r => r.id !== 'administrator').sort((a, b) => a.name.localeCompare(b.name));
                    
                    console.log(`✅ Loaded ${roles.length} roles including default Administrator role`);
                    return [adminRole, ...otherRoles];
                    
                } catch (error) {
                    console.error('❌ Error loading company roles:', error);
                    // Even on error, ensure Administrator role is available
                    return [
                        { 
                            id: 'administrator', 
                            name: 'Administrator', 
                            description: 'Default administrator role with full system access. This role cannot be modified or deleted.',
                            isDefault: true,
                            isSystemRole: true
                        },
                        { id: 'user', name: 'User', description: 'Standard user access' },
                        { id: 'manager', name: 'Manager', description: 'Management level access' }
                    ];
                }
            }

            // Populate dropdown fields with company-scoped data
            populateDropdownField(selectId, options, valueField = null, textField = null) {
                const selectElement = document.getElementById(selectId);
                if (!selectElement) {
                    console.warn(`⚠️ Select element not found: ${selectId}`);
                    return;
                }

                // Clear existing options except the first one (placeholder)
                const firstOption = selectElement.children[0];
                selectElement.innerHTML = '';
                if (firstOption) {
                    selectElement.appendChild(firstOption);
                }

                // Add new options
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    
                    if (typeof option === 'string') {
                        optionElement.value = option;
                        optionElement.textContent = option;
                    } else if (typeof option === 'object' && option !== null) {
                        // Handle settings.html format (label/value) and other formats
                        const value = valueField ? option[valueField] : (option.value || option.id || option.name);
                        const text = textField ? option[textField] : (option.label || option.name || option.text || value);
                        
                        optionElement.value = value;
                        optionElement.textContent = text;
                        
                        // Add description as title attribute if available
                        if (option.description) {
                            optionElement.title = option.description;
                        }
                        
                        // Skip disabled options from settings.html
                        if (option.enabled === false) {
                            return;
                        }
                    }
                    
                    selectElement.appendChild(optionElement);
                });

                console.log(`✓ Populated ${selectId} with ${options.length} options`);
            }

            // Helper method to set dropdown value with fallback handling
            setDropdownValue(elementId, value) {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.warn(`⚠️ Element not found: ${elementId}`);
                    return false;
                }

                if (!value || value.trim() === '') {
                    element.value = '';
                    console.log(`✓ Set ${elementId} to empty (no value provided)`);
                    return true;
                }

                const cleanValue = value.trim();

                // First try exact match
                element.value = cleanValue;
                if (element.value === cleanValue) {
                    console.log(`✓ Set ${elementId} to "${cleanValue}" (exact match)`);
                    return true;
                }

                // If exact match failed, try case-insensitive match
                const options = Array.from(element.options);
                const matchingOption = options.find(option => 
                    option.value.toLowerCase().trim() === cleanValue.toLowerCase()
                );

                if (matchingOption) {
                    element.value = matchingOption.value;
                    console.log(`✓ Set ${elementId} to "${matchingOption.value}" (case-insensitive match)`);
                    return true;
                }

                // Try partial match (contains)
                const partialMatch = options.find(option => 
                    option.value.toLowerCase().includes(cleanValue.toLowerCase()) ||
                    cleanValue.toLowerCase().includes(option.value.toLowerCase())
                );

                if (partialMatch) {
                    element.value = partialMatch.value;
                    console.log(`✓ Set ${elementId} to "${partialMatch.value}" (partial match for "${cleanValue}")`);
                    return true;
                }

                // Try matching by display text instead of value
                const textMatch = options.find(option => 
                    option.textContent.toLowerCase().trim() === cleanValue.toLowerCase()
                );

                if (textMatch) {
                    element.value = textMatch.value;
                    console.log(`✓ Set ${elementId} to "${textMatch.value}" (text content match for "${cleanValue}")`);
                    return true;
                }

                // If no match found, log available options and leave empty
                console.warn(`⚠️ No matching option found for ${elementId} with value "${cleanValue}"`);
                console.warn(`Available options:`, options.map(opt => `"${opt.value}" (${opt.textContent})`));
                element.value = '';
                return false;
            }

            // Methods for Edit Modal dropdown population (to maintain compatibility)
            async loadDepartmentsForEdit() {
                try {
                    const departments = await this.loadDepartments();
                    this.populateDropdownField('editUserDepartment', departments);
                    return departments;
                } catch (error) {
                    console.error('❌ Error loading departments for edit:', error);
                    return [];
                }
            }

            async loadJobTitlesForEdit() {
                try {
                    const jobTitles = await this.loadJobTitles();
                    this.populateDropdownField('editUserJobTitle', jobTitles);
                    return jobTitles;
                } catch (error) {
                    console.error('❌ Error loading job titles for edit:', error);
                    return [];
                }
            }

            async loadLineManagersForEdit() {
                try {
                    const lineManagers = await this.loadLineManagers();
                    
                    // Populate line managers dropdown for edit modal
                    const lineManagerSelect = document.getElementById('editUserLineManager');
                    if (lineManagerSelect && lineManagers.length > 0) {
                        // Clear existing options except the first one (placeholder)
                        const firstOption = lineManagerSelect.children[0];
                        lineManagerSelect.innerHTML = '';
                        if (firstOption) {
                            lineManagerSelect.appendChild(firstOption);
                        }

                        lineManagers.forEach(manager => {
                            const option = document.createElement('option');
                            option.value = manager.uid;
                            
                            // Create a more informative display text
                            let displayText = manager.name;
                            if (manager.jobTitle && manager.department) {
                                displayText += ` (${manager.jobTitle} - ${manager.department})`;
                            } else if (manager.jobTitle) {
                                displayText += ` (${manager.jobTitle})`;
                            } else if (manager.department) {
                                displayText += ` (${manager.department})`;
                            } else if (manager.role) {
                                displayText += ` (${manager.role})`;
                            }
                            
                            option.textContent = displayText;
                            option.title = `${manager.name} - ${manager.email}`;
                            lineManagerSelect.appendChild(option);
                        });
                        
                        console.log(`✓ Populated editUserLineManager with ${lineManagers.length} options`);
                    }
                    
                    return lineManagers;
                } catch (error) {
                    console.error('❌ Error loading line managers for edit:', error);
                    return [];
                }
            }

            async loadRolesForEdit() {
                try {
                    const roles = await this.loadCompanyRoles();
                    
                    // Load role visibility settings
                    let roleVisibility = null;
                    try {
                        roleVisibility = await window.getVisibleRolesForDropdown?.();
                    } catch (e) {
                        console.warn('Could not load role visibility settings:', e);
                    }

                    // Get the current user's role being edited (to always show it even if hidden)
                    const currentUserRole = window.currentEditingUser?.role?.toLowerCase?.() || '';
                    
                    // Populate roles dropdown for edit modal
                    const roleSelect = document.getElementById('editUserRole');
                    if (roleSelect && roles.length > 0) {
                        // Clear existing options except the first one (placeholder)
                        const firstOption = roleSelect.children[0];
                        roleSelect.innerHTML = '';
                        if (firstOption) {
                            roleSelect.appendChild(firstOption);
                        }

                        let addedCount = 0;
                        roles.forEach(role => {
                            // Check if role is visible (null means all visible, otherwise check the map)
                            const isVisible = roleVisibility === null || roleVisibility[role.id] === true;
                            // Administrator is always visible
                            // Also always show the current user's role so it can be preserved or changed
                            const isCurrentUserRole = currentUserRole && role.id.toLowerCase() === currentUserRole;
                            if (!isVisible && role.id !== 'administrator' && !isCurrentUserRole) {
                                return; // Skip hidden roles (unless it's the user's current role)
                            }

                            const option = document.createElement('option');
                            option.value = role.id;
                            
                            // Special display for Administrator role
                            if (role.id === 'administrator') {
                                option.textContent = `👑 ${role.name}`;
                                option.style.fontWeight = 'bold';
                                option.style.color = '#ffd700';
                            } else {
                                option.textContent = role.name;
                            }
                            
                            if (role.description) {
                                option.title = role.description;
                            }
                            roleSelect.appendChild(option);
                            addedCount++;
                        });
                        
                        console.log(`✓ Populated editUserRole with ${addedCount} visible roles (${roles.length} total, currentRole: ${currentUserRole})`);
                    }
                    
                    return roles;
                } catch (error) {
                    console.error('❌ Error loading roles for edit:', error);
                    return [];
                }
            }

            // Populate ALL dropdown fields in edit user modal with same data as add user modal
            async populateEditUserModalDropdowns() {
                try {
                    console.log('🔄 Loading dropdown data for edit user modal (using same data as add user modal)...');
                    
                    // Use the exact same method as add user modal for complete consistency
                    const fieldOptions = await this.loadCompanyFieldOptions();
                    
                    console.log('Field options loaded:', {
                        jobTitles: fieldOptions.jobTitles,
                        departments: fieldOptions.departments,
                        lineManagers: fieldOptions.lineManagers?.length || 0,
                        roles: fieldOptions.roles?.length || 0
                    });
                    
                    // Populate Job Titles dropdown
                    this.populateDropdownField('editUserJobTitle', fieldOptions.jobTitles);
                    console.log(`✓ Populated editUserJobTitle with ${fieldOptions.jobTitles.length} options:`, fieldOptions.jobTitles);
                    
                    // Populate Departments dropdown
                    this.populateDropdownField('editUserDepartment', fieldOptions.departments);
                    console.log(`✓ Populated editUserDepartment with ${fieldOptions.departments.length} options:`, fieldOptions.departments);
                    
                    // Populate Line Managers dropdown (with same enhanced display as add user modal)
                    const lineManagerSelect = document.getElementById('editUserLineManager');
                    if (lineManagerSelect && fieldOptions.lineManagers && fieldOptions.lineManagers.length > 0) {
                        // Clear existing options except the first one (placeholder)
                        const firstOption = lineManagerSelect.children[0];
                        lineManagerSelect.innerHTML = '';
                        if (firstOption) {
                            lineManagerSelect.appendChild(firstOption);
                        }

                        fieldOptions.lineManagers.forEach(manager => {
                            const option = document.createElement('option');
                            option.value = manager.uid || manager.id;
                            // Use EXACTLY the same display format as add user modal
                            option.textContent = `${manager.name}${manager.jobTitle ? ` (${manager.jobTitle}` : ''}${manager.department ? ` - ${manager.department})` : manager.jobTitle ? ')' : ''}`;
                            option.title = `${manager.name} - ${manager.email || 'No email'}`;
                            lineManagerSelect.appendChild(option);
                        });
                        
                        console.log(`✓ Populated editUserLineManager with ${fieldOptions.lineManagers.length} options (same format as add user modal)`);
                    } else {
                        console.warn('⚠️ No line managers available or element not found');
                    }
                    
                    // Populate Roles dropdown (with same display format as add user modal, filtered by visibility)
                    const roleSelect = document.getElementById('editUserRole');
                    if (roleSelect && fieldOptions.roles.length > 0) {
                        // Clear existing options except the first one (placeholder)
                        const firstOption = roleSelect.children[0];
                        roleSelect.innerHTML = '';
                        if (firstOption) {
                            roleSelect.appendChild(firstOption);
                        }

                        // Load role visibility settings
                        let roleVisibility = null;
                        try {
                            roleVisibility = await window.getVisibleRolesForDropdown?.();
                        } catch (e) {
                            console.warn('Could not load role visibility settings:', e);
                        }

                        // Get the current user's role being edited (to always show it even if hidden)
                        const currentUserRole = window.currentEditingUser?.role?.toLowerCase?.() || '';

                        let addedCount = 0;
                        fieldOptions.roles.forEach(role => {
                            // Check if role is visible (null means all visible, otherwise check the map)
                            const isVisible = roleVisibility === null || roleVisibility[role.id] === true;
                            // Administrator is always visible
                            // Also always show the current user's role so it can be preserved or changed
                            const isCurrentUserRole = currentUserRole && role.id.toLowerCase() === currentUserRole;
                            if (!isVisible && role.id !== 'administrator' && !isCurrentUserRole) {
                                return; // Skip hidden roles (unless it's the user's current role)
                            }

                            const option = document.createElement('option');
                            option.value = role.id;
                            
                            // Special display for Administrator role
                            if (role.id === 'administrator') {
                                option.textContent = `👑 ${role.name}`;
                                option.style.fontWeight = 'bold';
                                option.style.color = '#ffd700';
                            } else {
                                // Use EXACTLY the same display format as add user modal
                                option.textContent = role.name;
                            }
                            
                            if (role.description) {
                                option.title = role.description;
                            }
                            roleSelect.appendChild(option);
                            addedCount++;
                        });
                        
                        console.log(`✓ Populated editUserRole with ${addedCount} visible roles (${fieldOptions.roles.length} total, currentRole: ${currentUserRole})`);
                    }
                    
                    console.log('✅ Edit user modal dropdowns populated successfully with IDENTICAL data to add user modal');

                    // Populate Country Code select with a comprehensive E.164 list (codes only)
                    try {
                        populateCountryCodeSelect('editUserCountryCode');
                        console.log('✓ Populated editUserCountryCode with E.164 country calling codes');
                    } catch (e) {
                        console.warn('⚠️ Failed to populate editUserCountryCode:', e);
                    }

                    // Populate Company/Subcontractor dropdown (main company + subcontractors)
                    try {
                        const companySelect = document.getElementById('editUserCompanyAffiliation');
                        if (companySelect) {
                            // Clear but keep the placeholder
                            const firstOption = companySelect.children[0];
                            companySelect.innerHTML = '';
                            if (firstOption) companySelect.appendChild(firstOption);

                            const companyId = window.companyManagement.companyId;
                            const companyData = window.companyManagement.companyData || {};
                            const mainName = companyData.companyName || 'Main Company';
                            const normalizeName = (n) => (n || '').toString().trim().toLowerCase();
                            const seenNames = new Set();

                            // Main company option
                            const mainOpt = document.createElement('option');
                            mainOpt.value = JSON.stringify({ type: 'main', id: companyId, name: mainName });
                            mainOpt.textContent = `${mainName}`;
                            if (!seenNames.has(normalizeName(mainName))) {
                                companySelect.appendChild(mainOpt);
                                seenNames.add(normalizeName(mainName));
                            }

                            // Subcontractors
                            let subs = {};
                            try {
                                const subsSnap = await db.ref(`companies/${companyId}/subcontractors`).once('value');
                                subs = subsSnap.exists() ? subsSnap.val() : {};
                            } catch (e) {
                                console.warn('⚠️ Could not load subcontractors for edit user modal:', e);
                            }

                            Object.values(subs || {}).forEach(sub => {
                                if (!sub) return;
                                const id = sub.id || sub.uid || sub.key || sub.name;
                                const name = sub.name || sub.companyName || 'Subcontractor';
                                const opt = document.createElement('option');
                                opt.value = JSON.stringify({ type: 'subcontractor', id, name });
                                opt.textContent = `${name}`;
                                if (!seenNames.has(normalizeName(name))) {
                                    companySelect.appendChild(opt);
                                    seenNames.add(normalizeName(name));
                                }
                            });

                            console.log(`✓ Populated editUserCompanyAffiliation with ${companySelect.options.length - 1} options (deduped)`);
                        }
                    } catch (e) {
                        console.warn('⚠️ Failed to populate Edit Company/Subcontractor select:', e);
                    }
                    
                } catch (error) {
                    console.error('❌ Error populating edit user modal dropdowns:', error);
                }
            }

            async updateUserQuotaLimit() {
                try {
                    console.log('🔄 Updating quota limits...');
                    
                    const userQuota = parseInt(document.getElementById('userQuotaInput').value) || 0;
                    const featuresCount = this.getSelectedFeaturesCount();
                    const currentQuota = this.companyData.userQuota || 0;
                    
                    if (userQuota < 1) {
                        this.showNotification('User quota must be at least 1', 'error');
                        return;
                    }
                    
                    // Check if user is trying to decrease quota below current value
                    if (userQuota < currentQuota) {
                        this.showNotification(`Cannot decrease user quota below current limit of ${currentQuota} users. You can only increase the quota.`, 'error');
                        // Reset to current value
                        document.getElementById('userQuotaInput').value = currentQuota;
                        return;
                    }
                    
                    if (featuresCount < 1) {
                        this.showNotification('Please select at least one feature', 'error');
                        return;
                    }
                    
                    // Prepare selected features array - ensure currently subscribed features are always included
                    const selectedFeaturesSet = new Set(this.selectedFeatures);
                    // Add all currently subscribed features to ensure they can't be removed
                    this.currentlySubscribedFeatures.forEach(featureId => {
                        selectedFeaturesSet.add(featureId);
                    });
                    const selectedFeaturesArray = Array.from(selectedFeaturesSet);
                    
                    console.log('📋 Final features array (including protected subscribed features):', selectedFeaturesArray);
                    
                    // Update quotas and selected features in Firebase
                    const updates = {
                        userQuota: userQuota,
                        featuresQuota: selectedFeaturesArray.length, // Use actual final count
                        selectedFeatures: selectedFeaturesArray,
                        updatedAt: new Date().toISOString()
                    };
                    
                    await db.ref(`companies/${this.companyId}`).update(updates);
                    
                    // Update local data
                    this.companyData.userQuota = userQuota;
                    this.companyData.featuresQuota = selectedFeaturesArray.length;
                    this.companyData.selectedFeatures = selectedFeaturesArray;
                    
                    // Update features display using the new method
                    this.updateFeaturesDisplay(selectedFeaturesArray.length, selectedFeaturesArray.length);
                    
                    // Update main quota display in header
                    const mainQuotaElement = document.getElementById('userQuota');
                    if (mainQuotaElement) {
                        mainQuotaElement.textContent = `${this.users?.length || 0} / ${userQuota} Users`;
                    }
                    const headerPlanSummaryEl = document.getElementById('headerPlanSummary');
                    if (headerPlanSummaryEl) {
                        headerPlanSummaryEl.textContent = `${this.users?.length || 0} / ${userQuota} Users`;
                    }
                    
                    this.showNotification('Quota limits and features updated successfully!', 'success');
                    console.log('✅ Quota limits updated:', { userQuota, featuresCount: selectedFeaturesArray.length, selectedFeatures: selectedFeaturesArray });
                    
                } catch (error) {
                    console.error('❌ Error updating quota limits:', error);
                    this.showNotification('Error updating quota limits: ' + error.message, 'error');
                }
            }

            // Save subscription changes (quota and features)
            async saveSubscriptionChanges() {
                try {
                    console.log('💾 Saving subscription changes...');
                    
                    // Show loading state on save button
                    const saveBtn = document.getElementById('saveSubscriptionBtn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                        saveBtn.disabled = true;
                    }
                    
                    // Get current values from the form
                    const userQuota = parseInt(document.getElementById('userQuotaInput').value) || 0;
                    const currentQuota = this.companyData.userQuota || 0;
                    
                    // Validate user quota
                    if (userQuota < 1) {
                        this.showNotification('User quota must be at least 1', 'error');
                        return;
                    }
                    
                    // Check if user is trying to decrease quota below current value
                    if (userQuota < currentQuota) {
                        this.showNotification(`Cannot decrease user quota below current limit of ${currentQuota} users. You can only increase the quota.`, 'error');
                        document.getElementById('userQuotaInput').value = currentQuota;
                        return;
                    }
                    
                    // Get selected features
                    const selectedFeaturesSet = new Set(this.selectedFeatures);
                    // Ensure currently subscribed features are always included
                    this.currentlySubscribedFeatures.forEach(featureId => {
                        selectedFeaturesSet.add(featureId);
                    });
                    const selectedFeaturesArray = Array.from(selectedFeaturesSet);
                    
                    if (selectedFeaturesArray.length < 1) {
                        this.showNotification('Please select at least one feature', 'error');
                        return;
                    }
                    
                    console.log('📋 Saving changes:', {
                        userQuota,
                        featuresCount: selectedFeaturesArray.length,
                        selectedFeatures: selectedFeaturesArray
                    });
                    
                    // Prepare updates for Firebase
                    const updates = {
                        userQuota: userQuota,
                        featuresQuota: selectedFeaturesArray.length,
                        selectedFeatures: selectedFeaturesArray,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Use companyId or fallback
                    const companyId = this.companyId || this.currentUser?.companyId;
                    if (!companyId) {
                        this.showNotification('Error: Company ID not found', 'error');
                        return;
                    }
                    
                    // Save to Firebase
                    await db.ref(`companies/${companyId}`).update(updates);
                    
                    // Update local data
                    this.companyData.userQuota = userQuota;
                    this.companyData.featuresQuota = selectedFeaturesArray.length;
                    this.companyData.selectedFeatures = selectedFeaturesArray;
                    
                    // Update features display
                    this.updateFeaturesDisplay(selectedFeaturesArray.length, selectedFeaturesArray.length);
                    
                    // Update main quota display in header
                    const mainQuotaElement = document.getElementById('userQuota');
                    if (mainQuotaElement) {
                        mainQuotaElement.textContent = `${this.users?.length || 0} / ${userQuota} Users`;
                    }
                    const headerPlanSummaryEl2 = document.getElementById('headerPlanSummary');
                    if (headerPlanSummaryEl2) {
                        headerPlanSummaryEl2.textContent = `${this.users?.length || 0} / ${userQuota} Users`;
                    }
                    
                    // Update button states
                    this.updateQuotaButtonStates();
                    this.updateSaveButtonState(); // Reset save button state after successful save
                    
                    this.showNotification('Subscription changes saved successfully!', 'success');
                    console.log('✅ Subscription changes saved successfully');
                    
                } catch (error) {
                    console.error('❌ Error saving subscription changes:', error);
                    this.showNotification('Error saving subscription changes: ' + error.message, 'error');
                } finally {
                    // Restore save button
                    const saveBtn = document.getElementById('saveSubscriptionBtn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                        saveBtn.disabled = false;
                    }
                }
            }

            // Check if there are unsaved changes in subscription settings
            hasSubscriptionChanges() {
                try {
                    const currentUserQuota = parseInt(document.getElementById('userQuotaInput')?.value) || 0;
                    const originalUserQuota = this.companyData?.userQuota || 0;
                    
                    // Check if quota has changed
                    if (currentUserQuota !== originalUserQuota) {
                        return true;
                    }
                    
                    // Check if features selection has changed
                    const currentSelectedFeatures = new Set(this.selectedFeatures);
                    const originalSelectedFeatures = new Set(this.companyData?.selectedFeatures || []);
                    
                    if (currentSelectedFeatures.size !== originalSelectedFeatures.size) {
                        return true;
                    }
                    
                    // Check if any features are different
                    for (let feature of currentSelectedFeatures) {
                        if (!originalSelectedFeatures.has(feature)) {
                            return true;
                        }
                    }
                    
                    return false;
                } catch (error) {
                    console.error('Error checking subscription changes:', error);
                    return false;
                }
            }

            // Update save button state based on changes
            updateSaveButtonState() {
                const saveBtn = document.getElementById('saveSubscriptionBtn');
                if (!saveBtn) return;
                
                const hasChanges = this.hasSubscriptionChanges();
                saveBtn.disabled = !hasChanges;
                
                if (hasChanges) {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    saveBtn.style.opacity = '1';
                } else {
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> No Changes';
                    saveBtn.style.opacity = '0.6';
                }
            }

            validateUserQuotaInput() {
                const userQuotaInput = document.getElementById('userQuotaInput');
                if (!userQuotaInput) return;

                const currentValue = parseInt(userQuotaInput.value) || 0;
                const currentQuota = this.companyData && this.companyData.userQuota ? this.companyData.userQuota : 1;
                
                if (currentValue < currentQuota) {
                    // Reset to current quota if user tries to go below
                    userQuotaInput.value = currentQuota;
                    this.showNotification(`User quota cannot be decreased below current limit of ${currentQuota} users.`, 'warning');
                    
                    // Add visual feedback
                    userQuotaInput.style.borderColor = '#ff6b6b';
                    userQuotaInput.style.boxShadow = '0 0 5px rgba(255, 107, 107, 0.3)';
                    setTimeout(() => {
                        userQuotaInput.style.borderColor = '';
                        userQuotaInput.style.boxShadow = '';
                    }, 2000);
                }
            }

            updateQuotaButtonStates() {
                const userQuotaInput = document.getElementById('userQuotaInput');
                const decreaseBtn = document.querySelector('.quota-decrease');
                
                if (userQuotaInput && decreaseBtn && this.companyData) {
                    const currentValue = parseInt(userQuotaInput.value) || 0;
                    const currentQuota = this.companyData.userQuota || 1;
                    
                    if (currentValue <= currentQuota) {
                        decreaseBtn.classList.add('disabled');
                        decreaseBtn.setAttribute('disabled', 'true');
                        decreaseBtn.title = `Cannot decrease below current limit of ${currentQuota} users`;
                    } else {
                        decreaseBtn.classList.remove('disabled');
                        decreaseBtn.removeAttribute('disabled');
                        decreaseBtn.title = 'Decrease user quota';
                    }
                }
            }

            async loadSelectedFeatures() {
                try {
                    console.log('🔄 Loading selected features from selectedPlan...');
                    
                    if (!this.companyId) {
                        console.warn('⚠️ No company ID available');
                        return;
                    }

                    // Load features from the selectedPlan path
                    const selectedPlanRef = db.ref(`companies/${this.companyId}/selectedPlan`);
                    const snapshot = await selectedPlanRef.once('value');
                    
                    let activeFeatures = [];
                    let featuresQuota = 10; // Default quota
                    
                    if (snapshot.exists()) {
                        const planData = snapshot.val();
                        console.log('📋 Plan data loaded:', planData);
                        
                        // Check if features are stored in different formats
                        if (planData.features && Array.isArray(planData.features)) {
                            activeFeatures = planData.features;
                        } else if (planData.selectedFeatures && Array.isArray(planData.selectedFeatures)) {
                            activeFeatures = planData.selectedFeatures;
                        } else if (planData.features && typeof planData.features === 'object') {
                            // If features is an object, get the keys or values
                            activeFeatures = Object.keys(planData.features);
                        }
                        
                        // Get features quota if available
                        if (planData.featuresQuota) {
                            featuresQuota = planData.featuresQuota;
                        } else if (this.companyData && this.companyData.featuresQuota) {
                            featuresQuota = this.companyData.featuresQuota;
                        }
                    } else {
                        console.log('⚠️ No selectedPlan data found, using defaults');
                        
                        // Fallback: check if features are in the main company data
                        if (this.companyData && this.companyData.selectedFeatures) {
                            activeFeatures = this.companyData.selectedFeatures;
                        }
                        
                        if (this.companyData && this.companyData.featuresQuota) {
                            featuresQuota = this.companyData.featuresQuota;
                        }
                    }
                    
                    // Update selectedFeatures set
                    this.selectedFeatures = new Set(activeFeatures);
                    console.log(`✅ Loaded ${activeFeatures.length} active features:`, activeFeatures);
                    
                    // Update the features display
                    this.updateFeaturesDisplay(activeFeatures.length, featuresQuota);
                    
                    // Update feature selection in the UI
                    this.updateFeatureSelection();
                    
                } catch (error) {
                    console.error('❌ Error loading selected features:', error);
                    
                    // Fallback to showing 0/0
                    this.updateFeaturesDisplay(0, 0);
                }
            }

            updateFeaturesDisplay(activeCount, totalQuota) {
                console.log(`📊 Updating features display: ${activeCount} / ${totalQuota}`);
                
                // Update features display elements if they exist
                const featuresQuotaDisplay = document.getElementById('featuresQuotaDisplay');
                if (featuresQuotaDisplay) {
                    featuresQuotaDisplay.textContent = `${activeCount}/${totalQuota}`;
                    console.log(`✅ Updated featuresQuotaDisplay: ${activeCount} / ${totalQuota}`);
                }
            }

            async loadPlatformFeatures() {
                try {
                    console.log('🔄 Loading platform features from Firebase...');
                    
                    // Load features from the platformFeatures path
                    const featuresRef = db.ref('platformFeatures');
                    const snapshot = await featuresRef.once('value');
                    
                    if (snapshot.exists()) {
                        const featuresData = snapshot.val();
                        console.log('📋 Platform features loaded:', featuresData);
                        
                        // Convert to array if it's an object
                        let featuresArray = [];
                        if (Array.isArray(featuresData)) {
                            featuresArray = featuresData;
                        } else if (typeof featuresData === 'object') {
                            // If it's an object, convert to array with keys and values
                            featuresArray = Object.entries(featuresData).map(([key, value]) => {
                                if (typeof value === 'string') {
                                    return { id: key, name: value, title: value };
                                } else if (typeof value === 'object' && value !== null) {
                                    return { id: key, ...value };
                                } else {
                                    return { id: key, name: key, title: key };
                                }
                            });
                        }
                        
                        console.log(`✅ Processed ${featuresArray.length} platform features`);
                        return featuresArray;
                        
                    } else {
                        console.warn('⚠️ No platform features found in Firebase');
                        return [];
                    }
                    
                } catch (error) {
                    console.error('❌ Error loading platform features:', error);
                    return [];
                }
            }

            async populateFeaturesDropdown() {
                try {
                    const featuresContainer = document.getElementById('featuresCheckboxList');
                    const loadingMessage = document.getElementById('featuresLoadingMessage');
                    
                    if (!featuresContainer) {
                        console.warn('⚠️ Features container not found');
                        return;
                    }

                    // Show loading message
                    if (loadingMessage) loadingMessage.style.display = 'block';

                    // Load platform features from Firebase
                    const features = await this.loadPlatformFeatures();
                    
                    // Store features globally for later use
                    this.platformFeatures = features;
                    this.selectedFeatures = new Set(); // Initialize selected features set
                    
                    // Hide loading message and show features list
                    if (loadingMessage) loadingMessage.style.display = 'none';
                    featuresContainer.style.display = 'block';
                    
                    // Clear existing content
                    featuresContainer.innerHTML = '';

                    // Create checkbox for each feature
                    features.forEach((feature, index) => {
                        const featureId = feature.id || `feature_${index}`;
                        const displayName = feature.title || feature.name || feature.id || `Feature ${index + 1}`;
                        const description = feature.description || `${displayName} module`;
                        const price = feature.price ? parseFloat(feature.price) : 0;
                        const isSubscribed = this.currentlySubscribedFeatures.has(featureId);
                        
                        const featureItem = document.createElement('div');
                        featureItem.className = `feature-checkbox-item ${isSubscribed ? 'subscribed-feature' : ''}`;
                        featureItem.onclick = (e) => {
                            if (isSubscribed) {
                                e.preventDefault();
                                e.stopPropagation();
                                this.showNotification('This feature is part of your current plan and cannot be removed.', 'warning');
                                return false;
                            }
                            this.toggleFeatureSelection(featureId, featureItem);
                        };
                        
                        featureItem.innerHTML = `
                            <input type="checkbox" id="feature_${featureId}" data-feature-id="${featureId}" ${isSubscribed ? 'checked disabled' : ''} onchange="event.stopPropagation(); window.companyManagement.toggleFeatureSelection('${featureId}', this.closest('.feature-checkbox-item'));" ${isSubscribed ? 'title="This feature is currently subscribed and cannot be removed"' : ''}>
                            <div class="feature-info">
                                <div class="feature-name">
                                    ${displayName}
                                    ${isSubscribed ? '<span class="subscribed-label locked">🔒 Locked</span>' : ''}
                                </div>
                                <div class="feature-description">${description}</div>
                                <div class="feature-price">$${price.toFixed(2)}/user/month</div>
                            </div>
                            <div class="feature-icon">
                                <i class="fas ${isSubscribed ? 'fa-lock' : 'fa-puzzle-piece'}"></i>
                                ${isSubscribed ? '<small class="text-muted">Current Plan</small>' : ''}
                            </div>
                        `;
                        
                        featuresContainer.appendChild(featureItem);
                    });
                    
                    console.log(`✅ Populated features checkboxes with ${features.length} options`);
                    
                    // Also populate the visual features grid
                    this.populateVisualFeaturesGrid(features);
                    
                } catch (error) {
                    console.error('❌ Error populating features checkboxes:', error);
                    const loadingMessage = document.getElementById('featuresLoadingMessage');
                    if (loadingMessage) {
                        loadingMessage.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error loading features';
                    }
                }
            }

            populateVisualFeaturesGrid(features) {
                try {
                    const featuresGrid = document.querySelector('.features-grid');
                    if (!featuresGrid) {
                        console.warn('⚠️ Features grid not found');
                        return;
                    }

                    // Clear existing hardcoded feature cards
                    featuresGrid.innerHTML = '';

                    // Create a visual feature card for each feature
                    features.forEach((feature, index) => {
                        const featureId = feature.id || `feature_${index}`;
                        const displayName = feature.title || feature.name || feature.id || `Feature ${index + 1}`;
                        const description = feature.description || `${displayName} module`;
                        const price = feature.price ? parseFloat(feature.price) : 0;
                        const iconClass = feature.icon || 'fa-puzzle-piece';
                        const isActive = this.selectedFeatures.has(featureId);
                        const isSubscribed = this.currentlySubscribedFeatures.has(featureId);

                        const featureCard = document.createElement('div');
                        featureCard.className = `feature-card ${isActive ? 'selected active' : ''} ${isSubscribed ? 'subscribed' : ''}`;
                        featureCard.setAttribute('data-feature', featureId);
                        
                        featureCard.innerHTML = `
                            <div class="feature-status">
                                <span class="status-badge ${isSubscribed ? 'locked' : (isActive ? 'active' : 'inactive')}">
                                    <i class="fas ${isSubscribed ? 'fa-lock' : (isActive ? 'fa-check' : 'fa-times')}"></i>
                                    ${isSubscribed ? 'Locked' : (isActive ? 'Active' : 'Inactive')}
                                </span>
                            </div>
                            <div class="feature-icon">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="feature-title">${displayName}</div>
                            <div class="feature-description">
                                ${description}
                            </div>
                            <div class="feature-cost">$${price.toFixed(2)}/user/month</div>
                            ${isSubscribed ? '<div class="subscribed-indicator"><i class="fas fa-shield-alt"></i> Current Plan</div>' : ''}
                        `;

                        // Add click handler for the visual card
                        featureCard.addEventListener('click', () => {
                            // Find the corresponding checkbox and toggle it
                            const checkbox = document.querySelector(`input[data-feature-id="${featureId}"]`);
                            if (checkbox && !isSubscribed) {
                                checkbox.checked = !checkbox.checked;
                                const featureItem = checkbox.closest('.feature-checkbox-item');
                                this.toggleFeatureSelection(featureId, featureItem);
                                this.updateVisualFeatureCard(featureCard, featureId);
                            } else if (isSubscribed) {
                                this.showNotification('Cannot modify subscribed features. You can only add new features to your plan.', 'warning');
                            }
                        });

                        featuresGrid.appendChild(featureCard);
                    });

                    console.log(`✅ Populated visual features grid with ${features.length} cards`);

                } catch (error) {
                    console.error('❌ Error populating visual features grid:', error);
                }
            }

            updateVisualFeatureCard(featureCard, featureId) {
                const isActive = this.selectedFeatures.has(featureId);
                const statusBadge = featureCard.querySelector('.status-badge');
                const statusIcon = statusBadge.querySelector('i');
                
                if (isActive) {
                    featureCard.classList.add('selected', 'active');
                    statusBadge.classList.remove('inactive');
                    statusBadge.classList.add('active');
                    statusIcon.classList.remove('fa-times');
                    statusIcon.classList.add('fa-check');
                    statusBadge.innerHTML = '<i class="fas fa-check"></i> Active';
                } else {
                    featureCard.classList.remove('selected', 'active');
                    statusBadge.classList.remove('active');
                    statusBadge.classList.add('inactive');
                    statusIcon.classList.remove('fa-check');
                    statusIcon.classList.add('fa-times');
                    statusBadge.innerHTML = '<i class="fas fa-times"></i> Inactive';
                }
            }

            toggleFeatureSelection(featureId, featureElement) {
                try {
                    const checkbox = featureElement.querySelector('input[type="checkbox"]');
                    
                    if (checkbox.checked) {
                        // Add to selected features
                        this.selectedFeatures.add(featureId);
                        featureElement.classList.add('selected');
                    } else {
                        // Check if trying to uncheck a currently subscribed feature
                        if (this.currentlySubscribedFeatures.has(featureId)) {
                            // Prevent unchecking and show notification
                            checkbox.checked = true;
                            featureElement.classList.add('selected');
                            this.showNotification('Cannot remove subscribed features. You can only add new features to your plan.', 'warning');
                            return;
                        }
                        
                        // Remove from selected features
                        this.selectedFeatures.delete(featureId);
                        featureElement.classList.remove('selected');
                    }
                    
                    // Update the display and pricing
                    this.updateSelectedFeaturesDisplay();
                    if (typeof updatePricingPreview === 'function') {
                        updatePricingPreview();
                    }
                    
                    // Also update the corresponding visual feature card if it exists
                    const visualFeatureCard = document.querySelector(`[data-feature="${featureId}"]`);
                    if (visualFeatureCard) {
                        this.updateVisualFeatureCard(visualFeatureCard, featureId);
                    }
                    
                } catch (error) {
                    console.error('❌ Error toggling feature selection:', error);
                }
            }

            updateSelectedFeaturesDisplay() {
                try {
                    // Just update the pricing since we now show selection status in the feature cards themselves
                    this.updatePricingDisplay();
                    updatePricingPreview();
                    
                    console.log(`✅ Updated display for ${this.selectedFeatures.size} selected features`);
                } catch (error) {
                    console.error('❌ Error updating selected features display:', error);
                }
            }

            removeFeature(featureId) {
                try {
                    // Check if this is a currently subscribed feature
                    if (this.currentlySubscribedFeatures.has(featureId)) {
                        this.showNotification('Cannot remove subscribed features. You can only add new features to your plan.', 'warning');
                        return;
                    }
                    
                    // Remove from selected set
                    this.selectedFeatures.delete(featureId);
                    
                    // Uncheck the corresponding checkbox
                    const checkbox = document.querySelector(`input[data-feature-id="${featureId}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                        const featureItem = checkbox.closest('.feature-checkbox-item');
                        if (featureItem) {
                            featureItem.classList.remove('selected');
                        }
                    }
                    
                    // Update the visual feature card
                    const visualFeatureCard = document.querySelector(`[data-feature="${featureId}"]`);
                    if (visualFeatureCard) {
                        this.updateVisualFeatureCard(visualFeatureCard, featureId);
                    }
                    
                    // Update displays
                    this.updateSelectedFeaturesDisplay();
                    
                } catch (error) {
                    console.error('❌ Error removing feature:', error);
                }
            }

            getSelectedFeaturesCount() {
                return this.selectedFeatures ? this.selectedFeatures.size : 0;
            }
        }

        // Initialize Company Management System
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Initializing Company Management System...');
            
            // Check authentication status first
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                console.error('❌ No authenticated user found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }

            try {
                // Initialize the company management system
                window.companyManagement = new CompanyManagement();
                
                // Global payment modal functions
                window.showPaymentModal = function(amount) {
                    if (window.companyManagement && window.companyManagement.showPaymentModal) {
                        window.companyManagement.showPaymentModal(amount);
                    }
                };
                
                window.closePaymentModal = function() {
                    if (window.companyManagement && window.companyManagement.closePaymentModal) {
                        window.companyManagement.closePaymentModal();
                    }
                };
                
                window.selectPaymentMethod = function(method) {
                    if (window.companyManagement && window.companyManagement.selectPaymentMethod) {
                        window.companyManagement.selectPaymentMethod(method);
                    }
                };
                
                window.processSelectedPayment = function() {
                    if (window.companyManagement && window.companyManagement.processSelectedPayment) {
                        window.companyManagement.processSelectedPayment();
                    }
                };
                
                window.closePaymentSuccessModal = function() {
                    if (window.companyManagement && window.companyManagement.closePaymentSuccessModal) {
                        window.companyManagement.closePaymentSuccessModal();
                    }
                };

                // Handle Pay Now button click with calculated amount
                window.handlePayNowClick = function() {
                    // Get the current calculated total from the pricing preview
                    const newMonthlyFeeElement = document.getElementById('newMonthlyFee');
                    if (!newMonthlyFeeElement) {
                        console.error('Could not find pricing element');
                        return;
                    }
                    
                    // Extract the amount from the text (e.g., "$150/month" -> 150)
                    const feeText = newMonthlyFeeElement.textContent || '$0/month';
                    const amount = parseFloat(feeText.replace(/[^0-9.]/g, '')) || 0;
                    
                    if (amount <= 0) {
                        if (window.companyManagement && window.companyManagement.showNotification) {
                            window.companyManagement.showNotification('Please select users or features to proceed with payment', 'warning');
                        } else {
                            alert('Please select users or features to proceed with payment');
                        }
                        return;
                    }
                    
                    // Show the payment modal with the calculated amount
                    if (window.companyManagement && window.companyManagement.showPaymentModal) {
                        window.companyManagement.showPaymentModal(amount);
                    } else {
                        console.error('Payment modal function not available');
                    }
                };
                
                // Wait for authentication to complete
                await new Promise(resolve => {
                    const checkAuth = () => {
                        if (window.companyManagement.currentUser) {
                            resolve();
                        } else {
                            setTimeout(checkAuth, 100);
                        }
                    };
                    checkAuth();
                });

                console.log('✅ Company Management System initialized with authenticated user');
                
                // Ensure company branding is updated via AuthManager
                if (window.authManager && window.authManager.updateCompanyBranding) {
                    window.authManager.updateCompanyBranding();
                    console.log('✅ Company branding updated via AuthManager');
                } else if (window.companyManagement && window.companyManagement.updateCompanyBranding) {
                    window.companyManagement.updateCompanyBranding();
                    console.log('✅ Company branding updated via CompanyManagement');
                } else {
                    console.warn('⚠️ No updateCompanyBranding method found');
                }
                
            } catch (error) {
                console.error('❌ Error initializing Company Management System:', error);
                alert('Error loading application. Please refresh the page and try again.');
                return;
            }
            
            // Make switchTab globally available
            window.switchTab = function(tabId) {
                if (window.companyManagement && window.companyManagement.switchTab) {
                    window.companyManagement.switchTab(tabId);
                }
            };
            
            // Make logo functions globally available
            window.handleLogoUpload = function(event) {
                if (window.companyManagement && window.companyManagement.handleLogoUpload) {
                    window.companyManagement.handleLogoUpload(event);
                }
            };

            // Expose HR stamp handlers for inline events
            window.handleHrStampUpload = function(event) {
                if (window.companyManagement && window.companyManagement.handleHrStampUpload) {
                    window.companyManagement.handleHrStampUpload(event);
                }
            }
            window.removeHrStamp = function() {
                if (window.companyManagement && window.companyManagement.removeHrStamp) {
                    window.companyManagement.removeHrStamp();
                }
            }
            
            window.removeLogo = function() {
                if (window.companyManagement && window.companyManagement.removeLogo) {
                    window.companyManagement.removeLogo();
                }
            };
            
            // Initialize sidebar toggle functionality
            const sidebarToggle = document.querySelector('#sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
                console.log('✅ Sidebar toggle functionality initialized');
            }
            
            // Restore sidebar state on page load
            restoreSidebarState();
            
            // Ensure profile picture and dropdown are properly loaded
            setTimeout(async () => {
                console.log('🖼️ Final profile setup check...');
                
                if (window.authManager && window.authManager.currentUser) {
                    try {
                        await window.authManager.updateUserProfile();
                        console.log('✅ Profile picture and dropdown verified');
                    } catch (error) {
                        console.warn('⚠️ Profile update warning:', error);
                    }
                } else if (window.companyManagement.currentUser) {
                    // Fallback: ensure profile is displayed even without AuthManager
                    await window.companyManagement.initializeUserProfileDisplay();
                    console.log('✅ Profile display initialized via CompanyManagement fallback');
                }
                
                // Verify dropdown functionality
                const profileDropdown = document.querySelector('.profile-dropdown');
                const userProfileBtn = document.getElementById('userProfileBtn');
                if (profileDropdown && userProfileBtn) {
                    console.log('✅ Profile dropdown elements verified');
                } else {
                    console.warn('⚠️ Profile dropdown elements not found');
                }
                
            }, 1000);
        });

        // Platform Feature Update Listener - Listen for updates from super admin dashboard
        function initializePlatformFeatureUpdateListener() {
            console.log('🔧 Initializing platform feature update listener...');
            
            // Check for feature updates on page load
            checkForPlatformFeatureUpdates();
            
            // Listen for custom events (real-time updates)
            window.addEventListener('platformFeatureUpdated', (event) => {
                console.log('📡 Received real-time platform feature update:', event.detail);
                handlePlatformFeatureUpdate(event.detail);
            });
            
            // Poll for localStorage updates every 5 seconds
            setInterval(checkForPlatformFeatureUpdates, 5000);
            
            console.log('✅ Platform feature update listener initialized');
        }

        function checkForPlatformFeatureUpdates() {
            try {
                const updateSignal = localStorage.getItem('platformFeatureUpdate');
                if (updateSignal) {
                    const signal = JSON.parse(updateSignal);
                    
                    // Check if this is a new update (not processed before)
                    const lastProcessedTimestamp = sessionStorage.getItem('lastFeatureUpdateProcessed');
                    if (!lastProcessedTimestamp || signal.timestamp > parseInt(lastProcessedTimestamp)) {
                        console.log('📱 New platform feature update detected:', signal);
                        handlePlatformFeatureUpdate(signal);
                        
                        // Mark this update as processed
                        sessionStorage.setItem('lastFeatureUpdateProcessed', signal.timestamp.toString());
                    }
                }
            } catch (error) {
                console.error('❌ Error checking for platform feature updates:', error);
            }
        }

        function handlePlatformFeatureUpdate(updateSignal) {
            try {
                const actionType = updateSignal.deleted ? 'deleted' : 'updated';
                console.log(`🔄 Processing platform feature ${actionType} for feature: ${updateSignal.featureName} (${updateSignal.featureId})`);
                
                if (!updateSignal.deleted) {
                    console.log('📋 New authorized pages:', updateSignal.authorizedPages);
                }
                
                // Force trigger menu visibility update using the priority system
                console.log('🔧 Forcing menu visibility update due to platform feature change...');
                
                if (typeof window.updateMenuVisibilityForCompanyManagement === 'function') {
                    console.log('🔧 Triggering complete menu visibility update...');
                    window.updateMenuVisibilityForCompanyManagement();
                    console.log('✅ Menu visibility update completed');
                } else if (typeof window.updateMenuWithPrioritySystem === 'function') {
                    console.log('🔧 Triggering priority system update...');
                    window.updateMenuWithPrioritySystem({});
                    console.log('✅ Priority system update completed');
                } else {
                    console.warn('⚠️ No menu update functions found');
                }
                
                // Show notification to user about the feature update
                if (window.companyManagement && window.companyManagement.showNotification) {
                    const message = updateSignal.deleted 
                        ? `Platform feature "${updateSignal.featureName}" has been deleted. Menu visibility has been refreshed.`
                        : `Platform feature "${updateSignal.featureName}" has been updated. Menu visibility has been refreshed.`;
                    
                    window.companyManagement.showNotification(message, 'info');
                } else {
                    console.log(`ℹ️ Platform feature "${updateSignal.featureName}" ${actionType} - menu refreshed`);
                }
                
            } catch (error) {
                console.error('❌ Error handling platform feature update:', error);
            }
        }

        // Initialize the feature update listener after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Delay initialization to ensure other systems are ready
            setTimeout(() => {
                initializePlatformFeatureUpdateListener();
            }, 2000);
        });

        // Test function to verify menu visibility update listener
        window.testMenuVisibilityListener = function() {
            console.log('🧪 Testing menu visibility update listener...');
            console.log('📡 Checking for updates...');
            checkForPlatformFeatureUpdates();
            console.log('✅ Test completed. Check console for any detected updates.');
        };

        // Debug function to check current company's selected features
        window.debugCompanyFeatures = async function() {
            console.log('🔍 Debugging current company features...');
            
            try {
                // Get company ID using the same method as updateMenuWithFeatureAuthorization
                let currentUser = null;
                let companyId = null;
                
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using AuthManager - CompanyId:', companyId);
                } else if (window.companyManagement && window.companyManagement.currentUser) {
                    currentUser = window.companyManagement.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using CompanyManagement - CompanyId:', companyId);
                } else if (auth.currentUser) {
                    currentUser = auth.currentUser;
                    console.log('👤 Using Firebase auth - will search for company');
                }
                
                if (!companyId && currentUser) {
                    console.log('🔍 Company ID not available, searching for user in companies...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId}`);
                                console.log(`📋 Company name: ${company.name || 'Unknown'}`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found');
                    return;
                }
                
                // Get company data
                const companySnapshot = await db.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                console.log('🏢 Company data:', {
                    name: companyData?.name,
                    selectedFeatures: companyData?.selectedFeatures
                });
                
                // Get platform features
                const featuresSnapshot = await db.ref('/platformFeatures').once('value');
                const featuresData = featuresSnapshot.val();
                
                if (companyData?.selectedFeatures) {
                    console.log('🎯 Selected features with details:');
                    companyData.selectedFeatures.forEach(featureId => {
                        const feature = featuresData[featureId];
                        if (feature) {
                            console.log(`  📦 ${feature.name} (${featureId}):`, {
                                status: feature.status,
                                authorizedPages: feature.authorizedPages
                            });
                        } else {
                            console.log(`  ❌ Feature ${featureId} not found in platform features`);
                        }
                    });
                } else {
                    console.log('⚠️ Company has no selected features');
                }
                
            } catch (error) {
                console.error('❌ Error debugging company features:', error);
            }
        };
        
        // Sidebar toggle functions
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar && mainContent) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
                
                // Store sidebar state in localStorage
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            }
        }
        
        function restoreSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            if (isCollapsed) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (sidebar && mainContent) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('sidebar-collapsed');
                }
            }
        }
        
        // Make sidebar toggle functions globally available
        window.toggleSidebar = toggleSidebar;
        window.restoreSidebarState = restoreSidebarState;
    </script>

    <script>
        // Access Control: manage who can see User Management and Subscription/Quota tabs
        (function () {
            const PATH = (companyId) => `companies/${companyId}/accessControl/tabVisibility`;
            const VIS_PATH = (companyId) => `companies/${companyId}/accessControl/companyVisibility`;

            async function loadAccessControlData(companyId) {
                const [usersSnap, permsSnap] = await Promise.all([
                    db.ref(`companies/${companyId}/users`).once('value'),
                    db.ref(PATH(companyId)).once('value')
                ]);
                return { users: usersSnap.val() || {}, perms: permsSnap.val() || {} };
            }

            async function renderAccessControlTable(companyId, users, perms) {
                const tbody = document.getElementById('accessControlTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';

                // Load company roles to get role names
                let rolesMap = { administrator: 'Administrator' };
                try {
                    const rolesSnap = await db.ref(`companies/${companyId}/roles`).once('value');
                    const rolesData = rolesSnap.val() || {};
                    Object.entries(rolesData).forEach(([id, data]) => {
                        rolesMap[id] = data.name || id;
                    });
                } catch(e) {
                    console.warn('Could not load roles for display', e);
                }

                // Only include users that already have an explicit permission record
                const permUserIds = Object.keys(perms || {});
                if (permUserIds.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="11" style="text-align:center; color:#64748b;">No users found</td>`;
                    tbody.appendChild(tr);
                } else {
                    permUserIds.forEach((uid) => {
                        const u = users[uid] || {};
                        const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
                        const email = (u.accountType === 'without-account' || u.reportingOnly === true || u.canSignIn === false) ? '-' : (u.email || '-');
                        const roleId = u.role || 'User';
                        // Look up the role display name from rolesMap
                        const roleDisplayName = rolesMap[roleId] || roleId;
                        const p = perms[uid] || {};

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${name}</td>
                            <td>${email}</td>
                            <td><span class="role-badge role-${(roleId || 'user').toString().toLowerCase()}">${roleDisplayName}</span></td>
                            <td style="text-align:center;"><input type="checkbox" data-perm="profile" data-uid="${uid}" ${p.canSeeProfileTab !== false ? 'checked' : ''}></td>
                            <td style="text-align:center;"><input type="checkbox" data-perm="users" data-uid="${uid}" ${p.canSeeUsersTab ? 'checked' : ''}></td>
                            <td style="text-align:center;"><input type="checkbox" data-perm="subscription" data-uid="${uid}" ${p.canSeeSubscriptionTab ? 'checked' : ''}></td>
                            <td style="text-align:center;"><input type="checkbox" data-perm="seeAdd" data-uid="${uid}" ${p.canSeeAddButton ? 'checked' : ''}></td>
                            <td style="text-align:center;"><input type="checkbox" data-perm="createWith" data-uid="${uid}" ${p.canCreateWithAccount ? 'checked' : ''}></td>
                            <td style="text-align:center;"><input type="checkbox" data-perm="createWithout" data-uid="${uid}" ${p.canCreateWithoutAccount !== false ? 'checked' : ''}></td>
                            <td style="text-align:center;"><button class="btn btn-secondary" type="button" title="Manage company name visibility" onclick="window.openCompanyVisibilityModal('${uid}')"><i class="fas fa-eye"></i> Manage</button></td>
                            <td style="text-align:center;"><button class="btn btn-secondary" type="button" title="Manage which roles this user can see" onclick="window.openRoleVisibilityModal('${uid}')"><i class="fas fa-user-tag"></i> Manage</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // Single delegated handler to avoid duplicates on re-render
                tbody.onchange = async (e) => {
                    const target = e.target;
                    if (!target || !target.matches('input[type="checkbox"][data-uid]')) return;
                    const uid = target.getAttribute('data-uid');
                    const perm = target.getAttribute('data-perm');
                    const update = {};
                    if (perm === 'profile') update.canSeeProfileTab = target.checked;
                    if (perm === 'users') update.canSeeUsersTab = target.checked;
                    if (perm === 'subscription') update.canSeeSubscriptionTab = target.checked;
                    if (perm === 'seeAdd') update.canSeeAddButton = target.checked;
                    if (perm === 'createWith') update.canCreateWithAccount = target.checked;
                    if (perm === 'createWithout') update.canCreateWithoutAccount = target.checked;
                    try {
                        await db.ref(`${PATH(companyId)}/${uid}`).update(update);
                        // If toggling own access, apply immediately
                        const me = window.companyManagement?.currentUser?.uid || window.companyManagement?.currentUser?.id;
                        if (me && me === uid) {
                            await applyTabVisibilityForCurrentUser(companyId);
                        }
                        window.notificationManager?.addNotification({ type: 'success', message: 'Access updated' });
                    } catch (err) {
                        console.error('Failed to update access control:', err);
                        window.notificationManager?.addNotification({ type: 'error', message: 'Failed to update access' });
                    }
                };
            }

            async function populateAccessControlCard() {
                try {
                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    if (!companyId) return;
                    const { users, perms } = await loadAccessControlData(companyId);
                    renderAccessControlTable(companyId, users, perms);
                    cacheUsersAndPermsForModal(users, perms);
                } catch (e) {
                    console.warn('Access control could not be populated:', e);
                }
            }

            async function applyTabVisibilityForCurrentUser(companyId) {
                try {
                    const me = window.companyManagement?.currentUser?.uid || window.companyManagement?.currentUser?.id;
                    if (!me || !companyId) return;
                    const pSnap = await db.ref(`${PATH(companyId)}/${me}`).once('value');
                    const p = pSnap.val() || {};
                    // User Management tab is default DENY unless explicitly granted
                    const allowUsers = p.canSeeUsersTab === true;
                    // Subscription/Quota tab is now default DENY unless explicitly granted
                    const allowSubs = p.canSeeSubscriptionTab === true;
                    // Company Profile tab is default ALLOW unless explicitly disabled
                    const allowProfile = p.canSeeProfileTab !== false;

                    const usersBtn = document.querySelector('.tab-nav-btn[data-tab="users"]');
                    const subsBtn = document.querySelector('.tab-nav-btn[data-tab="subscription"]');
                    const profileBtn = document.querySelector('.tab-nav-btn[data-tab="profile"]');
                    const usersTab = document.getElementById('usersTab');
                    const subsTab = document.getElementById('subscriptionTab');
                    const profileTab = document.getElementById('profileTab');
                    const addUserBtn = document.getElementById('addUserButton');

                    if (profileBtn) profileBtn.style.display = allowProfile ? '' : 'none';
                    if (usersBtn) usersBtn.style.display = allowUsers ? '' : 'none';
                    if (subsBtn) subsBtn.style.display = allowSubs ? '' : 'none';
                    if (profileTab) profileTab.style.display = allowProfile ? '' : 'none';
                    if (usersTab) usersTab.style.display = allowUsers ? '' : 'none';
                    if (subsTab) subsTab.style.display = allowSubs ? '' : 'none';
                    // Add button visibility (default deny unless explicitly granted)
                    const allowSeeAdd = p.canSeeAddButton === true;
                    if (addUserBtn) addUserBtn.style.display = allowSeeAdd ? '' : 'none';

                    // If currently on a hidden tab, switch to profile
                    const isUsersActive = usersTab?.classList.contains('active');
                    const isSubsActive = subsTab?.classList.contains('active');
                    const isProfileActive = profileTab?.classList.contains('active');
                    if ((isProfileActive && !allowProfile) || (isUsersActive && !allowUsers) || (isSubsActive && !allowSubs)) {
                        const fallback = allowProfile ? 'profile' : (allowUsers ? 'users' : (allowSubs ? 'subscription' : null));
                        if (fallback) {
                            const fallbackBtn = document.querySelector(`.tab-nav-btn[data-tab="${fallback}"]`);
                            const fallbackTab = document.getElementById(`${fallback}Tab`);
                            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                            document.querySelectorAll('.tab-nav-btn').forEach(b => b.classList.remove('active'));
                            if (fallbackTab) fallbackTab.classList.add('active');
                            fallbackBtn?.classList.add('active');
                        }
                    }
                } catch (e) {
                    console.warn('Failed to apply tab visibility:', e);
                }
            }

            // Prevent clicking disallowed tabs
            document.addEventListener('click', async (e) => {
                const btn = e.target.closest?.('.tab-nav-btn');
                if (!btn) return;
                const tab = btn.getAttribute('data-tab');
                if (!tab || (tab !== 'users' && tab !== 'subscription' && tab !== 'profile')) return;
                const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                const me = window.companyManagement?.currentUser?.uid || window.companyManagement?.currentUser?.id;
                if (!companyId || !me) return; // nothing to enforce
                const pSnap = await db.ref(`${PATH(companyId)}/${me}`).once('value');
                const p = pSnap.val() || {};
                // Default deny for users unless explicitly true
                const allowUsers = p.canSeeUsersTab === true;
                // Default deny for subscription unless explicitly true
                const allowSubs = p.canSeeSubscriptionTab === true;
                const allowProfile = p.canSeeProfileTab !== false;
                if ((tab === 'users' && !allowUsers) || (tab === 'subscription' && !allowSubs) || (tab === 'profile' && !allowProfile)) {
                    e.preventDefault();
                    window.notificationManager?.addNotification({ type: 'warning', message: 'You do not have access to this tab.' });
                }
            });

            // Initialize after DOM and initial data load
            document.addEventListener('DOMContentLoaded', () => {
                const init = async () => {
                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    if (!companyId) { setTimeout(init, 500); return; }
                    await populateAccessControlCard();
                    await applyTabVisibilityForCurrentUser(companyId);
                };
                setTimeout(init, 800);
            });

            // Expose for manual refresh
            window.refreshAccessControlTable = populateAccessControlCard;
            window.applyTabVisibilityForCurrentUser = applyTabVisibilityForCurrentUser;
            // Modal helpers and state cache
            let __ac_users_cache = {}; let __ac_perms_cache = {};
            function cacheUsersAndPermsForModal(users, perms){ __ac_users_cache = users || {}; __ac_perms_cache = perms || {}; }

            function populateAccessControlModalOptions(){
                const select = document.getElementById('acUserSelect');
                if (!select) return;
                const existing = new Set(Object.keys(__ac_perms_cache || {}));
                select.innerHTML = '<option value="">-- Choose a user --</option>';
                Object.entries(__ac_users_cache || {}).forEach(([uid, u]) => {
                    if (existing.has(uid)) return;
                    const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
                    const email = u.email || '-';
                    const opt = document.createElement('option');
                    opt.value = uid; opt.textContent = `${name} ${email !== '-' ? `(${email})` : ''}`.trim();
                    select.appendChild(opt);
                });
            }

            window.openAccessControlModal = async function() {
                try {
                    // Ensure latest cache
                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    if (!companyId) return;
                    const { users, perms } = await loadAccessControlData(companyId);
                    cacheUsersAndPermsForModal(users, perms);
                    populateAccessControlModalOptions();
                    // reset toggles
                    const allowProfile = document.getElementById('acAllowProfileTab');
                    const allowUsers = document.getElementById('acAllowUsersTab');
                    const allowSubs = document.getElementById('acAllowSubsTab');
                    const allowSeeAdd = document.getElementById('acAllowSeeAddBtn');
                    const allowCreateWith = document.getElementById('acAllowCreateWith');
                    const allowCreateWithout = document.getElementById('acAllowCreateWithout');
                    if (allowProfile) allowProfile.checked = true;
                    if (allowUsers) allowUsers.checked = true;
                    if (allowSubs) allowSubs.checked = true;
                    if (allowSeeAdd) allowSeeAdd.checked = true;
                    if (allowCreateWith) allowCreateWith.checked = true;
                    if (allowCreateWithout) allowCreateWithout.checked = true;
                    const modal = document.getElementById('accessControlModal');
                    if (modal) { modal.style.display = 'flex'; modal.classList.add('show'); }
                } catch (e) { console.warn('Failed to open access control modal', e); }
            };

            window.saveAccessControlFromModal = async function() {
                const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                if (!companyId) return;
                const select = document.getElementById('acUserSelect');
                const uid = select?.value || '';
                if (!uid) { window.notificationManager?.addNotification({ type:'warning', message:'Please choose a user' }); return; }
                const canProfile = !!document.getElementById('acAllowProfileTab')?.checked;
                const canUsers = !!document.getElementById('acAllowUsersTab')?.checked;
                const canSubs = !!document.getElementById('acAllowSubsTab')?.checked;
                const canSeeAdd = !!document.getElementById('acAllowSeeAddBtn')?.checked;
                const canCreateWith = !!document.getElementById('acAllowCreateWith')?.checked;
                const canCreateWithout = !!document.getElementById('acAllowCreateWithout')?.checked;
                try {
                    await db.ref(`companies/${companyId}/accessControl/tabVisibility/${uid}`).set({
                        canSeeProfileTab: canProfile,
                        canSeeUsersTab: canUsers,
                        canSeeSubscriptionTab: canSubs,
                        canSeeAddButton: canSeeAdd,
                        canCreateWithAccount: canCreateWith,
                        canCreateWithoutAccount: canCreateWithout
                    });
                    await populateAccessControlCard();
                    closeModal('accessControlModal');
                    window.notificationManager?.addNotification({ type:'success', message:'User added to access control' });
                } catch (err) {
                    console.error('Failed to save access control:', err);
                    window.notificationManager?.addNotification({ type:'error', message:'Failed to add user' });
                }
            };

            // Company Name Visibility Management
            let __ac_company_visibility_uid = null;

            window.openCompanyVisibilityModal = async function(uid){
                try {
                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    if (!companyId || !uid) return;
                    __ac_company_visibility_uid = uid;
                    // Load subcontractors to build options
                    let subs = {};
                    try {
                        const subsSnap = await db.ref(`companies/${companyId}/subcontractors`).once('value');
                        subs = subsSnap.val() || {};
                    } catch(e) { console.warn('Could not load subcontractors for visibility modal', e); }
                    // Load current visibility
                    const visSnap = await db.ref(`${VIS_PATH(companyId)}/${uid}/allowedIds`).once('value');
                    const allowed = visSnap.val() || null;
                    const allowedSet = new Set(allowed ? Object.keys(allowed).filter(k => allowed[k]) : []);

                    // Build list
                    const container = document.getElementById('companyVisibilityOptions');
                    if (container) {
                        container.innerHTML = '';
                        // Main company
                        const mainId = companyId;
                        const mainName = window.companyManagement?.companyData?.companyName || 'Main Company';
                        const mainRow = document.createElement('label');
                        mainRow.className = 'checkbox-row';
                        mainRow.innerHTML = `<input type="checkbox" class="cv-checkbox" value="${mainId}" ${allowedSet.size === 0 || allowedSet.has(mainId) ? 'checked' : ''}> <span>${mainName}</span>`;
                        container.appendChild(mainRow);
                        // Subcontractors
                        Object.entries(subs).forEach(([id, sub]) => {
                            const name = sub?.name || sub?.companyName || 'Subcontractor';
                            const row = document.createElement('label');
                            row.className = 'checkbox-row';
                            row.innerHTML = `<input type="checkbox" class="cv-checkbox" value="${id}" ${allowedSet.has(id) ? 'checked' : ''}> <span>${name}</span>`;
                            container.appendChild(row);
                        });
                    }

                    const modal = document.getElementById('companyVisibilityModal');
                    if (modal) { modal.style.display = 'flex'; modal.classList.add('show'); }
                } catch(e) { console.warn('Failed to open company visibility modal', e); }
            };

            window.saveCompanyVisibility = async function(){
                try {
                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    const uid = __ac_company_visibility_uid;
                    if (!companyId || !uid) return;
                    const checks = Array.from(document.querySelectorAll('#companyVisibilityOptions .cv-checkbox'));
                    const allowedIds = {};
                    checks.forEach(chk => { if (chk.checked) allowedIds[chk.value] = true; });
                    // If nothing selected, default to main company only
                    if (Object.keys(allowedIds).length === 0) allowedIds[companyId] = true;
                    await db.ref(`${VIS_PATH(companyId)}/${uid}/allowedIds`).set(allowedIds);
                    window.notificationManager?.addNotification({ type:'success', message:'Company visibility updated' });
                    closeModal('companyVisibilityModal');
                } catch(e) {
                    console.error('Failed to save company visibility', e);
                    window.notificationManager?.addNotification({ type:'error', message:'Failed to save company visibility' });
                }
            };

            // Role Visibility Management - Control which roles appear in role dropdown (per-user)
            const ROLE_VIS_PATH = (companyId, uid) => `companies/${companyId}/accessControl/roleVisibility/${uid}`;

            // Store current user UID being edited for role visibility
            let roleVisibilityTargetUid = null;

            window.openRoleVisibilityModal = async function(uid){
                try {
                    if (!uid) {
                        window.notificationManager?.addNotification({ type:'warning', message:'User ID required' });
                        return;
                    }
                    roleVisibilityTargetUid = uid;

                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    if (!companyId) {
                        window.notificationManager?.addNotification({ type:'warning', message:'Company not loaded' });
                        return;
                    }

                    // Get user info for display
                    let userName = 'User';
                    try {
                        const userSnap = await db.ref(`users/${uid}`).once('value');
                        const userData = userSnap.val();
                        if (userData) {
                            userName = userData.displayName || userData.name || userData.firstName || userData.email || 'User';
                        }
                    } catch(e) {
                        console.warn('Could not load user name', e);
                    }

                    // Update modal title to show user name
                    const modalTitle = document.querySelector('#roleVisibilityModal .modal-title');
                    if (modalTitle) {
                        modalTitle.innerHTML = `<i class="fas fa-user-tag"></i> Role Visibility for <strong>${userName}</strong>`;
                    }

                    // Load all available roles
                    let allRoles = [];
                    if (window.companyManagement && typeof window.companyManagement.loadCompanyRoles === 'function') {
                        allRoles = await window.companyManagement.loadCompanyRoles();
                    } else {
                        // Fallback: load directly from Firebase
                        const rolesSnap = await db.ref(`companies/${companyId}/roles`).once('value');
                        const rolesData = rolesSnap.val() || {};
                        allRoles = [
                            { id: 'administrator', name: 'Administrator', description: 'Default administrator role', isSystemRole: true }
                        ];
                        Object.entries(rolesData).forEach(([id, data]) => {
                            if (id !== 'administrator') {
                                allRoles.push({ id, name: data.name || id, description: data.description || '' });
                            }
                        });
                    }

                    // Load current visibility settings for this specific user
                    const visSnap = await db.ref(ROLE_VIS_PATH(companyId, uid)).once('value');
                    const visibleRoles = visSnap.val() || null;
                    // If null (not configured), all roles are visible by default
                    const visibleSet = visibleRoles ? new Set(Object.keys(visibleRoles).filter(k => visibleRoles[k])) : null;

                    // Build checkbox list
                    const container = document.getElementById('roleVisibilityOptions');
                    if (container) {
                        container.innerHTML = '';
                        allRoles.forEach(role => {
                            const isChecked = visibleSet === null || visibleSet.has(role.id);
                            const isAdmin = role.id === 'administrator';
                            const row = document.createElement('label');
                            row.className = 'checkbox-row';
                            row.style.cssText = 'display:flex;align-items:center;gap:0.5rem;padding:0.5rem;border-radius:6px;cursor:pointer;transition:background 0.15s;';
                            row.onmouseenter = () => row.style.background = '#f1f5f9';
                            row.onmouseleave = () => row.style.background = '';
                            row.innerHTML = `
                                <input type="checkbox" class="rv-checkbox" value="${role.id}" ${isChecked ? 'checked' : ''} ${isAdmin ? 'disabled' : ''} style="width:18px;height:18px;cursor:pointer;">
                                <span style="flex:1;">
                                    <strong style="color:#1e293b;">${isAdmin ? '👑 ' : ''}${role.name}</strong>
                                    ${role.description ? `<br><small style="color:#64748b;">${role.description}</small>` : ''}
                                </span>
                            `;
                            container.appendChild(row);
                        });

                        // Add note about Administrator
                        const note = document.createElement('div');
                        note.style.cssText = 'margin-top:0.75rem;padding:0.5rem;background:#fef3c7;border-radius:6px;font-size:0.8rem;color:#92400e;';
                        note.innerHTML = '<i class="fas fa-info-circle"></i> Administrator role is always visible and cannot be hidden.';
                        container.appendChild(note);
                    }

                    const modal = document.getElementById('roleVisibilityModal');
                    if (modal) { modal.style.display = ''; modal.classList.add('show'); }
                } catch(e) {
                    console.error('Failed to open role visibility modal', e);
                    window.notificationManager?.addNotification({ type:'error', message:'Failed to load roles' });
                }
            };

            window.saveRoleVisibility = async function(){
                try {
                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    if (!companyId) return;
                    if (!roleVisibilityTargetUid) {
                        window.notificationManager?.addNotification({ type:'warning', message:'No user selected' });
                        return;
                    }

                    const checks = Array.from(document.querySelectorAll('#roleVisibilityOptions .rv-checkbox'));
                    const visibleRoles = {};
                    checks.forEach(chk => {
                        // Administrator is always visible even if disabled checkbox
                        if (chk.value === 'administrator') {
                            visibleRoles[chk.value] = true;
                        } else {
                            visibleRoles[chk.value] = chk.checked;
                        }
                    });

                    await db.ref(ROLE_VIS_PATH(companyId, roleVisibilityTargetUid)).set(visibleRoles);
                    window.notificationManager?.addNotification({ type:'success', message:'Role visibility settings saved' });
                    roleVisibilityTargetUid = null;
                    closeModal('roleVisibilityModal');
                } catch(e) {
                    console.error('Failed to save role visibility', e);
                    window.notificationManager?.addNotification({ type:'error', message:'Failed to save role visibility' });
                }
            };

            // Helper to get visible roles for the current logged-in user (for use in dropdown population)
            window.getVisibleRolesForDropdown = async function(){
                try {
                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    if (!companyId) return null;
                    
                    // Get current logged-in user's UID
                    const currentUser = firebase.auth().currentUser;
                    if (!currentUser || !currentUser.uid) return null;
                    
                    const visSnap = await db.ref(ROLE_VIS_PATH(companyId, currentUser.uid)).once('value');
                    return visSnap.val(); // null means all visible, object means check each role
                } catch(e) {
                    console.warn('Could not load role visibility settings', e);
                    return null;
                }
            };
        })();
    </script>
    <style>
        /* Font Awesome Icons - Keep external link for icons */
        /* All essential CSS from styles.css embedded below */
        
        /* CSS Variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --font-scale: 1;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* Main content adjustments when sidebar is collapsed */
        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .main-content.sidebar-collapsed .top-nav {
            left: 0.5rem;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.3rem;
            padding-top: 3.2rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
        }

        /* Top Navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.3rem;
            position: fixed;
            top: 0.25rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            height: 50px;
            min-height: 50px;
            z-index: 100;
            transition: left 0.3s ease;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .notification-btn:hover {
            background-color: #f8f9fa;
        }

        .notification-btn i {
            font-size: 1.2rem;
            color: #6c757d;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .mark-all-read:hover {
            text-decoration: underline;
        }

        .notification-list {
            padding: 0.5rem 0;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
            display: none;
        }

        .notification-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .notification-item:hover {
            background-color: #f8f9fa;
        }

        .notification-item.unread {
            background-color: #e3f2fd;
        }

        .notification-item .notification-content {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .notification-item .notification-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
            flex-shrink: 0;
        }

        .notification-item .notification-icon.info {
            background-color: #3498db;
        }

        .notification-item .notification-icon.success {
            background-color: #2ecc71;
        }

        .notification-item .notification-icon.warning {
            background-color: #f39c12;
        }

        .notification-item .notification-icon.error {
            background-color: #e74c3c;
        }

        .notification-item .notification-text {
            flex: 1;
        }

        .notification-item .notification-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .notification-item .notification-message {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .notification-item .notification-time {
            color: #6c757d;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-btn .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li {
            padding: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Content Styles */
        .content {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Form Styles */
        .form-container {
            width: 100%;
            max-width: none;
            margin: 1.5rem 0;
            padding: 1.5rem;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: var(--spacing-unit);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Button Styles */
        .btn {
            padding: var(--padding-sm) var(--padding-md);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--green);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--red);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Payment Button and Modal Styles */
        #payBalanceBtn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        #payBalanceBtn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea485 100%);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
            transform: translateY(-1px);
        }

        .payment-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border: 1px solid #dee2e6;
        }

        .amount-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .amount-label {
            font-weight: 500;
            color: #6c757d;
        }

        .amount-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #28a745;
        }

        .payment-methods {
            margin-bottom: 1.5rem;
        }

        .payment-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .payment-option:hover {
            background-color: #f8f9fa;
            border-color: #28a745;
        }

        .payment-option input[type="radio"] {
            margin-right: 0.75rem;
        }

        .payment-option label {
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .payment-option label i {
            margin-right: 0.5rem;
            color: #6c757d;
        }

        .price-difference.increase {
            color: #dc3545;
            font-weight: 600;
        }

        .price-difference.decrease {
            color: #28a745;
            font-weight: 600;
        }

        .price-difference i {
            margin-right: 0.25rem;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .btn-edit {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-edit:hover {
            background-color: #2980b9;
        }

        .btn-delete {
            background-color: var(--red);
            color: white;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .btn-view {
            background-color: var(--green);
            color: white;
        }

        .btn-view:hover {
            background-color: #218838;
        }

        /* Role Badge Styles */
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-user {
            background-color: #95a5a6;
            color: white;
        }

        .role-admin {
            background-color: #e67e22;
            color: white;
        }

        .role-manager {
            background-color: #2ecc71;
            color: white;
        }

        .role-hr {
            background-color: #3498db;
            color: white;
        }

        .role-safety {
            background-color: #9b59b6;
            color: white;
        }

        .role-finance {
            background-color: #f39c12;
            color: white;
        }

        /* Status Badge Styles */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background-color: #2ecc71;
            color: white;
        }

        .status-inactive {
            background-color: #95a5a6;
            color: white;
        }

        .status-suspended {
            background-color: #e74c3c;
            color: white;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-close:hover {
            color: var(--red);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Payment Modal Styles */
        .payment-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .amount-display {
            margin-bottom: 0.5rem;
        }

        .amount-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .amount-value {
            font-size: 2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .payment-description {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .payment-methods h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .payment-option {
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .payment-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .payment-option.selected {
            border-color: var(--primary-color);
            background-color: #e3f2fd;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .payment-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .payment-option label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin: 0;
            font-weight: 500;
            flex-direction: column;
            align-items: flex-start;
        }

        .payment-option label i {
            font-size: 1.5rem;
        }

        .payment-method-desc {
            font-size: 0.85rem;
            color: #666;
            font-weight: 400;
            margin-top: 0.25rem;
        }

        .payment-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .payment-form h5 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .paypal-info {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.9rem;
        }

        .paypal-info i {
            color: #28a745;
        }

        .payment-processing, .payment-success {
            padding: 2rem 1rem;
        }

        .payment-processing h4, .payment-success h4 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .payment-processing p, .payment-success p {
            color: #666;
            margin-bottom: 1.5rem;
        }

        .success-details {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: left;
        }

        #processPaymentBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* User Info Styles */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-email {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: static;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .top-nav {
                flex-direction: column;
                gap: 1rem;
            }

            .form-container {
                padding: 1rem;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
            }
        }
    </style>
    <style>
        /* Button styling for test controls */
        .feature-test-controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .feature-test-controls button:active {
            transform: translateY(0);
        }

        #menuSystemStatus {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        body {
            background: #f8f9fa;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .company-management-container {
            padding: 1rem;
            max-width: 100%;
            margin: 0;
            width: 100%;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 0.55rem 0.75rem;
            border-radius: 0;
            margin: 0.35rem 0 0.25rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.9rem;
        }

        .page-header i {
            font-size: 1rem;
        }

        .page-title {
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 0;
        }

        /* Make the header plan summary smaller without affecting other subtitles */
        #headerPlanSummary {
            font-size: 0.9rem;
            opacity: 0.85;
        }

        /* Hide the duplicate quota line in the info bar above the tabs */
        .company-info-bar #userQuota {
            display: none;
        }
        /* Hide the subscription plan label (Enterprise) above the tabs */
        .company-info-bar #subscriptionPlan {
            display: none;
        }

        .company-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.4rem;
            padding-top: 0.4rem;
            border-top: 1px solid rgba(255, 255, 255, 0.12);
        }

        .page-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Add New Button (match staff.html) */
        .btn-add-new {
            background: none;
            border: none;
            color: #fff;
            padding: 0.4rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-add-new:hover {
            color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        .btn-add-new i {
            font-size: 1.2rem;
        }

        .btn-add-new.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .company-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-active {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .subscription-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
        }

        .subscription-plan {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .user-quota {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }
        
        /* Role Badge Styles for Users Table */
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .role-badge.role-admin {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .role-badge.role-manager {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .role-badge.role-user {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }
        
        /* Additional role styles for company-created roles */
        .role-badge.role-hr {
            background: rgba(102, 16, 242, 0.1);
            color: #6610f2;
            border: 1px solid rgba(102, 16, 242, 0.2);
        }
        
        .role-badge.role-safety {
            background: rgba(253, 126, 20, 0.1);
            color: #fd7e14;
            border: 1px solid rgba(253, 126, 20, 0.2);
        }
        
        .role-badge.role-finance {
            background: rgba(13, 202, 240, 0.1);
            color: #0dcaf0;
            border: 1px solid rgba(13, 202, 240, 0.2);
        }
        
        /* Default styling for unknown roles */
        .role-badge:not(.role-admin):not(.role-manager):not(.role-user):not(.role-hr):not(.role-safety):not(.role-finance) {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
            border: 1px solid rgba(108, 117, 125, 0.2);
        }
        
        /* Role Change Notification Styles */
        .role-notification {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Top Navigation Header Logo */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 0.3rem;
            position: fixed;
            top: 0.25rem;
            right: 0.5rem;
            left: calc(var(--sidebar-width) + 0.5rem);
            height: 50px;
            min-height: 50px;
            z-index: 100;
            transition: left 0.3s ease;
        }

        .top-nav-left { display:flex; align-items:center; gap:0.75rem; }
        .company-branding { display:flex; align-items:center; gap:0.5rem; }
        #headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
        #headerCompanyLogo.visible { display:block; }
        #headerCompanyName { font-weight:600; font-size:0.85rem; }
        .header-company-logo { height:32px; width:auto; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        .company-name-header { font-weight:700; color:var(--dark-color); font-size:1rem; letter-spacing:0.5px; white-space:nowrap; }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Tab Navigation (match staff.html) */
        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin: 0 0 1rem 0;
            background: white;
            padding: 0.5rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-nav-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #6c757d;
            flex: 1;
            justify-content: center;
        }

        .tab-nav-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        /* Active tab matches staff.html generic style; page-specific colors can be added with IDs if needed */
        .tab-nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        /* Tab Content (align spacing with staff.html) */
        .tab-content {
            display: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .tab-content.active {
            display: block;
            width: 100%;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 2rem;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        /* Three column layout for name, title, department row */
        .form-grid-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        /* Four column layout for company name, reg no, industry, company size */
        .form-grid-four {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }

        /* Ensure 4-column layout takes precedence when both classes are present */
        .form-grid.form-grid-four {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }

        /* Grid column span helpers for 4-col layout */
        .form-grid-four .col-span-1 { grid-column: span 1; }
        .form-grid-four .col-span-2 { grid-column: span 2; }
        .form-grid-four .col-span-3 { grid-column: span 3; }
        .form-grid-four .col-span-4 { grid-column: span 4; }

        @media (max-width: 768px) {
            /* On mobile, all grid items span full width */
            .form-grid-four .col-span-1,
            .form-grid-four .col-span-2,
            .form-grid-four .col-span-3,
            .form-grid-four .col-span-4 {
                grid-column: span 1;
            }
        }

        /* Responsive form grid - stack on smaller screens */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }
            
            .form-grid-three {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }

            .form-grid-four {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }

            /* Stack 4-column grids in profile tab on mobile */
            #profileTab .form-grid.form-grid-four {
                grid-template-columns: 1fr;
                gap: 0.25rem;
            }

            /* Subscription section responsive */
            .subscription-status {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .subscription-actions {
                width: 100%;
                justify-content: center;
            }

            .quota-management-section {
                padding: 1.5rem;
            }

            .quota-input-section {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .input-groups-container {
                gap: 1.5rem;
            }

            .pricing-preview {
                min-width: auto;
            }

            .form-actions {
                flex-direction: column;
                gap: 0.75rem;
            }

            .form-actions .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .subscription-info-item {
                padding: 1rem;
            }

            .subscription-info-item .info-icon {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }

            .price-amount {
                font-size: 1.8rem;
            }

            .input-with-controls {
                padding: 0.15rem;
            }

            .quota-btn {
                width: 32px;
                height: 32px;
            }
        }

        .form-group {
            margin-bottom: 0.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .form-group label.required::after {
            content: " *";
            color: #dc3545;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        /* Make single-line textareas the same height as inputs */
        #profileTab #address,
        #profileTab #billingAddress {
            resize: none;
            height: 2.65rem; /* Same as input height with 0.75rem padding + 4px border + 0.9rem font-size */
            line-height: 1.2;
            overflow: hidden;
            min-height: 2.65rem;
            max-height: 2.65rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-hint {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .form-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: none;
        }

        .form-group.error input,
        .form-group.error select,
        .form-group.error textarea {
            border-color: #dc3545;
        }

        .form-group.error .form-error {
            display: block;
        }

        /* Logo Upload Styles */
        .logo-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
            border: 2px dashed #e9ecef;
            border-radius: 12px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .logo-upload-container:hover {
            border-color: var(--secondary-color);
            background: rgba(52, 152, 219, 0.1);
        }

        .logo-upload-container.dragover {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%);
        }

        .logo-preview {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: #e9ecef;
            border: 2px solid #dee2e6;
            object-fit: cover;
            display: none;
        }

        .logo-preview.visible {
            display: block;
        }

        .logo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: #e9ecef;
            border: 2px dashed #ced4da;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.5rem;
        }

        .logo-upload-text {
            text-align: center;
            color: #6c757d;
        }

        /* Company Profile: align logo uploader content to the left */
        #profileTab .logo-upload-container {
            align-items: flex-start;
        }

        #profileTab .logo-upload-text {
            text-align: left;
        }

        .logo-upload-text h4 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-weight: 600;
        }

        .logo-upload-text p {
            margin: 0;
            font-size: 0.9rem;
        }

        .logo-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .logo-actions.hidden {
            display: none;
        }

        /* Limit company logo section to match one field width in 4-col grid */
        #profileTab #companyLogoGroup {
            max-width: calc((100% - 3rem) / 4); /* 4 columns with 1rem gaps => 3 gaps */
        }
        /* Align the logo upload box to the left */
        #profileTab #companyLogoGroup .logo-upload-container {
            align-items: flex-start;
        }
        /* Stack full width on mobile */
        @media (max-width: 768px) {
            #profileTab #companyLogoGroup {
                max-width: 100%;
            }
        }

        .btn-upload {
            background: var(--secondary-color);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        /* Typography: reduce text sizes in Company Profile tab */
        #profileTab .card-title {
            font-size: 1.05rem; /* was 1.25rem globally */
        }
        #profileTab h4 {
            font-size: 1rem;
        }
        #profileTab .card-body,
        #profileTab .card-header {
            font-size: 0.95rem;
        }
        #profileTab .form-group label {
            font-size: 0.85rem; /* was 0.95rem */
        }
        #profileTab .form-group input,
        #profileTab .form-group select,
        #profileTab .form-group textarea {
            font-size: 0.9rem; /* was 1rem */
        }
        #profileTab .form-hint,
        #profileTab .form-error {
            font-size: 0.8rem; /* was 0.875rem */
        }
        #profileTab .logo-upload-text h4 { font-size: 0.95rem; }
        #profileTab .logo-upload-text p { font-size: 0.8rem; }

        /* Keep address height aligned with reduced input font-size in profile tab */
        #profileTab #address {
            height: calc(0.9rem + 1.5rem + 4px);
            line-height: 1.1rem;
        }

        .btn-upload:hover {
            background: var(--primary-color);
        }

        .btn-remove-logo {
            background: #dc3545;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-remove-logo:hover {
            background: #c82333;
        }

        .logo-file-input {
            display: none;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Disabled Button Styles */
        .btn:disabled,
        .btn.disabled {
            background: #e9ecef !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
            opacity: 0.6;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:disabled:hover,
        .btn.disabled:hover {
            background: #e9ecef !important;
            color: #6c757d !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Quota Exceeded Tooltip */
        .quota-exceeded-tooltip {
            position: relative;
            display: inline-block;
        }

        .quota-exceeded-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #dc3545;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            font-weight: normal;
        }

        .quota-exceeded-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #dc3545 transparent transparent transparent;
        }

        .quota-exceeded-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Users Management Styles (aligned with payroll Employees table) */
        .table-wrapper{overflow:auto;border:1px solid var(--border, #e2e8f0);border-radius:8px;background:#fff;}
    .users-table { width:100%; border-collapse:collapse; font-size:.72rem; min-width:900px; }
    .users-table th { background:#f1f5f9; padding:6px 8px; font-size:inherit; font-weight:600; color:#475569; border-bottom:1px solid var(--line, #e2e8f0); text-align:left; white-space:nowrap; }
    .users-table td { padding:6px 8px; font-size:inherit; color:#334155; border-bottom:1px solid var(--line, #e2e8f0); vertical-align:middle; }
    /* Ensure badges and special elements do not override uniform sizing within the table */
    .users-table .admin-badge,
    .users-table .role-badge,
    .users-table .status-badge { font-size: inherit; }
        /* Subcontractors actions: icon-only buttons (no background) */
        #subcontractorsCard .users-table td:last-child {
            white-space: nowrap;
        }
        #subcontractorsCard .users-table td:last-child .btn {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 4px;
            min-width: auto;
            height: auto;
            line-height: 1;
            cursor: pointer;
        }
        #subcontractorsCard .users-table td:last-child .btn .fas {
            font-size: 1rem;
        }
        #subcontractorsCard .users-table td:last-child .btn.btn-secondary {
            color: #64748b; /* slate-500 */
        }
        #subcontractorsCard .users-table td:last-child .btn.btn-danger {
            color: #dc3545; /* bootstrap danger red */
        }
        #subcontractorsCard .users-table td:last-child .btn:hover {
            background: transparent !important;
            opacity: 0.8;
        }
        #subcontractorsCard .users-table td:last-child .btn:focus {
            outline: 2px solid #94a3b8; /* slate-400 */
            outline-offset: 2px;
        }
        .users-table tbody tr { transition:background .15s; }
        .users-table tbody tr:hover { background:#f8fafc; cursor:pointer; box-shadow:none; transform:none; }

        .users-table tbody tr.user-row { transition: all 0.2s ease; }
        .users-table tbody tr.user-row:hover { background:#e3f2fd; }

        /* Admin row styling */
        .users-table tbody tr.admin-row {
            background: linear-gradient(135deg, #fff8dc 0%, #faf0e6 100%);
            border-left: 4px solid #ffd700;
            transition: all 0.2s ease;
        }

        .users-table tbody tr.admin-row:hover {
            background: linear-gradient(135deg, #fff5c4 0%, #f5e9d3 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }

        .admin-badge {
            color: #ffd700;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.7rem;
            margin-right: 0.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .user-email {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .role-admin {
            background: #d4edda;
            color: #155724;
        }

        .role-manager {
            background: #d1ecf1;
            color: #0c5460;
        }

        .role-user {
            background: #f8d7da;
            color: #721c24;
        }

        .admin-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .admin-yes {
            background: #d4edda;
            color: #155724;
        }

        .admin-no {
            background: #f8d7da;
            color: #721c24;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            justify-content: center;
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }

        .btn-view {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-view:hover {
            background: #bbdefb;
            color: #0d47a1;
        }

        .btn-edit {
            background: #fff3e0;
            color: #f57c00;
        }

        .btn-edit:hover {
            background: #ffe0b2;
            color: #e65100;
        }

        .btn-delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .btn-delete:hover {
            background: #ffcdd2;
            color: #b71c1c;
        }

        .btn-admin-add {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .btn-admin-add:hover {
            background: #c8e6c9;
            color: #1b5e20;
        }

        .btn-admin-remove {
            background: #fce4ec;
            color: #c2185b;
        }

        .btn-admin-remove:hover {
            background: #f8bbd9;
            color: #880e4f;
        }

        /* Quota Management */
        .quota-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .quota-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }

        .quota-stat {
            text-align: center;
        }

        .quota-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .quota-label {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 500;
        }

        .quota-progress {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .quota-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .quota-warning {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #fff3cd;
            color: #856404;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border: 1px solid #ffeaa7;
        }

        /* Feature Selection */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .feature-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .feature-card:hover {
            border-color: var(--secondary-color);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .feature-card.selected {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.05) 0%, rgba(52, 152, 219, 0.05) 100%);
        }

        .feature-card.selected::before {
            content: "✓";
            position: absolute;
            top: -10px;
            right: -10px;
            background: #28a745;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .feature-icon {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 1rem;
        }

        .feature-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .feature-description {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .feature-cost {
            font-size: 0.85rem;
            color: #007bff;
            font-weight: 600;
            background: #f0f8ff;
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            display: inline-block;
        }

        .subscribed-indicator {
            position: absolute;
            bottom: 12px;
            left: 12px;
            font-size: 0.75rem;
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .subscribed-indicator i {
            font-size: 0.7rem;
        }

        /* Feature Status Badge */
        .feature-status {
            position: absolute;
            top: 12px;
            right: 12px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .status-badge.active {
            background: #28a745;
            color: white;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        .status-badge.inactive {
            background: #6c757d;
            color: white;
        }

        .status-badge.locked {
            background: #ffc107;
            color: #212529;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
            font-weight: 700;
        }

        /* Enhanced feature card selected state */
        .feature-card.selected {
            border: 2px solid #28a745 !important;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2) !important;
            transform: translateY(-2px);
        }

        .feature-card.selected.active {
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }

        .feature-card.selected:hover {
            border-color: #28a745;
            box-shadow: 0 6px 16px rgba(40, 167, 69, 0.3) !important;
        }

        /* Locked/Subscribed feature card styling */
        .feature-card.subscribed {
            border: 2px solid #ffc107 !important;
            background: linear-gradient(135deg, #fffbf0 0%, #ffffff 100%);
            position: relative;
        }

        .feature-card.subscribed::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ffc107, #fd7e14);
            border-radius: 12px;
            z-index: -1;
            opacity: 0.1;
        }

        .feature-card.subscribed:hover {
            cursor: not-allowed;
            transform: none;
        }

        /* Active Features Summary */
        .active-features-summary {
            margin-bottom: 2rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
        }

        .stat-icon.active {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .stat-icon.cost {
            background: linear-gradient(135deg, #ffc107, #ffb300);
        }

        .stat-icon.users {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .active-features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .active-feature-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8fff8;
            border-radius: 8px;
            border: 1px solid #c3e6c3;
        }

        .active-feature-item .feature-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #28a745, #20c997);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            margin: 0;
        }

        .active-feature-info {
            flex: 1;
        }

        .active-feature-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .active-feature-cost {
            font-size: 0.85rem;
            color: #28a745;
        }

        /* Features Management Header */
        .features-management-header {
            margin-bottom: 2rem;
        }

        .features-quota-info {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .quota-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quota-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .quota-value {
            font-weight: 600;
            color: #007bff;
        }

        .quota-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .quota-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        /* Enhanced Pricing Summary */
        .pricing-breakdown-detailed {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .breakdown-item.total {
            font-weight: 600;
            font-size: 1.1rem;
            color: #2c3e50;
            padding-top: 0.75rem;
            border-top: 2px solid #dee2e6;
        }

        .breakdown-label {
            color: #6c757d;
        }

        .breakdown-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .breakdown-value.total {
            color: #007bff;
            font-size: 1.2rem;
        }

        /* Enhanced Feature Cards */
        .feature-card.selected.active {
            border-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, rgba(32, 201, 151, 0.05) 100%);
        }

        .feature-card.selected.active::before {
            background: #28a745;
        }

        .features-grid .feature-card {
            background: white;
        }

        /* Domain Management */
        .domain-list {
            margin-top: 1rem;
        }

        .domain-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #e9ecef;
        }

        .domain-item .domain-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .domain-item .domain-actions {
            display: flex;
            gap: 0.5rem;
        }

        .domain-item button {
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .btn-remove {
            background: #dc3545;
            color: white;
        }

        .btn-remove:hover {
            background: #c82333;
        }

        /* Plan Upgrade Section */
        .plan-upgrade {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
        }

        .plan-upgrade h3 {
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .plan-upgrade p {
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        /* Quota Management Section */
        .quota-management-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid #e9ecef;
        }

        .section-header {
            margin-bottom: 1.5rem;
        }

        .section-header h4 {
            margin: 0 0 0.5rem 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
        }

        .section-description {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .quota-form {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .quota-input-section {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 2rem;
            align-items: start;
        }

        .input-groups-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .input-group {
            flex: 1;
        }

        .input-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .input-with-controls {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.25rem;
            border: 1px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .input-with-controls:focus-within {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .quota-btn {
            background: none;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
            color: #6c757d;
        }

        .quota-btn:hover {
            background-color: #007bff;
            color: white;
        }

        .quota-btn:active {
            transform: scale(0.95);
        }

        .quota-btn:disabled,
        .quota-btn.disabled {
            background-color: #f8f9fa;
            color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .quota-btn:disabled:hover,
        .quota-btn.disabled:hover {
            background-color: #f8f9fa;
            color: #adb5bd;
        }

        .input-with-controls input {
            flex: 1;
            border: none;
            background: transparent;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 0.5rem;
            outline: none;
            color: #2c3e50;
        }

        /* Features Quota Select Styling */
        #featuresQuotaSelect {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            background: white;
            color: #2c3e50;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        #featuresQuotaSelect:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        #featuresQuotaSelect:hover {
            border-color: #dee2e6;
        }

        /* Features Selection Container */
        .features-selection-container {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
            background: white;
            max-height: 300px;
            overflow-y: auto;
        }

        .features-loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .features-loading i {
            margin-right: 0.5rem;
        }

        .features-checkbox-list {
            display: grid;
            gap: 0.5rem;
        }

        .feature-checkbox-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .feature-checkbox-item:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
        }

        .feature-checkbox-item.selected {
            background: #e3f2fd;
            border-color: var(--primary-color);
        }

        /* Subscribed Feature Checkbox Styling */
        .feature-checkbox-item.subscribed-feature {
            border-left: 4px solid #ffc107;
            background: linear-gradient(90deg, #fffbf0 0%, #ffffff 100%);
        }

        .feature-checkbox-item.subscribed-feature:hover {
            background: linear-gradient(90deg, #fffbf0 0%, #ffffff 100%);
            cursor: not-allowed;
        }

        .feature-checkbox-item.subscribed-feature.selected {
            background: linear-gradient(90deg, #fffbf0 0%, #ffffff 100%);
        }

        .feature-checkbox-item.subscribed-feature input[type="checkbox"] {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .subscribed-label {
            background: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            margin-left: 0.5rem;
            font-weight: 500;
        }

        .subscribed-label.locked {
            background: #ffc107;
            color: #212529;
            font-weight: 700;
        }

        .feature-lock {
            color: #6c757d;
            font-size: 0.8rem;
            margin-left: 0.3rem;
            opacity: 0.7;
        }

        .feature-checkbox-item.subscribed-feature .feature-icon i:first-child {
            color: #28a745;
        }

        .feature-checkbox-item input[type="checkbox"] {
            margin-right: 0.75rem;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .feature-info {
            flex: 1;
        }

        .feature-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .feature-description {
            font-size: 0.85rem;
            color: #6c757d;
            line-height: 1.3;
        }

        .feature-price {
            font-size: 0.8rem;
            color: #0ea5e9;
            font-weight: 600;
            margin-top: 0.25rem;
            background: rgba(14, 165, 233, 0.1);
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            display: inline-block;
        }

        .feature-price-small {
            font-size: 0.7rem;
            color: #0ea5e9;
            font-weight: 500;
            margin-top: 0.2rem;
        }

        .feature-icon {
            margin-left: auto;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .pricing-preview {
            min-width: 320px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .pricing-comparison-summary {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-label {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .comparison-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .comparison-value.positive {
            color: #dc3545;
        }

        .comparison-value.negative {
            color: #28a745;
        }

        .comparison-value.neutral {
            color: #6c757d;
        }

        .pricing-card {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .pricing-card.current-pricing {
            background: linear-gradient(135deg, #6c757d, #495057);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .pricing-card.updated-pricing {
            background: linear-gradient(135deg, #28a745, #20c997);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .pricing-header {
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pricing-content {
            padding: 1.5rem;
        }

        .price-breakdown-container {
            margin-bottom: 1rem;
        }

        .price-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .price-label {
            opacity: 0.9;
        }

        .price-value {
            font-weight: 600;
        }

        .price-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 1rem 0;
        }

        .price-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-total .price-label {
            font-size: 1rem;
            font-weight: 600;
        }

        .price-amount {
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin: 0;
        }

        .price-breakdown {
            font-size: 0.85rem;
            opacity: 0.9;
            margin: 1rem 0 0.5rem 0;
            text-align: center;
        }

        .price-difference {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        .btn-outline-warning {
            background: transparent;
            border: 2px solid #ffc107;
            color: #ffc107;
        }

        .btn-outline-warning:hover {
            background: #ffc107;
            color: #212529;
        }

        /* Enhanced form hints */
        .form-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.75rem;
        }

        .form-hint i {
            color: #007bff;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 1rem;
            max-width: 1000px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        /* Enhanced modal header styling to match staff.html */
        .modal-header h5 {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .close-modal:hover {
            color: #495057;
        }

        /* Form Section Styles */
        .form-section {
            margin-bottom: 1rem;
        }

        .form-section h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section h4 i {
            color: var(--secondary-color);
        }

        /* Enhanced Form Section Styles to match staff.html */
        .section-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
            background: linear-gradient(135deg, rgba(44, 62, 80, 0.03), rgba(52, 152, 219, 0.03));
            margin: -1rem -1rem 0.75rem -1rem;
            padding: 0.75rem 1rem 0.5rem 1rem;
            border-radius: 8px 8px 0 0;
        }

        .section-title i {
            color: var(--secondary-color);
            font-size: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.15rem;
            font-weight: 600;
            color: #495057;
            font-size: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1.5px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
            transform: translateY(-1px);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 2.5rem;
            font-family: inherit;
        }

        /* Enhanced form group spacing and organization */
        .form-group {
            margin-bottom: 0.75rem;
            position: relative;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        /* Enhanced form section styling */
        .form-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        /* Enhanced grid layouts with better spacing */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .form-grid-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        /* Ensure 4-column layout in Company Profile tab on desktop */
        #profileTab .form-grid.form-grid-four {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
        }

        /* Enhanced text and error styles */
        .form-text {
            font-size: 0.7rem;
            color: #6c757d;
            margin-top: 0.3rem;
            line-height: 1.3;
            font-style: italic;
        }

        .form-error {
            font-size: 0.7rem;
            color: #dc3545;
            margin-top: 0.3rem;
            display: none;
            font-weight: 500;
        }

        /* Enhanced required field styling */
        .required {
            color: #dc3545;
            font-weight: 700;
            margin-left: 2px;
        }

        /* Enhanced checkbox and label styling */
        .form-section label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #495057;
            transition: color 0.2s ease;
        }

        .form-section label:hover {
            color: var(--secondary-color);
        }

        .form-section input[type="checkbox"] {
            margin-right: 0.75rem;
            transform: scale(1.2);
            accent-color: var(--secondary-color);
        }

        /* Enhanced password input styling */
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-container input {
            padding-right: 3rem;
        }

        .password-toggle {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            z-index: 2;
        }

        .password-toggle:hover {
            color: var(--secondary-color);
            background-color: rgba(52, 152, 219, 0.1);
        }

        .password-toggle:focus {
            outline: 2px solid rgba(52, 152, 219, 0.3);
            outline-offset: 2px;
        }

        /* Enhanced select field styling */
        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        select.form-control:focus {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%233498db' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Enhanced field focus and validation states */
        .form-group.focused .form-label {
            color: var(--secondary-color);
            transform: translateY(-1px);
        }

        .form-group.error .form-control {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
        }

        .form-group.success .form-control {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.15);
        }

        .required {
            color: #dc3545;
        }

        /* Enhanced modal body styling */
        .modal-body {
            padding: 1.5rem 2rem;
            background: #fff;
            max-height: 75vh;
            overflow-y: auto;
        }

        /* Custom scrollbar for modal body */
        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Enhanced responsive design */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .form-grid-three {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .form-section {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .section-title {
                font-size: 0.8rem;
                margin: -1rem -1rem 0.5rem -1rem;
                padding: 0.75rem 1rem 0.5rem 1rem;
            }

            .form-label {
                font-size: 0.55rem;
            }

            .form-control {
                padding: 0.6rem 0.75rem;
                font-size: 0.8rem;
            }

            .modal-body {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .form-section {
                padding: 0.75rem;
                border-radius: 8px;
            }

            .section-title {
                font-size: 0.75rem;
                margin: -0.75rem -0.75rem 0.5rem -0.75rem;
                padding: 0.5rem 0.75rem;
            }

            .form-control {
                font-size: 0.85rem;
                padding: 0.7rem 0.75rem;
            }
        }
        .text-muted {
            color: #6c757d !important;
            font-size: 0.7rem;
            margin-top: 0.2rem;
            display: block;
        }

        .form-text {
            font-size: 0.7rem;
            color: #6c757d;
        }

        /* Close button styling to match staff.html */
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Enhanced modal footer styling */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
            margin-top: 1rem;
        }

        /* Password Input Container */
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-container input {
            padding-right: 3rem;
        }

        .password-toggle {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: color 0.2s ease;
        }

        .password-toggle:hover {
            color: #495057;
            background: #f8f9fa;
        }

        .password-toggle:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }

        /* Loading State */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Quota Warning Styles */
        .quota-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #856404;
            font-weight: 500;
        }

        .quota-warning.quota-exceeded {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-color: #dc3545;
            color: #721c24;
        }

        .quota-warning.quota-critical {
            background: linear-gradient(135deg, #ffe6e6 0%, #ffb3b3 100%);
            border-color: #dc3545;
            color: #721c24;
            animation: pulse-warning 2s infinite;
        }

        @keyframes pulse-warning {
            0%, 100% {
                box-shadow: 0 0 5px rgba(220, 53, 69, 0.3);
            }
            50% {
                box-shadow: 0 0 20px rgba(220, 53, 69, 0.6);
            }
        }

        .quota-warning i {
            font-size: 1.2rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .company-management-container {
                padding: 1rem;
            }

            .page-header {
                padding: 1rem;
            }

            .page-title {
                font-size: 1.5rem;
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .company-logo, .company-logo-placeholder {
                width: 50px;
                height: 50px;
            }

            .company-info-bar {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .tab-navigation {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .quota-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .features-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            /* Keep users table font-size uniform; do not override on smaller screens */

            .users-table th,
            .users-table td {
                padding: 0.5rem;
            }

            .logo-upload-container {
                padding: 1.5rem;
            }

            .logo-preview, .logo-placeholder {
                width: 80px;
                height: 80px;
            }

            .logo-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .quota-stats {
                grid-template-columns: 1fr;
            }

            .quota-number {
                font-size: 2rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .company-logo, .company-logo-placeholder {
                width: 40px;
                height: 40px;
            }

            .logo-upload-container {
                padding: 1rem;
            }

            .logo-preview, .logo-placeholder {
                width: 60px;
                height: 60px;
            }

            .logo-upload-text h4 {
                font-size: 1rem;
            }

            .logo-upload-text p {
                font-size: 0.8rem;
            }
        }

        /* User Details Modal Styles */
        .user-details-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 2rem;
            background: #f8f9fa;
            padding: 0.25rem;
            border-radius: 12px;
            overflow-x: auto;
        }

        .user-tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6c757d;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .user-tab-btn:hover {
            background: #e9ecef;
            color: #495057;
        }

        .user-tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        .user-tab-content {
            display: none;
        }

        .user-tab-content.active {
            display: block;
        }

        .user-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .user-info-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .user-info-section h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .user-info-section h4 i {
            color: var(--secondary-color);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .info-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 0.9rem;
            min-width: 100px;
            flex-shrink: 0;
        }

        .info-value {
            font-weight: 500;
            color: #2c3e50;
            text-align: right;
            word-break: break-word;
        }

        .user-quick-actions {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .user-quick-actions h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .user-quick-actions h4 i {
            color: var(--secondary-color);
        }

        .action-buttons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .action-buttons-grid .btn {
            padding: 0.75rem 1rem;
            justify-content: center;
            font-size: 0.9rem;
        }

        /* Status and Role Badges in Modal */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.suspended {
            background: #fff3cd;
            color: #856404;
        }

        /* Activity Tab Styles */
        .activity-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .activity-content h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .activity-content h4 i {
            color: var(--secondary-color);
        }

        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .activity-item:hover {
            background: #f8f9fa;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .activity-icon.login {
            background: #d4edda;
            color: #155724;
        }

        .activity-icon.logout {
            background: #f8d7da;
            color: #721c24;
        }

        .activity-icon.update {
            background: #d1ecf1;
            color: #0c5460;
        }

        .activity-icon.create {
            background: #d4edda;
            color: #155724;
        }

        .activity-details {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .activity-description {
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .activity-timestamp {
            color: #adb5bd;
            font-size: 0.8rem;
        }

        /* Settings Tab Styles */
        .settings-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
        }

        .settings-content h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .settings-content h4 i {
            color: var(--secondary-color);
        }

        .settings-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .settings-section h5 {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            flex: 1;
        }

        .setting-name {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .setting-description {
            color: #6c757d;
            font-size: 0.8rem;
        }

        .setting-control {
            margin-left: 1rem;
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .toggle-switch.active {
            background: var(--secondary-color);
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .toggle-switch.active::before {
            transform: translateX(24px);
        }

        /* Modal Responsive Design */
        @media (max-width: 768px) {
            .user-info-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .action-buttons-grid {
                grid-template-columns: 1fr;
            }

            .user-details-tabs {
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }

            .user-tab-btn {
                font-size: 0.8rem;
                padding: 0.5rem 1rem;
            }

            .modal-content {
                max-width: 1000px !important;
                width: 95%;
                margin: 1rem;
            }
        }

        @media (max-width: 480px) {
            .user-tab-btn {
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }

            .user-info-section,
            .user-quick-actions,
            .activity-content,
            .settings-content {
                padding: 1rem;
            }

            .activity-item {
                padding: 0.75rem;
            }
        }

        /* Menu Visibility System */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Enhanced menu loading states */
        .sidebar.menu-loading .menu-item:not(.menu-visible),
        .sidebar.menu-loading .menu-dropdown:not(.menu-visible),
        .sidebar.menu-loading li[data-feature]:not(.menu-visible),
        .sidebar.menu-loading [data-feature]:not(.menu-visible) {
            opacity: 0.3;
            pointer-events: none;
        }

        /* Allow menu-visible items to show even during loading */
        .sidebar.menu-loading .menu-visible,
        .sidebar.menu-loading li.menu-visible,
        .sidebar.menu-loading [data-feature].menu-visible {
            opacity: 1 !important;
            pointer-events: auto !important;
            display: block !important;
        }

        /* Hide non-visible items during loading */
        .menu-loading [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-loading .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Feature Testing Controls Styles */
        .feature-test-controls button:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .feature-test-controls button:active {
            transform: translateY(0);
        }

        .feature-test-controls button i {
            margin-right: 0.3rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
    <nav class="sidebar menu-loading" id="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
            <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view">
				<a href="#"><i class="fas fa-medkit"></i> Health</a>
				<ul class="submenu">
					<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
					<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
					<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
				<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
				<ul class="submenu">
					<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
					<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
					<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
					<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
					<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
					<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
				</ul>
			</li>
            <!-- Risk Management (separate section) -->
            <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                <ul class="submenu">
                    <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                    <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
				<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
				<ul class="submenu">
                    <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                    <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="environment_view">
				<a href="#"><i class="fas fa-leaf"></i> Environment</a>
				<ul class="submenu">
                    <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
				<a href="#"><i class="fas fa-lock"></i> Security</a>
				<ul class="submenu">
                    <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
				<a href="#"><i class="fas fa-truck"></i> Logistics</a>
				<ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
				<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
				<ul class="submenu">
					<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
				<a href="#"><i class="fas fa-users"></i> HR</a>
				<ul class="submenu">
					<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
					<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
					<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
					<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
					<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
					<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
					<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
					<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                    <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
					<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
					<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
					<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                    <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
				</ul>
			</li>
            <!-- Project Management as section button with submenu -->
            <li class="menu-dropdown" data-feature="project_management_section">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                </ul>
            </li>
            <!-- Inventory Management as section button with submenu -->
            <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                <ul class="submenu">
                    <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                    <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                    <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                    <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                    <li data-feature="inventory_approvals_view" data-requires-permission="inventory_approvals_view"><a href="inventory-approvals.html"><i class="fas fa-check-circle"></i> Approvals</a></li>
                    <li data-feature="inventory_issue_view" data-requires-permission="inventory_issue_view"><a href="inventory-issue.html"><i class="fas fa-shipping-fast"></i> Material Issue</a></li>
                </ul>
            </li>
            <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view">
				<a href="#"><i class="fas fa-cog"></i> Settings</a>
				<ul class="submenu">
                    <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html" class="active">Company Management</a></li>
                    <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
				</ul>
			</li>
		</ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                    <div class="company-branding">
                        <div id="headerLogoPlaceholder" style="display: flex; width: 32px; height: 32px; background: #f8f9fa; border: 2px dashed #ced4da; border-radius: 6px; align-items: center; justify-content: center; color: #6c757d; font-size: 0.8rem;">
                            <i class="fas fa-building"></i>
                        </div>
                        <img id="headerCompanyLogo" alt="Company Logo" />
                        <span id="headerCompanyName"></span>
                    </div>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-empty">
                                <i class="far fa-bell-slash"></i>
                                <div class="notification-empty-title">No notifications</div>
                                <div class="notification-empty-message">You're all caught up</div>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="User Avatar" onerror="this.style.display='none'; document.getElementById('userInitialsFallback').style.display='flex';">
                            <span id="userInitialsFallback" class="avatar-initials" style="display:none;">U</span>
                        </button>
                        <div class="profile-dropdown">
                            <ul></ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="company-management-container">
                <!-- Page Header -->
                <div class="page-header">
                    <div style="display: flex; align-items: center; gap: 0.6rem;">
                        <i class="fas fa-building"></i>
                        <div style="display:flex; flex-direction:column; line-height:1.2;">
                            <span>Company Management</span>
                        </div>
                    </div>
                    <div class="page-actions">
                        <div id="addUserButtonContainer" class="quota-exceeded-tooltip">
                            <button id="addUserButton" class="btn-add-new" onclick="showAddUserModal()" title="Add user">
                                <i class="fas fa-plus"></i>
                            </button>
                            <span id="quotaTooltip" class="tooltip-text" style="display: none;">
                                User quota limit reached. Upgrade your plan to add more users.
                            </span>
                        </div>
                        <small class="page-subtitle" id="headerPlanSummary">0 / 0 Users</small>
                    </div>
                </div>

                <!-- Company Info Bar (moved below header to keep exact header design) -->
                <div class="company-info-bar">
                    <div class="company-status" style="display: none;">
                        <span class="status-badge status-active">Active</span>
                        <span id="companyNameDisplay">Loading...</span>
                    </div>
                    <div class="subscription-info" style="margin-left: auto;">
                        <div class="subscription-plan" id="subscriptionPlan">Enterprise Plan</div>
                        <div class="user-quota" id="userQuota">0 / 0 Users</div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-nav-btn" data-tab="profile">
                        <i class="fas fa-building"></i>
                        Company Profile
                    </button>
                    <button class="tab-nav-btn" data-tab="users">
                        <i class="fas fa-users"></i>
                        User Management
                    </button>
                    <button class="tab-nav-btn active" data-tab="subscription">
                        <i class="fas fa-credit-card"></i>
                        Subscription & Quota
                    </button>
                </div>

                <!-- Company Profile Tab -->
                <div class="tab-content" id="profileTab">
                    <!-- Basic Information -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-info-circle"></i>
                                Basic Information
                            </h3>
                        </div>
                        <div class="card-body">
                            <form id="companyProfileForm">
                                <!-- Brand Upload Row: Logo + HR Stamp side-by-side -->
                                <div class="brand-upload-row" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px;margin-bottom:2rem;align-items:start;">
                                    <!-- Company Logo Section -->
                                    <div class="form-group" id="companyLogoGroup" style="margin: 0;">
                                        <label for="companyLogo">Company Logo</label>
                                        <div class="logo-upload-container" onclick="document.getElementById('logoFileInput').click()">
                                            <img id="logoPreview" class="logo-preview" src="" alt="Logo Preview">
                                            <div id="logoPlaceholder" class="logo-placeholder">
                                                <i class="fas fa-image"></i>
                                            </div>
                                            <div class="logo-upload-text">
                                                <h4>Upload Company Logo</h4>
                                                <p>Click to browse or drag & drop<br>
                                                Supported: JPG, PNG, SVG (Max: 2MB)<br>
                                                Recommended: 400x400px</p>
                                            </div>
                                            <input type="file" id="logoFileInput" class="logo-file-input" accept="image/*" onchange="handleLogoUpload(event)">
                                        </div>
                                        <div class="logo-actions hidden" id="logoActions">
                                            <button type="button" class="btn-upload" onclick="document.getElementById('logoFileInput').click()">
                                                <i class="fas fa-upload"></i> Change Logo
                                            </button>
                                            <button type="button" class="btn-remove-logo" onclick="removeLogo()">
                                                <i class="fas fa-trash"></i> Remove
                                            </button>
                                        </div>
                                        <div class="form-hint">Logo will be displayed in the header and throughout the system</div>
                                        <div class="form-error"></div>
                                    </div>

                                    <!-- HR Stamp Section -->
                                    <div class="form-group" id="hrStampGroup" style="margin: 0;">
                                        <label for="hrStamp">HR Stamp</label>
                                        <div class="logo-upload-container" onclick="document.getElementById('hrStampFileInput').click()">
                                            <img id="hrStampPreview" class="logo-preview" src="" alt="HR Stamp Preview">
                                            <div id="hrStampPlaceholder" class="logo-placeholder">
                                                <i class="fas fa-stamp"></i>
                                            </div>
                                            <div class="logo-upload-text">
                                                <h4>Upload HR Stamp</h4>
                                                <p>Click to browse or drag & drop<br>
                                                Supported: JPG, PNG, SVG (Max: 2MB)<br>
                                                Recommended: 400x400px</p>
                                            </div>
                                            <input type="file" id="hrStampFileInput" class="logo-file-input" accept="image/*" onchange="handleHrStampUpload(event)">
                                        </div>
                                        <div class="logo-actions hidden" id="hrStampActions">
                                            <button type="button" class="btn-upload" onclick="document.getElementById('hrStampFileInput').click()">
                                                <i class="fas fa-upload"></i> Change Stamp
                                            </button>
                                            <button type="button" class="btn-remove-logo" onclick="removeHrStamp()">
                                                <i class="fas fa-trash"></i> Remove
                                            </button>
                                        </div>
                                        <div class="form-hint">HR stamp can be used on documents where applicable</div>
                                        <div class="form-error"></div>
                                    </div>
                                </div>

                                <div class="form-grid form-grid-four">
                                    <div class="form-group">
                                        <label for="companyName" class="required">Company Name</label>
                                        <input type="text" id="companyName" name="companyName" required>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="companyRegistration" class="required">Registration Number</label>
                                        <input type="text" id="companyRegistration" name="companyRegistration" required>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="industry" class="required">Industry</label>
                                        <select id="industry" name="industry" required>
                                            <option value="">Select Industry</option>
                                            <option value="manufacturing">Manufacturing</option>
                                            <option value="construction">Construction</option>
                                            <option value="oil-gas">Oil & Gas</option>
                                            <option value="mining">Mining</option>
                                            <option value="logistics">Logistics</option>
                                            <option value="healthcare">Healthcare</option>
                                            <option value="other">Other</option>
                                        </select>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="companySize" class="required">Company Size</label>
                                        <select id="companySize" name="companySize" required>
                                            <option value="">Select Size</option>
                                            <option value="1-10">1-10 employees</option>
                                            <option value="11-50">11-50 employees</option>
                                            <option value="51-200">51-200 employees</option>
                                            <option value="201-1000">201-1000 employees</option>
                                            <option value="1000+">1000+ employees</option>
                                        </select>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="website">Company Website</label>
                                        <input type="url" id="website" name="website" placeholder="https://www.example.com">
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group col-span-1">
                                        <label for="country" class="required">Country</label>
                                        <select id="country" name="country" required>
                                            <option value="">Select Country</option>
                                            <option value="US">United States</option>
                                            <option value="CA">Canada</option>
                                            <option value="GB">United Kingdom</option>
                                            <option value="AU">Australia</option>
                                            <option value="DE">Germany</option>
                                            <option value="FR">France</option>
                                            <option value="JP">Japan</option>
                                            <option value="OTHER">Other</option>
                                        </select>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group col-span-2">
                                        <label for="address">Company Address</label>
                                        <textarea id="address" name="address" rows="1" placeholder="Enter your complete company address"></textarea>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group col-span-4">
                                        <label for="footer">Footer</label>
                                        <textarea id="footer" name="footer" rows="2" placeholder="Optional footer text for documents and pages"></textarea>
                                        <div class="form-error"></div>
                                    </div>
                                </div>


                                <div class="action-buttons">
                                    <button type="button" class="btn btn-secondary" onclick="resetForm('companyProfileForm')">
                                        <i class="fas fa-undo"></i>
                                        Reset
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Contact & Billing Information -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-address-book"></i>
                                Contact & Billing Information
                            </h3>
                        </div>
                        <div class="card-body">
                            <form id="contactBillingForm">
                                <h4 style="color: #2c3e50; margin-bottom: 1rem;">Primary Contact</h4>
                                <div class="form-grid form-grid-four">
                                    <div class="form-group">
                                        <label for="contactName" class="required">Contact Name</label>
                                        <input type="text" id="contactName" name="contactName" required>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="contactEmail" class="required">Contact Email</label>
                                        <input type="email" id="contactEmail" name="contactEmail" required>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="contactPhone" class="required">Contact Phone</label>
                                        <input type="tel" id="contactPhone" name="contactPhone" required>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="contactTitle">Contact Title</label>
                                        <input type="text" id="contactTitle" name="contactTitle" placeholder="e.g., Manager, Director">
                                        <div class="form-error"></div>
                                    </div>
                                </div>

                                <h4 style="color: #2c3e50; margin: 2rem 0 1rem 0;">Billing Information</h4>
                                <div class="form-grid form-grid-four">
                                    <div class="form-group col-span-2">
                                        <label for="billingAddress" class="required">Billing Address</label>
                                        <textarea id="billingAddress" name="billingAddress" rows="1" required></textarea>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="billingEmail" class="required">Billing Email</label>
                                        <input type="email" id="billingEmail" name="billingEmail" required>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group">
                                        <label for="billingPhone">Billing Phone</label>
                                        <input type="tel" id="billingPhone" name="billingPhone">
                                        <div class="form-error"></div>
                                    </div>
                                </div>

                                <h4 style="color: #2c3e50; margin: 2rem 0 1rem 0;">Domain Settings</h4>
                                <div class="form-grid form-grid-four">
                                    <div class="form-group col-span-2">
                                        <label for="primaryDomain" class="required">Primary Domain</label>
                                        <input type="text" id="primaryDomain" name="primaryDomain" placeholder="company.com" required>
                                        <div class="form-hint">Enter your company's primary email domain (without @)</div>
                                        <div class="form-error"></div>
                                    </div>
                                    <div class="form-group col-span-2">
                                        <label for="additionalDomain">Additional Domains</label>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <input type="text" id="additionalDomain" placeholder="Additional domain (optional)">
                                            <button type="button" class="btn btn-secondary" onclick="addDomain()">
                                                <i class="fas fa-plus"></i>
                                                Add
                                            </button>
                                        </div>
                                        <div id="domainList" class="domain-list"></div>
                                    </div>
                                </div>

                                <div class="action-buttons">
                                    <button type="button" class="btn btn-secondary" onclick="resetForm('contactBillingForm')">
                                        <i class="fas fa-undo"></i>
                                        Reset
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        Save Changes
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Subcontractors -->
                    <div class="card" id="subcontractorsCard">
                        <div class="card-header" style="display:flex;align-items:center;gap:0.75rem;">
                            <h3 class="card-title" style="flex:1;display:flex;align-items:center;gap:0.5rem;">
                                <i class="fas fa-handshake"></i>
                                Subcontractors
                            </h3>
                            <button type="button" class="btn btn-primary" title="Add subcontractor" onclick="window.companyManagement?.openSubcontractorModal()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <table class="users-table" id="subcontractorsTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Registration #</th>
                                        <th>Contact</th>
                                        <th>Address</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="subcontractorsTableBody">
                                    <!-- Subcontractors will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Access Control: Tab Visibility Permissions -->
                    <div class="card" id="accessControlCard" style="margin-top: 1.5rem;">
                        <div class="card-header" style="display:flex;align-items:center;gap:0.75rem;">
                            <h3 class="card-title" style="flex:1;display:flex;align-items:center;gap:0.5rem;">
                                <i class="fas fa-user-shield"></i>
                                Access Control
                            </h3>
                            <button type="button" class="btn btn-primary" title="Add access control" onclick="window.openAccessControlModal()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-wrapper">
                                <table class="users-table" id="accessControlTable">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th style="white-space:nowrap;">Company Profile Tab</th>
                                            <th style="white-space:nowrap;">User Management Tab</th>
                                            <th style="white-space:nowrap;">Subscription & Quota Tab</th>
                                            <th style="white-space:nowrap;">See + Button</th>
                                            <th style="white-space:nowrap;">Create With Account</th>
                                            <th style="white-space:nowrap;">Create Without Account</th>
                                            <th style="white-space:nowrap;">Company Name Visibility</th>
                                            <th style="white-space:nowrap;">Role Visibility</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accessControlTableBody">
                                        <!-- Permissions will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div class="tab-content" id="usersTab">
                    <div class="card">
                        <div class="card-body">

                            <!-- Search users toolbar -->
                            <div id="usersSearchBar" style="display:flex; gap:0.5rem; justify-content:flex-end; align-items:center; margin-bottom:0.75rem; flex-wrap:wrap;">
                                <input type="text" id="userSearchInput" class="form-control" placeholder="Search users (name, email, employee ID, company, role)" style="max-width: 360px;">
                                <button type="button" id="userSearchBtn" class="btn btn-primary" title="Search">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button type="button" id="userSearchClearBtn" class="btn btn-secondary" title="Clear search">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="table-wrapper">
                                <table class="users-table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Email</th>
                                            <th>Company</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Last Login</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <!-- Users will be dynamically loaded -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscription & Quota Tab -->
                <div class="tab-content active" id="subscriptionTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-credit-card"></i>
                                
                            </h3>
                        </div>
                        <div class="card-body">
                            <!-- Quota Management Section -->
                            <div class="quota-management-section">
                                <div class="section-header">
                                </div>
                            <form id="quotaManagementForm" class="quota-form">
                                <div class="quota-input-section">
                                    <div class="input-groups-container">
                                        <div class="input-group">
                                            <label for="userQuotaInput" class="required">
                                                <i class="fas fa-users"></i>
                                                Number of Users
                                            </label>
                                            <div class="input-with-controls">
                                                <button type="button" class="quota-btn quota-decrease" onclick="adjustQuota('users', -1)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" id="userQuotaInput" name="userQuota" min="1" max="10000" value="5">
                                                <button type="button" class="quota-btn quota-increase" onclick="adjustQuota('users', 1)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                            <div class="form-hint">
                                                <i class="fas fa-info-circle"></i>
                                                $25 per user per month. Note: You can only increase user quota, not decrease it.
                                            </div>
                                            <div class="form-error"></div>
                                        </div>

                                        <div class="input-group">
                                            <label class="required">
                                                <i class="fas fa-puzzle-piece"></i>
                                                Platform Features
                                            </label>
                                            <div id="featuresSelectionContainer" class="features-selection-container">
                                                <div id="featuresLoadingMessage" class="features-loading">
                                                    <i class="fas fa-spinner fa-spin"></i>
                                                    Loading features...
                                                </div>
                                                <div id="featuresCheckboxList" class="features-checkbox-list" style="display: none;">
                                                    <!-- Features checkboxes will be populated dynamically -->
                                                </div>
                                            </div>
                                            <div class="form-hint">
                                                <i class="fas fa-info-circle"></i>
                                                Each feature has its own price per user per month. Selected features are shown with a green "Active" status below.
                                            </div>
                                            <div class="form-error"></div>
                                        </div>
                                    </div>

                                    <div class="pricing-preview">
                                        <!-- Current Pricing Section -->
                                        <div class="pricing-card current-pricing">
                                            <div class="pricing-header current">
                                                <i class="fas fa-file-invoice-dollar"></i>
                                                <span>Current Pricing</span>
                                            </div>
                                            <div class="pricing-content">
                                                <div class="price-breakdown-container">
                                                    <div class="price-item">
                                                        <span class="price-label">Base Cost:</span>
                                                        <span class="price-value" id="currentBaseCostDisplay">$0/month</span>
                                                    </div>
                                                    <div class="price-item">
                                                        <span class="price-label">Features Cost:</span>
                                                        <span class="price-value" id="currentFeaturesCostDisplay">$0/month</span>
                                                    </div>
                                                    <div class="price-divider"></div>
                                                    <div class="price-total">
                                                        <span class="price-label">Current Total:</span>
                                                        <div class="price-amount current" id="currentMonthlyFee">$0/month</div>
                                                    </div>
                                                </div>
                                                <div class="price-breakdown current" id="currentPriceBreakdownText">Loading current pricing...</div>
                                            </div>
                                        </div>

                                        <!-- Updated Pricing Section -->
                                        <div class="pricing-card updated-pricing">
                                            <div class="pricing-header updated">
                                                <i class="fas fa-calculator"></i>
                                                <span>Updated Pricing</span>
                                            </div>
                                            <div class="pricing-content">
                                                <div class="price-breakdown-container">
                                                    <div class="price-item">
                                                        <span class="price-label">Base Cost:</span>
                                                        <span class="price-value" id="baseCostDisplay">$0/month</span>
                                                    </div>
                                                    <div class="price-item">
                                                        <span class="price-label">Features Cost:</span>
                                                        <span class="price-value" id="featuresCostDisplay">$0/month</span>
                                                    </div>
                                                    <div class="price-divider"></div>
                                                    <div class="price-total">
                                                        <span class="price-label">New Total:</span>
                                                        <div class="price-amount updated" id="newMonthlyFee">$0/month</div>
                                                    </div>
                                                </div>
                                                <div class="price-breakdown" id="priceBreakdownText">0 users × $25 + 0 features × $5 × 0 users</div>
                                                <div class="price-difference" id="priceDifference" style="display: none;">
                                                    <i class="fas fa-arrow-up"></i>
                                                    <span>+$0/month from current</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Price Comparison Summary -->
                                        <div class="pricing-comparison-summary">
                                            <div class="comparison-item">
                                                <div class="comparison-label">Monthly Change:</div>
                                                <div class="comparison-value" id="monthlyChangeSummary">$0/month</div>
                                            </div>
                                            <div class="comparison-item">
                                                <div class="comparison-label">Annual Impact:</div>
                                                <div class="comparison-value" id="annualChangeSummary">$0/year</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="button" id="saveSubscriptionBtn" class="btn btn-success" onclick="handlePayNowClick()">
                                        <i class="fas fa-credit-card"></i>
                                        Pay Now
                                    </button>
                                    <button type="button" id="payBalanceBtn" class="btn btn-success" onclick="showPaymentModal()" style="display: none;">
                                        <i class="fas fa-credit-card"></i>
                                        Pay Balance: <span id="payBalanceAmount">$0</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history"></i>
                                Billing History
                            </h3>
                        </div>
                        <div class="card-body">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Invoice</th>
                                    </tr>
                                </thead>
                                <tbody id="billingHistoryBody">
                                    <!-- Billing history will be dynamically loaded -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-user-plus"></i> Add New User</h5>
                <button class="close-modal" onclick="closeModal('addUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">

                    <!-- Account Settings -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-cog"></i> Account Settings
                        </div>
                        <!-- User Account Type Selector -->
                        <div class="form-group">
                            <label class="form-label">User Type</label>
                            <div class="inline-options" id="userAccountTypeGroup" style="display:flex; gap: 1rem; align-items:center; flex-wrap: wrap;">
                                <label style="display:flex; align-items:center; gap:.35rem;">
                                    <input type="radio" name="userAccountType" value="with-account" checked>
                                    With Account (can sign in)
                                </label>
                            </div>
                            <small class="form-text text-muted">User will have a sign-in account. Email and password are required for login.</small>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="userRole" class="form-label">Role <span class="required">*</span></label>
                                <select class="form-control" id="userRole" name="userRole" required>
                                    <option value="">Select Role</option>
                                    <!-- Roles will be populated dynamically from company-scoped roles -->
                                </select>
                                <div class="form-error"></div>
                                <small class="form-text text-muted">Determines access level and permissions based on company-defined roles</small>
                            </div>

                            <div class="form-group">
                                <label for="userStatus" class="form-label">Account Status</label>
                                <select class="form-control" id="userStatus" name="userStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                                <div class="form-error"></div>
                                <small class="form-text text-muted">Controls whether the user can access the system</small>
                            </div>
                        </div>

                        <div class="form-group" id="userPasswordGroup">
                            <label for="userPassword" class="form-label">Initial Password <span class="required" id="userPasswordRequiredStar">*</span></label>
                            <div class="password-input-container">
                                <input type="password" class="form-control" id="userPassword" name="userPassword" placeholder="Enter initial password">
                                <button type="button" class="password-toggle" data-target="userPassword" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">Minimum 6 characters. User will be prompted to change on first login</small>
                            <div class="form-error"></div>
                        </div>

                    </div>

                    <!-- Personal Information -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-user"></i> Personal Information
                        </div>
                        <div class="form-grid-three">
                            <div class="form-group">
                                <label for="userFirstName" class="form-label">First Name <span class="required">*</span></label>
                                <input type="text" class="form-control" id="userFirstName" name="userFirstName" required placeholder="Enter first name">
                                <div class="form-error"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="userLastName" class="form-label">Last Name <span class="required">*</span></label>
                                <input type="text" class="form-control" id="userLastName" name="userLastName" required placeholder="Enter last name">
                                <div class="form-error"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="userJobTitle" class="form-label">Job Title</label>
                                <select class="form-control" id="userJobTitle" name="userJobTitle">
                                    <option value="">Select Job Title</option>
                                    <!-- Will be populated dynamically from company field options -->
                                </select>
                                <div class="form-error"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="userDepartment" class="form-label">Department</label>
                                <select class="form-control" id="userDepartment" name="userDepartment">
                                    <option value="">Select Department</option>
                                    <!-- Will be populated dynamically from company field options -->
                                </select>
                                <div class="form-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="userCompanyAffiliation" class="form-label">Company</label>
                                <select class="form-control" id="userCompanyAffiliation" name="userCompanyAffiliation">
                                    <option value="">Select Company</option>
                                    <!-- Populated with main company and subcontractors (names only) -->
                                </select>
                                <small class="form-text text-muted">Choose the employing entity (main company or subcontractor)</small>
                                <div class="form-error"></div>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group" id="userEmailGroup">
                                <label for="userEmail" class="form-label">Email Address <span class="required" id="userEmailRequiredStar">*</span></label>
                                <input type="email" class="form-control" id="userEmail" name="userEmail" placeholder="Enter email address">
                                <div class="form-error"></div>
                                <small class="form-text text-muted" id="userEmailHelp">This will be used for login</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="userEmployeeId" class="form-label">Employee ID</label>
                                <input type="text" class="form-control" id="userEmployeeId" name="userEmployeeId" placeholder="Enter employee ID">
                                <div class="form-error"></div>
                                <small class="form-text text-muted">Unique identifier for this employee</small>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="userCountryCode" class="form-label">Country Code</label>
                                <select class="form-control" id="userCountryCode" name="userCountryCode">
                                    <option value="">Select</option>
                                    <option value="+1">+1 (US/CA)</option>
                                    <option value="+44">+44 (UK)</option>
                                    <option value="+61">+61 (AU)</option>
                                    <option value="+64">+64 (NZ)</option>
                                    <option value="+65">+65 (SG)</option>
                                    <option value="+60">+60 (MY)</option>
                                    <option value="+62">+62 (ID)</option>
                                    <option value="+63">+63 (PH)</option>
                                    <option value="+66">+66 (TH)</option>
                                    <option value="+81">+81 (JP)</option>
                                    <option value="+82">+82 (KR)</option>
                                    <option value="+84">+84 (VN)</option>
                                    <option value="+86">+86 (CN)</option>
                                    <option value="+91">+91 (IN)</option>
                                    <option value="+92">+92 (PK)</option>
                                    <option value="+95">+95 (MM)</option>
                                    <option value="+673">+673 (BN)</option>
                                    <option value="+852">+852 (HK)</option>
                                    <option value="+853">+853 (MO)</option>
                                    <option value="+886">+886 (TW)</option>
                                </select>
                                <div class="form-error"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="userPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="userPhone" name="userPhone" pattern="[0-9\-\s]+" placeholder="Enter phone number">
                                <small class="form-text text-muted">Enter phone number without country code</small>
                                <div class="form-error"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="userAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="userAddress" name="userAddress" rows="3" placeholder="Enter full address"></textarea>
                            <div class="form-error"></div>
                        </div>

                        <div class="form-group">
                            <label for="userLineManager" class="form-label">Line Manager</label>
                            <select class="form-control" id="userLineManager" name="userLineManager">
                                <option value="">Select Line Manager</option>
                                <!-- Will be populated dynamically from existing users -->
                            </select>
                            <div class="form-error"></div>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" form="addUserForm" class="btn btn-primary">
                    <span class="loading" style="display: none;">
                        <div class="spinner"></div>
                        Creating...
                    </span>
                    <span class="normal-text">
                        <i class="fas fa-save"></i> Add User
                    </span>
                </button>
            </div>
        </div>
    </div>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div id="userDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="user-avatar" id="modalUserAvatar" style="margin: 0;">
                        <!-- User initials will be set dynamically -->
                    </div>
                    <div>
                        <h3 class="modal-title" id="modalUserName">User Details</h3>
                        <p style="margin: 0; color: #6c757d; font-size: 0.9rem;" id="modalUserEmail"></p>
                    </div>
                </div>
                <button class="close-modal" onclick="closeModal('userDetailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- User Details Tabs -->
                <div class="user-details-tabs">
                    <button class="user-tab-btn active" onclick="switchUserTab('overview')">
                        <i class="fas fa-user"></i> Overview
                    </button>
                    <button class="user-tab-btn" onclick="switchUserTab('activity')">
                        <i class="fas fa-history"></i> Activity
                    </button>
                    <button class="user-tab-btn" onclick="switchUserTab('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>

                <!-- Overview Tab -->
                <div class="user-tab-content active" id="overviewTab">
                    <div class="user-info-grid">
                        <div class="user-info-section">
                            <h4><i class="fas fa-info-circle"></i> Basic Information</h4>
                            <div class="info-row">
                                <span class="info-label">Full Name:</span>
                                <span class="info-value" id="detailFullName">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Email:</span>
                                <span class="info-value" id="detailEmail">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Employee ID:</span>
                                <span class="info-value" id="detailEmployeeId">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Department:</span>
                                <span class="info-value" id="detailDepartment">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Job Title:</span>
                                <span class="info-value" id="detailJobTitle">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone:</span>
                                <span class="info-value" id="detailPhone">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Country Code:</span>
                                <span class="info-value" id="detailCountryCode">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Address:</span>
                                <span class="info-value" id="detailAddress">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Line Manager:</span>
                                <span class="info-value" id="detailLineManager">-</span>
                            </div>
                        </div>

                        <div class="user-info-section">
                            <h4><i class="fas fa-shield-alt"></i> Account Status</h4>
                            <div class="info-row">
                                <span class="info-label">Status:</span>
                                <span class="info-value">
                                    <span class="status-badge" id="detailStatus">Active</span>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Role:</span>
                                <span class="info-value">
                                    <span class="role-badge" id="detailRole">User</span>
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Created:</span>
                                <span class="info-value" id="detailCreatedDate">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Last Login:</span>
                                <span class="info-value" id="detailLastLogin">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="user-quick-actions">
                        <h4><i class="fas fa-bolt"></i> Quick Actions</h4>
                        <div class="action-buttons-grid">
                            <button class="btn btn-edit" onclick="editUser()">
                                <i class="fas fa-edit"></i> Edit User
                            </button>
                            <button class="btn btn-warning" onclick="resetPassword()">
                                <i class="fas fa-key"></i> Reset Password
                            </button>
                            <button class="btn btn-secondary" onclick="toggleUserStatus()">
                                <i class="fas fa-toggle-on"></i> <span id="toggleStatusText">Deactivate</span>
                            </button>
                            <button class="btn btn-danger" onclick="deleteUser()">
                                <i class="fas fa-trash"></i> Delete User
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div class="user-tab-content" id="activityTab">
                    <div class="activity-content">
                        <h4><i class="fas fa-history"></i> Recent Activity</h4>
                        <div id="userActivityLog">
                            <!-- Activity log will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="user-tab-content" id="settingsTab">
                    <div class="settings-content">
                        <h4><i class="fas fa-cog"></i> User Settings</h4>
                        <div id="userSettingsForm">
                            <!-- User settings form will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User Details</h3>
                <button class="close-modal" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm" autocomplete="off" onsubmit="return false;">
                    

                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-user"></i> Personal Information
                        </div>
                        <div class="form-grid-three">
                            <div class="form-group">
                                <label for="editUserFirstName" class="form-label">First Name <span class="required">*</span></label>
                                <input type="text" class="form-control" id="editUserFirstName" name="editUserFirstName" required placeholder="Enter first name">
                                <div class="form-error"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editUserLastName" class="form-label">Last Name <span class="required">*</span></label>
                                <input type="text" class="form-control" id="editUserLastName" name="editUserLastName" required placeholder="Enter last name">
                                <div class="form-error"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editUserJobTitle" class="form-label">Job Title</label>
                                <select class="form-control" id="editUserJobTitle" name="editUserJobTitle">
                                    <option value="">Select Job Title</option>
                                    <!-- Will be populated dynamically from company field options -->
                                </select>
                                <div class="form-error"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editUserDepartment" class="form-label">Department</label>
                                <select class="form-control" id="editUserDepartment" name="editUserDepartment">
                                    <option value="">Select Department</option>
                                    <!-- Will be populated dynamically from company field options -->
                                </select>
                                <div class="form-error"></div>
                            </div>

                            <div class="form-group">
                                <label for="editUserCompanyAffiliation" class="form-label">Company</label>
                                <select class="form-control" id="editUserCompanyAffiliation" name="editUserCompanyAffiliation">
                                    <option value="">Select Company</option>
                                    <!-- Populated with main company and subcontractors (names only) -->
                                </select>
                                <small class="form-text text-muted">Choose the employing entity (main company or subcontractor)</small>
                                <div class="form-error"></div>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group" id="editUserEmailGroup">
                                <label for="editUserEmail" class="form-label">Email Address <span class="required">*</span></label>
                                <input type="email" class="form-control" id="editUserEmail" name="editUserEmail" required placeholder="Enter email address">
                                <div class="form-error"></div>
                                <small class="form-text text-muted">This will be used for login</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="editUserEmployeeId" class="form-label">Employee ID</label>
                                <input type="text" class="form-control" id="editUserEmployeeId" name="editUserEmployeeId" placeholder="Enter employee ID">
                                <div class="form-error"></div>
                                <small class="form-text text-muted">Unique identifier for this employee</small>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editUserCountryCode" class="form-label">Country Code</label>
                                <select class="form-control" id="editUserCountryCode" name="editUserCountryCode">
                                    <option value="">Select</option>
                                    <option value="+1">+1 (US/CA)</option>
                                    <option value="+44">+44 (UK)</option>
                                    <option value="+61">+61 (AU)</option>
                                    <option value="+64">+64 (NZ)</option>
                                    <option value="+65">+65 (SG)</option>
                                    <option value="+60">+60 (MY)</option>
                                    <option value="+62">+62 (ID)</option>
                                    <option value="+63">+63 (PH)</option>
                                    <option value="+66">+66 (TH)</option>
                                    <option value="+81">+81 (JP)</option>
                                    <option value="+82">+82 (KR)</option>
                                    <option value="+84">+84 (VN)</option>
                                    <option value="+86">+86 (CN)</option>
                                    <option value="+91">+91 (IN)</option>
                                    <option value="+92">+92 (PK)</option>
                                    <option value="+95">+95 (MM)</option>
                                    <option value="+673">+673 (BN)</option>
                                    <option value="+852">+852 (HK)</option>
                                    <option value="+853">+853 (MO)</option>
                                    <option value="+886">+886 (TW)</option>
                                </select>
                                <div class="form-error"></div>
                            </div>
                            
                            <div class="form-group">
                                <label for="editUserPhone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="editUserPhone" name="editUserPhone" pattern="[0-9\-\s]+" placeholder="Enter phone number">
                                <small class="form-text text-muted">Enter phone number without country code</small>
                                <div class="form-error"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editUserAddress" class="form-label">Address</label>
                            <textarea class="form-control" id="editUserAddress" name="editUserAddress" rows="3" placeholder="Enter full address"></textarea>
                            <div class="form-error"></div>
                        </div>

                        <div class="form-group">
                            <label for="editUserLineManager" class="form-label">Line Manager</label>
                            <select class="form-control" id="editUserLineManager" name="editUserLineManager">
                                <option value="">Select Line Manager</option>
                                <!-- Will be populated dynamically from existing users -->
                            </select>
                            <div class="form-error"></div>
                        </div>
                    </div>

                    <!-- Convert to sign-in account section (visible for reporting-only users) -->
                    <div class="form-section" id="convertAccountSection" style="display:none;">
                        <div class="section-title">
                            <i class="fas fa-user-check"></i> Convert to sign-in account
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <label class="form-label" style="display:flex; align-items:center; gap:0.5rem;">
                                <input type="checkbox" id="convertToWithAccount">
                                Enable sign-in for this user now
                            </label>
                            <small class="form-text text-muted">This will create a login for the user and preserve their existing UID and data.</small>
                        </div>
                        <div id="convertFields" class="form-grid" style="display:none; margin-top:0.5rem;">
                            <div class="form-group">
                                <label for="convertEmail" class="form-label">Login Email <span class="required" id="convertEmailRequiredStar" style="visibility:hidden;">*</span></label>
                                <input type="email" class="form-control" id="convertEmail" placeholder="Enter login email">
                                <div class="form-error" id="convertEmailError" style="display:none;"></div>
                                <small class="form-text text-muted">Used for authentication. Must be unique.</small>
                            </div>
                            <div class="form-group">
                                <label for="convertPassword" class="form-label">Password <span class="required" id="convertPasswordRequiredStar" style="visibility:hidden;">*</span></label>
                                <input type="password" class="form-control" id="convertPassword" placeholder="Set a temporary password (min 6 characters)">
                                <div class="form-error" id="convertPasswordError" style="display:none;"></div>
                            </div>
                            <div class="form-group">
                                <label for="convertPasswordConfirm" class="form-label">Confirm Password</label>
                                <input type="password" class="form-control" id="convertPasswordConfirm" placeholder="Re-enter password">
                                <div class="form-error" id="convertPasswordConfirmError" style="display:none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Settings -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-cog"></i> Account Settings
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="editUserRole" class="form-label">Role <span class="required">*</span></label>
                                <select class="form-control" id="editUserRole" name="editUserRole" required>
                                    <option value="">Select Role</option>
                                    <!-- Roles will be populated dynamically from company-scoped roles -->
                                </select>
                                <div class="form-error"></div>
                                <small class="form-text text-muted">Determines access level and permissions based on company-defined roles</small>
                            </div>

                            <div class="form-group">
                                <label for="editUserStatus" class="form-label">Account Status</label>
                                <select class="form-control" id="editUserStatus" name="editUserStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                                <div class="form-error"></div>
                                <small class="form-text text-muted">Controls whether the user can access the system</small>
                            </div>
                        </div>

                    </div>

                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">
                            <i class="fas fa-times"></i>
                            Cancel
                        </button>
                        <button type="button" class="btn btn-danger" onclick="window.companyManagement.deleteUserFromModal()">
                            <i class="fas fa-trash"></i>
                            Delete
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveUserChanges()">
                            <span class="loading" style="display: none;">
                                <div class="spinner"></div>
                                Saving...
                            </span>
                            <span class="normal-text">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Menu Visibility Management Script -->
    <script>
        // Reset all menu items to hidden
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
        }

        // Emergency fallback - strict authorization (show nothing by default)
        function showBasicMenu() {
            console.log('🔧 Emergency fallback: Strict authorization - no default items shown');
            resetMenuVisibility();
            // Do not show any items by default - strict feature authorization only
            
            // Remove loading state from sidebar to ensure CSS rules apply correctly
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
        }

        // Feature-based authorization system that takes priority over role permissions
        async function updateMenuWithFeatureAuthorization() {
            console.log('🎯 Starting feature-based menu authorization for companymanagement.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('👤 Using Firebase auth - will search for company');
                } else {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log('🔍 Searching for user company...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                // Apply feature-based authorization
                await applyFeatureBasedMenuVisibility(companyId);
                
            } catch (error) {
                console.error('❌ Error in feature-based menu authorization:', error);
                resetMenuVisibility();
                // Ensure sidebar is not stuck in loading state
                showSidebarAfterAuth();
            }
        }

        // Apply feature-based menu visibility
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log('⚠️ No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('❌ Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('🏢 Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('⚠️ Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`� Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`⚠️ Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('� All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log('🎯 Authorized features for companymanagement.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`🎯 Feature-based menu authorization completed for companymanagement.html - ${visibleCount} items visible`);
                
                // Apply role-based filtering after feature authorization
                try {
                    console.log('🔐 Applying role-based filtering to visible menu items...');
                    
                    // Get current user's role and permissions
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    if (currentUser && currentUser.role && currentUser.role.permissions) {
                        filterMenuByPermissions(currentUser.role.permissions);
                    } else {
                        console.warn('⚠️ No role permissions found, skipping role-based filtering');
                    }
                } catch (roleError) {
                    console.error('❌ Error applying role-based filtering:', roleError);
                }
                
                // Show sidebar after authorization completes
                showSidebarAfterAuth();
                
            } catch (error) {
                console.error('❌ Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
            }
        }

        // Make updateMenuWithFeatureAuthorization available globally
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

        // Enhanced initialization - use feature-based authorization by default
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize role-based menu filtering
            initializeMenuAuthorization();
            
            // Safety timeout - if menu is still loading after 10 seconds, force show all items
            setTimeout(() => {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar && sidebar.classList.contains('menu-loading')) {
                    console.warn('⚠️ Menu authorization taking too long - forcing emergency fallback');
                    emergencyShowAllMenuItems();
                }
            }, 10000);
        });

        // Legacy support - map old function name to new implementation
        window.updateMenuVisibilityForCompanyManagement = updateMenuWithFeatureAuthorization;
        
        // Feature-based Menu Visibility System (takes priority over role-based permissions)
        
        /**
         * Update sidebar menu visibility based on platform features' authorized pages
         * This system takes priority over role-based permissions
         */
        async function updateMenuWithFeatureAuthorization() {
            console.log('🎯 Loading feature-based menu authorization...');
            
            try {
                // Get platform features from Firebase
                const featuresSnapshot = await db.ref('/platformFeatures').once('value');
                const featuresData = featuresSnapshot.val();
                
                if (!featuresData) {
                    console.log('⚠️ No platform features found, falling back to role-based permissions');
                    return false; // Indicates fallback to role-based system
                }
                
                // Get company ID using the same method as updateMenuVisibilityForCompanyManagement
                let currentUser = null;
                let companyId = null;
                
                // Get authenticated user from centralized system
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using AuthManager - CompanyId:', companyId);
                } else if (window.companyManagement && window.companyManagement.currentUser) {
                    currentUser = window.companyManagement.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using CompanyManagement - CompanyId:', companyId);
                } else if (auth.currentUser) {
                    currentUser = auth.currentUser;
                    console.log('👤 Using Firebase auth - will search for company');
                }
                
                // If we don't have company ID, try to find it by searching companies
                if (!companyId && currentUser) {
                    console.log('🔍 Company ID not available, searching for user in companies...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        // Search through all companies for the current user
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId}`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.log('⚠️ No company ID found, falling back to role-based permissions');
                    return false;
                }
                
                console.log(`🏢 Using company ID: ${companyId}`);
                
                const companySnapshot = await db.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                const subscribedFeatureIds = companyData?.selectedFeatures || [];
                
                console.log('🔍 Company subscribed features:', subscribedFeatureIds);
                
                // Collect all authorized pages from active subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        authorizedPages.push(...feature.authorizedPages);
                        console.log(`✅ Added authorized pages from feature: ${feature.name}`, feature.authorizedPages);
                    }
                });
                
                console.log('📋 All authorized pages from subscribed features:', authorizedPages);
                
                // Apply feature-based menu visibility
                applyFeatureBasedMenuVisibility(authorizedPages);
                
                return true; // Indicates feature-based system was applied
                
            } catch (error) {
                console.error('❌ Error loading feature-based menu authorization:', error);
                return false; // Fallback to role-based system
            }
        }
        
        /**
         * Apply menu visibility based on feature authorized pages
         */
        function applyFeatureBasedMenuVisibility(authorizedPages) {
            console.log('🎯 Applying feature-based menu visibility...');
            
            // Reset all menu items to hidden first
            resetMenuVisibility();
            
            // Create a set of authorized feature data attributes for quick lookup
            const authorizedFeatures = new Set();
            authorizedPages.forEach(pageInfo => {
                if (pageInfo.feature) {
                    authorizedFeatures.add(pageInfo.feature);
                }
            });
            
            // Strict authorization - only show features from platform subscriptions
            // No automatic inclusion of "always visible" features for security compliance
            
            console.log('🔐 Authorized features from subscribed platform features:', Array.from(authorizedFeatures));
            
            // Get all menu items in the sidebar
            const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
            let visibleCount = 0;
            
            // Update visibility for each menu item
            allMenuItems.forEach(menuItem => {
                const featureAttribute = menuItem.getAttribute('data-feature');
                const isAuthorized = authorizedFeatures.has(featureAttribute);
                const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                
                // Skip dropdown containers initially - they will be handled later
                if (isDropdownContainer) {
                    return;
                }
                
                if (isAuthorized) {
                    // Show the menu item
                    menuItem.classList.add('menu-visible');
                    visibleCount++;
                    console.log(`✅ Showing menu item: ${featureAttribute} (authorized by platform features)`);
                } else {
                    // Hide the menu item
                    menuItem.classList.remove('menu-visible');
                    console.log(`❌ Hiding menu item: ${featureAttribute} (not authorized by platform features)`);
                }
            });
            
            // Handle dropdown menus - show dropdown if any children are visible
            const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
            dropdownMenus.forEach(dropdown => {
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                let hasVisibleChildren = false;
                
                submenuItems.forEach(submenuItem => {
                    if (submenuItem.classList.contains('menu-visible')) {
                        hasVisibleChildren = true;
                    }
                });
                
                if (hasVisibleChildren) {
                    dropdown.classList.add('menu-visible');
                    console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children)`);
                } else {
                    dropdown.classList.remove('menu-visible');
                    console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children)`);
                }
            });
            
            console.log(`🎯 Feature-based menu visibility applied - ${visibleCount} items visible`);

            // Immediately apply role-based filtering to feature-authorized items
            try {
                console.log('🔐 Applying role-based filtering after feature checks...');
                const currentUser = (window.authManager && window.authManager.currentUser)
                    ? window.authManager.currentUser
                    : null;
                let permissions = null;

                if (currentUser && currentUser.role && currentUser.role.permissions) {
                    permissions = currentUser.role.permissions;
                } else {
                    // Fallback to localStorage (as used elsewhere in the app)
                    try {
                        const stored = JSON.parse(localStorage.getItem('currentUser') || '{}');
                        permissions = stored?.role?.permissions || null;
                    } catch (_) {
                        permissions = null;
                    }
                }

                if (permissions && Object.keys(permissions).length > 0) {
                    filterMenuByPermissions(permissions);
                } else {
                    console.warn('⚠️ No role permissions available; hiding items requiring permissions');
                    hideItemsRequiringPermissions();
                }
            } catch (e) {
                console.error('❌ Error during role-based filtering after feature checks:', e);
                hideItemsRequiringPermissions();
            }

            // Ensure sidebar is out of loading state
            showSidebarAfterAuth();
        }
        
    /**
     * Enhanced menu update function that prioritizes feature-based authorization
     * and then filters by role-based permissions
     */
    // No-op status updater (testing/status badge UI removed)
    function updateMenuSystemStatus(_) {}
        async function updateMenuWithPrioritySystem(permissions) {
            console.log('🎯 Starting priority-based menu update system...');
            console.log('📋 Step 1: Apply feature-based authorization first');
            console.log('📋 Step 2: Filter feature-authorized items by role permissions');
            updateMenuSystemStatus('Priority System');
            
            try {
                // STEP 1: Apply feature-based authorization to get the base set of allowed menu items
                const featureBasedApplied = await applyFeatureBasedAuthorizationForPriority();
                
                if (!featureBasedApplied) {
                    console.log('⚠️ Feature-based authorization failed, falling back to role-based permissions only');
                    updateMenuSystemStatus('Role Permissions');
                    filterMenuByPermissions(permissions);
                    return;
                }
                
                console.log('✅ Feature-based authorization applied successfully');
                
                // STEP 2: Now filter the feature-authorized items by role permissions
                console.log('🔧 Step 2: Filtering feature-authorized items by role permissions...');
                
                if (!permissions || Object.keys(permissions).length === 0) {
                    console.log('⚠️ No role permissions available - keeping only feature-authorized items');
                    // Keep the feature-based authorization as-is
                    document.querySelector('.sidebar')?.classList.remove('menu-loading');
                    return;
                }
                
                // Get all currently visible menu items (those authorized by features)
                const featureAuthorizedItems = document.querySelectorAll('[data-feature].menu-visible');
                console.log(`📋 Found ${featureAuthorizedItems.length} feature-authorized menu items to check against role permissions`);
                
                let roleFilteredCount = 0;
                
                // Filter feature-authorized items by role permissions
                featureAuthorizedItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    const isDropdownContainer = item.classList.contains('menu-dropdown');
                    
                    // Skip dropdown containers - they will be handled separately
                    if (isDropdownContainer) {
                        return;
                    }
                    
                    console.log(`🔍 Checking feature-authorized item: ${feature} (requires: ${requiresPermission})`);
                    
                    // If item doesn't require permission, keep it visible (it's already feature-authorized)
                    if (!requiresPermission) {
                        console.log(`✅ Keeping item ${feature} (no permission required, feature-authorized)`);
                        roleFilteredCount++;
                        return;
                    }
                    
                    // Check if user has the required permission
                    const permissionKey = requiresPermission;
                    if (permissionKey && permissions[permissionKey]) {
                        const hasViewPermission = permissions[permissionKey].view === true || permissions[permissionKey] === true;
                        
                        if (hasViewPermission) {
                            console.log(`✅ Keeping item ${feature} (feature-authorized + role-permitted)`);
                            roleFilteredCount++;
                        } else {
                            console.log(`❌ Hiding item ${feature} (feature-authorized but no role permission)`);
                            item.classList.remove('menu-visible');
                        }
                    } else {
                        console.log(`❌ Hiding item ${feature} (feature-authorized but permission ${permissionKey} not found)`);
                        item.classList.remove('menu-visible');
                    }
                });
                
                // Handle dropdown menus - show only if they have visible children after role filtering
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    const hasVisibleChildren = visibleSubmenuItems.length > 0;
                    
                    console.log(`🔍 Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
                    
                    if (hasVisibleChildren) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children after priority filtering)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown ${dropdownFeature} (no visible children after priority filtering)`);
                    }
                });
                
                console.log(`🎯 Priority system completed: Feature-authorized items filtered by role permissions`);
                console.log(`📊 Final result: ${roleFilteredCount} items visible after priority filtering`);
                
                // Remove loading state from sidebar
                document.querySelector('.sidebar')?.classList.remove('menu-loading');
                
            } catch (error) {
                console.error('❌ Error in priority system:', error);
                console.log('⚠️ Falling back to role-based permissions only');
                updateMenuSystemStatus('Role Permissions');
                filterMenuByPermissions(permissions);
            }
        }
        
        /**
         * Apply feature-based authorization specifically for the priority system
         * Returns true if successful, false if should fall back to role-based
         */
        async function applyFeatureBasedAuthorizationForPriority() {
            console.log('🎯 Applying feature-based authorization for priority system...');
            
            try {
                // Get platform features from Firebase
                const featuresSnapshot = await db.ref('/platformFeatures').once('value');
                const featuresData = featuresSnapshot.val();
                
                if (!featuresData) {
                    console.log('⚠️ No platform features found');
                    return false;
                }
                
                // Get company ID using the same method as other functions
                let currentUser = null;
                let companyId = null;
                
                // Get authenticated user from centralized system
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using AuthManager - CompanyId:', companyId);
                } else if (window.companyManagement && window.companyManagement.currentUser) {
                    currentUser = window.companyManagement.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using CompanyManagement - CompanyId:', companyId);
                } else if (auth.currentUser) {
                    currentUser = auth.currentUser;
                    console.log('👤 Using Firebase auth - will search for company');
                }
                
                // If we don't have company ID, try to find it by searching companies
                if (!companyId && currentUser) {
                    console.log('🔍 Company ID not available, searching for user in companies...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.log('⚠️ No company ID found');
                    return false;
                }
                
                console.log(`🏢 Using company ID for priority system: ${companyId}`);
                
                const companySnapshot = await db.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                const subscribedFeatureIds = companyData?.selectedFeatures || [];
                
                console.log('🔍 Company subscribed features for priority system:', subscribedFeatureIds);
                
                // Collect all authorized pages from active subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    }
                });
                
                console.log('📋 All authorized pages from subscribed features for priority system:', authorizedPages);
                
                // Apply feature-based menu visibility (this will be the base set for role filtering)
                applyFeatureBasedMenuVisibility(authorizedPages);
                
                return true; // Indicates feature-based system was applied successfully
                
            } catch (error) {
                console.error('❌ Error applying feature-based authorization for priority system:', error);
                return false;
            }
        }
        
    // (Testing helper removed)
        
        // Separate function to update menu with permissions
        function updateMenuWithPermissions(permissions) {
            console.log('🎯 Updating menu with permissions...');
            console.log('🎯 Permissions object:', permissions);
            console.log('🎯 Available permission keys:', Object.keys(permissions || {}));
            
            // Reset menu visibility first
            resetMenuVisibility();
            
            if (!permissions) {
                console.log('⚠️ No permissions object provided');
                resetMenuVisibility();
                return;
            }
            
            // Update menu visibility based on permissions
            const menuItems = document.querySelectorAll('[data-feature]');
            console.log(`🎯 Found ${menuItems.length} menu items to check`);
            let visibleCount = 0;
            
            menuItems.forEach(item => {
                const feature = item.getAttribute('data-feature');
                const requiresPermission = item.getAttribute('data-requires-permission');
                const isSubmenuItem = item.closest('.submenu') !== null;
                const isDropdownContainer = item.classList.contains('menu-dropdown');
                const parentDropdown = item.closest('.menu-dropdown');
                const parentFeature = parentDropdown ? parentDropdown.getAttribute('data-feature') : 'none';
                
                console.log(`🔍 Checking menu item: ${feature} (requires: ${requiresPermission}) [Submenu: ${isSubmenuItem}, Dropdown: ${isDropdownContainer}, Parent: ${parentFeature}]`);
                
                // Skip dropdown containers - they will be handled separately
                if (isDropdownContainer) {
                    console.log(`⏭️ Skipping dropdown container: ${feature} (will be handled by dropdown logic)`);
                    return;
                }
                
                // If item doesn't require permission, check if user has permission for this feature
                if (!requiresPermission) {
                    // Check if user has permission for this feature
                    if (feature && permissions[feature]) {
                        const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature}`);
                        } else {
                            console.log(`❌ No view permission for: ${feature}`);
                        }
                    } else {
                        console.log(`⚪ Feature not found in permissions: ${feature}`);
                    }
                    return;
                }
                
                // If item requires permission, check if user has it using the requiresPermission value
                const permissionKey = requiresPermission;
                if (permissionKey && permissions[permissionKey]) {
                    console.log(`🔍 Found permission for ${permissionKey}:`, permissions[permissionKey]);
                    
                    // Check if the permission has a 'view' property or if it's a boolean true
                    const hasViewPermission = permissions[permissionKey].view === true || permissions[permissionKey] === true;
                    
                    if (hasViewPermission) {
                        item.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${feature} (permission: ${permissionKey})`);
                    } else {
                        console.log(`❌ No view permission for: ${feature} (permission: ${permissionKey})`, permissions[permissionKey]);
                    }
                } else {
                    console.log(`⚪ Permission not found: ${permissionKey} for feature: ${feature}`);
                    console.log(`⚪ Available permissions:`, Object.keys(permissions));
                }
            });
            
            // Handle parent dropdowns - show only if they have visible children
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                const dropdownFeature = dropdown.getAttribute('data-feature');
                const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                const hasVisibleChildren = visibleSubmenuItems.length > 0;
                
                console.log(`🔍 Checking dropdown: ${dropdownFeature} - VisibleChildren: ${hasVisibleChildren} (${visibleSubmenuItems.length})`);
                
                if (hasVisibleChildren) {
                    dropdown.classList.add('menu-visible');
                    console.log(`✅ Showing parent dropdown ${dropdownFeature} (has ${visibleSubmenuItems.length} visible children)`);
                } else {
                    console.log(`❌ Hiding parent dropdown ${dropdownFeature} (no visible children)`);
                }
            });
            
            console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
            
            // Remove loading state from sidebar
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.classList.remove('menu-loading');
            }
        }
        
        // Initialize on auth state change
        auth.onAuthStateChanged((user) => {
            if (user) {
                updateMenuVisibilityForCompanyManagement();
            } else {
                resetMenuVisibility();
            }
        });
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                console.log('🔄 DOM loaded - waiting for authentication to complete...');
                
                // Wait for CompanyManagement to be initialized and authenticated
                const waitForAuth = () => {
                    if (window.companyManagement && window.companyManagement.currentUser && 
                        (window.companyManagement.currentUser.companyId || window.authManager?.currentUser?.companyId)) {
                        console.log('✅ Authentication and company context loaded - updating menu visibility');
                        updateMenuVisibilityForCompanyManagement();
                    } else {
                        console.log('⏳ Waiting for authentication and company context...');
                        setTimeout(waitForAuth, 500);
                    }
                };
                
                // Start checking after a brief delay to allow initialization
                setTimeout(waitForAuth, 1000);
                
                // Fallback: show basic menu after 5 seconds if auth never completes
                setTimeout(() => {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar && sidebar.classList.contains('menu-loading')) {
                        console.log('⚠️ Authentication timeout - showing basic menu');
                        showBasicMenu();
                    }
                }, 5000);
            });
        } else {
            console.log('🔄 DOM already loaded - waiting for authentication to complete...');
            
            // Wait for CompanyManagement to be initialized and authenticated
            const waitForAuth = () => {
                if (window.companyManagement && window.companyManagement.currentUser && 
                    (window.companyManagement.currentUser.companyId || window.authManager?.currentUser?.companyId)) {
                    console.log('✅ Authentication and company context loaded - updating menu visibility');
                    updateMenuVisibilityForCompanyManagement();
                } else {
                    console.log('⏳ Waiting for authentication and company context...');
                    setTimeout(waitForAuth, 500);
                }
            };
            
            // Start checking after a brief delay to allow initialization
            setTimeout(waitForAuth, 1000);
            
            // Fallback: show basic menu after 5 seconds if auth never completes
            setTimeout(() => {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar && sidebar.classList.contains('menu-loading')) {
                    console.log('⚠️ Authentication timeout - showing basic menu');
                    showBasicMenu();
                }
            }, 5000);
        }
        
        
        // Specific test for health permission
        window.testHealthPermission = async function() {
            console.log('🏥 TESTING HEALTH PERMISSION');
            console.log('==========================================');
            
            let currentUser = null;
            let companyId = null;
            let userRole = null;
            
            // Check centralized authentication system first
            if (window.authManager && window.authManager.currentUser) {
                currentUser = window.authManager.currentUser;
                companyId = currentUser.companyId;
                userRole = currentUser.role;
                console.log('👤 Using AuthManager authentication');
                console.log('🏢 Company ID:', companyId);
                console.log('👤 User role:', userRole);
            } else if (window.companyManagement && window.companyManagement.currentUser) {
                currentUser = window.companyManagement.currentUser;
                companyId = currentUser.companyId;
                userRole = currentUser.role;
                console.log('👤 Using CompanyManagement authentication');
                console.log('🏢 Company ID:', companyId);
                console.log('👤 User role:', userRole);
            } else if (auth.currentUser) {
                currentUser = auth.currentUser;
                console.log('👤 Using Firebase Auth (no centralized auth available)');
                console.log('⚠️ Company ID and role need to be fetched from Firebase');
            } else {
                console.log('❌ No authenticated user');
                return;
            }
            
            // If missing company ID, try to get it from Firebase
            if (!companyId) {
                console.log('🔍 Searching for company ID...');
                const database = firebase.database();
                const companiesRef = database.ref('companies');
                const companiesSnapshot = await companiesRef.once('value');
                
                if (companiesSnapshot.exists()) {
                    const companies = companiesSnapshot.val();
                    for (const [cId, company] of Object.entries(companies)) {
                        if (company.status !== 'active') continue;
                        if (company.users && company.users[currentUser.uid]) {
                            companyId = cId;
                            console.log('✅ Found company ID via search:', companyId);
                            break;
                        }
                    }
                }
                
                if (!companyId) {
                    console.log('❌ No company ID found');
                    return;
                }
            }
            
            const database = firebase.database();
            
            // If missing user role, get it from Firebase
            if (!userRole) {
                console.log('🔍 Fetching user role...');
                const companyUserRef = database.ref(`companies/${companyId}/users/${currentUser.uid}`);
                const companyUserSnapshot = await companyUserRef.once('value');
                const companyUserData = companyUserSnapshot.val();
                userRole = companyUserData.role;
                console.log('✅ Retrieved user role:', userRole);
            }
            
            // Get role permissions
            const roleRef = database.ref(`companies/${companyId}/roles/${userRole}`);
            const roleSnapshot = await roleRef.once('value');
            const roleData = roleSnapshot.val();
            const permissions = roleData.permissions;
            
            console.log('📋 All permissions:', Object.keys(permissions));
            
            // Check health_view permission specifically
            const healthPermission = permissions['health_view'];
            console.log('🏥 health_view permission:', healthPermission);
            
            if (healthPermission) {
                console.log('   • Permission exists: ✅ YES');
                console.log('   • Permission value:', healthPermission);
                console.log('   • Has view property:', healthPermission.hasOwnProperty('view'));
                if (healthPermission.hasOwnProperty('view')) {
                    console.log('   • View value:', healthPermission.view);
                }
                console.log('   • Is boolean true:', healthPermission === true);
                
                // Test the exact logic used in updateMenuWithPermissions
                const hasViewPermission = healthPermission.view === true || healthPermission === true;
                console.log('   • Should show menu (view === true OR permission === true):', hasViewPermission ? '✅ YES' : '❌ NO');
            } else {
                console.log('   • Permission exists: ❌ NO');
            }
            
            // Check the actual health menu item
            const healthMenuItem = document.querySelector('[data-feature="health_view"]');
            if (healthMenuItem) {
                console.log('🎯 Health menu item found');
                console.log('   • Has menu-visible class:', healthMenuItem.classList.contains('menu-visible') ? '✅ YES' : '❌ NO');
                console.log('   • data-requires-permission:', healthMenuItem.getAttribute('data-requires-permission'));
            } else {
                console.log('❌ Health menu item not found in DOM');
            }
            
            console.log('==========================================');
        };
        
        // Listen for role changes
        window.addEventListener('userRoleChanged', () => {
            updateMenuVisibilityForCompanyManagement();
        });

    // Helper functions for menu management (from project-list.html)
    function resetMenuVisibility() {
        document.querySelectorAll('[data-feature]').forEach(item => {
            item.classList.remove('menu-visible');
        });
        document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
            dropdown.classList.remove('menu-visible');
        });
    }

    function ensureHomeIsVisible() {
        const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
        if (homeItem && !homeItem.classList.contains('menu-visible')) {
            homeItem.classList.add('menu-visible');
            console.log('✅ Ensured home menu item is visible as fallback');
        }
    }

    function showSidebarAfterAuth() {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.classList.remove('menu-loading');
            console.log('✅ Sidebar loading state removed - menu authorization complete');
        }
    }

    // Emergency fallback function to show all menu items
    function emergencyShowAllMenuItems() {
        console.log('🚨 Emergency fallback - showing all menu items');
        const allItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
        allItems.forEach(item => {
            item.classList.add('menu-visible');
        });
        showSidebarAfterAuth();
    }

    function hideItemsRequiringPermissions() {
        console.log('🔒 Hiding all menu items that require permissions...');
        
        const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
        let hiddenCount = 0;
        
        itemsRequiringPermissions.forEach(item => {
            const feature = item.getAttribute('data-feature');
            const requiresPermission = item.getAttribute('data-requires-permission');
            
            item.classList.remove('menu-visible');
            hiddenCount++;
            console.log(`❌ Hiding menu item (requires permission): ${feature} (requires: ${requiresPermission})`);
        });
        
        // Also hide dropdown menus that only contain items requiring permissions
        const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
        dropdownMenus.forEach(dropdown => {
            const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
            const dropdownFeature = dropdown.getAttribute('data-feature');
            
            if (submenuItems.length === 0) {
                dropdown.classList.remove('menu-visible');
                console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
            }
        });
        
        console.log(`🔒 Hidden ${hiddenCount} items requiring permissions`);
        
        // Ensure at least home is visible
        ensureHomeIsVisible();
        
        // Show sidebar after hiding items
        showSidebarAfterAuth();
    }

    // Filter currently visible menu items by role permissions (from project-list.html)
    function filterMenuByPermissions(permissions) {
        console.log('🔍 Filtering visible menu items by role permissions...');
        
        if (!permissions) {
            console.log('⚠️ No permissions object provided');
            hideItemsRequiringPermissions();
            showSidebarAfterAuth();
            return;
        }
        
    // Check all feature-authorized visible items (dropdown containers handled later)
    const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-feature]');
    console.log(`🎯 Found ${visibleMenuItems.length} visible menu items to check against permissions`);
        
        let hiddenCount = 0;
        
        visibleMenuItems.forEach(item => {
            const isDropdown = item.classList.contains('menu-dropdown');
            if (isDropdown) return; // handled in dropdown phase

            const feature = item.getAttribute('data-feature');
            const requiresPermission = item.getAttribute('data-requires-permission');

            // Determine the permission key to check
            const permissionKey = requiresPermission || feature;
            const hasPermissionObj = permissions[permissionKey];
            const hasViewPermission = hasPermissionObj === true || (hasPermissionObj && hasPermissionObj.view === true);

            if (!hasViewPermission) {
                item.classList.remove('menu-visible');
                hiddenCount++;
                console.log(`❌ Hiding menu item (no permission): ${feature} (checked key: ${permissionKey})`);
            } else {
                console.log(`✅ Keeping menu item visible: ${feature} (permitted via: ${permissionKey})`);
            }
        });
        
        // Re-check dropdown menus after permission filtering
        const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
        dropdownMenus.forEach(dropdown => {
            const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
            const dropdownFeature = dropdown.getAttribute('data-feature');
            
            if (submenuItems.length === 0) {
                // No visible children - check if dropdown itself has permission requirements
                const dropdownRequires = dropdown.getAttribute('data-requires-permission');
                if (dropdownRequires) {
                    const hasDropdownPermission = permissions[dropdownRequires] === true || 
                                                 (permissions[dropdownRequires] && permissions[dropdownRequires].view === true);
                    if (!hasDropdownPermission) {
                        dropdown.classList.remove('menu-visible');
                        hiddenCount++;
                        console.log(`❌ Hiding dropdown (no children and no permission): ${dropdownFeature}`);
                    }
                } else {
                    dropdown.classList.remove('menu-visible');
                    console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
                }
            } else {
                console.log(`✅ Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
            }
        });
        
        console.log(`🎯 Role-based filtering completed - ${hiddenCount} items hidden due to lack of permissions`);
        
        // Ensure at least home is visible
        ensureHomeIsVisible();
        
        // Show sidebar after all filtering is complete
        showSidebarAfterAuth();
    }

    // Initialize menu authorization system (from project-list.html)
    function initializeMenuAuthorization() {
        console.log('🚀 Initializing menu authorization system...');
        
        // Set sidebar to loading state initially
        const sidebar = document.querySelector('.sidebar');
        if (sidebar) {
            sidebar.classList.add('menu-loading');
        }
        
        // Wait a moment for Firebase to initialize, then start authorization
        setTimeout(async () => {
            try {
                console.log('⚡ Starting feature + role-based authorization...');
                await updateMenuWithFeatureAuthorization();
                console.log('✅ Menu authorization initialization complete');
                
                // Ensure loading class is removed after successful authorization
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
            } catch (error) {
                console.error('❌ Error during menu authorization:', error);
                // Fallback - show all menu items and remove loading state
                const allItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                allItems.forEach(item => item.classList.add('menu-visible'));
                showSidebarAfterAuth();
            }
        }, 500);
    }

    // Make functions globally available (testing helpers removed)
    window.resetMenuVisibility = resetMenuVisibility;
    window.ensureHomeIsVisible = ensureHomeIsVisible;
    window.showSidebarAfterAuth = showSidebarAfterAuth;
    window.hideItemsRequiringPermissions = hideItemsRequiringPermissions;
    window.filterMenuByPermissions = filterMenuByPermissions;
    window.initializeMenuAuthorization = initializeMenuAuthorization;
    window.updateMenuWithPermissions = updateMenuWithPermissions;
    window.updateMenuWithPrioritySystem = updateMenuWithPrioritySystem;
    window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;
    window.applyFeatureBasedMenuVisibility = applyFeatureBasedMenuVisibility;
    window.updateMenuVisibilityForCompanyManagement = updateMenuWithFeatureAuthorization;
    window.applyFeatureBasedAuthorizationForPriority = applyFeatureBasedAuthorizationForPriority;
    window.emergencyShowAllMenuItems = emergencyShowAllMenuItems;

    // (Testing functions removed)

        // New function to apply only role-based permissions without feature filtering
        async function applyRolePermissionsOnly() {
            console.log('🔧 Applying ONLY role-based permissions (no feature filtering)...');
            
            try {
                // Get current user and company info
                let currentUser = null;
                let companyId = null;
                let userRole = null;
                
                // Get authenticated user from centralized system
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                    console.log('👤 Using AuthManager - User:', currentUser.email, 'Role:', userRole, 'CompanyId:', companyId);
                } else if (window.companyManagement && window.companyManagement.currentUser) {
                    currentUser = window.companyManagement.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                    console.log('👤 Using CompanyManagement - User:', currentUser.email, 'Role:', userRole, 'CompanyId:', companyId);
                } else if (auth.currentUser) {
                    console.log('⚠️ Centralized auth not ready, using Firebase auth as fallback');
                    currentUser = auth.currentUser;
                    console.log('👤 Firebase user:', currentUser.email);
                } else {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If we don't have company ID or role from centralized system, try to get it from Firebase
                if (!companyId || !userRole) {
                    console.log('🔍 Missing company/role info, fetching from Firebase...');
                    const database = firebase.database();
                    
                    if (!companyId) {
                        // Search for user's company dynamically
                        const companiesRef = database.ref('companies');
                        const companiesSnapshot = await companiesRef.once('value');
                        
                        if (companiesSnapshot.exists()) {
                            const companies = companiesSnapshot.val();
                            
                            // Search through all companies for the current user
                            for (const [cId, company] of Object.entries(companies)) {
                                if (company.status !== 'active') continue;
                                
                                if (company.users && company.users[currentUser.uid]) {
                                    companyId = cId;
                                    console.log(`✅ Found user in company: ${companyId}`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (!companyId) {
                        console.log('❌ No company found for user');
                        resetMenuVisibility();
                        return;
                    }
                    
                    // Get user's role within the specific company if not available
                    if (!userRole) {
                        const companyUserRef = database.ref(`companies/${companyId}/users/${currentUser.uid}`);
                        const companyUserSnapshot = await companyUserRef.once('value');
                        
                        if (!companyUserSnapshot.exists()) {
                            console.log('❌ User not found in company user list');
                            resetMenuVisibility();
                            return;
                        }
                        
                        const companyUserData = companyUserSnapshot.val();
                        userRole = companyUserData.role;
                        console.log(`👤 Retrieved user role from Firebase: ${userRole}`);
                    }
                }
                
                console.log(`👤 Final auth data for role test - CompanyId: ${companyId}, Role: ${userRole}`);
                
                if (!userRole) {
                    console.log('⚠️ Missing user role');
                    resetMenuVisibility();
                    return;
                }
                
                // Get role permissions from Firebase
                const database = firebase.database();
                const allRolesRef = database.ref(`companies/${companyId}/roles`);
                console.log(`🔍 Fetching role permissions from: companies/${companyId}/roles/${userRole}`);
                
                const allRolesSnapshot = await allRolesRef.once('value');
                
                if (!allRolesSnapshot.exists()) {
                    console.log(`❌ No roles found in company ${companyId}`);
                    resetMenuVisibility();
                    return;
                }
                
                const allRoles = allRolesSnapshot.val();
                console.log('🔍 Available roles in company:', Object.keys(allRoles));
                
                // Find the user's role and get permissions
                if (allRoles[userRole] && allRoles[userRole].permissions) {
                    console.log(`✅ Found role ${userRole} with permissions`);
                    const permissions = allRoles[userRole].permissions;
                    console.log('✅ Role permissions:', permissions);
                    
                    // Apply ONLY role-based permissions (no feature filtering)
                    updateMenuWithPermissions(permissions);
                    return;
                }
                
                // Try to find role with different casing or format
                const roleKeys = Object.keys(allRoles);
                const matchingRole = roleKeys.find(key => 
                    key.toLowerCase() === userRole.toLowerCase() ||
                    key.replace(/\s+/g, '').toLowerCase() === userRole.replace(/\s+/g, '').toLowerCase()
                );
                
                if (matchingRole && allRoles[matchingRole].permissions) {
                    console.log(`✅ Found matching role: ${matchingRole}`);
                    const permissions = allRoles[matchingRole].permissions;
                    console.log('✅ Role permissions:', permissions);
                    
                    // Apply ONLY role-based permissions (no feature filtering)
                    updateMenuWithPermissions(permissions);
                    return;
                }
                
                console.log(`❌ No permissions found for role ${userRole} in company ${companyId}`);
                resetMenuVisibility();
                
            } catch (error) {
                console.error('❌ Error applying role-based permissions:', error);
                resetMenuVisibility();
            }
        }

    // (Status badge updates removed)

    // (Notification helper removed)

        // Debug function to test role permissions specifically
        window.debugRolePermissionsTest = async function() {
            console.log('🧪 DEBUG: Testing Role Permissions Only');
            console.log('==========================================');
            
            try {
                // Show current menu state before test
                console.log('📋 BEFORE - Current visible menu items:');
                const visibleBefore = document.querySelectorAll('[data-feature].menu-visible');
                visibleBefore.forEach(item => {
                    console.log(`  ✅ ${item.getAttribute('data-feature')}`);
                });
                
                // Apply role permissions only
                console.log('\n🔧 Applying role permissions only...');
                await applyRolePermissionsOnly();
                
                // Show menu state after test
                console.log('\n📋 AFTER - Visible menu items with role permissions:');
                const visibleAfter = document.querySelectorAll('[data-feature].menu-visible');
                visibleAfter.forEach(item => {
                    console.log(`  ✅ ${item.getAttribute('data-feature')}`);
                });
                
                console.log('\n📊 SUMMARY:');
                console.log(`  • Items before: ${visibleBefore.length}`);
                console.log(`  • Items after: ${visibleAfter.length}`);
                console.log(`  • Difference: ${visibleAfter.length - visibleBefore.length}`);
                
                if (visibleAfter.length === 0) {
                    console.log('⚠️  WARNING: No menu items visible! Check:');
                    console.log('   1. User has valid company role');
                    console.log('   2. Role has permissions defined');
                    console.log('   3. Menu items have correct data-feature attributes');
                }
                
            } catch (error) {
                console.error('❌ Error in role permissions test:', error);
            }
            
            console.log('==========================================');
        };

        // Debug function to test the priority system specifically
        window.debugPrioritySystemTest = async function() {
            console.log('🎯 DEBUG: Testing Priority System (Feature + Role Filtering)');
            console.log('==========================================');
            
            try {
                // Show current menu state before test
                console.log('📋 BEFORE - Current visible menu items:');
                const visibleBefore = document.querySelectorAll('[data-feature].menu-visible');
                visibleBefore.forEach(item => {
                    console.log(`  ✅ ${item.getAttribute('data-feature')}`);
                });
                
                // Get user permissions first
                console.log('\n🔍 Getting user role permissions...');
                let currentUser = null;
                let companyId = null;
                let userRole = null;
                
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                } else if (window.companyManagement && window.companyManagement.currentUser) {
                    currentUser = window.companyManagement.currentUser;
                    companyId = currentUser.companyId;
                    userRole = currentUser.role;
                } else if (auth.currentUser) {
                    currentUser = auth.currentUser;
                }
                
                if (!companyId && currentUser) {
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                break;
                            }
                        }
                    }
                }
                
                if (!userRole && companyId && currentUser) {
                    const companyUserRef = firebase.database().ref(`companies/${companyId}/users/${currentUser.uid}`);
                    const companyUserSnapshot = await companyUserRef.once('value');
                    const companyUserData = companyUserSnapshot.val();
                    userRole = companyUserData?.role;
                }
                
                if (!companyId || !userRole) {
                    console.log('❌ Could not get company ID or user role');
                    return;
                }
                
                // Get permissions
                const allRolesRef = firebase.database().ref(`companies/${companyId}/roles`);
                const allRolesSnapshot = await allRolesRef.once('value');
                const allRoles = allRolesSnapshot.val();
                const permissions = allRoles[userRole]?.permissions || {};
                
                console.log(`👤 User role: ${userRole}`);
                console.log(`🔑 User permissions:`, Object.keys(permissions));
                
                // Apply priority system
                console.log('\n🔧 Applying priority system (feature + role filtering)...');
                await updateMenuWithPrioritySystem(permissions);
                
                // Show menu state after test
                console.log('\n📋 AFTER - Visible menu items with priority system:');
                const visibleAfter = document.querySelectorAll('[data-feature].menu-visible');
                visibleAfter.forEach(item => {
                    console.log(`  ✅ ${item.getAttribute('data-feature')}`);
                });
                
                console.log('\n📊 PRIORITY SYSTEM SUMMARY:');
                console.log(`  • Items before: ${visibleBefore.length}`);
                console.log(`  • Items after: ${visibleAfter.length}`);
                console.log(`  • Process: Platform Features → Role Permissions Filter`);
                console.log(`  • Result: Shows items that are BOTH feature-authorized AND role-permitted`);
                
                if (visibleAfter.length === 0) {
                    console.log('\n⚠️  WARNING: No menu items visible! Check:');
                    console.log('   1. Company has subscribed platform features');
                    console.log('   2. User role has permissions for feature-authorized pages');
                    console.log('   3. Menu items have correct data-feature attributes');
                }
                
            } catch (error) {
                console.error('❌ Error in priority system test:', error);
            }
            
            console.log('==========================================');
        };
    </script>

    <script>
        // Note: Firebase configuration and initialization already done above
        // Just make sure the global variables are available if needed
        if (typeof window.db === 'undefined') {
            window.db = db;
        }
        if (typeof window.auth === 'undefined') {
            window.auth = auth;
        }
        if (typeof window.loginWithEmail === 'undefined') {
            window.loginWithEmail = loginWithEmail;
        }
        if (typeof window.logoutUser === 'undefined') {
            window.logoutUser = logoutUser;
        }
        window.firebase = firebase;
    </script>

    <script>
        // Password toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Handle password toggle buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('password-toggle') || e.target.closest('.password-toggle')) {
                    const button = e.target.closest('.password-toggle') || e.target;
                    const targetId = button.getAttribute('data-target');
                    const targetInput = document.getElementById(targetId);
                    const icon = button.querySelector('i');
                    
                    if (targetInput && icon) {
                        if (targetInput.type === 'password') {
                            targetInput.type = 'text';
                            icon.classList.remove('fa-eye');
                            icon.classList.add('fa-eye-slash');
                        } else {
                            targetInput.type = 'password';
                            icon.classList.remove('fa-eye-slash');
                            icon.classList.add('fa-eye');
                        }
                    }
                }
            });

            // Form validation
            const addUserForm = document.getElementById('addUserForm');
            if (addUserForm) {
                // Note: Form submission is handled by companymanagement.js module
                // This section only handles password toggle functionality
                console.log('Add user form found, but submission is handled by JS module');
            }

            // Edit User Form Submission Handler
            const editUserForm = document.getElementById('editUserForm');
            if (editUserForm) {
                console.log('🔧 Setting up edit user form submission handler...');
                
                // Add direct button click handler as primary method
                const submitButton = editUserForm.querySelector('button[type="submit"]');
                if (submitButton) {
                    console.log('🔘 Found submit button, adding click handler...');
                    
                    // Remove any existing click listeners
                    submitButton.onclick = null;
                    
                    // Add click handler that calls the function when it's available
                    submitButton.addEventListener('click', async function(event) {
                        console.log('🖱️ EDIT SUBMIT BUTTON CLICKED!');
                        console.log('📊 Click event details:', {
                            type: event.type,
                            target: event.target.tagName,
                            button: event.button,
                            disabled: event.target.disabled
                        });
                        
                        // CRITICAL: Prevent all default behaviors and form submission
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation();
                        
                        console.log('🛑 All event propagation stopped - no form submission will occur');
                        
                        // Check if button is disabled
                        if (event.target.disabled) {
                            console.log('🔒 Button is disabled, ignoring click');
                            return false;
                        }
                        
                        // Check if the function is available
                        if (typeof window.handleEditUserSubmission === 'function') {
                            console.log('🚀 Calling handleEditUserSubmission function...');
                            
                            // Create a synthetic form submit event
                            const syntheticEvent = new Event('submit', { 
                                bubbles: true, 
                                cancelable: true 
                            });
                            
                            // Add preventDefault and stopPropagation methods
                            syntheticEvent.preventDefault = () => {
                                syntheticEvent.defaultPrevented = true;
                            };
                            syntheticEvent.stopPropagation = () => {};
                            
                            // Set the target to the form
                            Object.defineProperty(syntheticEvent, 'target', {
                                value: editUserForm,
                                writable: false
                            });
                            
                            try {
                                await window.handleEditUserSubmission(syntheticEvent);
                            } catch (error) {
                                console.error('❌ Error in button click handler:', error);
                                if (window.companyManagement) {
                                    window.companyManagement.showNotification('Error saving user: ' + error.message, 'error');
                                } else {
                                    alert('Error saving user: ' + error.message);
                                }
                            }
                        } else {
                            console.error('❌ handleEditUserSubmission function not available');
                            if (window.companyManagement) {
                                window.companyManagement.showNotification('Error: Form submission handler not ready. Please refresh the page.', 'error');
                            } else {
                                alert('Error: Form submission handler not ready. Please refresh the page.');
                            }
                        }
                        
                        // Explicitly return false to prevent any form submission
                        return false;
                    });
                    
                    console.log('✅ Direct submit button click handler added');
                } else {
                    console.error('❌ Submit button not found in edit form');
                }
                
                console.log('✅ Edit user form submission handler attached successfully');
            } else {
                console.warn('⚠️ Edit user form not found - submission handler not attached');
            }

            // Initialize enhanced quota management
            const quotaInput = document.getElementById('userQuotaInput');
            
            if (quotaInput) {
                // Set initial value and preview
                quotaInput.value = 50; // This should come from actual data
                
                // Add input event listener for real-time updates
                quotaInput.addEventListener('input', function() {
                    if (typeof updatePricingPreview === 'function') {
                        updatePricingPreview();
                    }
                });

                // Add transition effects to input
                quotaInput.style.transition = 'transform 0.15s ease';
            }

            // Initial pricing update
            if (quotaInput && typeof updatePricingPreview === 'function') {
                updatePricingPreview();
            }

            // Initialize quota tracking capabilities
            console.log('📊 Dashboard initialized with quota tracking enabled');
        });

        // Quota Management Functions
        function checkUserQuota() {
            // Get current quota information from the page
            const userQuotaElement = document.getElementById('userQuota');
            const subscriptionCurrentUsersElement = document.getElementById('subscriptionCurrentUsers');
            const subscriptionMaxUsersElement = document.getElementById('subscriptionMaxUsers');
            
            let currentUsers = 0;
            let maxUsers = 50; // Default quota
            
            // Try to get values from different elements
            if (userQuotaElement && userQuotaElement.textContent) {
                const quotaText = userQuotaElement.textContent.trim();
                const quotaMatch = quotaText.match(/(\d+)\s*\/\s*(\d+)/);
                if (quotaMatch) {
                    currentUsers = parseInt(quotaMatch[1]);
                    maxUsers = parseInt(quotaMatch[2]);
                }
            } else if (subscriptionCurrentUsersElement && subscriptionMaxUsersElement) {
                currentUsers = parseInt(subscriptionCurrentUsersElement.textContent) || 0;
                maxUsers = parseInt(subscriptionMaxUsersElement.textContent) || 50;
            }
            
            return {
                currentUsers: currentUsers,
                maxUsers: maxUsers,
                isQuotaExceeded: currentUsers >= maxUsers,
                availableSlots: Math.max(0, maxUsers - currentUsers)
            };
        }

        function updateAddUserButtonState() {
            const addUserButton = document.getElementById('addUserButton');
            const addUserButtonContainer = document.getElementById('addUserButtonContainer');
            const quotaTooltip = document.getElementById('quotaTooltip');
            
            if (!addUserButton || !addUserButtonContainer || !quotaTooltip) {
                console.warn('Add user button elements not found');
                return;
            }
            
            const quotaInfo = checkUserQuota();
            
            if (quotaInfo.isQuotaExceeded) {
                // Disable button when quota is reached
                addUserButton.disabled = true;
                addUserButton.classList.add('disabled');
                addUserButton.style.cursor = 'not-allowed';
                
                // Show tooltip
                quotaTooltip.style.display = 'block';
                quotaTooltip.textContent = `User quota limit reached (${quotaInfo.currentUsers}/${quotaInfo.maxUsers}). Upgrade your plan to add more users.`;
                
                // Add hover effect for tooltip
                addUserButtonContainer.classList.add('quota-exceeded-tooltip');
                
                console.log('Add User button disabled - quota exceeded');
            } else {
                // Enable button when quota allows
                addUserButton.disabled = false;
                addUserButton.classList.remove('disabled');
                addUserButton.style.cursor = 'pointer';
                
                // Hide tooltip
                quotaTooltip.style.display = 'none';
                addUserButtonContainer.classList.remove('quota-exceeded-tooltip');
                
                console.log(`Add User button enabled - ${quotaInfo.availableSlots} slots available`);
            }
        }

        // Enhanced showAddUserModal function with quota checking
        function showAddUserModalWithQuotaCheck() {
            const quotaInfo = checkUserQuota();
            
            if (quotaInfo.isQuotaExceeded) {
                // Show notification instead of modal
                showQuotaExceededNotification(quotaInfo);
                return false;
            }
            
            // If quota allows, proceed with original function
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.classList.add('show');
                
                // Focus on first input
                setTimeout(() => {
                    const firstInput = modal.querySelector('input');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 100);
            }
            return true;
        }

        function showQuotaExceededNotification(quotaInfo) {
            // Create and show a notification
            const notification = document.createElement('div');
            notification.className = 'quota-notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; 
                            padding: 1rem 1.5rem; border-radius: 8px; z-index: 10001; 
                            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3); max-width: 400px;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <i class="fas fa-exclamation-triangle" style="margin-top: 0.125rem; font-size: 1.1rem;"></i>
                        <div>
                            <strong style="display: block; margin-bottom: 0.5rem;">User Quota Exceeded</strong>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.4;">
                                You have reached your user limit (${quotaInfo.currentUsers}/${quotaInfo.maxUsers}). 
                                Please upgrade your subscription plan to add more users.
                            </p>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    style="margin-top: 0.75rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                                           color: white; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-times" style="margin-right: 0.25rem;"></i>Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        // Modal close function
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                // Ensure modal is hidden visually as some modals use inline display styles
                modal.style.display = 'none';
                
                // Reset form if it exists
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    
                    // Clear error states
                    const errorGroups = form.querySelectorAll('.form-group.error');
                    errorGroups.forEach(group => {
                        group.classList.remove('error');
                        const errorDiv = group.querySelector('.form-error');
                        if (errorDiv) {
                            errorDiv.style.display = 'none';
                        }
                    });
                }
            }
        }

        // Global payment processing function
        function processPayment() {
            if (window.companyManagement) {
                window.companyManagement.processPayment();
            } else {
                console.error('❌ Company Management instance not available');
                showNotification('Error: System not ready. Please refresh the page.', 'error');
            }
        }

        // Global save subscription changes function
        function saveSubscriptionChanges() {
            if (window.companyManagement) {
                window.companyManagement.saveSubscriptionChanges();
            } else {
                console.error('❌ Company Management instance not available');
                showNotification('Error: System not ready. Please refresh the page.', 'error');
            }
        }

        // Global notification function
        function showNotification(message, type = 'info') {
            if (window.companyManagement) {
                window.companyManagement.showNotification(message, type);
            } else {
                // Fallback notification if CompanyManagement not available
                alert(message);
            }
        }

        // Show modal function with quota checking and dropdown population
        async function showAddUserModal() {
            const quotaInfo = checkUserQuota();
            
            if (quotaInfo.isQuotaExceeded) {
                // Show notification instead of modal
                showQuotaExceededNotification(quotaInfo);
                return false;
            }
            
            // Show modal IMMEDIATELY for better UX, then load data in background
            const modal = document.getElementById('addUserModal');
            if (!modal) return false;
            
            // Reset display style (closeModal sets it to 'none') and add show class
            modal.style.display = '';
            modal.classList.add('show');
            
            // Focus on first input right away
            setTimeout(() => {
                const firstInput = modal.querySelector('input');
                if (firstInput) firstInput.focus();
            }, 50);

            // Load data and apply permissions in background (non-blocking)
            (async () => {
                try {
                    // Permission check (non-blocking - if fails, close modal)
                    const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                    const me = window.companyManagement?.currentUser?.uid || window.companyManagement?.currentUser?.id;
                    if (companyId && me) {
                        const pSnap0 = await db.ref(`companies/${companyId}/accessControl/tabVisibility/${me}`).once('value');
                        const p0 = pSnap0.val() || {};
                        if (p0.canSeeAddButton !== true) {
                            showNotification('You do not have permission to add users.', 'warning');
                            closeModal('addUserModal');
                            return;
                        }
                    }
                } catch (permErr) { console.warn('Add modal permission check failed:', permErr); }

                // Load and populate dropdown fields with company-scoped data (background)
                populateAddUserModalDropdowns().catch(e => console.warn('Dropdown population error:', e));

                // Initialize account type UI toggles
                try {
                    const form = document.getElementById('addUserForm');
                    const emailGroup = document.getElementById('userEmailGroup');
                    const emailRequiredStar = document.getElementById('userEmailRequiredStar');
                    const emailHelp = document.getElementById('userEmailHelp');
                    const passwordGroup = document.getElementById('userPasswordGroup');
                    const passwordRequiredStar = document.getElementById('userPasswordRequiredStar');
                    const emailInput = document.getElementById('userEmail');
                    const passwordInput = document.getElementById('userPassword');

                    // Access-control-based restrictions for account type radios
                    const withRadio = form?.querySelector('input[name="userAccountType"][value="with-account"]');
                    const withoutRadio = form?.querySelector('input[name="userAccountType"][value="without-account"]');
                    try {
                        const companyId = window.companyManagement?.companyId || window.companyManagement?.getCurrentCompanyId?.();
                        const me = window.companyManagement?.currentUser?.uid || window.companyManagement?.currentUser?.id;
                        if (companyId && me) {
                            const pSnap = await db.ref(`companies/${companyId}/accessControl/tabVisibility/${me}`).once('value');
                            const p = pSnap.val() || {};
                            const allowCreateWith = p.canCreateWithAccount === true;
                            const allowCreateWithout = p.canCreateWithoutAccount !== false; // default allow
                            if (withRadio) withRadio.disabled = !allowCreateWith;
                            if (withoutRadio) withoutRadio.disabled = !allowCreateWithout;
                            // Normalize selection to an allowed option
                            if (withRadio && withRadio.checked && withRadio.disabled && withoutRadio && !withoutRadio.disabled) {
                                withoutRadio.checked = true;
                            } else if (withoutRadio && withoutRadio.checked && withoutRadio.disabled && withRadio && !withRadio.disabled) {
                                withRadio.checked = true;
                            } else if (withRadio && withRadio.disabled && withoutRadio && withoutRadio.disabled) {
                                // no allowed option; bail out
                                showNotification('You do not have permission to create any type of user.', 'warning');
                                closeModal('addUserModal');
                                return;
                            }
                        }
                    } catch (ePerm) { console.warn('Failed to apply create permissions to account type radios:', ePerm); }

                    const applyAccountTypeUI = () => {
                        const accountType = form.querySelector('input[name="userAccountType"]:checked')?.value || 'with-account';
                        const isWithAccount = accountType === 'with-account';
                        // Required indicators
                        if (emailRequiredStar) emailRequiredStar.style.visibility = isWithAccount ? 'visible' : 'hidden';
                        if (passwordRequiredStar) passwordRequiredStar.style.visibility = isWithAccount ? 'visible' : 'hidden';
                        // Help text
                        if (emailHelp) emailHelp.textContent = isWithAccount ? 'This will be used for login' : 'Optional (used for contact and reporting only)';
                        // Enable/disable fields visually (not disabling to preserve validation messaging)
                        if (emailGroup) emailGroup.classList.toggle('optional', !isWithAccount);
                        if (passwordGroup) passwordGroup.classList.toggle('optional', !isWithAccount);
                        // Clear errors when switching to optional
                        if (!isWithAccount) {
                            emailGroup?.classList.remove('error');
                            passwordGroup?.classList.remove('error');
                            emailGroup?.querySelector('.form-error')?.style && (emailGroup.querySelector('.form-error').style.display = 'none');
                            passwordGroup?.querySelector('.form-error')?.style && (passwordGroup.querySelector('.form-error').style.display = 'none');
                        }
                        // Helper to get the .form-group wrapper for a field id
                        const groupOf = (id) => {
                            const el = document.getElementById(id);
                            return el ? el.closest('.form-group') : null;
                        };
                        // Helper to set/unset required safely
                        const setRequired = (id, req) => {
                            const el = document.getElementById(id);
                            if (!el) return;
                            if (req) el.setAttribute('required', ''); else el.removeAttribute('required');
                        };

                        // Groups to toggle based on account type
                        const allFieldIds = [
                            'userRole','userStatus','userPassword','userEmail','userEmployeeId',
                            'userCountryCode','userPhone','userAddress','userLineManager','userDepartment',
                            'userCompanyAffiliation','userJobTitle','userFirstName','userLastName'
                        ];
                        const showForWithout = new Set(['userFirstName','userLastName','userJobTitle','userCompanyAffiliation']);

                        if (!isWithAccount) {
                            // Show only First/Last/Job Title/Company
                            allFieldIds.forEach(id => {
                                const grp = groupOf(id);
                                if (!grp) return;
                                grp.style.display = showForWithout.has(id) ? '' : 'none';
                            });
                            // Remove required for account fields
                            setRequired('userEmail', false);
                            setRequired('userPassword', false);
                            setRequired('userRole', false);
                        } else {
                            // Show everything for account users
                            allFieldIds.forEach(id => {
                                const grp = groupOf(id);
                                if (!grp) return;
                                grp.style.display = '';
                            });
                            // Restore required
                            setRequired('userEmail', true);
                            setRequired('userPassword', true);
                            setRequired('userRole', true);
                        }

                        // Remove HTML required attributes for non-account inputs to avoid browser-level blocking
                        if (!isWithAccount) {
                            emailInput?.removeAttribute('required');
                            passwordInput?.removeAttribute('required');
                        }
                    };

                    applyAccountTypeUI();
                    form.querySelectorAll('input[name="userAccountType"]').forEach(r => {
                        r.addEventListener('change', applyAccountTypeUI);
                    });
                } catch (e) {
                    console.warn('Failed to initialize account type UI toggles:', e);
                }
            })(); // End of background async IIFE
            
            return true;
        }

        // Populate dropdown fields in add user modal
        async function populateAddUserModalDropdowns() {
            try {
                console.log('🔄 Loading dropdown data for add user modal...');
                
                // Check if companyManagement instance is available
                if (!window.companyManagement) {
                    console.warn('⚠️ Company management instance not available');
                    return;
                }

                console.log('🔍 Debug - Company ID check:', {
                    companyId: window.companyManagement.companyId,
                    currentUserCompanyId: window.companyManagement.currentUser?.companyId
                });

                // Load all field options
                const fieldOptions = await window.companyManagement.loadCompanyFieldOptions();
                
                console.log('📋 Field options loaded for add user modal:', {
                    jobTitles: fieldOptions.jobTitles?.length || 0,
                    jobTitlesData: fieldOptions.jobTitles,
                    departments: fieldOptions.departments?.length || 0,
                    lineManagers: fieldOptions.lineManagers?.length || 0
                });
                
                // Populate Job Titles dropdown
                window.companyManagement.populateDropdownField(
                    'userJobTitle', 
                    fieldOptions.jobTitles
                );
                console.log('✅ Populated userJobTitle dropdown with', fieldOptions.jobTitles?.length || 0, 'options');
                
                // Populate Departments dropdown
                window.companyManagement.populateDropdownField(
                    'userDepartment', 
                    fieldOptions.departments
                );
                console.log('✅ Populated userDepartment dropdown with', fieldOptions.departments?.length || 0, 'options');
                
                // Populate Line Managers dropdown
                const lineManagerSelect = document.getElementById('userLineManager');
                if (lineManagerSelect && fieldOptions.lineManagers.length > 0) {
                    // Clear existing options except the first one (placeholder)
                    const firstOption = lineManagerSelect.children[0];
                    lineManagerSelect.innerHTML = '';
                    if (firstOption) {
                        lineManagerSelect.appendChild(firstOption);
                    }

                    fieldOptions.lineManagers.forEach(manager => {
                        const option = document.createElement('option');
                        option.value = manager.uid;
                        
                        // Create a more informative display text
                        let displayText = manager.name;
                        if (manager.jobTitle && manager.department) {
                            displayText += ` (${manager.jobTitle} - ${manager.department})`;
                        } else if (manager.jobTitle) {
                            displayText += ` (${manager.jobTitle})`;
                        } else if (manager.department) {
                            displayText += ` (${manager.department})`;
                        } else if (manager.role) {
                            displayText += ` (${manager.role})`;
                        }
                        
                        option.textContent = displayText;
                        option.title = `${manager.name} - ${manager.email}`;
                        lineManagerSelect.appendChild(option);
                    });
                    
                    console.log(`✓ Populated userLineManager with ${fieldOptions.lineManagers.length} options`);
                }
                
                // Populate Roles dropdown (filtered by visibility settings)
                const roleSelect = document.getElementById('userRole');
                if (roleSelect && fieldOptions.roles.length > 0) {
                    // Clear existing options except the first one (placeholder)
                    const firstOption = roleSelect.children[0];
                    roleSelect.innerHTML = '';
                    if (firstOption) {
                        roleSelect.appendChild(firstOption);
                    }

                    // Load role visibility settings
                    let roleVisibility = null;
                    try {
                        roleVisibility = await window.getVisibleRolesForDropdown?.();
                    } catch (e) {
                        console.warn('Could not load role visibility settings:', e);
                    }

                    let addedCount = 0;
                    fieldOptions.roles.forEach(role => {
                        // Check if role is visible (null means all visible, otherwise check the map)
                        const isVisible = roleVisibility === null || roleVisibility[role.id] === true;
                        // Administrator is always visible
                        if (!isVisible && role.id !== 'administrator') {
                            return; // Skip hidden roles
                        }

                        const option = document.createElement('option');
                        option.value = role.id;
                        
                        // Special display for Administrator role
                        if (role.id === 'administrator') {
                            option.textContent = `👑 ${role.name}`;
                            option.style.fontWeight = 'bold';
                            option.style.color = '#ffd700';
                        } else {
                            option.textContent = role.name;
                        }
                        
                        if (role.description) {
                            option.title = role.description;
                        }
                        roleSelect.appendChild(option);
                        addedCount++;
                    });
                    
                    console.log(`✓ Populated userRole with ${addedCount} visible roles (${fieldOptions.roles.length} total)`);
                }

                // Populate Company/Subcontractor dropdown (main company + subcontractors)
                try {
                    const companySelect = document.getElementById('userCompanyAffiliation');
                    if (companySelect) {
                        // Clear but keep the placeholder
                        const firstOption = companySelect.children[0];
                        companySelect.innerHTML = '';
                        if (firstOption) companySelect.appendChild(firstOption);

                        const companyId = window.companyManagement.companyId;
                        const companyData = window.companyManagement.companyData || {};
                        const mainName = companyData.companyName || 'Main Company';
                        const normalizeName = (n) => (n || '').toString().trim().toLowerCase();
                        const seenNames = new Set();

                        // Main company option
                        const mainOpt = document.createElement('option');
                        mainOpt.value = JSON.stringify({ type: 'main', id: companyId, name: mainName });
                        mainOpt.textContent = `${mainName}`;
                        if (!seenNames.has(normalizeName(mainName))) {
                            companySelect.appendChild(mainOpt);
                            seenNames.add(normalizeName(mainName));
                        }

                        // Subcontractors from companies/{companyId}/subcontractors
                        let subs = {};
                        try {
                            const subsSnap = await db.ref(`companies/${companyId}/subcontractors`).once('value');
                            subs = subsSnap.exists() ? subsSnap.val() : {};
                        } catch (e) {
                            console.warn('⚠️ Could not load subcontractors for add user modal:', e);
                        }

                        Object.values(subs || {}).forEach(sub => {
                            if (!sub) return;
                            const id = sub.id || sub.uid || sub.key || sub.name;
                            const name = sub.name || sub.companyName || 'Subcontractor';
                            const opt = document.createElement('option');
                            opt.value = JSON.stringify({ type: 'subcontractor', id, name });
                            opt.textContent = `${name}`;
                            if (!seenNames.has(normalizeName(name))) {
                                companySelect.appendChild(opt);
                                seenNames.add(normalizeName(name));
                            }
                        });

                        // Default to main company
                        companySelect.value = mainOpt.value;
                        console.log(`✓ Populated userCompanyAffiliation with ${companySelect.options.length - 1} options (deduped)`);
                    }
                } catch (e) {
                    console.warn('⚠️ Failed to populate Company/Subcontractor select:', e);
                }
                
                console.log('✅ Add user modal dropdowns populated successfully');
                
                // Populate Country Code select with a comprehensive E.164 list (codes only)
                try {
                    populateCountryCodeSelect('userCountryCode');
                    console.log('✓ Populated userCountryCode with E.164 country calling codes');
                } catch (e) {
                    console.warn('⚠️ Failed to populate userCountryCode:', e);
                }
                
            } catch (error) {
                console.error('❌ Error populating add user modal dropdowns:', error);
                // Don't prevent the modal from showing, just log the error
            }
        }

        // Reusable: Populate a select with E.164 country calling codes (codes only)
        function populateCountryCodeSelect(selectId) {
            const E164_CODES = [
                "+1","+7","+20","+27","+30","+31","+32","+33","+34","+36","+39",
                "+40","+41","+43","+44","+45","+46","+47","+48","+49","+51","+52",
                "+53","+54","+55","+56","+57","+58","+60","+61","+62","+63","+64",
                "+65","+66","+81","+82","+84","+86","+90","+91","+92","+93","+94",
                "+95","+98","+211","+212","+213","+216","+218","+220","+221","+222",
                "+223","+224","+225","+226","+227","+228","+229","+230","+231","+232",
                "+233","+234","+235","+236","+237","+238","+239","+240","+241","+242",
                "+243","+244","+245","+246","+248","+249","+250","+251","+252","+253",
                "+254","+255","+256","+257","+258","+260","+261","+262","+263","+264",
                "+265","+266","+267","+268","+269","+290","+291","+297","+298","+299",
                "+350","+351","+352","+353","+354","+355","+356","+357","+358","+359",
                "+370","+371","+372","+373","+374","+375","+376","+377","+378","+379",
                "+380","+381","+382","+383","+385","+386","+387","+389","+420","+421",
                "+423","+500","+501","+502","+503","+504","+505","+506","+507","+508",
                "+509","+590","+591","+592","+593","+594","+595","+596","+597","+598",
                "+599","+670","+672","+673","+674","+675","+676","+677","+678","+679",
                "+680","+681","+682","+683","+685","+686","+687","+688","+689","+690",
                "+691","+692","+850","+852","+853","+855","+856","+870","+871","+872",
                "+873","+874","+875","+876","+877","+878","+879","+880","+881","+882",
                "+883","+886","+888","+960","+961","+962","+963","+964","+965","+966",
                "+967","+968","+970","+971","+972","+973","+974","+975","+976","+977",
                "+978","+979","+991","+992","+993","+994","+995","+996","+998"
            ];
            const select = document.getElementById(selectId);
            if (!select) return;
            const previous = select.value;
            // Preserve a placeholder if present
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = 'Select';
            select.innerHTML = '';
            select.appendChild(placeholder);
            E164_CODES.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = code;
                select.appendChild(opt);
            });
            // Try to restore previous selection if still valid
            if (previous && E164_CODES.includes(previous)) {
                select.value = previous;
            }
        }

        // Make functions globally available
        window.closeModal = closeModal;
        // Enhanced quota adjustment functions
        function adjustQuota(type, change) {
            let input, minValue, maxValue;
            
            if (type === 'users') {
                input = document.getElementById('userQuotaInput');
                // Get current quota from companyManagement instance
                const currentQuota = window.companyManagement && window.companyManagement.companyData ? 
                    (window.companyManagement.companyData.userQuota || 1) : 1;
                minValue = currentQuota; // Cannot go below current quota
                maxValue = 10000;
            } else if (type === 'features') {
                input = document.getElementById('featuresQuotaInput');
                minValue = 1;
                maxValue = 10;
            }
            
            if (!input) return;
            
            const currentValue = parseInt(input.value) || 0;
            const newValue = Math.max(minValue, Math.min(maxValue, currentValue + change));
            
            // Show notification if trying to decrease user quota below current limit
            if (type === 'users' && change < 0 && currentValue <= minValue) {
                if (window.companyManagement) {
                    window.companyManagement.showNotification(`Cannot decrease user quota below current limit of ${minValue} users. You can only increase the quota.`, 'warning');
                }
                return;
            }
            
            input.value = newValue;
            updatePricingPreview();
            
            // Update button states
            if (window.companyManagement && typeof window.companyManagement.updateQuotaButtonStates === 'function') {
                window.companyManagement.updateQuotaButtonStates();
            }
            
            // Add visual feedback
            input.style.transform = 'scale(1.05)';
            setTimeout(() => {
                input.style.transform = 'scale(1)';
            }, 150);
        }

        function updatePricingPreview() {
            const userCount = parseInt(document.getElementById('userQuotaInput').value) || 0;
            const featureCount = window.companyManagement ? window.companyManagement.getSelectedFeaturesCount() : 0;
            
            const pricePerUser = 25;
            
            // Calculate UPDATED pricing
            const baseCost = userCount * pricePerUser;
            
            // Calculate features cost based on individual feature prices from Firebase
            let featuresCost = 0;
            if (window.companyManagement && window.companyManagement.selectedFeatures && window.companyManagement.platformFeatures) {
                window.companyManagement.selectedFeatures.forEach(selectedFeatureId => {
                    const feature = window.companyManagement.platformFeatures.find(f => f.id === selectedFeatureId);
                    if (feature && feature.price) {
                        featuresCost += parseFloat(feature.price) * userCount;
                    }
                });
            }
            
            const totalCost = baseCost + featuresCost;
            
            // Calculate CURRENT pricing (from existing company data)
            let currentUserCount = 0;
            let currentFeaturesCost = 0;
            let currentBaseCost = 0;
            let currentTotal = 0;
            
            if (window.companyManagement && window.companyManagement.companyData) {
                const companyData = window.companyManagement.companyData;
                
                // Current user count
                currentUserCount = companyData.userQuota || 0;
                currentBaseCost = currentUserCount * pricePerUser;
                
                // Current features cost
                if (companyData.selectedFeatures && Array.isArray(companyData.selectedFeatures) && window.companyManagement.platformFeatures) {
                    companyData.selectedFeatures.forEach(featureId => {
                        const feature = window.companyManagement.platformFeatures.find(f => f.id === featureId);
                        if (feature && feature.price) {
                            currentFeaturesCost += parseFloat(feature.price) * currentUserCount;
                        }
                    });
                }
                
                currentTotal = currentBaseCost + currentFeaturesCost;
            }
            
            // Update CURRENT pricing displays
            document.getElementById('currentBaseCostDisplay').textContent = `$${currentBaseCost.toLocaleString()}/month`;
            document.getElementById('currentFeaturesCostDisplay').textContent = `$${currentFeaturesCost.toLocaleString()}/month`;
            document.getElementById('currentMonthlyFee').textContent = `$${currentTotal.toLocaleString()}/month`;
            
            // Create current pricing breakdown
            let currentBreakdownText = `${currentUserCount} users × $${pricePerUser}`;
            if (currentFeaturesCost > 0 && window.companyManagement && window.companyManagement.companyData.selectedFeatures) {
                currentBreakdownText += ` + Features: `;
                const currentFeatureBreakdowns = [];
                window.companyManagement.companyData.selectedFeatures.forEach(featureId => {
                    const feature = window.companyManagement.platformFeatures.find(f => f.id === featureId);
                    if (feature && feature.price) {
                        currentFeatureBreakdowns.push(`${feature.name || featureId}($${feature.price})`);
                    }
                });
                currentBreakdownText += currentFeatureBreakdowns.join(' + ');
                currentBreakdownText += ` × ${currentUserCount} users`;
            }
            document.getElementById('currentPriceBreakdownText').textContent = currentBreakdownText;
            
            // Update UPDATED pricing displays
            document.getElementById('baseCostDisplay').textContent = `$${baseCost.toLocaleString()}/month`;
            document.getElementById('featuresCostDisplay').textContent = `$${featuresCost.toLocaleString()}/month`;
            document.getElementById('newMonthlyFee').textContent = `$${totalCost.toLocaleString()}/month`;
            
            // Create detailed breakdown showing individual feature prices
            let breakdownText = `${userCount} users × $${pricePerUser}`;
            if (featuresCost > 0 && window.companyManagement && window.companyManagement.selectedFeatures) {
                breakdownText += ` + Features: `;
                const featureBreakdowns = [];
                window.companyManagement.selectedFeatures.forEach(selectedFeatureId => {
                    const feature = window.companyManagement.platformFeatures.find(f => f.id === selectedFeatureId);
                    if (feature && feature.price) {
                        featureBreakdowns.push(`${feature.name || selectedFeatureId}($${feature.price})`);
                    }
                });
                breakdownText += featureBreakdowns.join(' + ');
                breakdownText += ` × ${userCount} users`;
            }
            document.getElementById('priceBreakdownText').textContent = breakdownText;
            
            // Calculate and show price difference
            const difference = totalCost - currentTotal;
            const differenceElement = document.getElementById('priceDifference');
            
            if (difference !== 0) {
                differenceElement.style.display = 'inline-flex';
                const sign = difference > 0 ? '+' : '';
                const arrow = difference > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                const color = difference > 0 ? '#dc3545' : '#28a745';
                
                differenceElement.innerHTML = `
                    <i class="fas ${arrow}"></i>
                    <span>${sign}$${Math.abs(difference).toLocaleString()}/month from current</span>
                `;
                differenceElement.style.backgroundColor = `${color}20`;
                differenceElement.style.color = color;
            } else {
                differenceElement.style.display = 'none';
            }
            
            // Update comparison summary
            const monthlyChange = difference;
            const annualChange = difference * 12;
            
            const monthlyChangeSummary = document.getElementById('monthlyChangeSummary');
            const annualChangeSummary = document.getElementById('annualChangeSummary');
            
            if (monthlyChangeSummary) {
                const monthlySign = monthlyChange > 0 ? '+' : '';
                monthlyChangeSummary.textContent = `${monthlySign}$${Math.abs(monthlyChange).toLocaleString()}/month`;
                monthlyChangeSummary.className = 'comparison-value ' + 
                    (monthlyChange > 0 ? 'positive' : monthlyChange < 0 ? 'negative' : 'neutral');
            }
            
            if (annualChangeSummary) {
                const annualSign = annualChange > 0 ? '+' : '';
                annualChangeSummary.textContent = `${annualSign}$${Math.abs(annualChange).toLocaleString()}/year`;
                annualChangeSummary.className = 'comparison-value ' + 
                    (annualChange > 0 ? 'positive' : annualChange < 0 ? 'negative' : 'neutral');
            }
        }

        function viewBillingHistory() {
            // Scroll to billing history section or show it if hidden
            const billingSection = document.querySelector('[data-tab="subscription"]');
            if (billingSection) {
                billingSection.click();
                setTimeout(() => {
                    const billingTable = document.getElementById('billingHistoryBody');
                    if (billingTable) {
                        billingTable.closest('.card').scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }
                }, 300);
            }
        }

        function manageBilling() {
            // Open billing management modal or redirect
            alert('Billing management feature coming soon!');
            // This would typically open a modal or navigate to billing settings
        }

        // Make functions globally available
        window.adjustQuota = adjustQuota;
        window.updatePricingPreview = updatePricingPreview;
        window.updateSelectedFeaturesDisplay = function() {
            if (window.companyManagement && window.companyManagement.updateSelectedFeaturesDisplay) {
                window.companyManagement.updateSelectedFeaturesDisplay();
            }
        };
        window.viewBillingHistory = viewBillingHistory;
        window.manageBilling = manageBilling;
        window.showAddUserModal = showAddUserModal;
        window.populateAddUserModalDropdowns = populateAddUserModalDropdowns;
        window.checkUserQuota = checkUserQuota;
        window.updateAddUserButtonState = updateAddUserButtonState;
        window.showQuotaExceededNotification = showQuotaExceededNotification;
        window.openUserDetailsModal = openUserDetailsModal;
        window.populateModalHeader = populateModalHeader;
        window.populateOverviewTab = populateOverviewTab;
        window.clearTabsContent = clearTabsContent;
        window.switchUserTab = switchUserTab;
        window.loadUserActivity = loadUserActivity;
        window.loadUserSettings = loadUserSettings;
        window.editUserFromDetails = editUser;
        window.editUser = editUser;
        window.loadUserDataFromFirebase = loadUserDataFromFirebase;
        window.getCurrentUserDataFromModal = getCurrentUserDataFromModal;
        window.populateEditUserModal = populateEditUserModal;
        // Add new edit modal dropdown population function
        window.populateEditUserModalDropdowns = function() {
            if (window.companyManagement && window.companyManagement.populateEditUserModalDropdowns) {
                return window.companyManagement.populateEditUserModalDropdowns();
            }
        };

        // Save User Changes Function - Updates user details in company-scoped Firebase
        async function saveUserChanges() {
            console.log('🔄 Starting save user changes process...');
            
            const form = document.getElementById('editUserForm');
            if (!form) {
                console.error('❌ Edit user form not found');
                showNotification('Error: Form not found', 'error');
                return;
            }

            const saveButton = form.querySelector('.btn-primary');
            const loadingSpan = saveButton.querySelector('.loading');
            const normalTextSpan = saveButton.querySelector('.normal-text');

            try {
                // Show loading state
                saveButton.disabled = true;
                loadingSpan.style.display = 'inline-flex';
                normalTextSpan.style.display = 'none';

                // Get current user being edited
                if (!window.currentEditingUser) {
                    throw new Error('No user selected for editing');
                }

                // Handle both uid and id properties for Firebase compatibility
                const userId = window.currentEditingUser.uid || window.currentEditingUser.id;
                if (!userId) {
                    throw new Error('No user ID found for editing');
                }
                
                console.log('📝 Updating user:', userId);
                console.log('👤 Current editing user data:', window.currentEditingUser);

                // Get company ID from company management instance
                let companyId = null;
                let currentUser = null;

                if (window.companyManagement) {
                    companyId = window.companyManagement.companyId || window.companyManagement.getCurrentCompanyId();
                    currentUser = window.companyManagement.currentUser;
                    console.log('🏢 Company ID from companyManagement:', companyId);
                    console.log('👤 Current user from companyManagement:', currentUser);
                }

                // Fallback: try to get from localStorage
                if (!companyId || !currentUser) {
                    console.log('🔄 Trying fallback methods for company ID and user...');
                    
                    try {
                        const storedUser = localStorage.getItem('currentUser');
                        if (storedUser) {
                            const userData = JSON.parse(storedUser);
                            companyId = userData.companyId;
                            currentUser = userData;
                            console.log('💾 Found data in localStorage - Company ID:', companyId);
                        }
                    } catch (error) {
                        console.warn('⚠️ Could not parse localStorage currentUser:', error);
                    }
                }

                // Final validation
                if (!companyId) {
                    throw new Error('No company ID found. Please refresh the page and try again.');
                }

                if (!currentUser || (!currentUser.uid && !currentUser.id)) {
                    throw new Error('No current user found. Please refresh the page and try again.');
                }

                // Collect form data - capture ALL form fields exactly as they are with proper processing
                const formData = new FormData(form);
                
                // Debug: Log all form fields
                console.log('🔍 Raw FormData entries:');
                for (let [key, value] of formData.entries()) {
                    console.log(`  ${key}: "${value}"`);
                }

                // Helper function to get line manager name from dropdown display text
                const getLineManagerNameFromDropdown = (selectId) => {
                    const selectElement = document.getElementById(selectId);
                    if (!selectElement || !selectElement.value) {
                        console.log(`⚠️ Line manager dropdown empty or not found: ${selectId}`);
                        return '';
                    }
                    
                    const selectedOption = selectElement.options[selectElement.selectedIndex];
                    if (selectedOption && selectedOption.value !== '') {
                        // Extract just the name part from the display text (remove job title/department in parentheses)
                        const displayText = selectedOption.textContent || selectedOption.text;
                        const lineManagerName = displayText.split(' (')[0].trim(); // Get name before any parentheses
                        console.log(`📋 Line manager selected: ID=${selectElement.value}, Name="${lineManagerName}"`);
                        return lineManagerName;
                    }
                    
                    return '';
                };
                
                const updatedUserData = {
                    // Basic Information
                    firstName: formData.get('editUserFirstName')?.trim(),
                    lastName: formData.get('editUserLastName')?.trim(),
                    name: `${(formData.get('editUserFirstName')||'').trim()} ${(formData.get('editUserLastName')||'').trim()}`.trim(),
                    email: formData.get('editUserEmail')?.trim(),
                    employeeId: formData.get('editUserEmployeeId')?.trim(),
                    
                    // Contact Information
                    phone: formData.get('editUserPhone')?.trim(),
                    countryCode: formData.get('editUserCountryCode')?.trim(),
                    address: formData.get('editUserAddress')?.trim(),
                    
                    // Work Information
                    jobTitle: formData.get('editUserJobTitle')?.trim(),
                    department: formData.get('editUserDepartment')?.trim(),
                    lineManager: getLineManagerNameFromDropdown('editUserLineManager'), // Use proper name extraction
                    lineManagerId: formData.get('editUserLineManager')?.trim(), // Store ID for reference
                    role: formData.get('editUserRole')?.trim(),
                    status: formData.get('editUserStatus')?.trim(),
                    
                    // System fields
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.uid || currentUser.id
                };

                // Parse employing company/subcontractor selection from edit modal
                try {
                    const companyAffSelect = document.getElementById('editUserCompanyAffiliation');
                    if (companyAffSelect && companyAffSelect.value) {
                        const parsed = JSON.parse(companyAffSelect.value);
                        if (parsed && parsed.id) {
                            updatedUserData.employerCompanyType = parsed.type || 'main';
                            updatedUserData.employerCompanyId = parsed.id;
                            updatedUserData.employerCompanyName = parsed.name || '';
                        }
                    }
                } catch (e) {
                    console.warn('⚠️ Could not parse editUserCompanyAffiliation value');
                }

                console.log('📝 Collected form data:', updatedUserData);
                console.log('🔍 Line manager processing: ID="' + updatedUserData.lineManagerId + '", Name="' + updatedUserData.lineManager + '"');

                console.log('📝 Collected form data:', updatedUserData);

                // Validate required fields (conditional when reporting-only user)
                const isReportingOnlyUser = (window.currentEditingUser?.accountType === 'without-account') || (window.currentEditingUser?.reportingOnly === true) || (window.currentEditingUser?.canSignIn === false) || !window.currentEditingUser?.authUid;
                const convertCheckbox = document.getElementById('convertToWithAccount');
                const wantsConversion = !!(convertCheckbox && convertCheckbox.checked);

                const baseRequired = ['firstName', 'lastName', 'role'];
                const emailRequired = !isReportingOnlyUser || wantsConversion; // email required if already sign-in user or converting now

                for (const field of baseRequired) {
                    if (!updatedUserData[field]) {
                        throw new Error(`${field.charAt(0).toUpperCase() + field.slice(1)} is required`);
                    }
                }
                // If converting now, we'll validate the email in the conversion section instead of the main email field
                if (emailRequired && !wantsConversion) {
                    if (!updatedUserData.email) {
                        throw new Error('Email is required');
                    }
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(updatedUserData.email)) {
                        throw new Error('Please enter a valid email address');
                    }
                }

                // Clean up data - convert empty strings to empty strings (not null/undefined)
                Object.keys(updatedUserData).forEach(key => {
                    if (updatedUserData[key] === null || updatedUserData[key] === undefined) {
                        updatedUserData[key] = '';
                    }
                });

                console.log('📊 Final updated user data to save:', updatedUserData);

                // Update user in company-scoped Firebase path
                const userRef = firebase.database().ref(`companies/${companyId}/users/${userId}`);
                
                // Get current user data to preserve fields not in the form
                const currentUserSnapshot = await userRef.once('value');
                const currentUserData = currentUserSnapshot.val() || {};

                console.log('📖 Current user data from Firebase:', currentUserData);

                // Merge updated data with existing data, giving priority to form data
                const mergedUserData = {
                    ...currentUserData,
                    ...updatedUserData
                };

                // Only remove undefined values, preserve empty strings as they represent form data
                Object.keys(mergedUserData).forEach(key => {
                    if (mergedUserData[key] === undefined) {
                        delete mergedUserData[key];
                    }
                });

                console.log('💾 Saving merged user data to Firebase:', mergedUserData);
                console.log('🔍 Employee ID being saved:', mergedUserData.employeeId);
                console.log('🔍 Line Manager being saved:', mergedUserData.lineManager);
                console.log('🔍 Line Manager ID being saved:', mergedUserData.lineManagerId);

                // If converting reporting-only user to sign-in account, process that first
                if (isReportingOnlyUser && wantsConversion) {
                    const convertEmailInput = document.getElementById('convertEmail');
                    const convertPasswordInput = document.getElementById('convertPassword');
                    const convertPasswordConfirmInput = document.getElementById('convertPasswordConfirm');
                    const email = (convertEmailInput?.value || updatedUserData.email || '').trim();
                    const password = (convertPasswordInput?.value || '').trim();
                    const password2 = (convertPasswordConfirmInput?.value || '').trim();

                    if (!email) throw new Error('Login Email is required to convert this user');
                    const emailRegex2 = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex2.test(email)) throw new Error('Enter a valid login email for conversion');
                    if (!password || password.length < 6) throw new Error('Password must be at least 6 characters');
                    if (password !== password2) throw new Error('Passwords do not match');

                    // Call backend callable to create auth user with existing UID
                    if (!firebase.functions) {
                        throw new Error('Firebase Functions SDK not available');
                    }

                    // Helper: call createAuthUser with region fallback
                    const callCreateAuthUser = async (payload) => {
                        // Allow override via window.FUNCTIONS_REGION or localStorage('functionsRegion')
                        const preferred = (typeof window !== 'undefined' && window.FUNCTIONS_REGION) ? window.FUNCTIONS_REGION : (localStorage.getItem('functionsRegion') || null);
                        const candidatesRaw = [preferred, null, 'us-central1', 'europe-west1', 'asia-south1', 'asia-southeast1', 'asia-northeast1'];
                        const regions = candidatesRaw.filter((r, idx) => candidatesRaw.indexOf(r) === idx); // de-dup
                        let lastErr = null;
                        for (const region of regions) {
                            try {
                                const fn = region ? firebase.app().functions(region) : firebase.functions();
                                const callable = fn.httpsCallable('createAuthUser');
                                console.log(`🔐 Attempting conversion via ${region || 'default'} region...`);
                                const res = await callable(payload);
                                console.log(`✅ Conversion succeeded via ${region || 'default'} region`);
                                return res;
                            } catch (e) {
                                lastErr = e;
                                const code = e?.code || (e?.details && e.details.code) || 'unknown';
                                console.warn(`⚠️ Conversion via ${region || 'default'} region failed:`, code, e?.message || e);
                                // For region issues, we try the next region; for explicit client errors, break early
                                if (code && !['internal','not-found','unavailable','failed-precondition'].includes(code)) {
                                    break;
                                }
                            }
                        }
                        throw lastErr || new Error('Failed to call conversion function');
                    };

                    try {
                        console.log('🔐 Converting user to sign-in account via callable (with region fallback)...');
                        const res = await callCreateAuthUser({ uid: userId, email, password, displayName: mergedUserData.name || undefined, companyId });
                        console.log('✅ Conversion result:', res?.data || res);
                        // Update mergedUserData flags to reflect sign-in account
                        mergedUserData.email = email;
                        mergedUserData.accountType = 'with-account';
                        mergedUserData.canSignIn = true;
                        mergedUserData.reportingOnly = false;
                        mergedUserData.authUid = userId;
                    } catch (convErr) {
                        console.error('❌ Conversion failed:', convErr);
                        const code = convErr?.code || (convErr?.details && convErr.details.code) || '';
                        const rawMsg = convErr?.message || '';
                        let friendly = 'Failed to convert user';
                        if (code === 'already-exists' || /email-already-in-use/i.test(rawMsg)) {
                            friendly = 'Email already in use';
                        } else if (code === 'permission-denied') {
                            friendly = 'Permission denied for conversion';
                        } else if (code === 'not-found') {
                            friendly = 'Conversion service not found. Please deploy createAuthUser.';
                        } else if (code === 'internal' || /internal/i.test(rawMsg)) {
                            friendly = 'Conversion service error (likely wrong region or backend error)';
                        }
                        // Surface both friendly and technical code to help triage
                        throw new Error(`${friendly}${code ? ` [${code}]` : ''}`);
                    }
                }

                // Save to Firebase after potential conversion
                await userRef.set(mergedUserData);

                // Also update global users path for consistency
                try {
                    const globalUserRef = firebase.database().ref(`users/${userId}`);
                    const globalSnapshot = await globalUserRef.once('value');
                    if (globalSnapshot.exists()) {
                        await globalUserRef.update({
                            name: mergedUserData.name || '',
                            firstName: mergedUserData.firstName || '',
                            lastName: mergedUserData.lastName || '',
                            email: mergedUserData.email || '',
                            employeeId: mergedUserData.employeeId || '',
                            department: mergedUserData.department || '',
                            jobTitle: mergedUserData.jobTitle || '',
                            countryCode: mergedUserData.countryCode || '',
                            phone: mergedUserData.phone || '',
                            lineManager: mergedUserData.lineManager || '',
                            lineManagerId: mergedUserData.lineManagerId || '',
                            address: mergedUserData.address || '',
                            role: mergedUserData.role || '',
                            status: mergedUserData.status || '',
                            employerCompanyType: mergedUserData.employerCompanyType || 'main',
                            employerCompanyId: mergedUserData.employerCompanyId || (window.companyManagement?.companyId || ''),
                            employerCompanyName: mergedUserData.employerCompanyName || (window.companyManagement?.companyData?.companyName || ''),
                            accountType: mergedUserData.accountType || '',
                            canSignIn: (typeof mergedUserData.canSignIn === 'boolean') ? mergedUserData.canSignIn : undefined,
                            reportingOnly: (typeof mergedUserData.reportingOnly === 'boolean') ? mergedUserData.reportingOnly : undefined,
                            authUid: mergedUserData.authUid || undefined,
                            updatedAt: mergedUserData.updatedAt || new Date().toISOString(),
                            updatedBy: mergedUserData.updatedBy || (currentUser.uid || currentUser.id)
                        });
                        console.log('✅ Global user path also updated with employer company fields');
                    }
                } catch (globalErr) {
                    console.warn('⚠️ Failed to update global users path (non-critical):', globalErr);
                }

                console.log('✅ User updated successfully in Firebase');

                // Update the global editing user object
                window.currentEditingUser = { ...window.currentEditingUser, ...mergedUserData };

                // Show success message
                showNotification('User updated successfully!', 'success');

                // Close modal after a short delay
                setTimeout(() => {
                    closeModal('editUserModal');
                    
                    // Refresh users table if the company management instance is available
                    if (window.companyManagement && window.companyManagement.loadUsers) {
                        window.companyManagement.loadUsers();
                    }
                }, 1500);

            } catch (error) {
                console.error('❌ Error saving user changes:', error);
                showNotification(`Error saving user: ${error.message}`, 'error');
            } finally {
                // Hide loading state
                saveButton.disabled = false;
                loadingSpan.style.display = 'none';
                normalTextSpan.style.display = 'inline-flex';
            }
        }

        // Make saveUserChanges globally available
        window.saveUserChanges = saveUserChanges;

        // User Details Modal Functions
        async function openUserDetailsModal(userId, userData = null) {
            const modal = document.getElementById('userDetailsModal');
            if (!modal) {
                console.error('User details modal not found');
                return;
            }

            console.log('🔄 Opening user details modal for userId:', userId);
            console.log('📋 Ensuring same data loading path as edit modal');

            try {
                // Always load fresh data from Firebase using the same function as edit modal
                let freshUserData;
                
                if (userId) {
                    console.log('📡 Loading fresh user data from Firebase (same path as edit modal)...');
                    freshUserData = await loadUserDataFromFirebase(userId);
                    console.log('✅ Fresh user data loaded from company-scoped path:', freshUserData);
                } else if (userData) {
                    console.log('📋 Using provided user data...');
                    freshUserData = userData;
                } else {
                    console.error('❌ No user ID or data provided');
                    return;
                }

                // Store the current user ID in the modal for reference
                modal.setAttribute('data-current-user-id', userId || freshUserData.id);

                // Store fresh data globally for consistency
                window.currentEditingUser = {
                    uid: freshUserData.id || freshUserData.uid,
                    id: freshUserData.id || freshUserData.uid,
                    ...freshUserData
                };

                // Populate modal header
                populateModalHeader(freshUserData);

                // Populate overview tab with fresh data
                populateOverviewTab(freshUserData);

                // Clear other tabs content
                clearTabsContent();

                // Set active tab to overview
                switchUserTab('overview');

                // Show the modal
                modal.classList.add('show');
                console.log('✅ User details modal opened with fresh data from same path as edit modal');

                // Load additional data for other tabs
                loadUserActivity(userId || freshUserData.id);
                loadUserSettings(userId || freshUserData.id);
                
            } catch (error) {
                console.error('❌ Error opening user details modal:', error);
                alert('Error loading user data: ' + error.message);
            }
        }

        function populateModalHeader(userData) {
            // Set user avatar
            const avatar = document.getElementById('modalUserAvatar');
            if (avatar && userData.name) {
                const initials = userData.name.split(' ').map(n => n[0]).join('').toUpperCase();
                avatar.textContent = initials;
            }

            // Set user name and email
            const nameElement = document.getElementById('modalUserName');
            const emailElement = document.getElementById('modalUserEmail');
            
            if (nameElement) nameElement.textContent = userData.name || 'Unknown User';
            if (emailElement) emailElement.textContent = userData.email || '';
        }

        function populateOverviewTab(userData) {
            console.log('🔄 Populating overview tab with user data:', userData);
            console.log('📋 Using same data structure as edit modal for consistency');
            
            // Basic Information - same fields as edit modal
            const basicInfoFields = {
                'detailFullName': userData.name || '-',
                'detailEmail': userData.email || '-',
                'detailEmployeeId': userData.employeeId || userData.id || '-',
                'detailDepartment': userData.department || '-',
                'detailJobTitle': userData.jobTitle || '-',
                'detailPhone': userData.phone || '-',
                'detailCountryCode': userData.countryCode || '-',
                'detailAddress': userData.address || '-',
                'detailLineManager': userData.lineManager || userData.lineManagerName || '-'
            };

            Object.entries(basicInfoFields).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    console.log(`✅ Set ${id}:`, value);
                } else {
                    console.warn(`⚠️ Element not found: ${id}`);
                }
            });

            console.log('✅ All basic information fields populated with same data as edit modal');

            // Account Status
            const statusElement = document.getElementById('detailStatus');
            if (statusElement) {
                const statusBadge = statusElement;
                statusBadge.textContent = userData.status || 'Active';
                statusBadge.className = 'status-badge';
                
                // Add appropriate status class
                const status = (userData.status || 'active').toLowerCase();
                if (status === 'active') {
                    statusBadge.classList.add('active');
                } else if (status === 'inactive') {
                    statusBadge.classList.add('inactive');
                } else if (status === 'suspended') {
                    statusBadge.classList.add('suspended');
                }
            }

            // Role
            const roleElement = document.getElementById('detailRole');
            if (roleElement) {
                console.log('Updating role element with role:', userData.role);
                
                // Use the exact same display logic as the dropdown to ensure consistency
                let roleDisplayName = 'User'; // Default fallback
                if (window.companyManagement && window.companyManagement.companyRoles && window.companyManagement.companyRoles[userData.role]) {
                    const roleData = window.companyManagement.companyRoles[userData.role];
                    roleDisplayName = roleData.name || roleData.roleName || userData.role;
                } else {
                    // Fallback to getRoleDisplayName if companyRoles not available
                    roleDisplayName = getRoleDisplayName(userData.role);
                }
                
                console.log('Role display name:', roleDisplayName);
                roleElement.textContent = roleDisplayName;
                roleElement.setAttribute('data-role-id', userData.role || 'user'); // Store actual role ID
                roleElement.className = 'role-badge';
                
                // Add appropriate role class using helper function
                const roleClass = getRoleClass(userData.role);
                console.log('Role CSS class:', roleClass);
                roleElement.classList.add(roleClass);
            }

            // Dates
            const createdElement = document.getElementById('detailCreatedDate');
            if (createdElement) {
                const createdDate = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString() : '-';
                createdElement.textContent = createdDate;
            }

            const lastLoginElement = document.getElementById('detailLastLogin');
            if (lastLoginElement) {
                const lastLogin = userData.lastLogin ? new Date(userData.lastLogin).toLocaleDateString() : 'Never';
                lastLoginElement.textContent = lastLogin;
            }

            // Update toggle status button
            const toggleStatusBtn = document.getElementById('toggleStatusText');
            if (toggleStatusBtn) {
                const currentStatus = (userData.status || 'active').toLowerCase();
                toggleStatusBtn.textContent = currentStatus === 'active' ? 'Deactivate' : 'Activate';
            }
        }

        function clearTabsContent() {
            // Clear activity content
            const activityLog = document.getElementById('userActivityLog');
            if (activityLog) {
                activityLog.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading activity...</div>';
            }

            // Clear settings content
            const settingsForm = document.getElementById('userSettingsForm');
            if (settingsForm) {
                settingsForm.innerHTML = '<div class="loading-state"><i class="fas fa-spinner fa-spin"></i> Loading settings...</div>';
            }
        }

        function switchUserTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.user-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.user-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Add active class to selected tab button
            const selectedBtn = document.querySelector(`.user-tab-btn[onclick*="${tabName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
        }

        function loadUserActivity(userId) {
            const activityLog = document.getElementById('userActivityLog');
            if (!activityLog) return;

            // Simulate loading activity (replace with actual Firebase call)
            setTimeout(() => {
                const activityHTML = `
                    <div class="activity-log">
                        <div class="activity-item">
                            <div class="activity-icon login">
                                <i class="fas fa-sign-in-alt"></i>
                            </div>
                            <div class="activity-details">
                                <div class="activity-title">User Login</div>
                                <div class="activity-description">Successful login from Chrome browser</div>
                                <div class="activity-timestamp">2 hours ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon update">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="activity-details">
                                <div class="activity-title">Profile Updated</div>
                                <div class="activity-description">Updated phone number and department</div>
                                <div class="activity-timestamp">1 day ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon create">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div class="activity-details">
                                <div class="activity-title">Training Request</div>
                                <div class="activity-description">Submitted new safety training request</div>
                                <div class="activity-timestamp">3 days ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon logout">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <div class="activity-details">
                                <div class="activity-title">User Logout</div>
                                <div class="activity-description">Logged out from previous session</div>
                                <div class="activity-timestamp">4 days ago</div>
                            </div>
                        </div>
                    </div>
                `;
                activityLog.innerHTML = activityHTML;
            }, 1000);
        }

        function loadUserSettings(userId) {
            const settingsForm = document.getElementById('userSettingsForm');
            if (!settingsForm) return;

            // Simulate loading settings (replace with actual Firebase call)
            setTimeout(() => {
                const settingsHTML = `
                    <div class="settings-section">
                        <h5>Notification Preferences</h5>
                        <div class="setting-item">
                            <div class="setting-label">
                                <div class="setting-name">Email Notifications</div>
                                <div class="setting-description">Receive notifications via email</div>
                            </div>
                            <div class="setting-control">
                                <div class="toggle-switch active" onclick="toggleSetting(this)"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <div class="setting-name">SMS Notifications</div>
                                <div class="setting-description">Receive notifications via SMS</div>
                            </div>
                            <div class="setting-control">
                                <div class="toggle-switch" onclick="toggleSetting(this)"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h5>Security Settings</h5>
                        <div class="setting-item">
                            <div class="setting-label">
                                <div class="setting-name">Two-Factor Authentication</div>
                                <div class="setting-description">Add extra security to your account</div>
                            </div>
                            <div class="setting-control">
                                <div class="toggle-switch" onclick="toggleSetting(this)"></div>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <div class="setting-name">Session Timeout</div>
                                <div class="setting-description">Auto-logout after inactivity</div>
                            </div>
                            <div class="setting-control">
                                <div class="toggle-switch active" onclick="toggleSetting(this)"></div>
                            </div>
                        </div>
                    </div>
                `;
                settingsForm.innerHTML = settingsHTML;
            }, 1200);
        }

        function toggleSetting(element) {
            element.classList.toggle('active');
            // Here you would save the setting to Firebase
            console.log('Setting toggled:', element.classList.contains('active'));
        }

        // Global variable to store current user data being edited
        let currentEditingUser = null;

        // Function to load complete user data from Firebase
        async function loadUserDataFromFirebase(userId) {
            try {
                console.log('🔍 Loading user data from Firebase for userId:', userId);
                
                if (!window.companyManagement) {
                    throw new Error('Company management system not available');
                }
                
                const companyId = window.companyManagement.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                const db = window.companyManagement.db;
                if (!db) {
                    throw new Error('Database connection not available');
                }
                
                // Import Firebase functions
                const { ref, get } = await import('./js/firebase-config.js');
                
                // Try primary path first (exact user ID)
                const userPath = `companies/${companyId}/users/${userId}`;
                const userRef = firebase.database().ref(userPath);
                
                console.log('📍 Primary attempt - Loading user data from path:', userPath);
                console.log('🔗 Firebase URL:', `https://users-8be65-default-rtdb.firebaseio.com/${userPath}`);
                console.log('🏢 Company ID:', companyId);
                console.log('👤 User ID:', userId);
                
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    console.log('✅ Complete user data loaded from Firebase (primary path):', userData);
                    console.log('🔍 Employee ID from Firebase:', userData.employeeId);
                    console.log('✅ Confirmed loading from company-scoped path only');
                    
                    // Return data with userId included
                    const fullUserData = { 
                        id: userId, 
                        ...userData 
                    };
                    
                    console.log('📋 Final user data for editing:', fullUserData);
                    console.log('🔍 Final Employee ID value:', fullUserData.employeeId);
                    return fullUserData;
                } else {
                    console.warn('⚠️ User not found at primary path, attempting alternative search...');
                    
                    // Fallback: Search all users in the company to find by email
                    const allUsersPath = `companies/${companyId}/users`;
                    const allUsersRef = firebase.database().ref(allUsersPath);
                    const allUsersSnapshot = await allUsersRef.once('value');
                    
                    if (allUsersSnapshot.exists()) {
                        const allUsers = allUsersSnapshot.val();
                        console.log('🔍 Searching through all company users for match...');
                        
                        // If userId looks like an email-based ID, try to find by email
                        if (userId.includes('_') && !userId.includes('@')) {
                            const possibleEmail = userId.replace(/_/g, '.').replace(/(.+)_(.+)_(.+)/, '$1@$2.$3');
                            console.log('🔍 Converted ID to possible email:', possibleEmail);
                            
                            // Search for user with matching email
                            for (const [actualUserId, userData] of Object.entries(allUsers)) {
                                if (userData.email === possibleEmail) {
                                    console.log('✅ Found user by email match!');
                                    console.log('📧 Matched email:', possibleEmail);
                                    console.log('🆔 Actual user ID:', actualUserId);
                                    console.log('📋 User data:', userData);
                                    
                                    return {
                                        id: actualUserId,
                                        ...userData
                                    };
                                }
                            }
                        }
                        
                        // Also try direct email search in case ID was an email
                        if (userId.includes('@')) {
                            for (const [actualUserId, userData] of Object.entries(allUsers)) {
                                if (userData.email === userId) {
                                    console.log('✅ Found user by direct email match!');
                                    console.log('🆔 Actual user ID:', actualUserId);
                                    
                                    return {
                                        id: actualUserId,
                                        ...userData
                                    };
                                }
                            }
                        }
                    }
                    
                    const errorMsg = `User not found in database. Searched path: ${userPath}`;
                    console.error('❌ ' + errorMsg);
                    console.log('🔗 Failed URL:', `https://users-8be65-default-rtdb.firebaseio.com/${userPath}`);
                    console.log('💡 Suggestion: Check that the user ID matches the Firebase database structure');
                    throw new Error(errorMsg);
                }
                
            } catch (error) {
                console.error('❌ Error loading user data from Firebase:', error);
                throw error;
            }
        }

        // Quick Action Functions
        async function editUser(userId = null) {
            console.log('🎯 Edit user function called with userId:', userId);
            
            try {
                let userData;
                
                // If userId is provided (from table button), load from Firebase
                if (userId) {
                    console.log('📡 Loading user data from Firebase for userId:', userId);
                    try {
                        userData = await loadUserDataFromFirebase(userId);
                        console.log('✅ User data loaded successfully:', userData);
                    } catch (firebaseError) {
                        console.error('❌ Failed to load user from Firebase:', firebaseError);
                        alert('Error: Could not load user data from database. ' + firebaseError.message);
                        return;
                    }
                } else {
                    // Fallback: Get the current user data from the details modal
                    console.log('📋 Using user data from details modal...');
                    userData = getCurrentUserDataFromModal();
                    
                    if (!userData) {
                        console.error('❌ Could not retrieve user data for editing');
                        alert('Error: Could not retrieve user data for editing');
                        return;
                    }
                    
                    // If we have user ID, try to load complete data from Firebase
                    if (userData.id) {
                        try {
                            console.log('🔄 Attempting to load complete data for user:', userData.id);
                            userData = await loadUserDataFromFirebase(userData.id);
                        } catch (firebaseError) {
                            console.warn('⚠️ Could not load from Firebase, using modal data:', firebaseError);
                            // Continue with modal data as fallback
                        }
                    }
                }
                
                // Validate we have essential user data
                if (!userData || !userData.email) {
                    console.error('❌ Invalid user data:', userData);
                    alert('Error: Invalid user data - missing required fields');
                    return;
                }
                
                // Store the user data globally for form submission
                window.currentEditingUser = {
                    uid: userData.id || userData.uid,  // Ensure uid is set for Firebase compatibility
                    id: userData.id || userData.uid,   // Keep id as backup
                    ...userData
                };
                console.log('💾 User data prepared for editing:', window.currentEditingUser);
                
                // Close the details modal if open
                closeModal('userDetailsModal');
                
                // Load departments, job titles, line managers, and roles for edit modal
                if (window.companyManagement) {
                    try {
                        console.log('Loading dropdown data for edit modal...');
                        await Promise.all([
                            window.companyManagement.loadDepartmentsForEdit(),
                            window.companyManagement.loadJobTitlesForEdit(),
                            window.companyManagement.loadLineManagersForEdit(),
                            window.companyManagement.loadRolesForEdit()
                        ]);
                        console.log('✅ All dropdown data loaded successfully');
                        
                        // Wait a bit more to ensure DOM is updated
                        await new Promise(resolve => setTimeout(resolve, 200));
                        
                    } catch (error) {
                        console.error('Error loading dropdowns for edit modal:', error);
                    }
                } else {
                    console.warn('Company management system not available for loading dropdowns');
                }
                
                // Populate and show the edit modal
                console.log('🔄 About to populate edit modal with user data...');
                populateEditUserModal(userData);
                
                // Show the edit modal
                console.log('📺 Showing edit modal...');
                const editModal = document.getElementById('editUserModal');
                if (editModal) {
                    editModal.classList.add('show');
                    console.log('✅ Edit modal displayed successfully');
                    
                    // Focus on first input after a short delay
                    setTimeout(() => {
                        const firstInput = editModal.querySelector('input:not([readonly]):not([disabled])');
                        if (firstInput) {
                            firstInput.focus();
                            console.log('🎯 Focused on first input field');
                        }
                    }, 300);
                } else {
                    console.error('❌ Edit modal element not found');
                    alert('Error: Could not display edit modal');
                }
                
            } catch (error) {
                console.error('❌ Error in edit user function:', error);
                alert('Error loading user data for editing: ' + error.message);
            }
        }

        function getCurrentUserDataFromModal() {
            console.log('🔄 Extracting user data from details modal - same structure as edit modal');
            
            // Extract user data from the current modal display - matching edit modal fields exactly
            const userData = {
                id: currentEditingUser?.id || generateUserIdFromName(document.getElementById('modalUserName')?.textContent || ''),
                name: document.getElementById('detailFullName')?.textContent || '',
                email: document.getElementById('detailEmail')?.textContent || '',
                employeeId: document.getElementById('detailEmployeeId')?.textContent || '',
                department: document.getElementById('detailDepartment')?.textContent || '',
                jobTitle: document.getElementById('detailJobTitle')?.textContent || '',
                phone: document.getElementById('detailPhone')?.textContent || '',
                countryCode: document.getElementById('detailCountryCode')?.textContent || '',
                address: document.getElementById('detailAddress')?.textContent || '',
                lineManager: currentEditingUser?.lineManager || '',
                lineManagerName: document.getElementById('detailLineManager')?.textContent || '',
                status: document.getElementById('detailStatus')?.textContent || 'active',
                role: document.getElementById('detailRole')?.getAttribute('data-role-id') || 'user' // Get actual role ID, not display name
            };
            
            // Clean up data (remove dashes and empty values) - same as edit modal
            Object.keys(userData).forEach(key => {
                if (userData[key] === '-' || userData[key] === '') {
                    userData[key] = '';
                }
            });
            
            console.log('✅ Extracted user data (matching edit modal structure):', userData);
            return userData;
        }

        function populateEditUserModal(userData) {
            console.log('Populating edit modal with user data:', userData);
            console.log('🔍 Employee ID value from userData:', userData.employeeId);
            console.log('🔍 Available userData keys:', Object.keys(userData));
            
            // Helper function to safely set element value
            const setElementValue = (elementId, value, defaultValue = '') => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.value = value || defaultValue;
                    console.log(`Set ${elementId}:`, element.value);
                } else {
                    console.warn(`Element not found: ${elementId}`);
                }
            };
            
            // Populate immediate fields (non-dropdown)
            const _firstName = userData.firstName || (userData.name ? userData.name.split(' ')[0] : '');
            const _lastName = userData.lastName || (userData.name ? userData.name.split(' ').slice(1).join(' ') : '');
            setElementValue('editUserFirstName', _firstName);
            setElementValue('editUserLastName', _lastName);
            setElementValue('editUserEmail', userData.email);
            // Handle employee ID - ensure it's properly set even if undefined/null
            const employeeIdValue = userData.employeeId || userData.employee_id || '';
            console.log('🔍 Setting employee ID field with value:', employeeIdValue);
            setElementValue('editUserEmployeeId', employeeIdValue);
            setElementValue('editUserCountryCode', userData.countryCode);
            setElementValue('editUserPhone', userData.phone);
            setElementValue('editUserAddress', userData.address);
            setElementValue('editUserStatus', (userData.status || 'active').toLowerCase());
            
            // Function to populate dropdown with retries
            const populateDropdownWithRetry = (elementId, value, maxRetries = 5, delay = 500) => {
                let attempts = 0;
                
                const tryPopulate = () => {
                    attempts++;
                    const element = document.getElementById(elementId);
                    
                    if (!element) {
                        console.warn(`Element not found: ${elementId}`);
                        return;
                    }
                    
                    const options = element.querySelectorAll('option');
                    console.log(`Attempt ${attempts} for ${elementId}:`, {
                        value: value,
                        optionsCount: options.length,
                        options: Array.from(options).map(opt => ({value: opt.value, text: opt.textContent}))
                    });
                    
                    if (options.length <= 1 && attempts < maxRetries) {
                        // Dropdown not yet populated, retry
                        console.log(`Dropdown ${elementId} not ready, retrying in ${delay}ms...`);
                        setTimeout(tryPopulate, delay);
                        return;
                    }
                    
                    if (!value) {
                        console.log(`No value provided for ${elementId}`);
                        return;
                    }
                    
                    // Try to match by value first, then by text content
                    let matched = false;
                    for (let option of options) {
                        if (option.value === value || option.textContent.trim() === value) {
                            element.value = option.value;
                            matched = true;
                            console.log(`✅ Successfully set ${elementId} to:`, option.value, `(${option.textContent})`);
                            break;
                        }
                    }
                    
                    if (!matched) {
                        console.warn(`❌ Value "${value}" not found in ${elementId} dropdown`);
                        // For debugging: log all available options
                        console.log(`Available options in ${elementId}:`, 
                            Array.from(options).map(opt => `"${opt.value}" (${opt.textContent})`));
                    }
                };
                
                // Start the population attempt
                setTimeout(tryPopulate, delay);
            };
            
            // Populate dropdown fields with retry logic
            populateDropdownWithRetry('editUserDepartment', userData.department);
            populateDropdownWithRetry('editUserJobTitle', userData.jobTitle);
            
            // Special handling for line manager - try ID first, then name matching
            const populateLineManager = () => {
                const lineManagerSelect = document.getElementById('editUserLineManager');
                if (!lineManagerSelect) {
                    console.warn('Line manager dropdown not found');
                    return;
                }
                
                const options = lineManagerSelect.querySelectorAll('option');
                if (options.length <= 1) {
                    console.log('Line manager dropdown not yet populated, retrying...');
                    setTimeout(populateLineManager, 500);
                    return;
                }
                
                console.log('🔍 Populating line manager dropdown...');
                console.log('📋 User data - lineManagerId:', userData.lineManagerId, 'lineManager:', userData.lineManager);
                
                let matched = false;
                
                // First try to match by lineManagerId if available
                if (userData.lineManagerId) {
                    for (let option of options) {
                        if (option.value === userData.lineManagerId) {
                            lineManagerSelect.value = option.value;
                            matched = true;
                            console.log(`✅ Matched line manager by ID: ${option.value} (${option.textContent})`);
                            break;
                        }
                    }
                }
                
                // If no ID match, try to match by name
                if (!matched && userData.lineManager && userData.lineManager !== '-' && userData.lineManager !== '') {
                    for (let option of options) {
                        const optionText = option.textContent || option.text;
                        // Check if the option text starts with the stored line manager name
                        if (optionText.startsWith(userData.lineManager)) {
                            lineManagerSelect.value = option.value;
                            matched = true;
                            console.log(`✅ Matched line manager by name: ${option.value} (${optionText})`);
                            break;
                        }
                    }
                }
                
                if (!matched) {
                    console.warn(`❌ Could not match line manager: ID="${userData.lineManagerId}", Name="${userData.lineManager}"`);
                    console.log('Available line manager options:', 
                        Array.from(options).map(opt => `"${opt.value}" (${opt.textContent})`));
                }
            };
            
            // Start line manager population with delay to ensure dropdown is loaded
            setTimeout(populateLineManager, 100);
            
            populateDropdownWithRetry('editUserRole', userData.role);
            
            console.log('✅ Edit modal population initiated for all fields');
        }

        // Real-time update function for edit modal fields (immediate feedback after save)
        function updateEditModalFieldsRealTime(updateData) {
            console.log('🔄 Updating edit modal fields with new data in real-time:', updateData);
            
            // Helper function to safely update field values
            const updateField = (elementId, value) => {
                const element = document.getElementById(elementId);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = Boolean(value);
                    } else {
                        element.value = value || '';
                    }
                    console.log(`Updated ${elementId}:`, element.type === 'checkbox' ? element.checked : element.value);
                }
            };
            
            // Update all form fields with the new data
            const __firstName = updateData.firstName || (updateData.name ? updateData.name.split(' ')[0] : '');
            const __lastName = updateData.lastName || (updateData.name ? updateData.name.split(' ').slice(1).join(' ') : '');
            updateField('editUserFirstName', __firstName);
            updateField('editUserLastName', __lastName);
            updateField('editUserEmail', updateData.email);
            updateField('editUserEmployeeId', updateData.employeeId);
            updateField('editUserCountryCode', updateData.countryCode);
            updateField('editUserPhone', updateData.phone);
            updateField('editUserAddress', updateData.address);
            updateField('editUserStatus', updateData.status);
            
            // Update dropdown fields
            updateField('editUserDepartment', updateData.department);
            updateField('editUserJobTitle', updateData.jobTitle);
            updateField('editUserLineManager', updateData.lineManager);
            updateField('editUserRole', updateData.role);
            
            console.log('✅ Edit modal real-time update completed');
        }

        // Edit User Form Submission Handler
        window.handleEditUserSubmission = async function handleEditUserSubmission(event) {
            // CRITICAL: Prevent any form submission or page redirect
            event.preventDefault();
            event.stopPropagation();
            event.stopImmediatePropagation();
            
            console.log('🛑 Form submission completely blocked - NO REDIRECTS WILL OCCUR');
            console.log('🔄 Starting edit user form submission process...');
            console.log('🎯 Event details:', {
                type: event.type,
                target: event.target.id,
                preventDefault: typeof event.preventDefault === 'function',
                currentEditingUser: currentEditingUser
            });
            
            // Get form elements
            const form = event.target;
            const submitButton = form.querySelector('button[type="submit"]');
            const loadingSpan = submitButton.querySelector('.loading');
            const normalSpan = submitButton.querySelector('.normal-text');
            
            console.log('🔍 Form elements found:', {
                form: !!form,
                submitButton: !!submitButton,
                loadingSpan: !!loadingSpan,
                normalSpan: !!normalSpan
            });
            
            // Disable the submit button immediately to prevent double submissions
            if (submitButton) {
                submitButton.disabled = true;
                console.log('🔒 Submit button disabled to prevent multiple submissions');
            }
            
            try {
                // Clear previous errors
                console.log('🧹 Clearing previous form errors...');
                clearEditFormErrors();
                
                // Validate form data
                console.log('📝 Getting form data...');
                const formData = getEditFormData();
                console.log('✅ Form data retrieved:', formData);
                
                console.log('🔍 Validating form data...');
                const validation = validateEditFormData(formData);
                console.log('✅ Validation result:', validation);
                
                if (!validation.isValid) {
                    console.warn('❌ Form validation failed:', validation.errors);
                    showEditFormErrors(validation.errors);
                    return;
                }
                console.log('✅ Form validation passed');
                
                // Check if currentEditingUser is available
                if (!currentEditingUser || !currentEditingUser.id) {
                    console.error('❌ No user data available for editing');
                    throw new Error('No user data available for editing');
                }
                console.log('✅ Current editing user available:', currentEditingUser.id);
                
                // Show loading state
                console.log('⏳ Setting loading state...');
                setEditFormLoadingState(true);
                console.log('✅ Loading state activated');
                
                // Update user in Firebase
                console.log('🔄 Updating user with comprehensive field data:', formData);
                    console.log('📝 Fields being saved:');
                    console.log('  👤 Name:', `${formData.firstName} ${formData.lastName}`.trim());
                console.log('  📧 Email:', formData.email);
                console.log('  � Employee ID:', formData.employeeId);
                console.log('  �🏢 Department:', formData.department);
                console.log('  💼 Job Title:', formData.jobTitle);
                console.log('  📞 Phone:', formData.countryCode, formData.phone);
                console.log('  📍 Address:', formData.address);
                console.log('  👨‍💼 Line Manager:', formData.lineManager);
                console.log('  🎭 Role:', formData.role);
                console.log('  ✅ Status:', formData.status);
                
                // Call Firebase update function
                console.log('🔄 Starting Firebase update...');
                console.log('👤 User ID to update:', currentEditingUser.id);
                
                const updateResult = await updateUserInFirebase(currentEditingUser.id, formData);
                console.log('✅ Firebase update completed successfully');
                console.log('📦 Update result:', updateResult);
                
                // Small delay to ensure Firebase operation is fully committed
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // CRITICAL: Update the currentEditingUser object with the new data
                console.log('🔄 Updating currentEditingUser object with new data...');
                Object.assign(currentEditingUser, formData);
                window.currentEditingUser = currentEditingUser;
                console.log('✅ currentEditingUser updated:', currentEditingUser);
                
                // CRITICAL: Refresh the modal fields to show the updated values
                console.log('🔄 Refreshing modal fields to display updated values...');
                await refreshEditModalFields(currentEditingUser);
                
                // Show success message using both methods for reliability
                showEditSuccessMessage();
                
                // Also use the main notification system
                if (window.companyManagement) {
                    window.companyManagement.showNotification('User updated successfully! All changes have been saved and are now displayed.', 'success');
                } else {
                    console.log('✅ SUCCESS: User updated successfully! All changes have been saved and are now displayed.');
                }
                
                // DON'T close modal immediately - keep it open to show updated values
                console.log('✅ User saved successfully - modal now shows updated values');
                
                // Show success and delay before optional close
                setTimeout(() => {
                    console.log('📢 Modal is now displaying the updated user data. You can close the modal or continue editing.');
                }, 1000);
                
        // Simplified function to refresh users list after updates
        async function refreshUsersList() {
            try {
                console.log('🔄 Refreshing users list after user update...');
                
                if (window.companyManagement && window.companyManagement.loadUsers) {
                    await window.companyManagement.loadUsers();
                    console.log('✅ Users list refreshed successfully');
                } else {
                    console.warn('⚠️ Company management or loadUsers method not available');
                }
                
                // Also refresh dashboard info to update user counts
                if (window.companyManagement && window.companyManagement.updateDashboardInfo) {
                    await window.companyManagement.updateDashboardInfo();
                    console.log('✅ Dashboard info updated');
                }
                
            } catch (error) {
                console.error('❌ Error refreshing users list:', error);
            }
        }

        // Function to refresh the edit modal fields with updated data
        async function refreshEditModalFields(userData) {
            try {
                console.log('🔄 Refreshing edit modal fields with updated data...');
                console.log('📊 Updated user data:', userData);

                // Helper function to safely set element value
                const setElementValue = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value || '';
                        console.log(`✅ Updated ${elementId} = "${value}"`);
                        return true;
                    } else {
                        console.warn(`⚠️ Element not found for refresh: ${elementId}`);
                        return false;
                    }
                };

                // Helper function to safely set dropdown value
                const setDropdownValue = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value || '';
                        console.log(`✅ Updated dropdown ${elementId} = "${value}"`);
                        return true;
                    } else {
                        console.warn(`⚠️ Dropdown element not found for refresh: ${elementId}`);
                        return false;
                    }
                };

                // Update all form fields with the latest data
                console.log('📝 Updating all form fields with refreshed data...');
                
                // Basic fields
                setElementValue('editUserFirstName', userData.firstName || (userData.name ? userData.name.split(' ')[0] : ''));
                setElementValue('editUserLastName', userData.lastName || (userData.name ? userData.name.split(' ').slice(1).join(' ') : ''));
                setElementValue('editUserEmail', userData.email || '');
                setElementValue('editUserEmployeeId', userData.employeeId || '');
                setElementValue('editUserPhone', userData.phone || '');
                setElementValue('editUserAddress', userData.address || '');
                
                // Dropdown fields
                setDropdownValue('editUserJobTitle', userData.jobTitle || '');
                setDropdownValue('editUserDepartment', userData.department || '');
                setDropdownValue('editUserCountryCode', userData.countryCode || '');
                setDropdownValue('editUserLineManager', userData.lineManagerId || userData.lineManager || '');
                setDropdownValue('editUserRole', userData.role || '');
                setDropdownValue('editUserStatus', userData.status || 'active');

                console.log('✅ All edit modal fields refreshed with updated data');
                
                // Verify the refresh by logging current field values
                console.log('🔍 Verification - Current field values after refresh:');
                console.log('  First Name:', document.getElementById('editUserFirstName')?.value);
                console.log('  Last Name:', document.getElementById('editUserLastName')?.value);
                console.log('  Email:', document.getElementById('editUserEmail')?.value);
                console.log('  Employee ID:', document.getElementById('editUserEmployeeId')?.value);
                console.log('  Job Title:', document.getElementById('editUserJobTitle')?.value);
                console.log('  Department:', document.getElementById('editUserDepartment')?.value);
                console.log('  Phone:', document.getElementById('editUserPhone')?.value);
                console.log('  Country Code:', document.getElementById('editUserCountryCode')?.value);
                console.log('  Address:', document.getElementById('editUserAddress')?.value);
                console.log('  Line Manager:', document.getElementById('editUserLineManager')?.value);
                console.log('  Role:', document.getElementById('editUserRole')?.value);
                console.log('  Status:', document.getElementById('editUserStatus')?.value);
                
            } catch (error) {
                console.error('❌ Error refreshing edit modal fields:', error);
            }
        }
                
                console.log('User updated successfully');
                
                // Refresh user list in background
                await refreshUsersList();
                
            } catch (error) {
                console.error('❌ Error updating user:', error);
                console.error('❌ Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                
                // Show detailed error message
                const errorMessage = error.message || 'An error occurred while updating the user';
                showEditErrorMessage(errorMessage);
                
                // Also use the main notification system for error
                if (window.companyManagement) {
                    window.companyManagement.showNotification(`Error updating user: ${errorMessage}`, 'error');
                } else {
                    console.error(`❌ ERROR: Error updating user: ${errorMessage}`);
                }
            } finally {
                // Hide loading state and re-enable button
                setEditFormLoadingState(false);
                
                // Re-enable submit button
                if (submitButton) {
                    submitButton.disabled = false;
                    console.log('🔓 Submit button re-enabled');
                }
                
                console.log('🏁 Edit user form submission process completed');
            }
            
            // CRITICAL: Ensure absolutely no form submission occurs
            console.log('🛑 Explicitly returning false to prevent any form submission or page reload');
            return false;
        };

        function getEditFormData() {
            console.log('📋 Getting edit form data...');
            console.log('🔍 Starting to collect form field values...');
            
            // Helper function to safely get element value
            const getElementValue = (id, type = 'value') => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`⚠️ Element not found: ${id}`);
                    return type === 'checked' ? false : '';
                }
                const value = type === 'checked' ? element.checked : element.value;
                console.log(`✅ ${id}: "${value}" (element exists: ${!!element})`);
                return value;
            };

            // Helper function to get line manager name from dropdown display text
            const getLineManagerNameFromDropdown = (selectId) => {
                const selectElement = document.getElementById(selectId);
                if (!selectElement || !selectElement.value) {
                    console.log(`⚠️ Line manager dropdown empty or not found: ${selectId}`);
                    return '';
                }
                
                const selectedOption = selectElement.options[selectElement.selectedIndex];
                if (selectedOption && selectedOption.value !== '') {
                    // Extract just the name part from the display text (remove job title/department in parentheses)
                    const displayText = selectedOption.textContent || selectedOption.text;
                    const lineManagerName = displayText.split(' (')[0].trim(); // Get name before any parentheses
                    console.log(`📋 Line manager selected in edit form: ID=${selectElement.value}, Name="${lineManagerName}"`);
                    return lineManagerName;
                }
                
                return '';
            };
            
            // Collect all form field values with detailed logging
            console.log('📝 Collecting all form field values:');
            const formData = {
                firstName: getElementValue('editUserFirstName').trim(),
                lastName: getElementValue('editUserLastName').trim(),
                email: getElementValue('editUserEmail').trim(),
                employeeId: getElementValue('editUserEmployeeId').trim(),
                department: getElementValue('editUserDepartment'),
                jobTitle: getElementValue('editUserJobTitle'),
                countryCode: getElementValue('editUserCountryCode'),
                phone: getElementValue('editUserPhone').trim(),
                lineManager: getLineManagerNameFromDropdown('editUserLineManager'),
                lineManagerId: getElementValue('editUserLineManager'), // Store ID for reference
                address: getElementValue('editUserAddress').trim(),
                role: getElementValue('editUserRole'),
                status: getElementValue('editUserStatus'),
                companyAffiliationRaw: getElementValue('editUserCompanyAffiliation')
            };
            formData.name = `${formData.firstName} ${formData.lastName}`.trim();
            
            console.log('📦 Complete form data collected:', formData);
            console.log('🔍 Detailed form data breakdown:');
            Object.keys(formData).forEach(key => {
                console.log(`  ${key}: "${formData[key]}" (type: ${typeof formData[key]})`);
            });
            
            return formData;
        }

        function validateEditFormData(formData) {
            const errors = {};
            
            // Required fields validation
            if (!formData.firstName) {
                errors.editUserFirstName = 'First name is required';
            }
            if (!formData.lastName) {
                errors.editUserLastName = 'Last name is required';
            }
            
            if (!formData.email) {
                errors.editUserEmail = 'Email address is required';
            } else if (!isValidEmail(formData.email)) {
                errors.editUserEmail = 'Please enter a valid email address';
            }
            
            if (!formData.role) {
                errors.editUserRole = 'Role is required';
            }
            
            // Phone validation (if provided)
            if (formData.phone && !isValidPhone(formData.phone)) {
                errors.editUserPhone = 'Please enter a valid phone number';
            }
            
            return {
                isValid: Object.keys(errors).length === 0,
                errors: errors
            };
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function isValidPhone(phone) {
            const phoneRegex = /^[0-9\-\s]{7,15}$/;
            return phoneRegex.test(phone);
        }

        function clearEditFormErrors() {
            const errorGroups = document.querySelectorAll('#editUserForm .form-group.error');
            errorGroups.forEach(group => {
                group.classList.remove('error');
                const errorDiv = group.querySelector('.form-error');
                if (errorDiv) {
                    errorDiv.textContent = '';
                }
            });
        }

        function showEditFormErrors(errors) {
            Object.entries(errors).forEach(([fieldId, message]) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    const formGroup = field.closest('.form-group');
                    const errorDiv = formGroup.querySelector('.form-error');
                    
                    if (formGroup && errorDiv) {
                        formGroup.classList.add('error');
                        errorDiv.textContent = message;
                    }
                }
            });
        }

        function setEditFormLoadingState(isLoading) {
            const form = document.getElementById('editUserForm');
            const submitButton = form.querySelector('button[type="submit"]');
            const loadingSpan = submitButton.querySelector('.loading');
            const normalSpan = submitButton.querySelector('.normal-text');
            
            if (isLoading) {
                submitButton.disabled = true;
                loadingSpan.style.display = 'flex';
                normalSpan.style.display = 'none';
            } else {
                submitButton.disabled = false;
                loadingSpan.style.display = 'none';
                normalSpan.style.display = 'flex';
            }
        }

        function showEditSuccessMessage() {
            const userNameDisplay = `${document.getElementById('editUserFirstName')?.value || ''} ${document.getElementById('editUserLastName')?.value || ''}`.trim() || 'User';
            const notification = document.createElement('div');
            notification.className = 'edit-success-notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; 
                            padding: 1rem 1.5rem; border-radius: 8px; z-index: 10001; 
                            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.3); max-width: 400px;">
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-check-circle" style="font-size: 1.1rem;"></i>
                        <div>
                            <strong>✅ ${userNameDisplay} Updated Successfully!</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">All user information has been saved to Firebase and updated in real-time.</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 6 seconds
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.remove();
                }
            }, 6000);
        }

        function showEditErrorMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'edit-error-notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; 
                            padding: 1rem 1.5rem; border-radius: 8px; z-index: 10001; 
                            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3); max-width: 400px;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <i class="fas fa-exclamation-circle" style="margin-top: 0.125rem; font-size: 1.1rem;"></i>
                        <div>
                            <strong>Update Failed</strong>
                            <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.remove();
                }
            }, 8000);
        }

        // Firebase Integration Functions
        async function updateUserInFirebase(userId, userData) {
            try {
                console.log('🚀 updateUserInFirebase called with:', { userId, userData });
                
                // Check if companyManagement instance is available
                if (!window.companyManagement) {
                    console.error('❌ Company management system not available');
                    throw new Error('Company management system not available');
                }
                console.log('✅ Company management system available');
                
                // Get current user authentication
                const currentUser = window.companyManagement.currentUser;
                if (!currentUser) {
                    console.error('❌ User not authenticated');
                    throw new Error('User not authenticated');
                }
                console.log('✅ User authenticated:', currentUser.uid || currentUser.id);
                
                // Get the company ID from companyManagement instance
                const companyId = window.companyManagement.companyId;
                if (!companyId) {
                    console.error('❌ Company ID not found');
                    throw new Error('Company ID not found');
                }
                console.log('✅ Company ID found:', companyId);
                
                // Store the original role for comparison
                const originalRole = currentEditingUser?.role;
                const newRole = userData.role;
                const isRoleChanged = originalRole !== newRole;
                
                // Parse full name into firstName and lastName for org chart compatibility
                const fullName = userData.name || '';
                const nameParts = fullName.trim().split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';
                
                // Prepare comprehensive update data with all fields
                const updateData = {
                    name: userData.name,
                    firstName: firstName,
                    lastName: lastName,
                    email: userData.email,
                    employeeId: userData.employeeId || '',
                    department: userData.department || '',
                    jobTitle: userData.jobTitle || '',
                    countryCode: userData.countryCode || '',
                    phone: userData.phone || '',
                    lineManager: userData.lineManager || '',
                    lineManagerId: userData.lineManagerId || '',
                    address: userData.address || '',
                    role: userData.role,
                    status: userData.status,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.uid || currentUser.id
                };
                console.log('✅ Comprehensive update data prepared:', updateData);
                
                // Use Firebase v8 database reference for reliable updates
                const userPath = `companies/${companyId}/users/${userId}`;
                const userRef = firebase.database().ref(userPath);
                
                console.log('🔄 Updating user at company-scoped path:', userPath);
                
                // Perform the Firebase update
                await userRef.update(updateData);
                console.log('✅ Firebase update operation completed successfully');
                
                // Also update global users path for consistency (if it exists)
                try {
                    const globalUserRef = firebase.database().ref(`users/${userId}`);
                    const globalSnapshot = await globalUserRef.once('value');
                    if (globalSnapshot.exists()) {
                        await globalUserRef.update(updateData);
                        console.log('✅ Global user path also updated');
                    }
                } catch (globalError) {
                    console.warn('⚠️ Global user update failed (non-critical):', globalError);
                }
                
                // Force refresh the users list in the UI to show updated data
                console.log('🔄 Refreshing users list to show updated data...');
                if (window.companyManagement.loadUsers) {
                    await window.companyManagement.loadUsers();
                    console.log('✅ Users list refreshed');
                }
                
                // Update the currentEditingUser with new data for real-time display
                if (window.currentEditingUser) {
                    window.currentEditingUser = {
                        ...window.currentEditingUser,
                        ...updateData,
                        id: userId
                    };
                    console.log('✅ Current editing user updated with new data');
                }
                
                // Refresh org chart if available (for updated user names and relationships)
                if (window.refreshOrgChart) {
                    try {
                        await window.refreshOrgChart();
                        console.log('✅ Org chart refreshed after user update');
                    } catch (error) {
                        console.warn('⚠️ Failed to refresh org chart:', error);
                    }
                }

                // Trigger cross-page communication for org chart refresh
                try {
                    // Use custom event for same-page communication
                    window.dispatchEvent(new CustomEvent('userDataUpdated', {
                        detail: { action: 'updated', userId: userId, userData: updateData }
                    }));

                    // Use localStorage for cross-tab communication
                    localStorage.setItem('orgChartRefreshNeeded', 'true');
                    setTimeout(() => localStorage.removeItem('orgChartRefreshNeeded'), 1000);
                    
                    console.log('✅ Cross-page refresh signals sent for user update');
                } catch (error) {
                    console.warn('⚠️ Failed to send cross-page refresh signals:', error);
                }
                
                // Update currentEditingUser with new data
                if (window.currentEditingUser) {
                    window.currentEditingUser = { ...window.currentEditingUser, ...updateData };
                }
                
                // IMMEDIATELY refresh the edit modal fields with the saved data
                console.log('🔄 Refreshing edit modal with saved data immediately...');
                await refreshEditModalWithSavedData(userId, updateData);
                
                // Update the user details modal if it's open for the same user
                const userDetailsModal = document.getElementById('userDetailsModal');
                if (userDetailsModal && userDetailsModal.classList.contains('show')) {
                    const modalUserId = userDetailsModal.getAttribute('data-current-user-id');
                    if (modalUserId === userId) {
                        console.log('Updating user details modal with new data');
                        populateOverviewTab(currentEditingUser);
                    }
                }
                
                // Update the edit modal fields immediately with the new data (if still open)
                const editModal = document.getElementById('editUserModal');
                if (editModal && editModal.classList.contains('show')) {
                    console.log('Updating edit modal with new data for real-time feedback');
                    updateEditModalFieldsRealTime(updateData);
                }
                
                // If the role changed, handle menu updates and notifications
                if (isRoleChanged) {
                    console.log(`Role changed from ${originalRole} to ${newRole} for user ${userId}`);
                    
                    // Update open modals with the new role information
                    updateOpenModalsOnRoleChange(userId, newRole);
                    
                    // Check if the edited user is the currently logged-in user
                    const isCurrentUser = userId === currentUser.uid;
                    
                    if (isCurrentUser) {
                        console.log('Current user role changed, updating menu permissions...');
                        
                        // Update current user data in localStorage for immediate UI updates
                        const storedUser = localStorage.getItem('currentUser');
                        if (storedUser) {
                            const userData = JSON.parse(storedUser);
                            userData.role = newRole;
                            localStorage.setItem('currentUser', JSON.stringify(userData));
                            console.log('Updated current user role in localStorage');
                        }
                        
                        // Trigger menu refresh on all open pages
                        await triggerMenuRefreshForCurrentUser();
                        
                        // Show notification about role change
                        showRoleChangeNotification(originalRole, newRole, true);
                    } else {
                        // Show notification about other user's role change
                        showRoleChangeNotification(originalRole, newRole, false);
                    }
                }
                
                return updateData;
                
            } catch (error) {
                console.error('Error updating user in Firebase:', error);
                throw error;
            }
        }
        
        // Function to refresh edit modal with saved data
        async function refreshEditModalWithSavedData(userId, savedData) {
            try {
                console.log('🔄 Refreshing edit modal with saved data for user:', userId);
                console.log('💾 Saved data to display:', savedData);
                
                // Ensure dropdowns are still populated (they might have been cleared)
                if (window.companyManagement) {
                    await window.companyManagement.populateEditUserModalDropdowns();
                    console.log('✅ Dropdowns repopulated in edit modal');
                }
                
                // Small delay to ensure dropdowns are ready
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Update all form fields with the saved data
                document.getElementById('editUserFirstName').value = savedData.firstName || (savedData.name ? savedData.name.split(' ')[0] : '');
                document.getElementById('editUserLastName').value = savedData.lastName || (savedData.name ? savedData.name.split(' ').slice(1).join(' ') : '');
                document.getElementById('editUserEmail').value = savedData.email || '';
                
                // Use the enhanced setDropdownValue for better matching
                if (window.companyManagement && window.companyManagement.setDropdownValue) {
                    console.log(`🔧 Setting job title to: "${savedData.jobTitle}"`);
                    window.companyManagement.setDropdownValue('editUserJobTitle', savedData.jobTitle);
                    
                    console.log(`🔧 Setting department to: "${savedData.department}"`);
                    window.companyManagement.setDropdownValue('editUserDepartment', savedData.department);
                    
                    console.log(`🔧 Setting role to: "${savedData.role}"`);
                    window.companyManagement.setDropdownValue('editUserRole', savedData.role);
                    
                    console.log(`🔧 Setting line manager to: "${savedData.lineManager}"`);
                    window.companyManagement.setDropdownValue('editUserLineManager', savedData.lineManager);
                    
                    console.log(`🔧 Setting status to: "${savedData.status}"`);
                    window.companyManagement.setDropdownValue('editUserStatus', savedData.status);
                } else {
                    // Fallback to direct value setting
                    document.getElementById('editUserJobTitle').value = savedData.jobTitle || '';
                    document.getElementById('editUserDepartment').value = savedData.department || '';
                    document.getElementById('editUserRole').value = savedData.role || '';
                    document.getElementById('editUserLineManager').value = savedData.lineManager || '';
                    document.getElementById('editUserStatus').value = savedData.status || 'active';
                }
                
                document.getElementById('editUserPhone').value = savedData.phone || '';
                document.getElementById('editUserCountryCode').value = savedData.countryCode || '';
                document.getElementById('editUserAddress').value = savedData.address || '';
                
                // Handle company admin checkbox if it exists
                const companyAdminCheckbox = document.getElementById('editUserIsCompanyAdmin');
                if (companyAdminCheckbox) {
                    companyAdminCheckbox.checked = savedData.isCompanyAdmin || false;
                }

                // Refresh Company/Subcontractor selection if present
                try {
                    const companySelect = document.getElementById('editUserCompanyAffiliation');
                    if (companySelect) {
                        // Repopulate options to be safe
                        if (window.companyManagement && window.companyManagement.populateEditUserModalDropdowns) {
                            await window.companyManagement.populateEditUserModalDropdowns();
                        }
                        await new Promise(r => setTimeout(r, 150));
                        const target = {
                            type: savedData.employerCompanyType || 'main',
                            id: savedData.employerCompanyId || (window.companyManagement?.companyId)
                        };
                        let matched = false;
                        for (let i = 0; i < companySelect.options.length; i++) {
                            try {
                                const v = JSON.parse(companySelect.options[i].value);
                                if (v && v.id === target.id && v.type === target.type) {
                                    companySelect.selectedIndex = i;
                                    matched = true;
                                    break;
                                }
                            } catch {}
                        }
                        if (!matched && companySelect.options.length > 1) {
                            companySelect.selectedIndex = 1;
                        }
                        console.log('✅ Company affiliation refreshed in edit modal');
                    }
                } catch (e) {
                    console.warn('⚠️ Failed to refresh company affiliation in edit modal:', e);
                }
                
                console.log('✅ Edit modal refreshed with saved data');
                console.log('🔍 Final verification of displayed values:', {
                    name: `${document.getElementById('editUserFirstName')?.value || ''} ${document.getElementById('editUserLastName')?.value || ''}`.trim(),
                    email: document.getElementById('editUserEmail').value,
                    jobTitle: document.getElementById('editUserJobTitle').value,
                    department: document.getElementById('editUserDepartment').value,
                    role: document.getElementById('editUserRole').value,
                    phone: document.getElementById('editUserPhone').value,
                    address: document.getElementById('editUserAddress').value
                });
                
            } catch (error) {
                console.error('❌ Error refreshing edit modal with saved data:', error);
            }
        }
        
        // Function to trigger menu refresh for the current user
        async function triggerMenuRefreshForCurrentUser() {
            try {
                // Try to refresh menu on current page if staff.html menu system is available
                if (window.debugRefreshMenu && typeof window.debugRefreshMenu === 'function') {
                    console.log('Refreshing menu permissions on current page...');
                    await window.debugRefreshMenu();
                }
                
                // Store a flag in localStorage to trigger menu refresh on other pages
                localStorage.setItem('triggerMenuRefresh', Date.now().toString());
                
                // Dispatch a custom event for any listening pages
                window.dispatchEvent(new CustomEvent('userRoleChanged', {
                    detail: { timestamp: Date.now() }
                }));
                
                console.log('Menu refresh triggered for current user');
                
            } catch (error) {
                console.error('Error triggering menu refresh:', error);
            }
        }
        
        // Function to update open modals when role definitions change or user roles are updated
        function updateOpenModalsOnRoleChange(updatedUserId = null, newUserRole = null) {
            try {
                console.log('Updating open modals on role change...');
                
                // Update user details modal if open
                const userDetailsModal = document.getElementById('userDetailsModal');
                if (userDetailsModal && userDetailsModal.classList.contains('show')) {
                    const currentUserId = userDetailsModal.getAttribute('data-current-user-id');
                    console.log('User details modal is open for user:', currentUserId);
                    
                    // If this is the user whose role changed, update their display
                    if (updatedUserId && currentUserId === updatedUserId && newUserRole) {
                        console.log('Updating user details modal role display for changed user');
                        updateRoleDisplayInModal(newUserRole);
                    } else {
                        // If role definitions changed, refresh all role displays
                        console.log('Refreshing all role displays in user details modal');
                        const roleElement = document.getElementById('detailRole');
                        if (roleElement) {
                            const currentRoleId = roleElement.getAttribute('data-role-id');
                            if (currentRoleId) {
                                updateRoleDisplayInModal(currentRoleId);
                            }
                        }
                    }
                }
                
                // Update edit user modal if open
                const editUserModal = document.getElementById('editUserModal');
                if (editUserModal && editUserModal.classList.contains('show')) {
                    console.log('Edit user modal is open, refreshing role dropdown and selected value');
                    
                    // Refresh role dropdown options
                    if (window.companyManagement && window.companyManagement.populateRoleDropdown) {
                        window.companyManagement.populateRoleDropdown();
                    }
                    
                    // If this is the user being edited and their role changed, update the selection
                    if (updatedUserId && currentEditingUser && currentEditingUser.id === updatedUserId && newUserRole) {
                        setTimeout(() => {
                            const roleSelect = document.getElementById('editUserRole');
                            if (roleSelect) {
                                roleSelect.value = newUserRole;
                                console.log('Updated edit modal role selection to:', newUserRole);
                            }
                        }, 100);
                    }
                }
                
                console.log('Open modals updated successfully');
                
            } catch (error) {
                console.error('Error updating open modals on role change:', error);
            }
        }
        
        // Helper function to update role display in the user details modal
        function updateRoleDisplayInModal(roleId) {
            try {
                const roleElement = document.getElementById('detailRole');
                if (!roleElement) return;
                
                console.log('Updating role display in modal for role:', roleId);
                
                // Use the exact same display logic as other role displays
                let roleDisplayName = 'User'; // Default fallback
                if (window.companyManagement && window.companyManagement.companyRoles && window.companyManagement.companyRoles[roleId]) {
                    const roleData = window.companyManagement.companyRoles[roleId];
                    roleDisplayName = roleData.name || roleData.roleName || roleId;
                } else {
                    // Fallback to getRoleDisplayName if companyRoles not available
                    roleDisplayName = getRoleDisplayName(roleId);
                }
                
                // Update the display
                roleElement.textContent = roleDisplayName;
                roleElement.setAttribute('data-role-id', roleId);
                roleElement.className = 'role-badge';
                
                // Add appropriate role class using helper function
                const roleClass = getRoleClass(roleId);
                roleElement.classList.add(roleClass);
                
                console.log('Role display updated in modal:', roleDisplayName, roleClass);
                
            } catch (error) {
                console.error('Error updating role display in modal:', error);
            }
        }
        
        // Function to show role change notification
        function showRoleChangeNotification(oldRole, newRole, isCurrentUser) {
            const message = isCurrentUser 
                ? `Your role has been updated from "${getRoleDisplayName(oldRole)}" to "${getRoleDisplayName(newRole)}". Your menu permissions have been refreshed.`
                : `User role updated from "${getRoleDisplayName(oldRole)}" to "${getRoleDisplayName(newRole)}".`;
                
            const notificationColor = isCurrentUser ? '#17a2b8' : '#28a745';
            
            const notification = document.createElement('div');
            notification.className = 'role-notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${notificationColor}; color: white; 
                            padding: 1rem 1.5rem; border-radius: 8px; z-index: 10001; 
                            box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 400px;">
                    <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                        <i class="fas fa-user-shield" style="margin-top: 0.125rem; font-size: 1.1rem;"></i>
                        <div>
                            <strong style="display: block; margin-bottom: 0.5rem;">Role Updated</strong>
                            <p style="margin: 0; font-size: 0.9rem; line-height: 1.4;">${message}</p>
                            ${isCurrentUser ? 
                                '<p style="margin: 0.5rem 0 0 0; font-size: 0.8rem; opacity: 0.9;"><i class="fas fa-info-circle"></i> Menu permissions will take effect immediately.</p>' : 
                                ''
                            }
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    style="margin-top: 0.75rem; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); 
                                           color: white; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                                <i class="fas fa-times" style="margin-right: 0.25rem;"></i>Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (notification && notification.parentElement) {
                    notification.remove();
                }
            }, 8000);
        }
        
        // Helper function to get role display name
        function getRoleDisplayName(roleId) {
            if (window.companyManagement && typeof window.companyManagement.getRoleDisplayName === 'function') {
                return window.companyManagement.getRoleDisplayName(roleId);
            }
            
            // If companyManagement is available, try to get from company roles
            if (window.companyManagement && window.companyManagement.companyRoles) {
                const companyRoles = window.companyManagement.companyRoles;
                if (companyRoles[roleId] && companyRoles[roleId].name) {
                    return companyRoles[roleId].name;
                }
            }
            
            // Last fallback: return the roleId as-is with proper capitalization
            return roleId ? roleId.charAt(0).toUpperCase() + roleId.slice(1).replace(/_/g, ' ') : 'Unknown Role';
        }
        
        // Helper function to get appropriate CSS class for role badge
        function getRoleClass(roleId) {
            if (!roleId) return 'role-user';
            
            const roleLower = roleId.toLowerCase();
            
            // Check for admin roles
            if (roleLower.includes('admin') || roleLower.includes('administrator')) {
                return 'role-admin';
            }
            
            // Check for manager/supervisor roles
            if (roleLower.includes('manager') || roleLower.includes('supervisor') || roleLower.includes('lead')) {
                return 'role-manager';
            }
            
            // Check for specific department roles
            if (roleLower.includes('hr') || roleLower.includes('human')) {
                return 'role-hr';
            }
            
            if (roleLower.includes('safety') || roleLower.includes('security')) {
                return 'role-safety';
            }
            
            if (roleLower.includes('finance') || roleLower.includes('accounting')) {
                return 'role-finance';
            }
            
            // Default to user role
            return 'role-user';
        }

        async function getCurrentCompanyId() {
            try {
                // First, try to get from companyManagement instance
                if (window.companyManagement && window.companyManagement.companyId) {
                    return window.companyManagement.companyId;
                }
                
                // Fallback: get from current user data
                const currentUser = window.companyManagement?.currentUser;
                if (currentUser && currentUser.companyId) {
                    return currentUser.companyId;
                }
                
                throw new Error('Company ID not found');
                
            } catch (error) {
                console.error('Error getting company ID:', error);
                throw error;
            }
        }

        

        // Make user details functions globally available
        window.openUserDetailsModal = openUserDetailsModal;
        window.switchUserTab = switchUserTab;
        window.resetPassword = resetPassword;
        window.toggleUserStatus = toggleUserStatus;
        window.deleteUser = deleteUser;
        window.toggleSetting = toggleSetting;

        // User Table Row Click Functionality
        function makeUserTableRowsClickable() {
            const usersTable = document.getElementById('usersTableBody');
            if (!usersTable) {
                console.warn('Users table body not found');
                return;
            }

            // Add click event listener to the table body (event delegation)
            usersTable.addEventListener('click', function(event) {
                // Find the closest tr element
                const row = event.target.closest('tr');
                if (!row) return;

                // Skip if clicked on a button or action element
                if (event.target.closest('.action-btn') || 
                    event.target.closest('button') || 
                    event.target.closest('.action-buttons')) {
                    return;
                }

                // Extract user data from the row
                const userData = extractUserDataFromRow(row);
                if (userData) {
                    console.log('🔍 DEBUG: User data extracted from table row:', userData);
                    console.log('🔍 DEBUG: User ID that will be passed to modal:', userData.id);
                    
                    // Add visual feedback
                    row.style.backgroundColor = '#e3f2fd';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                    }, 200);

                    // Open the user details modal with userId only (will load fresh data)
                    openUserDetailsModal(userData.id);
                }
            });

            // Add hover effect to indicate rows are clickable
            const style = document.createElement('style');
            style.textContent = `
                .users-table tbody tr {
                    cursor: pointer;
                    transition: background-color 0.2s ease;
                }
                .users-table tbody tr:hover {
                    background-color: #f8f9fa !important;
                }
                .users-table tbody tr:hover .user-name {
                    color: var(--secondary-color);
                }
            `;
            document.head.appendChild(style);
        }

        function extractUserDataFromRow(row) {
            try {
                console.log('🔍 Extracting user data from table row');
                
                // Get all cells in the row
                const cells = row.querySelectorAll('td');
                if (cells.length < 5) {
                    console.warn('Invalid row structure - not enough cells');
                    return null;
                }

                // First, try to get the actual user ID from data attributes
                const dataUserId = row.getAttribute('data-user-id');
                const dataUserEmail = row.getAttribute('data-user-email');
                
                console.log('📋 Row data attributes:');
                console.log('  - data-user-id:', dataUserId);
                console.log('  - data-user-email:', dataUserEmail);

                // Extract user information from the row structure
                // Assuming structure: [User Info, Role, Status, Last Login, Actions]
                
                // Extract user info from first cell
                const userInfoCell = cells[0];
                const userInfo = userInfoCell.querySelector('.user-info');
                const userDetails = userInfo ? userInfo.querySelector('.user-details') : null;
                
                const nameElement = userDetails ? userDetails.querySelector('.user-name') : null;
                const emailElement = userDetails ? userDetails.querySelector('.user-email') : null;
                const name = nameElement ? nameElement.textContent.trim() : 'Unknown User';
                // With new column, prefer second cell text if no email in user-details
                let email = emailElement ? emailElement.textContent.trim() : '';
                if (!email) {
                    const emailCell = cells[1];
                    const emailText = emailCell ? emailCell.textContent.trim() : '';
                    email = emailText || dataUserEmail || '';
                }

                console.log('📋 Extracted from DOM:');
                console.log('  - name:', name);
                console.log('  - email:', email);

                // Extract role from third cell (after adding Email column)
                const roleCell = cells[2];
                const roleBadge = roleCell.querySelector('.role-badge');
                const role = roleBadge ? roleBadge.textContent.trim() : 'User';

                // Use the actual user ID from data attributes first, fallback to email-based ID
                let userId;
                if (dataUserId && dataUserId.trim() !== '') {
                    userId = dataUserId.trim();
                    console.log('✅ Using actual user ID from data attribute:', userId);
                } else {
                    // Fallback: generate from email (this shouldn't happen if data is properly set)
                    userId = email.replace('@', '_').replace(/\./g, '_') || generateUserIdFromName(name);
                    console.warn('⚠️ No data-user-id found, generating ID from email:', userId);
                    console.warn('⚠️ This might cause data loading issues - check table row creation');
                }

                // Create user data object
                const userData = {
                    id: userId,
                    name: name,
                    email: email,
                    role: role,
                    status: 'active', // Default status
                    department: '', // Will be populated if available
                    jobTitle: '', // Will be populated if available
                    phone: '', // Will be populated if available
                    createdAt: new Date().toISOString(), // Default creation date
                    lastLogin: null // Will be updated with actual data
                };

                // Try to extract additional data if available in the row
                const additionalData = extractAdditionalUserData(row);
                Object.assign(userData, additionalData);

                console.log('Extracted user data from row:', userData);
                return userData;

            } catch (error) {
                console.error('Error extracting user data from row:', error);
                return null;
            }
        }

        function extractAdditionalUserData(row) {
            const additionalData = {};
            
            // Try to get data from data attributes
            const attributes = row.attributes;
            for (let i = 0; i < attributes.length; i++) {
                const attr = attributes[i];
                if (attr.name.startsWith('data-user-')) {
                    const key = attr.name.replace('data-user-', '');
                    additionalData[key] = attr.value;
                }
            }

            // Try to extract status if available
            const statusElement = row.querySelector('.status-badge');
            if (statusElement) {
                additionalData.status = statusElement.textContent.trim().toLowerCase();
            }

            return additionalData;
        }

        function generateUserIdFromName(name) {
            // Generate a simple ID from name for demo purposes
            return name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
        }

        // Enhanced user table population with clickable rows
        function populateUsersTable(users) {
            const tableBody = document.getElementById('usersTableBody');
            if (!tableBody) {
                console.warn('Users table body not found');
                return;
            }

            // Clear existing rows
            tableBody.innerHTML = '';

            if (!users || users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #6c757d;">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            No users found. Click "Add User" to create the first user.
                        </td>
                    </tr>
                `;
                return;
            }

            // Create rows for each user
            users.forEach(user => {
                const row = createUserTableRow(user);
                tableBody.appendChild(row);
            });

            // Make rows clickable after populating
            makeUserTableRowsClickable();
        }

        function createUserTableRow(user) {
            const row = document.createElement('tr');
            
            // Add data attributes for easier extraction
            row.setAttribute('data-user-id', user.id || user.uid || '');
            row.setAttribute('data-user-email', user.email || '');
            row.setAttribute('data-user-role', user.role || 'user');
            row.setAttribute('data-user-status', user.status || 'active');
            if (user.department) row.setAttribute('data-user-department', user.department);
            if (user.jobTitle) row.setAttribute('data-user-jobtitle', user.jobTitle);
            if (user.phone) row.setAttribute('data-user-phone', user.phone);

            // User Info Cell
            const userInfoCell = document.createElement('td');
            const userName = user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || 'Unknown User';
            const userEmail = (user.accountType === 'without-account' || user.reportingOnly === true || user.canSignIn === false) ? '' : (user.email || '');
            const userInitials = userName.split(' ').map(n => n[0]).join('').toUpperCase();

            userInfoCell.innerHTML = `
                <div class="user-info">
                    <div class="user-avatar">${userInitials}</div>
                    <div class="user-details">
                        <div class="user-name">${userName}</div>
                    </div>
                </div>
            `;
            // Email Cell
            const emailCell = document.createElement('td');
            emailCell.textContent = userEmail || '-';

            // Role Cell
            const roleCell = document.createElement('td');
            const role = user.role || 'user';
            
            // Use the same display logic as the dropdown to ensure consistency
            let roleDisplayName = 'User'; // Default fallback
            if (window.companyManagement && window.companyManagement.companyRoles && window.companyManagement.companyRoles[role]) {
                const roleData = window.companyManagement.companyRoles[role];
                roleDisplayName = roleData.name || roleData.roleName || role;
            } else {
                // Fallback to getRoleDisplayName if companyRoles not available
                roleDisplayName = getRoleDisplayName(role);
            }
            
            const roleClass = getRoleClass(role);
            
            roleCell.innerHTML = `<span class="role-badge ${roleClass}" data-role-id="${role}">${roleDisplayName}</span>`;

            // Status Cell
            const statusCell = document.createElement('td');
            const status = user.status || 'active';
            const statusClass = status.toLowerCase();
            statusCell.innerHTML = `<span class="status-badge ${statusClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;

            // Last Login Cell
            const lastLoginCell = document.createElement('td');
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never';
            lastLoginCell.textContent = lastLogin;

            // Actions Cell
            const actionsCell = document.createElement('td');
            actionsCell.innerHTML = `
                <div class="action-buttons">
                    <button class="action-btn btn-view" title="View Details" onclick="event.stopPropagation(); openUserDetailsModal('${user.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn btn-edit" title="Edit User" onclick="event.stopPropagation(); editUserFromTable('${user.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn btn-delete" title="Delete User" onclick="event.stopPropagation(); deleteUserFromTable('${user.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            // Append all cells to row
            row.appendChild(userInfoCell);
            row.appendChild(emailCell);
            row.appendChild(roleCell);
            row.appendChild(statusCell);
            row.appendChild(lastLoginCell);
            row.appendChild(actionsCell);

            return row;
        }

        // Table action functions
        function editUserFromTable(userId) {
            console.log('Edit user from table:', userId);
            
            // Directly call the edit function with userId to load complete data from Firebase
            editUser(userId);
        }

        async function deleteUserFromTable(userId) {
            if (!userId) {
                console.error('No user ID provided for deletion');
                showDeleteErrorMessage('Unable to delete user: Invalid user ID');
                return;
            }

            // Confirm deletion with user
            const confirmMessage = 'Are you sure you want to delete this user? This action cannot be undone and will remove all user data from the system.';
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                // Show loading state
                showDeleteLoadingState(true);
                console.log('Deleting user from Firebase:', userId);

                // Delete user from Firebase
                const success = await deleteUserFromFirebase(userId);
                
                if (success) {
                    // Show success message
                    showDeleteSuccessMessage();
                    
                    // Refresh the users list to update the table
                    await refreshUsersList();
                    
                    console.log('User successfully deleted from Firebase and table updated');
                } else {
                    throw new Error('Failed to delete user from Firebase');
                }

            } catch (error) {
                console.error('Error deleting user:', error);
                showDeleteErrorMessage(`Failed to delete user: ${error.message}`);
            } finally {
                showDeleteLoadingState(false);
            }
        }

        // Firebase delete function
        async function deleteUserFromFirebase(userId) {
            try {
                // Get current company ID
                const companyId = await getCurrentCompanyId();
                
                if (!companyId) {
                    throw new Error('Company ID not found');
                }

                // Delete from company-scoped user data
                if (window.firebase && window.firebase.database) {
                    const db = window.firebase.database();
                    
                    // Delete user from company users
                    const companyUserRef = db.ref(`companies/${companyId}/users/${userId}`);
                    await companyUserRef.remove();
                    
                    console.log(`User ${userId} deleted from company ${companyId} users`);
                }

                // Also try to delete from global users if Firebase Auth is available
                if (window.firebase && window.firebase.firestore) {
                    const firestore = window.firebase.firestore();
                    
                    // Delete user document from global users collection
                    const userDocRef = firestore.collection('users').doc(userId);
                    await userDocRef.delete();
                    
                    console.log(`User ${userId} deleted from global users collection`);
                }

                // If using Firebase Realtime Database for global users
                if (window.firebase && window.firebase.database) {
                    const db = window.firebase.database();
                    
                    // Delete from global users
                    const globalUserRef = db.ref(`users/${userId}`);
                    await globalUserRef.remove();
                    
                    console.log(`User ${userId} deleted from global users`);
                }

                return true;

            } catch (error) {
                console.error('Error deleting user from Firebase:', error);
                throw error;
            }
        }

        // UI feedback functions for delete operations
        function showDeleteLoadingState(isLoading) {
            // You could implement a loading spinner or disable buttons here
            if (isLoading) {
                console.log('Delete operation in progress...');
                // Disable all delete buttons temporarily
                const deleteButtons = document.querySelectorAll('.btn-delete');
                deleteButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                });
            } else {
                // Re-enable delete buttons
                const deleteButtons = document.querySelectorAll('.btn-delete');
                deleteButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-trash"></i>';
                });
            }
        }

        function showDeleteSuccessMessage() {
            const notification = document.createElement('div');
            notification.className = 'delete-success-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>User successfully deleted from the system</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; margin-left: 1rem; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function showDeleteErrorMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'delete-error-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #dc3545, #c82333);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            notification.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; margin-left: 1rem; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 8000);
        }

        // Initialize table functionality when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Make existing table rows clickable if they exist
            setTimeout(() => {
                makeUserTableRowsClickable();
            }, 1000);

            // Also initialize when users data is loaded
            if (window.usersDataLoaded) {
                makeUserTableRowsClickable();
            }
            
            // Listen for role definition changes from external sources (e.g., roles.html)
            window.addEventListener('roleDefinitionsUpdated', function(event) {
                console.log('Received role definitions updated event:', event.detail);
                
                // Call the role definitions changed handler
                if (window.onRoleDefinitionsChanged) {
                    window.onRoleDefinitionsChanged();
                }
            });
            
            // Listen for storage changes (in case roles.html updates localStorage)
            window.addEventListener('storage', function(event) {
                if (event.key === 'roleDefinitionsUpdated') {
                    console.log('Role definitions updated via localStorage');
                    
                    if (window.onRoleDefinitionsChanged) {
                        window.onRoleDefinitionsChanged();
                    }
                }
            });
        });

        // Make table functions globally available
        window.populateUsersTable = populateUsersTable;
        window.createUserTableRow = createUserTableRow;
        window.makeUserTableRowsClickable = makeUserTableRowsClickable;
        window.editUserFromTable = editUserFromTable;
        window.deleteUserFromTable = deleteUserFromTable;
        window.deleteUserFromFirebase = deleteUserFromFirebase;
        window.showDeleteSuccessMessage = showDeleteSuccessMessage;
        window.showDeleteErrorMessage = showDeleteErrorMessage;
        window.showDeleteLoadingState = showDeleteLoadingState;
        
        // Make edit functions globally available
        window.handleEditUserSubmission = handleEditUserSubmission;
        window.updateUserInFirebase = updateUserInFirebase;
        window.triggerMenuRefreshForCurrentUser = triggerMenuRefreshForCurrentUser;
        window.updateRoleDisplaysInTable = updateRoleDisplaysInTable;
        window.showRoleChangeNotification = showRoleChangeNotification;
        window.getRoleDisplayName = getRoleDisplayName;
        window.getRoleClass = getRoleClass;
        window.updateOpenModalsOnRoleChange = updateOpenModalsOnRoleChange;
        window.updateRoleDisplayInModal = updateRoleDisplayInModal;
        
        // Test function to verify user management system
        window.testUserManagement = function() {
            console.log('🧪 Testing user management system...');
            
            // Check if modals exist
            const addModal = document.getElementById('addUserModal');
            const editModal = document.getElementById('editUserModal');
            
            console.log('Modal status:', {
                addUserModal: !!addModal,
                editUserModal: !!editModal,
                companyManagement: !!window.companyManagement,
                currentUser: !!window.companyManagement?.currentUser,
                companyId: window.companyManagement?.companyId,
                handleEditUserSubmission: typeof window.handleEditUserSubmission
            });
            
            // Check form fields
            const addFields = [
                'userFirstName', 'userLastName', 'userEmail', 'userEmployeeId', 'userJobTitle', 
                'userDepartment', 'userPhone', 'userCountryCode', 'userAddress',
                'userLineManager', 'userRole', 'userStatus', 'userPassword',
                'userEmailGroup', 'userPasswordGroup'
            ];
            
            const editFields = [
                'editUserFirstName', 'editUserLastName', 'editUserEmail', 'editUserEmployeeId', 'editUserJobTitle',
                'editUserDepartment', 'editUserPhone', 'editUserCountryCode', 'editUserAddress',
                'editUserLineManager', 'editUserRole', 'editUserStatus'
            ];
            
            console.log('Add form fields:', addFields.map(id => ({
                field: id,
                exists: !!document.getElementById(id)
            })));
            
            console.log('Edit form fields:', editFields.map(id => ({
                field: id,
                exists: !!document.getElementById(id)
            })));
            
            // Test edit form submission
            const editForm = document.getElementById('editUserForm');
            const editSubmitButton = editForm?.querySelector('button[type="submit"]');
            
            console.log('Edit form components:', {
                editForm: !!editForm,
                editSubmitButton: !!editSubmitButton,
                formEventListeners: editForm?._eventListeners?.submit?.length || 'unknown'
            });
            
            console.log('✅ User management system test completed');
        };
        
        // Test function specifically for edit form submission
        window.testEditFormSubmission = function() {
            console.log('🧪 Testing edit form submission...');
            
            const editForm = document.getElementById('editUserForm');
            if (!editForm) {
                console.error('❌ Edit form not found');
                return;
            }
            
            // Create a test event
            const testEvent = new Event('submit', { bubbles: true, cancelable: true });
            testEvent.preventDefault = () => { console.log('preventDefault called'); };
            testEvent.stopPropagation = () => { console.log('stopPropagation called'); };
            
            Object.defineProperty(testEvent, 'target', {
                value: editForm,
                writable: false
            });
            
            console.log('🚀 Dispatching test submit event...');
            
            if (typeof handleEditUserSubmission === 'function') {
                handleEditUserSubmission(testEvent);
            } else {
                console.error('❌ handleEditUserSubmission function not available');
            }
        };

        // Simple test for button responsiveness
        window.testEditButtonClick = function() {
            console.log('🧪 Testing edit button click responsiveness...');
            
            const editForm = document.getElementById('editUserForm');
            const submitButton = editForm?.querySelector('button[type="submit"]');
            
            if (!submitButton) {
                console.error('❌ Submit button not found');
                return;
            }
            
            console.log('✅ Submit button found');
            console.log('📊 Button state:', {
                type: submitButton.type,
                disabled: submitButton.disabled,
                textContent: submitButton.textContent.trim(),
                hasClickListeners: submitButton.onclick !== null
            });
            
            // Test if button responds to programmatic click
            console.log('🖱️ Simulating button click...');
            submitButton.click();
            
            console.log('✅ Button click test completed');
        };

        // Test function to verify form data collection is working
        window.testFormDataCollection = function() {
            console.log('🧪 Testing form data collection...');
            
            const editForm = document.getElementById('editUserForm');
            if (!editForm) {
                console.error('❌ Edit form not found');
                return;
            }
            
            console.log('✅ Edit form found');
            
            // Test getting form data
            try {
                const formData = getEditFormData();
                console.log('✅ Form data collection successful');
                console.log('📦 Collected data:', formData);
                
                // Check if any fields have values
                const hasData = Object.values(formData).some(value => value && value.toString().trim() !== '');
                if (hasData) {
                    console.log('✅ Form contains data - collection is working properly');
                } else {
                    console.log('⚠️ Form appears to be empty - make sure to fill some fields first');
                }
                
                return formData;
                
            } catch (error) {
                console.error('❌ Error collecting form data:', error);
                return null;
            }
        };

        // Function to manually trigger the edit form submission (for testing)
        window.testUpdateUser = function() {
            console.log('🧪 MANUAL TEST: Triggering edit user update...');
            
            const editForm = document.getElementById('editUserForm');
            const submitButton = editForm?.querySelector('button[type="submit"]');
            
            if (!submitButton) {
                console.error('❌ Submit button not found');
                return;
            }
            
            if (!window.handleEditUserSubmission) {
                console.error('❌ handleEditUserSubmission function not available');
                return;
            }
            
            console.log('✅ All components found, triggering update...');
            
            // Simulate button click
            submitButton.click();
        };
        
        console.log('🎉 User management system fully rebuilt and ready for testing!');
        
        // Function for roles.html to trigger when role definitions change
        window.onRoleDefinitionsChanged = function() {
            console.log('Role definitions changed, updating all displays...');
            
            // Update role displays in the users table
            updateRoleDisplaysInTable();
            
            // Update open modals
            updateOpenModalsOnRoleChange();
            
            // Refresh role dropdown in edit modal if open
            const editUserModal = document.getElementById('editUserModal');
            if (editUserModal && editUserModal.classList.contains('show')) {
                if (window.companyManagement && window.companyManagement.populateRoleDropdown) {
                    window.companyManagement.populateRoleDropdown();
                    
                    // Re-select the current user's role after dropdown refresh
                    setTimeout(() => {
                        if (currentEditingUser && currentEditingUser.role) {
                            const roleSelect = document.getElementById('editUserRole');
                            if (roleSelect) {
                                roleSelect.value = currentEditingUser.role;
                                console.log('Re-selected role in edit modal:', currentEditingUser.role);
                            }
                        }
                    }, 100);
                }
            }
            
            console.log('All role displays updated after role definitions change');
        };
        
        // Function to force update role displays in real-time
        window.forceUpdateRoleDisplays = function() {
            console.log('Force updating all role displays...');
            
            // Update user details modal if open
            const userDetailsModal = document.getElementById('userDetailsModal');
            if (userDetailsModal && userDetailsModal.classList.contains('show')) {
                const roleElement = document.getElementById('detailRole');
                if (roleElement) {
                    const currentRoleId = roleElement.getAttribute('data-role-id');
                    if (currentRoleId) {
                        updateRoleDisplayInModal(currentRoleId);
                    }
                }
            }
            
            // Update edit modal role dropdown display
            const editUserModal = document.getElementById('editUserModal');
            if (editUserModal && editUserModal.classList.contains('show')) {
                const roleSelect = document.getElementById('editUserRole');
                if (roleSelect && currentEditingUser && currentEditingUser.role) {
                    // Ensure the selected option shows the correct display name
                    const selectedOption = roleSelect.querySelector(`option[value="${currentEditingUser.role}"]`);
                    if (selectedOption && window.companyManagement && window.companyManagement.companyRoles) {
                        const roleData = window.companyManagement.companyRoles[currentEditingUser.role];
                        if (roleData) {
                            selectedOption.textContent = roleData.name || roleData.roleName || currentEditingUser.role;
                        }
                    }
                }
            }
            
            // Update users table
            updateRoleDisplaysInTable();
            
            console.log('Force update of role displays completed');
        };
        
        // Debug function to test role change notifications
        window.debugRoleChange = function(oldRole = 'user', newRole = 'admin', isCurrentUser = true) {
            console.log('Testing role change notification...');
            showRoleChangeNotification(oldRole, newRole, isCurrentUser);
        };
        
        // Debug function to test menu refresh
        window.debugMenuRefresh = async function() {
            console.log('Testing menu refresh...');
            await triggerMenuRefreshForCurrentUser();
        };
        
        // Debug function to check current user permissions specifically for Settings
        window.debugSettingsPermissions = async function() {
            console.log('🔧 DEBUG: Checking Settings permissions for current user');
            
            try {
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    console.log('❌ No authenticated user found');
                    return;
                }
                
                // Get company management instance
                if (!window.companyManagement) {
                    console.log('❌ Company management instance not available');
                    return;
                }
                
                const companyId = window.companyManagement.companyId;
                const userRef = firebase.database().ref(`companies/${companyId}/users/${currentUser.uid}`);
                const userSnapshot = await userRef.once('value');
                
                if (!userSnapshot.exists()) {
                    console.log('❌ User data not found in company');
                    return;
                }
                
                const userData = userSnapshot.val();
                console.log('👤 User data:', userData);
                console.log('🎭 User role:', userData.role);
                
                // Get role permissions
                const roleRef = firebase.database().ref(`companies/${companyId}/roles/${userData.role}`);
                const roleSnapshot = await roleRef.once('value');
                
                if (!roleSnapshot.exists()) {
                    console.log('❌ Role data not found');
                    return;
                }
                
                const roleData = roleSnapshot.val();
                console.log('🔑 Role permissions:', roleData.permissions);
                
                // Check specific Settings-related permissions
                const settingsPermissions = {
                    settings_view: roleData.permissions?.settings_view,
                    account_settings_view: roleData.permissions?.account_settings_view,
                    company_management_view: roleData.permissions?.company_management_view,
                    approval_settings_view: roleData.permissions?.approval_settings_view,
                    field_setup_view: roleData.permissions?.field_setup_view,
                    preferences_view: roleData.permissions?.preferences_view,
                    notification_settings_view: roleData.permissions?.notification_settings_view,
                    user_management_view: roleData.permissions?.user_management_view,
                    role_permissions_view: roleData.permissions?.role_permissions_view
                };
                
                console.log('⚙️ Settings-related permissions:', settingsPermissions);
                
                // Check if Settings dropdown should be visible
                const hasSettingsPermission = settingsPermissions.settings_view?.view === true || settingsPermissions.settings_view === true;
                console.log('🔍 Has settings_view permission:', hasSettingsPermission);
                
                // Check visible child permissions
                const visibleChildPermissions = Object.entries(settingsPermissions)
                    .filter(([key, permission]) => key !== 'settings_view')
                    .filter(([key, permission]) => permission?.view === true || permission === true);
                    
                console.log('👶 Visible child permissions:', visibleChildPermissions);
                console.log('📊 Should Settings dropdown be visible?', hasSettingsPermission || visibleChildPermissions.length > 0);
                
            } catch (error) {
                console.error('❌ Error checking settings permissions:', error);
            }
        };
        window.refreshUsersList = refreshUsersList;
        
        // Debug function to verify user update paths
        window.verifyUserUpdatePath = function(userId) {
            console.log('🔍 Verifying user update path for userId:', userId);
            
            if (!window.companyManagement) {
                console.error('❌ Company management not available');
                return;
            }
            
            const companyId = window.companyManagement.companyId;
            if (!companyId) {
                console.error('❌ Company ID not available');
                return;
            }
            
            const expectedPath = `companies/${companyId}/users/${userId}`;
            console.log('✅ Expected user update path:', expectedPath);
            console.log('🏢 Company ID:', companyId);
            console.log('👤 User ID:', userId);
            
            // Verify path format
            if (expectedPath.includes('/users/') && expectedPath.startsWith('companies/')) {
                console.log('✅ Path format is correct - company-scoped');
            } else {
                console.error('❌ Invalid path format');
            }
            
            return expectedPath;
        };
        
        // Debug function to verify user data loading from correct path
        window.verifyUserDataLoading = async function(userId) {
            try {
                console.log('🔍 Verifying user data loading for userId:', userId);
                
                if (!window.companyManagement) {
                    console.error('❌ Company management system not available');
                    return false;
                }
                
                const companyId = window.companyManagement.companyId;
                if (!companyId) {
                    console.error('❌ Company ID not found');
                    return false;
                }
                
                const expectedPath = `companies/${companyId}/users/${userId}`;
                console.log('📍 Expected user data path:', expectedPath);
                
                // Using Firebase v8 database reference
                const database = firebase.database();
                
                const userRef = database.ref(expectedPath);
                const snapshot = await userRef.once('value');
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    console.log('✅ User data successfully loaded from company-scoped path:', userData);
                    console.log('📍 Path confirmed:', expectedPath);
                    console.log('🔗 Firebase URL:', `https://users-8be65-default-rtdb.firebaseio.com/${expectedPath}`);
                    return {
                        success: true,
                        path: expectedPath,
                        fullUrl: `https://users-8be65-default-rtdb.firebaseio.com/${expectedPath}`,
                        userData: userData
                    };
                } else {
                    console.warn('⚠️ No user data found at path:', expectedPath);
                    console.log('🔗 Attempted Firebase URL:', `https://users-8be65-default-rtdb.firebaseio.com/${expectedPath}`);
                    return {
                        success: false,
                        path: expectedPath,
                        fullUrl: `https://users-8be65-default-rtdb.firebaseio.com/${expectedPath}`,
                        error: 'User not found'
                    };
                }
                
            } catch (error) {
                console.error('❌ Error verifying user data loading:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        };
        
        // Debug function to test edit modal workflow
        window.testEditModalWorkflow = async function(userId) {
            try {
                console.log('🧪 Testing edit modal workflow for userId:', userId);
                
                // Step 1: Verify path
                const pathInfo = window.verifyUserUpdatePath(userId);
                console.log('Step 1 - Path verification:', pathInfo);
                
                // Step 2: Load user data
                const loadResult = await window.verifyUserDataLoading(userId);
                console.log('Step 2 - Data loading verification:', loadResult);
                
                if (loadResult.success) {
                    console.log('✅ Edit modal workflow test passed');
                    console.log('📋 User will be loaded from:', loadResult.fullUrl);
                    console.log('💾 User will be updated at path:', pathInfo);
                    return true;
                } else {
                    console.error('❌ Edit modal workflow test failed - user data not found');
                    return false;
                }
                
            } catch (error) {
                console.error('❌ Error testing edit modal workflow:', error);
                return false;
            }
        };
        
        // Debug function to test details modal workflow 
        window.testDetailsModalWorkflow = async function(userId) {
            try {
                console.log('🧪 Testing details modal workflow for userId:', userId);
                
                // Step 1: Verify same path as edit modal
                const pathInfo = window.verifyUserUpdatePath(userId);
                console.log('Step 1 - Path verification (same as edit modal):', pathInfo);
                
                // Step 2: Load user data using same function
                const loadResult = await window.verifyUserDataLoading(userId);
                console.log('Step 2 - Data loading verification (same function as edit modal):', loadResult);
                
                if (loadResult.success) {
                    console.log('✅ Details modal workflow test passed');
                    console.log('✅ Details modal uses same data path as edit modal');
                    return true;
                } else {
                    console.error('❌ Details modal workflow test failed');
                    return false;
                }
                
            } catch (error) {
                console.error('❌ Error testing details modal workflow:', error);
                return false;
            }
        };
        
        // Debug function to compare modal data consistency
        window.testModalDataConsistency = async function(userId) {
            try {
                console.log('🧪 Testing modal data consistency for userId:', userId);
                
                // Load fresh data (same function both modals use)
                const userData = await loadUserDataFromFirebase(userId);
                
                console.log('📋 Loaded user data from company-scoped path:', userData);
                
                // Test fields available in both modals
                const expectedFields = [
                    'id', 'name', 'email', 'department', 'jobTitle', 
                    'phone', 'countryCode', 'address', 'lineManager', 
                    'role', 'status'
                ];
                
                const missingFields = expectedFields.filter(field => userData[field] === undefined);
                const presentFields = expectedFields.filter(field => userData[field] !== undefined);
                
                console.log('✅ Present fields:', presentFields);
                if (missingFields.length > 0) {
                    console.warn('⚠️ Missing fields:', missingFields);
                }
                
                console.log('✅ Both modals will display the same data with same field structure');
                return {
                    success: true,
                    userData: userData,
                    presentFields: presentFields,
                    missingFields: missingFields
                };
                
            } catch (error) {
                console.error('❌ Error testing modal data consistency:', error);
                return { success: false, error: error.message };
            }
        };
        
        // Debug function to list all user IDs in company
        window.debugListAllUserIds = async function() {
            try {
                console.log('🔍 Listing all user IDs in current company...');
                
                if (!window.companyManagement) {
                    throw new Error('Company management system not available');
                }
                
                const companyId = window.companyManagement.companyId;
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                const database = firebase.database();
                if (!database) {
                    throw new Error('Database connection not available');
                }
                
                // Using Firebase v8 database reference
                
                const allUsersPath = `companies/${companyId}/users`;
                const allUsersRef = database.ref(allUsersPath);
                const snapshot = await allUsersRef.once('value');
                
                if (snapshot.exists()) {
                    const allUsers = snapshot.val();
                    const userList = Object.entries(allUsers).map(([userId, userData]) => ({
                        id: userId,
                        name: userData.name || 'No name',
                        email: userData.email || 'No email'
                    }));
                    
                    console.log('📋 All users in company:');
                    console.table(userList);
                    
                    console.log('🆔 Available user IDs:');
                    userList.forEach(user => {
                        console.log(`  - "${user.id}" (${user.name} - ${user.email})`);
                    });
                    
                    return userList;
                } else {
                    console.log('📭 No users found in company database');
                    return [];
                }
                
            } catch (error) {
                console.error('❌ Error listing user IDs:', error);
                return [];
            }
        };
        
        // Quick debug function to check table row data attributes
        window.debugTableRowData = function() {
            console.log('🔍 Checking all table row data attributes...');
            
            const tableRows = document.querySelectorAll('.users-table tbody tr');
            console.log(`Found ${tableRows.length} table rows`);
            
            tableRows.forEach((row, index) => {
                const userId = row.getAttribute('data-user-id');
                const email = row.getAttribute('data-user-email');
                const nameElement = row.querySelector('.user-name');
                const emailElement = row.querySelector('.user-email');
                
                const extractedName = nameElement ? nameElement.textContent.trim() : 'No name found';
                const extractedEmail = emailElement ? emailElement.textContent.trim() : 'No email found';
                
                console.log(`Row ${index + 1}:`);
                console.log(`  - data-user-id: "${userId}"`);
                console.log(`  - data-user-email: "${email}"`);
                console.log(`  - extracted name: "${extractedName}"`);
                console.log(`  - extracted email: "${extractedEmail}"`);
                console.log('  ---');
            });
        };
        
        // Debug function specifically for the problematic user
        window.debugProblematicUser = async function() {
            console.log('🕵️ Debugging the problematic user klabilatoss@any.gmail.com...');
            
            // First, list all users to see what IDs exist
            const allUsers = await debugListAllUserIds();
            
            // Look for user with email klabilatoss@any.gmail.com
            const targetEmail = 'klabilatoss@any.gmail.com';
            const matchingUser = allUsers.find(user => user.email === targetEmail);
            
            if (matchingUser) {
                console.log('✅ Found user with matching email!');
                console.log(`🆔 Actual user ID: "${matchingUser.id}"`);
                console.log(`📧 Email: "${matchingUser.email}"`);
                console.log(`👤 Name: "${matchingUser.name}"`);
                console.log('');
                console.log('💡 The issue is that the table is using the generated ID "klabilatossany_gmail_com"');
                console.log(`💡 But the actual user ID in Firebase is: "${matchingUser.id}"`);
                console.log('');
                console.log('🔧 Try clicking the modal with the correct ID:');
                console.log(`openUserDetailsModal('${matchingUser.id}')`);
                
                return matchingUser;
            } else {
                console.log('❌ No user found with email:', targetEmail);
                console.log('📋 Available emails:');
                allUsers.forEach(user => {
                    console.log(`  - ${user.email}`);
                });
                return null;
            }
        };
        
        // Quick test function to reload users and check table row data
        window.testUserTableReload = async function() {
            console.log('🔄 Testing user table reload with fixed data attributes...');
            
            // Reload users if companyManagement is available
            if (window.companyManagement && typeof window.companyManagement.loadUsers === 'function') {
                console.log('📡 Reloading users from companyManagement...');
                await window.companyManagement.loadUsers();
                
                // Check table row data after reload
                setTimeout(() => {
                    debugTableRowData();
                    console.log('✅ User table reloaded. Check the data attributes above.');
                    console.log('💡 Now try clicking on a user row - it should use the correct Firebase user ID!');
                }, 1000);
            } else {
                console.log('❌ CompanyManagement not available');
            }
        };

        // Debug function to test header branding
        window.testHeaderBranding = function() {
            console.log('🧪 Testing header branding elements...');
            
            const headerLogo = document.getElementById('headerCompanyLogo');
            const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
            const companyNameHeader = document.getElementById('headerCompanyName');
            
            console.log('Header Logo:', headerLogo ? 'Found' : 'NOT FOUND');
            console.log('Header Logo Placeholder:', headerLogoPlaceholder ? 'Found' : 'NOT FOUND');
            console.log('Company Name Header:', companyNameHeader ? 'Found' : 'NOT FOUND');
            
            if (headerLogoPlaceholder) {
                headerLogoPlaceholder.style.display = 'flex';
                headerLogoPlaceholder.style.background = '#ff0000'; // Red background for testing
                console.log('✅ Placeholder made visible with red background');
            }
            
            if (companyNameHeader) {
                companyNameHeader.style.display = 'inline-block';
                companyNameHeader.textContent = 'TEST COMPANY NAME';
                companyNameHeader.style.color = '#ff0000'; // Red text for testing
                console.log('✅ Company name updated with red text');
            }
            
            // Force call updateCompanyBranding on both instances
            if (window.authManager && window.authManager.updateCompanyBranding) {
                try {
                    window.authManager.updateCompanyBranding();
                    console.log('✅ Called updateCompanyBranding on AuthManager');
                } catch (error) {
                    console.error('❌ Error calling AuthManager.updateCompanyBranding:', error);
                }
            }
            
            if (window.companyManagement && window.companyManagement.updateCompanyBranding) {
                try {
                    window.companyManagement.updateCompanyBranding();
                    console.log('✅ Called updateCompanyBranding on CompanyManagement');
                } catch (error) {
                    console.error('❌ Error calling CompanyManagement.updateCompanyBranding:', error);
                }
            }
            
            console.log('🧪 Header branding test completed');
        };
    </script>
    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-credit-card"></i> Payment Options</h3>
                <button class="close-modal" onclick="closePaymentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="payment-summary">
                    <div class="amount-display">
                        <div class="amount-label">Total Amount Due:</div>
                        <div class="amount-value" id="modalPaymentAmount">$0.00</div>
                    </div>
                    <div class="payment-description" id="paymentDescription">
                        Subscription upgrade payment
                    </div>
                </div>

                <div class="payment-methods">
                    <h4><i class="fas fa-wallet"></i> Select Payment Method</h4>
                    
                    <div class="payment-option" onclick="selectPaymentMethod('orange-money')">
                        <input type="radio" id="orangeMoney" name="paymentMethod" value="orange-money">
                        <label for="orangeMoney">
                            <i class="fas fa-mobile-alt" style="color: #FF6600;"></i>
                            Orange Money
                            <span class="payment-method-desc">Mobile payment via Orange Money</span>
                        </label>
                    </div>

                    <div class="payment-option" onclick="selectPaymentMethod('paypal')">
                        <input type="radio" id="paypal" name="paymentMethod" value="paypal">
                        <label for="paypal">
                            <i class="fab fa-paypal" style="color: #0070BA;"></i>
                            PayPal
                            <span class="payment-method-desc">Secure payment via PayPal</span>
                        </label>
                    </div>
                </div>

                <!-- Orange Money Form -->
                <div id="orangeMoneyForm" class="payment-form" style="display: none;">
                    <h5><i class="fas fa-mobile-alt"></i> Orange Money Payment</h5>
                    <div class="form-group">
                        <label for="orangePhoneNumber">Phone Number:</label>
                        <input type="tel" id="orangePhoneNumber" placeholder="07xxxxxxxx" pattern="[0-9]{10}" required>
                        <div class="form-hint">Enter your Orange Money phone number</div>
                    </div>
                </div>

                <!-- PayPal Form -->
                <div id="paypalForm" class="payment-form" style="display: none;">
                    <h5><i class="fab fa-paypal"></i> PayPal Payment</h5>
                    <p>You will be redirected to PayPal to complete your payment securely.</p>
                    <div class="paypal-info">
                        <i class="fas fa-shield-alt"></i>
                        Your payment is protected by PayPal's security measures
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                <button type="button" id="processPaymentBtn" class="btn btn-success" onclick="processSelectedPayment()" disabled>
                    <i class="fas fa-credit-card"></i>
                    Process Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Payment Processing Modal -->
    <div id="paymentProcessingModal" class="modal">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <div class="modal-body">
                <div class="payment-processing">
                    <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #007bff; margin-bottom: 1rem;"></i>
                    <h4>Processing Payment...</h4>
                    <p id="processingMessage">Please wait while we process your payment.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Success Modal -->
    <div id="paymentSuccessModal" class="modal">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <div class="modal-body">
                <div class="payment-success">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #28a745; margin-bottom: 1rem;"></i>
                    <h4>Payment Successful!</h4>
                    <p>Your subscription has been updated successfully.</p>
                    <div class="success-details" id="successDetails">
                        <!-- Payment details will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn btn-primary" onclick="closePaymentSuccessModal()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Subcontractors Modal -->
    <div id="subcontractorsModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3><i class="fas fa-handshake"></i> Manage Subcontractors</h3>
                <button class="close-modal" onclick="window.companyManagement?.closeSubcontractorModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="modalSub_name" class="required">Company Name</label>
                        <input type="text" id="modalSub_name" required>
                    </div>
                    <div class="form-group">
                        <label for="modalSub_reg">Registration Number</label>
                        <input type="text" id="modalSub_reg">
                    </div>
                    <div class="form-group">
                        <label for="modalSub_contactName">Contact Name</label>
                        <input type="text" id="modalSub_contactName">
                    </div>
                    <div class="form-group">
                        <label for="modalSub_contactEmail">Contact Email</label>
                        <input type="email" id="modalSub_contactEmail">
                    </div>
                    <div class="form-group">
                        <label for="modalSub_contactPhone">Contact Phone</label>
                        <input type="tel" id="modalSub_contactPhone">
                    </div>
                    <div class="form-group">
                        <label for="modalSub_address">Address</label>
                        <input type="text" id="modalSub_address">
                    </div>
                </div>
                <div class="form-group">
                    <label for="modalSub_notes">Notes</label>
                    <textarea id="modalSub_notes" rows="2"></textarea>
                </div>
                <input type="hidden" id="modalSub_id" value="">

                <div style="display:flex;gap:0.5rem;margin:1rem 0;">
                    <button type="button" class="btn btn-secondary" onclick="window.companyManagement?.resetModalSubForm()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button type="button" class="btn btn-primary" onclick="window.companyManagement?.saveModalSubcontractor()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>

                <!-- Subcontractors list moved to Company Profile tab -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="window.companyManagement?.closeSubcontractorModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Access Control Modal (modeled after campset.html modal style) -->
    <div id="accessControlModal" class="modal" style="display:none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3><i class="fas fa-user-shield"></i> Add Access Control</h3>
                <button class="modal-close" onclick="closeModal('accessControlModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="accessControlForm">
                    <div class="form-grid">
                        <div class="form-group" style="grid-column:1/-1;">
                            <label for="acUserSelect" class="form-label">User</label>
                            <select id="acUserSelect" class="form-control">
                                <option value="">Loading users...</option>
                            </select>
                            <small class="form-text text-muted">Choose a user who is not already in the access control list.</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company Profile Tab</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;">
                                <input type="checkbox" id="acAllowProfileTab" checked>
                                Allow access
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">User Management Tab</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;">
                                <input type="checkbox" id="acAllowUsersTab" checked>
                                Allow access
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subscription & Quota Tab</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;">
                                <input type="checkbox" id="acAllowSubsTab" checked>
                                Allow access
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">See + Button</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;">
                                <input type="checkbox" id="acAllowSeeAddBtn" checked>
                                Allow access
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Create With Account</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;">
                                <input type="checkbox" id="acAllowCreateWith" checked>
                                Allow
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Create Without Account</label>
                            <label style="display:flex;align-items:center;gap:0.4rem;">
                                <input type="checkbox" id="acAllowCreateWithout" checked>
                                Allow
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" type="button" onclick="closeModal('accessControlModal')">Cancel</button>
                <button class="btn btn-primary" type="button" onclick="window.saveAccessControlFromModal()">Add</button>
            </div>
        </div>
    </div>

    <!-- Company Name Visibility Modal -->
    <div id="companyVisibilityModal" class="modal" style="display:none;">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3><i class="fas fa-eye"></i> Company Name Visibility</h3>
                <button class="modal-close" onclick="closeModal('companyVisibilityModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:0.75rem;color:#64748b;">Choose which company names this user is allowed to see in the Users table.</p>
                <div id="companyVisibilityOptions" style="display:flex;flex-direction:column;gap:0.5rem;max-height:300px;overflow:auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" type="button" onclick="closeModal('companyVisibilityModal')">Cancel</button>
                <button class="btn btn-primary" type="button" onclick="window.saveCompanyVisibility()">Save</button>
            </div>
        </div>
    </div>

    <!-- Role Visibility Modal - Manage which roles appear in the role dropdown -->
    <div id="roleVisibilityModal" class="modal" style="display:none;">
        <div class="modal-dialog" style="max-width:500px;">
            <div class="modal-header">
                <h3><i class="fas fa-user-tag"></i> Manage Role Visibility</h3>
                <button class="modal-close" onclick="closeModal('roleVisibilityModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:0.75rem;color:#64748b;">Select which roles should appear in the role dropdown when creating new users. Unchecked roles will be hidden from the dropdown.</p>
                <div id="roleVisibilityOptions" style="display:flex;flex-direction:column;gap:0.5rem;max-height:350px;overflow:auto;">
                    <!-- Role checkboxes will be populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" type="button" onclick="closeModal('roleVisibilityModal')">Cancel</button>
                <button class="btn btn-primary" type="button" onclick="window.saveRoleVisibility()">Save</button>
            </div>
        </div>
    </div>

</body>
</html>
