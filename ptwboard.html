<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,1.0">
    <title>HSE System - Permit to Work Board</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="vendor/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase v8 Scripts for Centralized Authentication -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        :root { 
            --primary-color:#2c3e50; 
            --secondary-color:#34495e; 
            --accent-color:#e74c3c; 
            --success-color:#27ae60; 
            --warning-color:#f39c12; 
            --info-color:#3498db; 
            --light-color:#ecf0f1; 
            --dark-color:#2c3e50; 
            --sidebar-width:250px; 
            --transition-speed:.25s; 
        }
        
        * { 
            box-sizing:border-box; 
            margin:0; 
            padding:0; 
        }
        
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            background:#f5f7fa; 
            color:#222; 
        }
        
        .app-container { 
            display:flex; 
            min-height:100vh; 
        }
        
        .sidebar { 
            width:var(--sidebar-width); 
            background:var(--primary-color); 
            color:#fff; 
            padding:1rem; 
            position:fixed; 
            top:0; 
            left:0; 
            bottom:0; 
            overflow-y:auto; 
            transition:transform .3s ease; 
            z-index:1000; 
        }
        
        .sidebar.collapsed { 
            transform:translateX(-100%); 
        }
        
        .main-content { 
            flex:1; 
            margin-left:var(--sidebar-width); 
            padding:0.3rem; 
            padding-top:3.2rem; 
            transition:margin-left .3s ease; 
        }
        
        .main-content.sidebar-collapsed { 
            margin-left:0; 
        }
        
        .main-content.sidebar-collapsed .top-nav { 
            left:0.5rem; 
        }
        
        .logo h2 { 
            text-align:center; 
            padding:1rem 0; 
            border-bottom:1px solid rgba(255,255,255,0.1); 
            font-size:1.05rem; 
            letter-spacing:.5px; 
        }
        
        .menu { 
            list-style:none; 
            margin-top:2rem; 
        }
        
        .menu li { 
            margin-bottom:0.45rem; 
        }
        
        .menu a { 
            display:flex; 
            align-items:center; 
            gap:10px; 
            color:#fff; 
            text-decoration:none; 
            padding:0.6rem 0.75rem; 
            border-radius:6px; 
            font-size:0.82rem; 
            font-weight:500; 
            transition:background .25s; 
        }
        
        .menu a:hover, 
        .menu a.active { 
            background:rgba(255,255,255,0.12); 
        }
        
        .submenu { 
            list-style:none; 
            margin-left:0.75rem; 
            display:none; 
            margin-top:0.25rem; 
        }
        
        .menu-dropdown:hover .submenu { 
            display:block; 
        }
        
        .submenu a { 
            font-size:0.75rem; 
            padding:0.45rem 0.65rem; 
        }
        
        .top-nav { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            padding:0.5rem 0.75rem; 
            background-color:#fff; 
            box-shadow:0 2px 5px rgba(0,0,0,0.1); 
            margin-bottom:0.3rem; 
            position:fixed; 
            top:0.25rem; 
            right:0.5rem; 
            left:calc(var(--sidebar-width) + 0.5rem); 
            height:50px; 
            min-height:50px; 
            z-index:100; 
            transition:left 0.3s ease; 
        }
        
        .sidebar-toggle-btn { 
            background:none; 
            border:none; 
            cursor:pointer; 
            font-size:1.1rem; 
            padding:0.4rem; 
            color:#555; 
        }
        
        .top-nav-left { 
            display:flex; 
            align-items:center; 
            gap:0.75rem; 
        }
        
        .company-branding { 
            display:flex; 
            align-items:center; 
            gap:0.5rem; 
        }
        
        #headerCompanyLogo { 
            width:32px; 
            height:32px; 
            object-fit:contain; 
            display:none; 
        }
        
        #headerCompanyName { 
            font-weight:600; 
            font-size:0.85rem; 
        }
        
        .top-nav-right { 
            display:flex; 
            align-items:center; 
            gap:1rem; 
        }
        
        .notifications { 
            position:relative; 
            display:flex; 
            align-items:center; 
        }
        
        .notification-btn { 
            background:none; 
            border:none; 
            cursor:pointer; 
            position:relative; 
            font-size:1.2rem; 
            padding:0.5rem; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
        }
        
        .notification-badge { 
            position:absolute; 
            top:-5px; 
            right:-5px; 
            background-color:var(--accent-color); 
            color:white; 
            border-radius:50%; 
            padding:0.2rem 0.5rem; 
            font-size:0.7rem; 
            display:none; 
        }
        
        .notification-dropdown { 
            display:none; 
            position:absolute; 
            right:0; 
            top:100%; 
            width:320px; 
            background:#fff; 
            border-radius:8px; 
            box-shadow:0 4px 20px rgba(0,0,0,0.15); 
            z-index:1000; 
            border:1px solid #e9ecef; 
            max-height:400px; 
            overflow:hidden; 
        }
        
        .notification-dropdown.show { 
            display:block; 
            animation: slideDown 0.2s ease-out; 
        }
        
        @keyframes slideDown { 
            from { 
                opacity:0; 
                transform:translateY(-10px);
            } 
            to { 
                opacity:1; 
                transform:translateY(0);
            } 
        }
        
        .notification-header { 
            padding:12px 16px; 
            border-bottom:1px solid #e9ecef; 
            background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%); 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
        }
        
        .notification-header h3 { 
            margin:0; 
            color:#333; 
            font-size:14px; 
            font-weight:600; 
        }
        
        .user-profile { 
            position:relative; 
        }
        
        .profile-btn { 
            background:none; 
            border:none; 
            border-radius:50%; 
            overflow:hidden; 
            width:38px; 
            height:38px; 
            cursor:pointer; 
        }
        
        .profile-btn img { 
            width:100%; 
            height:100%; 
            object-fit:cover; 
        }
        
        .profile-dropdown { 
            display:none; 
            position:absolute; 
            right:0; 
            top:110%; 
            background:#fff; 
            border-radius:8px; 
            min-width:200px; 
            box-shadow:0 6px 18px rgba(0,0,0,0.12); 
            overflow:hidden; 
        }
        
        .profile-dropdown.show { 
            display:block; 
        }
        
        .page-header { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color: #fff; 
            padding: 0.55rem 0.75rem; 
            margin: 0.35rem 0 0.5rem 0; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14); 
            font-size: 0.9rem; 
        }
        
        .page-header h1 { 
            color: #fff; 
            font-size: 0.9rem; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            letter-spacing: 0.5px; 
            margin: 0; 
            font-weight: 600; 
        }
        
        .page-header i { 
            font-size: 1rem; 
        }
        
        .page-actions { 
            display:flex; 
            gap:0.4rem; 
            flex-wrap:wrap; 
        }
        
        .btn-add-new {
            background: none;
            border: none;
            color: #fff;
            padding: 0.4rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }
        
        .btn-add-new:hover {
            color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }
        
        .btn-add-new i {
            font-size: 1.2rem;
        }
        
        .ptw-board-container {
            max-width: 100%;
            margin: 16px auto 0; /* reduced top gap from 40px */
            padding: 14px 20px 20px;
        }

        /* Page header styling */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 0.55rem 0.75rem;
            border-radius: 0;
            margin: 0.35rem 0 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.9rem;
        }
        
        .page-header i {
            font-size: 1rem;
        }
        
        .page-header h1 {
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.9rem;
            margin: 0;
            font-weight: 600;
        }
        
        .page-actions { 
            display: flex; 
            gap: 0.5rem; 
        }
        
        .btn-add-new {
            background: none;
            color: #fff;
            border: none;
            padding: 0.4rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .btn-add-new:hover {
            color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        /* Filter and search section */
        .filters-section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filters-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn-filter {
            padding: 8px 16px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            height: 38px;
        }

        .btn-filter:hover {
            background-color: #0056b3;
        }

        /* PTW Cards */
        .ptw-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .ptw-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 4px solid;
            overflow: hidden;
        }

        .ptw-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .ptw-card.status-pending { border-left-color: #ffc107; }
        .ptw-card.status-submitted { border-left-color: #17a2b8; }
        .ptw-card.status-approved { border-left-color: #28a745; }
        .ptw-card.status-rejected { border-left-color: #dc3545; }
        .ptw-card.status-expired { border-left-color: #6c757d; }
        .ptw-card.status-draft { border-left-color: #e0e0e0; }

        .ptw-card-header {
            padding: 15px 20px 10px;
            background: linear-gradient(135deg, #f8f9fa, #fff);
        }

        .ptw-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
            line-height: 1.3;
        }

        .ptw-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ptw-id {
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending { background: #fff3cd; color: #856404; }
        .status-badge.submitted { background: #d1ecf1; color: #0c5460; }
        .status-badge.approved { background: #d4edda; color: #155724; }
        .status-badge.rejected { background: #f8d7da; color: #721c24; }
        .status-badge.expired { background: #e2e3e5; color: #383d41; }
        .status-badge.draft { background: #f8f9fa; color: #6c757d; }

        .ptw-card-body {
            padding: 0 20px 15px;
        }

        .ptw-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.9rem;
            color: #333;
            font-weight: 400;
        }

        .ptw-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .ptw-card-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ptw-dates {
            font-size: 0.8rem;
            color: #666;
        }

        .ptw-actions {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-view {
            background: #17a2b8;
            color: #fff;
        }

        .btn-view:hover {
            background: #138496;
            color: #fff;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-delete {
            background: #dc3545;
            color: #fff;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-approve {
            background: #28a745;
            color: #fff;
        }

        .btn-approve:hover {
            background: #218838;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        /* Statistics cards */
    .stats-section { margin-top: 4px; margin-bottom: 12px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: #fff;
            padding: 10px 10px 8px;
            border-radius: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            text-align: center;
            border: 1px solid #e2e8f0;
            position: relative;
        }

        /* Remove colored top borders */
        .stat-card.total,
        .stat-card.pending,
        .stat-card.approved,
        .stat-card.expired { border-top-color: #e2e8f0; }

        .stat-number {
            font-size: 1.35rem;
            font-weight: 600;
            line-height: 1.1;
            margin-bottom: 2px;
        }

        .stat-label {
            color: #666;
            font-size: 0.68rem;
            letter-spacing: .3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        /* Subtle hover for affordance */
        .stat-card:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.12); transform: translateY(-2px); transition: all .18s ease; }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .stat-number { font-size: 1.2rem; }
        }

        /* Hide filters section */
        .filters-section {
            display: none !important;
        }

        /* Priority indicators */
        .priority-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .priority-low { background-color: #28a745; }
        .priority-medium { background-color: #ffc107; }
        .priority-high { background-color: #fd7e14; }
        .priority-urgent { background-color: #dc3545; }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-actions {
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            justify-content:flex-end;
            margin-top:24px;
            padding-top:16px;
            border-top:1px solid #e2e8f0;
        }
        .modal-action-btn {
            background:#f1f5f9;
            border:1px solid #d1d9e0;
            border-radius:4px;
            padding:6px 12px;
            font-size:0.7rem;
            font-weight:600;
            letter-spacing:.5px;
            text-transform:uppercase;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            gap:6px;
            color:#2c3e50;
            transition:background .18s ease, box-shadow .18s ease;
        }
        .modal-action-btn:hover { background:#e2e8f0; }
        .modal-action-btn.approve { background:#28a745; color:#fff; border-color:#28a745; }
        .modal-action-btn.approve:hover { background:#21913a; }
        .modal-action-btn.reject { background:#dc3545; color:#fff; border-color:#dc3545; }
        .modal-action-btn.reject:hover { background:#b82332; }
        .modal-action-btn.edit { background:#007bff; color:#fff; border-color:#007bff; }
        .modal-action-btn.edit:hover { background:#0069d4; }
        .modal-action-btn.delete { background:#f8d7da; color:#b00017; border-color:#f5c2c7; }
        .modal-action-btn.delete:hover { background:#f5c2c7; }
        .modal-action-btn.close { background:#6c757d; color:#fff; border-color:#6c757d; }
        .modal-action-btn.close:hover { background:#5a6268; }

        /* PTW Modal Styles - Investigation Report Design */
        .ptw-info-table td { padding:6px 12px; border:1px solid #e5e7eb; vertical-align:top; background:#fff; color:#111827; }
        .ptw-info-table td:first-child { width:180px; font-weight:600; color:#374151; white-space:nowrap; }
        .ptw-section-title { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
            color:#fff; 
            font-weight:600; 
            font-size:.75rem; 
            padding:10px 14px; 
            border:none; 
            border-radius:0; 
            display:flex; 
            align-items:center; 
            gap:10px;
            box-shadow: 0 2px 8px rgba(44,62,80,0.15);
        }
        .ptw-section-title i { 
            font-size: 1rem; 
            width: 28px; 
            height: 28px; 
            background: rgba(255,255,255,0.2); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            flex-shrink: 0;
        }
        .ptw-section-title .section-text { flex: 1; }
        .ptw-section-title.general-section i { background: rgba(52,152,219,0.3); }
        .ptw-section-title.personnel-section i { background: rgba(155,89,182,0.3); }
        .ptw-section-title.schedule-section i { background: rgba(241,196,15,0.3); }
        .ptw-section-title.safety-section i { background: rgba(231,76,60,0.3); }
        .ptw-section-title.equipment-section i { background: rgba(46,204,113,0.3); }
        .ptw-section-title.approval-section i { background: rgba(26,188,156,0.3); }
        .ptw-define-grid { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px 14px; margin-top:8px; }
        .ptw-define-item { border:1px solid #e5e7eb; border-radius:6px; background:#fff; padding:10px 12px; display:flex; align-items:flex-start; column-gap:8px; }
        .ptw-define-item .label { font-size:.74rem; color:#374151; font-weight:700; text-transform:none; letter-spacing:.01em; min-width:140px; white-space:nowrap; }
        .ptw-define-item .label::after { content: ':'; margin-left:4px; }
        .ptw-define-item .value { font-size:.74rem; color:#111827; line-height:1.35; flex:1; }
        .ptw-define-item.stacked { flex-direction:column; gap:4px; grid-column: span 2; }
        .ptw-define-item.stacked .label { min-width:auto; }
        .ptw-define-item.stacked .label::after { content: ':'; }
        .ptw-define-item.stacked .value { width:100%; }
        .ptw-define-item.stacked.boxed { border: none; border-radius: 0; background: transparent; padding: 0; margin-top: 10px; }
        .ptw-define-item.stacked.boxed .label { font-size: .76rem; color: #1f2937; font-weight: 700; margin-bottom: 6px; }
        .ptw-define-item.stacked.boxed .value { font-size: .74rem; color: #374151; line-height: 1.5; background: #f9fafb; padding: 10px 12px; border-radius: 0; border: 1px solid #d1d5db; }
        .ptw-hazard-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .ptw-hazard-badge { background: #fef3c7; color: #92400e; padding: 3px 8px; border-radius: 4px; font-size: .7rem; font-weight: 600; }
        .ptw-table tbody tr { cursor: pointer; transition: background 0.15s ease; }
        .ptw-table tbody tr:hover { background: #f0f7ff !important; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            margin: 0;
            color: #333;
        }

        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .filters-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .ptw-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .ptw-details {
                grid-template-columns: 1fr;
            }
            
            .ptw-card-footer {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }

        /* PTW Modal Print Styles */
        @media print {
            @page { size:A4; margin:6mm 10mm 10mm 10mm; }
            
            /* Hide everything by default */
            html, body { margin:0 !important; padding:0 !important; background:#fff !important; }
            body * { visibility:hidden !important; }
            
            /* Show printable area and all children */
            #ptwDetailsOverlay, 
            #ptwDetailsOverlay *, 
            .printable, 
            .printable * { visibility:visible !important; }
            
            /* Position and size the print area */
            #ptwDetailsOverlay { 
                position:absolute !important; 
                left:0 !important; 
                top:0 !important; 
                width:100% !important; 
                padding:0 !important; 
                background:transparent !important; 
                display:block !important;
                overflow:visible !important;
            }
            
            .modal-content, .ptw-preview-container { 
                box-shadow:none !important; 
                border-radius:0 !important; 
                width:100% !important; 
                max-width:100% !important; 
                min-height:auto !important;
                overflow:visible !important;
            }
            
            .ptw-sheet { 
                width:100% !important; 
                min-height:auto !important; 
                margin:0 !important; 
                padding:0 10mm 10mm !important; 
                border:none !important; 
                box-shadow:none !important; 
            }
            
            /* Hide buttons */
            .ptw-print-btn, .ptw-close-btn, #ptwApprovalActions { display:none !important; }
            
            /* Table styling for print */
            .ptw-info-table { 
                width:100% !important; 
                border-collapse:collapse !important;
                page-break-inside:auto !important;
            }
            
            .ptw-info-table td {
                background:#fff !important;
                color:#111827 !important;
                border:1px solid #e5e7eb !important;
                -webkit-print-color-adjust:exact !important;
                print-color-adjust:exact !important;
            }
            
            .ptw-info-table tr { 
                page-break-inside:avoid !important; 
            }

            /* Section title - enhanced for print */
            .ptw-section-title { 
                background: linear-gradient(135deg, #2c3e50, #34495e) !important; 
                color: #fff !important; 
                border: none !important;
                border-radius: 0 !important;
                padding: 10px 12px !important;
                page-break-after:avoid !important;
                display: flex !important;
                align-items: center !important;
                gap: 10px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .ptw-section-title i {
                color: #fff !important;
                font-size: 0.9rem !important;
                width: 24px !important;
                height: 24px !important;
                background: rgba(255,255,255,0.2) !important;
                border-radius: 50% !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .ptw-define-grid { 
                grid-template-columns: 1fr 1fr !important; 
                gap:8px !important; 
            }
            .ptw-define-item { 
                page-break-inside:avoid !important; 
                break-inside:avoid !important; 
                border:1px solid #e5e7eb !important; 
                background:#fff !important; 
                padding:8px 10px !important;
                margin:0 !important;
                display:flex !important;
                align-items:flex-start !important;
            }
            .ptw-define-item .label { min-width:120px !important; white-space:nowrap !important; font-size:.7rem !important; }
            .ptw-define-item .value { flex:1 !important; font-size:.7rem !important; }

            /* Stacked items in print */
            .ptw-define-item.stacked { flex-direction:column !important; gap:4px !important; grid-column: span 2 !important; }
            .ptw-define-item.stacked .label { min-width:auto !important; }
            .ptw-define-item.stacked .value { width:100% !important; }

            /* Boxed stacked items in print */
            .ptw-define-item.stacked.boxed { 
                border: none !important; 
                border-radius: 0 !important; 
                background: transparent !important; 
                padding: 0 !important; 
                margin-top: 8px !important;
                page-break-inside: avoid !important;
            }
            .ptw-define-item.stacked.boxed .label { 
                font-weight: 700 !important;
                padding-bottom: 0 !important;
                margin-bottom: 4px !important;
                border-bottom: none !important;
            }
            .ptw-define-item.stacked.boxed .value { 
                background: #f9fafb !important;
                padding: 8px 10px !important;
                border-radius: 0 !important;
                border: 1px solid #d1d5db !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Hide generated timestamp in print */
            #ptwModalGenerated { display:none !important; }
            
            /* Section styling */
            .ptw-sections { 
                display:flex !important; 
                flex-direction:column !important; 
                gap:12px !important; 
            }
            
            .ptw-sections .section { 
                page-break-inside:avoid !important; 
                break-inside:avoid !important;
            }
            
            /* Header styling */
            .ptw-header { 
                display:flex !important; 
                justify-content:space-between !important; 
                page-break-after:avoid !important; 
            }
            
            .ptw-logo, #ptwModalLogo { 
                max-width:80px !important; 
                max-height:80px !important;
                -webkit-print-color-adjust:exact !important;
                print-color-adjust:exact !important;
            }

            /* Hazard badges for print */
            .ptw-hazard-badge {
                background: #fef3c7 !important;
                color: #92400e !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Status badges for print */
            .status-badge {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .status-badge.pending { background: #fff3cd !important; color: #856404 !important; }
            .status-badge.submitted { background: #d1ecf1 !important; color: #0c5460 !important; }
            .status-badge.approved { background: #d4edda !important; color: #155724 !important; }
            .status-badge.rejected { background: #f8d7da !important; color: #721c24 !important; }
            .status-badge.expired { background: #e2e3e5 !important; color: #383d41 !important; }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading...</p>
        </div>
    </div>

    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu">
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown active" data-feature="safety_view">
                    <a href="#" class="active"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view"><a href="ptwboard.html" class="active">Permit to Work</a></li>
                        <li data-feature="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
                    </ul>
                </li>
                    <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    	<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    	<ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                    	</ul>
                    </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li data-feature="logistics_view"><a href="#"><i class="fas fa-truck"></i> Logistics</a></li>
                <li class="menu-dropdown" data-feature="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="staff_management_view"><a href="staff.html">Staffing</a></li>
                    </ul>
                </li>
                <li data-feature="finance_view"><a href="#"><i class="fas fa-dollar-sign"></i> Finance</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <nav class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                    <div class="company-branding">
                        <img id="headerCompanyLogo" alt="Company Logo" />
                        <span id="headerCompanyName"></span>
                    </div>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                            <div class="notification-empty">
                                <i class="fas fa-inbox"></i>
                                <div class="notification-empty-title">No notifications</div>
                                <div class="notification-empty-message">You're all caught up</div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile" style="position:relative;">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="user-img" src="" alt="User Avatar" style="display:none;" />
                            <div id="user-initials" style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">??</div>
                        </button>
                        <div class="profile-dropdown"><ul></ul></div>
                    </div>
                </div>
            </nav>
            <div class="page-header">
                <h1><i class="fas fa-file-contract"></i> Permit to Work Board</h1>
                <div class="page-actions">
                    <a href="ptw.html" class="btn-add-new" title="Create New PTW">
                        <i class="fas fa-plus"></i>
                    </a>
                </div>
            </div>

            <div class="ptw-board-container">
                <!-- Statistics Section -->
                <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card total">
                        <div class="stat-number" id="totalPTWs">0</div>
                        <div class="stat-label">Total PTWs</div>
                    </div>
                    <div class="stat-card pending">
                        <div class="stat-number" id="pendingPTWs">0</div>
                        <div class="stat-label">Pending Approval</div>
                    </div>
                    <div class="stat-card approved">
                        <div class="stat-number" id="approvedPTWs">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat-card expired">
                        <div class="stat-number" id="expiredPTWs">0</div>
                        <div class="stat-label">Expired/Due Soon</div>
                    </div>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters-section">
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="searchFilter">Search</label>
                        <input type="text" id="searchFilter" placeholder="Search by title, location, or description...">
                    </div>
                    <div class="filter-group">
                        <label for="statusFilter">Status</label>
                        <select id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="draft">Draft</option>
                            <option value="pending">Pending</option>
                            <option value="submitted">Submitted</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="typeFilter">Permit Type</label>
                        <select id="typeFilter">
                            <option value="">All Types</option>
                            <option value="hot_work">Hot Work</option>
                            <option value="confined_space">Confined Space</option>
                            <option value="electrical">Electrical Work</option>
                            <option value="excavation">Excavation</option>
                            <option value="work_at_height">Work at Height</option>
                            <option value="cold_work">Cold Work</option>
                            <option value="radiography">Radiography</option>
                            <option value="lifting">Lifting Operations</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="departmentFilter">Department</label>
                        <select id="departmentFilter">
                            <option value="">All Departments</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="operations">Operations</option>
                            <option value="construction">Construction</option>
                            <option value="hse">HSE</option>
                            <option value="engineering">Engineering</option>
                            <option value="contractor">Contractor</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button id="applyFilters" class="btn-filter">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
            </div>

            <!-- PTW Table View -->
            <div id="ptwTableContainer" style="margin-top:20px;">
                <table id="ptwTable" class="ptw-table" style="width:100%;border-collapse:collapse;font-size:0.78rem;">
                    <thead style="background:#f1f5f9;">
                        <tr>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">ID</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Title</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Permit Type</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Location</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Department</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Start</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">End</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Status</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Priority</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #e2e8f0;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ptwTableBody">
                        <!-- Rows injected dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-file-contract"></i>
                <h3>No Permit to Work requests found</h3>
                <p>Create your first PTW request to get started.</p>
                <a href="ptw.html" class="btn btn-primary" style="margin-top: 20px;">
                    <i class="fas fa-plus"></i> Create New PTW
                </a>
            </div>

            <!-- PTW Detail Modal (Investigation Report Style) -->
            <div class="modal-overlay" id="ptwDetailsOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:2000; align-items:flex-start; justify-content:center; overflow:auto; padding:32px 20px;">
                <div class="modal-content ptw-preview-container" style="background:#fff; border-radius:12px; width:100%; max-width:940px; min-height:60vh; max-height:85vh; box-shadow:0 18px 42px rgba(0,0,0,0.22); position:relative; overflow:auto;">
                    <!-- Print/Close buttons -->
                    <button id="ptwPrintBtn" class="ptw-print-btn" style="position:absolute; top:10px; right:10px; background:#111827; color:#fff; border:none; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; display:inline-flex; align-items:center; gap:6px; z-index:10;"><i class="fas fa-print"></i> Print / PDF</button>
                    <button id="ptwCloseBtn" class="ptw-close-btn" style="position:absolute; top:10px; right:120px; background:#fff; border:1px solid #d1d5db; color:#111827; border-radius:6px; padding:7px 10px; font-size:.7rem; cursor:pointer; z-index:10;">Close</button>
                    
                    <div class="ptw-sheet printable" style="background:#fff; width:100%; padding:20px 24px 40px; box-sizing:border-box; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; position:relative; line-height:1.4; color:#111827;">
                        <!-- Header with Company Logo and Name -->
                        <div class="ptw-header" style="display:flex; justify-content:space-between; gap:20px; margin-bottom:0; align-items:flex-start;">
                            <div class="company-block" style="display:flex; flex-direction:column; align-items:flex-start; gap:8px;">
                                <img id="ptwModalLogo" class="ptw-logo" src="" alt="Company Logo" style="width:100px; height:100px; object-fit:contain; border:none; border-radius:8px; background:#fff; display:none;">
                                <div id="ptwModalLogoFallback" class="ptw-logo-fallback" style="width:100px; height:100px; display:flex; align-items:center; justify-content:center; font-size:.9rem; font-weight:600; color:#444; background:#f8fafc; border-radius:8px;"></div>
                                <div class="ptw-company">
                                    <h1 id="ptwModalCompanyName" style="margin:0; font-size:1.1rem; line-height:1.2; font-weight:700;"></h1>
                                    <h2 class="doc-title" style="font-size:.9rem; font-weight:700; margin:2px 0 0; color:#111827; text-align:left;">Permit to Work</h2>
                                </div>
                            </div>
                            <div class="ptw-meta" style="font-size:.63rem; color:#374151; text-align:right; line-height:1.35; min-width:150px;">
                                <div id="ptwModalGenerated" style="font-size:.55rem; color:#6b7280; font-weight:500;"></div>
                            </div>
                        </div>
                        
                        <div class="divider" style="height:1px; background:#e5e7eb; margin:12px 0 18px; border-radius:1px;"></div>
                        
                        <!-- Document Number -->
                        <div class="docmeta-row" style="font-size:.72rem; color:#111827; margin:6px 0 12px;">
                            <span style="font-weight:700; color:#374151; margin-right:6px;">Permit Number:</span>
                            <span id="ptwModalDocNumber"></span>
                        </div>
                        
                        <!-- Sections -->
                        <div class="ptw-sections" style="display:flex; flex-direction:column; gap:16px;">
                            <div class="section">
                                <div class="ptw-section-title general-section"><i class="fas fa-clipboard-list"></i><span class="section-text">General Information</span></div>
                                <div id="ptwSectionGeneral" class="ptw-define-grid"></div>
                            </div>
                            <div class="section">
                                <div class="ptw-section-title personnel-section"><i class="fas fa-users"></i><span class="section-text">Personnel</span></div>
                                <div id="ptwSectionPersonnel" class="ptw-define-grid"></div>
                            </div>
                            <div class="section">
                                <div class="ptw-section-title schedule-section"><i class="fas fa-calendar-alt"></i><span class="section-text">Schedule & Duration</span></div>
                                <table class="ptw-info-table" style="width:100%; border-collapse:collapse; font-size:.72rem; margin-top:8px;">
                                    <tbody id="ptwSectionSchedule"></tbody>
                                </table>
                            </div>
                            <div class="section">
                                <div class="ptw-section-title safety-section"><i class="fas fa-exclamation-triangle"></i><span class="section-text">Safety Information</span></div>
                                <div id="ptwSectionSafety" class="ptw-define-grid"></div>
                            </div>
                            <div class="section" id="ptwEquipmentSection" style="display:none;">
                                <div class="ptw-section-title equipment-section"><i class="fas fa-tools"></i><span class="section-text">Equipment & Requirements</span></div>
                                <div id="ptwSectionEquipment" class="ptw-define-grid"></div>
                            </div>
                            <div class="section">
                                <div class="ptw-section-title approval-section"><i class="fas fa-stamp"></i><span class="section-text">Approval Status</span></div>
                                <div id="ptwSectionApproval" style="display:grid; gap:10px; margin-top:10px;"></div>
                            </div>
                            <!-- Approval Actions -->
                            <div id="ptwApprovalActions" class="section" style="display:none; padding-top:12px; border-top:1px solid #e2e8f0; margin-top:12px;">
                                <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <button type="button" id="ptwEditBtn" style="background:#1f2937; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button type="button" id="ptwDeleteBtn" style="background:#dc2626; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <button type="button" id="ptwRejectBtn" style="background:#ef4444; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                        <button type="button" id="ptwApproveBtn" style="background:#10b981; color:#fff; border:none; font-size:0.7rem; padding:6px 10px; border-radius:6px; cursor:pointer; display:none;">
                                            <i class="fas fa-check"></i> Approve
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "909025468149",
            appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
            measurementId: "G-XHFMRCJQEZ"
        };

        // Initialize Firebase
        function initializeFirebase() {
            if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                window.firebase.initializeApp(firebaseConfig);
                console.log('✅ Firebase v8 initialized successfully for centralized auth');
            }
            return window.firebase;
        }

        const firebase = initializeFirebase();
        const auth = firebase.auth();
        const database = firebase.database();

        // Global variables
        let allPTWs = [];
        let filteredPTWs = [];
        let currentUser = null;

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log('User authenticated:', user.email);
                updateUIForAuthenticatedUser(user);
            } else {
                console.log('User not authenticated');
                window.location.href = 'login.html';
            }
        });

        // User profile functions
        function getUserInitials(displayName) {
            if (!displayName) return '??';
            
            const names = displayName.trim().split(' ');
            if (names.length >= 2) {
                return (names[0][0] + names[names.length - 1][0]).toUpperCase();
            } else if (names.length === 1) {
                return names[0][0].toUpperCase() + (names[0][1] || '').toUpperCase();
            }
            return '??';
        }

        function getUserDisplayName() {
            const user = auth.currentUser;
            if (!user) return '';
            
            return user.displayName || 
                   localStorage.getItem('userDisplayName') || 
                   user.email?.split('@')[0] || 
                   'User';
        }

        async function getCompanyIdFor(uid) {
            try {
                if (!uid) return null;
                const snap = await database.ref('users/' + uid).once('value');
                const u = snap.val() || {};
                return u.companyId || u.companyID || u.company || u.company_id || null;
            } catch (e) {
                return null;
            }
        }

        async function getUserAvatarUrl() {
            const user = auth.currentUser;
            if (!user) return null;
            
            try {
                // 1) If auth has a photoURL, use it
                if (user.photoURL) return user.photoURL;

                // 2) If localStorage user has a photo url, use it
                let storedUser = null;
                try {
                    storedUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
                } catch (e) {
                    storedUser = null;
                }
                const directUrl = storedUser?.profilePhotoUrl || storedUser?.profilePicture || storedUser?.photoURL;
                if (directUrl) return directUrl;

                // 3) Resolve companyId from multiple sources (localStorage companyId is often missing)
                const companyId = (
                    window.authManager?.currentUser?.companyId ||
                    storedUser?.companyId ||
                    localStorage.getItem('companyId') ||
                    (await getCompanyIdFor(user.uid)) ||
                    'default'
                );

                const uid = user.uid;
                const names = ['profile', 'avatar'];
                const exts = ['jpg', 'jpeg', 'png'];
                const searchPaths = [];

                // Common company-scoped paths
                if (companyId) {
                    names.forEach((n) => exts.forEach((ext) => searchPaths.push(`companies/${companyId}/avatars/${uid}/${n}.${ext}`)));
                    // Some pages store under companies/{companyId}/users/{uid}/...
                    names.forEach((n) => exts.forEach((ext) => searchPaths.push(`companies/${companyId}/users/${uid}/${n}.${ext}`)));
                }

                // Global fallback paths
                names.forEach((n) => exts.forEach((ext) => searchPaths.push(`avatars/${uid}/${n}.${ext}`)));
                names.forEach((n) => exts.forEach((ext) => searchPaths.push(`profiles/${uid}/${n}.${ext}`)));
                
                // Try each path until we find one that exists
                let lastErr = null;
                for (const path of searchPaths) {
                    try {
                        const storageRef = firebase.storage().ref(path);
                        const downloadURL = await storageRef.getDownloadURL();
                        return downloadURL;
                    } catch (error) {
                        lastErr = error;
                        // Continue to next path if this one doesn't exist
                        continue;
                    }
                }

                if (lastErr) {
                    console.warn('Avatar not found (or no permission). Last error:', lastErr);
                }
                
                // If no avatar found, return null
                return null;
            } catch (error) {
                console.log('Error getting avatar URL:', error);
                return null;
            }
        }

        async function updateUIForAuthenticatedUser(user) {
            try {
                // Update user display name
                const displayName = getUserDisplayName();
                const email = (auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : '';
                
                // Get avatar URL
                const avatarUrl = await getUserAvatarUrl();
                
                // Update profile button avatar
                const btn = document.getElementById('userProfileBtn');
                const btnImg = document.getElementById('user-img');
                const btnInitials = document.getElementById('user-initials');
                const initialsText = getUserInitials(displayName);
                
                if (avatarUrl && btnImg) {
                    btnImg.src = avatarUrl;
                    btnImg.alt = displayName + ' Avatar';
                    btnImg.style.display = 'block';
                    if (btnInitials) btnInitials.style.display = 'none';
                    btnImg.onerror = () => {
                        btnImg.style.display = 'none';
                        if (btnInitials) {
                            btnInitials.textContent = initialsText;
                            btnInitials.style.display = 'flex';
                        }
                    };
                } else {
                    if (btnImg) btnImg.style.display = 'none';
                    if (btnInitials) {
                        btnInitials.textContent = initialsText;
                        btnInitials.style.display = 'flex';
                    }
                }
                
                // Update any display name elements
                const userNameElements = document.querySelectorAll('.user-name, .user-display-name');
                userNameElements.forEach(element => {
                    element.textContent = displayName;
                });

                // Populate profile dropdown list
                const list = document.querySelector('.profile-dropdown ul');
                if (list) {
                    const avatarHtml = avatarUrl 
                        ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`
                        : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${getUserInitials(displayName)}</div>`;
                    list.innerHTML = `
                        <li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                ${avatarHtml}
                                <div>
                                    <div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div>
                                    <div style="color:#666;font-size:12px;">${email}</div>
                                </div>
                            </div>
                        </li>
                        <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                        <li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>
                    `;
                    const logoutLink = list.querySelector('#logoutLink');
                    if (logoutLink) {
                        logoutLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            logout();
                        });
                    }
                }
                
            } catch (error) {
                console.error('Error updating UI for authenticated user:', error);
            }
        }

        function updateUserAvatar() {
            const user = auth.currentUser;
            if (user) {
                updateUIForAuthenticatedUser(user);
            }
        }

        function bindProfileDropdown() {
            const btn = document.getElementById('userProfileBtn');
            const dd = document.querySelector('.profile-dropdown');
            if (!btn || !dd) return;
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                dd.classList.toggle('show');
            });
            document.addEventListener('click', (e) => {
                if (!btn.contains(e.target) && !dd.contains(e.target)) {
                    dd.classList.remove('show');
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') dd.classList.remove('show');
            });
        }

        async function logout() {
            try {
                await firebase.auth().signOut();
            } catch (e) {
                console.warn('Sign out warning:', e);
            } finally {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }

        // Initialize the board
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadPTWData();
            setupEventListeners();
            updateStatistics();
            loadCompanyBranding();
            updateUserAvatar();
            bindProfileDropdown();
        });

        function loadUserData() {
            currentUser = JSON.parse(localStorage.getItem('currentUser')) || {
                name: 'Current User',
                email: 'user@company.com',
                role: 'user'
            };
        }

        function loadPTWData() {
            // Load PTW data from localStorage
            allPTWs = JSON.parse(localStorage.getItem('ptwData')) || [];
            
            // Add sample data if none exists
            if (allPTWs.length === 0) {
                allPTWs = generateSamplePTWs();
                localStorage.setItem('ptwData', JSON.stringify(allPTWs));
            }
            
            filteredPTWs = [...allPTWs];
            renderPTWTable();
        }

        function generateSamplePTWs() {
            const sampleData = [
                {
                    id: 'PTW-001',
                    workTitle: 'Hot Work - Welding on Main Pipeline',
                    permitType: 'hot_work',
                    workDescription: 'Welding repairs on the main water pipeline in section A-12. Work involves cutting and welding steel pipe joints.',
                    workLocation: 'Production Area - Section A-12',
                    department: 'maintenance',
                    priority: 'high',
                    status: 'approved',
                    startDate: '2024-11-08T08:00',
                    endDate: '2024-11-08T17:00',
                    requestedBy: 'John Smith',
                    workSupervisor: 'Mike Johnson',
                    hazards: ['fire', 'toxic', 'mechanical'],
                    createdAt: '2024-11-07T10:00:00.000Z',
                    submittedBy: { name: 'John Smith', department: 'Maintenance' }
                },
                {
                    id: 'PTW-002',
                    workTitle: 'Confined Space Entry - Tank Inspection',
                    permitType: 'confined_space',
                    workDescription: 'Internal inspection of storage tank T-101 for corrosion and structural integrity.',
                    workLocation: 'Storage Tank Area - Tank T-101',
                    department: 'operations',
                    priority: 'medium',
                    status: 'pending',
                    startDate: '2024-11-09T09:00',
                    endDate: '2024-11-09T15:00',
                    requestedBy: 'Sarah Davis',
                    workSupervisor: 'Robert Wilson',
                    hazards: ['confined', 'toxic', 'mechanical'],
                    createdAt: '2024-11-07T14:30:00.000Z',
                    submittedBy: { name: 'Sarah Davis', department: 'Operations' }
                },
                {
                    id: 'PTW-003',
                    workTitle: 'Electrical Maintenance - Control Panel Upgrade',
                    permitType: 'electrical',
                    workDescription: 'Upgrade control panel in pump house #2. Replacement of old relay systems with new digital controls.',
                    workLocation: 'Pump House #2 - Control Room',
                    department: 'engineering',
                    priority: 'low',
                    status: 'submitted',
                    startDate: '2024-11-10T08:00',
                    endDate: '2024-11-11T17:00',
                    requestedBy: 'David Chen',
                    workSupervisor: 'Lisa Anderson',
                    hazards: ['electrical', 'mechanical'],
                    createdAt: '2024-11-07T16:45:00.000Z',
                    submittedBy: { name: 'David Chen', department: 'Engineering' }
                }
            ];
            
            return sampleData;
        }

        function setupEventListeners() {
            // Filter controls
            document.getElementById('searchFilter').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('departmentFilter').addEventListener('change', applyFilters);
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            
            // Modal
            document.getElementById('ptwCloseBtn').addEventListener('click', closePTWModal);
            document.getElementById('ptwPrintBtn').addEventListener('click', () => window.print());
            document.getElementById('ptwDetailsOverlay').addEventListener('click', function(e) {
                if (e.target === this) closePTWModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closePTWModal();
            });
            
            // Keyboard shortcut for new PTW
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    window.location.href = 'ptw.html';
                }
            });
        }

    function applyFilters() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const departmentFilter = document.getElementById('departmentFilter').value;
            
            filteredPTWs = allPTWs.filter(ptw => {
                const matchesSearch = !searchTerm || 
                    ptw.workTitle.toLowerCase().includes(searchTerm) ||
                    ptw.workLocation.toLowerCase().includes(searchTerm) ||
                    ptw.workDescription.toLowerCase().includes(searchTerm);
                    
                const matchesStatus = !statusFilter || ptw.status === statusFilter;
                const matchesType = !typeFilter || ptw.permitType === typeFilter;
                const matchesDepartment = !departmentFilter || ptw.department === departmentFilter;
                
                return matchesSearch && matchesStatus && matchesType && matchesDepartment;
            });
            
            renderPTWTable();
            updateStatistics();
        }

        function renderPTWTable() {
            const tableContainer = document.getElementById('ptwTableContainer');
            const tbody = document.getElementById('ptwTableBody');
            const emptyState = document.getElementById('emptyState');
            if (!tbody) return;

            if (filteredPTWs.length === 0) {
                if (tableContainer) tableContainer.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }

            if (tableContainer) tableContainer.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';

            const rows = filteredPTWs.map(ptw => createPTWRow(ptw)).join('');
            tbody.innerHTML = rows;

            // Wire action buttons
            tbody.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    openPTWModal(btn.getAttribute('data-id'));
                });
            });
            tbody.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    editPTW(btn.getAttribute('data-id'));
                });
            });
            tbody.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    deletePTW(btn.getAttribute('data-id'));
                });
            });
            tbody.querySelectorAll('.btn-approve').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    approvePTW(btn.getAttribute('data-id'));
                });
            });

            // Row click opens modal (excluding clicks on action buttons)
            tbody.querySelectorAll('tr[data-ptw-id]').forEach(row => {
                row.addEventListener('click', (e) => {
                    // Don't open modal if clicking on action buttons
                    if (e.target.closest('.btn-view, .btn-edit, .btn-delete, .btn-approve, a, button')) return;
                    const ptwId = row.getAttribute('data-ptw-id');
                    if (ptwId) openPTWModal(ptwId);
                });
            });
        }

        function createPTWRow(ptw) {
            const startDate = new Date(ptw.startDate);
            const endDate = new Date(ptw.endDate);
            const now = new Date();
            const isExpired = endDate < now && ptw.status === 'approved';
            const actualStatus = isExpired ? 'expired' : ptw.status;
            const priorityLabel = (ptw.priority || 'medium').toString();
            const permitTypeDisplay = ptw.permitType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            return `
                <tr data-ptw-id="${ptw.id}" style="cursor:pointer;">
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;white-space:nowrap;">${ptw.id}</td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;min-width:180px;">${escapeHtml(ptw.workTitle || '')}</td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;">${permitTypeDisplay}</td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;">${escapeHtml(ptw.workLocation || '')}</td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;">${escapeHtml(ptw.department || '')}</td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;white-space:nowrap;">${formatDateTime(startDate)}</td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;white-space:nowrap;">${formatDateTime(endDate)}</td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;"><span class="status-badge ${actualStatus}">${actualStatus}</span></td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;text-transform:capitalize;">${priorityLabel}</td>
                    <td style="padding:8px;border-bottom:1px solid #e2e8f0;white-space:nowrap;">
                        <a href="#" class="btn-view" data-id="${ptw.id}" title="View"><i class="fas fa-eye"></i></a>
                        <a href="#" class="btn-edit" data-id="${ptw.id}" title="Edit" style="margin-left:8px;"><i class="fas fa-edit"></i></a>
                        <a href="#" class="btn-delete" data-id="${ptw.id}" title="Delete" style="margin-left:8px;color:#dc3545;"><i class="fas fa-trash"></i></a>
                        ${actualStatus === 'submitted' ? `<a href="#" class="btn-approve" data-id="${ptw.id}" title="Approve" style="margin-left:8px;color:#28a745;"><i class=\"fas fa-check\"></i></a>` : ''}
                    </td>
                </tr>
            `;
        }

        // Legacy card renderer retained (no longer used). If needed later, re-enable by calling renderPTWGrid().

        function canEditPTW(ptw) {
            // Can edit if owner or admin, and status allows editing
            return (ptw.requestedBy === currentUser.name || currentUser.role === 'admin') &&
                   ['draft', 'rejected'].includes(ptw.status);
        }

        function canApprovePTW(ptw) {
            // Can approve if admin/supervisor and status is pending/submitted
            return (currentUser.role === 'admin' || currentUser.role === 'supervisor') &&
                   ['pending', 'submitted'].includes(ptw.status);
        }

        function canDeletePTW(ptw) {
            // Can delete if owner or admin, and not approved
            return (ptw.requestedBy === currentUser.name || currentUser.role === 'admin') &&
                   !['approved'].includes(ptw.status);
        }

        function updateStatistics() {
            const total = allPTWs.length;
            const pending = allPTWs.filter(ptw => ['pending', 'submitted'].includes(ptw.status)).length;
            const approved = allPTWs.filter(ptw => ptw.status === 'approved').length;
            
            // Count expired PTWs (approved but end date has passed)
            const now = new Date();
            const expired = allPTWs.filter(ptw => {
                const endDate = new Date(ptw.endDate);
                return ptw.status === 'approved' && endDate < now;
            }).length;
            
            document.getElementById('totalPTWs').textContent = total;
            document.getElementById('pendingPTWs').textContent = pending;
            document.getElementById('approvedPTWs').textContent = approved;
            document.getElementById('expiredPTWs').textContent = expired;
        }

        // Helpers
        function escapeHtml(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function pad2(n) { return n < 10 ? '0' + n : '' + n; }
        function formatDateTime(d) {
            if (!(d instanceof Date) || isNaN(d)) return '';
            const yyyy = d.getFullYear();
            const mm = pad2(d.getMonth()+1);
            const dd = pad2(d.getDate());
            const hh = pad2(d.getHours());
            const mi = pad2(d.getMinutes());
            return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
        }

        let currentPTWId = null;

        function openPTWModal(ptwId) {
            const ptw = allPTWs.find(p => p.id === ptwId);
            if (!ptw) return;
            
            currentPTWId = ptwId;
            populatePTWModal(ptw);
            document.getElementById('ptwDetailsOverlay').style.display = 'flex';
        }

        async function populatePTWModal(ptw) {
            const startDate = new Date(ptw.startDate);
            const endDate = new Date(ptw.endDate);
            const createdDate = new Date(ptw.createdAt);
            const now = new Date();
            const isExpired = endDate < now && ptw.status === 'approved';
            const actualStatus = isExpired ? 'expired' : ptw.status;
            const permitTypeDisplay = ptw.permitType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

            // Load company branding
            await loadModalCompanyBranding();

            // Document number and generated date
            document.getElementById('ptwModalDocNumber').textContent = ptw.id;
            document.getElementById('ptwModalGenerated').textContent = `Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`;

            // General Information Section
            const generalSection = document.getElementById('ptwSectionGeneral');
            generalSection.innerHTML = `
                <div class="ptw-define-item">
                    <span class="label">Permit Type</span>
                    <span class="value">${escapeHtml(permitTypeDisplay)}</span>
                </div>
                <div class="ptw-define-item">
                    <span class="label">Status</span>
                    <span class="value"><span class="status-badge ${actualStatus}" style="text-transform:capitalize;">${actualStatus}</span></span>
                </div>
                <div class="ptw-define-item">
                    <span class="label">Location</span>
                    <span class="value">${escapeHtml(ptw.workLocation || '-')}</span>
                </div>
                <div class="ptw-define-item">
                    <span class="label">Department</span>
                    <span class="value" style="text-transform:capitalize;">${escapeHtml(ptw.department || '-')}</span>
                </div>
                <div class="ptw-define-item">
                    <span class="label">Priority</span>
                    <span class="value" style="text-transform:capitalize;">${escapeHtml(ptw.priority || 'Medium')}</span>
                </div>
                <div class="ptw-define-item stacked boxed">
                    <span class="label">Work Title</span>
                    <span class="value">${escapeHtml(ptw.workTitle || '-')}</span>
                </div>
                <div class="ptw-define-item stacked boxed">
                    <span class="label">Work Description</span>
                    <span class="value">${escapeHtml(ptw.workDescription || '-')}</span>
                </div>
            `;

            // Personnel Section
            const personnelSection = document.getElementById('ptwSectionPersonnel');
            personnelSection.innerHTML = `
                <div class="ptw-define-item">
                    <span class="label">Requested By</span>
                    <span class="value">${escapeHtml(ptw.requestedBy || '-')}</span>
                </div>
                <div class="ptw-define-item">
                    <span class="label">Work Supervisor</span>
                    <span class="value">${escapeHtml(ptw.workSupervisor || '-')}</span>
                </div>
                ${ptw.workTeam ? `
                <div class="ptw-define-item">
                    <span class="label">Work Team</span>
                    <span class="value">${escapeHtml(ptw.workTeam)}</span>
                </div>` : ''}
                ${ptw.emergencyContact ? `
                <div class="ptw-define-item">
                    <span class="label">Emergency Contact</span>
                    <span class="value">${escapeHtml(ptw.emergencyContact)}</span>
                </div>` : ''}
                ${ptw.contractorCompany ? `
                <div class="ptw-define-item">
                    <span class="label">Contractor Company</span>
                    <span class="value">${escapeHtml(ptw.contractorCompany)}</span>
                </div>` : ''}
            `;

            // Schedule Section
            const scheduleSection = document.getElementById('ptwSectionSchedule');
            scheduleSection.innerHTML = `
                <tr>
                    <td>Start Date/Time</td>
                    <td>${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString()}</td>
                </tr>
                <tr>
                    <td>End Date/Time</td>
                    <td>${endDate.toLocaleDateString()} ${endDate.toLocaleTimeString()}</td>
                </tr>
                <tr>
                    <td>Created At</td>
                    <td>${createdDate.toLocaleDateString()} ${createdDate.toLocaleTimeString()}</td>
                </tr>
                ${ptw.submittedBy ? `
                <tr>
                    <td>Submitted By</td>
                    <td>${escapeHtml(ptw.submittedBy.name || '-')} ${ptw.submittedBy.department ? `(${escapeHtml(ptw.submittedBy.department)})` : ''}</td>
                </tr>` : ''}
            `;

            // Safety Section
            const safetySection = document.getElementById('ptwSectionSafety');
            let hazardsHtml = '-';
            if (ptw.hazards && ptw.hazards.length > 0) {
                hazardsHtml = `<div class="ptw-hazard-list">${ptw.hazards.map(h => `<span class="ptw-hazard-badge">${escapeHtml(h.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</span>`).join('')}</div>`;
            }
            safetySection.innerHTML = `
                <div class="ptw-define-item stacked">
                    <span class="label">Identified Hazards</span>
                    <span class="value">${hazardsHtml}</span>
                </div>
                ${ptw.safetyMeasures ? `
                <div class="ptw-define-item stacked boxed">
                    <span class="label">Safety Measures</span>
                    <span class="value">${escapeHtml(ptw.safetyMeasures)}</span>
                </div>` : ''}
            `;

            // Equipment Section
            const equipmentSection = document.getElementById('ptwEquipmentSection');
            const equipmentContent = document.getElementById('ptwSectionEquipment');
            if (ptw.equipmentTools || ptw.isolationRequirements || (ptw.attachments && ptw.attachments.length > 0)) {
                equipmentSection.style.display = 'block';
                equipmentContent.innerHTML = `
                    ${ptw.equipmentTools ? `
                    <div class="ptw-define-item stacked boxed">
                        <span class="label">Equipment & Tools</span>
                        <span class="value">${escapeHtml(ptw.equipmentTools)}</span>
                    </div>` : ''}
                    ${ptw.isolationRequirements ? `
                    <div class="ptw-define-item stacked boxed">
                        <span class="label">Isolation Requirements</span>
                        <span class="value">${escapeHtml(ptw.isolationRequirements)}</span>
                    </div>` : ''}
                    ${ptw.attachments && ptw.attachments.length > 0 ? `
                    <div class="ptw-define-item stacked">
                        <span class="label">Attachments</span>
                        <span class="value">
                            <ul style="margin:0; padding-left:18px;">
                                ${ptw.attachments.map(f => `<li>${escapeHtml(f)}</li>`).join('')}
                            </ul>
                        </span>
                    </div>` : ''}
                `;
            } else {
                equipmentSection.style.display = 'none';
            }

            // Approval Section
            const approvalSection = document.getElementById('ptwSectionApproval');
            approvalSection.innerHTML = `
                <div class="ptw-define-item" style="grid-column: span 2;">
                    <span class="label">Current Status</span>
                    <span class="value"><span class="status-badge ${actualStatus}" style="text-transform:capitalize;">${actualStatus}</span></span>
                </div>
                ${ptw.approvedBy ? `
                <div class="ptw-define-item">
                    <span class="label">Approved By</span>
                    <span class="value">${escapeHtml(ptw.approvedBy)}</span>
                </div>
                <div class="ptw-define-item">
                    <span class="label">Approved At</span>
                    <span class="value">${ptw.approvedAt ? new Date(ptw.approvedAt).toLocaleString() : '-'}</span>
                </div>` : ''}
                ${ptw.rejectedBy ? `
                <div class="ptw-define-item">
                    <span class="label">Rejected By</span>
                    <span class="value">${escapeHtml(ptw.rejectedBy)}</span>
                </div>
                <div class="ptw-define-item">
                    <span class="label">Rejected At</span>
                    <span class="value">${ptw.rejectedAt ? new Date(ptw.rejectedAt).toLocaleString() : '-'}</span>
                </div>` : ''}
            `;

            // Approval Actions
            const actionsSection = document.getElementById('ptwApprovalActions');
            const editBtn = document.getElementById('ptwEditBtn');
            const deleteBtn = document.getElementById('ptwDeleteBtn');
            const approveBtn = document.getElementById('ptwApproveBtn');
            const rejectBtn = document.getElementById('ptwRejectBtn');

            actionsSection.style.display = 'block';
            editBtn.style.display = canEditPTW(ptw) ? 'inline-flex' : 'none';
            deleteBtn.style.display = canDeletePTW(ptw) ? 'inline-flex' : 'none';
            approveBtn.style.display = canApprovePTW(ptw) ? 'inline-flex' : 'none';
            rejectBtn.style.display = canApprovePTW(ptw) ? 'inline-flex' : 'none';

            // Wire up action buttons
            editBtn.onclick = () => { editPTW(ptw.id); closePTWModal(); };
            deleteBtn.onclick = () => { deletePTW(ptw.id); closePTWModal(); };
            approveBtn.onclick = () => { approvePTW(ptw.id); openPTWModal(ptw.id); };
            rejectBtn.onclick = () => { rejectPTW(ptw.id); openPTWModal(ptw.id); };
        }

        async function loadModalCompanyBranding() {
            try {
                const logoEl = document.getElementById('ptwModalLogo');
                const fallbackEl = document.getElementById('ptwModalLogoFallback');
                const companyNameEl = document.getElementById('ptwModalCompanyName');

                let currentUser = null;
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                } else {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) currentUser = JSON.parse(storedUser);
                }

                if (!currentUser) {
                    companyNameEl.textContent = 'Dreamex Datalab';
                    logoEl.style.display = 'none';
                    fallbackEl.textContent = 'DD';
                    fallbackEl.style.display = 'flex';
                    return;
                }

                const db = firebase.database();
                const companiesSnap = await db.ref('companies').once('value');
                if (!companiesSnap.exists()) {
                    companyNameEl.textContent = 'Dreamex Datalab';
                    logoEl.style.display = 'none';
                    fallbackEl.textContent = 'DD';
                    fallbackEl.style.display = 'flex';
                    return;
                }

                const companies = companiesSnap.val();
                let companyId = currentUser.companyId || null;

                if (!companyId) {
                    for (const [cId, company] of Object.entries(companies)) {
                        if (company.users && company.users[currentUser.uid]) {
                            companyId = cId;
                            break;
                        }
                    }
                }

                if (companyId && companies[companyId]) {
                    const company = companies[companyId];
                    const companyName = company.companyName || company.name || 'Dreamex Datalab';
                    const logoUrl = company.logoUrl || company.logo || '';

                    companyNameEl.textContent = companyName;
                    if (logoUrl) {
                        logoEl.src = logoUrl;
                        logoEl.style.display = 'block';
                        fallbackEl.style.display = 'none';
                    } else {
                        logoEl.style.display = 'none';
                        const initials = companyName.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
                        fallbackEl.textContent = initials;
                        fallbackEl.style.display = 'flex';
                    }
                } else {
                    companyNameEl.textContent = 'Dreamex Datalab';
                    logoEl.style.display = 'none';
                    fallbackEl.textContent = 'DD';
                    fallbackEl.style.display = 'flex';
                }
            } catch (err) {
                console.warn('Failed to load modal company branding:', err);
            }
        }

        function closePTWModal() {
            document.getElementById('ptwDetailsOverlay').style.display = 'none';
            currentPTWId = null;
        }

        // Legacy viewPTW for backward compatibility
        function viewPTW(ptwId) {
            openPTWModal(ptwId);
        }

        function rejectPTW(ptwId) {
            if (confirm('Reject this PTW request?')) {
                const ptw = allPTWs.find(p => p.id === ptwId);
                if (ptw) {
                    ptw.status = 'rejected';
                    ptw.rejectedBy = currentUser.name;
                    ptw.rejectedAt = new Date().toISOString();
                    localStorage.setItem('ptwData', JSON.stringify(allPTWs));
                    applyFilters();
                    updateStatistics();
                }
            }
        }

        function editPTW(ptwId) {
            // For now, redirect to the form with the PTW ID
            window.location.href = `ptw.html?edit=${ptwId}`;
        }

        function deletePTW(ptwId) {
            if (confirm('Are you sure you want to delete this PTW request? This action cannot be undone.')) {
                allPTWs = allPTWs.filter(ptw => ptw.id !== ptwId);
                localStorage.setItem('ptwData', JSON.stringify(allPTWs));
                applyFilters();
                updateStatistics();
            }
        }

        function approvePTW(ptwId) {
            if (confirm('Are you sure you want to approve this PTW request?')) {
                const ptw = allPTWs.find(p => p.id === ptwId);
                if (ptw) {
                    ptw.status = 'approved';
                    ptw.approvedBy = currentUser.name;
                    ptw.approvedAt = new Date().toISOString();
                    localStorage.setItem('ptwData', JSON.stringify(allPTWs));
                    applyFilters();
                    updateStatistics();
                }
            }
        }

        function closeModal() {
            closePTWModal();
        }

        // Load company name and logo into header (similar to project-list.html)
        async function loadCompanyBranding() {
            try {
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerCompanyName = document.getElementById('headerCompanyName');
                if (!headerLogo || !headerCompanyName) return;

                // Resolve current user from centralized AuthManager or localStorage fallback
                let currentUser = null;
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                } else {
                    const storedUser = localStorage.getItem('currentUser');
                    if (storedUser) currentUser = JSON.parse(storedUser);
                }

                if (!currentUser) {
                    headerCompanyName.textContent = 'Dreamex Datalab';
                    headerLogo.style.display = 'none';
                    return;
                }

                // Check if Firebase is available
                if (typeof firebase === 'undefined' || !firebase.database) {
                    headerCompanyName.textContent = 'Dreamex Datalab';
                    headerLogo.style.display = 'none';
                    return;
                }

                const db = firebase.database();
                const companiesSnap = await db.ref('companies').once('value');
                if (!companiesSnap.exists()) {
                    headerCompanyName.textContent = 'Dreamex Datalab';
                    headerLogo.style.display = 'none';
                    return;
                }

                const companies = companiesSnap.val();
                let companyId = currentUser.companyId || null;

                // If companyId not provided on user, try to locate by membership
                if (!companyId) {
                    for (const [cId, company] of Object.entries(companies)) {
                        if (company?.status !== 'active') continue;
                        if (company?.users && (company.users[currentUser.uid] || company.users[currentUser.authUid])) {
                            companyId = cId;
                            break;
                        }
                    }
                }

                if (companyId && companies[companyId]) {
                    const company = companies[companyId];
                    const companyName = company.companyName || company.name || 'Dreamex Datalab';
                    const logoUrl = company.logoUrl || company.logo || '';

                    headerCompanyName.textContent = companyName;
                    if (logoUrl) {
                        headerLogo.src = logoUrl;
                        headerLogo.style.display = 'block';
                    } else {
                        headerLogo.style.display = 'none';
                    }

                    // Optionally brand the page title
                    if (companyName && companyName !== 'Dreamex Datalab') {
                        document.title = document.title.replace('Dreamex Datalab', companyName);
                    }
                } else {
                    headerCompanyName.textContent = 'Dreamex Datalab';
                    headerLogo.style.display = 'none';
                }
            } catch (err) {
                console.warn('Failed to load company branding:', err);
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerCompanyName = document.getElementById('headerCompanyName');
                if (headerCompanyName) headerCompanyName.textContent = 'Dreamex Datalab';
                if (headerLogo) headerLogo.style.display = 'none';
            }
        }
    </script>
    
    <script src="js/notifications.js"></script>
    <script type="module" src="js/auth.js"></script>
    <script type="module" src="js/roles.js"></script>
</body>
</html>