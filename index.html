<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Chart - Dreamex Datalab HSE</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, get, onValue, set, update, remove, push, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Make Firebase available globally
        window.firebase = { app, db, auth, storage, ref, set, get, onValue, remove, update, push, child, onAuthStateChanged, storageRef, uploadBytes, getDownloadURL, deleteObject };
    </script>
    
    <!-- Comprehensive CSS Styles -->
    <style>
        /* CSS Variables and Base Styles */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
            --transition-speed: 0.2s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
        }

        /* Top Navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.3s;
            display: none; /* Hidden by default, show on mobile */
        }

        .sidebar-toggle-btn:hover {
            background-color: var(--bg-secondary);
            color: var(--secondary-color);
        }

        .header-company-logo {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f8f9fa;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notifications {
            position: relative;
        }

        .notification-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .notification-btn:hover {
            background-color: var(--bg-secondary);
            color: var(--secondary-color);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--red);
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7rem;
            min-width: 18px;
            text-align: center;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 300px;
            z-index: 1000;
        }

        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 50%;
            overflow: hidden;
            width: 40px;
            height: 40px;
        }

        .profile-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 250px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li {
            border-bottom: 1px solid #f0f0f0;
        }

        .profile-dropdown ul li:last-child {
            border-bottom: none;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text-primary);
            transition: background-color 0.3s;
        }

        .profile-dropdown ul li a:hover {
            background-color: var(--bg-secondary);
        }

        .profile-dropdown ul li a i {
            margin-right: 12px;
            width: 16px;
            text-align: center;
        }

        /* Organization Chart Specific Styles */
        .org-chart-container {
            max-width: 100%;
            margin: 90px auto 0;
            padding: 20px;
        }

        .org-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .org-chart-title h2 {
            margin-bottom: 5px;
        }

        .org-chart-title p {
            color: #666;
            margin: 0;
        }

        .org-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .department-container {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }

        .department {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            min-width: 300px;
            max-width: 400px;
            flex: 1;
        }

        .department-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .department-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .department-name i {
            color: #3498db;
        }

        .department-manager {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .manager-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        .manager-info {
            flex: 1;
        }

        .manager-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .manager-title {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .employee-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .employee {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 4px;
            background: #f8f9fa;
            transition: background-color 0.2s;
        }

        .employee:hover {
            background: #e9ecef;
        }

        .employee-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.8em;
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .employee-title {
            font-size: 0.8em;
            color: #7f8c8d;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        /* Complete Organizational Chart Styles */
        .complete-org-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            width: 100%;
        }

        .org-hierarchy-node {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 15px 0;
            position: relative;
        }

        .org-hierarchy-node.level-0 {
            margin-bottom: 30px;
        }

        /* Enhanced Employee Card with Connection Indicators */
        .org-employee-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 250px;
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .org-employee-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            border-color: #007acc;
        }

        /* Connection point at top of card (connects to line manager) */
        .org-employee-card::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: #007acc;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 122, 204, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Connection point at bottom of card (connects to reports) */
        .org-employee-card::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: #0056b3;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 86, 179, 0.3);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Show connection points on hover */
        .org-employee-card:hover::before,
        .org-employee-card:hover::after {
            opacity: 1;
        }

        /* Special styling for cards that have reports */
        .org-employee-card.has-reports::after {
            opacity: 0.7;
        }

        .org-employee-card.has-reports:hover::after {
            opacity: 1;
            transform: translateX(-50%) scale(1.1);
        }

        .org-employee-card.top-level-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #5a67d8;
            min-width: 280px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .org-employee-card.top-level-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 48px rgba(102, 126, 234, 0.4);
        }

        /* Top-level cards don't need top connection points */
        .org-employee-card.top-level-card::before {
            display: none;
        }

        .employee-details {
            flex: 1;
            text-align: center;
        }

        .employee-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
            line-height: 1.3;
            margin-bottom: 6px;
        }

        .employee-title {
            font-weight: 500;
            color: #6c757d;
            font-size: 14px;
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .top-level-card .employee-name {
            color: white;
            font-size: 18px;
        }

        .top-level-card .employee-title {
            color: rgba(255,255,255,0.9);
            font-size: 15px;
        }

        .team-count {
            background: #f8f9fa;
            color: #495057;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #e9ecef;
        }

        .top-level-card .team-count {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* Enhanced Hierarchical Connector Styles */
        .hierarchy-connector {
            width: 6px;
            height: 40px;
            background: linear-gradient(to bottom, #007acc 0%, #0056b3 50%, #004d9f 100%);
            margin: 8px auto;
            border-radius: 3px;
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
        }

        .hierarchy-connector::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #007acc 0%, #0056b3 100%);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 3px 12px rgba(0, 122, 204, 0.4);
        }

        .hierarchy-connector::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #0056b3 0%, #004d9f 100%);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 3px 12px rgba(0, 86, 179, 0.4);
        }

        /* Enhanced Connection Line Animation */
        .hierarchy-connector {
            position: relative;
            overflow: visible;
        }

        .hierarchy-connector:hover {
            background: linear-gradient(to bottom, #0099ff 0%, #007acc 50%, #0056b3 100%);
            transform: scaleY(1.1);
            transition: all 0.3s ease;
        }

        .hierarchy-connector:hover::before,
        .hierarchy-connector:hover::after {
            transform: translateX(-50%) scale(1.1);
            transition: all 0.3s ease;
        }

        /* Animated pulse effect for active connections */
        @keyframes connectionPulse {
            0% { 
                box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
            }
            50% { 
                box-shadow: 0 4px 16px rgba(0, 122, 204, 0.6);
                transform: scaleY(1.05);
            }
            100% { 
                box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
            }
        }

        .org-hierarchy-node:hover .hierarchy-connector {
            animation: connectionPulse 2s ease-in-out infinite;
        }

        /* Connection indicator lines */
        .connection-indicator {
            position: absolute;
            width: 2px;
            background: linear-gradient(to bottom, #007acc, transparent);
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }

        .org-hierarchy-node:hover .connection-indicator {
            opacity: 0.7;
        }

        /* Enhanced Reports Container with Better Connection Lines */
        .reports-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            margin-top: 15px;
            position: relative;
            padding: 25px 0;
        }

        .reports-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 10%;
            right: 10%;
            height: 6px;
            background: linear-gradient(to right, 
                transparent 0%, 
                #007acc 10%, 
                #0056b3 50%, 
                #007acc 90%, 
                transparent 100%);
            border-radius: 3px;
            z-index: 0;
            box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
        }

        /* Enhanced connection lines for individual reports */
        .reports-container > .org-hierarchy-node {
            position: relative;
        }

        .reports-container > .org-hierarchy-node::before {
            content: '';
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 25px;
            background: linear-gradient(to bottom, #007acc, #0056b3);
            border-radius: 3px;
            z-index: 1;
            box-shadow: 0 2px 6px rgba(0, 122, 204, 0.3);
        }

        .reports-container > .org-hierarchy-node::after {
            content: '';
            position: absolute;
            top: -34px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #007acc 0%, #0056b3 100%);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 122, 204, 0.4);
            z-index: 2;
        }

        /* Hover effects for connection lines */
        .reports-container > .org-hierarchy-node:hover::before {
            background: linear-gradient(to bottom, #0099ff, #007acc);
            transform: translateX(-50%) scaleY(1.1);
            transition: all 0.3s ease;
        }

        .reports-container > .org-hierarchy-node:hover::after {
            transform: translateX(-50%) scale(1.15);
            box-shadow: 0 3px 12px rgba(0, 153, 255, 0.5);
            transition: all 0.3s ease;
        }

        /* Level-specific spacing */
        .reports-container.level-1 {
            gap: 35px;
        }

        .reports-container.level-2 {
            gap: 30px;
        }

        .reports-container.level-3 {
            gap: 25px;
        }

        /* Enhanced visual hierarchy */
        .org-hierarchy-node.level-1 .org-employee-card {
            background: linear-gradient(135deg, #fff8f0 0%, #ffeaa7 100%);
            border-color: #fdcb6e;
        }

        .org-hierarchy-node.level-2 .org-employee-card {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border-color: #48bb78;
        }

        .org-hierarchy-node.level-3 .org-employee-card {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7e2 100%);
            border-color: #f56565;
        }

        .hierarchy-node.top-level {
            border-color: var(--primary-color);
            border-width: 3px;
        }

        .hierarchy-node.top-level .employee-node {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* Line Manager Information Styles */
        .line-manager-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #007acc;
            border-radius: 8px 8px 0 0;
            padding: 8px 12px;
            margin-bottom: -2px;
            font-size: 13px;
            color: #495057;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .reports-to {
            color: #333;
            font-weight: 500;
        }

        .line-manager-info + .employee-node {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-top: none;
            margin-top: 0;
        }

        .employee-node {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .employee-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .top-level .employee-avatar {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .employee-info {
            flex: 1;
        }

        .employee-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .top-level .employee-name {
            color: white;
            font-size: 1.2rem;
        }

        .employee-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .top-level .employee-title {
            color: rgba(255,255,255,0.9);
        }

        .employee-department {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 2px;
        }

        .top-level .employee-department {
            color: rgba(255,255,255,0.8);
        }

        .employee-email {
            font-size: 0.8rem;
            color: #999;
        }

        .top-level .employee-email {
            color: rgba(255,255,255,0.7);
        }

        .direct-reports {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .direct-reports-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .reports-container {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .direct-report {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.2s;
        }

        .direct-report:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .direct-report-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .direct-report-info {
            flex: 1;
        }

        .direct-report-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .direct-report-title {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 1px;
        }

        .direct-report-dept {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 1px;
        }

        .sub-reports-count {
            font-size: 0.7rem;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }

        .filter-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            color: #495057;
        }

        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .zoom-btn {
            padding: 8px;
            border: none;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            color: #495057;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: #e9ecef;
            color: #212529;
        }

        /* Department Color Coding */
        .department.hse { border-left: 4px solid #198754; }
        .department.operations { border-left: 4px solid #0d6efd; }
        .department.maintenance { border-left: 4px solid #fd7e14; }
        .department.quality { border-left: 4px solid #6f42c1; }
        .department.admin { border-left: 4px solid #6c757d; }
        .department.hr { border-left: 4px solid #20c997; }
        .department.security { border-left: 4px solid #dc3545; }
        .department.it { border-left: 4px solid #17a2b8; }
        .department.finance { border-left: 4px solid #ffc107; }
        .department.rd { border-left: 4px solid #6610f2; }

        /* Employee Chart Styles */
        .employee-chart-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 30px;
        }

        .employee-chart-section h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
        }

        .chart-container {
            height: 500px;
            max-height: 70vh;
            position: relative;
        }

        /* New Department-based Org Chart Styles */
        .dept-org-chart {
            width: 100%;
            padding: 20px;
        }

        .dept-level {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-start;
        }

        .dept-node {
            background: white;
            border-radius: 8px;
            padding: 15px 25px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 200px;
            transition: all 0.3s ease;
        }

        .dept-node:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .dept-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .dept-employee-count {
            font-size: 0.9em;
            color: #6c757d;
        }

        .hod-node {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px 20px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hod-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        .hod-info {
            text-align: left;
        }

        .hod-name {
            font-weight: 500;
            color: #2c3e50;
        }

        .hod-title {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .dept-connecting-line {
            width: 2px;
            background: #dee2e6;
            height: 20px;
            margin: 0 auto;
        }

        /* Direct Reports Styles */
        .direct-reports {
            margin-top: 15px;
            padding: 10px;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }

        .direct-reports-title {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        .direct-report {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .direct-report:hover {
            background: #f8f9fa;
        }

        .direct-report-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 0.8em;
            font-weight: 500;
        }

        .direct-report-info {
            flex: 1;
        }

        .direct-report-name {
            font-size: 0.9em;
            color: #2c3e50;
            font-weight: 500;
        }

        .direct-report-title {
            font-size: 0.8em;
            color: #6c757d;
        }

        /* Menu visibility for role-based access */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        .menu-loading [data-feature] {
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .department-container {
                flex-direction: column;
            }

            .department {
                width: 100%;
                max-width: none;
            }

            .filters {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            /* Mobile responsive adjustments for header branding */
            .top-nav {
                padding: 0.75rem 1rem;
                border-radius: 0;
            }
            
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 48px;
                height: 48px;
            }

            .sidebar-toggle-btn {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu">
                <li data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="lms_view">
                    <a href="#"><i class="fas fa-graduation-cap"></i> LMS</a>
                    <ul class="submenu">
                        <li data-feature="lms_view"><a href="lmsboard.html">Courses</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
                </li>
                <li data-feature="logistics_view"><a href="#"><i class="fas fa-truck"></i> Logistics</a></li>
                <li class="menu-dropdown" data-feature="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="staff_management_view"><a href="staff.html">Staffing</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companyboard.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo">
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="https://via.placeholder.com/40x40/3498db/ffffff?text=U" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <div class="org-chart-container">
                <div class="org-chart-header">
                    <div class="org-chart-title">
                        <h2>Organization Chart</h2>
                        <p>View and manage company structure</p>
                    </div>
                </div>

                <div id="orgChart" class="org-chart">
                    <div class="dept-org-chart">
                        <div class="dept-level" id="departmentLevel">
                            <!-- Top-level employees (senior leadership) will be rendered here -->
                        </div>
                        <div class="dept-connecting-line"></div>
                        <div class="dept-level" id="hodLevel">
                            <!-- Additional/orphaned employees will be rendered here -->
                        </div>
                    </div>
                </div>

                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomIn" title="Zoom In"><i class="fas fa-plus"></i></button>
                    <button class="zoom-btn" id="zoomOut" title="Zoom Out"><i class="fas fa-minus"></i></button>
                    <button class="zoom-btn" id="resetZoom" title="Reset Zoom"><i class="fas fa-sync"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- Integrated JavaScript -->
    <script>
        // Organization Chart Class
        class OrganizationChart {
            constructor() {
                this.departments = new Map();
                this.employees = {};
                this.currentScale = 1;
                this.isDataLoaded = false;
                
                // Initialize elements
                this.orgChartContainer = document.getElementById('orgChart');
                this.departmentLevel = document.getElementById('departmentLevel');
                this.hodLevel = document.getElementById('hodLevel');
                
                // Initialize zoom controls but delay data loading until auth is ready
                this.initializeZoomControls();
                this.setupEventListeners();
            }

            // Call this method after authentication is complete
            async initializeData() {
                console.log('🔍 InitializeData called, isDataLoaded:', this.isDataLoaded);
                if (!this.isDataLoaded) {
                    console.log('🔍 Loading data for the first time...');
                    await this.loadDepartmentsAndEmployees();
                    this.isDataLoaded = true;
                } else {
                    console.log('🔍 Data already loaded, skipping...');
                }
            }

            // Method to refresh data (useful when company changes or user data updates)
            async refreshData() {
                console.log('🔄 Refreshing organization chart data...');
                this.isDataLoaded = false;
                await this.initializeData();
            }

            // Static method to refresh org chart from external pages
            static async refreshOrgChart() {
                if (window.orgChart) {
                    await window.orgChart.refreshData();
                }
            }

            initializeZoomControls() {
                const zoomInBtn = document.getElementById('zoomIn');
                const zoomOutBtn = document.getElementById('zoomOut');
                const resetZoomBtn = document.getElementById('resetZoom');
                
                if (zoomInBtn) zoomInBtn.addEventListener('click', () => this.zoom(0.1));
                if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => this.zoom(-0.1));
                if (resetZoomBtn) resetZoomBtn.addEventListener('click', () => this.resetZoom());
            }
            
            zoom(delta) {
                this.currentScale = Math.min(Math.max(0.5, this.currentScale + delta), 2);
                if (this.orgChartContainer) {
                    this.orgChartContainer.style.transform = `scale(${this.currentScale})`;
                }
            }
            
            resetZoom() {
                this.currentScale = 1;
                if (this.orgChartContainer) {
                    this.orgChartContainer.style.transform = 'scale(1)';
                }
            }

            async loadDepartmentsAndEmployees() {
                try {
                    // Check if Firebase is available
                    if (!window.firebase || !window.firebase.db) {
                        console.warn('Firebase not available, loading demo data');
                        this.loadDemoData();
                        return;
                    }

                    // Use the specific company ID from the provided URL
                    const companyId = '-OVdOmV_CnbwZ0d7JrkB';
                    
                    console.log('🔍 Loading organization data for company:', companyId);
                    console.log('🔍 Firebase database available:', !!window.firebase.db);

                    // Fetch data from the specific company scope
                    const companyUsersRef = window.firebase.ref(window.firebase.db, `companies/${companyId}/users`);
                    const companyDeptConfigRef = window.firebase.ref(window.firebase.db, `companies/${companyId}/fieldOptions/department`);
                    
                    console.log('🔍 Firebase references created:');
                    console.log('🔍 Users path:', `companies/${companyId}/users`);
                    console.log('🔍 Dept config path:', `companies/${companyId}/fieldOptions/department`);
                    
                    // Get both company users and department configurations
                    const [usersSnapshot, deptConfigSnapshot] = await Promise.all([
                        window.firebase.get(companyUsersRef),
                        window.firebase.get(companyDeptConfigRef)
                    ]);
                    
                    console.log('🔍 Users snapshot exists:', usersSnapshot.exists());
                    console.log('🔍 Dept config snapshot exists:', deptConfigSnapshot.exists());
                    
                    if (usersSnapshot.exists()) {
                        const rawData = usersSnapshot.val();
                        console.log('🔍 Raw user data from Firebase:', rawData);
                        console.log('🔍 Number of users found:', Object.keys(rawData || {}).length);
                    } else {
                        console.log('❌ No users found at path:', `companies/${companyId}/users`);
                        
                        // Try alternative paths to see if data exists elsewhere
                        console.log('🔍 Trying alternative paths...');
                        try {
                            const globalUsersRef = window.firebase.ref(window.firebase.db, 'users');
                            const globalSnapshot = await window.firebase.get(globalUsersRef);
                            if (globalSnapshot.exists()) {
                                console.log('🔍 Found data in global users path:', Object.keys(globalSnapshot.val()).length, 'users');
                            }
                        } catch (e) {
                            console.log('🔍 Error checking global users:', e);
                        }
                        
                        try {
                            const companiesRef = window.firebase.ref(window.firebase.db, 'companies');
                            const companiesSnapshot = await window.firebase.get(companiesRef);
                            if (companiesSnapshot.exists()) {
                                console.log('🔍 Available companies:', Object.keys(companiesSnapshot.val()));
                            }
                        } catch (e) {
                            console.log('🔍 Error checking companies:', e);
                        }
                    }
                    
                    this.employees = {};
                    this.departments.clear();
                    
                    // Create a map of department configurations from company scope
                    const deptConfigs = new Map();
                    if (deptConfigSnapshot.exists()) {
                        const deptData = deptConfigSnapshot.val();
                        if (typeof deptData === 'object') {
                            Object.values(deptData).forEach(dept => {
                                if (dept.value) {
                                    deptConfigs.set(dept.value, {
                                        headOfDepartmentName: dept.headOfDepartmentName || null,
                                        headOfDepartment: dept.headOfDepartment || null,
                                        label: dept.label || dept.value
                                    });
                                }
                            });
                        }
                    }
                    
                    // First pass: collect all employees from company scope
                    if (usersSnapshot.exists()) {
                        const usersData = usersSnapshot.val();
                        console.log('🔍 Processing users data...');
                        Object.entries(usersData).forEach(([userId, employee]) => {
                            console.log(`🔍 Processing user ${userId}:`, employee);
                            console.log(`🔍 Has firstName: ${!!employee.firstName}, lastName: ${!!employee.lastName}`);
                            
                            // Include all employees from this company's data
                            if (employee.firstName && employee.lastName) {
                                this.employees[userId] = {
                                    id: userId,
                                    companyId: companyId,
                                    firstName: employee.firstName,
                                    lastName: employee.lastName,
                                    email: employee.email || '',
                                    department: employee.department || 'Unassigned',
                                    jobTitle: employee.jobTitle || employee.position || 'Employee',
                                    lineManager: employee.lineManager || employee.supervisor || null,
                                    ...employee
                                };
                                console.log(`✅ Added employee with lineManager:`, {
                                    name: `${employee.firstName} ${employee.lastName}`,
                                    lineManager: employee.lineManager,
                                    id: userId
                                });
                            } else {
                                console.log(`❌ Skipped user ${userId} - missing firstName or lastName`);
                            }
                        });
                    }
                    
                    // Create a map for quick lookup of employees by ID
                    const employeeMap = new Map(Object.entries(this.employees));
                    
                    // Second pass: organize departments and establish relationships
                    Object.values(this.employees).forEach(employee => {
                        if (employee.department) {
                            if (!this.departments.has(employee.department)) {
                                const deptConfig = deptConfigs.get(employee.department) || {};
                                this.departments.set(employee.department, {
                                    name: deptConfig.label || employee.department,
                                    headOfDepartment: null,
                                    headOfDepartmentName: deptConfig.headOfDepartmentName || null,
                                    employees: [],
                                    companyId: companyId
                                });
                            }
                            
                            const dept = this.departments.get(employee.department);
                            dept.employees.push(employee);
                            
                            // If this employee is the head of department from config
                            const deptConfig = deptConfigs.get(employee.department);
                            if (deptConfig && deptConfig.headOfDepartment === employee.id) {
                                dept.headOfDepartment = employee;
                            }
                        }
                    });
                    
                    console.log(`🔍 Final results: ${Object.keys(this.employees).length} employees from ${this.departments.size} departments for company ${companyId}`);
                    console.log('🔍 All employees:', this.employees);
                    console.log('🔍 All departments:', Array.from(this.departments.entries()));
                    
                    if (Object.keys(this.employees).length === 0) {
                        console.log('❌ No employees found - showing no data message');
                        this.showNoDataMessage(companyId);
                    } else {
                        console.log('✅ Rendering organization chart...');
                        this.renderOrganizationChart();
                    }
                } catch (error) {
                    console.error('Error loading organization data:', error);
                    this.loadDemoData();
                }
            }

            showNoDataMessage(companyId) {
                if (this.departmentLevel) {
                    this.departmentLevel.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-building" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                            <h3 style="margin-bottom: 8px;">No Organization Data Found</h3>
                            <p>No employees or departments found for company: <strong>${companyId}</strong></p>
                            <p style="font-size: 14px; margin-top: 16px;">Please contact your administrator to set up organizational data.</p>
                        </div>
                    `;
                }
                if (this.hodLevel) {
                    this.hodLevel.innerHTML = '';
                }
            }

            loadDemoData() {
                // Load demo data when Firebase is not available
                this.departments.clear();
                this.employees = {};
                
                // Get company ID for demo data
                const currentUser = window.authManager?.getCurrentUser();
                const companyId = currentUser?.companyId || 'dreamex-datalab-demo';
                
                console.log('Loading demo data for company:', companyId);
                
                // Create demo employees with proper line manager relationships
                const demoEmployees = {
                    'demo-ceo-001': {
                        id: 'demo-ceo-001',
                        firstName: 'John',
                        lastName: 'Smith',
                        jobTitle: 'Chief Executive Officer',
                        department: 'Executive',
                        email: 'john.smith@dreamexdatalab.com',
                        lineManager: null,
                        companyId: companyId
                    },
                    'demo-hse-001': {
                        id: 'demo-hse-001',
                        firstName: 'Jane',
                        lastName: 'Doe',
                        jobTitle: 'HSE Manager',
                        department: 'Health, Safety & Environment',
                        email: 'jane.doe@dreamexdatalab.com',
                        lineManager: 'demo-ceo-001',
                        companyId: companyId
                    },
                    'demo-hse-002': {
                        id: 'demo-hse-002',
                        firstName: 'Michael',
                        lastName: 'Brown',
                        jobTitle: 'Safety Officer',
                        department: 'Health, Safety & Environment',
                        email: 'michael.brown@dreamexdatalab.com',
                        lineManager: 'demo-hse-001',
                        companyId: companyId
                    },
                    'demo-ops-001': {
                        id: 'demo-ops-001',
                        firstName: 'Sarah',
                        lastName: 'Wilson',
                        jobTitle: 'Operations Manager',
                        department: 'Operations',
                        email: 'sarah.wilson@dreamexdatalab.com',
                        lineManager: 'demo-ceo-001',
                        companyId: companyId
                    },
                    'demo-ops-002': {
                        id: 'demo-ops-002',
                        firstName: 'David',
                        lastName: 'Johnson',
                        jobTitle: 'Operations Officer',
                        department: 'Operations',
                        email: 'david.johnson@dreamexdatalab.com',
                        lineManager: 'demo-ops-001',
                        companyId: companyId
                    },
                    'demo-hr-001': {
                        id: 'demo-hr-001',
                        firstName: 'Emily',
                        lastName: 'Davis',
                        jobTitle: 'HR Manager',
                        department: 'Human Resources',
                        email: 'emily.davis@dreamexdatalab.com',
                        lineManager: 'demo-ceo-001',
                        companyId: companyId
                    },
                    'demo-it-001': {
                        id: 'demo-it-001',
                        firstName: 'Alex',
                        lastName: 'Chen',
                        jobTitle: 'IT Manager',
                        department: 'Information Technology',
                        email: 'alex.chen@dreamexdatalab.com',
                        lineManager: 'demo-ceo-001',
                        companyId: companyId
                    }
                };
                
                // Set employees
                this.employees = demoEmployees;
                
                // Create departments with proper head assignments
                const departmentMap = {
                    'Executive': { head: 'demo-ceo-001', label: 'Executive' },
                    'Health, Safety & Environment': { head: 'demo-hse-001', label: 'Health, Safety & Environment' },
                    'Operations': { head: 'demo-ops-001', label: 'Operations' },
                    'Human Resources': { head: 'demo-hr-001', label: 'Human Resources' },
                    'Information Technology': { head: 'demo-it-001', label: 'Information Technology' }
                };
                
                Object.entries(departmentMap).forEach(([deptName, config]) => {
                    const employees = Object.values(demoEmployees).filter(emp => emp.department === deptName);
                    const headOfDept = demoEmployees[config.head];
                    
                    this.departments.set(deptName, {
                        name: config.label,
                        headOfDepartment: headOfDept,
                        headOfDepartmentName: headOfDept ? `${headOfDept.firstName} ${headOfDept.lastName}` : null,
                        employees: employees,
                        companyId: companyId
                    });
                });
                
                console.log(`Loaded ${Object.keys(this.employees).length} demo employees from ${this.departments.size} departments`);
                this.renderOrganizationChart();
            }
            
            setupEventListeners() {
                // Setup sidebar toggle for mobile
                const sidebarToggle = document.getElementById('sidebarToggle');
                const sidebar = document.querySelector('.sidebar');
                
                if (sidebarToggle && sidebar) {
                    sidebarToggle.addEventListener('click', () => {
                        sidebar.classList.toggle('show');
                    });
                }

                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 768 && 
                        !sidebar.contains(e.target) && 
                        !sidebarToggle.contains(e.target) && 
                        sidebar.classList.contains('show')) {
                        sidebar.classList.remove('show');
                    }
                });
            }
            
            getDepartmentNodeHTML(department) {
                return `
                    <div class="dept-node ${department.name.toLowerCase().replace(/\s+/g, '-')}">
                        <div class="dept-name">${department.name}</div>
                        <div class="dept-employee-count">${department.employees.length} employees</div>
                    </div>
                `;
            }
            
            getHodNodeHTML(department) {
                const hod = department.headOfDepartment;
                const hodName = hod ? 
                    `${hod.firstName} ${hod.lastName}` : 
                    (department.headOfDepartmentName || 'No Head of Department');
                
                // Find direct reports - employees who have this person as their line manager
                let directReports = [];
                if (hod) {
                    directReports = Object.values(this.employees).filter(employee => {
                        return employee.lineManager === hod.id;
                    });
                }
                
                // Generate direct reports HTML
                const directReportsHTML = directReports.length > 0 ? `
                    <div class="direct-reports">
                        <div class="direct-reports-title">Direct Reports (${directReports.length})</div>
                        ${directReports.map(employee => `
                            <div class="direct-report">
                                <div class="direct-report-avatar">
                                    ${employee.firstName[0]}${employee.lastName[0]}
                                </div>
                                <div class="direct-report-info">
                                    <div class="direct-report-name">${employee.firstName} ${employee.lastName}</div>
                                    <div class="direct-report-title">${employee.jobTitle || ''}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="direct-reports">
                        <div class="direct-reports-title">No Direct Reports</div>
                    </div>
                `;

                return `
                    <div class="dept-node ${department.name.toLowerCase().replace(/\s+/g, '-')}">
                        <div class="hod-node">
                            <div class="hod-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="hod-info">
                                <div class="hod-name">${hodName}</div>
                                <div class="hod-title">Head of ${department.name}</div>
                            </div>
                        </div>
                        ${directReportsHTML}
                    </div>
                `;
            }
            
            renderOrganizationChart() {
                if (!this.departmentLevel) return;
                
                // Clear previous content
                this.departmentLevel.innerHTML = '';
                if (this.hodLevel) this.hodLevel.innerHTML = '';
                
                // Build hierarchical structure based on line manager relationships
                const hierarchy = this.buildHierarchy();
                
                // Create a complete hierarchical visualization
                const hierarchicalHTML = this.renderCompleteHierarchy(hierarchy);
                this.departmentLevel.innerHTML = hierarchicalHTML;
            }

            buildHierarchy() {
                console.log('📈 Building hierarchy...');
                console.log('🔍 All employees data:', this.employees);
                
                // Log all employees with their line manager info
                Object.values(this.employees).forEach(emp => {
                    const empName = emp.firstName && emp.lastName ? 
                        `${emp.firstName} ${emp.lastName}` : emp.name;
                    console.log(`👤 Employee: ${empName}, Line Manager: ${emp.lineManager || 'None'}`);
                });
                
                const employeeMap = new Map(Object.entries(this.employees));
                const processedEmployees = new Set();
                
                // Find top-level employees (no line manager or CEO/senior roles)
                const topLevelEmployees = this.findTopLevelEmployees();
                
                console.log('🎯 Top level employees found:', topLevelEmployees.length);
                
                // Build the complete organizational tree
                const organizationTree = topLevelEmployees.map(employee => 
                    this.buildCompleteEmployeeTree(employee, employeeMap, processedEmployees)
                );
                
                // Find any orphaned employees not yet processed
                const orphanedEmployees = Object.values(this.employees).filter(employee => 
                    !processedEmployees.has(employee.id)
                );
                
                if (orphanedEmployees.length > 0) {
                    console.log('🔍 Found orphaned employees:', orphanedEmployees.length);
                    orphanedEmployees.forEach(employee => {
                        organizationTree.push(this.buildCompleteEmployeeTree(employee, employeeMap, processedEmployees));
                    });
                }
                
                console.log('✅ Complete organization tree built with', organizationTree.length, 'root nodes');
                console.log('📊 Total employees processed:', processedEmployees.size);
                
                return organizationTree;
            }

            findTopLevelEmployees() {
                // First, find employees with no line manager
                let topLevel = Object.values(this.employees).filter(employee => 
                    !employee.lineManager || employee.lineManager === '' || employee.lineManager === null
                );
                
                // If no clear top-level found, look for senior roles
                if (topLevel.length === 0) {
                    const seniorRoles = ['ceo', 'president', 'director', 'manager', 'head', 'chief'];
                    for (const role of seniorRoles) {
                        const seniorEmployee = Object.values(this.employees).find(employee => 
                            employee.jobTitle && employee.jobTitle.toLowerCase().includes(role)
                        );
                        if (seniorEmployee) {
                            topLevel = [seniorEmployee];
                            break;
                        }
                    }
                }
                
                return topLevel;
            }

            buildCompleteEmployeeTree(employee, employeeMap, processedEmployees) {
                // Mark this employee as processed
                processedEmployees.add(employee.id);
                
                // Find all direct reports using name-based matching
                const employeeName = employee.firstName && employee.lastName ? 
                    `${employee.firstName} ${employee.lastName}` : employee.name;
                
                const directReports = Object.values(this.employees).filter(emp => {
                    if (processedEmployees.has(emp.id)) return false;
                    return emp.lineManager === employeeName;
                });
                
                return {
                    employee: employee,
                    reports: directReports.map(report => 
                        this.buildCompleteEmployeeTree(report, employeeMap, processedEmployees)
                    )
                };
            }

            renderCompleteHierarchy(organizationTree) {
                if (!organizationTree || organizationTree.length === 0) {
                    return '<div style="text-align: center; padding: 40px; color: #666;">No organizational data available</div>';
                }
                
                return `
                    <div class="complete-org-chart">
                        ${organizationTree.map(rootNode => this.renderEmployeeWithReports(rootNode, 0)).join('')}
                    </div>
                `;
            }

            renderEmployeeWithReports(employeeNode, level) {
                const employee = employeeNode.employee;
                const reports = employeeNode.reports || [];
                
                // Generate employee card
                const employeeCard = this.generateEmployeeCard(employee, level, reports.length);
                
                // If no reports, return just the card
                if (reports.length === 0) {
                    return `
                        <div class="org-hierarchy-node level-${level}">
                            ${employeeCard}
                        </div>
                    `;
                }
                
                // Render employee with their reports below
                const reportsHTML = reports.map(reportNode => 
                    this.renderEmployeeWithReports(reportNode, level + 1)
                ).join('');
                
                return `
                    <div class="org-hierarchy-node level-${level}">
                        ${employeeCard}
                        <div class="hierarchy-connector"></div>
                        <div class="reports-container level-${level + 1}">
                            ${reportsHTML}
                        </div>
                    </div>
                `;
            }

            generateEmployeeCard(employee, level, reportsCount) {
                const isTopLevel = level === 0;
                const hasReports = reportsCount > 0;
                
                return `
                    <div class="org-employee-card ${isTopLevel ? 'top-level-card' : ''} ${hasReports ? 'has-reports' : ''}">
                        <div class="employee-details">
                            <div class="employee-name">
                                ${employee.firstName && employee.lastName ? 
                                    `${employee.firstName} ${employee.lastName}` :
                                    (employee.name || 'Unknown')
                                }
                            </div>
                            <div class="employee-title">${employee.jobTitle || 'Employee'}</div>
                        </div>
                        ${reportsCount > 0 ? `
                            <div class="team-count">
                                <i class="fas fa-users"></i>
                                <span>${reportsCount} ${reportsCount === 1 ? 'Report' : 'Reports'}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            markProcessed(employee, processedSet, addedEmployees) {
                processedSet.add(employee.id);
                addedEmployees.add(employee.id);
                
                // Mark all subordinates as processed too
                const employeeName = employee.firstName && employee.lastName ? 
                    `${employee.firstName} ${employee.lastName}` : employee.name;
                    
                const directReports = Object.values(this.employees).filter(emp => 
                    emp.lineManager === employeeName && !addedEmployees.has(emp.id)
                );
                directReports.forEach(report => this.markProcessed(report, processedSet, addedEmployees));
            }
        }

        // Basic Authentication Manager
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.isInitialized = false;
            }

            async init() {
                if (this.isInitialized) return;

                // Check for stored user data
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    try {
                        this.currentUser = JSON.parse(savedUser);
                        await this.updateUIForAuthenticatedUser();
                    } catch (e) {
                        console.error('Error parsing saved user:', e);
                        this.currentUser = null;
                        // Create demo user for demonstration
                        this.createDemoUser();
                    }
                } else {
                    // Create demo user for demonstration
                    this.createDemoUser();
                }

                // Check Firebase auth state if available
                if (window.firebase && window.firebase.onAuthStateChanged) {
                    window.firebase.onAuthStateChanged(window.firebase.auth, async (user) => {
                        if (user) {
                            await this.handleFirebaseUser(user);
                        } else if (!this.currentUser) {
                            this.redirectToLogin();
                        }
                    });
                } else if (!this.currentUser) {
                    this.redirectToLogin();
                }

                this.isInitialized = true;
            }

            async handleFirebaseUser(firebaseUser) {
                try {
                    const userRef = window.firebase.ref(window.firebase.db, `users/${firebaseUser.uid}`);
                    const snapshot = await window.firebase.get(userRef);
                    const userData = snapshot.val() || {};

                    this.currentUser = {
                        uid: firebaseUser.uid,
                        email: firebaseUser.email,
                        role: userData.role || 'standard',
                        name: userData.name || firebaseUser.email.split('@')[0],
                        department: userData.department || 'Unknown',
                        companyId: userData.companyId || null
                    };

                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    await this.updateUIForAuthenticatedUser();
                } catch (error) {
                    console.error('Error handling Firebase user:', error);
                }
            }

            async updateUIForAuthenticatedUser() {
                // Update user profile display
                const profileBtn = document.getElementById('userProfileBtn');
                const profileDropdown = document.querySelector('.profile-dropdown ul');
                
                if (profileBtn && this.currentUser) {
                    // Use centralized display methods
                    const initials = this.getUserInitials();
                    const displayName = this.getUserDisplayName();
                    const email = this.getUserEmail();
                    
                    // Preload avatar URL to avoid showing initials first
                    const avatarUrl = await this.getUserAvatarUrl();
                    
                    // Update profile image - show the correct image immediately
                    const profileImg = profileBtn.querySelector('img');
                    if (profileImg) {
                        if (avatarUrl) {
                            profileImg.src = avatarUrl;
                            profileImg.alt = displayName + ' Avatar';
                        } else {
                            // Generate initials avatar
                            this.generateInitialsAvatar(displayName, profileImg);
                        }
                    }
                    
                    // Create avatar for dropdown (either real avatar or initials)
                    let dropdownAvatarHtml;
                    if (avatarUrl) {
                        dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                    }
                    
                    // Update profile dropdown with user info
                    if (profileDropdown) {
                        const userInfoHtml = `
                            <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    ${dropdownAvatarHtml}
                                    <div>
                                        <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                            ${displayName}
                                        </div>
                                        <div style="color: #666; font-size: 12px;">
                                            ${email}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                            <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        `;
                        
                        profileDropdown.innerHTML = userInfoHtml;
                    }
                }

                // Update menu visibility based on features and roles
                await this.updateMenuWithFeatureAuthorization();

                // Update header branding
                await this.updateHeaderBranding();
            }

            async updateHeaderBranding() {
                // Use the same specific company ID as the organization data
                const companyId = '-OVdOmV_CnbwZ0d7JrkB';
                
                console.log('🏢 Updating header branding for company:', companyId);

                try {
                    // Get company data for branding
                    const companyRef = window.firebase.ref(window.firebase.db, `companies/${companyId}`);
                    const snapshot = await window.firebase.get(companyRef);
                    const companyData = snapshot.val();

                    console.log('🏢 Company data for branding:', companyData);

                    const headerLogo = document.getElementById('headerCompanyLogo');
                    const headerName = document.getElementById('headerCompanyName');

                    if (companyData) {
                        // Update company name
                        if (headerName && companyData.companyName) {
                            headerName.textContent = companyData.companyName;
                            console.log('✅ Company name updated in header:', companyData.companyName);
                        } else if (headerName) {
                            headerName.textContent = 'Dreamex Datalab HSE';
                        }

                        // Update company logo - check for both logoUrl and logo properties
                        const logoUrl = companyData.logoUrl || companyData.logo;
                        if (headerLogo && logoUrl) {
                            headerLogo.src = logoUrl;
                            headerLogo.style.display = 'block';
                            headerLogo.classList.add('visible');
                            console.log('✅ Company logo displayed:', logoUrl);
                        } else if (headerLogo) {
                            headerLogo.style.display = 'none';
                            headerLogo.classList.remove('visible');
                            headerLogo.src = '';
                            console.log('ℹ️ No logo URL found, logo hidden');
                        }
                    } else {
                        console.log('❌ No company data found');
                        this.clearHeaderBranding();
                    }
                } catch (error) {
                    console.error('Error updating header branding:', error);
                    this.clearHeaderBranding();
                }
            }

            clearHeaderBranding() {
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerName = document.getElementById('headerCompanyName');

                if (headerLogo) {
                    headerLogo.style.display = 'none';
                    headerLogo.classList.remove('visible');
                    headerLogo.src = '';
                }

                if (headerName) {
                    headerName.textContent = 'Dreamex Datalab HSE';
                }
            }

            getCurrentUser() {
                return this.currentUser;
            }

            redirectToLogin() {
                if (window.location.pathname !== '/login.html') {
                    window.location.href = 'login.html';
                }
            }

            async logout() {
                try {
                    if (window.firebase && window.firebase.auth) {
                        await window.firebase.auth.signOut();
                    }
                    localStorage.removeItem('currentUser');
                    this.currentUser = null;
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Error during logout:', error);
                }
            }

            getCurrentCompanyId() {
                return this.currentUser?.companyId || 'default-company';
            }

            async updateMenuWithFeatureAuthorization() {
                try {
                    const companyId = this.getCurrentCompanyId();
                    if (!companyId) {
                        this.showBasicMenu();
                        return;
                    }

                    const companyRef = window.firebase.ref(window.firebase.db, `companies/${companyId}`);
                    const snapshot = await window.firebase.get(companyRef);
                    const companyData = snapshot.val();

                    if (!companyData?.selectedFeatures) {
                        this.showBasicMenu();
                        return;
                    }

                    await this.applyFeatureBasedMenuVisibility(companyId);

                } catch (error) {
                    console.error('Error updating menu authorization:', error);
                    this.showBasicMenu();
                }
            }

            async applyFeatureBasedMenuVisibility(companyId) {
                try {
                    // Get platform features
                    const featuresSnapshot = await window.firebase.get(window.firebase.ref(window.firebase.db, '/platformFeatures'));
                    
                    if (!featuresSnapshot.exists()) {
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    const featuresData = featuresSnapshot.val();
                    
                    // Get company's selected features
                    const companySnapshot = await window.firebase.get(window.firebase.ref(window.firebase.db, `/companies/${companyId}`));
                    const companyData = companySnapshot.val();
                    
                    if (!companyData) {
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    const subscribedFeatureIds = companyData.selectedFeatures || [];
                    
                    if (subscribedFeatureIds.length === 0) {
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    // Collect authorized pages from subscribed features
                    const authorizedPages = [];
                    subscribedFeatureIds.forEach(featureId => {
                        const feature = featuresData[featureId];
                        if (feature && feature.status === 'active' && feature.authorizedPages) {
                            authorizedPages.push(...feature.authorizedPages);
                        }
                    });
                    
                    // Reset all menu items first
                    this.resetMenuVisibility();
                    
                    // Create set of authorized features
                    const authorizedFeatures = new Set();
                    authorizedPages.forEach(pageInfo => {
                        if (pageInfo.feature) {
                            authorizedFeatures.add(pageInfo.feature);
                        }
                    });
                    
                    // Apply menu visibility
                    const allMenuItems = document.querySelectorAll('.sidebar li[data-feature]');
                    
                    allMenuItems.forEach(menuItem => {
                        const featureAttribute = menuItem.getAttribute('data-feature');
                        const isAuthorized = authorizedFeatures.has(featureAttribute);
                        const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                        
                        if (isDropdownContainer) {
                            return; // Handle dropdowns separately
                        }
                        
                        if (isAuthorized) {
                            menuItem.classList.add('menu-visible');
                        } else {
                            menuItem.classList.remove('menu-visible');
                        }
                    });
                    
                    // Handle dropdown menus
                    const dropdownMenus = document.querySelectorAll('.sidebar li.menu-dropdown');
                    dropdownMenus.forEach(dropdown => {
                        const dropdownFeature = dropdown.getAttribute('data-feature');
                        const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                        let hasVisibleChildren = false;
                        
                        submenuItems.forEach(submenuItem => {
                            if (submenuItem.classList.contains('menu-visible')) {
                                hasVisibleChildren = true;
                            }
                        });
                        
                        if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                            dropdown.classList.add('menu-visible');
                        } else {
                            dropdown.classList.remove('menu-visible');
                        }
                    });
                    
                    // Remove loading class
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('menu-loading');
                    }
                    
                } catch (error) {
                    console.error('Error applying feature-based menu visibility:', error);
                    this.resetMenuVisibility();
                }
            }

            resetMenuVisibility() {
                document.querySelectorAll('[data-feature]').forEach(item => {
                    item.classList.remove('menu-visible');
                });
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('menu-visible');
                });
            }

            showBasicMenu() {
                this.resetMenuVisibility();
                
                // Remove loading class
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                // Show basic menu items
                const basicFeatures = ['home_view', 'settings_view'];
                basicFeatures.forEach(feature => {
                    const menuItem = document.querySelector(`[data-feature="${feature}"]`);
                    if (menuItem) {
                        menuItem.classList.add('menu-visible');
                    }
                });
            }

            // Get user display name
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                
                const cleanName = (name) => {
                    if (!name || typeof name !== 'string') return '';
                    return name.trim().replace(/\s+/g, ' ');
                };
                
                const potentialNames = [
                    this.currentUser.displayName,
                    this.currentUser.name,
                    this.currentUser.username
                ];
                
                for (const name of potentialNames) {
                    const cleaned = cleanName(name);
                    if (cleaned) return cleaned;
                }
                
                if (this.currentUser.email) {
                    const emailUsername = this.currentUser.email.split('@')[0];
                    const cleaned = cleanName(emailUsername);
                    if (cleaned) return cleaned;
                }
                
                return 'User';
            }

            // Get user initials for avatar display
            getUserInitials() {
                const displayName = this.getUserDisplayName();
                
                if (!displayName || displayName === 'User') return 'U';
                
                const words = displayName.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            // Get user email
            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Generate initials avatar
            generateInitialsAvatar(name, imgElement) {
                if (!imgElement || !name) return;
                
                const initials = this.getUserInitials();
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                const backgroundColor = colors[name.length % colors.length];
                
                const svg = `
                    <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                        <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                    </svg>
                `;
                
                imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                imgElement.alt = name + ' Avatar';
            }

            // Get user avatar URL or null if not available
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    if (window.firebase && window.firebase.storage) {
                        const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                        const avatarRef = window.firebase.storageRef(window.firebase.storage, avatarPath);
                        
                        return await window.firebase.getDownloadURL(avatarRef);
                    }
                    return null;
                } catch (error) {
                    return null;
                }
            }

            createDemoUser() {
                // Create a demo user for demonstration purposes
                this.currentUser = {
                    uid: 'demo-user-123',
                    email: 'demo.user@dreamexdatalab.com',
                    name: 'Demo User',
                    displayName: 'Demo User',
                    role: 'admin',
                    department: 'IT',
                    companyId: 'dreamex-datalab-demo' // Company-scoped demo data
                };
                
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                
                // Set demo company branding
                this.setDemoCompanyBranding();
                
                this.updateUIForAuthenticatedUser();
            }

            setDemoCompanyBranding() {
                // Set demo company branding directly since Firebase might not be available
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerName = document.getElementById('headerCompanyName');

                if (headerName) {
                    headerName.textContent = 'Dreamex Datalab HSE';
                }

                if (headerLogo) {
                    // Use a placeholder logo for demo
                    headerLogo.src = 'https://via.placeholder.com/60x60/3498db/ffffff?text=DX';
                    headerLogo.style.display = 'block';
                    headerLogo.classList.add('visible');
                }
            }
        }

        // Global logout function for easy access
        function logout() {
            if (window.authManager) {
                window.authManager.logout();
            } else {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }

        // Global function to refresh org chart (can be called from other pages)
        window.refreshOrgChart = async function() {
            console.log('🔄 Global org chart refresh requested');
            if (window.orgChart) {
                await window.orgChart.refreshData();
                console.log('✅ Org chart refreshed successfully');
            } else {
                console.log('ℹ️ Org chart not available for refresh');
            }
        };

        // Listen for custom events from other pages (cross-page communication)
        window.addEventListener('userDataUpdated', async (event) => {
            console.log('📡 Received userDataUpdated event:', event.detail);
            if (window.orgChart) {
                await window.orgChart.refreshData();
                console.log('✅ Org chart auto-refreshed due to user data update');
            }
        });

        // Listen for storage events (for cross-tab communication)
        window.addEventListener('storage', async (event) => {
            if (event.key === 'orgChartRefreshNeeded' && event.newValue === 'true') {
                console.log('📡 Received storage event to refresh org chart');
                if (window.orgChart) {
                    await window.orgChart.refreshData();
                    console.log('✅ Org chart auto-refreshed due to storage event');
                }
                // Clear the flag
                localStorage.removeItem('orgChartRefreshNeeded');
            }
        });

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🔍 DOM Content Loaded - starting initialization...');
            
            // Initialize authentication first
            const authManager = new AuthManager();
            window.authManager = authManager; // Make globally accessible
            console.log('🔍 AuthManager created, initializing...');
            await authManager.init();
            console.log('🔍 AuthManager initialized');
            
            // Initialize organization chart after auth is ready
            console.log('🔍 Creating OrganizationChart...');
            window.orgChart = new OrganizationChart();
            console.log('🔍 OrganizationChart created, loading data...');
            // Load data after auth is complete to ensure company ID is available
            await window.orgChart.initializeData();
            console.log('🔍 Organization data loading complete');
            
            // Setup notification dropdown
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    notificationDropdown.style.display = notificationDropdown.style.display === 'block' ? 'none' : 'block';
                });
                
                document.addEventListener('click', () => {
                    notificationDropdown.style.display = 'none';
                });
            }
            
            // Setup profile dropdown
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Toggle dropdown visibility
                    if (profileDropdown.style.display === 'block') {
                        profileDropdown.style.display = 'none';
                        profileDropdown.classList.remove('show');
                    } else {
                        profileDropdown.style.display = 'block';
                        profileDropdown.classList.add('show');
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.style.display = 'none';
                        profileDropdown.classList.remove('show');
                    }
                });
            }
            
            // Setup logout functionality
            const logoutLinks = document.querySelectorAll('a[href="#"]');
            logoutLinks.forEach(link => {
                if (link.textContent.trim().includes('Logout')) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        logout();
                    });
                }
            });
        });

        // Error handling for missing resources
        window.addEventListener('error', function(e) {
            console.error('Resource loading error:', e.target.src || e.target.href);
        });
    </script>
</body>
</html>
