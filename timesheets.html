<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timesheets - Dreamex Datalab</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
:root { --primary-color:#2c3e50; --secondary-color:#34495e; --accent-color:#e74c3c; --success-color:#27ae60; --warning-color:#f39c12; --info-color:#3498db; --light-color:#ecf0f1; --dark-color:#2c3e50; --sidebar-width:250px; --transition-speed:.25s; }
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family: 'Segoe UI', Arial, sans-serif; background:#f5f7fa; color:#222; }
.app-container { display:flex; min-height:100vh; }
.sidebar { width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; transition:transform .3s ease; z-index:1000; }
.sidebar.collapsed { transform:translateX(-100%); }
.main-content { flex:1; margin-left:var(--sidebar-width); padding:0.3rem; padding-top:3.2rem; transition:margin-left .3s ease; }
.main-content.sidebar-collapsed { margin-left:0; }
.main-content.sidebar-collapsed .top-nav { left:0.5rem; }
.logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:1.05rem; letter-spacing:.5px; }
.menu { list-style:none; margin-top:2rem; }
.menu li { margin-bottom:0.45rem; }
.menu a { display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none; padding:0.6rem 0.75rem; border-radius:6px; font-size:0.82rem; font-weight:500; transition:background .25s; }
.menu a:hover, .menu a.active { background:rgba(255,255,255,0.12); }
.submenu { list-style:none; margin-left:0.75rem; display:none; margin-top:0.25rem; }
.menu-dropdown:hover .submenu { display:block; }
.submenu a { font-size:0.75rem; padding:0.45rem 0.65rem; }
[data-feature]:not(.menu-visible) { display:none !important; }
.menu-dropdown:not(.menu-visible) { display:none !important; }
.sidebar.menu-loading .menu-item,
.sidebar.menu-loading .menu-dropdown,
.sidebar.menu-loading li[data-feature],
.sidebar.menu-loading [data-feature] { display:none !important; }
.sidebar.menu-loading .menu-visible,
.sidebar.menu-loading li.menu-visible,
.sidebar.menu-loading [data-feature].menu-visible { display:block !important; }
.menu-visible { display:block !important; }
.top-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0.75rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:0.3rem; position:fixed; top:0.25rem; right:0.5rem; left:calc(var(--sidebar-width) + 0.5rem); height:50px; min-height:50px; z-index:100; transition:left 0.3s ease; }
.sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
.top-nav-left { display:flex; align-items:center; gap:0.75rem; }
.company-branding { display:flex; align-items:center; gap:0.5rem; }
#headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
#headerCompanyName { font-weight:600; font-size:0.85rem; }
/* Header right (notifications + profile) */
.top-nav-right { display:flex; align-items:center; gap:1rem; }
.notifications { position:relative; display:flex; align-items:center; }
.notification-btn { background:none; border:none; cursor:pointer; position:relative; font-size:1.2rem; padding:0.5rem; display:flex; align-items:center; justify-content:center; }
.notification-badge { position:absolute; top:-5px; right:-5px; background-color:var(--accent-color); color:white; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.7rem; display:none; }
.notification-dropdown { display:none; position:absolute; right:0; top:100%; width:320px; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); z-index:1000; border:1px solid #e9ecef; max-height:400px; overflow:hidden; }
.notification-dropdown.show { display:block; animation: slideDown 0.2s ease-out; }
@keyframes slideDown { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
.notification-header { padding:12px 16px; border-bottom:1px solid #e9ecef; background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%); display:flex; justify-content:space-between; align-items:center; }
.notification-header h3 { margin:0; color:#333; font-size:14px; font-weight:600; }
.mark-all-read { background:none; border:none; color:#3498db; cursor:pointer; font-size:12px; padding:4px 8px; border-radius:4px; transition:all .2s ease; }
.mark-all-read:hover { background:#e3f2fd; color:#1976d2; }
.notification-list { max-height:320px; overflow-y:auto; padding:0; }
.notification-empty { padding:40px 20px; text-align:center; color:#999; display:none; }
.notification-empty i { font-size:32px; margin-bottom:12px; color:#ddd; }
.notification-empty-title { font-size:14px; font-weight:500; margin-bottom:4px; color:#666; }
.notification-empty-message { font-size:12px; color:#999; }
.user-profile { position:relative; }
.profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
.profile-btn img { width:100%; height:100%; object-fit:cover; }
.profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; }
.profile-dropdown.show { display:block; }
.profile-dropdown ul { list-style:none; }
.profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
.profile-dropdown li a:hover { background:#f1f5f9; }
.page-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; padding: 0.55rem 0.75rem; margin: 0.35rem 0 0.5rem 0; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14); font-size: 0.9rem; }
.page-header h1 { color: #fff; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; letter-spacing: 0.5px; margin: 0; font-weight: 600; }
.section { background:#fff; padding:0.7rem; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.06); margin-bottom:0.3rem; }
/* Page-specific styles */
:root{--bg:#f5f7fa;--card:#fff;--line:#e2e8f0;--muted:#64748b;--text:#111827;--primary:#2563eb;--danger:#dc2626;--ok:#16a34a;--warn:#d97706}
.btn{border:none;border-radius:6px;padding:0.45rem 0.75rem;font-size:0.68rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:0.4rem;letter-spacing:.5px;background:#eef2f6;color:#1e293b;transition:.2s}
.btn:hover{background:#e2e8f0}
.btn.primary{background:var(--primary);color:#fff}
.btn.success{background:var(--ok);color:#fff}
.btn.danger{background:#fff;border:1px solid var(--danger);color:var(--danger)}
.wrap{max-width:1200px;margin:0 auto;padding:0 0.4rem}
.card{background:var(--card);border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:14px;margin-bottom:12px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:160px}
label{font-size:.85rem;color:#334155}
input, select, textarea{padding:9px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}
table{width:100%;border-collapse:collapse;margin-top:12px}
th, td{border-bottom:1px solid var(--line);padding:10px;text-align:left;font-size:.9rem}
th{background:#f8fafc;font-weight:600}
.info{background:#f0f9ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;font-size:.9rem;color:#1e40af;margin-bottom:16px}
.tools{display:flex;gap:8px;flex-wrap:wrap}
.timesheet-grid{display:grid;grid-template-columns:120px repeat(7, 1fr);gap:1px;background:#e5e7eb;border-radius:8px;overflow:hidden;margin-top:12px}
.timesheet-cell{background:#fff;padding:8px;border:1px solid #e5e7eb;min-height:40px;display:flex;align-items:center;justify-content:center}
.timesheet-header{font-weight:600;background:#f3f4f6;font-size:.85rem}
.timesheet-input{width:100%;border:none;text-align:center;background:transparent;font-size:.9rem}
.total-cell{background:#fef3c7;font-weight:600}
@media (max-width: 900px){ .main-content{margin-left:0} .sidebar{transform:translateX(-100%)} .sidebar.open{transform:translateX(0)} .top-nav{left:0.5rem} .timesheet-grid{grid-template-columns:100px repeat(7, 1fr);font-size:.8rem} }
    </style>
    <meta name="robots" content="noindex" />
    <meta http-equiv="Cache-Control" content="no-store" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" href="data:,">
    <script>
// Firebase config (same as project-list)
const firebaseConfig={apiKey:"AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",authDomain:"users-8be65.firebaseapp.com",databaseURL:"https://users-8be65-default-rtdb.firebaseio.com",projectId:"users-8be65",storageBucket:"users-8be65.firebasestorage.app",messagingSenderId:"909025468149",appId:"1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",measurementId:"G-XHFMRCJQEZ"};
function initializeFirebase(){try{if(!window.firebase||!window.firebase.apps||window.firebase.apps.length===0){window.firebase.initializeApp(firebaseConfig)}}catch(e){}return window.firebase}
const firebase=initializeFirebase();
// Minimal AuthManager for header branding
class AuthManager{constructor(){this.currentUser=this.getCurrentUser();this.currentCompany=null;this.init()}getCurrentUser(){try{return JSON.parse(localStorage.getItem('currentUser')||'null')}catch{return null}}setCurrentUser(u){localStorage.setItem('currentUser',JSON.stringify(u));localStorage.setItem('user',JSON.stringify(u));this.currentUser=u}async init(){if(!this.currentUser){return}await this.loadUserCompany();this.updateCompanyBranding()}async loadUserCompany(){if(!this.currentUser) return;try{const snap=await firebase.database().ref('companies').once('value');if(!snap.exists()) return;const companies=snap.val();for(const [cid,comp] of Object.entries(companies)){if(comp.status!=='active') continue; if(comp.users){for(const [uid,u] of Object.entries(comp.users)){if(u.authUid===this.currentUser.uid||uid===this.currentUser.uid){this.currentUser.companyId=cid;this.currentUser.companyName=comp.companyName;this.currentUser.role=u.role||u.userRole||'user';this.currentCompany=comp;this.setCurrentUser(this.currentUser);return}}}}}catch(e){}}
updateCompanyBranding(){const logoEl=document.getElementById('headerCompanyLogo');const nameEl=document.getElementById('headerCompanyName');if(!this.currentCompany){if(nameEl) nameEl.textContent=''; if(logoEl) logoEl.style.display='none'; return;}if(nameEl) nameEl.textContent=this.currentCompany.companyName||'';const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){if(logoUrl){logoEl.src=logoUrl;logoEl.style.display='block'}else{logoEl.style.display='none'}}}
}
window.addEventListener('DOMContentLoaded',()=>{window.authManager=new AuthManager();initializeMenuAuthorization?.();document.getElementById('sidebarToggle')?.addEventListener('click',()=>{document.getElementById('sidebar')?.classList.toggle('collapsed');document.getElementById('mainContent')?.classList.toggle('sidebar-collapsed')});});
// Canonical two-phase feature + role authorization (copied from canonical implementation)
function resetMenuVisibility() {
    const allItems = document.querySelectorAll('#roleBasedMenu li');
    allItems.forEach(item => item.classList.remove('menu-visible'));
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.classList.add('menu-loading');
}

function showBasicMenu() {
    const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
    if (homeItem) homeItem.classList.add('menu-visible');
    showSidebarAfterAuth();
}

async function updateMenuWithFeatureAuthorization() {
    try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || localStorage.getItem('user') || 'null');
        if (!currentUser) { resetMenuVisibility(); showBasicMenu(); return; }
        const companyId = currentUser.companyId;
        if (!companyId) { resetMenuVisibility(); showBasicMenu(); return; }

        const companyRef = firebase.database().ref(`companies/${companyId}`);
        const [ companySnapshot, featuresSnapshot ] = await Promise.all([
            companyRef.once('value'),
            firebase.database().ref('platformFeatures').once('value')
        ]);

        if (!companySnapshot.exists()) { resetMenuVisibility(); showBasicMenu(); return; }
        const companyData = companySnapshot.val();
        const featureData = featuresSnapshot.exists() ? featuresSnapshot.val() : {};
        const selectedFeatures = companyData.selectedFeatures || {};
        const role = currentUser.role || currentUser.userRole || 'user';
        const rolePermissions = (companyData.roles && companyData.roles[role] && companyData.roles[role].permissions) || {};

        const subscribedFeatureIds = Object.keys(selectedFeatures).filter(fid => selectedFeatures[fid]);
        if (subscribedFeatureIds.length === 0) { resetMenuVisibility(); showBasicMenu(); return; }

        applyFeatureBasedMenuVisibility(featureData, subscribedFeatureIds);
        applyRoleBasedFiltering(rolePermissions);
    } catch (error) {
        resetMenuVisibility();
        hideItemsRequiringPermissions();
        showBasicMenu();
    }
}

function applyFeatureBasedMenuVisibility(featureData, subscribedFeatureIds) {
    const allowedPages = new Set();
    subscribedFeatureIds.forEach(fid => {
        if (featureData[fid] && featureData[fid].pages) {
            featureData[fid].pages.forEach(pageInfo => {
                if (pageInfo && pageInfo.feature) allowedPages.add(pageInfo.feature);
            });
        }
    });
    const menuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
    let matched = false;
    menuItems.forEach(item => {
        const featureName = item.getAttribute('data-feature');
        if (allowedPages.has(featureName)) { item.classList.add('menu-visible'); matched = true; }
    });
    document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(dropdown => {
        const visibleChildren = dropdown.querySelectorAll('.submenu li.menu-visible');
        if (visibleChildren.length > 0) dropdown.classList.add('menu-visible');
    });
    if (!matched) showBasicMenu();
}

function applyRoleBasedFiltering(permissions) {
    if (!permissions || Object.keys(permissions).length === 0) {
        hideItemsRequiringPermissions();
        showSidebarAfterAuth();
        ensureHomeIsVisible();
        return;
    }
    filterMenuByPermissions(permissions);
}

function filterMenuByPermissions(permissions) {
    const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
    visibleMenuItems.forEach(item => {
        const requiresPermission = item.getAttribute('data-requires-permission');
        const hasPermission = permissions[requiresPermission] === true || (permissions[requiresPermission] && permissions[requiresPermission].view === true);
        if (!hasPermission) item.classList.remove('menu-visible');
    });
    const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
    dropdownMenus.forEach(dropdown => {
        const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        if (submenuItems.length === 0) {
            const dropdownRequires = dropdown.getAttribute('data-requires-permission');
            if (dropdownRequires) {
                const hasDropdownPermission = permissions[dropdownRequires] === true || (permissions[dropdownRequires] && permissions[dropdownRequires].view === true);
                if (!hasDropdownPermission) dropdown.classList.remove('menu-visible');
            } else {
                dropdown.classList.remove('menu-visible');
            }
        }
    });
    ensureHomeIsVisible();
    showSidebarAfterAuth();
}

function hideItemsRequiringPermissions() {
    const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
    itemsRequiringPermissions.forEach(item => { item.classList.remove('menu-visible'); });
    const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
    dropdownMenus.forEach(dropdown => {
        const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
        if (visibleSubmenuItems.length === 0) dropdown.classList.remove('menu-visible');
    });
    ensureHomeIsVisible();
}

function ensureHomeIsVisible() {
    const homeItem = document.querySelector('#roleBasedMenu li[data-feature="home_view"]');
    if (homeItem && !homeItem.classList.contains('menu-visible')) homeItem.classList.add('menu-visible');
}

function showSidebarAfterAuth() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.classList.remove('menu-loading');
}

function initializeMenuAuthorization() {
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) sidebar.classList.add('menu-loading');
    setTimeout(() => { updateMenuWithFeatureAuthorization(); }, 500);
}

window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

// Integrated Timesheet Logic (aligned with profile.html data model)
// Data model in Firebase: timesheets/{id} with fields { id, month, days[], totalHours, status, submittedBy }
// This page provides a weekly grid view that aggregates underlying monthly timesheet (auto-creates month if missing)

const readJSON=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
const writeJSON=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

const TS_STATE={ month:null, raw:null, weekStart:null, currentUser:null };

function startOfWeek(date){const d=new Date(date);const day=(d.getDay()+6)%7;d.setHours(0,0,0,0);d.setDate(d.getDate()-day);return d;} // Monday start
function formatDate(d){return d.toISOString().slice(0,10);}    

async function initTimesheetPage(){
    TS_STATE.currentUser = window.authManager?.currentUser || JSON.parse(localStorage.getItem('currentUser')||'null');
    const now=new Date();
    TS_STATE.month = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    TS_STATE.weekStart = startOfWeek(now);
    
    // Migrate any existing localStorage entries to Firebase
    await migrateLocalStorageEntries();
    
    await loadOrCreateMonthlyTimesheet();
    renderWeek();
    bindControls();
}

async function migrateLocalStorageEntries() {
    if(!TS_STATE.currentUser) return;
    
    try {
        // Check for legacy localStorage timesheet data
        const legacyKeys = [];
        for(let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if(key && key.startsWith('timesheet-') && key.includes('-week-')) {
                legacyKeys.push(key);
            }
        }
        
        if(legacyKeys.length === 0) return; // No legacy data found
        
        console.log(`Found ${legacyKeys.length} legacy timesheet entries to migrate`);
        
        const db = firebase.database();
        let migratedCount = 0;
        
        for(const key of legacyKeys) {
            try {
                const legacyData = JSON.parse(localStorage.getItem(key) || '{}');
                if(!legacyData || Object.keys(legacyData).length === 0) continue;
                
                // Extract date from key pattern: timesheet-YYYY-MM-DD-week-N
                const keyParts = key.split('-');
                if(keyParts.length < 4) continue;
                
                const year = keyParts[1];
                const month = keyParts[2];
                const monthKey = `${year}-${month}`;
                
                // Check if we already migrated this month
                const existingSnap = await db.ref('timesheets')
                    .orderByChild('submittedBy').equalTo(TS_STATE.currentUser.uid)
                    .once('value');
                    
                let foundExisting = false;
                if(existingSnap.exists()) {
                    const existingTimesheets = existingSnap.val();
                    for(const existing of Object.values(existingTimesheets)) {
                        if(existing.month === monthKey && existing.migratedFromLocal) {
                            foundExisting = true;
                            break;
                        }
                    }
                }
                
                if(foundExisting) continue; // Skip if already migrated
                
                // Convert legacy format to new Firebase structure
                const migratedDays = [];
                let totalHours = 0;
                
                // Legacy data structure: { 'YYYY-MM-DD': { 'Project A': 8, 'Project B': 2 }, ... }
                for(const [dateKey, projectHours] of Object.entries(legacyData)) {
                    if(typeof projectHours === 'object' && projectHours) {
                        for(const [project, hours] of Object.entries(projectHours)) {
                            const numHours = parseFloat(hours) || 0;
                            if(numHours > 0) {
                                migratedDays.push({
                                    date: dateKey,
                                    project: project,
                                    hours: numHours
                                });
                                totalHours += numHours;
                            }
                        }
                    }
                }
                
                if(migratedDays.length === 0) continue; // No data to migrate
                
                // Create new timesheet record
                const migratedId = `TS-MIGRATED-${TS_STATE.currentUser.uid}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const migratedTimesheet = {
                    id: migratedId,
                    month: monthKey,
                    days: migratedDays,
                    totalHours: totalHours,
                    status: 'draft', // Migrated as draft, user can submit if needed
                    submittedBy: TS_STATE.currentUser.uid,
                    submittedByEmail: TS_STATE.currentUser.email || '',
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    migratedFromLocal: true,
                    originalLocalKey: key
                };
                
                // Save to Firebase
                await db.ref(`timesheets/${migratedId}`).set(migratedTimesheet);
                migratedCount++;
                
                // Mark as migrated in localStorage (don't delete yet, just mark)
                localStorage.setItem(`${key}-migrated`, 'true');
                
            } catch(entryError) {
                console.warn(`Failed to migrate ${key}:`, entryError);
            }
        }
        
        if(migratedCount > 0) {
            console.log(`Successfully migrated ${migratedCount} timesheet entries to Firebase`);
            
            // Show user notification about migration
            if(migratedCount === 1) {
                alert('Your previous timesheet data has been migrated to the new system.');
            } else {
                alert(`${migratedCount} previous timesheet entries have been migrated to the new system.`);
            }
        }
        
    } catch(error) {
        console.warn('Error during timesheet migration:', error);
    }
}

function bindControls(){
    // Add enhanced toolbar if not present
    if(!document.getElementById('tsToolbar')){
        const wrap=document.querySelector('.wrap');
        if(wrap){
            const bar=document.createElement('div');
            bar.id='tsToolbar';
            bar.style.cssText='display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 6px;align-items:center;padding:12px;background:#f8f9fa;border-radius:8px;border:1px solid #dee2e6;';
            
            // Generate month options for dropdown (current year + prev/next year)
            const currentYear = new Date().getFullYear();
            let monthOptions = '';
            for(let year = currentYear - 1; year <= currentYear + 1; year++) {
                for(let month = 1; month <= 12; month++) {
                    const value = `${year}-${String(month).padStart(2,'0')}`;
                    const label = new Date(year, month-1, 1).toLocaleDateString(undefined, {month: 'long', year: 'numeric'});
                    const selected = value === TS_STATE.month ? 'selected' : '';
                    monthOptions += `<option value="${value}" ${selected}>${label}</option>`;
                }
            }
            
            bar.innerHTML=`
                <div style="display:flex;gap:6px;align-items:center;">
                    <label style="font-size:0.85rem;font-weight:600;color:#374151;">Month:</label>
                    <select id="monthSelector" style="padding:4px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:0.85rem;">
                        ${monthOptions}
                    </select>
                </div>
                <div style="height:20px;width:1px;background:#dee2e6;"></div>
                <button class="btn" id="prevWeekBtn"><i class="fas fa-chevron-left"></i> Prev Week</button>
                <button class="btn" id="nextWeekBtn">Next Week <i class="fas fa-chevron-right"></i></button>
                <div style="height:20px;width:1px;background:#dee2e6;"></div>
                <button class="btn primary" id="saveDraftBtn"><i class="fas fa-save"></i> Save Draft</button>
                <button class="btn success" id="submitBtn"><i class="fas fa-paper-plane"></i> Submit</button>
                <div id="approvalControls" style="display:none;gap:6px;">
                    <div style="height:20px;width:1px;background:#dee2e6;"></div>
                    <button class="btn" style="background:#dc2626;color:white;" id="rejectBtn"><i class="fas fa-times"></i> Reject</button>
                    <button class="btn" style="background:#059669;color:white;" id="approveBtn"><i class="fas fa-check"></i> Approve</button>
                </div>
                <div style="margin-left:auto;display:flex;align-items:center;gap:12px;">
                    <div style="font-size:0.8rem;color:#6b7280;" id="weekLabel"></div>
                    <div id="statusBadge" style="padding:4px 8px;border-radius:16px;font-size:0.75rem;font-weight:600;"></div>
                </div>
            `;
            wrap.prepend(bar);
            
            // Check if current user is admin for approval controls
            checkAdminPermissions();
        }
    }
    
    // Bind event listeners
    document.getElementById('monthSelector')?.addEventListener('change', changeMonth);
    document.getElementById('prevWeekBtn')?.addEventListener('click',()=>{TS_STATE.weekStart.setDate(TS_STATE.weekStart.getDate()-7);renderWeek();});
    document.getElementById('nextWeekBtn')?.addEventListener('click',()=>{TS_STATE.weekStart.setDate(TS_STATE.weekStart.getDate()+7);renderWeek();});
    document.getElementById('saveDraftBtn')?.addEventListener('click',()=>saveWeek(false));
    document.getElementById('submitBtn')?.addEventListener('click',()=>saveWeek(true));
    document.getElementById('rejectBtn')?.addEventListener('click',()=>handleApproval('rejected'));
    document.getElementById('approveBtn')?.addEventListener('click',()=>handleApproval('approved'));
}

async function changeMonth() {
    const newMonth = document.getElementById('monthSelector')?.value;
    if(newMonth && newMonth !== TS_STATE.month) {
        TS_STATE.month = newMonth;
        await loadOrCreateMonthlyTimesheet();
        renderWeek();
    }
}

async function checkAdminPermissions() {
    // Show approval controls if user has payroll admin permissions
    try {
        const currentUser = TS_STATE.currentUser;
        if(!currentUser) return;
        
        // Check user permissions from localStorage or Firebase
        const permissions = JSON.parse(localStorage.getItem('userPermissions') || '{}');
        const hasPayrollAdmin = permissions.payroll_admin === true || 
                               (permissions.payroll && permissions.payroll.approve === true);
        
        if(hasPayrollAdmin) {
            const approvalControls = document.getElementById('approvalControls');
            if(approvalControls) {
                approvalControls.style.display = 'flex';
            }
        }
    } catch(error) {
        console.warn('Could not check admin permissions:', error);
    }
}

async function handleApproval(action) {
    if(!TS_STATE.raw || !TS_STATE.currentUser) return;
    
    const confirmation = confirm(`Are you sure you want to ${action} this timesheet?`);
    if(!confirmation) return;
    
    try {
        TS_STATE.raw.status = action;
        TS_STATE.raw.approvedBy = TS_STATE.currentUser.uid;
        TS_STATE.raw.approvedAt = Date.now();
        TS_STATE.raw.updatedAt = Date.now();
        
        // Add approval history entry
        if(!TS_STATE.raw.approvalHistory) TS_STATE.raw.approvalHistory = [];
        TS_STATE.raw.approvalHistory.push({
            action: action,
            approvedBy: TS_STATE.currentUser.uid,
            approvedByEmail: TS_STATE.currentUser.email,
            timestamp: Date.now()
        });
        
        await firebase.database().ref(`timesheets/${TS_STATE.raw.id}`).set(TS_STATE.raw);
        updateStatusDisplay();
        alert(`Timesheet ${action} successfully.`);
        
    } catch(error) {
        console.error('Error updating approval status:', error);
        alert('Failed to update approval status. Please try again.');
    }
}

async function loadOrCreateMonthlyTimesheet(){
    if(!TS_STATE.currentUser) return;
    const db=firebase.database();
    // Query timesheets for user & month
    const snap=await db.ref('timesheets').orderByChild('submittedBy').equalTo(TS_STATE.currentUser.uid).once('value');
    let match=null;
    if(snap.exists()){
        const all=snap.val();
        for(const t of Object.values(all)){
            if(t.month===TS_STATE.month){match=t;break;}
        }
    }
    if(!match){
        const id=`TS-${TS_STATE.currentUser.uid}-${Date.now()}`;
        match={id,month:TS_STATE.month,days:[],totalHours:0,status:'draft',submittedBy:TS_STATE.currentUser.uid,submittedByEmail:TS_STATE.currentUser.email||'',createdAt:Date.now(),updatedAt:Date.now()};
        await db.ref(`timesheets/${id}`).set(match);
    }
    TS_STATE.raw=match;
}

function renderWeek(){
    const grid=document.getElementById('timesheet-grid');
    if(!grid) return;
    grid.innerHTML='';
    const projects=['Project A','Project B','Admin','Training'];
    const weekDays=[];for(let i=0;i<7;i++){const d=new Date(TS_STATE.weekStart);d.setDate(d.getDate()+i);weekDays.push(d);} 
    // Header
    grid.appendChild(cell('Project/Day','timesheet-header'));
    weekDays.forEach(d=>grid.appendChild(cell(d.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}),'timesheet-header')));
    grid.appendChild(cell('Total','timesheet-header'));
    // Projects rows
    projects.forEach((proj,pIndex)=>{
        grid.appendChild(cell(proj,'timesheet-cell'));
        let rowTotal=0;
        weekDays.forEach((d,dIndex)=>{
            const dayIso=formatDate(d);
            const existing=findDayEntry(dayIso,proj);
            const input=document.createElement('input');
            input.type='number';input.step='0.25';input.min='0';input.max='24';input.className='timesheet-input';
            input.dataset.project=pIndex;input.dataset.projectName=proj;input.dataset.date=dayIso;input.value= existing? existing.hours: '';
            
            // Disable input if timesheet is submitted/approved/rejected
            if(TS_STATE.raw?.status && ['submitted', 'approved', 'rejected'].includes(TS_STATE.raw.status)) {
                input.disabled = true;
                input.style.background = '#f3f4f6';
                input.style.color = '#6b7280';
            }
            
            input.addEventListener('input',updateTotalsAggregates);
            const c=cell('', 'timesheet-cell');c.appendChild(input);grid.appendChild(c);
            if(existing) rowTotal+=existing.hours||0;
        });
        const total=cell(rowTotal.toFixed(2),'timesheet-cell total-cell');total.id=`row-total-${pIndex}`;grid.appendChild(total);
    });
    // Daily totals row
    grid.appendChild(cell('Daily Total','timesheet-header'));
    weekDays.forEach((d,i)=>{
        const dayIso=formatDate(d);let sum=0;projects.forEach(p=>{const e=findDayEntry(dayIso,p);if(e) sum+=e.hours||0;});
        const t=cell(sum.toFixed(2),'timesheet-cell total-cell');t.id=`day-total-${i}`;grid.appendChild(t);
    });
    const weekTotalVal=computeWeekTotal(weekDays);
    grid.appendChild(cell(weekTotalVal.toFixed(2),'timesheet-cell total-cell','week-total'));
    
    // Update week label
    document.getElementById('weekLabel').textContent=`Week of ${weekDays[0].toLocaleDateString()} — ${weekDays[6].toLocaleDateString()}`;
    
    // Update status display
    updateStatusDisplay();
    
    // Update button states based on status
    updateButtonStates();
}

function updateStatusDisplay() {
    const statusBadge = document.getElementById('statusBadge');
    if(!statusBadge || !TS_STATE.raw) return;
    
    const status = TS_STATE.raw.status || 'draft';
    const statusConfig = {
        'draft': { text: 'Draft', bg: '#f59e0b', color: '#white' },
        'submitted': { text: 'Submitted', bg: '#3b82f6', color: 'white' },
        'approved': { text: 'Approved', bg: '#059669', color: 'white' },
        'rejected': { text: 'Rejected', bg: '#dc2626', color: 'white' }
    };
    
    const config = statusConfig[status] || statusConfig['draft'];
    statusBadge.textContent = config.text;
    statusBadge.style.background = config.bg;
    statusBadge.style.color = config.color;
    
    // Show additional status info for approved/rejected
    if(status === 'approved' || status === 'rejected') {
        const approvedAt = TS_STATE.raw.approvedAt ? new Date(TS_STATE.raw.approvedAt).toLocaleDateString() : '';
        if(approvedAt) {
            statusBadge.title = `${config.text} on ${approvedAt}`;
        }
    }
}

function updateButtonStates() {
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const submitBtn = document.getElementById('submitBtn');
    const status = TS_STATE.raw?.status || 'draft';
    
    // Disable save/submit buttons if already submitted/approved/rejected
    const isReadOnly = ['submitted', 'approved', 'rejected'].includes(status);
    
    if(saveDraftBtn) {
        saveDraftBtn.disabled = isReadOnly;
        saveDraftBtn.style.opacity = isReadOnly ? '0.5' : '1';
    }
    
    if(submitBtn) {
        submitBtn.disabled = isReadOnly || status === 'submitted';
        submitBtn.style.opacity = (isReadOnly || status === 'submitted') ? '0.5' : '1';
    }
}

function cell(text,cls,id=null){const d=document.createElement('div');d.className=cls;d.textContent=text;if(id) d.id=id;return d;}

function findDayEntry(dayIso, projectName){
    if(!TS_STATE.raw||!Array.isArray(TS_STATE.raw.days)) return null;
    return TS_STATE.raw.days.find(d=>d.date===dayIso && d.project===projectName) || null;
}

function updateTotalsAggregates(){
    const projects=['Project A','Project B','Admin','Training'];
    const inputs=document.querySelectorAll('.timesheet-input');
    const rowTotals=Array(projects.length).fill(0);
    const dayTotals=Array(7).fill(0);
    let weekTotal=0;
    inputs.forEach(inp=>{const v=parseFloat(inp.value)||0;const p=parseInt(inp.dataset.project);const date=new Date(inp.dataset.date);const dayIndex=( (date.getDay()+6)%7 ); // Monday index
        // Only aggregate for current visible week
        if(date>=TS_STATE.weekStart && date< new Date(TS_STATE.weekStart.getTime()+7*86400000)){
            rowTotals[p]+=v;weekTotal+=v;const idx=(date - TS_STATE.weekStart)/86400000;dayTotals[idx]+=v;}
    });
    rowTotals.forEach((t,i)=>{const el=document.getElementById(`row-total-${i}`);if(el) el.textContent=t.toFixed(2);});
    dayTotals.forEach((t,i)=>{const el=document.getElementById(`day-total-${i}`);if(el) el.textContent=t.toFixed(2);});
    const wk=document.getElementById('week-total');if(wk) wk.textContent=weekTotal.toFixed(2);
}

function computeWeekTotal(weekDays){let total=0;weekDays.forEach(d=>{const iso=formatDate(d);const dayEntries=(TS_STATE.raw?.days||[]).filter(e=>e.date===iso);dayEntries.forEach(e=>{total+=e.hours||0;});});return total;}

async function saveWeek(submit){
    if(!TS_STATE.currentUser||!TS_STATE.raw) return alert('Not authenticated');
    
    // Check if timesheet is already submitted/approved/rejected
    const currentStatus = TS_STATE.raw.status || 'draft';
    if(submit && ['submitted', 'approved', 'rejected'].includes(currentStatus)) {
        return alert('Cannot submit: This timesheet has already been submitted or processed.');
    }
    
    // Merge input changes into TS_STATE.raw.days
    const inputs=document.querySelectorAll('.timesheet-input');
    inputs.forEach(inp=>{
        const v=parseFloat(inp.value);
        const date=inp.dataset.date;
        const proj=inp.dataset.projectName;
        let entry=findDayEntry(date,proj);
        if(v && v>0){
            if(!entry){
                entry={date,project:proj,hours:0};
                TS_STATE.raw.days.push(entry);
            }
            entry.hours=v;
        } else if(entry){ 
            // Remove zero hour entry
            TS_STATE.raw.days=TS_STATE.raw.days.filter(e=>!(e.date===date && e.project===proj));
        }
    });
    
    // Recalculate monthly total
    TS_STATE.raw.totalHours=TS_STATE.raw.days.reduce((a,b)=>a+(b.hours||0),0);
    TS_STATE.raw.updatedAt=Date.now();
    
    if(submit){
        // Add validation for submission
        if(TS_STATE.raw.totalHours === 0) {
            return alert('Cannot submit empty timesheet. Please enter some hours first.');
        }
        
        TS_STATE.raw.status='submitted';
        TS_STATE.raw.submittedAt = Date.now();
        
        // Initialize approval history if not exists
        if(!TS_STATE.raw.approvalHistory) TS_STATE.raw.approvalHistory = [];
        TS_STATE.raw.approvalHistory.push({
            action: 'submitted',
            submittedBy: TS_STATE.currentUser.uid,
            submittedByEmail: TS_STATE.currentUser.email || '',
            timestamp: Date.now()
        });
    }
    
    try {
        await firebase.database().ref(`timesheets/${TS_STATE.raw.id}`).set(TS_STATE.raw);
        updateStatusDisplay();
        updateButtonStates();
        
        const message = submit ? 
            'Timesheet submitted for approval! You will be notified when it is reviewed.' : 
            'Draft saved successfully.';
        alert(message);
        
    } catch(error) {
        console.error('Error saving timesheet:', error);
        alert('Failed to save timesheet. Please check your connection and try again.');
    }
}

document.addEventListener('DOMContentLoaded',()=>{initTimesheetPage();});
    </script>
</head>
<body>
<div class="app-container">
    <nav class="sidebar menu-loading" id="sidebar">
        <div class="logo"><h2>Dreamex Datalab</h2></div>
        <ul class="menu" id="roleBasedMenu">
            <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view">
                <a href="#"><i class="fas fa-medkit"></i> Health</a>
                <ul class="submenu">
                    <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                    <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                    <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                <ul class="submenu">
                    <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                    <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                    <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                    <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                    <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                    <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                </ul>
            </li>
                <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                	<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                	<ul class="submenu">
                    <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                    <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                    <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
                	</ul>
                </li>
            <!-- Risk Management (separate section) -->
            <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                <ul class="submenu">
                    <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                <ul class="submenu">
                    <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="environment_view">
                <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                <ul class="submenu">
                    <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                <a href="#"><i class="fas fa-lock"></i> Security</a>
                <ul class="submenu">
                    <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
                    <li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
                    <li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                <ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                <ul class="submenu">
                    <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                <a href="#"><i class="fas fa-users"></i> HR</a>
                <ul class="submenu">
                    <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                    <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                    <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                    <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                    <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                    <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                    <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                    <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                    <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                    <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                    <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                    <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                    <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="project_management_section">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                <ul class="submenu">
                    <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                    <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                    <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                    <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                </ul>
            </li>
            <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view">
                <a href="#"><i class="fas fa-cog"></i> Settings</a>
                <ul class="submenu">
                    <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                    <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                </ul>
            </li>
        </ul>
    </nav>
    <main class="main-content" id="mainContent">
        <nav class="top-nav">
            <div class="top-nav-left">
                <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                <div class="company-branding">
                    <img id="headerCompanyLogo" alt="Company Logo" />
                    <span id="headerCompanyName"></span>
                </div>
            </div>
            <div class="top-nav-right">
                <div class="notifications">
                    <button id="notificationBtn" class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">0</span>
                    </button>
                    <div class="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button class="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notification-list"></div>
                        <div class="notification-empty">
                            <i class="fas fa-inbox"></i>
                            <div class="notification-empty-title">No notifications</div>
                            <div class="notification-empty-message">You're all caught up</div>
                        </div>
                    </div>
                </div>
                <div class="user-profile" style="position:relative;">
                    <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                    <div class="profile-dropdown"><ul></ul></div>
                </div>
            </div>
        </nav>
        <div class="page-header">
            <h1><i class="fas fa-clock"></i> Payroll — Timesheets</h1>
        </div>
        <div class="wrap">
            <div class="card">
                <div class="info">
                    Track your weekly hours by project. Enter hours worked for each day and project combination. Use the toolbar above to navigate weeks, save drafts, and submit for approval.
                </div>

                <div class="timesheet-grid" id="timesheet-grid">
                    <!-- Generated dynamically by JavaScript -->
                </div>
            </div>
        </div>
    </main>
</div>
<script>
// Header profile and notifications UI (aligned with payroll.html)
function getUserDisplayName(){try{const cu=window.authManager?.currentUser||JSON.parse(localStorage.getItem('currentUser')||'null')||{};const dn=(cu.displayName||'').trim();const fn=(cu.firstName||'').trim();const ln=(cu.lastName||'').trim();const full=[fn,ln].filter(Boolean).join(' ').trim();const emailName=cu.email&&String(cu.email).includes('@')?String(cu.email).split('@')[0]:'';return (dn||full||emailName||'User').trim()||'User';}catch{return 'User'}}
function getUserInitials(){const name=(getUserDisplayName()||'').trim();if(!name) return 'U';const parts=name.split(/\s+/).filter(Boolean);const a=(parts[0]||'').charAt(0);const b=(parts[1]||'').charAt(0)||(parts[0]||'').charAt(1)||'';const ini=(a+b).toUpperCase().replace(/[^A-Z0-9]/g,'');return ini||a.toUpperCase()||'U'}
async function getUserAvatarUrl(){try{const cu=window.authManager?.currentUser||JSON.parse(localStorage.getItem('currentUser')||'null');if(!cu) return null;const paths=[`avatars/${cu.uid}.jpg`,`avatars/${cu.uid}.jpeg`,`avatars/${cu.uid}.png`,`avatars/${cu.uid}.webp`];for(const p of paths){try{const ref=firebase.storage().ref(p);const url=await ref.getDownloadURL();return url}catch{}}return null}catch{return null}}
async function updateUserProfileUI(){const btn=document.getElementById('userProfileBtn');const list=document.querySelector('.profile-dropdown ul');if(!btn||!list) return;const name=getUserDisplayName();const email=(window.authManager?.currentUser?.email)||'';const initials=getUserInitials();const initialsBtnHtml=`<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${initials}</div>`;btn.innerHTML=initialsBtnHtml;let headerAvatarHtml=`<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${initials}</div>`;try{const url=await getUserAvatarUrl();if(url){btn.innerHTML=`<img src="${url}" alt="${name} Avatar" style="width:38px;height:38px;border-radius:50%;object-fit:cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='${initialsBtnHtml.replace(/"/g,'&quot;')}';" />`;headerAvatarHtml=`<img src="${url}" alt="${name} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;" onerror="this.outerHTML='${headerAvatarHtml.replace(/"/g,'&quot;')}'" />`}}catch{}list.innerHTML=`
    <li style=\"border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;\">
        <div style=\"display:flex;align-items:center;gap:12px;\">${headerAvatarHtml}
            <div>
                <div style=\"font-weight:600;color:#333;font-size:14px;margin-bottom:2px;\">${name}</div>
                <div style=\"color:#666;font-size:12px;\">${email||''}</div>
            </div>
        </div>
    </li>
    <li><a href=\"profile.html\"><i class=\"fas fa-user\"></i> Profile</a></li>
    <li><a href=\"account.html\"><i class=\"fas fa-cog\"></i> Account Settings</a></li>
    <li><a href=\"#\" id=\"logoutLink\"><i class=\"fas fa-sign-out-alt\"></i> Sign out</a></li>`;list.querySelector('#logoutLink')?.addEventListener('click',async e=>{e.preventDefault();try{await firebase.auth().signOut()}catch{}localStorage.removeItem('currentUser');localStorage.removeItem('user');window.location.href='login.html'});const dd=document.querySelector('.profile-dropdown');btn.addEventListener('click',e=>{e.stopPropagation();dd?.classList.toggle('show')});document.addEventListener('click',e=>{if(!btn.contains(e.target)) dd?.classList.remove('show')});}
document.addEventListener('DOMContentLoaded',()=>{
    const notificationBtn=document.getElementById('notificationBtn');
    const notificationDropdown=document.querySelector('.notification-dropdown');
    if(notificationBtn&&notificationDropdown){
        notificationBtn.addEventListener('click',e=>{e.stopPropagation();notificationDropdown.classList.toggle('show')});
        document.addEventListener('click',e=>{ if(!e.target.closest('.notifications')) notificationDropdown.classList.remove('show') });
    }
    updateUserProfileUI();
});
</script>
</body>
</html>
