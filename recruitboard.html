<!DOCTYPE html>
<!--
RECRUITMENT BOARD - DUAL DATA SOURCE IMPLEMENTATION
==================================================

FEATURES IMPLEMENTED:
1. ✅ Dual Data Loading System
   - Loads approved positions from Firebase 'staff' path
   - Loads recruitment requests from Firebase 'recruit' path
   - Real-time Firebase listeners for both data sources

2. ✅ Create Recruitment Requests
   - "Create Recruitment Request" button saves to 'recruit' path
   - Auto-fills data from existing staff positions
   - Unique ID generation and source tracking

3. ✅ Visual Source Indicators
   - Green badges for recruitment board requests
   - Blue badges for staff management positions
   - Row styling and hover effects by source

4. ✅ Enhanced fillPosition Function
   - Handles both 'staff' and 'recruit' data sources
   - Updates correct Firebase path based on position source
   - Tracks who filled the position and when

5. ✅ Real-time Data Synchronization
   - Firebase real-time listeners update table automatically
   - Combines data from both sources seamlessly
   - Removes filled positions from display automatically

6. ✅ Enhanced Statistics & Filtering
   - Tracks positions by source (staff vs recruit)
   - Source breakdown in tooltips
   - All filters work across both data sources

DATA FLOW:
Staff Management → Firebase 'staff' → Recruitment Board (approved positions)
Recruitment Board → Firebase 'recruit' → Recruitment Board (new requests)
Both sources combine into single unified table with source indicators
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Recruitment Board - Manage job positions and recruitment requests">
    <meta name="keywords" content="recruitment, jobs, hiring, HR, management">
    <meta name="author" content="Dreamex Datalab HSE">
    <meta name="robots" content="noindex, nofollow">
    <title>Recruitment Board - Dreamex Datalab HSE</title>
    
    <!-- Preconnect to external domains for better performance -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    
    <!-- Font Awesome CSS (External CDN) -->
    <style>
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
    </style>
    
    <!-- Embedded Styles from css/styles.css -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            /* Theme Colors */
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            
            /* Default Values */
            --accent-color: var(--red);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem; /* Standardized, reduced from 14px */
            --font-scale: 1;
            
            /* Theme-specific variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #404040;
        }

        /* High contrast mode */
        [data-contrast="high"] {
            --text-primary: #000000;
            --text-secondary: #000000;
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --border-color: #000000;
        }

        [data-theme="dark"][data-contrast="high"] {
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --bg-primary: #000000;
            --bg-secondary: #000000;
            --border-color: #ffffff;
        }

        /* Layout density */
        [data-density="comfortable"] {
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
        }

        [data-density="compact"] {
            --spacing-unit: 0.75rem;
            --padding-sm: 0.25rem;
            --padding-md: 0.75rem;
            --padding-lg: 1rem;
        }

        [data-density="spacious"] {
            --spacing-unit: 1.5rem;
            --padding-sm: 0.75rem;
            --padding-md: 1.5rem;
            --padding-lg: 2rem;
        }

        /* Animation settings */
        [data-reduced-motion="none"] {
            --transition-speed: 0.2s;
        }

        [data-reduced-motion="reduced"] {
            --transition-speed: 0.4s;
        }

        [data-reduced-motion="minimal"] {
            --transition-speed: 0s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background: #f8f9fa;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            overflow-x: hidden; /* Hide horizontal scrollbar */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }

        body::-webkit-scrollbar { /* WebKit */
            display: none;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        /* Main content adjustments when sidebar is collapsed */
        .main-content.sidebar-collapsed {
            margin-left: 0;
            width: 100%;
        }

        .main-content.sidebar-collapsed .top-nav {
            left: 0.5rem;
            right: 0.5rem;
            width: auto;
        }

        .main-content.sidebar-collapsed .content {
            max-width: calc(100vw - 1rem);
            height: calc(100vh - 80px); /* Adjusted for smaller header */
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block !important;
        }

        /* Ensure submenu items are properly displayed when parent is hovered */
        .menu-dropdown:hover .submenu li {
            display: block !important;
        }

        /* Additional hover rules to override visibility classes */
        .menu-dropdown:hover .submenu li.menu-visible {
            display: block !important;
        }

        .menu-dropdown.menu-visible:hover .submenu li.menu-visible {
            display: block !important;
        }

        /* Force visibility on hover regardless of classes */
        .menu-dropdown:hover .submenu li[data-feature].menu-visible {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.3rem; /* Reduced padding */
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
            transition: margin-left 0.3s ease, width 0.3s ease;
            height: 100vh; /* Full viewport height */
            overflow: hidden; /* Prevent main content from scrolling */
            display: flex;
            flex-direction: column;
        }

        /* Form Container Styles */
        .form-container {
            width: 100%;
            max-width: none;
            padding: 1.5rem;
            margin: 0;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Content Container */
        .content {
            width: 100%;
            margin: 0; /* Removed margins for more space */
            padding: 0.75rem; /* Further reduced padding */
            background-color: white;
            border-radius: 6px; /* Smaller radius for compactness */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            max-width: calc(100vw - var(--sidebar-width));
            height: calc(100vh - 85px); /* Optimized height for better space usage */
            overflow-y: auto; /* Enable scrolling within content */
            display: flex;
            flex-direction: column;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem; /* Further reduced padding */
            background-color: white;
            border-radius: 6px; /* Smaller radius */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 0.3rem; /* Reduced margin */
            position: fixed;
            top: 0.25rem; /* Reduced top position for more space */
            right: 0.25rem; /* Reduced right position for more space */
            left: calc(var(--sidebar-width) + 0.25rem); /* Reduced left position for more space */
            z-index: 100;
            transition: left 0.3s ease, width 0.3s ease;
            height: 50px; /* Reduced height */
            min-height: 50px;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color);
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding-top: 0.5rem; /* Reduced padding for mobile */
                padding-left: 0.2rem;
                padding-right: 0.2rem;
            }

            .top-nav {
                position: relative;
                left: 0;
                right: 0;
                top: 0;
                margin-bottom: 0.5rem; /* Reduced margin for mobile */
            }
            
            /* Mobile sidebar toggle behavior */
            .sidebar.collapsed {
                display: none;
            }
            
            .sidebar-toggle-btn {
                display: block;
            }
            
            .top-nav-left {
                display: flex;
            }
        }

        /* Menu Visibility Styles */
        .menu-item {
            display: block;
        }

        .menu-item.hidden {
            display: none !important;
        }

        /* Essential Menu Visibility Styles - matches dashboard.html and staff.html */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Ensure menu-visible items are displayed */
        [data-feature].menu-visible {
            display: block !important;
        }

        .menu-dropdown.menu-visible {
            display: block !important;
        }

        /* Essential Menu Visibility Styles - matches staff.html */
        [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown:not(.menu-visible) {
            display: none !important;
        }

        /* Hide ALL menu items by default - high specificity rules */
        .sidebar.menu-loading .menu-item,
        .sidebar.menu-loading .menu-dropdown,
        .sidebar.menu-loading li[data-feature],
        .sidebar.menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading [data-feature] {
            display: none !important;
        }

        .menu-loading .menu-dropdown {
            display: none !important;
        }

        /* Fix submenu hover functionality - ensure submenus can be shown on hover even with visibility classes */
        .menu-dropdown.menu-visible .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        /* Enhanced hover functionality to override visibility classes when hovering */
        .menu-dropdown.menu-visible:hover .submenu {
            display: block !important;
        }

        .menu-dropdown.menu-visible:hover .submenu li[data-feature].menu-visible {
            display: block !important;
        }

        /* Force display of visible submenu items when parent is hovered */
        .menu-dropdown.menu-visible:hover .submenu li[data-feature]:not(.menu-visible) {
            display: none !important;
        }

        /* Also ensure all non-feature submenu items are shown on hover */
        .menu-dropdown.menu-visible:hover .submenu li:not([data-feature]) {
            display: block !important;
        }

        /* Base submenu item visibility when not hovered */
        .menu-dropdown.menu-visible .submenu li[data-feature]:not(.menu-visible) {
            display: none !important;
        }

        .menu-dropdown.menu-visible .submenu li[data-feature].menu-visible {
            display: block !important;
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;  /* Increased from 1rem for better spacing */
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 320px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            border: 1px solid #e9ecef;
            max-height: 400px;
            overflow: hidden;
        }

        .notification-dropdown.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .clear-all-notifications {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin-left: 8px;
        }

        .clear-all-notifications:hover {
            background: #fdf2f2;
            color: #c0392b;
        }

        .notification-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: none;
            gap: 4px;
        }

        .notification-item:hover .notification-actions {
            display: flex;
        }

        .mark-read-btn, .delete-notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .mark-read-btn {
            color: #3498db;
        }

        .mark-read-btn:hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .delete-notification-btn {
            color: #e74c3c;
        }

        .delete-notification-btn:hover {
            background: #fdf2f2;
            color: #c0392b;
        }

        .notification-item.read .mark-read-btn {
            color: #95a5a6;
            cursor: default;
        }

        .notification-item.read .mark-read-btn:hover {
            background: none;
            color: #95a5a6;
        }

        .notification-list {
            max-height: 320px;
            overflow-y: auto;
            padding: 0;
        }

        .notification-list::-webkit-scrollbar {
            width: 4px;
        }

        .notification-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .notification-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f1f1f1;
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .notification-item:hover {
            background-color: #f5f5f5;
        }

        .notification-item.unread {
            background: #e8f4fd;
            border-left: 3px solid #3498db;
        }

        .notification-item.unread::before {
            content: '';
            position: absolute;
            top: 16px;
            right: 16px;
            width: 8px;
            height: 8px;
            background: #3498db;
            border-radius: 50%;
        }

        .notification-empty {
            padding: 40px 20px;
            text-align: center;
            color: #999;
        }

        .notification-empty i {
            font-size: 32px;
            margin-bottom: 12px;
            color: #ddd;
        }

        .notification-empty-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #666;
        }

        .notification-empty-message {
            font-size: 12px;
            color: #999;
        }

        .notification-dot {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 8px;
            height: 8px;
            background: #3498db;
            border-radius: 50%;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li {
            padding: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Ensure the profile button looks interactive */
        .profile-btn {
            cursor: pointer;
            padding: 0.25rem;
            border: none;
            background: none;
            display: flex;
            align-items: center;
        }

        /* User Profile Dropdown Styles */
        .user-info {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .admin-crown-icon {
            color: #ffd700; /* Gold color for the crown */
            margin-left: 0.5rem;
            font-size: 0.9rem;
            vertical-align: middle;
            animation: crown-glow 2s ease-in-out infinite alternate;
        }

        @keyframes crown-glow {
            from {
                text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
            to {
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            }
        }

        .user-email {
            font-size: 0.9rem;
            color: #666;
        }

        .user-status {
            margin-top: 0.25rem;
        }

        .divider {
            height: 1px;
            background-color: #eee;
            margin: 0.5rem 0;
        }

        /* Profile Dropdown Status Badge */
        .user-status .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        /* Content Styles */
        .content {
            margin-top: 0.5rem; /* Further reduced margin */
            padding: 0.5rem; /* Further reduced padding */
            background-color: white;
            border-radius: 6px; /* Smaller radius */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.75rem; /* Reduced from 1rem */
        }

        .data-table th,
        .data-table td {
            padding: 0.4rem 0.6rem; /* Further reduced padding */
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.85rem; /* Smaller font for compactness */
        }

        .data-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .btn {
            padding: var(--padding-sm) var(--padding-md);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
        }

        .btn-edit {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-approve {
            background-color: #27ae60;
            color: white;
        }

        .btn-decline {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: white;
        }

        .btn-icon i {
            font-size: 0.9rem;
        }

        .btn-icon.btn-approve {
            background-color: #2ecc71;
        }

        .btn-icon.btn-approve:hover {
            background-color: #27ae60;
        }

        .btn-icon.btn-decline {
            background-color: #e74c3c;
        }

        .btn-icon.btn-decline:hover {
            background-color: #c0392b;
        }

        .btn-icon.btn-export {
            background-color: #9b59b6;
        }

        .btn-icon.btn-export:hover {
            background-color: #8e44ad;
        }

        .btn-icon.btn-delete {
            background-color: #e74c3c;
        }

        .btn-icon.btn-delete:hover {
            background-color: #c0392b;
        }

        .btn-icon:not(:last-child) {
            margin-right: 0.25rem;
        }

        /* Form Styles */
        .form-container {
            width: 100%;
            max-width: none;
            margin: 1.5rem 0; /* Removed auto centering */
            padding: 1.5rem; /* Reduced from 2rem */
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: var(--spacing-unit);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        /* Override for modal form controls to ensure consistent sizing */
        .modal .form-group .form-control {
            padding: 0.2rem !important;
            font-size: 0.55rem !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 3px !important;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .login-box {
            background-color: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-color);
            opacity: 0.8;
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon input {
            padding-left: 40px;
            width: 100%;
            height: 45px;
        }

        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.5;
        }

        .btn-login {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            height: 45px;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn-login:hover {
            background-color: var(--secondary-color);
        }

        .error-message {
            color: var(--accent-color);
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Role Badge Styles */
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-guest {
            background-color: #95a5a6;
            color: white;
        }

        .role-standard {
            background-color: #3498db;
            color: white;
        }

        .role-editor {
            background-color: #2ecc71;
            color: white;
        }

        .role-admin {
            background-color: #e67e22;
            color: white;
        }

        .role-superuser {
            background-color: #9b59b6;
            color: white;
        }

        /* Form Hint Style */
        .form-hint {
            color: #666;
            font-size: 0.8rem;
            margin-top: 4px;
            display: block;
        }

        /* Content Header with Button */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem; /* Further reduced margin */
            margin-top: 0.2rem; /* Further reduced top margin */
        }

        /* User Table Status Styles */
        .status-active {
            background-color: #2ecc71;
            color: white;
        }

        .status-inactive {
            background-color: #95a5a6;
            color: white;
        }

        /* Modal Header Styles */
        .modal-header {
            border-bottom: 1px solid #ddd;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        /* Modal Footer Styles */
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 0.85rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-start; /* Changed from flex-end to flex-start to align buttons to the left */
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            bottom: 0;
            z-index: 2;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
        }

        .modal-footer .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        /* Color coding for different action buttons */
        .btn-edit {
            background-color: #3b82f6; /* Blue */
            color: white;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        .btn-edit:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background-color: #10b981; /* Green */
            color: white;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        .btn-delete {
            background-color: #f43f5e; /* Pink/Red */
            color: white;
            box-shadow: 0 2px 5px rgba(244, 63, 94, 0.3);
        }

        .btn-delete:hover {
            background-color: #e11d48;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(244, 63, 94, 0.4);
        }

        .btn-secondary {
            background-color: #6b7280; /* Gray */
            color: white;
            box-shadow: 0 2px 5px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
        }

        /* New warning color button - Yellow/Amber */
        .btn-warning {
            background-color: #f59e0b;
            color: white;
            box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }

        /* New info color button - Light blue */
        .btn-info {
            background-color: #0ea5e9;
            color: white;
            box-shadow: 0 2px 5px rgba(14, 165, 233, 0.3);
        }

        .btn-info:hover {
            background-color: #0284c7;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.4);
        }

        /* Disabled button styling */
        .btn:disabled,
        .btn.btn-disabled {
            opacity: 1; /* Changed from 0.6 */
            cursor: pointer; /* Changed from not-allowed */
            pointer-events: auto; /* Changed from none */
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled:hover,
        .btn.btn-disabled:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn.btn-success:disabled,
        .btn.btn-success.btn-disabled {
            background-color: #10b981; /* Changed from #92d3b5 to full color */
            color: #ffffff;
        }

        /* Add tooltip styling for disabled buttons */
        .btn.btn-disabled::before {
            content: attr(title);
            position: absolute;
            background-color: rgba(51, 51, 51, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn.btn-disabled::after {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: rgba(51, 51, 51, 0.9) transparent transparent transparent;
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* All remaining styles from styles.css - continued in the next section due to length... */
        
        /* Settings Navigation Styles */
        .settings-navigation {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 1rem;
        }

        .settings-nav-item {
            background: white;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .settings-nav-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .settings-nav-item a {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 1.5rem;
            text-decoration: none;
            color: inherit;
            height: 100%;
        }

        .settings-nav-item i {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
        }

        .settings-nav-item span {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .settings-description {
            font-size: 0.9rem;
            color: #666;
            margin: 0;
        }

        /* Enhanced Role Management Styles */
        .roles-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
        }

        .roles-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .role-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            border: 1px solid #eee;
        }

        .role-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: var(--secondary-color);
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Multiple Select Styles */
        select[multiple] {
            padding: 8px;
            width: 100%;
            border: 1px solid var(--border-color, #ddd);
            border-radius: 4px;
            background-color: white;
        }

        select[multiple] option {
            padding: 8px;
            margin: 2px 0;
            border-radius: 2px;
        }

        select[multiple] option:checked {
            background-color: var(--secondary-color);
            color: white;
        }

        /* Notification System Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
            color: white;
            font-weight: 500;
        }

        .notification-success {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .notification-error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .notification-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .notification-info {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Company Context Information Styles */
        .company-context-info {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .context-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .context-item label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .context-item span {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .access-granted {
            color: var(--green) !important;
            font-weight: 600;
        }

        .access-denied {
            color: var(--red) !important;
            font-weight: 600;
        }

        /* Enhanced status messages for authentication */
        .status-message.status-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .status-message.status-info {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        .status-message .fas {
            margin-right: 0.75rem;
            font-size: 1.1rem;
        }

        /* Company-scoped settings indicator */
        .settings-header::after {
            content: '';
            display: block;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            margin-top: 1rem;
            border-radius: 2px;
        }
    </style>
    </style>
    
    <!-- Core scripts for preferences and role management -->
    <!-- Embedded JavaScript modules for self-contained functionality -->
    
    <!-- Firebase Ready Promise - Must be defined before modules -->
    <script>
        // Firebase Ready Promise - Initialize Firebase v8
        window.firebaseReady = new Promise((resolve, reject) => {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initFirebase);
            } else {
                initFirebase();
            }
            
            function initFirebase() {
                // Check if Firebase is loaded
                if (typeof firebase === 'undefined') {
                    reject(new Error('Firebase SDK not loaded'));
                    return;
                }

                const firebaseConfig = {
                    apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
                    authDomain: "users-8be65.firebaseapp.com",
                    databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
                    projectId: "users-8be65",
                    storageBucket: "users-8be65.firebasestorage.app",
                    messagingSenderId: "829083030831",
                    appId: "1:829083030831:web:36a370e62691e560bc3dda"
                };
                
                // Initialize Firebase if not already initialized
                if (!firebase.apps.length) {
                    try {
                        firebase.initializeApp(firebaseConfig);
                        console.log('✅ Firebase initialized successfully');
                        resolve(firebase);
                    } catch (error) {
                        console.error('❌ Firebase initialization failed:', error);
                        reject(error);
                    }
                } else {
                    console.log('✅ Firebase already initialized');
                    resolve(firebase);
                }
            }
        });
    </script>
    
    <script type="module">
        // ========================================================================================
        // EMBEDDED FIREBASE CONFIG MODULE
        // ========================================================================================
        // Initialize Firebase v8 (since we're already loading v8 externally)
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Wait for Firebase to be ready then initialize modules
        window.firebaseReady.then(() => {
            // ========================================================================================
            // EMBEDDED COMPANY DATA SERVICE MODULE
            // ========================================================================================
            class CompanyDataService {
                constructor() {
                    this.currentUser = null;
                    this.currentCompany = null;
                    this.userCompanyId = null;
                    this.initializeUserContext();
                }

                async initializeUserContext() {
                    return new Promise((resolve) => {
                        const storedUser = localStorage.getItem('currentUser');
                        if (storedUser) {
                            const userData = JSON.parse(storedUser);
                            this.currentUser = { uid: userData.uid };
                            this.loadUserCompanyContext().then(resolve);
                        } else {
                            firebase.auth().onAuthStateChanged(async (user) => {
                                if (user) {
                                    this.currentUser = user;
                                    await this.loadUserCompanyContext();
                                }
                                resolve();
                            });
                        }
                    });
                }

                async loadUserCompanyContext() {
                    if (!this.currentUser) return;

                    try {
                        const companiesSnapshot = await firebase.database().ref('companies').once('value');
                        
                        if (companiesSnapshot.exists()) {
                            const companies = companiesSnapshot.val();
                            
                            for (const [companyId, company] of Object.entries(companies)) {
                                if (company.status === 'active') {
                                    if (company.users && company.users[this.currentUser.uid]) {
                                        const user = company.users[this.currentUser.uid];
                                        if (user.authUid === this.currentUser.uid) {
                                            this.userCompanyId = companyId;
                                            this.currentCompany = company;
                                            console.log('Company context loaded:', company.companyName);
                                            // Update menu visibility based on user permissions immediately
                                            updateMenuWithFeatureAuthorization();
                                            // Initialize company header display
                                            setTimeout(() => initializeCompanyHeader(), 100);
                                            // Update user profile with avatar
                                            setTimeout(() => {
                                                if (window.authManager?.updateUserProfile) {
                                                    window.authManager.updateUserProfile(this.currentUser);
                                                }
                                            }, 200);
                                            return;
                                        }
                                    }
                                    
                                    if (company.admin && (company.admin.authUid === this.currentUser.uid || company.admin.userId === this.currentUser.uid)) {
                                        this.userCompanyId = companyId;
                                        this.currentCompany = company;
                                        console.log('Company context loaded from admin:', company.companyName);
                                        // Update menu visibility based on user permissions immediately
                                        updateMenuWithFeatureAuthorization();
                                        // Initialize company header display
                                        setTimeout(() => initializeCompanyHeader(), 100);
                                        // Update user profile with avatar
                                        setTimeout(() => {
                                            if (window.authManager?.updateUserProfile) {
                                                window.authManager.updateUserProfile(this.currentUser);
                                            }
                                        }, 200);
                                        return;
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error loading user company context:', error);
                    }
                }

                getCurrentCompanyId() {
                    return this.userCompanyId;
                }

                getCurrentCompany() {
                    return this.currentCompany;
                }

                async hasCompanyAccess() {
                    return this.userCompanyId !== null;
                }
            }

            // ========================================================================================
            // EMBEDDED AUTH MANAGER MODULE
            // ========================================================================================
            class AuthManager {
                constructor() {
                    this.db = firebase.database(); // Add database reference
                    this.currentUser = this.getCurrentUser();
                    this.currentCompany = null;
                    this.initializeAuth();
                }

                getCurrentUser() {
                    const storedUser = localStorage.getItem('currentUser');
                    return storedUser ? JSON.parse(storedUser) : null;
                }

                setCurrentUser(userData) {
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    this.currentUser = userData;
                }

                initializeAuth() {
                    if (!this.currentUser) {
                        console.warn('No authenticated user found');
                        return;
                    }

                    this.loadUserRole(this.currentUser);
                    this.updateUIForAuthenticatedUser();
                }

                async loadUserRole(userData) {
                    try {
                        const userRef = firebase.database().ref(`users/${userData.uid}`);
                        userRef.once('value', (snapshot) => {
                            if (snapshot.exists()) {
                                const data = snapshot.val();
                                userData.role = data.role || 'standard';
                                userData.name = data.name || userData.name;
                                userData.department = data.department || 'Unknown';
                                this.setCurrentUser(userData);
                                this.updateUserProfile(userData);
                            }
                        });
                    } catch (error) {
                        console.error('Error loading user role:', error);
                    }
                }

                updateUIForAuthenticatedUser() {
                    this.updateUserProfile(this.currentUser);
                    this.setupProfileDropdown();

                    // Mirror staff.html: inject user info (avatar, name, email) into profile dropdown
                    (async () => {
                        try {
                            const profileBtn = document.querySelector('.profile-btn');
                            const profileDropdownList = document.querySelector('.profile-dropdown ul');
                            if (!profileBtn || !profileDropdownList || !this.currentUser) return;

                            const initials = this.getUserInitials();
                            const displayName = this.getUserDisplayName();
                            const email = this.getUserEmail();
                            const avatarUrl = await this.getUserAvatarUrl();

                            // Update header avatar image immediately if available
                            const profileImg = profileBtn.querySelector('img');
                            if (profileImg) {
                                if (avatarUrl) {
                                    profileImg.src = avatarUrl;
                                    profileImg.alt = displayName + ' Avatar';
                                } else {
                                    this.generateInitialsAvatar(displayName, profileImg);
                                }
                            }

                            const dropdownAvatarHtml = avatarUrl
                                ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">`
                                : `<div style="width: 24px; height: 24px; border-radius: 50%; background: #3498db; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 10px;">${initials}</div>`;

                            const userInfoHtml = `
                                <li style="border-bottom: 1px solid #eee; padding: 6px 10px; background: #f8f9fa;">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        ${dropdownAvatarHtml}
                                        <div>
                                            <div style=\"font-weight: 600; color: #333; font-size: 12px; margin-bottom: 1px;\">${displayName}</div>
                                            <div style=\"color: #666; font-size: 10px;\">${email}</div>
                                        </div>
                                    </div>
                                </li>
                                <li><a href="profile.html"><i class="fas fa-id-card"></i> Profile</a></li>
                                <li><a href="#" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            `;

                            profileDropdownList.innerHTML = userInfoHtml;

                            // Wire logout
                            const logoutBtn = profileDropdownList.querySelector('.logout-link');
                            if (logoutBtn) {
                                logoutBtn.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    this.logout();
                                });
                            }
                        } catch (e) {
                            console.warn('Profile dropdown update skipped:', e);
                        }
                    })();
                }

                // Get user display name
                getUserDisplayName() {
                    if (!this.currentUser) return 'User';
                    
                    const cleanName = (name) => {
                        if (!name || typeof name !== 'string') return '';
                        return name.trim().replace(/\s+/g, ' ');
                    };
                    
                    const potentialNames = [
                        this.currentUser.displayName,
                        this.currentUser.name,
                        this.currentUser.username
                    ];
                    
                    for (const name of potentialNames) {
                        const cleaned = cleanName(name);
                        if (cleaned) return cleaned;
                    }
                    
                    if (this.currentUser.email) {
                        const emailUsername = this.currentUser.email.split('@')[0];
                        const cleaned = cleanName(emailUsername);
                        if (cleaned) return cleaned;
                    }
                    
                    return 'User';
                }

                // Get user initials for avatar display
                getUserInitials() {
                    const displayName = this.getUserDisplayName();
                    
                    if (!displayName || displayName === 'User') return 'U';
                    
                    const words = displayName.split(' ').filter(word => word.length > 0);
                    if (words.length === 1) {
                        return words[0].substring(0, 2).toUpperCase();
                    } else {
                        return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                    }
                }

                // Get user email
                getUserEmail() {
                    return this.currentUser?.email || '';
                }

                // Generate initials avatar
                generateInitialsAvatar(name, imgElement) {
                    if (!imgElement || !name) return;
                    
                    const initials = this.getUserInitials();
                    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                    const backgroundColor = colors[name.length % colors.length];
                    
                    const svg = `
                        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                            <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                        </svg>
                    `;
                    
                    imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
                    imgElement.alt = name + ' Avatar';
                }

                // Get user avatar URL or null if not available
                async getUserAvatarUrl() {
                    if (!this.currentUser) return null;
                    
                    try {
                        // First, try to get avatar from Firebase Storage (matches roles.html)
                        const firebase = window.firebase;
                        const storage = firebase.storage();
                        const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                        const avatarRef = storage.ref(avatarPath);
                        
                        try {
                            const downloadUrl = await avatarRef.getDownloadURL();
                            console.log('✅ Found avatar in Firebase Storage:', downloadUrl);
                            return downloadUrl;
                        } catch (storageError) {
                            console.log('ℹ️ No avatar found in Firebase Storage, checking user properties...');
                        }
                        
                        // Fallback: Check various sources for avatar URL in user data
                        const avatarSources = [
                            this.currentUser.photoURL,
                            this.currentUser.profilePicture,
                            this.currentUser.avatar,
                            this.currentUser.avatarUrl
                        ];
                        
                        for (const url of avatarSources) {
                            if (url && typeof url === 'string' && url.startsWith('http')) {
                                console.log('✅ Found avatar in user properties:', url);
                                return url;
                            }
                        }
                        
                        console.log('ℹ️ No avatar URL found in any source');
                        return null;
                        
                    } catch (error) {
                        console.error('❌ Error getting avatar URL:', error);
                        return null;
                    }
                }

                async updateUserProfile(userData) {
                    console.log('🔄 Updating user profile...');
                    const profileBtn = document.getElementById('userProfileBtn');
                    const userNameElement = document.querySelector('.user-name');
                    const userEmailElement = document.querySelector('.user-email');

                    if (profileBtn) {
                        const profileImg = profileBtn.querySelector('img');
                        if (profileImg) {
                            const displayName = this.getUserDisplayName();
                            const email = this.getUserEmail();
                            
                            console.log('👤 User info:', { displayName, email });
                            
                            // Preload avatar URL to avoid showing initials first
                            const avatarUrl = await this.getUserAvatarUrl();
                            
                            if (avatarUrl) {
                                console.log('🖼️ Loading user avatar from URL:', avatarUrl);
                                profileImg.src = avatarUrl;
                                profileImg.alt = displayName + ' Avatar';
                                
                                // Add error handler to fallback to initials
                                profileImg.onerror = () => {
                                    console.log('❌ Avatar failed to load, generating initials avatar');
                                    this.generateInitialsAvatar(displayName, profileImg);
                                };
                            } else {
                                console.log('ℹ️ No avatar URL found, generating initials avatar');
                                // Generate initials avatar
                                this.generateInitialsAvatar(displayName, profileImg);
                            }
                            
                            // Update user info in dropdown (optional; elements may not exist)
                            if (userNameElement) {
                                userNameElement.textContent = displayName;
                            }
                            if (userEmailElement) {
                                userEmailElement.textContent = email;
                            }
                            
                            console.log('✅ User profile updated');
                        }
                    }
                    
                    // Also update all avatar displays on the page
                    await this.updateUserProfileDisplay();
                }

                setupProfileDropdown() {
                    const userProfileBtn = document.getElementById('userProfileBtn');
                    const profileDropdown = document.querySelector('.profile-dropdown');
                    
                    if (userProfileBtn && profileDropdown) {
                        userProfileBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            profileDropdown.classList.toggle('show');
                        });

                        document.addEventListener('click', (e) => {
                            if (!userProfileBtn.contains(e.target)) {
                                profileDropdown.classList.remove('show');
                            }
                        });
                        
                        // Setup notification dropdown if available
                        const notificationBtn = document.querySelector('.notification-btn');
                        const notificationDropdown = document.querySelector('.notification-dropdown');
                        
                        if (notificationBtn && notificationDropdown) {
                            notificationBtn.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                
                                // Refresh notifications when bell is clicked to ensure latest state
                                console.log('🔔 Notification bell clicked, refreshing notifications...');
                                if (window.notificationManager) {
                                    try {
                                        await window.notificationManager.forceRefresh();
                                        console.log('✅ Notifications refreshed on bell click');
                                    } catch (error) {
                                        console.warn('⚠️ Error refreshing notifications on bell click:', error);
                                    }
                                }
                                
                                notificationDropdown.classList.toggle('show');
                            });
                            
                            document.addEventListener('click', (e) => {
                                if (!notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) {
                                    notificationDropdown.classList.remove('show');
                                }
                            });
                            
                            // Handle mark all as read button
                            const markAllReadBtn = notificationDropdown.querySelector('.mark-all-read');
                            if (markAllReadBtn) {
                                markAllReadBtn.addEventListener('click', async () => {
                                    if (window.notificationManager) {
                                        window.notificationManager.markAllAsRead();
                                    }
                                });
                            }
                            
                            // Handle clear all notifications button
                            const clearAllBtn = notificationDropdown.querySelector('.clear-all-notifications');
                            if (clearAllBtn) {
                                clearAllBtn.addEventListener('click', async () => {
                                    if (confirm('Are you sure you want to clear all notifications?')) {
                                        if (window.notificationManager) {
                                            window.notificationManager.clearAll();
                                        }
                                    }
                                });
                            }
                        }
                    }
                }

                // Update user avatar display with profile picture or initials
                async updateUserAvatarDisplay(elementId = 'userAvatarInitials') {
                    const avatarElement = document.getElementById(elementId);
                    if (avatarElement) {
                        console.log(`🎭 Updating avatar for element: ${elementId} (${avatarElement.tagName})`);
                        try {
                            const avatarUrl = await this.getUserAvatarUrl();
                            console.log(`🔍 Avatar URL result for ${elementId}:`, avatarUrl);
                            
                            // Handle <img> elements differently from div elements
                            if (avatarElement.tagName === 'IMG') {
                                if (avatarUrl) {
                                    // For img elements, just update the src
                                    avatarElement.src = avatarUrl;
                                    avatarElement.alt = this.getUserDisplayName() + ' Avatar';
                                    console.log('✅ Profile picture loaded for img element:', elementId);
                                    
                                    // Add error handler to fallback to initials if image fails to load
                                    avatarElement.onerror = () => {
                                        console.log('❌ Image failed to load, generating initials avatar for:', elementId);
                                        this.generateInitialsAvatar(this.getUserDisplayName(), avatarElement);
                                    };
                                } else {
                                    // For img elements without avatar, generate initials avatar
                                    console.log('ℹ️ No avatar URL, generating initials for img element:', elementId);
                                    this.generateInitialsAvatar(this.getUserDisplayName(), avatarElement);
                                }
                            } else {
                                // For div/other elements, use innerHTML
                                if (avatarUrl) {
                                    // Show custom avatar
                                    avatarElement.innerHTML = `<img src="${avatarUrl}" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.textContent='${this.getUserInitials()}';">`;
                                    console.log('✅ Profile picture loaded for element:', elementId);
                                } else {
                                    // Show initials
                                    avatarElement.textContent = this.getUserInitials();
                                    console.log('✅ User initials displayed for element:', elementId);
                                }
                            }
                        } catch (error) {
                            console.error(`❌ Error updating avatar for ${elementId}:`, error);
                            // Fallback based on element type
                            if (avatarElement.tagName === 'IMG') {
                                this.generateInitialsAvatar(this.getUserDisplayName(), avatarElement);
                            } else {
                                avatarElement.textContent = this.getUserInitials();
                            }
                            console.warn('⚠️ Avatar loading failed, showing fallback for element:', elementId);
                        }
                    } else {
                        console.warn(`⚠️ Avatar element not found: ${elementId}`);
                    }
                }

                // Update user avatar initials on page
                updateUserAvatarInitials(elementId = 'userAvatarInitials') {
                    const avatarElement = document.getElementById(elementId);
                    if (avatarElement) {
                        avatarElement.textContent = this.getUserInitials();
                    }
                }

                // Update user profile display elements
                async updateUserProfileDisplay() {
                    // Update avatar displays with custom images or initials
                    await this.updateUserAvatarDisplay();
                    await this.updateUserAvatarDisplay('userInitials'); // Alternative ID used in some pages
                    await this.updateUserAvatarDisplay('userAvatar'); // Update the main avatar in header
                    
                    // Update user name displays
                    const userNameElements = document.querySelectorAll('#userName, #userDisplayName, .user-name-display');
                    userNameElements.forEach(element => {
                        element.textContent = this.getUserDisplayName();
                    });
                    
                    // Update user email displays
                    const userEmailElements = document.querySelectorAll('#userEmail, #userDisplayEmail, .user-email-display');
                    userEmailElements.forEach(element => {
                        element.textContent = this.getUserEmail();
                    });
                }

                async logout() {
                    try {
                        await firebase.auth().signOut();
                        localStorage.removeItem('currentUser');
                        window.location.href = 'login.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                }

                // ========================================================================================
                // NOTIFICATION SYSTEM METHODS - MATCHES STAFF.HTML
                // ========================================================================================

                // Create notification for user activity
                async createNotification(recipientUserId, notificationData) {
                    try {
                        console.log('🔔 Creating notification for user:', recipientUserId);
                        console.log('📄 Notification data:', notificationData);
                        
                        // Test Firebase connection and auth
                        console.log('🔥 Firebase connection test:');
                        console.log('  - Firebase available:', !!firebase);
                        console.log('  - Database available:', !!firebase?.database);
                        console.log('  - Auth available:', !!firebase?.auth);
                        console.log('  - Current auth user:', firebase?.auth()?.currentUser?.uid);
                        
                        if (!this.currentUser) {
                            console.log('❌ No authenticated user for creating notifications');
                            return false;
                        }

                        console.log('👤 Current user creating notification:', this.currentUser.uid, this.currentUser.email);

                        const notificationId = 'notif_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        const notification = {
                            id: notificationId,
                            title: notificationData.title,
                            message: notificationData.message,
                            type: notificationData.type || 'info',
                            read: false,
                            timestamp: Date.now(),
                            createdAt: new Date().toISOString(),
                            createdBy: this.currentUser.uid,
                            createdByName: `${this.currentUser.firstName || ''} ${this.currentUser.lastName || ''}`.trim() || this.currentUser.name || this.currentUser.email,
                            companyId: this.currentUser.companyId,
                            relatedData: notificationData.relatedData || {}
                        };

                        console.log('💾 Saving notification to Firebase:', `notifications/${recipientUserId}/${notificationId}`);
                        console.log('📦 Full notification object:', notification);

                        const notificationRef = firebase.database().ref(`notifications/${recipientUserId}/${notificationId}`);
                        await notificationRef.set(notification);
                        
                        console.log(`✅ Notification created for user ${recipientUserId}:`, notification.title);
                        
                        // If the recipient is the current user, refresh their notification badge
                        if (recipientUserId === this.currentUser.uid) {
                            console.log('🔄 Refreshing notification badge for current user');
                            // Use the same pattern as staff.html
                            setTimeout(async () => {
                                const notifications = await this.loadNotifications();
                                this.updateNotificationBadgeCount(notifications);
                                this.populateNotificationDropdown(notifications);
                                console.log('📊 Updated badge and dropdown via AuthManager, total notifications:', notifications.length);
                            }, 100);
                        }

                        return true;
                    } catch (error) {
                        console.error('❌ Error creating notification:', error);
                        console.error('❌ Error details:', error.message, error.stack);
                        return false;
                    }
                }

                // Create notifications for multiple users involved in an action
                async createNotificationsForAction(actionType, actionData, involvedUsers) {
                    try {
                        const notifications = [];
                        const currentUser = this.currentUser;
                        
                        if (!currentUser) {
                            console.error('No current user for notification creation');
                            return false;
                        }

                        // Define notification templates for different actions (recruitment specific)
                        const notificationTemplates = {
                            recruitment_created: {
                                title: 'New Recruitment Request Created',
                                message: `New recruitment request "${actionData.positionTitle}" in ${actionData.department} requires review`,
                                type: 'info'
                            },
                            recruitment_approved: {
                                title: 'Recruitment Request Approved',
                                message: `Recruitment request "${actionData.positionTitle}" has been approved`,
                                type: 'success'
                            },
                            recruitment_declined: {
                                title: 'Recruitment Request Declined',
                                message: `Recruitment request "${actionData.positionTitle}" has been declined`,
                                type: 'warning'
                            },
                            recruitment_submitted: {
                                title: 'Recruitment Request Submitted',
                                message: `Recruitment request "${actionData.positionTitle}" in ${actionData.department} has been submitted for approval`,
                                type: 'info'
                            },
                            recruitment_published: {
                                title: 'Position Published',
                                message: `Position "${actionData.positionTitle}" has been published and is actively recruiting`,
                                type: 'success'
                            },
                            recruitment_closed: {
                                title: 'Position Closed',
                                message: `Position "${actionData.positionTitle}" has been closed`,
                                type: 'info'
                            },
                            recruitment_filled: {
                                title: 'Position Filled',
                                message: `Position "${actionData.positionTitle}" has been successfully filled`,
                                type: 'success'
                            }
                        };

                        const template = notificationTemplates[actionType];
                        if (!template) {
                            console.warn(`No notification template found for action: ${actionType}`);
                            return false;
                        }

                        // Create notifications for all involved users
                        for (const userId of involvedUsers) {
                            // Don't notify the user who performed the action unless specified
                            if (userId === currentUser.uid && !actionData.notifyCreator) {
                                continue;
                            }

                            const notificationData = {
                                ...template,
                                relatedData: {
                                    actionType,
                                    recruitmentId: actionData.id || actionData.firebaseKey,
                                    positionTitle: actionData.positionTitle,
                                    department: actionData.department,
                                    employmentType: actionData.employmentType,
                                    actionPerformedBy: currentUser.uid,
                                    actionPerformedByName: `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || currentUser.name || currentUser.email
                                }
                            };

                            const success = await this.createNotification(userId, notificationData);
                            if (success) {
                                notifications.push({ userId, notificationData });
                            }
                        }

                        console.log(`✅ Created ${notifications.length} notifications for action: ${actionType}`);
                        return notifications.length > 0;

                    } catch (error) {
                        console.error('Error creating notifications for action:', error);
                        return false;
                    }
                }

                // Load notifications for current user (used by notification system)
                async loadNotifications() {
                    try {
                        if (!this.currentUser) {
                            console.log('No authenticated user for loading notifications');
                            return [];
                        }

                        const notificationsRef = firebase.database().ref(`notifications/${this.currentUser.uid}`);
                        const snapshot = await notificationsRef.once('value');
                        
                        if (!snapshot.exists()) {
                            return [];
                        }

                        const notificationsData = snapshot.val();
                        const notifications = Object.values(notificationsData)
                            .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                        return notifications;
                    } catch (error) {
                        console.error('Error loading notifications:', error);
                        return [];
                    }
                }

                // Get all users who should be notified for a recruitment action
                async getInvolvedUsersForRecruitmentAction(recruitmentData, actionType) {
                    try {
                        const involvedUsers = new Set();
                        const currentUser = this.currentUser;
                        
                        console.log('🔍 Getting involved users for recruitment action:', actionType);
                        console.log('Current user:', currentUser?.uid);
                        console.log('Recruitment data:', { 
                            id: recruitmentData.id, 
                            createdBy: recruitmentData.createdBy, 
                            department: recruitmentData.department 
                        });
                        
                        if (!currentUser || !currentUser.companyId) {
                            console.warn('❌ No current user or company ID');
                            return [];
                        }

                        // Include the creator (person who created the recruitment request)
                        if (recruitmentData.createdBy && recruitmentData.createdBy !== currentUser.uid) {
                            involvedUsers.add(recruitmentData.createdBy);
                            console.log('➕ Added recruitment creator:', recruitmentData.createdBy);
                        }

                        // Include line manager if specified (for recruitment_created action)
                        if (actionType === 'recruitment_created' && recruitmentData.lineManager) {
                            try {
                                console.log('🔍 Looking for line manager:', recruitmentData.lineManager);
                                
                                // Check if lineManager is already a user ID (UID format)
                                if (recruitmentData.lineManager.length > 20) {
                                    // Likely a Firebase UID
                                    if (recruitmentData.lineManager !== currentUser.uid) {
                                        involvedUsers.add(recruitmentData.lineManager);
                                        console.log('➕ Added line manager by ID:', recruitmentData.lineManager);
                                    }
                                } else {
                                    // Line manager is stored as name, need to find the user ID
                                    const companyUsersRef = firebase.database().ref(`companies/${currentUser.companyId}/users`);
                                    const usersSnapshot = await companyUsersRef.once('value');
                                    
                                    if (usersSnapshot.exists()) {
                                        const usersData = usersSnapshot.val();
                                        const lineManagerName = recruitmentData.lineManager.toLowerCase().trim();
                                        
                                        Object.entries(usersData).forEach(([userId, userData]) => {
                                            if (userId !== currentUser.uid && userData && userData.name) {
                                                const userName = userData.name.toLowerCase().trim();
                                                // Match by full name or check if the line manager name is contained in user name
                                                if (userName === lineManagerName || 
                                                    userName.includes(lineManagerName) || 
                                                    lineManagerName.includes(userName)) {
                                                    involvedUsers.add(userId);
                                                    console.log('➕ Added line manager by name match:', userId, userData.name);
                                                }
                                            }
                                        });
                                    }
                                }
                            } catch (error) {
                                console.warn('Error resolving line manager for notifications:', error);
                            }
                        }

                        // Always include submitter for confirmation notification (even if they are the current user)
                        if (actionType === 'recruitment_created') {
                            if (recruitmentData.createdBy && recruitmentData.createdBy === currentUser.uid) {
                                involvedUsers.add(recruitmentData.createdBy);
                                console.log('➕ Added submitter (current user) for confirmation:', recruitmentData.createdBy);
                            }
                        }

                        // Get recruitment approval flow to include approvers
                        if (actionType.includes('created') || actionType.includes('submitted') || actionType.includes('approval')) {
                            console.log('🔍 Fetching recruitment approval config for approvers...');
                            
                            // Try to get recruitment-specific approval config, fallback to staff approval config
                            let approvalConfig = null;
                            try {
                                const recruitmentApprovalRef = firebase.database().ref(`companies/${currentUser.companyId}/settings/recruitmentApprovalFlow`);
                                const recruitmentSnapshot = await recruitmentApprovalRef.once('value');
                                if (recruitmentSnapshot.exists()) {
                                    approvalConfig = recruitmentSnapshot.val();
                                    console.log('✅ Found recruitment-specific approval config');
                                } else {
                                    // Fallback to staff approval config
                                    console.log('⚠️ No recruitment approval config, trying staff approval config as fallback');
                                    approvalConfig = await this.fetchApprovalFlowConfig();
                                }
                            } catch (error) {
                                console.warn('Error fetching recruitment approval config:', error);
                                // Fallback to staff approval config
                                approvalConfig = await this.fetchApprovalFlowConfig();
                            }
                            
                            if (approvalConfig && approvalConfig.enabled && approvalConfig.selectedRoles) {
                                console.log('✅ Approval config found with roles:', Object.keys(approvalConfig.selectedRoles || {}));
                                
                                // Get approvers from all roles
                                for (const [roleName, roleConfig] of Object.entries(approvalConfig.selectedRoles)) {
                                    if (roleConfig && roleConfig.approvers && Array.isArray(roleConfig.approvers)) {
                                        roleConfig.approvers.forEach(approver => {
                                            if (approver.id && approver.id !== currentUser.uid) {
                                                involvedUsers.add(approver.id);
                                                console.log('➕ Added recruitment approver:', approver.id, approver.name, 'from role:', roleName);
                                            }
                                        });
                                    }
                                }
                            } else {
                                console.warn('⚠️ No approval config found or disabled for recruitment');
                            }
                        }

                        // Get all HR/recruitment team members for recruitment notifications
                        try {
                            console.log('🔍 Fetching HR/recruitment team members...');
                            const companyUsersRef = firebase.database().ref(`companies/${currentUser.companyId}/users`);
                            const usersSnapshot = await companyUsersRef.once('value');
                            
                            if (usersSnapshot.exists()) {
                                const usersData = usersSnapshot.val();
                                Object.entries(usersData).forEach(([userId, userData]) => {
                                    if (userId !== currentUser.uid && userData) {
                                        // Include HR team members, recruitment team, and department heads
                                        const role = (userData.role || '').toLowerCase();
                                        const department = (userData.department || '').toLowerCase();
                                        
                                        if (role.includes('hr') || 
                                            role.includes('human resource') || 
                                            role.includes('recruitment') || 
                                            role.includes('recruiter') ||
                                            department.includes('hr') ||
                                            department.includes('human resource') ||
                                            department.includes('recruitment')) {
                                            involvedUsers.add(userId);
                                            console.log('➕ Added HR/recruitment team member:', userId, userData.name);
                                        }
                                        
                                        // Include department heads for their department's recruitment
                                        if (recruitmentData.department && 
                                            (role.includes('head') || role.includes('manager') || role.includes('director')) && 
                                            userData.department && 
                                            userData.department.toLowerCase().includes(recruitmentData.department.toLowerCase())) {
                                            involvedUsers.add(userId);
                                            console.log('➕ Added department head:', userId, userData.name, 'for department:', recruitmentData.department);
                                        }
                                    }
                                });
                            }
                        } catch (error) {
                            console.warn('Error fetching company users for recruitment notifications:', error);
                        }

                        // For specific action types, add relevant users
                        switch (actionType) {
                            case 'recruitment_published':
                                // Notify hiring managers and team leads for published positions
                                if (recruitmentData.hiringManager && recruitmentData.hiringManager !== currentUser.uid) {
                                    involvedUsers.add(recruitmentData.hiringManager);
                                    console.log('➕ Added hiring manager for published position:', recruitmentData.hiringManager);
                                }
                                break;
                                
                            case 'recruitment_filled':
                                // Notify all stakeholders when position is filled
                                if (recruitmentData.createdBy && recruitmentData.createdBy !== currentUser.uid) {
                                    involvedUsers.add(recruitmentData.createdBy);
                                    console.log('➕ Added creator for filled position notification:', recruitmentData.createdBy);
                                }
                                break;
                        }

                        const result = Array.from(involvedUsers);
                        console.log(`✅ Found ${result.length} involved users for recruitment action '${actionType}':`, result);
                        
                        // Enhanced debugging: show user details if we found users
                        if (result.length > 0) {
                            try {
                                const companyUsersRef = firebase.database().ref(`companies/${currentUser.companyId}/users`);
                                const usersSnapshot = await companyUsersRef.once('value');
                                if (usersSnapshot.exists()) {
                                    const usersData = usersSnapshot.val();
                                    console.log('👥 User details for notifications:');
                                    result.forEach(userId => {
                                        const userData = usersData[userId];
                                        console.log(`  - ${userId}: ${userData?.name || 'Unknown'} (${userData?.email || 'No email'})`);
                                    });
                                }
                            } catch (debugError) {
                                console.warn('Debug error getting user details:', debugError);
                            }
                        } else {
                            console.warn('⚠️ No users found for notification - checking recruitment data:', {
                                createdBy: recruitmentData.createdBy,
                                lineManager: recruitmentData.lineManager,
                                department: recruitmentData.department,
                                currentUserUid: currentUser.uid
                            });
                        }
                        
                        return result;

                    } catch (error) {
                        console.error('Error getting involved users for recruitment action:', error);
                        return [];
                    }
                }

                // Fetch approval flow config (reused from staff.html logic)
                async fetchApprovalFlowConfig() {
                    try {
                        if (!this.currentUser || !this.currentUser.companyId) {
                            console.warn('No current user or company ID for fetching approval config');
                            return null;
                        }

                        const approvalRef = firebase.database().ref(`companies/${this.currentUser.companyId}/settings/approvalFlow`);
                        const snapshot = await approvalRef.once('value');
                        
                        if (snapshot.exists()) {
                            return snapshot.val();
                        } else {
                            console.log('No approval flow config found');
                            return null;
                        }
                    } catch (error) {
                        console.error('Error fetching approval flow config:', error);
                        return null;
                    }
                }

                // Update notification badge count (matches staff.html)
                updateNotificationBadgeCount(notifications) {
                    const badge = document.querySelector('.notification-badge');
                    if (!badge) return;

                    const unreadCount = notifications.filter(n => !n.read).length;
                    
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                // Populate notification dropdown (matches staff.html)
                populateNotificationDropdown(notifications) {
                    const container = document.querySelector('.notification-list');
                    const emptyState = document.querySelector('.notification-empty');
                    
                    if (!container) return;

                    if (notifications.length === 0) {
                        // Show empty state
                        if (emptyState) {
                            emptyState.style.display = 'block';
                        }
                        container.innerHTML = '';
                        return;
                    }

                    // Hide empty state
                    if (emptyState) {
                        emptyState.style.display = 'none';
                    }

                    // Populate notifications
                    notifications.slice(0, 10).forEach((notification, index) => {
                        console.log(`📝 Adding notification ${index + 1}:`, notification.title);
                        
                        const notificationItem = document.createElement('div');
                        notificationItem.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                        
                        const timeAgo = this.formatTimeAgo(notification.timestamp);
                        
                        notificationItem.innerHTML = `
                            <div class="notification-content">
                                <div class="notification-title">${notification.title || 'New Notification'}</div>
                                <div class="notification-message">${notification.message || 'You have a new notification'}</div>
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                            <div class="notification-actions">
                                ${!notification.read ? 
                                    `<button class="mark-read-btn" title="Mark as read" onclick="markNotificationAsRead('${notification.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>` : 
                                    `<button class="mark-read-btn" title="Already read" disabled>
                                        <i class="fas fa-check"></i>
                                    </button>`
                                }
                                <button class="delete-notification-btn" title="Delete notification" onclick="deleteNotificationWithConfirm('${notification.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        container.appendChild(notificationItem);
                    });

                    // Update badge with unread count
                    this.updateNotificationBadgeCount(notifications);
                }

                // Format time ago helper method (matches staff.html)
                formatTimeAgo(timestamp) {
                    const now = new Date();
                    const time = new Date(timestamp);
                    const diffInSeconds = Math.floor((now - time) / 1000);

                    if (diffInSeconds < 60) {
                        return 'Just now';
                    } else if (diffInSeconds < 3600) {
                        const minutes = Math.floor(diffInSeconds / 60);
                        return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                    } else if (diffInSeconds < 86400) {
                        const hours = Math.floor(diffInSeconds / 3600);
                        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                    } else {
                        const days = Math.floor(diffInSeconds / 86400);
                        return `${days} day${days !== 1 ? 's' : ''} ago`;
                    }
                }
            }

            // ========================================================================================
            // EMBEDDED MENU VISIBILITY MODULE - MATCHES STAFF.HTML AND DASHBOARD.HTML
            // ========================================================================================
            
            // Menu visibility management system (updated to match dashboard.html)

            // Initialize menu state - DOES NOT remove menu-loading class
            function resetMenuVisibility() {
                document.querySelectorAll('[data-feature]').forEach(item => {
                    item.classList.remove('menu-visible');
                });
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('menu-visible');
                });
                // NOTE: Do NOT remove menu-loading class here - it should only be removed after successful permission loading
            }

            // Emergency fallback - show basic menu items
            function showBasicMenu() {
                console.log('🔧 Emergency fallback: Showing basic menu items');
                resetMenuVisibility();
                const homeItem = document.querySelector('[data-feature="home_view"]');
                if (homeItem) {
                    homeItem.classList.add('menu-visible');
                }
            }

            // Apply feature-based menu visibility
            async function applyFeatureBasedMenuVisibility(companyId) {
                try {
                    console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                    
                    // Get platform features
                    const database = firebase.database();
                    const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                    
                    if (!featuresSnapshot.exists()) {
                        console.log('⚠️ No platform features found');
                        resetMenuVisibility();
                        return;
                    }
                    
                    const featuresData = featuresSnapshot.val();
                    
                    // Get company's selected features
                    const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                    const companyData = companySnapshot.val();
                    
                    if (!companyData) {
                        console.error('❌ Company data not found');
                        resetMenuVisibility();
                        return;
                    }
                    
                    const subscribedFeatureIds = companyData.selectedFeatures || [];
                    console.log('🏢 Company subscribed features:', subscribedFeatureIds);
                    
                    if (subscribedFeatureIds.length === 0) {
                        console.log('⚠️ Company has no subscribed features');
                        resetMenuVisibility();
                        return;
                    }
                    
                    // Collect authorized pages from subscribed features
                    const authorizedPages = [];
                    subscribedFeatureIds.forEach(featureId => {
                        const feature = featuresData[featureId];
                        if (feature && feature.status === 'active' && feature.authorizedPages) {
                            console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                            authorizedPages.push(...feature.authorizedPages);
                        } else {
                            console.log(`⚠️ Feature ${featureId} not found or inactive`);
                        }
                    });
                    
                    console.log('🔐 All authorized pages:', authorizedPages);
                    
                    // Reset all menu items first
                    resetMenuVisibility();
                    
                    // Create set of authorized features
                    const authorizedFeatures = new Set();
                    authorizedPages.forEach(pageInfo => {
                        if (pageInfo.feature) {
                            authorizedFeatures.add(pageInfo.feature);
                        }
                    });
                    
                    console.log('🎯 Authorized features for recruitboard.html:', Array.from(authorizedFeatures));
                    
                    // Apply menu visibility
                    const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                    let visibleCount = 0;
                    
                    allMenuItems.forEach(menuItem => {
                        const featureAttribute = menuItem.getAttribute('data-feature');
                        const isAuthorized = authorizedFeatures.has(featureAttribute);
                        const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                        
                        if (isDropdownContainer) {
                            return; // Handle dropdowns separately after all items are processed
                        }
                        
                        if (isAuthorized) {
                            menuItem.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
                        } else {
                            menuItem.classList.remove('menu-visible');
                            console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
                        }
                    });
                    
                    // Handle dropdown menus - show if they have visible children
                    const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                    dropdownMenus.forEach(dropdown => {
                        const dropdownFeature = dropdown.getAttribute('data-feature');
                        const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                        let hasVisibleChildren = false;
                        
                        submenuItems.forEach(submenuItem => {
                            if (submenuItem.classList.contains('menu-visible')) {
                                hasVisibleChildren = true;
                            }
                        });
                        
                        if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                            dropdown.classList.add('menu-visible');
                            console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                        } else {
                            dropdown.classList.remove('menu-visible');
                            console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                        }
                    });
                    
                    console.log(`🎯 Feature-based menu authorization completed for recruitboard.html - ${visibleCount} items visible`);
                    
                    // Remove menu-loading class only after successful authorization
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('menu-loading');
                        console.log('✅ Menu loading completed - showing authorized menu items');
                    }
                    
                } catch (error) {
                    console.error('❌ Error applying feature-based menu visibility:', error);
                    resetMenuVisibility();
                    // Remove menu-loading class even on error to prevent permanent loading state
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('menu-loading');
                    }
                }
            }

            // Feature-based authorization system that takes priority over role permissions
            async function updateMenuWithFeatureAuthorization() {
                console.log('🎯 Starting feature-based menu authorization for recruitboard.html...');
                
                try {
                    let currentUser = null;
                    let companyId = null;
                    
                    // Get user and company info using authManager first
                    if (window.authManager && window.authManager.currentUser) {
                        currentUser = window.authManager.currentUser;
                        companyId = currentUser.companyId;
                        console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                    } else if (firebase.auth().currentUser) {
                        currentUser = firebase.auth().currentUser;
                        console.log('👤 Using Firebase auth - will search for company');
                    } else {
                        console.log('❌ No authenticated user found');
                        resetMenuVisibility();
                        // Remove menu-loading class when no user found
                        const sidebar = document.querySelector('.sidebar');
                        if (sidebar) {
                            sidebar.classList.remove('menu-loading');
                        }
                        return;
                    }
                    
                    // If no company ID from authManager, search companies collection
                    if (!companyId && currentUser) {
                        console.log('🔍 Searching for user company...');
                        const database = firebase.database();
                        const companiesRef = database.ref('companies');
                        const companiesSnapshot = await companiesRef.once('value');
                        
                        if (companiesSnapshot.exists()) {
                            const companies = companiesSnapshot.val();
                            
                            for (const [cId, company] of Object.entries(companies)) {
                                if (company.status !== 'active') continue;
                                
                                if (company.users && company.users[currentUser.uid]) {
                                    companyId = cId;
                                    console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (!companyId) {
                        console.error('❌ No company ID found, cannot determine authorized features');
                        resetMenuVisibility();
                        // Remove menu-loading class when no company found
                        const sidebar = document.querySelector('.sidebar');
                        if (sidebar) {
                            sidebar.classList.remove('menu-loading');
                        }
                        return;
                    }
                    
                    // Apply feature-based authorization
                    await applyFeatureBasedMenuVisibility(companyId);
                    
                } catch (error) {
                    console.error('❌ Error in feature-based menu authorization:', error);
                    resetMenuVisibility();
                    // Remove menu-loading class on error
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar) {
                        sidebar.classList.remove('menu-loading');
                    }
                }
            }

            // Fallback function to show all menu items if feature loading fails
            function showAllMenuItems() {
                const menuElement = document.getElementById('roleBasedMenu');
                const sidebar = document.querySelector('.sidebar');
                
                if (menuElement) {
                    const allItems = menuElement.querySelectorAll('[data-feature]');
                    allItems.forEach(item => {
                        item.classList.add('menu-visible');
                    });
                    
                    const dropdowns = menuElement.querySelectorAll('.menu-dropdown');
                    dropdowns.forEach(dropdown => {
                        dropdown.classList.add('menu-visible');
                    });
                }
                
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                console.log('Fallback: Showing all menu items');
            }

            // Make updateMenuWithFeatureAuthorization available globally
            window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

            // Enhanced initialization - use feature-based authorization by default
            document.addEventListener('DOMContentLoaded', function() {
                // Wait for auth manager to be ready
                setTimeout(async () => {
                    try {
                        await updateMenuWithFeatureAuthorization();
                    } catch (error) {
                        console.error('❌ Error initializing feature-based menu:', error);
                        showBasicMenu();
                    }
                }, 1500);
                
                // Add hover debugging for submenu items
                setTimeout(() => {
                    const dropdowns = document.querySelectorAll('.menu-dropdown');
                    dropdowns.forEach(dropdown => {
                        dropdown.addEventListener('mouseenter', function() {
                            console.log('Hovering over dropdown:', this.querySelector('a').textContent);
                            const submenu = this.querySelector('.submenu');
                            if (submenu) {
                                const visibleItems = submenu.querySelectorAll('li.menu-visible');
                                const hiddenItems = submenu.querySelectorAll('li:not(.menu-visible)');
                                console.log('Visible submenu items:', visibleItems.length);
                                console.log('Hidden submenu items:', hiddenItems.length);
                                
                                // Force show visible submenu items
                                visibleItems.forEach(item => {
                                    item.style.display = 'block';
                                });
                            }
                        });
                    });
                }, 2000);
            });

            // Also add a backup initialization outside the Firebase ready block
            document.addEventListener('DOMContentLoaded', function() {
                // Backup initialization in case the Firebase ready block doesn't execute
                setTimeout(() => {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar && sidebar.classList.contains('menu-loading')) {
                        console.warn('Firebase initialization may have failed, showing basic menu');
                        showBasicMenu();
                    }
                }, 5000);
            });

            // ========================================================================================
            // EMBEDDED NOTIFICATIONS MODULE - MATCHES STAFF.HTML FIREBASE INTEGRATION
            // ========================================================================================
            class NotificationManager {
                constructor() {
                    this.notifications = [];
                    this.settings = this.loadSettings();
                    this.initializeNotifications();
                }

                async loadNotifications() {
                    try {
                        // Load from Firebase using the same path as staff.html
                        if (window.authManager && window.authManager.currentUser) {
                            const notifications = await window.authManager.loadNotifications();
                            this.notifications = notifications;
                            return notifications;
                        } else {
                            console.warn('No authenticated user for loading notifications');
                            return [];
                        }
                    } catch (error) {
                        console.error('Error loading notifications from Firebase:', error);
                        // Fallback to localStorage for compatibility
                        try {
                            const stored = localStorage.getItem('notifications');
                            return stored ? JSON.parse(stored) : [];
                        } catch {
                            return [];
                        }
                    }
                }

                loadSettings() {
                    const detailContent = `
                        <div class="position-details-flat">
                            <h3 class="position-title"><i class="fas fa-briefcase"></i> ${position.jobTitle || 'N/A'}</h3>
                            <div class="detail-meta-row">
                                <span class="position-code">${formattedPositionCode}</span>
                                <span class="department-tag">${position.department || 'N/A'}</span>
                                <span class="status-badge badge-${(position.status || '').toLowerCase()}">${formatStatus(position.status) || 'N/A'}</span>
                            </div>
                            <div class="flat-section-heading"><i class="fas fa-id-badge"></i> Employment details</div>
                            <div class="detail-item employment-details-group">
                                <div class="field-row"><span class="detail-label">Employment type</span><span class="detail-value">${formatEmploymentType(position.employmentType || position.employment_type || position.type) || 'N/A'}</span></div>
                                <div class="field-row"><span class="detail-label">Working hours/week</span><span class="detail-value">${position.workingHours || 'N/A'}</span></div>
                                <div class="field-row"><span class="detail-label">Work location</span><span class="detail-value">${position.workLocation || position.location || 'N/A'}</span></div>
                                <div class="field-row"><span class="detail-label">Line manager</span><span class="detail-value">${formatLineManagerName(position.lineManager) || 'N/A'}</span></div>
                            </div>
                            <div class="flat-section-heading"><i class="fas fa-calendar-alt"></i> Timeline & dates</div>
                            <div class="detail-item timeline-group">
                                <div class="field-row"><span class="detail-label">Start date</span><span class="detail-value">${formatDate(position.startDate) || 'N/A'}</span></div>
                                <div class="field-row"><span class="detail-label">End date</span><span class="detail-value">${formatDate(position.endDate) || 'N/A'}</span></div>
                                <div class="field-row"><span class="detail-label">${currentActiveTab === 'published' ? 'Published date' : 'Posted date'}</span><span class="detail-value">${formatDate(currentActiveTab === 'published' ? (position.publishedDate || position.postedDate) : position.postedDate) || 'N/A'}</span></div>
                            </div>
                            <div class="flat-section-heading"><i class="fas fa-coins"></i> Compensation</div>
                            <div class="detail-item"><span class="detail-label">Salary range</span><span class="detail-value">${position.salaryMin ? '$'+Number(position.salaryMin).toLocaleString() : 'N/A'} ${position.salaryMax ? ' - $'+Number(position.salaryMax).toLocaleString() : ''}</span></div>
                            <div class="flat-section-heading"><i class="fas fa-clipboard-list"></i> Requirements</div>
                            <div class="detail-item requirements-group">
                                <div class="field-row"><span class="detail-label">Education</span><span class="detail-value">${position.requiredEducation || position.education || position.educationLevel || position.educationRequired || 'N/A'}</span></div>
                                <div class="field-row"><span class="detail-label">Experience</span><span class="detail-value">${position.requiredExperience ? position.requiredExperience + ' years' : 'N/A'}</span></div>
                            </div>
                            <div class="flat-section-heading"><i class="fas fa-users"></i> Recruitment</div>
                            <div class="detail-item recruitment-group">
                                <div class="field-row"><span class="detail-label">Urgency</span><span class="detail-value priority-${(position.urgency || position.priority || '').toLowerCase()}">${formatPriority(position.urgency || position.priority) || 'N/A'}</span></div>
                                <div class="field-row"><span class="detail-label">Reason</span><span class="detail-value">${position.recruitmentReason || position.reason || position.hiringReason || position.requestReason || 'N/A'}</span></div>
                                <div class="field-row"><span class="detail-label">Advertise</span><span class="detail-value">${(() => { if (position.advertiseOptionLabel) return position.advertiseOptionLabel; const v = (position.advertiseOption || '').toLowerCase(); if (v === 'external-internal') return 'Yes - External & Internal'; if (v === 'internal-only') return 'Yes - Internal Only'; if (v === 'no-advertise') return 'No - Do Not Advertise'; return 'N/A'; })()}</span></div>
                            </div>
                            ${position.jobDescription ? `<div class=\"flat-section-heading\">Job description</div><div class=\"detail-paragraph\">${position.jobDescription}</div>` : ''}
                            ${position.requiredSkills ? `<div class=\"flat-section-heading\">Required skills & competencies</div><div class=\"detail-paragraph\">${position.requiredSkills}</div>` : ''}
                            ${position.notes ? `<div class=\"flat-section-heading\">Additional notes</div><div class=\"detail-paragraph\">${position.notes}</div>` : ''}
                            ${position.attachments && position.attachments.length > 0 ? `<div class=\"flat-section-heading\">Attachments</div><div class=\"attachments-flat\">${position.attachments.map(a => `<div class='attachment-item'><i class='fas fa-file'></i> ${a.name || a}</div>`).join('')}</div>` : ''}
                        </div>
                    `;
                    const userId = window.authManager.currentUser.uid;
                    console.log('🔗 Setting up notification listener for user:', userId);
                    
                    const notificationsRef = firebase.database().ref(`notifications/${userId}`);
                    
                    notificationsRef.on('value', async (snapshot) => {
                        try {
                            console.log('🔄 Notification listener triggered for user:', userId);
                            
                            if (snapshot.exists()) {
                                const notificationsData = snapshot.val();
                                const notificationKeys = Object.keys(notificationsData);
                                console.log(`📨 Found ${notificationKeys.length} notifications in Firebase`);
                                
                                this.notifications = Object.values(notificationsData)
                                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                                    
                                console.log('📋 Processed notifications:', this.notifications.length);
                                if (this.notifications.length > 0) {
                                    console.log('📄 Latest notification:', this.notifications[0]);
                                }
                            } else {
                                console.log('📭 No notifications found in Firebase for user:', userId);
                                this.notifications = [];
                            }
                            
                            this.updateNotificationBadge();
                            this.renderNotifications();
                            
                            console.log('🔔 Notification badge and list updated');
                        } catch (error) {
                            console.error('❌ Error processing notification update:', error);
                        }
                    });
                    
                    console.log('✅ Real-time notification listener setup for user:', userId);
                }

                addNotification(notification) {
                    const newNotification = {
                        id: Date.now().toString(),
                        timestamp: new Date().toISOString(),
                        read: false,
                        ...notification
                    };

                    this.notifications.unshift(newNotification);
                    this.saveNotifications();
                    this.updateNotificationBadge();
                    this.renderNotifications();
                }

                updateNotificationBadge() {
                    const badge = document.querySelector('.notification-badge');
                    const unreadCount = this.notifications.filter(n => !n.read).length;
                    
                    if (badge) {
                        if (unreadCount > 0) {
                            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                            badge.style.display = 'block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }

                updateNotificationBadgeCount(notifications) {
                    if (notifications) {
                        this.notifications = notifications;
                    }
                    this.updateNotificationBadge();
                }

                saveNotifications() {
                    try {
                        // Save to localStorage for offline compatibility
                        localStorage.setItem('notifications', JSON.stringify(this.notifications));
                    } catch (error) {
                        console.error('Error saving notifications to localStorage:', error);
                    }
                }

                renderNotifications() {
                    const container = document.querySelector('.notification-list');
                    const emptyState = document.querySelector('.notification-empty');
                    
                    if (!container) return;

                    if (this.notifications.length === 0) {
                        // Show empty state
                        if (emptyState) {
                            emptyState.style.display = 'block';
                        }
                        container.innerHTML = '';
                        return;
                    }

                    // Hide empty state
                    if (emptyState) {
                        emptyState.style.display = 'none';
                    }

                    container.innerHTML = this.notifications
                        .slice(0, 10)
                        .map(notification => `
                            <div class="notification-item ${notification.read ? 'read' : 'unread'}" data-id="${notification.id}">
                                <div class="notification-content">
                                    <div class="notification-title">${notification.title || 'New Notification'}</div>
                                    <div class="notification-message">${notification.message || 'You have a new notification'}</div>
                                    <div class="notification-time">${this.formatTimeAgo(notification.timestamp)}</div>
                                </div>
                                <div class="notification-actions">
                                    ${!notification.read ? 
                                        `<button class="mark-read-btn" title="Mark as read" onclick="markNotificationAsRead('${notification.id}')">
                                            <i class="fas fa-check"></i>
                                        </button>` : 
                                        `<button class="mark-read-btn" title="Already read" disabled>
                                            <i class="fas fa-check"></i>
                                        </button>`
                                    }
                                    <button class="delete-notification-btn" title="Delete notification" onclick="deleteNotificationWithConfirm('${notification.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                ${!notification.read ? '<div class="notification-dot"></div>' : ''}
                            </div>
                        `).join('');
                }

                formatTimeAgo(timestamp) {
                    const now = new Date();
                    const time = new Date(timestamp);
                    const diffInSeconds = Math.floor((now - time) / 1000);

                    if (diffInSeconds < 60) {
                        return 'Just now';
                    } else if (diffInSeconds < 3600) {
                        const minutes = Math.floor(diffInSeconds / 60);
                        return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                    } else if (diffInSeconds < 86400) {
                        const hours = Math.floor(diffInSeconds / 3600);
                        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
                    } else if (diffInSeconds < 604800) {
                        const days = Math.floor(diffInSeconds / 86400);
                        return `${days} day${days !== 1 ? 's' : ''} ago`;
                    } else {
                        return time.toLocaleDateString();
                    }
                }

                async markAsRead(notificationId) {
                    try {
                        if (!window.authManager || !window.authManager.currentUser) {
                            console.warn('Cannot mark notification as read: no authenticated user');
                            return;
                        }

                        const userId = window.authManager.currentUser.uid;
                        const notificationRef = firebase.database().ref(`notifications/${userId}/${notificationId}`);
                        
                        // Update in Firebase
                        await notificationRef.update({ read: true });
                        
                        // Update local state
                        const notification = this.notifications.find(n => n.id === notificationId);
                        if (notification) {
                            notification.read = true;
                            this.updateNotificationBadge();
                            this.renderNotifications();
                        }
                        
                        console.log('✅ Notification marked as read:', notificationId);
                    } catch (error) {
                        console.error('Error marking notification as read:', error);
                    }
                }

                async deleteNotification(notificationId) {
                    try {
                        if (!window.authManager || !window.authManager.currentUser) {
                            console.warn('Cannot delete notification: no authenticated user');
                            return;
                        }

                        const userId = window.authManager.currentUser.uid;
                        const notificationRef = firebase.database().ref(`notifications/${userId}/${notificationId}`);
                        
                        // Delete from Firebase
                        await notificationRef.remove();
                        
                        // Update local state
                        this.notifications = this.notifications.filter(n => n.id !== notificationId);
                        this.updateNotificationBadge();
                        this.renderNotifications();
                        
                        console.log('✅ Notification deleted:', notificationId);
                    } catch (error) {
                        console.error('Error deleting notification:', error);
                    }
                }

                async markAllAsRead() {
                    try {
                        if (!window.authManager || !window.authManager.currentUser) {
                            console.warn('Cannot mark all notifications as read: no authenticated user');
                            return;
                        }

                        const userId = window.authManager.currentUser.uid;
                        const notificationsRef = firebase.database().ref(`notifications/${userId}`);
                        
                        // Get all notifications and mark as read
                        const snapshot = await notificationsRef.once('value');
                        if (snapshot.exists()) {
                            const updates = {};
                            const notificationsData = snapshot.val();
                            
                            Object.keys(notificationsData).forEach(notificationId => {
                                updates[`${notificationId}/read`] = true;
                            });
                            
                            await notificationsRef.update(updates);
                        }
                        
                        // Update local state
                        this.notifications.forEach(n => n.read = true);
                        this.updateNotificationBadge();
                        this.renderNotifications();
                        
                        console.log('✅ All notifications marked as read');
                    } catch (error) {
                        console.error('Error marking all notifications as read:', error);
                    }
                }

                async clearAll() {
                    try {
                        if (!window.authManager || !window.authManager.currentUser) {
                            console.warn('Cannot clear notifications: no authenticated user');
                            return;
                        }

                        const userId = window.authManager.currentUser.uid;
                        const notificationsRef = firebase.database().ref(`notifications/${userId}`);
                        
                        // Delete all notifications from Firebase
                        await notificationsRef.remove();
                        
                        // Update local state
                        this.notifications = [];
                        this.updateNotificationBadge();
                        this.renderNotifications();
                        
                    console.log('✅ All notifications cleared');
                } catch (error) {
                    console.error('Error clearing all notifications:', error);
                }
            }

            // Force refresh notifications from Firebase
            async forceRefresh() {
                try {
                    console.log('🔄 Force refreshing notifications from Firebase...');
                    
                    if (!window.authManager || !window.authManager.currentUser) {
                        console.warn('Cannot force refresh: no authenticated user');
                        return;
                    }

                    const userId = window.authManager.currentUser.uid;
                    const notificationsRef = firebase.database().ref(`notifications/${userId}`);
                    
                    // Force a fresh read from Firebase
                    const snapshot = await notificationsRef.once('value');
                    
                    if (snapshot.exists()) {
                        const notificationsData = snapshot.val();
                        this.notifications = Object.values(notificationsData)
                            .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        console.log(`📥 Force refresh loaded ${this.notifications.length} notifications`);
                    } else {
                        this.notifications = [];
                        console.log('📭 Force refresh found no notifications');
                    }
                    
                    this.updateNotificationBadge();
                    this.renderNotifications();
                    
                    console.log('✅ Force refresh completed');
                } catch (error) {
                    console.error('❌ Error during force refresh:', error);
                }
            }
        }            // ========================================================================================
            // EMBEDDED RECRUITMENT APPROVAL FLOW MODULE
            // ========================================================================================
            async function getApprovalStatus(level, levelNumber, isSequential, previousLevelStatus) {
                // Base statuses
                if (level.status === 'rejected') {
                    return 'rejected';
                }
                if (level.isCompleted || level.status === 'completed' || level.status === 'approved') {
                    return 'approved';
                }
                if (level.status === 'pending') {
                    return 'pending';
                }
                // Sequential flow specific logic
                if (isSequential && levelNumber > 1 && !previousLevelStatus?.isCompleted) {
                    return 'locked';
                }
                return 'waiting';
            }

            // Main recruitment approval flow function
            window.fetchRecruitmentApprovalFlow = async function fetchRecruitmentApprovalFlow(recruitmentRequestId) {
                console.log(`🚀 fetchRecruitmentApprovalFlow called with ID: ${recruitmentRequestId}`);
                
                try {
                    // Get current company ID for company-scoped approval flows
                    const getCurrentCompanyId = () => {
                        if (window.companyDataService && typeof window.companyDataService.getCurrentCompanyId === 'function') {
                            return window.companyDataService.getCurrentCompanyId();
                        }
                        
                        const localStorageId = localStorage.getItem('currentCompanyId');
                        const sessionStorageId = sessionStorage.getItem('currentCompanyId');
                        return localStorageId || sessionStorageId;
                    };

                    const companyId = getCurrentCompanyId() || '-OUuYJ2TBZebiL0ciPq-';
                    
                    if (!companyId) {
                        console.error('❌ No company ID available for approval flow');
                        return { type: 'No Company Context', levels: [] };
                    }

                    // Get the approval flow configuration for recruitment from company scope
                    const flowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/recruitment`);
                    let flowSnapshot = await flowRef.once('value');
                    
                    let globalFlowSnapshot = null;
                    if (!flowSnapshot.exists()) {
                        // Fallback to global approval flow if company-specific doesn't exist
                        const globalFlowRef = firebase.database().ref('approvalFlows/recruitment');
                        globalFlowSnapshot = await globalFlowRef.once('value');
                        
                        if (!globalFlowSnapshot.exists()) {
                            // Create a mock approval flow for testing
                            return {
                                type: 'Mock Sequential Approval (Company Scope)',
                                approvalOrder: 'sequential',
                                companyId: companyId,
                                levels: [{
                                    name: 'Level 1',
                                    status: 'pending',
                                    totalApprovers: 1,
                                    approvedCount: 0,
                                    rejectedCount: 0,
                                    approvers: [{
                                        name: 'Test Manager',
                                        title: 'Department Manager',
                                        department: 'Human Resources',
                                        status: 'pending',
                                        date: null,
                                        role: 'Manager Approval',
                                        value: 'user_test123'
                                    }],
                                    comments: ''
                                }]
                            };
                        }
                    }
                    
                    const flow = (flowSnapshot.exists() ? flowSnapshot : globalFlowSnapshot).val();
                    const selectedRoles = flow.selectedRoles || {};
                    const isSequential = flow.approvalOrder === 'sequential' || flow.approvalSequence === 'sequential';

                    // Get the current approval status for this recruitment request
                    const statusRef = firebase.database().ref(`recruit/${recruitmentRequestId}/approvals`);
                    const statusSnapshot = await statusRef.once('value');
                    const approvalStatus = statusSnapshot.exists() ? statusSnapshot.val() : {};

                    // Build the levels array with approver details
                    const levels = [];
                    for (const [levelKey, roles] of Object.entries(selectedRoles)) {
                        const levelNumber = parseInt(levelKey.replace('level', ''));
                        const currentLevel = approvalStatus[levelKey] || {};
                        const previousLevel = levelNumber > 1 ? approvalStatus[`level${levelNumber - 1}`] : null;

                        const levelApprovals = currentLevel.approvals || [];
                        const totalApproversInLevel = roles.length;
                        const approvedCount = levelApprovals.filter(a => a.status === 'approved').length;
                        const rejectedCount = levelApprovals.filter(a => a.status === 'rejected').length;
                        
                        const approvers = await Promise.all(roles.map(async (role) => {
                            let approverInfo = {
                                name: 'Not assigned',
                                title: '',
                                department: '',
                                status: 'pending',
                                date: null,
                                role: '',
                                value: role.value
                            };

                            if (role.value.startsWith('user_')) {
                                const userId = role.value.replace('user_', '');
                                
                                // Try company users first, then global users
                                let userRef = firebase.database().ref(`companies/${companyId}/users/${userId}`);
                                let userSnapshot = await userRef.once('value');
                                
                                if (!userSnapshot.exists()) {
                                    userRef = firebase.database().ref(`users/${userId}`);
                                    userSnapshot = await userRef.once('value');
                                }
                                
                                if (userSnapshot.exists()) {
                                    const user = userSnapshot.val();
                                    let fullName = user.displayName || user.name || user.fullName || 
                                                  (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null) || 
                                                  user.username || 'Not assigned';
                                    
                                    // Extract name from email if still no name
                                    if ((!fullName || fullName === 'Not assigned') && user.email) {
                                        const emailParts = user.email.split('@')[0];
                                        fullName = emailParts.replace(/[._-]/g, ' ')
                                            .split(' ')
                                            .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
                                            .join(' ');
                                    }
                                    
                                    const approverAction = levelApprovals.find(a => 
                                        (role.type === 'user' && a.approverId === userId) ||
                                        (role.type === 'function' && a.approverRole === role.value)
                                    );
                                    
                                    approverInfo = {
                                        name: fullName,
                                        title: user.jobTitle || '',
                                        department: user.department || '',
                                        status: await getApprovalStatus(approverAction || {}, levelNumber, isSequential, previousLevel),
                                        date: approverAction?.approvedDateTime || 
                                             (approverAction?.approvedAt ? new Date(approverAction.approvedAt).toLocaleString() : null),
                                        comments: approverAction?.comments || '',
                                        role: role.text || role.label || 'Direct Approver',
                                        value: role.value,
                                        userId: userId,
                                        approverId: userId
                                    };
                                }
                            }
                            // Handle other role types (function_, L+, etc.)
                            
                            return approverInfo;
                        }));

                        // Determine overall level status
                        let levelStatus;
                        if (currentLevel.isCompleted) {
                            levelStatus = 'approved';
                        } else if (rejectedCount > 0) {
                            levelStatus = 'rejected';
                        } else if (isSequential && levelNumber > 1 && !approvalStatus[`level${levelNumber - 1}`]?.isCompleted) {
                            levelStatus = 'locked';
                        } else if (approvedCount > 0 && approvedCount < totalApproversInLevel) {
                            levelStatus = 'partially-approved';
                        } else {
                            levelStatus = 'pending';
                        }

                        levels.push({
                            name: `Level ${levelNumber}`,
                            status: levelStatus,
                            totalApprovers: totalApproversInLevel,
                            approvedCount: approvedCount,
                            rejectedCount: rejectedCount,
                            approvers: approvers,
                            comments: currentLevel.comments || ''
                        });
                    }
                    
                    return {
                        type: isSequential ? 'Sequential Approval (Company Scope)' : 'Parallel Approval (Company Scope)',
                        approvalOrder: isSequential ? 'sequential' : 'parallel',
                        companyId: companyId,
                        levels: levels
                    };
                } catch (error) {
                    console.error('❌ Error fetching recruitment approval flow:', error);
                    return { type: 'Error', levels: [] };
                }
            };

            // ========================================================================================
            // INITIALIZE GLOBAL SERVICES
            // ========================================================================================
            window.companyDataService = new CompanyDataService();
            window.authManager = new AuthManager();
            window.notificationManager = new NotificationManager();
            
            // Initialize notification system immediately when authentication is ready
            const initializeNotificationSystem = async () => {
                console.log('🔔 Starting notification system initialization...');
                console.log('Available objects:', {
                    authManager: !!window.authManager,
                    currentUser: !!window.authManager?.currentUser,
                    notificationManager: !!window.notificationManager,
                    firebase: !!window.firebase,
                    database: !!window.firebase?.database
                });
                
                if (window.authManager && window.authManager.currentUser && window.notificationManager) {
                    console.log('👤 Current user:', window.authManager.currentUser.email);
                    console.log('🏢 Company ID:', window.authManager.currentUser.companyId);
                    console.log('🆔 User ID:', window.authManager.currentUser.uid);
                    
                    try {
                        await window.notificationManager.initializeNotifications();
                        console.log('✅ Notification system initialized successfully');
                        
                        // Load and log current notifications for debugging
                        const notifications = await window.authManager.loadNotifications();
                        console.log(`📊 Loaded ${notifications.length} notifications from Firebase`);
                        if (notifications.length > 0) {
                            console.log('📋 Notification types:', [...new Set(notifications.map(n => n.type))]);
                            console.log('📋 Recent notifications:', notifications.slice(0, 3));
                        }
                        
                        // Mark as initialized
                        window.notificationSystemReady = true;
                        console.log('🎯 Notification system marked as ready');
                    } catch (error) {
                        console.error('❌ Error initializing notification system:', error);
                    }
                } else {
                    console.warn('⚠️ Cannot initialize notifications: missing dependencies');
                    if (!window.authManager) console.warn('  - AuthManager not found');
                    if (!window.authManager?.currentUser) console.warn('  - Current user not found');
                    if (!window.notificationManager) console.warn('  - NotificationManager not found');
                    
                    // Retry initialization after a short delay if dependencies are missing
                    setTimeout(initializeNotificationSystem, 1000);
                }
            };
            
            // Start initialization with minimal delay
            setTimeout(initializeNotificationSystem, 500);
            
            // Initialize menu visibility when page loads
            document.addEventListener('DOMContentLoaded', () => {
                // Call menu visibility immediately, no delay
                updateMenuWithFeatureAuthorization();
                
                // Add a timeout fallback to ensure menu is visible even if features don't load
                setTimeout(() => {
                    const sidebar = document.querySelector('.sidebar');
                    if (sidebar && sidebar.classList.contains('menu-loading')) {
                        console.warn('Menu still loading after 10 seconds, showing all items as fallback');
                        showAllMenuItems();
                    }
                }, 10000);
                
                // Set active menu item for recruitment board  
                setActiveMenuItem();
                
                // Initialize centralized header system with small delay
                setTimeout(() => {
                    initializeHeader();
                }, 100);
                
                // Additional header refresh after services are fully loaded
                setTimeout(() => {
                    if (typeof initializeCompanyHeader === 'function') {
                        initializeCompanyHeader();
                        console.log('🔄 Company header refreshed after full initialization');
                    }
                    
                    // Update user profile with avatar after full initialization
                    if (window.authManager?.currentUser && window.authManager?.updateUserProfile) {
                        window.authManager.updateUserProfile(window.authManager.currentUser);
                        console.log('🔄 User profile refreshed after full initialization');
                    }
                }, 1500);
            });

            // ========================================================================================
            // NAVIGATION INTEGRATION
            // ========================================================================================
            function setActiveMenuItem() {
                // Remove active class from all menu items
                document.querySelectorAll('.menu a').forEach(link => {
                    link.classList.remove('active');
                });
                
                // Set active class for recruitment board menu item
                const recruitmentMenuItem = document.querySelector('a[href*="recruitboard"]');
                if (recruitmentMenuItem) {
                    recruitmentMenuItem.classList.add('active');
                }
                
                // Also try to find by text content if href doesn't work
                if (!recruitmentMenuItem) {
                    const menuLinks = document.querySelectorAll('.menu a');
                    menuLinks.forEach(link => {
                        if (link.textContent.toLowerCase().includes('recruitment') || 
                            link.textContent.toLowerCase().includes('recruit')) {
                            link.classList.add('active');
                        }
                    });
                }
            }

            // ========================================================================================
            // CENTRALIZED HEADER INTEGRATION
            // ========================================================================================
            function initializeHeader() {
                console.log('🔧 Initializing header...');
                
                // Initialize sidebar toggle functionality
                const sidebarToggle = document.getElementById('sidebarToggle');
                console.log('🔧 Sidebar toggle element:', sidebarToggle);
                
                if (sidebarToggle) {
                    console.log('✅ Adding click event listener to sidebar toggle');
                    sidebarToggle.addEventListener('click', toggleSidebar);
                    
                    // Test if the button is clickable
                    sidebarToggle.addEventListener('click', function() {
                        console.log('🖱️ Sidebar toggle button clicked!');
                    });
                } else {
                    console.error('❌ Sidebar toggle button not found!');
                }

                // Initialize company header information
                initializeCompanyHeader();
                
                // Restore sidebar state from localStorage
                restoreSidebarState();
            }

            function toggleSidebar() {
                console.log('🔧 toggleSidebar function called');
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                console.log('🔧 Sidebar element:', sidebar);
                console.log('🔧 Main content element:', mainContent);
                
                if (sidebar && mainContent) {
                    console.log('✅ Both elements found, toggling classes...');
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                    
                    // Store sidebar state in localStorage
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    localStorage.setItem('sidebarCollapsed', isCollapsed);
                    console.log('💾 Sidebar state saved:', isCollapsed);
                } else {
                    console.error('❌ Sidebar or main content not found!');
                }
            }

            function restoreSidebarState() {
                const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                if (isCollapsed && sidebar && mainContent) {
                    sidebar.classList.add('collapsed');
                    mainContent.classList.add('sidebar-collapsed');
                }
            }

            async function initializeCompanyHeader() {
                try {
                    console.log('🏢 Initializing company header...');
                    const companyId = window.companyDataService?.getCurrentCompanyId();
                    if (!companyId) {
                        console.warn('⚠️ No company context for header');
                        return;
                    }

                    console.log('🔍 Loading company data for ID:', companyId);
                    const companyRef = firebase.database().ref(`companies/${companyId}`);
                    const snapshot = await companyRef.once('value');
                    
                    if (snapshot.exists()) {
                        const company = snapshot.val();
                        console.log('✅ Company data loaded:', {
                            name: company.companyName || company.name,
                            logoUrl: company.logoUrl || company.logo ? '✅' : '❌'
                        });
                        
                        // Get header elements
                        const headerCompanyName = document.getElementById('headerCompanyName');
                        const headerCompanyLogo = document.getElementById('headerCompanyLogo');
                        const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                        
                        console.log('🔍 Header elements found:', {
                            name: headerCompanyName ? '✅' : '❌',
                            logo: headerCompanyLogo ? '✅' : '❌',
                            placeholder: headerLogoPlaceholder ? '✅' : '❌'
                        });
                        
                        // Update company name - try both field names for compatibility
                        const companyName = company.companyName || company.name || '';
                        if (headerCompanyName && companyName) {
                            headerCompanyName.textContent = companyName;
                            console.log('✅ Company name updated:', companyName);
                        } else if (headerCompanyName) {
                            headerCompanyName.textContent = 'Unknown Company';
                            console.log('⚠️ No company name found, using fallback');
                        }
                        
                        // Update company logo - try both field names for compatibility
                        const logoUrl = company.logoUrl || company.logo;
                        if (logoUrl && headerCompanyLogo) {
                            console.log('🖼️ Setting company logo:', logoUrl);
                            headerCompanyLogo.src = logoUrl;
                            headerCompanyLogo.style.display = 'block';
                            headerCompanyLogo.classList.add('loaded', 'visible');
                            
                            // Hide placeholder when logo loads
                            if (headerLogoPlaceholder) {
                                headerLogoPlaceholder.style.display = 'none';
                                console.log('✅ Logo placeholder hidden');
                            }
                            
                            // Add error handler for logo loading
                            headerCompanyLogo.onerror = () => {
                                console.log('❌ Logo failed to load, showing placeholder');
                                headerCompanyLogo.style.display = 'none';
                                if (headerLogoPlaceholder) {
                                    headerLogoPlaceholder.style.display = 'flex';
                                }
                            };
                            
                            console.log('✅ Company logo updated');
                        } else {
                            console.log('ℹ️ No company logo available, showing placeholder');
                            // Show placeholder when no logo
                            if (headerLogoPlaceholder) {
                                headerLogoPlaceholder.style.display = 'flex';
                                console.log('✅ Logo placeholder displayed');
                            }
                            if (headerCompanyLogo) {
                                headerCompanyLogo.style.display = 'none';
                            }
                        }
                        
                        console.log('✅ Company header initialization complete');
                    } else {
                        console.warn('⚠️ No company data found for ID:', companyId);
                    }
                } catch (error) {
                    console.error('❌ Error loading company header info:', error);
                }
            }

            // Make header initialization available globally for manual refresh
            window.refreshCompanyHeader = initializeCompanyHeader;
            
            // Make user avatar refresh available globally
            window.refreshUserAvatar = () => {
                if (window.authManager?.currentUser && window.authManager?.updateUserProfile) {
                    window.authManager.updateUserProfile(window.authManager.currentUser);
                    console.log('🔄 User avatar manually refreshed');
                }
            };

            console.log('✅ Embedded modules initialized successfully');
        });
    </script>
    
    <!-- Backup Sidebar Toggle Initialization -->
    <script>
        // Backup initialization for sidebar toggle - runs independently
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 Backup sidebar toggle initialization...');
            
            // Wait a bit longer for DOM to be fully ready
            setTimeout(function() {
                const sidebarToggle = document.getElementById('sidebarToggle');
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                
                console.log('🔍 Backup check - Elements found:', {
                    toggle: sidebarToggle ? '✅' : '❌',
                    sidebar: sidebar ? '✅' : '❌',
                    mainContent: mainContent ? '✅' : '❌'
                });
                
                if (sidebarToggle) {
                    // Remove any existing listeners to avoid duplicates
                    sidebarToggle.replaceWith(sidebarToggle.cloneNode(true));
                    const newToggle = document.getElementById('sidebarToggle');
                    
                    newToggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🖱️ Backup toggle clicked!');
                        
                        const sidebarEl = document.querySelector('.sidebar');
                        const mainContentEl = document.querySelector('.main-content');
                        
                        if (sidebarEl && mainContentEl) {
                            console.log('🔄 Toggling sidebar classes...');
                            sidebarEl.classList.toggle('collapsed');
                            mainContentEl.classList.toggle('sidebar-collapsed');
                            
                            const isCollapsed = sidebarEl.classList.contains('collapsed');
                            localStorage.setItem('sidebarCollapsed', isCollapsed);
                            console.log('✅ Sidebar toggled, collapsed:', isCollapsed);
                        }
                    });
                    
                    console.log('✅ Backup sidebar toggle initialized');
                } else {
                    console.error('❌ Backup: Sidebar toggle button still not found!');
                }
            }, 2000);
        });
    </script>
    <style>
        /* Main content optimization */
        .recruitment-board-content {
            padding: 1rem; /* Reduced from 2rem */
            width: 100%;
            margin: 0;
            height: 100%; /* Use full available height */
            overflow: hidden; /* Let child elements handle scrolling */
        }

        /* Ensure proper spacing */
        .content {
            height: calc(100vh - 70px); /* Adjusted for smaller header */
            overflow-y: auto;
            margin-top: 60px; /* Reduced space for fixed header */
            padding: 0.5rem; /* Further reduced padding */
        }

        .content-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 0.55rem 0.75rem;
            border-radius: 0;
            margin: 0.35rem 0 0.5rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14);
            font-size: 0.9rem;
        }

        .content-header h1 {
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.9rem;
            margin: 0;
            font-weight: 600;
        }

        .page-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Add New Button */
        .btn-add-new {
            background: none;
            border: none;
            color: #fff;
            padding: 0.4rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn-add-new:hover {
            color: rgba(255,255,255,0.8);
            transform: scale(1.1);
        }

        .btn-add-new i {
            font-size: 1.2rem;
        }

        .action-buttons-group {
            display: flex;
            gap: 0.6rem; /* Reduced gap */
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 0.9rem; /* Reduced padding */
            border: none;
            border-radius: 6px; /* Smaller radius */
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem; /* Smaller gap */
            transition: all 0.2s ease;
            font-size: 0.8rem; /* Smaller font size */
            white-space: nowrap;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08); /* Lighter shadow */
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .recruitment-table-container {
            background: white;
            border-radius: 0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.08); /* Further reduced shadow */
            overflow: hidden;
            width: 100%;
            margin: 0;
            transition: box-shadow 0.3s ease;
            height: calc(100vh - 280px); /* Optimized height to match staff.html pattern */
            display: flex;
            flex-direction: column;
        }

        .recruitment-table-container:hover {
            box-shadow: 0 12px 32px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.12); /* Reduced hover shadow */
        }

        /* Table wrapper with scrolling */
        .table-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
            min-height: 0; /* Important for flex container */
        }

        .table-header {
            background: #f8f9fa;
            color: #495057;
            padding: 0.6rem; /* Reduced padding */
            font-weight: 600;
            font-size: 0.8rem; /* Reduced font size */
            border-bottom: 2px solid #e9ecef;
        }

        .recruitment-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem; /* Match tab navigation font size */
        }

        .recruitment-table th,
        .recruitment-table td {
            padding: 0.3rem 0.4rem; /* Further reduced padding for smaller cells */
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        .recruitment-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 0.7rem; /* Match tab navigation font size */
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            white-space: nowrap;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dynamic table header colors based on active tab */
        .tab-content.active .recruitment-table th {
            color: #ffffff;
        }

        /* Pending tab - Yellow headers */
        #pendingTabContent.active .recruitment-table th {
            background: #ffc107;
            color: #ffffff;
        }

        /* Published tab - Green headers */
        #publishedTabContent.active .recruitment-table th {
            background: #28a745;
        }

        /* Declined tab - Red headers */
        #declinedTabContent.active .recruitment-table th {
            background: #dc3545;
        }

        /* Archives tab - Blue headers */
        #archivesTabContent.active .recruitment-table th {
            background: #007bff;
        }

        .recruitment-table th:first-child {
            width: 40px;
            text-align: center;
        }

        .recruitment-table td {
            font-size: 0.7rem; /* Match tab navigation font size */
            color: #495057;
        }

        .recruitment-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .recruitment-table tbody tr {
            transition: all 0.2s ease;
        }

        /* Enhanced job title cell styling */
        .job-title-cell {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.65rem; /* Reduced from 0.8rem for consistency */
        }

        /* Position ID styling matching staff.html */
        .position-id-cell {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #495057;
            font-weight: 500;
        }

        /* Department tag styling */
        .department-tag {
            color: #495057;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Employment period styling */
        .employment-period {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            color: #495057;
            font-weight: 500;
        }

        /* Enhanced action buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            padding: 0.15rem 0.3rem; /* Further reduced padding */
            border: none;
            border-radius: 3px; /* Smaller radius */
            cursor: pointer;
            font-size: 0.6rem; /* Further reduced font */
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.15rem; /* Smaller gap */
        }

        .btn-info {
            background: #ffc107;
            color: #212529;
        }

        .btn-info:hover {
            background: #e0a800;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-edit {
            background: #ffc107;
            color: #212529;
        }

        .btn-edit:hover {
            background: #e0a800;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        /* Source badges for data source indication */
        .source-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .source-recruit {
            background: #d4edda;
            color: #155724;
        }

        .source-staff {
            background: #d1ecf1;
            color: #0c5460;
        }

        .source-published {
            background: #fff3cd;
            color: #856404;
        }

        .source-closed {
            background: #f8d7da;
            color: #721c24;
        }

        /* Row styling based on source */
        .recruit-row {
            border-left: 4px solid #28a745;
        }

        .staff-row {
            border-left: 4px solid #17a2b8;
        }

        .published-row {
            border-left: 4px solid #ffc107;
        }

        .closed-row {
            border-left: 4px solid #dc3545;
        }

        .recruit-row:hover {
            background-color: #f8fff9 !important;
        }

        .staff-row:hover {
            background-color: #f1f9ff !important;
        }

        .published-row:hover {
            background-color: #fffbf0 !important;
        }

        .closed-row:hover {
            background-color: #fdf5f5 !important;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .badge {
            padding: 0.2rem 0.5rem; /* Reduced padding */
            border-radius: 10px; /* Smaller radius */
            font-size: 0.6rem !important; /* Further reduced to match other badges */
            font-weight: 500;
            text-transform: uppercase;
        }

        /* Status badges matching staff.html design */
        .status-badge {
            padding: 0.15rem 0.3rem; /* Further reduced padding */
            border-radius: 8px; /* Smaller radius */
            font-size: 0.6rem !important; /* Further reduced font size with important */
            font-weight: 500;
            text-transform: uppercase;
        }

        .badge-active {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-approved {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-released {
            background: #d1ecf1;
            color: #0c5460;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-rejected {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-terminated {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-declined {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-archives {
            background: #e2e3e5;
            color: #6c757d;
        }

        /* Employment type badges matching staff.html */
        .employment-type-badge {
            font-size: 0.6rem !important; /* Reduced from 0.7rem to match other badges with important */
            font-weight: 500;
        }

        .badge-direct {
            color: #495057;
        }

        .badge-indirect {
            color: #495057;
        }

        .badge-contract {
            color: #495057;
        }

        .badge-temporary {
            color: #495057;
        }

        .badge-full-time {
            background: #d4edda;
            color: #155724;
        }

        .badge-part-time {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-internship {
            background: #fff3cd;
            color: #856404;
        }

        .badge-open {
            background: #d4edda;
            color: #155724;
        }

        .badge-filled {
            background: #e2e3e5;
            color: #6c757d;
        }

        /* Priority badges with subtle colors */
        .badge-urgent {
            background: #f8d7da;
            color: #721c24;
            animation: pulse 2s infinite;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-high {
            background: #fde8d0;
            color: #7a2e0e;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-medium {
            background: #fff3cd;
            color: #856404;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-low {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-active {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-published {
            background: #d1ecf1;
            color: #0c5460;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-terminated {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-declined {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-archives {
            background: #e2e3e5;
            color: #6c757d;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        /* Employment type badges matching staff.html */
        .employment-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem; /* Reduced to match other badges */
            font-weight: 500;
        }

        .badge-full-time {
            background: #28a745;
            color: white;
        }

        .badge-part-time {
            background: #17a2b8;
            color: white;
        }

        .badge-internship {
            background: #6f42c1;
            color: white;
        }

        /* Priority badges with proper colors - subtle styling */
        .badge-urgent {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-high {
            background: #fde8d0;
            color: #7a2e0e;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-medium {
            background: #fff3cd;
            color: #856404;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .badge-low {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Position Code Styling */
        .position-code {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
            font-weight: 600;
        }

        /* Salary range styling */
        .salary-range {
            font-weight: 500;
            color: #495057;
        }

        /* Loading and empty states matching staff.html */
        .loading-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .recruitment-table {
                font-size: 0.7rem; /* Match tab navigation font size on medium screens */
            }
            
            .recruitment-table th,
            .recruitment-table td {
                padding: 0.25rem 0.35rem; /* Further reduced responsive padding */
            }
        }

        @media (max-width: 768px) {
            .recruitment-board-content {
                padding: 1rem 0;
            }

            .content-header {
                margin: 0 1rem 0.3rem 1rem;
                padding: 0.5rem;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .recruitment-table-container {
                overflow-x: auto;
                margin: 0 -1rem;
                border-radius: 0;
            }

            .recruitment-table {
                font-size: 0.7rem; /* Match tab navigation font size on mobile screens */
                min-width: 800px;
            }

            .recruitment-table th,
            .recruitment-table td {
                padding: 0.3rem; /* Reduced padding for medium screens */
            }

            .action-buttons {
                gap: 0.2rem; /* Smaller gap */
            }

            .action-btn {
                padding: 0.2rem; /* Reduced button padding */
                font-size: 0.6rem; /* Smaller button font */
            }
        }

        @media (max-width: 480px) {
            .recruitment-table {
                font-size: 0.6rem; /* Further reduced mobile font size */
                min-width: 700px;
            }

            .recruitment-table th,
            .recruitment-table td {
                padding: 0.2rem; /* Further reduced mobile padding */
            }

            .badge,
            .status-badge {
                font-size: 0.55rem; /* Smaller mobile badges */
                padding: 0.15rem 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .content-header {
                margin: 0 0.75rem 0.3rem 0.75rem;
            }

            .recruitment-table {
                font-size: 0.7rem; /* Match tab navigation font size on small screens */
            }

            .recruitment-table th,
            .recruitment-table td {
                padding: 0.5rem;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .actions-wrapper {
                justify-content: center;
                margin-top: 0.5rem;
            }
        }

        /* Additional professional table styling */
        .job-title-cell {
            font-weight: 600;
            color: #2c3e50;
        }

        /* Position ID styling matching staff.html */
        .position-id-cell {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
        }

        /* Department tag styling */
        .department-tag {
            background: #f0f0f0;
            color: #333;
            padding: 0.2rem 0.6rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* Employment period styling */
        .employment-period {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .employment-type {
            font-size: 0.8rem;
            color: #6c757d;
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 8px;
        }

        .applications-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .count-badge {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Status badges similar to jobscreen.html */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem; /* Reduced to match other badges */
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .status-draft {
            background: #fff3cd;
            color: #856404;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .status-closed {
            background: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        .status-reviewed {
            background: #d1ecf1;
            color: #0c5460;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 500;
        }

        /* Enhanced Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(5px);
            }
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 1000px;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255,255,255,0.2);
            animation: modalSlideUp 0.4s ease-out;
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(50px) scale(0.95);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 16px 16px 0 0;
            position: relative;
            overflow: hidden;
        }

        .modal-header h5 {
            margin: 0;
            font-size: 1.4rem; /* Reduced font size */
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.6rem; /* Reduced gap */
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg) scale(1.1);
        }

        .modal-body {
            padding: 0;
            max-height: calc(95vh - 120px);
            overflow-y: auto;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .form-section {
            background: white;
            border: none;
            border-radius: 0;
            padding: 2rem;
            margin: 0;
            position: relative;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .section-title {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e9ecef;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .detail-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 6px; /* Slightly reduced radius */
            padding: 0.75rem; /* Reduced padding */
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }

        /* Removed hover lift/shadow for position details modal fields */
        .detail-item:hover {
            transform: none;
            box-shadow: none;
            background: rgba(255,255,255,0.95);
        }

        .detail-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 0.65rem; /* Reduced to match form label size */
            text-transform: none; /* Removed uppercase forcing */
            letter-spacing: 0.2px; /* Subtler spacing */
            margin-bottom: 0.4rem; /* Slightly reduced margin */
            display: flex;
            align-items: center;
            gap: 0.4rem; /* Reduced gap */
        }

        .detail-value {
            color: #1a1a1a;
            font-size: 0.75rem; /* Reduced to match form input size */
            font-weight: 500;
            line-height: 1.3; /* Slightly reduced line height */
            word-break: break-word;
        }

        /* Enhanced badge styles */
        .source-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .source-recruit {
            background: #d4edda;
            color: #155724;
        }

        .source-staff {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Enhanced position code styling */
        .position-code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #495057;
            font-weight: 600;
            letter-spacing: 1px;
            text-align: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            box-shadow: 0 2px 5px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
        }

        .btn-success {
            background-color: #10b981;
            color: white;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .btn-warning {
            background-color: #f59e0b;
            color: white;
            box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        /* Tab Layout Styles */
        .content-tabs {
            margin: 0;
            width: 100%;
            box-shadow: 0 32px 96px rgba(0,0,0,0.35), 0 20px 48px rgba(0,0,0,0.25), 0 10px 24px rgba(0,0,0,0.18);
            border-radius: 0;
            transition: box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .content-tabs:hover {
            box-shadow: 0 40px 120px rgba(0,0,0,0.42), 0 26px 60px rgba(0,0,0,0.32), 0 14px 32px rgba(0,0,0,0.22);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            margin: 0 0 1rem 0;
            background: white;
            padding: 0.5rem;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .tab-nav-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 0;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #6c757d;
            flex: 1;
            justify-content: center;
        }

        .tab-nav-btn:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .tab-nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        /* Specific tab colors matching table headers */
        .tab-nav-btn#pendingTabBtn.active {
            background: #ffc107;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .tab-nav-btn#publishedTabBtn.active {
            background: #28a745;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .tab-nav-btn#declinedTabBtn.active {
            background: #dc3545;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .tab-nav-btn#archivesTabBtn.active {
            background: #007bff;
            color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .tab-content {
            background: white;
            border-radius: 0;
            box-shadow: 0 12px 36px rgba(0,0,0,0.15), 0 6px 18px rgba(0,0,0,0.10), 0 3px 9px rgba(0,0,0,0.08);
            padding: 1rem 1.5rem; /* Reduced top/bottom padding */
            display: none;
            transition: box-shadow 0.3s ease;
        }

        .tab-content:hover {
            box-shadow: 0 16px 48px rgba(0,0,0,0.18), 0 8px 24px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.10);
        }

        .tab-content.active {
            display: block;
        }

        .tab-controls {
            margin-bottom: 1.5rem;
        }

        .search-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .controls-section {
            margin-bottom: 1rem; /* Reduced margin */
            margin-top: 0.3rem; /* Minimal top margin for filter fields */
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 0.6rem; /* Reduced gap */
            margin-bottom: 0.4rem; /* Further reduced margin */
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.2rem; /* Further reduced gap */
        }

        .filter-select, .search-input {
            padding: 0.4rem; /* Reduced padding */
            border: 1px solid #ced4da;
            border-radius: 6px; /* Smaller radius */
            font-size: 0.75rem; /* Reduced font size */
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .filter-select:focus, .search-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            padding-left: 2.5rem;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            pointer-events: none;
        }

        .actions-wrapper {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* Delete icon styling to match staff.html */
        .actions-wrapper .bulk-actions i.fa-trash { 
            color: #e74c3c !important; 
        }

        .view-toggles {
            display: flex;
            gap: 0.5rem;
        }

        /* Dropdown Filter Styles */
        .dropdown-filter {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropdown-filter-btn {
            width: 100%;
            padding: 0.4rem; /* Reduced padding */
            border: 1px solid #ced4da;
            border-radius: 6px; /* Smaller radius */
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem; /* Reduced font size */
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .dropdown-filter-btn:hover {
            border-color: #007bff;
        }

        .dropdown-filter-btn:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .dropdown-filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 6px; /* Smaller radius */
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Lighter shadow */
            z-index: 1000;
            display: none;
            margin-top: 2px;
        }

        .dropdown-filter-menu.show {
            display: block;
        }

        .dropdown-filter-item {
            padding: 0.4rem; /* Reduced padding */
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f8f9fa;
            font-size: 0.75rem; /* Reduced font size */
        }

        .dropdown-filter-item:last-child {
            border-bottom: none;
        }

        .dropdown-filter-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-filter-item.selected {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .loading-state {
            text-align: center;
            padding: 2rem; /* Reduced padding */
            color: #6c757d;
            font-size: 0.8rem; /* Added smaller font size */
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .d-none {
            display: none !important;
        }

        /* Plain icon button styles */
        .view-toggles i {
            transition: all 0.2s ease;
        }

        .view-toggles i:hover {
            transform: scale(1.2);
            opacity: 0.8;
        }

        /* Enhanced responsive design for modal */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 10px;
                border-radius: 12px;
            }
            
            .modal-header {
                padding: 1.5rem;
                border-radius: 12px 12px 0 0;
            }
            
            .modal-header h5 {
                font-size: 1.5rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal-footer {
                padding: 1.5rem;
                border-radius: 0 0 12px 12px;
            }
            
            .modal-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .modal-actions .btn {
                justify-content: center;
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                width: 100%;
                margin: 5px;
                border-radius: 8px;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 1rem;
                border-radius: 8px 8px 0 0;
            }
            
            .modal-header h5 {
                font-size: 1.2rem;
            }
            
            .form-section {
                padding: 1rem;
            }
            
            .modal-footer {
                padding: 1rem;
                border-radius: 0 0 8px 8px;
            }
        }

        /* Enhanced Modal Styles - Training Board Style */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
            border-radius: 16px;
            width: 95%;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            position: relative;
            transform: scale(0.7);
            opacity: 0;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            padding: 0.3rem 0.5rem; /* Further reduced padding */
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            top: 0;
            z-index: 2;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.03);
        }

        .modal-header h5 {
            font-size: 1rem; /* Reduced header size to match compact design */
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px; /* Slightly reduced gap */
        }

        .modal-header h5::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 40px;
            height: 3px;
            background: #3b82f6;
            border-radius: 2px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 0.3rem; /* Even further reduced padding */
            overflow-y: auto;
            max-height: calc(75vh - 100px); /* Further reduced height */
            scrollbar-width: none; /* Hide Firefox scrollbar */
            -ms-overflow-style: none; /* Hide IE scrollbar */
            position: relative;
        }

        .modal-body::-webkit-scrollbar {
            display: none; /* Hide webkit scrollbar */
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background-color: #ddd;
            border-radius: 3px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background-color: #bbb;
        }

        .form-section {
            margin-bottom: 0.3rem; /* Further reduced from 0.6rem */
            padding: 0.3rem; /* Further reduced from 0.5rem */
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 3px; /* Smaller radius */
            background: rgba(255, 255, 255, 0.95);
        }

        .section-title {
            font-size: 0.65rem; /* Further reduced from 0.75rem */
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 0.3rem; /* Further reduced from 0.5rem */
            display: flex;
            align-items: center;
            gap: 0.2rem; /* Further reduced from 0.3rem */
            padding-bottom: 0.2rem; /* Further reduced from 0.3rem */
            border-bottom: 2px solid #3b82f6;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 0.25rem; /* Further reduced from 0.4rem */
            margin-bottom: 0.25rem; /* Further reduced from 0.4rem */
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 0.3rem; /* Further reduced from 0.5rem */
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 0.2rem; /* Further reduced from 0.3rem */
            color: #495057;
            font-size: 0.6rem; /* Further reduced from 0.7rem */
        }

        .form-control {
            padding: 0.2rem; /* Even further reduced padding */
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 2px; /* Smaller radius */
            font-size: 0.55rem; /* Even smaller font size */
            background: rgba(255, 255, 255, 0.95);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        /* Global small text sizing */
        small, .small {
            font-size: 0.5rem !important; /* Further reduced from 0.6rem */
            line-height: 1.1;
        }

        /* Remove horizontal scrollbar and ensure content fits */
        body {
            overflow-x: hidden;
        }
        
        .modal-content {
            max-width: 95vw;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal {
            overflow: hidden;
        }

        /* Override button sizes for ultra-compact layout */
        .btn {
            padding: 0.2rem 0.4rem !important; /* Even smaller buttons */
            font-size: 0.6rem !important; /* Smaller text */
            border-radius: 2px !important;
        }

        .form-control:focus {
            border-color: #3b82f6;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        /* File input specific styling */
        .form-control[type="file"] {
            padding: 0.5rem;
            background-color: #f8f9fa;
            border: 2px dashed #ced4da;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-control[type="file"]:hover {
            border-color: #007bff;
            background-color: #e9ecef;
        }

        .form-control[type="file"]:focus {
            border-color: #007bff;
            background-color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* File input label styling */
        .form-group label[for="newAttachments"] {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group label[for="newAttachments"]::before {
            content: '📎';
            font-size: 1.1rem;
        }

        /* Selected files display styling */
        .selected-files {
            margin-top: 0.5rem;
        }

        .selected-files .text-success {
            color: #28a745 !important;
            font-weight: 600;
        }

        /* Attachment item styling for details modal */
        .attachment-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .attachment-item i {
            color: #6c757d;
        }

        .file-list {
            list-style: none !important;
            padding: 0.5rem !important;
            margin: 0.5rem 0 !important;
            background-color: #f8f9fa !important;
            border-radius: 6px !important;
            border: 1px solid #e9ecef !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .file-list li {
            padding: 0.3rem 0 !important;
            font-size: 0.9rem !important;
            color: #495057 !important;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-list li i {
            color: #007bff;
            width: 14px;
        }

        /* Enhanced file input hover and focus states */
        .form-control[type="file"]:hover + .selected-files {
            opacity: 0.9;
        }

        .required {
            color: #dc3545;
            font-weight: bold;
        }

        /* Read-only field styling for auto-filled recruitment form */
        .form-control[readonly],
        .form-control:disabled,
        select.form-control:disabled {
            background-color: #f8f9fa !important;
            border-color: #e9ecef !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
            opacity: 0.8;
        }

        /* Auto-fill notice styling */
        .auto-fill-notice {
            background: #d1ecf1 !important;
            color: #0c5460 !important;
            padding: 0.75rem !important;
            border-radius: 6px !important;
            margin: 1rem 2rem !important;
            border: 1px solid #bee5eb !important;
            font-size: 0.9rem !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }

        .auto-fill-notice i {
            color: #0c5460;
            font-size: 1rem;
        }

        .modal-footer {
            padding: 0.3rem 0.5rem; /* Further reduced padding */
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 0.3rem; /* Further reduced gap */
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            bottom: 0;
            z-index: 2;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
        }

        .modal-footer .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .modal-footer .btn-secondary {
            background-color: #6b7280;
            color: white;
            box-shadow: 0 2px 5px rgba(107, 114, 128, 0.3);
        }

        .modal-footer .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
        }

        .modal-footer .btn-warning {
            background-color: #f59e0b;
            color: white;
            box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3);
        }

        .modal-footer .btn-warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }

        .modal-footer .btn-success {
            background-color: #10b981;
            color: white;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
        }

        .modal-footer .btn-success:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .modal-footer .btn-primary {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        .modal-footer .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .modal-footer .btn-danger {
            background-color: #ef4444;
            color: white;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
        }

        .modal-footer .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .top-nav {
                position: fixed;
                top: 0.25rem;
                left: 0.25rem;
                right: 0.25rem;
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            .top-nav-left .company-name-header {
                display: none;
            }
            
            .top-nav-right {
                gap: 1rem;
            }
            
            .content {
                margin-top: 7rem; /* Increased from 5.5rem to ensure proper spacing on tablets */
            }
            
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .top-nav {
                padding: 0.5rem;
            }
            
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .top-nav-right {
                gap: 0.75rem;
            }
            
            .content {
                margin-top: 6rem; /* Increased from 5rem to ensure proper clearance on mobile */
            }
            
            .profile-btn img {
                width: 40px;
                height: 40px;
            }
            
            .action-buttons-group {
                flex-direction: column;
            }
        }

        /* Approval Flow Container */
        .approval-flow-container {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .approval-type {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
            color: #495057;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .approval-type i {
            color: #6c757d;
        }

        .approval-levels {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .approval-level {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 250px;
            max-width: calc(33.33% - 10px);
        }

        .approval-level:hover {
            border-color: #007bff;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
        }

        .approval-level.completed,
        .approval-level.approved {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f8fff9, #d4edda);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
        }

        .approval-level.pending {
            border-left: 4px solid #ffc107;
        }

        .approval-level.rejected {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }

        .approval-level.locked {
            opacity: 0.7;
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            position: relative;
        }

        .approval-level.locked::before {
            content: "🔒";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            opacity: 0.6;
        }

        .approval-level.locked .level-header {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-color: #6c757d;
            color: #6c757d;
        }

        .approval-level.locked .approver-details {
            opacity: 0.6;
            pointer-events: none;
        }

        .approver-details.level-locked {
            opacity: 0.5;
            background: #f8f9fa;
            border: 1px dashed #dee2e6;
            cursor: not-allowed;
        }

        .approver-details.level-locked .approver-avatar {
            background: #e9ecef;
            color: #6c757d;
        }

        /* Enhanced level header styling for completed levels */
        .approval-level.completed .level-header,
        .approval-level.approved .level-header {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
            color: #155724;
            border-bottom: 2px solid #28a745;
            border-radius: 6px 6px 0 0;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
        }

        .level-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .level-status {
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-width: 100px;
        }

        .level-status.completed,
        .level-status.approved {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #28a745;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
        }

        .level-status.pending {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 1px solid #ffc107;
            box-shadow: 0 2px 4px rgba(255, 193, 7, 0.2);
        }

        .level-status.rejected {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #dc3545;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
        }

        .level-status.locked {
            background: linear-gradient(135deg, #e2e3e5, #ced4da);
            color: #6c757d;
            border: 1px solid #adb5bd;
            box-shadow: 0 2px 4px rgba(108, 117, 125, 0.2);
        }

        .approvers-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .approver-details {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #e9ecef;
        }

        .approver-details.clickable:hover {
            transform: translateY(-1px);
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-color: #007bff;
            cursor: pointer;
        }

        .approver-details.not-clickable {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .approver-details.not-clickable:hover {
            transform: none;
            box-shadow: none;
            border-color: #e9ecef;
        }

        .approver-avatar.current-user {
            border: 2px solid #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.3);
        }

        .approver-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: #495057;
        }

        .approver-info {
            flex: 1;
        }

        .approver-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .approver-role-context {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .approval-info {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
        }

        .approval-info i.fa-check-circle {
            color: #28a745;
        }

        .approval-info i.fa-times-circle {
            color: #dc3545;
        }

        .approval-date {
            color: #6c757d;
        }

        .no-approver {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 1rem;
        }

        /* Authorization info message styling */
        .approval-info-message {
            border-radius: 6px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
        }

        .approval-info-message i {
            margin-right: 0.5rem;
            flex-shrink: 0;
        }

        .approval-info-message.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .approval-info-message.info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
        }

        .approval-level-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.25rem;
        }

        /* Approval Flow Type Styling */
        .flow-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .flow-type-sequential {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        .flow-type-parallel {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #6a1b9a;
            border: 1px solid #ce93d8;
        }

        .flow-type-mixed {
            background: linear-gradient(135deg, #fff3e0, #ffcc02);
            color: #e65100;
            border: 1px solid #ffb74d;
        }

        .flow-type-none {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            color: #616161;
            border: 1px solid #bdbdbd;
        }
    </style>
    <!-- GitHub Pages Fix Script -->
    <!-- All external JavaScript dependencies have been embedded above for self-contained deployment -->
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3><i class="fas fa-bell" style="margin-right: 6px; color: #3498db;"></i>Notifications</h3>
                                <div>
                                    <button class="mark-all-read">Mark all as read</button>
                                    <button class="clear-all-notifications">Clear all</button>
                                </div>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <!-- Empty state -->
                                <div class="notification-empty" id="notificationEmpty">
                                    <i class="fas fa-bell-slash"></i>
                                    <div class="notification-empty-title">No notifications</div>
                                    <div class="notification-empty-message">You're all caught up!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiMzNDk4ZGIiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSI+CjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8Y2lyY2xlIGN4PSIxMiIgY3k9IjciIHI9IjQiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo8L3N2Zz4K" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                                <li><a href="profile.html"><i class="fas fa-user"></i> My Profile</a></li>
                                <li><a href="#" onclick="window.authManager?.logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">                <div class="content-header">
                    <div style="display: flex; align-items: center; gap: 0.6rem;">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Recruitment Board</span>
                    </div>
                    <div class="page-actions">
                        <button type="button" class="btn-add-new" onclick="openNewRecruitmentModal()" title="Add New Recruitment Request">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- Content Tabs Layout -->
                <div class="content-tabs">
                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <button class="tab-nav-btn" id="pendingTabBtn" onclick="switchToTab('pending')">
                            <i class="fas fa-clock"></i>
                            Pending
                        </button>
                        <button class="tab-nav-btn" id="publishedTabBtn" onclick="switchToTab('published')">
                            <i class="fas fa-check-circle"></i>
                            Published
                        </button>
                        <button class="tab-nav-btn" id="declinedTabBtn" onclick="switchToTab('declined')">
                            <i class="fas fa-times-circle"></i>
                            Declined
                        </button>
                        <button class="tab-nav-btn" id="archivesTabBtn" onclick="switchToTab('archives')">
                            <i class="fas fa-archive"></i>
                            Archives
                        </button>
                        <button class="tab-nav-btn" id="settingsTabBtn" onclick="switchToTab('settings')" title="Recruitment Access Settings">
                            <i class="fas fa-sliders-h"></i>
                            Settings
                        </button>
                    </div>

                    <!-- Pending Tab Content -->
                    <div class="tab-content active" id="pendingTabContent">
                        <!-- Search and Filter Controls -->
                        <div class="controls-section">
                            <div class="controls-grid">
                                <div class="filter-group">
                                    <div class="dropdown-filter">
                                        <button class="dropdown-filter-btn" id="filterDropdownBtn" onclick="toggleFilterDropdown()">
                                            <span id="filterDropdownText">Select Filter</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div class="dropdown-filter-menu" id="filterDropdownMenu">
                                            <div class="dropdown-filter-item" onclick="selectFilter('none')">
                                                <span>No Filter</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectFilter('jobTitle')">
                                                <span>Job Title</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectFilter('department')">
                                                <span>Department</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectFilter('employmentType')">
                                                <span>Employment Type</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectFilter('priority')">
                                                <span>Priority</span>
                                            </div>
                                        </div>
                                    </div>
                                    <select class="filter-select" id="filterValueSelect" style="display: none;" onchange="applyFilters()">
                                        <option value="">All</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <div class="actions-wrapper">
                                        <div class="bulk-actions">
                                            <i class="fas fa-download" onclick="exportSelected()" title="Export Selected" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                            <i class="fas fa-trash" onclick="deleteSelected()" title="Delete Selected" style="cursor: pointer; font-size: 0.9rem; color: #e74c3c;"></i>
                                        </div>
                                        <div class="view-toggles">
                                            <i class="fas fa-file-excel" onclick="exportData()" title="Export All Data" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recruitment Table -->
                        <div class="recruitment-table-container">
                            <!-- Loading State -->
                            <div class="loading-state" id="pendingLoadingState" style="display: none;">
                                <div class="spinner"></div>
                                <p>Loading pending positions...</p>
                            </div>

                            <!-- Recruitment Table -->
                            <div class="table-wrapper">
                                <table class="recruitment-table" id="recruitmentTable">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                            </th>
                                            <th>Job Title</th>
                                            <th>Department</th>
                                            <th>Employment Type</th>
                                            <th>Salary Range</th>
                                            <th>Priority</th>
                                            <th>Status</th>
                                            <th>Posted Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recruitmentTableBody">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab Content -->
                    <div class="tab-content" id="settingsTabContent" style="display:none;">
                        <div class="content-header" style="margin-bottom:1rem; display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; align-items:center; gap:.6rem;">
                                <i class="fas fa-sliders-h"></i>
                                <h2 style="margin:0; font-size:1.2rem; font-weight:600;">Recruitment Access Control</h2>
                            </div>
                            <div>
                                <button class="btn btn-primary" id="saveRecruitmentAccessBtn" onclick="saveRecruitmentAccessSettings()" style="font-size:.75rem; padding:.5rem .9rem;">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </div>
                        </div>
                        <div class="settings-description" style="background:#f8fafc; border:1px solid #e2e8f0; padding:12px 16px; border-radius:8px; font-size:.75rem; color:#475569; margin-bottom:1rem;">
                            Default permissions applied to all users unless a specific user override is defined in the Recruitment Access Control table below.
                        </div>
                        <!-- Approval Configuration (collapsible, with table and modal) -->
                        <div id="approvalConfigCard" class="access-role-card collapsible-card" style="background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:0; box-shadow:0 1px 2px rgba(0,0,0,.04); margin-bottom:1rem;">
                            <div class="collapsible-header" style="padding:14px 16px; display:flex; justify-content:space-between; align-items:center; gap:.5rem; cursor:pointer;">
                                <div style="display:flex; align-items:center; gap:.5rem;">
                                    <i class="fas fa-user-check" style="color:#64748b;"></i>
                                    <h3 style="font-size:.9rem; margin:0; font-weight:600; color:#334155;">Approval Configuration</h3>
                                    <span class="role-badge" style="background:#06b6d4; color:#fff; font-size:.6rem; padding:2px 6px; border-radius:10px;">ATR</span>
                                </div>
                                <div style="display:flex;gap:.5rem;align-items:center;">
                                    <button type="button" class="btn btn-secondary" id="approvalWrapBtn" style="font-size:.6rem; padding:.3rem .55rem; display:inline-flex; align-items:center; gap:6px;">
                                        <i class="fas fa-chevron-up" aria-hidden="true"></i>
                                        <span class="wrap-label">Wrap</span>
                                    </button>
                                    <button type="button" class="btn btn-primary" title="Add approvers" onclick="openApprovalApproverModal()" style="font-size:.65rem;padding:.4rem .65rem;display:inline-flex;align-items:center;gap:4px;">
                                        <i class="fas fa-plus"></i>
                                        Configure
                                    </button>
                                </div>
                            </div>
                            <div class="collapsible-body" style="display:block; padding:12px 16px; border-top:1px solid #e2e8f0;">
                                <div style="font-size:.75rem;color:#475569;margin-bottom:.5rem;">Users allowed to approve in the position details modal. If empty, anyone with the Approve permission can approve.</div>
                                <div class="table-wrapper" style="padding:.5rem 0;">
                                    <table class="users-table" id="approvalConfigTable" style="font-size:.65rem;width:100%;">
                                        <thead>
                                            <tr>
                                                <th style="width:220px;">User</th>
                                                <th>Email</th>
                                                <th style="white-space:nowrap;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="approvalConfigTableBody"></tbody>
                                    </table>
                                    <div id="approvalConfigEmpty" style="display:none;text-align:center;color:#64748b;padding:.75rem;font-size:.65rem;">No approvers configured. All users with approval permission can approve.</div>
                                </div>
                            </div>
                        </div>
                        <div class="access-control-grid" style="display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr));">
                            <div id="defaultAccessCard" class="access-role-card collapsible-card collapsed" data-role="default" style="background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:0; box-shadow:0 1px 2px rgba(0,0,0,.04);">
                                <div class="collapsible-header" style="padding:14px 16px; display:flex; justify-content:space-between; align-items:center; gap:.5rem; cursor:pointer;">
                                    <div style="display:flex; align-items:center; gap:.5rem;">
                                        <i class="fas fa-user-shield" style="color:#64748b;"></i>
                                        <h3 style="font-size:.9rem; margin:0; font-weight:600; color:#334155;">Default</h3>
                                        <span class="role-badge" style="background:#6366f1; color:#fff; font-size:.6rem; padding:2px 6px; border-radius:10px;">Global</span>
                                    </div>
                                    <button type="button" id="defaultWrapBtn" class="btn btn-secondary" style="font-size:.6rem; padding:.3rem .55rem; display:inline-flex; align-items:center; gap:6px;">
                                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                                        <span class="wrap-label">Unwrap</span>
                                    </button>
                                </div>
                                <div class="collapsible-summary" id="defaultPermSummary" style="display:none; padding:0 16px 12px 16px; border-top:1px solid #e2e8f0;">
                                    <!-- Summary chips rendered by JS -->
                                </div>
                                <div class="collapsible-body" style="display:block; padding:12px 16px; border-top:1px solid #e2e8f0;">
                                    <div class="perm-group" style="display:grid; gap:6px; font-size:.65rem;">
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="view" checked> View Board</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="create"> Create Authority to Recruit</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="approve"> Approve Position</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="decline"> Decline Position</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="fill"> Fill Position</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="edit"> Edit Request</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="delete"> Delete Request</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="export"> Export Data</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="select"> Allow Selection (Tick Boxes)</label>
                                        <div style="height:1px; background:#e2e8f0; margin:4px 0;"></div>
                                        <div style="font-size:.58rem; font-weight:600; text-transform:uppercase; letter-spacing:.05em; color:#64748b;">Tab Visibility</div>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="showPending" checked> Show Pending Tab</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="showPublished" checked> Show Published Tab</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="showDeclined" checked> Show Declined Tab</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="showArchives" checked> Show Archives Tab</label>
                                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" data-perm="showSettings" checked> Show Settings Tab</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                                                <!-- Recruitment Access Control Table (Fleet-style) -->
                                                <div class="card" id="recruitAccessControlCard" style="margin-top:1.75rem;">
                                                    <div class="card-header" style="display:flex;align-items:center;gap:.75rem;">
                                                        <h3 class="card-title" style="flex:1;display:flex;align-items:center;gap:.5rem;font-size:.9rem;">
                                                            <i class="fas fa-user-shield"></i>
                                                            Recruitment Access Control
                                                        </h3>
                                                        <button type="button" class="btn btn-primary" title="Add user permissions" onclick="openUserOverrideModal()" style="font-size:.65rem;padding:.4rem .65rem;display:inline-flex;align-items:center;gap:4px;">
                                                            <i class="fas fa-plus"></i>
                                                            Add
                                                        </button>
                                                    </div>
                                                    <div class="card-body" style="padding:0;">
                                                        <div class="table-wrapper" style="padding:1rem;">
                                                            <table class="users-table" id="recruitAccessControlTable" style="font-size:.65rem;width:100%;">
                                                                <thead>
                                                                    <tr>
                                                                        <th style="width:220px;">User</th>
                                                                        <th>Email</th>
                                                                        <th>Job Title</th>
                                                                        <th style="white-space:nowrap;">Permissions</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody id="recruitAccessControlTableBody"></tbody>
                                                            </table>
                                                            <div id="recruitAccessControlEmpty" style="display:none;text-align:center;color:#64748b;padding:.75rem;font-size:.65rem;">No recruitment access control users added yet.</div>
                                                        </div>
                                                    </div>
                                                </div>
                        <div style="margin-top:1.25rem; font-size:.65rem; color:#64748b;">
                            Changes take effect immediately after saving. Action buttons and tabs will be conditionally hidden or disabled based on these settings.
                        </div>
                    </div>

                    <!-- Published Tab Content -->
                    <div class="tab-content" id="publishedTabContent">
                        <!-- Search and Filter Controls -->
                        <div class="controls-section">
                            <div class="controls-grid">
                                <div class="filter-group">
                                    <div class="dropdown-filter">
                                        <button class="dropdown-filter-btn" id="publishedFilterDropdownBtn" onclick="togglePublishedFilterDropdown()">
                                            <span id="publishedFilterDropdownText">Select Filter</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div class="dropdown-filter-menu" id="publishedFilterDropdownMenu">
                                            <div class="dropdown-filter-item" onclick="selectPublishedFilter('none')">
                                                <span>No Filter</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectPublishedFilter('jobTitle')">
                                                <span>Job Title</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectPublishedFilter('department')">
                                                <span>Department</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectPublishedFilter('employmentType')">
                                                <span>Employment Type</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectPublishedFilter('priority')">
                                                <span>Priority</span>
                                            </div>
                                        </div>
                                    </div>
                                    <select class="filter-select" id="publishedFilterValueSelect" style="display: none;" onchange="applyPublishedFilters()">
                                        <option value="">All</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <div class="actions-wrapper">
                                        <div class="bulk-actions">
                                            <i class="fas fa-download" onclick="exportPublishedSelected()" title="Export Selected" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                            <i class="fas fa-archive" onclick="archivePublishedSelected()" title="Archive Selected" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                        </div>
                                        <div class="view-toggles">
                                            <i class="fas fa-file-excel" onclick="exportPublishedData()" title="Export All Data" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                            <i class="fas fa-sync" onclick="refreshPublishedData()" title="Refresh Data" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Published Table -->
                        <div class="recruitment-table-container">
                            <!-- Loading State -->
                            <div class="loading-state" id="publishedLoadingState" style="display: none;">
                                <div class="spinner"></div>
                                <p>Loading published positions...</p>
                            </div>

                            <!-- Published Table -->
                            <div class="table-wrapper">
                                <table class="recruitment-table" id="publishedTable">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAllPublishedCheckbox" onchange="toggleSelectAllPublished()">
                                            </th>
                                            <th>Job Title</th>
                                            <th>Department</th>
                                            <th>Employment Type</th>
                                            <th>Salary Range</th>
                                            <th>Priority</th>
                                            <th>Status</th>
                                            <th>Published Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="publishedTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Declined Tab Content -->
                    <div class="tab-content" id="declinedTabContent">
                        <!-- Search and Filter Controls -->
                        <div class="controls-section">
                            <div class="controls-grid">
                                <div class="filter-group">
                                    <div class="dropdown-filter">
                                        <button class="dropdown-filter-btn" id="declinedFilterDropdownBtn" onclick="toggleDeclinedFilterDropdown()">
                                            <span id="declinedFilterDropdownText">Select Filter</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div class="dropdown-filter-menu" id="declinedFilterDropdownMenu">
                                            <div class="dropdown-filter-item" onclick="selectDeclinedFilter('none')">
                                                <span>No Filter</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectDeclinedFilter('jobTitle')">
                                                <span>Job Title</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectDeclinedFilter('department')">
                                                <span>Department</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectDeclinedFilter('employmentType')">
                                                <span>Employment Type</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectDeclinedFilter('priority')">
                                                <span>Priority</span>
                                            </div>
                                        </div>
                                    </div>
                                    <select class="filter-select" id="declinedFilterValueSelect" style="display: none;" onchange="applyDeclinedFilters()">
                                        <option value="">All</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <div class="actions-wrapper">
                                        <div class="bulk-actions">
                                            <i class="fas fa-download" onclick="exportDeclinedSelected()" title="Export Selected" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                            <i class="fas fa-archive" onclick="archiveDeclinedSelected()" title="Archive Selected" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                        </div>
                                        <div class="view-toggles">
                                            <i class="fas fa-file-excel" onclick="exportDeclinedData()" title="Export All Data" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                            <i class="fas fa-sync" onclick="refreshDeclinedData()" title="Refresh Data" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Declined Table -->
                        <div class="recruitment-table-container">
                            <!-- Loading State -->
                            <div class="loading-state" id="declinedLoadingState" style="display: none;">
                                <div class="spinner"></div>
                                <p>Loading declined positions...</p>
                            </div>

                            <!-- Declined Table -->
                            <div class="table-wrapper">
                                <table class="recruitment-table" id="declinedTable">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAllDeclinedCheckbox" onchange="toggleSelectAllDeclined()">
                                            </th>
                                            <th>Job Title</th>
                                            <th>Department</th>
                                            <th>Employment Type</th>
                                            <th>Salary Range</th>
                                            <th>Priority</th>
                                            <th>Status</th>
                                            <th>Declined Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="declinedTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Archives Tab Content -->
                    <div class="tab-content" id="archivesTabContent">
                        <!-- Search and Filter Controls -->
                        <div class="controls-section">
                            <div class="controls-grid">
                                <div class="filter-group">
                                    <div class="dropdown-filter">
                                        <button class="dropdown-filter-btn" id="archivesFilterDropdownBtn" onclick="toggleArchivesFilterDropdown()">
                                            <span id="archivesFilterDropdownText">Select Filter</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div class="dropdown-filter-menu" id="archivesFilterDropdownMenu">
                                            <div class="dropdown-filter-item" onclick="selectArchivesFilter('none')">
                                                <span>No Filter</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectArchivesFilter('jobTitle')">
                                                <span>Job Title</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectArchivesFilter('department')">
                                                <span>Department</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectArchivesFilter('employmentType')">
                                                <span>Employment Type</span>
                                            </div>
                                            <div class="dropdown-filter-item" onclick="selectArchivesFilter('priority')">
                                                <span>Priority</span>
                                            </div>
                                        </div>
                                    </div>
                                    <select class="filter-select" id="archivesFilterValueSelect" style="display: none;" onchange="applyArchivesFilters()">
                                        <option value="">All</option>
                                    </select>
                                </div>

                                <div class="filter-group">
                                    <div class="actions-wrapper">
                                        <div class="bulk-actions">
                                            <i class="fas fa-download" onclick="exportArchivesSelected()" title="Export Selected" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                            <i class="fas fa-undo" onclick="restoreArchivesSelected()" title="Restore Selected" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                        </div>
                                        <div class="view-toggles">
                                            <i class="fas fa-file-excel" onclick="exportArchivedData()" title="Export All Data" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                            <i class="fas fa-sync" onclick="refreshArchivesData()" title="Refresh Data" style="cursor: pointer; font-size: 0.9rem; color: #6c757d;"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Archives Table -->
                        <div class="recruitment-table-container">
                            <!-- Loading State -->
                            <div class="loading-state" id="archiveLoadingState" style="display: none;">
                                <div class="spinner"></div>
                                <p>Loading archived positions...</p>
                            </div>

                            <!-- Archives Table -->
                            <div class="table-wrapper">
                                <table class="recruitment-table" id="archiveTable">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="selectAllArchivesCheckbox" onchange="toggleSelectAllArchives()">
                                            </th>
                                            <th>Job Title</th>
                                            <th>Department</th>
                                            <th>Employment Type</th>
                                            <th>Salary Range</th>
                                            <th>Priority</th>
                                            <th>Status</th>
                                            <th>Archived Date</th>
                                        </tr>
                                    </thead>
                                    <tbody id="archiveTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    </div>

                </div>
            </div>
        </main>
    </div>            <!-- View Details Modal -->
    <div class="modal" id="viewDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-users"></i> Position Details</h5>
                <button class="close-btn" onclick="closeViewModal()">&times;</button>
            </div>
            <div class="modal-body" id="viewDetailsContent">
                <!-- Details will be populated here -->
            </div>
            <div class="modal-footer">
                <div id="modalActionButtons" class="action-buttons-group">
                    <!-- Action buttons will be dynamically added here based on position source and status -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="closeViewModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    <style>
        /* Enhanced Position Details Modal Styling */
        #viewDetailsModal .modal-content {
            max-width: 920px;
            width: 100%;
        }

        /* Position Details Layout */
        .position-details-layout {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
        /* Flat layout overrides */
        .position-details-flat {display:flex; flex-direction:column; gap:.4rem;}
        .position-details-flat .position-title {font-size:1rem; font-weight:600; margin:0 0 .35rem; display:flex; align-items:center; gap:.45rem;}
        .detail-meta-row {display:flex; flex-wrap:wrap; gap:.5rem; margin:0 0 .65rem; align-items:center;}
        .flat-section-heading {margin:.9rem 0 .35rem; font-weight:600; font-size:.72rem; letter-spacing:.4px; color:#495057; position:relative; padding-left:.6rem; display:flex; align-items:center; gap:6px;}
        .flat-section-heading:before {content:''; position:absolute; left:0; top:50%; transform:translateY(-50%); width:4px; height:70%; background:#667eea; border-radius:2px; opacity:.65;}
        .detail-paragraph {font-size:.7rem; line-height:1.4; color:#4a4f54; background:#f8f9fa; padding:.55rem .7rem; border:1px solid #e5e7eb; border-radius:4px;}
        .attachments-flat {display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:.4rem; margin-top:.25rem;}
        .attachments-flat .attachment-item {background:#f5f6f7; border:1px solid #e0e3e7; padding:.45rem .55rem; font-size:.65rem; border-radius:4px; display:flex; align-items:center; gap:.4rem;}
        .attachments-flat .attachment-item i {font-size:.7rem; color:#6c757d;}

        /* Position Header */
        .position-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.2rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .position-title-block .position-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 0.8rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .position-title i {
            font-size: 1rem;
            opacity: 0.9;
        }

        .position-meta {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .position-code {
            font-family: 'Monaco', 'Menlo', monospace;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .department-tag {
            background: rgba(255,255,255,0.25);
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: none; /* Removed uppercase */
            letter-spacing: 0.3px;
        }

        .badge-pending { background: #ffc107; color: #212529; }
        .badge-approved, .badge-published { background: #28a745; color: white; }
        .badge-declined { background: #dc3545; color: white; }
        .badge-active { background: #17a2b8; color: white; }

        /* Details Grid */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        /* Detail Cards */
        .detail-card {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }

        .detail-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .detail-card.full-width {
            grid-column: 1 / -1;
        }

        /* Card Headers */
        .card-header {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            font-size: 0.8rem;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header i {
            color: #6c757d;
            font-size: 0.75rem;
        }

        /* Card Content */
        .card-content {
            padding: 1rem;
        }

        /* Detail Items */
        .detail-item {
            display: flex;
            align-items: baseline;
            gap: 2px; /* tighter gap */
            padding: 0.3rem 0;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.75rem;
        }

        .detail-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.75rem;
            text-transform: none; /* Ensure sentence case */
            margin-right: 4px; /* subtle space before value */
            flex: 0 0 auto; /* shrink to content */
            display: inline-flex;
        }
        .detail-value {
            font-weight: 400; /* lighter than label */
            color: #60696f; /* slightly lighter gray for contrast */
            display: inline-flex;
            flex: 0 0 auto;
        }
        .employment-details-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .employment-details-group .field-row {
            display: flex;
            align-items: baseline;
            gap: 2px;
            flex-wrap: nowrap;
        }
        .timeline-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .timeline-group .field-row {
            display: flex;
            align-items: baseline;
            gap: 2px;
            flex-wrap: nowrap;
        }
        .requirements-group, .recruitment-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .requirements-group .field-row, .recruitment-group .field-row {
            display: flex;
            align-items: baseline;
            gap: 2px;
            flex-wrap: nowrap;
        }
        .detail-value {
            font-weight: 400; /* lighter than label */
            color: #60696f; /* slightly lighter gray for contrast */
        }

        .detail-value {
            color: #212529;
            flex: 1;
            text-align: right;
            font-size: 0.75rem;
            line-height: 1.3;
        }

        /* Salary Range Styling */
        .salary-range {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .salary-item {
            flex: 1;
            text-align: center;
        }

        .salary-label {
            display: block;
            font-size: 0.65rem;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 0.25rem;
            text-transform: none; /* Removed uppercase */
            letter-spacing: 0.3px;
        }

        .salary-value {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            color: #28a745;
        }

        .salary-separator {
            color: #dee2e6;
            font-weight: 300;
            font-size: 1.2rem;
        }

        /* Priority styling */
        .priority-urgent { color: #dc3545; font-weight: 600; }
        .priority-high { color: #fd7e14; font-weight: 600; }
        .priority-medium { color: #ffc107; font-weight: 600; }
        .priority-low { color: #28a745; font-weight: 600; }

        /* Content sections */
        .description-content,
        .skills-content,
        .notes-content {
            color: #495057;
            line-height: 1.5;
            font-size: 0.75rem;
        }

        /* Attachments Grid */
        .attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .attachment-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .attachment-item:hover {
            background: #e9ecef;
            cursor: pointer;
        }

        .attachment-item i {
            color: #6c757d;
            font-size: 0.75rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #viewDetailsModal .modal-content {
                max-width: 95vw;
                margin: 0.5rem;
            }

            .position-details-layout {
                gap: 0.8rem;
            }

            .position-header {
                padding: 0.8rem;
            }

            .position-title-block .position-title {
                font-size: 1rem;
            }

            .position-meta {
                gap: 0.5rem;
            }

            .details-grid {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .card-content {
                padding: 0.75rem;
            }

            .detail-item {
                display: inline-flex;
                flex-wrap: wrap;
                align-items: baseline;
                gap: 4px;
            }

            .detail-item {
                display: flex;
                align-items: baseline;
                gap: 2px;
                flex-wrap: nowrap;
            }
            .detail-label, .detail-value {
                flex: 0 0 auto;
                width: auto;
            }

            .attachments-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- New Recruitment Modal -->
    <div class="modal" id="newRecruitmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5><i class="fas fa-plus-circle"></i> Create Authority to Recruit</h5>
                <button class="close-btn" onclick="closeNewRecruitmentModal()">&times;</button>
            </div>            <div class="modal-body">
                <form id="newRecruitmentForm">
                    <!-- Position Information -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-briefcase"></i> Position Information
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newJobTitle" class="form-label" style="font-size: 0.75rem;">Job Title <span class="required">*</span></label>
                                <select class="form-control" id="newJobTitle" name="jobTitle" required>
                                    <option value="">Select Job Title</option>
                                </select>
                                <small class="text-muted" style="font-size: 0.65rem;">Select from existing approved positions</small>
                            </div>
                            <div class="form-group">
                                <label for="newPositionCode" class="form-label" style="font-size: 0.75rem;">Position Code <span class="required">*</span></label>
                                <select class="form-control" id="newPositionCode" name="positionCode" required>
                                    <option value="">Select Position Code</option>
                                </select>
                                <small class="text-muted" style="font-size: 0.65rem;">Choose from approved positions for the selected job title</small>
                            </div>
                            <div class="form-group">
                                <label for="newDepartment" class="form-label" style="font-size: 0.75rem;">Department <span class="required">*</span></label>
                                <input type="text" class="form-control" id="newDepartment" name="department" required readonly>
                                <small class="text-muted" style="font-size: 0.65rem;">Auto-filled based on job title</small>
                            </div>
                        </div>
                    </div>

                    <!-- Employment Details -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-id-card"></i> Employment Details
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newEmploymentType" class="form-label" style="font-size: 0.75rem;">Employment Type <span class="required">*</span></label>
                                <select class="form-control" id="newEmploymentType" name="employmentType" required>
                                    <option value="">Select Type</option>
                                    <option value="direct">Direct Employee</option>
                                    <option value="indirect">Indirect Employee</option>
                                    <option value="contract">Contract Worker</option>
                                    <option value="temporary">Temporary Worker</option>
                                    <option value="intern">Intern</option>
                                    <option value="consultant">Consultant</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newEmploymentStatus" class="form-label" style="font-size: 0.75rem;">Employment Status <span class="required">*</span></label>
                                <select class="form-control" id="newEmploymentStatus" name="employmentStatus" required>
                                    <option value="">Select Status</option>
                                    <option value="full-time">Full-Time</option>
                                    <option value="part-time">Part-Time</option>
                                    <option value="casual">Casual</option>
                                    <option value="seasonal">Seasonal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newWorkingHours" class="form-label">Working Hours/Week</label>
                                <input type="number" class="form-control" id="newWorkingHours" name="workingHours" min="1" max="60" placeholder="40">
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newStartDate" class="form-label">Start Date <span class="required">*</span></label>
                                <input type="date" class="form-control" id="newStartDate" name="startDate" required>
                            </div>
                            <div class="form-group">
                                <label for="newEndDate" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="newEndDate" name="endDate">
                                <small class="text-muted" style="font-size: 0.65rem;">Leave blank for permanent positions</small>
                            </div>
                            <div class="form-group">
                                <label for="newLineManager" class="form-label">Direct Line Manager <span class="required">*</span></label>
                                <input type="text" class="form-control" id="newLineManager" name="lineManager" readonly required>
                                <small class="text-muted" style="font-size: 0.65rem;">Auto-filled from existing position data</small>
                            </div>
                        </div>
                    </div>

                    <!-- Location & Compensation -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-map-marker-alt"></i> Location & Compensation
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newWorkLocation" class="form-label">Primary Work Location <span class="required">*</span></label>
                                <input type="text" class="form-control" id="newWorkLocation" name="workLocation" required readonly>
                                <small class="text-muted" style="font-size: 0.65rem;">Auto-filled from existing position data</small>
                            </div>
                            <div class="form-group">
                                <label for="newSalaryMin" class="form-label">Minimum Salary (Annual)</label>
                                <input type="number" class="form-control" id="newSalaryMin" name="salaryMin" min="0" placeholder="50000">
                            </div>
                            <div class="form-group">
                                <label for="newSalaryMax" class="form-label">Maximum Salary (Annual)</label>
                                <input type="number" class="form-control" id="newSalaryMax" name="salaryMax" min="0" placeholder="80000">
                            </div>
                        </div>
                    </div>

                    <!-- Job Description & Requirements -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-clipboard-list"></i> Job Description & Requirements
                        </div>
                        <div class="form-group">
                            <label for="newJobDescription" class="form-label">Job Description <span class="required">*</span></label>
                            <textarea class="form-control" id="newJobDescription" name="jobDescription" rows="1" required placeholder="Detailed description of role responsibilities, duties, and objectives..."></textarea>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newRequiredEducation" class="form-label">Required Education</label>
                                <select class="form-control" id="newRequiredEducation" name="requiredEducation">
                                    <option value="">Select Education Level</option>
                                    <option value="high-school">High School</option>
                                    <option value="diploma">Diploma</option>
                                    <option value="associate">Associate Degree</option>
                                    <option value="bachelor">Bachelor's Degree</option>
                                    <option value="master">Master's Degree</option>
                                    <option value="doctorate">Doctorate</option>
                                    <option value="professional">Professional Certification</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newRequiredExperience" class="form-label">Required Experience (Years)</label>
                                <input type="number" class="form-control" id="newRequiredExperience" name="requiredExperience" min="0" placeholder="3">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newRequiredSkills" class="form-label">Required Skills & Competencies</label>
                            <textarea class="form-control" id="newRequiredSkills" name="requiredSkills" rows="1" placeholder="List key skills, certifications, and competencies required for this role..."></textarea>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-section">
                        <div class="section-title">
                            <i class="fas fa-info-circle"></i> Additional Information
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="newUrgency" class="form-label">Hiring Urgency <span class="required">*</span></label>
                                <select class="form-control" id="newUrgency" name="urgency" required>
                                    <option value="">Select Urgency</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newRecruitmentReason" class="form-label">Recruitment Reason</label>
                                <select class="form-control" id="newRecruitmentReason" name="recruitmentReason">
                                    <option value="">Select Reason</option>
                                    <option value="replacement">Replacement</option>
                                    <option value="expansion">Business Expansion</option>
                                    <option value="new-project">New Project</option>
                                    <option value="promotion">Internal Promotion</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newAdvertiseOption" class="form-label">Advertise Position <span class="required">*</span></label>
                                <select class="form-control" id="newAdvertiseOption" name="advertiseOption" required>
                                    <option value="">Select Advertising Preference</option>
                                    <option value="external-internal">Yes - External & Internal</option>
                                    <option value="internal-only">Yes - Internal Only</option>
                                    <option value="no-advertise">No - Do Not Advertise</option>
                                </select>
                                <small class="text-muted" style="font-size:0.65rem;">Choose how (or if) this position will be advertised</small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newNotes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="newNotes" name="notes" rows="1" placeholder="Any additional information about this position, special requirements, or instructions..."></textarea>
                            <small class="text-muted" style="font-size: 0.65rem;">Include any special instructions, requirements, or relevant details</small>
                        </div>
                        <div class="form-group">
                            <label for="newAttachments" class="form-label">Attachments</label>
                            <input type="file" class="form-control" id="newAttachments" name="attachments" multiple accept=".pdf,.doc,.docx,.txt">
                            <small class="text-muted" style="font-size: 0.65rem;">Upload relevant documents (PDF, DOC, DOCX, TXT). Multiple files allowed.</small>
                            <div id="fileDisplay" class="selected-files">
                                <!-- Selected files will be displayed here -->
                            </div>
                        </div>
                    </div>
                </form>
            </div><div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeNewRecruitmentModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createRecruitmentRequest()">
                    <i class="fas fa-paper-plane"></i> Create Recruitment Request
                </button>
            </div>
        </div>
    </div>

        <!-- Typography bump for New Recruitment Modal -->
        <style>
            /* Increase text sizes only within the Initiate New Recruitment modal */
            #newRecruitmentModal .modal-content { font-size: 1rem; max-width: 900px; }
            #newRecruitmentModal .modal-header h5 { font-size: 1.4rem; }
            #newRecruitmentModal .section-title { font-size: 1.1rem; }
            #newRecruitmentModal .form-label { font-size: 0.95rem !important; }
            #newRecruitmentModal .text-muted { font-size: 0.85rem !important; }
            #newRecruitmentModal .form-control { font-size: 0.95rem; }
            #newRecruitmentModal select.form-control,
            #newRecruitmentModal input.form-control,
            #newRecruitmentModal textarea.form-control { font-size: 0.95rem; }
            #newRecruitmentModal .modal-footer .btn { font-size: 0.95rem; }
            #newRecruitmentModal .modal-body { line-height: 1.5; }
            @media (max-width: 640px) {
                #newRecruitmentModal .modal-header h5 { font-size: 1.2rem; }
                #newRecruitmentModal .form-label { font-size: 1rem !important; }
                #newRecruitmentModal .text-muted { font-size: 0.9rem !important; }
                #newRecruitmentModal .form-control { font-size: 1rem; }
            }
        </style>

    <!-- Firebase SDK v8 (External CDN for compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>// Global variables
        let recruitmentData = [];
        let currentViewingPositionId = null;
        let currentActiveTab = 'pending';
        let currentFilter = 'none';
        let currentFilterValue = '';
        
        // Global notification functions
        function markNotificationAsRead(notificationId) {
            if (window.notificationManager) {
                window.notificationManager.markAsRead(notificationId);
            }
        }
        
        function deleteNotificationWithConfirm(notificationId) {
            if (confirm('Are you sure you want to delete this notification?')) {
                if (window.notificationManager) {
                    window.notificationManager.deleteNotification(notificationId);
                }
            }
        }
        
        // Email Notification Service for Production
        class RecruitmentEmailNotificationService {
            constructor() {
                // Production-ready Email Server Configuration
                this.emailServerUrl = this.getEmailServiceUrl();
                this.apiKey = 'dreemex_hse_email_service_2025'; // Production API key
                
                // Check if email server is available
                this.checkEmailServerHealth();
                
                // Delivery statistics
                this.deliveryStats = {
                    totalSent: 0,
                    successful: 0,
                    failed: 0,
                    lastUpdated: null
                };
                
                // Notification history
                this.notificationHistory = [];
                this.maxHistorySize = 100;
                
                // Load saved history from localStorage
                try {
                    const savedHistory = localStorage.getItem('recruitment_notification_history');
                    if (savedHistory) {
                        this.notificationHistory = JSON.parse(savedHistory);
                    }
                } catch (error) {
                    console.warn('Failed to load notification history:', error);
                }
                
                // Log configuration
                console.log('✅ Recruitment Email Service Configuration:');
                console.log(`📧 Email Server URL: ${this.emailServerUrl}`);
                console.log(`🔑 API Key: ${this.apiKey ? 'Configured' : 'Missing'}`);
                console.log(`🌍 Environment: ${this.getEnvironment()}`);
            }
            
            // Get email service URL based on environment
            getEmailServiceUrl() {
                // Check if running in production environment
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                
                // Production environment detection
                if (hostname !== 'localhost' && hostname !== '127.0.0.1' && !hostname.includes('file://')) {
                    // In production, use the same domain with port 3001
                    return `${protocol}//${hostname}:3001`;
                }
                
                // Development/local environment
                return 'http://localhost:3001';
            }
            
            // Get current environment
            getEnvironment() {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname.includes('file://')) {
                    return 'development';
                }
                return 'production';
            }
            
            // Check if email server is running
            async checkEmailServerHealth() {
                try {
                    const response = await fetch(`${this.emailServerUrl}/health`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const healthData = await response.json().catch(() => ({}));
                        console.log('✅ Email server is running and accessible');
                        console.log('📊 Server status:', healthData.status || 'OK');
                        return true;
                    } else {
                        console.warn('⚠️ Email server responded but with error status:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.warn('⚠️ Email server not accessible:', error.message);
                    console.warn('💡 Make sure the email service is running on port 3001');
                    return false;
                }
            }
            
            log(level, message, data = null) {
                const timestamp = new Date().toISOString();
                const logMessage = `[${timestamp}] [RECRUITMENT-EMAIL-${level.toUpperCase()}] ${message}`;
                
                if (data) {
                    console[level](logMessage, data);
                } else {
                    console[level](logMessage);
                }
            }
            
            // Send recruitment request created notification
            async sendRecruitmentRequestNotification(notificationData) {
                this.log('info', 'Starting recruitment request notification process', notificationData);
                
                try {
                    // Validate required data
                    if (!notificationData || !notificationData.positionTitle) {
                        throw new Error('Missing required notification data');
                    }
                    
                    // Get recipient data (submitter and approvers from original position)
                    const recipients = await this.getNotificationRecipients(notificationData);
                    
                    if (!recipients || recipients.length === 0) {
                        this.log('warn', 'No recipients found for notification');
                        return { success: false, error: 'No recipients found' };
                    }
                    
                    this.log('info', `Found ${recipients.length} recipients for notification`);
                    
                    // Send notifications to all recipients
                    const notificationResults = [];
                    for (const recipient of recipients) {
                        try {
                            const result = await this.sendSingleNotification(notificationData, recipient);
                            notificationResults.push(result);
                        } catch (error) {
                            this.log('error', `Failed to send notification to ${recipient.email}`, error);
                            notificationResults.push({
                                success: false,
                                recipient: recipient.email,
                                error: error.message
                            });
                        }
                    }
                    
                    // Calculate overall success
                    const successCount = notificationResults.filter(r => r.success).length;
                    const totalCount = notificationResults.length;
                    
                    this.log('info', `Notification batch completed: ${successCount}/${totalCount} successful`);
                    
                    return {
                        success: successCount > 0,
                        totalSent: totalCount,
                        successful: successCount,
                        failed: totalCount - successCount,
                        results: notificationResults
                    };
                    
                } catch (error) {
                    this.log('error', 'Failed to send recruitment request notifications', error);
                    
                    // Update delivery stats
                    this.deliveryStats.failed++;
                    this.deliveryStats.lastUpdated = new Date();
                    
                    return {
                        success: false,
                        error: `Recruitment notification failed: ${error.message}`
                    };
                }
            }
            
            // Get notification recipients (submitter and approvers from original position)
            async getNotificationRecipients(notificationData) {
                try {
                    const recipients = [];
                    
                    // Add position submitter if available
                    if (notificationData.submittedBy && notificationData.submitterEmail) {
                        recipients.push({
                            name: notificationData.submittedBy,
                            email: notificationData.submitterEmail,
                            role: 'Position Submitter'
                        });
                    }
                    
                    // Add approvers from original position approval flow
                    if (notificationData.originalPositionId) {
                        const approvers = await this.getPositionApprovers(notificationData.originalPositionId);
                        recipients.push(...approvers);
                    }
                    
                    // Add CC recipients if specified
                    if (notificationData.ccRecipients && Array.isArray(notificationData.ccRecipients)) {
                        for (const ccRecipient of notificationData.ccRecipients) {
                            if (ccRecipient.email) {
                                recipients.push({
                                    name: ccRecipient.name || 'Team Member',
                                    email: ccRecipient.email,
                                    role: 'CC Recipient'
                                });
                            }
                        }
                    }
                    
                    // Remove duplicates based on email
                    const uniqueRecipients = recipients.filter((recipient, index, self) => 
                        index === self.findIndex(r => r.email === recipient.email)
                    );
                    
                    this.log('info', `Found ${uniqueRecipients.length} unique recipients`);
                    return uniqueRecipients;
                    
                } catch (error) {
                    this.log('error', 'Error getting notification recipients', error);
                    return [];
                }
            }
            
            // Get approvers from original position in staff management
            async getPositionApprovers(positionId) {
                try {
                    const approvers = [];
                     
                    // Get current company ID
                    const companyId = this.getCurrentCompanyId();
                    if (!companyId) {
                        this.log('warn', 'No company context available for getting approvers');
                        return approvers;
                    }
                    
                    // Fetch position data from staff management Firebase path
                    const positionRef = firebase.database().ref(`companies/${companyId}/staff/${positionId}`);
                    const positionSnapshot = await positionRef.once('value');
                    
                    if (positionSnapshot.exists()) {
                        const positionData = positionSnapshot.val();
                        
                        // Extract approvers from approval flow
                        if (positionData.approvalFlow && positionData.approvalFlow.levels) {
                            for (const [levelKey, level] of Object.entries(positionData.approvalFlow.levels)) {
                                if (level.approvers) {
                                    for (const [approverKey, approver] of Object.entries(level.approvers)) {
                                        if (approver.email && approver.status === 'approved') {
                                            approvers.push({
                                                name: approver.name || 'Approver',
                                                email: approver.email,
                                                role: `Level ${levelKey} Approver`
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    this.log('info', `Found ${approvers.length} approvers for position ${positionId}`);
                    return approvers;
                    
                } catch (error) {
                    this.log('error', `Error getting approvers for position ${positionId}`, error);
                    return [];
                }
            }
            
            // Send notification to a single recipient
            async sendSingleNotification(notificationData, recipient) {
                try {
                    // Prepare email subject and body for local email server
                    const subject = `🎯 Recruitment Request Created: ${notificationData.positionTitle}`;
                    
                    const body = `
A new recruitment request has been created and requires your attention.

POSITION DETAILS:
• Position Title: ${notificationData.positionTitle}
• Department: ${notificationData.department || 'Not specified'}
• Employment Type: ${notificationData.employmentType || 'Not specified'}
• Work Location: ${notificationData.workLocation || 'Not specified'}
• Urgency Level: ${notificationData.urgency || 'Medium'}
• Expected Start Date: ${notificationData.expectedStartDate || 'TBD'}

REQUEST INFORMATION:
• Request ID: ${notificationData.recruitmentId}
• Created Date: ${notificationData.createdDate}
• Created By: ${notificationData.createdBy}
• Your Role: ${recipient.role}

NEXT STEPS:
Please review this recruitment request in the system and take appropriate action.

View Recruitment Board: ${window.location.origin}/recruitboard.html

Thank you for your prompt attention to this matter.
                    `.trim();
                    
                    // Prepare request payload for local email server
                    const emailPayload = {
                        to: recipient.email,
                        subject: subject,
                        body: body,
                        type: 'recruitment-request-created',
                        metadata: {
                            jobId: notificationData.recruitmentId,
                            jobTitle: notificationData.positionTitle,
                            department: notificationData.department,
                            urgency: notificationData.urgency,
                            createdBy: notificationData.createdBy,
                            recipientRole: recipient.role,
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    this.log('info', 'Sending recruitment notification via local email server', {
                        recipient: recipient.email,
                        positionTitle: notificationData.positionTitle,
                        serverUrl: this.emailServerUrl
                    });
                    
                    // Send email using local email server
                    const response = await fetch(`${this.emailServerUrl}/send/recruitment-notification`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': this.apiKey
                        },
                        body: JSON.stringify(emailPayload)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`Email server error: ${response.status} - ${errorData.error || 'Unknown error'}`);
                    }
                    
                    const result = await response.json();
                    this.log('info', 'Recruitment notification sent successfully via local server', result);
                    
                    // Update delivery stats
                    this.deliveryStats.totalSent++;
                    this.deliveryStats.successful++;
                    this.deliveryStats.lastUpdated = new Date();
                    
                    // Add to notification history
                    const notification = {
                        id: Date.now(),
                        type: 'recruitment_request_created',
                        recipient: recipient.email,
                        subject: subject,
                        status: 'sent',
                        timestamp: new Date().toISOString(),
                        recruitmentId: notificationData.recruitmentId,
                        messageId: result.messageId,
                        method: 'local-email-server'
                    };
                    
                    this.addToHistory(notification);
                    
                    return {
                        success: true,
                        method: 'local-email-server',
                        messageId: result.messageId,
                        recipient: recipient.email,
                        recipientName: recipient.name,
                        positionTitle: notificationData.positionTitle,
                        serverResponse: result,
                        timestamp: new Date().toISOString()
                    };
                    
                } catch (error) {
                    this.log('error', 'Failed to send single recruitment notification', error);
                    
                    // Update delivery stats
                    this.deliveryStats.totalSent++;
                    this.deliveryStats.failed++;
                    this.deliveryStats.lastUpdated = new Date();
                    
                    return {
                        success: false,
                        error: `Notification failed: ${error.message}`,
                        recipient: recipient.email
                    };
                }
            }
            
            // Add notification to history
            addToHistory(notification) {
                this.notificationHistory.unshift(notification);
                
                // Keep only the latest notifications
                if (this.notificationHistory.length > this.maxHistorySize) {
                    this.notificationHistory = this.notificationHistory.slice(0, this.maxHistorySize);
                }
                
                // Save to localStorage
                try {
                    localStorage.setItem('recruitment_notification_history', JSON.stringify(this.notificationHistory));
                } catch (error) {
                    this.log('error', 'Failed to save notification history', error);
                }
            }
            
            // Get current company ID
            getCurrentCompanyId() {
                // Try multiple methods to get company ID
                if (window.companyDataService && typeof window.companyDataService.getCurrentCompanyId === 'function') {
                    return window.companyDataService.getCurrentCompanyId();
                }
                
                // Fallback: Try to get from localStorage
                try {
                    const companyContext = localStorage.getItem('dreamex_current_company');
                    if (companyContext) {
                        const context = JSON.parse(companyContext);
                        return context.companyId;
                    }
                } catch (error) {
                    console.warn('Error getting company ID from localStorage:', error);
                }
                
                // Final fallback
                return 'dreamex-dev-company';
            }
            
            // Get delivery statistics
            getDeliveryStatistics() {
                return {
                    ...this.deliveryStats,
                    history: this.notificationHistory.slice(-50), // Last 50 notifications
                    successRate: this.deliveryStats.totalSent > 0 
                        ? (this.deliveryStats.successful / this.deliveryStats.totalSent * 100).toFixed(2) + '%'
                        : '0%'
                };
            }
        }
        
        // Initialize global recruitment email service
        window.recruitmentEmailService = new RecruitmentEmailNotificationService();
        console.log('✅ Recruitment Email Notification Service initialized');

        // Debug function to test email notifications (Production-Ready)
        window.testRecruitmentNotification = async function() {
            console.log('🧪 Testing recruitment notification system...');
            console.log('📧 PRODUCTION-READY EMAIL SYSTEM');
            console.log(`🌍 Environment: ${window.recruitmentEmailService.getEnvironment()}`);
            console.log(`📧 Email Server: ${window.recruitmentEmailService.emailServerUrl}`);
            
            // Test data
            const testNotificationData = {
                recruitmentId: 'test_' + Date.now(),
                positionTitle: 'Test Position - Software Engineer',
                department: 'IT Department',
                employmentType: 'Full-time',
                workLocation: 'Lagos, Nigeria',
                urgency: 'High',
                expectedStartDate: '2025-09-01',
                createdDate: new Date().toLocaleDateString(),
                createdBy: 'Test User',
                submittedBy: 'Test User',
                submitterEmail: 'test@dreamexdatalab.com',
                originalPositionId: null,
                ccRecipients: [
                    { name: 'HR Team', email: 'hr@dreamexdatalab.com' },
                    { name: 'Test Recipient', email: 'test2@dreamexdatalab.com' }
                ]
            };
            
            // Check email server health first
            console.log('🧪 Checking email server health...');
            const healthCheck = await window.recruitmentEmailService.checkEmailServerHealth();
            
            if (!healthCheck) {
                const environment = window.recruitmentEmailService.getEnvironment();
                const serverUrl = window.recruitmentEmailService.emailServerUrl;
                
                alert(`❌ Email server is not running!\n\nEnvironment: ${environment}\nServer URL: ${serverUrl}\n\nPlease start the email server:\n• Development: run start-email-service.bat\n• Production: run start-production-email-service.bat`);
                return { success: false, error: 'Email server not accessible' };
            }
            
            try {
                const result = await window.recruitmentEmailService.sendRecruitmentRequestNotification(testNotificationData);
                console.log('🧪 Test notification result:', result);
                
                if (result.success) {
                    alert(`✅ Test notification sent successfully!\n\nEnvironment: ${window.recruitmentEmailService.getEnvironment()}\nEmail Server: ${window.recruitmentEmailService.emailServerUrl}\nSent to ${result.successful} recipient(s)\nFailed: ${result.failed}`);
                } else {
                    alert(`❌ Test notification failed:\n\n${result.error}`);
                }
                
                return result;
            } catch (error) {
                console.error('🧪 Test notification error:', error);
                alert(`❌ Test notification error:\n\n${error.message}`);
                return { success: false, error: error.message };
            }
        };
        
        console.log('🧪 Test function available: window.testRecruitmentNotification()');
        console.log('📧 Email system: PRODUCTION-READY with environment detection');

        // Tab switching functionality
        function switchToTab(tabName) {
            // Enforce tab-level permissions if available
            try {
                const perms = window._recruitEffectivePerms || null;
                if (perms) {
                    const map = { pending: 'showPending', published: 'showPublished', declined: 'showDeclined', archives: 'showArchives', settings: 'showSettings' };
                    const key = map[tabName];
                    if (key && key in perms && !perms[key]) {
                        showRecruitmentSettingsNotification('You do not have access to this tab', 'warning');
                        return; // block switching
                    }
                }
            } catch {}
            // Remove active class from all tabs
            document.querySelectorAll('.tab-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                // Hide content explicitly for non-active tabs to support inline display:none override
                if (!content.id.startsWith(tabName)) {
                    content.style.display = 'none';
                }
            });
            
            // Add active class to selected tab
            document.getElementById(tabName + 'TabBtn').classList.add('active');
            const activeContent = document.getElementById(tabName + 'TabContent');
            if (activeContent) {
                activeContent.classList.add('active');
                activeContent.style.display = 'block';
            }
            
            // Update current active tab
            currentActiveTab = tabName;
            
            // Load appropriate data for the tab
            switch(tabName) {
                case 'pending':
                    renderPendingPositions();
                    break;
                case 'published':
                    renderPublishedPositions();
                    break;
                case 'declined':
                    renderDeclinedPositions();
                    break;
                case 'archives':
                    renderArchivedPositions();
                    break;
                case 'settings':
                    // Lazy initialize settings tab (load existing permissions from Firebase once)
                    if (typeof loadRecruitmentAccessSettings === 'function') {
                        loadRecruitmentAccessSettings();
                    }
                    break;
            }
        }

        // Filter dropdown functionality
        function toggleFilterDropdown() {
            const menu = document.getElementById('filterDropdownMenu');
            menu.classList.toggle('show');
        }

        function selectFilter(filterType) {
            currentFilter = filterType;
            const dropdownText = document.getElementById('filterDropdownText');
            const filterSelect = document.getElementById('filterValueSelect');
            const menu = document.getElementById('filterDropdownMenu');
            
            // Close dropdown
            menu.classList.remove('show');
            
            // Update dropdown text
            const filterNames = {
                'none': 'No Filter',
                'jobTitle': 'Job Title',
                'department': 'Department',
                'employmentType': 'Employment Type',
                'priority': 'Priority'
            };
            
            dropdownText.textContent = filterNames[filterType] || 'Select Filter';
            
            // Show/hide filter select
            if (filterType === 'none') {
                filterSelect.style.display = 'none';
                currentFilterValue = '';
                applyFilters();
            } else {
                filterSelect.style.display = 'block';
                populateFilterOptions(filterType);
            }
        }

        function populateFilterOptions(filterType) {
            const filterSelect = document.getElementById('filterValueSelect');
            filterSelect.innerHTML = '<option value="">All</option>';
            
            // Get unique values for the filter type
            const values = new Set();
            recruitmentData.forEach(position => {
                let value = '';
                switch(filterType) {
                    case 'jobTitle':
                        value = position.jobTitle;
                        break;
                    case 'department':
                        value = position.department;
                        break;
                    case 'employmentType':
                        value = position.employmentType;
                        break;
                    case 'priority':
                        value = position.priority;
                        break;
                }
                if (value) values.add(value);
            });
            
            // Add options to select
            Array.from(values).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                filterSelect.appendChild(option);
            });
        }

        function applyFilters() {
            const filterSelect = document.getElementById('filterValueSelect');
            currentFilterValue = filterSelect.value;
            
            // Re-render current tab with filters
            switch(currentActiveTab) {
                case 'pending':
                    renderPendingPositions();
                    break;
                case 'approved':
                    renderPublishedPositions();
                    break;
                case 'declined':
                    renderDeclinedPositions();
                    break;
                case 'archives':
                    renderArchivedPositions();
                    break;
            }
        }

        // Filter data based on current filter settings
        function filterData(data) {
            if (currentFilter === 'none' || !currentFilterValue) {
                return data;
            }
            
            return data.filter(position => {
                let value = '';
                switch(currentFilter) {
                    case 'jobTitle':
                        value = position.jobTitle;
                        break;
                    case 'department':
                        value = position.department;
                        break;
                    case 'employmentType':
                        value = position.employmentType;
                        break;
                    case 'priority':
                        value = position.priority;
                        break;
                }
                return value === currentFilterValue;
            });
        }

        // Render functions for each tab
        function renderPendingPositions() {
            const pendingData = recruitmentData.filter(position => {
                const status = (position.status || position.approvalStatus || '').toLowerCase();
                // Exclude published positions and those transferred to jobs
                return (status === 'pending' || status === 'submitted' || status === '') && 
                       status !== 'published' && 
                       !position.transferredToJobs &&
                       position.source !== 'published'; // Don't show published jobs in pending
            });
            
            const filteredData = filterData(pendingData);
            renderTableData(filteredData, 'recruitmentTableBody', null, 'pendingLoadingState');
        }

        function renderPublishedPositions() {
            const publishedData = recruitmentData.filter(position => {
                const status = (position.status || position.approvalStatus || '').toLowerCase();
                // Show published jobs from jobs path, published staff positions, and closed jobs
                return (status === 'approved' || status === 'released' || status === 'published' || status === 'closed') && 
                       (position.source === 'published' || position.source === 'staff' || position.source === 'closed');
            });
            
            const filteredData = filterData(publishedData);
            renderTableData(filteredData, 'publishedTableBody', null, 'publishedLoadingState');
        }

        function renderDeclinedPositions() {
            const declinedData = recruitmentData.filter(position => {
                const status = (position.status || position.approvalStatus || '').toLowerCase();
                return status === 'declined' || status === 'rejected';
            });
            
            const filteredData = filterData(declinedData);
            renderTableData(filteredData, 'declinedTableBody', null, 'declinedLoadingState');
        }

        function renderArchivedPositions() {
            const archivedData = recruitmentData.filter(position => {
                return position.isArchived === true;
            });
            
            const filteredData = filterData(archivedData);
            renderTableData(filteredData, 'archiveTableBody', null, 'archiveLoadingState');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('filterDropdownMenu');
            const button = document.getElementById('filterDropdownBtn');
            
            if (dropdown && button && !button.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Helper function to get current user ID
        function getCurrentUserId() {
            try {
                // Try to get from localStorage first
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    return user.uid || user.id || user.email;
                }
                
                // Try to get from Firebase auth if available
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    return firebase.auth().currentUser.uid;
                }
                
                return 'anonymous';
            } catch (error) {
                console.warn('Error getting current user ID:', error);
                return 'anonymous';
            }
        }

        // Enhanced function to get current user ID with company context resolution
        async function getCurrentUserIdWithCompanyContext() {
            try {
                const globalUserId = getCurrentUserId();
                const currentCompanyId = getCurrentCompanyId();
                
                console.log(`🔍 Resolving user ID - Global: ${globalUserId}, Company: ${currentCompanyId}`);
                
                if (!currentCompanyId || globalUserId === 'anonymous') {
                    return globalUserId;
                }

                // Try to find user in company-scoped users
                try {
                    const companyUsersRef = firebase.database().ref(`companies/${currentCompanyId}/users`);
                    const snapshot = await companyUsersRef.once('value');
                    const companyUsers = snapshot.val();
                    
                    if (companyUsers) {
                        // Look for user by various ID methods
                        for (const [companyUserId, userData] of Object.entries(companyUsers)) {
                            if (userData.uid === globalUserId || 
                                userData.id === globalUserId ||
                                userData.email === globalUserId ||
                                companyUserId === globalUserId) {
                                console.log(`✅ Found company-scoped user ID: ${companyUserId} for global ID: ${globalUserId}`);
                                return companyUserId;
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Error resolving company-scoped user ID:', error);
                }

                console.log(`⚠️ Could not resolve company-scoped user ID, using global ID: ${globalUserId}`);
                return globalUserId;
            } catch (error) {
                console.error('Error in getCurrentUserIdWithCompanyContext:', error);
                return getCurrentUserId(); // Fallback to global ID
            }
        }
        
        // Get current user name
        function getCurrentUserName() {
            try {
                // Try to get from localStorage first
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    return user.displayName || user.name || user.firstName + ' ' + (user.lastName || '') || user.email;
                }
                
                // Try to get from Firebase auth if available
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    const user = firebase.auth().currentUser;
                    return user.displayName || user.email;
                }
                
                return 'System User';
            } catch (error) {
                console.warn('Error getting current user name:', error);
                return 'System User';
            }
        }
        
        // Get current user email
        function getCurrentUserEmail() {
            try {
                // Try to get from localStorage first
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    return user.email;
                }
                
                // Try to get from Firebase auth if available
                if (typeof firebase !== 'undefined' && firebase.auth && firebase.auth().currentUser) {
                    return firebase.auth().currentUser.email;
                }
                
                return 'hr@dreamexdatalab.com';
            } catch (error) {
                console.warn('Error getting current user email:', error);
                return 'hr@dreamexdatalab.com';
            }
        }
        
        // Initialize user avatar display
        async function initializeUserAvatar() {
            // Wait for authManager to be available
            let retries = 0;
            const maxRetries = 20;
            while (!window.authManager && retries < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, 250));
                retries++;
            }
            
            if (window.authManager) {
                try {
                    console.log('🎭 Initializing user avatar display...');
                    
                    // Use the new updateUserProfileDisplay method for comprehensive avatar updates
                    await window.authManager.updateUserProfileDisplay();
                    console.log('✅ User avatar display initialized successfully');
                    
                } catch (error) {
                    console.error('❌ Error initializing user avatar:', error);
                    // Fallback to showing initials
                    const avatarInitials = document.getElementById('userAvatarInitials');
                    if (avatarInitials && window.authManager) {
                        avatarInitials.textContent = window.authManager.getUserInitials();
                        avatarInitials.style.display = 'flex';
                        avatarInitials.style.alignItems = 'center';
                        avatarInitials.style.justifyContent = 'center';
                    }
                }
            } else {
                console.warn('⚠️ AuthManager not available for avatar initialization');
            }
        }
        
        // Company context helper functions
        function validateCompanyContext() {
            try {
                if (window.companyDataService) {
                    const companyId = window.companyDataService.getCurrentCompanyId();
                    if (companyId) {
                        console.log('✅ Company context validated:', companyId);
                        return companyId;
                    }
                }
                
                // Fallback: try to get from current user
                const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                if (currentUser.companyId) {
                    console.log('✅ Company context from user:', currentUser.companyId);
                    return currentUser.companyId;
                }
                
                console.warn('⚠️ No company context available');
                return null;
            } catch (error) {
                console.error('❌ Error validating company context:', error);
                return null;
            }
        }
        
        function getCurrentCompanyId() {
            return validateCompanyContext();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for Firebase to be ready
            try {
                await window.firebaseReady;
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
            }
            
            // Wait for company data service to be available
            let retries = 0;
            const maxRetries = 20; // 10 seconds total
            while (!window.companyDataService && retries < maxRetries) {
                await new Promise(resolve => setTimeout(resolve, 500));
                retries++;
            }
            
            if (window.companyDataService) {
                console.log('✅ Company data service available');
                try {
                    await window.companyDataService.initializeUserContext();
                    console.log('✅ Company context initialized');
                } catch (error) {
                    console.error('❌ Error initializing company context:', error);
                }
            } else {
                console.warn('⚠️ Company data service not available after waiting');
            }
            
            loadApprovedPositions();
            loadRecruitmentRequests();
            loadPublishedJobs();
            loadClosedJobs();
            
            // Initialize user avatar display
            initializeUserAvatar();
            
            // Set up avatar update listener for dynamic updates
            if (window.authManager) {
                // Listen for avatar updates (this can be triggered from profile page)
                document.addEventListener('avatarUpdated', () => {
                    console.log('🔄 Avatar updated, refreshing display...');
                    initializeUserAvatar();
                });
            }
            
            console.log('Page initialization complete');
            
            // Load preferences and initialize notifications  
            if (typeof loadUserPreferences === 'function') loadUserPreferences();
            if (typeof initializeNotifications === 'function') initializeNotifications();
            // Load Approval Configuration
            try { await loadRecruitmentApprovalConfig(); } catch (_) {}
        });

        // Load approved positions from Firebase staff data
        async function loadApprovedPositions() {
            try {
                if (typeof firebase !== 'undefined' && firebase.database) {
                    const staffRef = firebase.database().ref('staff');
                    staffRef.on('value', (staffSnapshot) => {
                        loadStaffData(staffSnapshot);
                    });                } else {
                    console.warn('Firebase not available');
                    recruitmentData = [];
                    // Initialize tab system with pending tab
                    switchToTab('pending');
                }
            } catch (error) {
                console.error('Error loading approved positions:', error);
                showNotification('Error loading positions', 'error');
                recruitmentData = [];
                // Initialize tab system with pending tab
                switchToTab('pending');
            }
        }

        // Load recruitment requests from Firebase recruit data
        async function loadRecruitmentRequests() {
            try {
                if (typeof firebase !== 'undefined' && firebase.database) {
                    // Get current company ID
                    const companyId = getCurrentCompanyId();
                    if (!companyId) {
                        console.warn('No company context available, skipping recruitment requests');
                        recruitRequests = [];
                        combineAndRenderData();
                        return;
                    }
                    
                    console.log(`Loading recruitment requests from company path: companies/${companyId}/recruit`);
                    
                    // Load from company-scoped recruit path with real-time updates
                    const recruitRef = firebase.database().ref(`companies/${companyId}/recruit`);
                    recruitRef.on('value', (recruitSnapshot) => {
                        console.log('Real-time recruitment data update received');
                        loadRecruitData(recruitSnapshot);
                    }, (error) => {
                        console.error('Error loading recruitment data:', error);
                        recruitRequests = [];
                        combineAndRenderData();
                    });
                }
            } catch (error) {
                console.error('Error loading recruitment requests:', error);
            }
        }

        // Global variables to store data from both sources
        let staffPositions = [];
        let recruitRequests = [];
        let publishedJobs = [];
        let closedJobs = [];
        
        // Debouncing variable to prevent rapid data combination calls
        let combineDataTimeout = null;
        let isLoadingData = false;

        // Process staff data from Firebase
        function loadStaffData(snapshot) {
            const firebaseData = snapshot.val();
            console.log('Staff Firebase data loaded:', firebaseData);
            
            if (firebaseData) {
                // Get all staff records
                const allStaffRecords = Object.keys(firebaseData).map(key => ({
                    ...firebaseData[key],
                    firebaseKey: key,
                    source: 'staff'
                }));
                  // Filter for approved positions that are open for recruitment
                const approvedPositions = allStaffRecords.filter(staff => 
                    staff.approvalStatus === 'approved' &&
                    staff.status !== 'filled' &&
                    (staff.id || staff.positionCode) && 
                    staff.jobTitle
                );                staffPositions = approvedPositions.map(staff => ({
                    id: staff.id || staff.firebaseKey,
                    positionCode: staff.positionCode,
                    jobTitle: staff.jobTitle,
                    department: staff.department,
                    employmentType: staff.employmentType,
                    salaryMin: staff.salaryMin || 0,
                    salaryMax: staff.salaryMax || 0,
                    priority: staff.urgency || staff.priority || 'medium',
                    status: staff.status === 'filled' ? 'filled' : 'open',
                    startDate: staff.startDate || staff.expectedStartDate,
                    postedDate: staff.createdAt || staff.updatedAt,
                    publishedDate: staff.publishedDate || staff.datePublished || staff.createdAt || staff.updatedAt, // Ensure published date exists for approved staff positions
                    lineManager: staff.lineManager,
                    workingHours: staff.workingHours,
                    location: staff.workLocation || staff.location,
                    jobDescription: staff.jobDescription,
                    requiredEducation: staff.requiredEducation,
                    requiredExperience: staff.requiredExperience,
                    requiredSkills: staff.requiredSkills,
                    endDate: staff.endDate,
                    notes: staff.notes,
                    recruitmentReason: staff.recruitmentReason,
                    firebaseKey: staff.firebaseKey,
                    source: 'staff',
                    approvalStatus: staff.approvalStatus
                }));
                
                console.log(`Loaded ${staffPositions.length} approved staff positions`);
            } else {
                staffPositions = [];
            }
            
            // Combine and render data
            combineAndRenderData();
        }

        // Process recruitment request data from Firebase
        function loadRecruitData(snapshot) {
            const firebaseData = snapshot.val();
            console.log('Recruit Firebase data loaded:', firebaseData);
            
            if (firebaseData) {
                // Get all recruitment records
                const allRecruitRecords = Object.keys(firebaseData).map(key => ({
                    ...firebaseData[key],
                    firebaseKey: key,
                    source: 'recruit'
                }));                recruitRequests = allRecruitRecords.map(recruit => ({
                    id: recruit.id || recruit.firebaseKey,
                    positionCode: recruit.positionCode,
                    jobTitle: recruit.jobTitle,
                    department: recruit.department,
                    employmentType: recruit.employmentType,
                    salaryMin: recruit.salaryMin || 0,
                    salaryMax: recruit.salaryMax || 0,
                    priority: recruit.urgency || recruit.priority || 'medium',
                    status: recruit.status || 'open',
                    startDate: recruit.startDate || recruit.expectedStartDate,
                    postedDate: recruit.postedDate || recruit.createdAt,
                    publishedDate: recruit.publishedDate || (recruit.status === 'approved' ? recruit.postedDate || recruit.createdAt : null), // Ensure published date for approved positions
                    transferredToJobs: recruit.transferredToJobs, // Include transfer flag
                    lineManager: recruit.lineManager,
                    workingHours: recruit.workingHours,
                    location: recruit.workLocation || recruit.location,
                    jobDescription: recruit.jobDescription,
                    requiredEducation: recruit.requiredEducation,
                    requiredExperience: recruit.requiredExperience,
                    requiredSkills: recruit.requiredSkills,
                    endDate: recruit.endDate,
                    notes: recruit.notes,
                    recruitmentReason: recruit.recruitmentReason,
                    advertiseOption: recruit.advertiseOption, // Preserve advertising preference
                    advertiseOptionLabel: recruit.advertiseOptionLabel, // Preserve original label if stored
                    firebaseKey: recruit.firebaseKey,
                    source: 'recruit',
                    approvalStatus: recruit.approvalStatus || 'pending',
                    submittedBy: recruit.submittedBy
                }));
                
                console.log('🔍 Loaded recruitment requests with critical fields check:');
                recruitRequests.forEach((req, index) => {
                    if (index < 3) { // Only log first 3 for brevity
                        console.log(`Request ${req.id}:`, {
                            employmentType: req.employmentType,
                            requiredEducation: req.requiredEducation,
                            recruitmentReason: req.recruitmentReason
                        });
                    }
                });
                
                console.log(`Loaded ${recruitRequests.length} recruitment requests`);
            } else {
                recruitRequests = [];
            }
            
            // Combine and render data
            combineAndRenderData();
        }

        // Load published jobs from Firebase jobs collection
        async function loadPublishedJobs() {
            try {
                const companyId = getCurrentCompanyId();
                console.log('Loading published jobs for company ID:', companyId);
                
                if (!companyId) {
                    console.warn('Company ID not available for loading published jobs');
                    publishedJobs = [];
                    combineAndRenderData();
                    return;
                }

                if (typeof firebase !== 'undefined' && firebase.database) {
                    const jobsRef = firebase.database().ref(`companies/${companyId}/jobs`);
                    console.log('Setting up Firebase listener for path:', `companies/${companyId}/jobs`);
                    
                    jobsRef.on('value', (jobsSnapshot) => {
                        console.log('Firebase data received for published jobs');
                        loadJobsData(jobsSnapshot);
                    });
                } else {
                    console.warn('Firebase not available for loading published jobs');
                    publishedJobs = [];
                    combineAndRenderData();
                }
            } catch (error) {
                console.error('Error loading published jobs:', error);
                publishedJobs = [];
                combineAndRenderData();
            }
        }

        // Load closed jobs from Firebase jobclosed collection
        async function loadClosedJobs() {
            try {
                const companyId = getCurrentCompanyId();
                if (!companyId) {
                    console.warn('Company ID not available for loading closed jobs');
                    closedJobs = [];
                    combineAndRenderData();
                    return;
                }

                if (typeof firebase !== 'undefined' && firebase.database) {
                    const closedJobsRef = firebase.database().ref(`companies/${companyId}/jobclosed`);
                    closedJobsRef.on('value', (closedJobsSnapshot) => {
                        loadClosedJobsData(closedJobsSnapshot);
                    });
                } else {
                    console.warn('Firebase not available for loading closed jobs');
                    closedJobs = [];
                    combineAndRenderData();
                }
            } catch (error) {
                console.error('Error loading closed jobs:', error);
                closedJobs = [];
                combineAndRenderData();
            }
        }

        // Process published jobs data from Firebase
        function loadJobsData(snapshot) {
            const firebaseData = snapshot.val();
            console.log('Published jobs Firebase data loaded:', firebaseData);
            
            if (firebaseData) {
                console.log('Raw Firebase data keys:', Object.keys(firebaseData));
                
                // Convert published jobs to the format expected by recruitboard
                publishedJobs = Object.keys(firebaseData).map(key => {
                    const job = firebaseData[key];
                    console.log(`Processing job ${key}:`, job.jobTitle, 'Status:', job.status);
                    
                    // Include jobs with published or closed status
                    if (job.status !== 'published' && job.status !== 'closed') {
                        console.log(`Excluding job ${key} due to status: ${job.status}`);
                        return null;
                    }
                    
                    return {
                        id: key,
                        positionCode: job.positionCode || key,
                        jobTitle: job.jobTitle || job.title,
                        department: job.department,
                        employmentType: job.employmentType,
                        salaryMin: job.salaryMin,
                        salaryMax: job.salaryMax,
                        urgency: job.urgency,
                        startDate: job.startDate,
                        postedDate: job.createdDate || job.datePosted,
                        publishedDate: job.publishedDate || job.datePublished || job.createdDate || new Date().toISOString(), // Ensure published date exists
                        closedDate: job.closedDate, // Add closed date for closed jobs
                        originalStatus: job.originalStatus, // Add original status for closed jobs
                        closedBy: job.closedBy, // Add who closed the job
                        endDate: job.endDate,
                        notes: job.notes,
                        location: job.workLocation || job.location,
                        workLocation: job.workLocation || job.location, // Alternative mapping
                        jobDescription: job.jobDescription,
                        requiredEducation: job.requiredEducation,
                        requiredExperience: job.requiredExperience,
                        requiredSkills: job.requiredSkills,
                        lineManager: job.lineManager, // Add line manager
                        workingHours: job.workingHours, // Add working hours
                        advertisingClosingDate: job.advertisingClosingDate || job.closingDate, // Add advertising closing date
                        recruitmentReason: job.recruitmentReason || job.reason || job.hiringReason || job.requestReason,
                        firebaseKey: key,
                        source: job.status === 'closed' ? 'closed' : 'published',
                        status: job.status, // Use actual job status (published or closed)
                        approvalStatus: job.status === 'closed' ? 'closed' : 'published'
                    };
                }).filter(job => job !== null); // Remove null entries (non-published/closed jobs)
                
                console.log(`Loaded ${publishedJobs.length} published and closed jobs`);
            } else {
                publishedJobs = [];
            }
            
            // Combine and render data
            combineAndRenderData();
        }

        // Process closed jobs data from Firebase
        function loadClosedJobsData(snapshot) {
            const firebaseData = snapshot.val();
            console.log('Closed jobs Firebase data loaded:', firebaseData);
            
            if (firebaseData) {
                // Convert closed jobs to the format expected by recruitboard
                closedJobs = Object.keys(firebaseData).map(key => {
                    const job = firebaseData[key];
                    
                    return {
                        id: key,
                        positionCode: job.positionCode || key,
                        jobTitle: job.jobTitle || job.title,
                        department: job.department,
                        employmentType: job.employmentType,
                        salaryMin: job.salaryMin,
                        salaryMax: job.salaryMax,
                        urgency: job.urgency,
                        startDate: job.startDate,
                        postedDate: job.createdDate || job.datePosted,
                        publishedDate: job.publishedDate || job.datePublished || job.createdDate,
                        closedDate: job.closedDate || job.dateArchived, // Add closed date
                        endDate: job.endDate,
                        notes: job.notes,
                        location: job.workLocation || job.location,
                        workLocation: job.workLocation || job.location,
                        jobDescription: job.jobDescription,
                        requiredEducation: job.requiredEducation,
                        requiredExperience: job.requiredExperience,
                        requiredSkills: job.requiredSkills,
                        lineManager: job.lineManager,
                        workingHours: job.workingHours,
                        advertisingClosingDate: job.advertisingClosingDate || job.closingDate,
                        recruitmentReason: job.recruitmentReason || job.reason || job.hiringReason || job.requestReason,
                        archiveReason: job.archiveReason || job.closureReason, // Add closure reason
                        firebaseKey: key,
                        source: 'closed',
                        status: 'closed',
                        approvalStatus: 'closed'
                    };
                });
                
                console.log(`Loaded ${closedJobs.length} closed jobs`);
            } else {
                closedJobs = [];
            }
            
            // Combine and render data
            combineAndRenderData();
        }        // Combine data from both sources and render
        function combineAndRenderData() {
            // Prevent multiple simultaneous data combinations
            if (isLoadingData) {
                console.log('Data combination already in progress, skipping...');
                return;
            }
            
            // Clear any existing timeout to debounce rapid calls
            if (combineDataTimeout) {
                clearTimeout(combineDataTimeout);
            }
            
            // Set a timeout to debounce rapid data combination calls
            combineDataTimeout = setTimeout(() => {
                console.log('🔄 Combining and rendering data from all sources...');
                performDataCombination();
            }, 150); // 150ms delay to allow multiple rapid Firebase updates to settle
        }
        
        // Actual data combination logic (separated for debouncing)
        function performDataCombination() {
            console.log('🔄 Starting data combination...');
            console.log('Data source counts:');
            console.log('- staffPositions:', staffPositions.length);
            console.log('- recruitRequests:', recruitRequests.length);
            console.log('- publishedJobs:', publishedJobs.length);
            console.log('- closedJobs:', closedJobs.length);
            
            isLoadingData = true;
            
            // Filter out filled positions and ensure data quality
            const validStaffPositions = staffPositions.filter(position => 
                position.status !== 'filled' && 
                (position.id || position.positionCode) && 
                position.jobTitle &&
                position.department
            );
            
            const validRecruitRequests = recruitRequests.filter(request => 
                request.status !== 'filled' && 
                request.status !== 'published' && // Exclude published requests
                !request.transferredToJobs && // Exclude transferred requests
                (request.id || request.positionCode) && 
                request.jobTitle &&
                request.department
            );
            
            const validPublishedJobs = publishedJobs.filter(job => 
                (job.status === 'published' || job.status === 'closed') && 
                (job.id || job.positionCode) && 
                job.jobTitle &&
                job.department
            );
            
            console.log('Filtered data counts:');
            console.log('- validStaffPositions:', validStaffPositions.length);
            console.log('- validRecruitRequests:', validRecruitRequests.length);
            console.log('- validPublishedJobs:', validPublishedJobs.length);
            
            // No need for validClosedJobs since closed jobs are now in publishedJobs
            // const validClosedJobs = closedJobs.filter(job => 
            //     job.status === 'closed' && 
            //     (job.id || job.positionCode) && 
            //     job.jobTitle &&
            //     job.department
            // );
            
            // Combine staff positions, recruitment requests, and published jobs (which includes closed jobs)
            recruitmentData = [...validStaffPositions, ...validRecruitRequests, ...validPublishedJobs];
            
            console.log('Final recruitmentData count:', recruitmentData.length);
            console.log('recruitmentData sample:', recruitmentData.slice(0, 3));
            
            // Remove duplicates using a more comprehensive unique key approach
            const uniquePositions = [];
            const seenKeys = new Set();
            
            // Sort by priority: published jobs first, then closed jobs, then staff, then recruit requests
            const prioritizedData = recruitmentData.sort((a, b) => {
                const priorityOrder = { 'published': 1, 'closed': 2, 'staff': 3, 'recruit': 4 };
                return (priorityOrder[a.source] || 5) - (priorityOrder[b.source] || 5);
            });
            
            prioritizedData.forEach(position => {
                // Create a more comprehensive unique key to prevent duplicates
                const uniqueKey = `${position.source}-${position.id || position.firebaseKey}`;
                const positionCode = position.positionCode || position.id;
                
                // Check both unique key and position code to prevent duplicates
                if (!seenKeys.has(uniqueKey) && (!positionCode || !Array.from(seenKeys).some(key => key.includes(positionCode)))) {
                    seenKeys.add(uniqueKey);
                    uniquePositions.push(position);
                    console.log(`✅ Added position: ${uniqueKey} (${position.jobTitle})`);
                } else {
                    console.log(`🔄 Filtered duplicate: ${uniqueKey} (${position.jobTitle}) - positionCode: ${positionCode}`);
                }
            });
            
            recruitmentData = uniquePositions;
            
            // Sort by posted date (newest first)
            recruitmentData.sort((a, b) => {
                const dateA = new Date(a.postedDate || a.createdAt || 0);
                const dateB = new Date(b.postedDate || b.createdAt || 0);
                return dateB - dateA;
            });
            console.log('Combined recruitment data:', recruitmentData);
            console.log(`Total positions: ${recruitmentData.length} (${staffPositions.length} from staff + ${recruitRequests.length} from recruit + ${publishedJobs.length} from published + ${closedJobs.length} from closed jobs)`);
            
            // Initialize tab system with pending tab
            switchToTab('pending');
            
            // Refresh job title dropdown to exclude newly added positions
            populateJobTitleDropdown();
            
            // Reset loading flag
            isLoadingData = false;
            console.log('✅ Data combination completed');
        }

        // Render recruitment table
        function renderRecruitmentTable(data = recruitmentData) {
            // Default to pending tab data when called without parameters
            renderTableData(data, 'recruitmentTableBody', null, 'pendingLoadingState');
        }

        // Generic table rendering function
        function renderTableData(data, tbodyId, emptyStateId, loadingStateId) {
            const tbody = document.getElementById(tbodyId);
            const loadingState = document.getElementById(loadingStateId);
            
            if (!tbody) return;
            
            // Show loading
            if (loadingState) {
                loadingState.style.display = 'block';
            }
            tbody.innerHTML = '';
            
            // Simulate loading delay
            setTimeout(() => {
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                
                if (data.length === 0) {
                    // No empty state shown - just leave table empty
                    return;
                }
                
                // Render table rows
                data.forEach(position => {
                    const row = createTableRow(position);
                    tbody.appendChild(row);
                });
                
                // Update filter options for current data
                if (currentActiveTab === 'pending') {
                    populateFilterOptions(currentFilter);
                }
            }, 300);
        }

        // Helper function to determine which date to display based on position status and tab
        function getDisplayDate(position) {
            const status = (position.status || position.approvalStatus || '').toLowerCase();
            const isPublished = status === 'published' || status === 'approved' || status === 'released';
            
            // For published positions, prioritize published date
            if (isPublished && currentActiveTab === 'published') {
                return position.publishedDate || position.postedDate || position.createdDate;
            }
            
            // For transferred recruitment requests, show published date if available
            if (position.transferredToJobs && position.publishedDate) {
                return position.publishedDate;
            }
            
            // Default to posted/created date
            return position.postedDate || position.createdDate;
        }

        // Create table row for position data
        function createTableRow(position) {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            
            // Create source display text
            const sourceDisplayMap = {
                'recruit': 'Recruitment Board',
                'staff': 'Staff Management',
                'published': 'Published Jobs',
                'closed': 'Closed Jobs'
            };
            const sourceDisplay = sourceDisplayMap[position.source] || 'Unknown Source';
            row.title = `Click to view details • Source: ${sourceDisplay}`;
            
            // Add source-based row styling
            if (position.source === 'recruit') {
                row.classList.add('recruit-row');
            } else if (position.source === 'published') {
                row.classList.add('published-row');
            } else if (position.source === 'closed') {
                row.classList.add('closed-row');
            } else {
                row.classList.add('staff-row');
            }
            
            // Add checkbox for all tabs (each tab has checkbox functionality)
            let checkboxCell = '';
            let checkboxClass = 'position-checkbox';
            
            // Add tab-specific checkbox classes for proper selection handling
            switch(currentActiveTab) {
                case 'pending':
                    checkboxClass = 'position-checkbox';
                    break;
                case 'published':
                    checkboxClass = 'published-checkbox';
                    break;
                case 'declined':
                    checkboxClass = 'declined-checkbox';
                    break;
                case 'archives':
                    checkboxClass = 'archives-checkbox';
                    break;
                default:
                    checkboxClass = 'position-checkbox';
            }
            
            checkboxCell = `<td><input type="checkbox" class="${checkboxClass}" data-id="${position.id}"></td>`;
            
            row.innerHTML = `
                ${checkboxCell}
                <td><strong class="job-title-cell">${position.jobTitle || 'N/A'}</strong></td>
                <td>${position.department || 'N/A'}</td>
                <td>
                    <span class="employment-type-badge badge-${(position.employmentType || '').toLowerCase()}">
                        ${formatEmploymentType(position.employmentType)}
                    </span>
                </td>
                <td class="salary-range">${formatSalaryRange(position.salaryMin, position.salaryMax)}</td>
                <td>
                    <span class="badge badge-${(position.priority || position.urgency || 'low').toLowerCase()}">
                        ${formatPriority(position.priority || position.urgency)}
                    </span>
                </td>
                <td>
                    <span class="status-badge badge-${(position.status || position.approvalStatus || '').toLowerCase()}">
                        ${formatStatus(position.status || position.approvalStatus)}
                    </span>
                </td>
                <td>${formatDate(getDisplayDate(position))}</td>
            `;
            
            // Add click event for row
            row.addEventListener('click', (e) => {
                if (!e.target.closest('.position-checkbox')) {
                    viewDetails(position.id);
                }
            });
            
            return row;
        }

        // Utility functions for bulk actions
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const positionCheckboxes = document.querySelectorAll('.position-checkbox');
            
            positionCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function toggleSelectAllPublished() {
            const selectAllCheckbox = document.getElementById('selectAllPublishedCheckbox');
            const positionCheckboxes = document.querySelectorAll('.published-checkbox');
            
            positionCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function toggleSelectAllDeclined() {
            const selectAllCheckbox = document.getElementById('selectAllDeclinedCheckbox');
            const positionCheckboxes = document.querySelectorAll('.declined-checkbox');
            
            positionCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function toggleSelectAllArchives() {
            const selectAllCheckbox = document.getElementById('selectAllArchivesCheckbox');
            const positionCheckboxes = document.querySelectorAll('.archives-checkbox');
            
            positionCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function exportSelected() {
            // Get the appropriate checkbox selector based on current tab
            let checkboxSelector;
            switch(currentActiveTab) {
                case 'pending':
                    checkboxSelector = '.position-checkbox:checked';
                    break;
                case 'published':
                    checkboxSelector = '.published-checkbox:checked';
                    break;
                case 'declined':
                    checkboxSelector = '.declined-checkbox:checked';
                    break;
                case 'archives':
                    checkboxSelector = '.archives-checkbox:checked';
                    break;
                default:
                    checkboxSelector = '.position-checkbox:checked';
            }
            
            const selectedIds = Array.from(document.querySelectorAll(checkboxSelector))
                .map(checkbox => checkbox.dataset.id);
            
            if (selectedIds.length === 0) {
                alert('Please select positions to export.');
                return;
            }
            
            const selectedData = recruitmentData.filter(position => selectedIds.includes(position.id));
            exportData(selectedData);
        }

        function deleteSelected() {
            // Get the appropriate checkbox selector based on current tab
            let checkboxSelector;
            switch(currentActiveTab) {
                case 'pending':
                    checkboxSelector = '.position-checkbox:checked';
                    break;
                case 'published':
                    checkboxSelector = '.published-checkbox:checked';
                    break;
                case 'declined':
                    checkboxSelector = '.declined-checkbox:checked';
                    break;
                case 'archives':
                    checkboxSelector = '.archives-checkbox:checked';
                    break;
                default:
                    checkboxSelector = '.position-checkbox:checked';
            }
            
            const selectedIds = Array.from(document.querySelectorAll(checkboxSelector))
                .map(checkbox => checkbox.dataset.id);
            
            if (selectedIds.length === 0) {
                alert('Please select positions to delete.');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${selectedIds.length} selected position(s)?`)) {
                console.log('🗑️ Deleting positions:', selectedIds);
                (async () => {
                    const companyId = getCurrentCompanyId();
                    if (!companyId) {
                        alert('Company context unavailable – cannot delete.');
                        return;
                    }
                    const failures = [];
                    // Remove each selected recruitment record (only recruit-sourced items exist at path)
                    await Promise.all(selectedIds.map(async id => {
                        try {
                            await firebase.database().ref(`companies/${companyId}/recruit/${id}`).remove();
                            console.log(`✅ Deleted recruitment request ${id}`);
                        } catch (err) {
                            console.error(`❌ Failed to delete ${id}:`, err);
                            failures.push({ id, error: err });
                        }
                    }));
                    // Optimistically remove rows from current table before realtime update arrives
                    selectedIds.forEach(id => {
                        const checkbox = document.querySelector(`[data-id='${id}']`);
                        if (checkbox) {
                            const row = checkbox.closest('tr');
                            if (row) row.remove();
                        }
                    });
                    // Clear master select-all checkbox if present
                    ['selectAllCheckbox','selectAllPublishedCheckbox','selectAllDeclinedCheckbox','selectAllArchivesCheckbox']
                        .forEach(cid => { const el = document.getElementById(cid); if (el) el.checked = false; });
                    if (typeof showNotification === 'function') {
                        if (failures.length === 0) {
                            showNotification('Selected positions deleted successfully', 'success');
                        } else {
                            showNotification(`Deleted with ${failures.length} error(s) – check console`, 'error');
                        }
                    }
                })();
            }
        }

        // Search functions for different tabs
        function searchPublishedPositions() {
            const searchInput = document.getElementById('publishedSearchInput');
            const searchTerm = searchInput.value.toLowerCase();
            
            const publishedData = recruitmentData.filter(position => {
                const status = (position.status || position.approvalStatus || '').toLowerCase();
                const matchesStatus = status === 'approved' || status === 'released' || status === 'published';
                const matchesSearch = !searchTerm || 
                    (position.jobTitle && position.jobTitle.toLowerCase().includes(searchTerm)) ||
                    (position.department && position.department.toLowerCase().includes(searchTerm)) ||
                    (position.employmentType && position.employmentType.toLowerCase().includes(searchTerm));
                
                return matchesStatus && matchesSearch;
            });
            
            renderTableData(publishedData, 'publishedTableBody', null, 'publishedLoadingState');
        }

        function searchDeclinedPositions() {
            const searchInput = document.getElementById('declinedSearchInput');
            const searchTerm = searchInput.value.toLowerCase();
            
            const declinedData = recruitmentData.filter(position => {
                const status = (position.status || position.approvalStatus || '').toLowerCase();
                const matchesStatus = status === 'declined' || status === 'rejected';
                const matchesSearch = !searchTerm || 
                    (position.jobTitle && position.jobTitle.toLowerCase().includes(searchTerm)) ||
                    (position.department && position.department.toLowerCase().includes(searchTerm)) ||
                    (position.employmentType && position.employmentType.toLowerCase().includes(searchTerm));
                
                return matchesStatus && matchesSearch;
            });
            
            renderTableData(declinedData, 'declinedTableBody', null, 'declinedLoadingState');
        }

        function searchArchivedPositions() {
            const searchInput = document.getElementById('archiveSearchInput');
            const searchTerm = searchInput.value.toLowerCase();
            
            const archivedData = recruitmentData.filter(position => {
                const matchesArchived = position.isArchived === true;
                const matchesSearch = !searchTerm || 
                    (position.jobTitle && position.jobTitle.toLowerCase().includes(searchTerm)) ||
                    (position.department && position.department.toLowerCase().includes(searchTerm)) ||
                    (position.employmentType && position.employmentType.toLowerCase().includes(searchTerm));
                
                return matchesArchived && matchesSearch;
            });
            
            renderTableData(archivedData, 'archiveTableBody', null, 'archiveLoadingState');
        }

        // Export functions for different tabs
        function exportPublishedData() {
            const publishedData = recruitmentData.filter(position => {
                const status = (position.status || position.approvalStatus || '').toLowerCase();
                return status === 'approved' || status === 'released' || status === 'published';
            });
            exportData(publishedData, 'published_positions');
        }

        function exportDeclinedData() {
            const declinedData = recruitmentData.filter(position => {
                const status = (position.status || position.approvalStatus || '').toLowerCase();
                return status === 'declined' || status === 'rejected';
            });
            exportData(declinedData, 'declined_positions');
        }

        function exportArchivedData() {
            const archivedData = recruitmentData.filter(position => {
                return position.isArchived === true;
            });
            exportData(archivedData, 'archived_positions');
        }

        // Format functions
        function formatEmploymentType(type) {
            if (!type) return 'N/A';
            const typeMap = {
                'full-time': 'Full-time',
                'part-time': 'Part-time',
                'contract': 'Contract',
                'temporary': 'Temporary',
                'internship': 'Internship'
            };
            return typeMap[type.toLowerCase()] || type;
        }

        function formatSalaryRange(min, max) {
            if (!min && !max) return 'N/A';
            if (!min) return `Up to $${max.toLocaleString()}`;
            if (!max) return `$${min.toLocaleString()}+`;
            return `$${min.toLocaleString()} - $${max.toLocaleString()}`;
        }

        function formatPriority(priority) {
            if (!priority) return 'Low';
            const priorityMap = {
                'low': 'Low',
                'medium': 'Medium',
                'high': 'High',
                'urgent': 'Urgent'
            };
            return priorityMap[priority.toLowerCase()] || priority;
        }

        function formatStatus(status) {
            if (!status) return 'Pending';
            const statusMap = {
                'pending': 'Pending',
                'approved': 'Approved',
                'declined': 'Declined',
                'rejected': 'Rejected',
                'released': 'Released',
                'filled': 'Filled',
                'active': 'Active',
                'published': 'Published',
                'closed': 'Closed'
            };
            return statusMap[status.toLowerCase()] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Ensure Line Manager displays only full name (no title/department)
        function formatLineManagerName(val) {
            if (!val) return '';
            try {
                let s = String(val).trim();
                // Remove trailing parentheses/brackets content like (HR Manager) or [Finance]
                s = s.replace(/\s*[\(\[].*?[\)\]]\s*$/g, '').trim();
                // If an email is present, remove it
                s = s.replace(/\b[\w.+-]+@[\w.-]+\.[A-Za-z]{2,}\b/g, '').trim();
                // Split on common separators and keep the first segment as the name
                const first = (s.split(/\s*[-–—|,\/]\s*/)[0] || s).trim();
                return first || (val + '').trim();
            } catch (_) {
                return (val + '').trim();
            }
        }

        // Action functions
        function viewDetails(positionId) {
            console.log('Viewing details for position:', positionId);
            // Add actual implementation for viewing position details
            alert(`Viewing details for position: ${positionId}`);
        }

        function approvePosition(positionId) {
            if (confirm('Are you sure you want to approve this position?')) {
                console.log('Approving position:', positionId);
                // Add actual implementation for approving position
                alert(`Position ${positionId} approved successfully!`);
                // Refresh the current view
                refreshCurrentTab();
            }
        }

        function declinePosition(positionId) {
            if (confirm('Are you sure you want to decline this position?')) {
                console.log('Declining position:', positionId);
                // Add actual implementation for declining position
                alert(`Position ${positionId} declined.`);
                // Refresh the current view
                refreshCurrentTab();
            }
        }

        function fillPosition(positionId) {
            if (confirm('Mark this position as filled?')) {
                console.log('Filling position:', positionId);
                // Add actual implementation for filling position
                alert(`Position ${positionId} marked as filled!`);
                // Refresh the current view
                refreshCurrentTab();
            }
        }

        function refreshCurrentTab() {
            // Refresh the current active tab
            const currentTabData = getCurrentTabData();
            renderTableData(currentTabData, getCurrentTabTableId(), null, getCurrentTabLoadingStateId());
        }

        function getCurrentTabData() {
            switch (currentActiveTab) {
                case 'pending':
                    return recruitmentData.filter(position => {
                        const status = (position.status || position.approvalStatus || '').toLowerCase();
                        return status === 'pending' || status === '' || status === 'new';
                    });
                case 'approved':
                    return recruitmentData.filter(position => {
                        const status = (position.status || position.approvalStatus || '').toLowerCase();
                        return status === 'approved' || status === 'released' || status === 'published';
                    });
                case 'declined':
                    return recruitmentData.filter(position => {
                        const status = (position.status || position.approvalStatus || '').toLowerCase();
                        return status === 'declined' || status === 'rejected';
                    });
                case 'archives':
                    return recruitmentData.filter(position => position.isArchived === true);
                default:
                    return recruitmentData;
            }
        }

        function getCurrentTabTableId() {
            switch (currentActiveTab) {
                case 'pending': return 'recruitmentTableBody';
                case 'approved': return 'approvedTableBody';
                case 'declined': return 'declinedTableBody';
                case 'archives': return 'archiveTableBody';
                default: return 'recruitmentTableBody';
            }
        }

        function getCurrentTabLoadingStateId() {
            switch (currentActiveTab) {
                case 'pending': return 'pendingLoadingState';
                case 'published': return 'publishedLoadingState';
                case 'declined': return 'declinedLoadingState';
                case 'archives': return 'archiveLoadingState';
                default: return 'pendingLoadingState';
            }
        }

        // Export data function
        function exportData(data, filename = 'recruitment_data') {
            const csvContent = convertToCSV(data);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function convertToCSV(data) {
            const headers = ['Job Title', 'Department', 'Employment Type', 'Salary Range', 'Priority', 'Status', 'Posted Date'];
            const csvRows = [headers.join(',')];
            
            data.forEach(position => {
                const row = [
                    `"${position.jobTitle || ''}"`,
                    `"${position.department || ''}"`,
                    `"${formatEmploymentType(position.employmentType)}"`,
                    `"${formatSalaryRange(position.salaryMin, position.salaryMax)}"`,
                    `"${formatPriority(position.priority || position.urgency)}"`,
                    `"${formatStatus(position.status || position.approvalStatus)}"`,
                    `"${formatDate(getDisplayDate(position))}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }
        function formatEmploymentType(type) {
            const types = {
                'direct': 'Direct',
                'indirect': 'Indirect',
                'contract': 'Contract',
                'temporary': 'Temporary'
            };
            return types[type] || type;
        }

        function formatPriority(priority) {
            const priorities = {
                'urgent': 'Urgent',
                'high': 'High',
                'medium': 'Medium',
                'low': 'Low'
            };
            return priorities[priority] || priority;
        }        function formatStatus(status) {
            const statuses = {
                'open': 'Open',
                'filled': 'Filled'
            };
            return statuses[status] || status;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            
            return new Date(dateString).toLocaleString('en-US', options);
        }        function formatSalaryRange(min, max) {
            if (min === 0 && max === 0) return 'Not specified';
            if (min === max) return `$${min.toLocaleString()}`;
            return `$${min.toLocaleString()} - $${max.toLocaleString()}`;
        }

        // Format date for HTML date input (YYYY-MM-DD format)        // Helper function to format date for HTML date input
        function formatDateForInput(dateString) {
            if (!dateString) {
                console.log('formatDateForInput: Empty or null date string');
                return '';
            }
            
            try {
                // Handle various date formats
                let date;
                
                // If it's already a Date object
                if (dateString instanceof Date) {
                    date = dateString;
                } else if (typeof dateString === 'string') {
                    // Handle ISO strings, timestamp strings, etc.
                    date = new Date(dateString);
                } else if (typeof dateString === 'number') {
                    // Handle timestamp numbers
                    date = new Date(dateString);
                } else {
                    console.warn('formatDateForInput: Unsupported date format:', typeof dateString, dateString);
                    return '';
                }
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.warn('formatDateForInput: Invalid date:', dateString);
                    return '';
                }
                
                // Format as YYYY-MM-DD for HTML date input
                const formatted = date.toISOString().split('T')[0];
                console.log('formatDateForInput: Formatted', dateString, '→', formatted);
                return formatted;
                
            } catch (error) {
                console.error('formatDateForInput: Error formatting date:', error, 'Input:', dateString);
                return '';
            }
        }        // View details function
        function viewDetails(positionId) {
            const position = recruitmentData.find(pos => pos.id === positionId);
            if (!position) return;
            
            currentViewingPositionId = positionId;

            // Debug: Log position data to console
            console.log('Position data for modal:', position);
            console.log('Start date:', position.startDate);
            console.log('Priority:', position.priority);

            // Format position code to match staff.html format
            const formattedPositionCode = position.positionCode || `POS${position.id.replace(/[^0-9]/g, '')}`;
              // Populate detail fields
            const detailContent = `
            <style>
                #viewDetailsContent{ display:flex; justify-content:center; align-items:flex-start; overflow:auto; padding:12px; background:#f5f6fa; }
                #viewDetailsContent .a4-sheet{ position:relative; width:210mm; min-height:297mm; margin:0 auto; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 1px 3px rgba(0,0,0,0.04); padding:5mm 5mm 18mm; box-sizing:border-box; color:#111827; }
                #viewDetailsContent .sheet-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
                #viewDetailsContent .company-block{display:flex;flex-direction:row;align-items:center;gap:12px;}
                #viewDetailsContent .company-info{display:flex;flex-direction:column;gap:4px;}
                #viewDetailsContent .sheet-logo{width:52px;height:52px;border-radius:8px;object-fit:contain;background:#fff;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:600;color:#444;}
                #viewDetailsContent .doc-title{font-size:.95rem;font-weight:700;margin:0;color:#111827;}
                #viewDetailsContent .divider{height:1px;background:#e5e7eb;margin:10px 0;}
                #viewDetailsContent .meta-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:4px 0 10px;}
                #viewDetailsContent .meta-item{display:flex;flex-direction:column;min-width:110px;}
                #viewDetailsContent .meta-label{font-size:.58rem;font-weight:700;color:#6b7280;}
                #viewDetailsContent .meta-value{font-size:.72rem;color:#111827;}
                #viewDetailsContent .section-title{font-size:.75rem;margin:0 0 6px;display:flex;align-items:center;gap:6px;font-weight:600;color:#1f2937;}
                #viewDetailsContent .info-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:6px;}
                #viewDetailsContent .info-item{display:grid;grid-template-columns:max-content 1fr;column-gap:6px;row-gap:2px;}
                #viewDetailsContent .info-item.single-line span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;}
                #viewDetailsContent .info-item.single-line label{white-space:nowrap;}
                #viewDetailsContent .info-item.full-row{grid-column:1 / -1;}
                #viewDetailsContent .info-item.duo{grid-column:1 / -1;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));column-gap:20px;row-gap:4px;align-items:start;}
                #viewDetailsContent .info-item.duo .sub{display:grid;grid-template-columns:max-content 1fr;column-gap:6px;row-gap:2px;}
                #viewDetailsContent .info-item.duo .sub label{font-size:.7rem;font-weight:700;color:#6b7280;}
                #viewDetailsContent .info-item.duo .sub label::after{content:':' ;margin-left:3px;color:#9ca3af;}
                #viewDetailsContent .info-item.duo .sub span{font-size:.7rem;color:#111827;}
                #viewDetailsContent .info-item label{font-size:.7rem;font-weight:700;color:#6b7280;}
                #viewDetailsContent .info-item label::after{content:':';margin-left:3px;color:#9ca3af;}
                #viewDetailsContent .info-item span{font-size:.7rem;color:#111827;}
                #viewDetailsContent .paragraph-block{font-size:.7rem;line-height:1.4;color:#4a4f54;background:#f8f9fa;padding:.55rem .7rem;border:1px solid #e5e7eb;border-radius:4px;}
                #viewDetailsContent .attachment-list{display:flex;flex-direction:column;gap:6px;margin-top:4px;}
                #viewDetailsContent .attachment-item{display:flex;align-items:center;gap:8px;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#fafafa;font-size:.7rem;}
                #viewDetailsContent .status-chip{display:inline-block;font-size:.55rem;font-weight:600;letter-spacing:.02em;color:#374151;background:transparent;border:none;padding:0;border-radius:0;}
                #viewDetailsContent .status-chip.approved{color:#166534;}#viewDetailsContent .status-chip.declined{color:#991b1b;}#viewDetailsContent .status-chip.pending{color:#92400e;}
            </style>
            <div class="a4-sheet">
                <div class="sheet-header">
                    <div class="company-block">
                        <div id="mdCompanyLogoPH" class="sheet-logo">DL</div>
                        <img id="mdCompanyLogo" class="sheet-logo" alt="Company Logo" style="display:none;"/>
                        <div class="company-info">
                            <h1 id="mdCompanyName" style="margin:0;font-size:1rem;">Company Name</h1>
                            <h2 class="doc-title" id="mdDocTitle">Authority to Recruit</h2>
                        </div>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="meta-row">
                    <div class="meta-item"><span class="meta-label">Position Code</span><span class="meta-value" id="mdDocNumber"></span></div>
                    <div class="meta-item"><span class="meta-label">Department</span><span class="meta-value">${position.department || 'N/A'}</span></div>
                    <div class="meta-item"><span class="meta-label">Status</span><span class="meta-value"><span class="status-chip ${((position.status||'').toLowerCase())}">${formatStatus(position.status) || 'N/A'}</span></span></div>
                    <div class="meta-item"><span class="meta-label">Employment Type</span><span class="meta-value">${formatEmploymentType(position.employmentType || position.employment_type || position.type) || 'N/A'}</span></div>
                    <div class="meta-item"><span class="meta-label">Location</span><span class="meta-value">${position.workLocation || position.location || 'N/A'}</span></div>
                </div>
                <div class="divider"></div>
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-briefcase"></i> Position Details</h2>
                    <div class="info-grid" id="mdPosInfo"></div>
                </div>
                <div class="divider"></div>
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-calendar-alt"></i> Timeline</h2>
                    <div class="info-grid">
                        <div class="info-item"><label>Start Date</label><span>${formatDate(position.startDate) || 'N/A'}</span></div>
                        <div class="info-item"><label>End Date</label><span>${formatDate(position.endDate) || 'N/A'}</span></div>
                        <div class="info-item"><label>${currentActiveTab === 'published' ? 'Published Date' : 'Posted Date'}</label><span>${formatDate(currentActiveTab === 'published' ? (position.publishedDate || position.postedDate) : position.postedDate) || 'N/A'}</span></div>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-coins"></i> Compensation</h2>
                    <div class="info-grid">
                        <div class="info-item"><label>Salary Range</label><span>${position.salaryMin ? '$'+Number(position.salaryMin).toLocaleString() : 'N/A'} ${position.salaryMax ? ' - $'+Number(position.salaryMax).toLocaleString() : ''}</span></div>
                        <div class="info-item"><label>Working Hours</label><span>${position.workingHours || 'N/A'}</span></div>
                    </div>
                </div>
                <div class="divider"></div>
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-users"></i> Recruitment</h2>
                    <div class="info-grid">
                        <div class="info-item"><label>Reason</label><span>${position.recruitmentReason || position.reason || position.hiringReason || position.requestReason || 'N/A'}</span></div>
                        <div class="info-item"><label>Advertise</label><span>${(() => { if (position.advertiseOptionLabel) return position.advertiseOptionLabel; const v = (position.advertiseOption || '').toLowerCase(); if (v === 'external-internal') return 'Yes - External & Internal'; if (v === 'internal-only') return 'Yes - Internal Only'; if (v === 'no-advertise') return 'No - Do Not Advertise'; return 'N/A'; })()}</span></div>
                    </div>
                </div>
                ${position.jobDescription ? `<div class="divider"></div><div class="section"><h2 class=\"section-title\">Job Description</h2><div class=\"paragraph-block\">${position.jobDescription}</div></div>` : ''}
                ${position.requiredSkills ? `<div class="divider"></div><div class="section"><h2 class=\"section-title\">Required Skills & Competencies</h2><div class=\"paragraph-block\">${position.requiredSkills}</div></div>` : ''}
                ${position.notes ? `<div class="divider"></div><div class="section"><h2 class=\"section-title\">Additional Notes</h2><div class=\"paragraph-block\">${position.notes}</div></div>` : ''}
                ${(position.attachments && position.attachments.length > 0) ? `<div class="divider"></div><div class="section"><h2 class=\"section-title\">Attachments</h2><div class=\"attachment-list\">${position.attachments.map(a => `<div class='attachment-item'><i class='fas fa-file'></i> ${a.name || a}</div>`).join('')}</div></div>` : ''}
                <div class="divider"></div>
                <div class="section" id="approvalSection">
                    <h2 class="section-title"><i class="fas fa-project-diagram"></i> Approval Flow</h2>
                    <div class="approval-flow-container">
                        <div class="approval-type" title="Approval flow type will be displayed here">
                            <i class="fas fa-stream"></i> Loading approval flow...
                        </div>
                        <div class="approval-levels"></div>
                    </div>
                </div>
            </div>`;

            const contentEl = document.getElementById('viewDetailsContent');
            if(contentEl) contentEl.innerHTML = detailContent;

            // Populate dynamic company logo/name similar to staff.html logic
            (function populateCompanyHeader(pos){
                try {
                    let cName = pos.companyName || (pos.company && (pos.company.name || pos.company.title)) || pos.orgName || pos.organizationName || pos.clientName || '';
                    let cLogo = pos.companyLogoUrl || pos.companyLogo || (pos.company && (pos.company.logoUrl || pos.company.logo)) || pos.logoUrl || pos.companyLogoURL || '';
                    if (!cName || !cLogo) {
                        try {
                            const stored = JSON.parse(localStorage.getItem('currentCompanyData') || sessionStorage.getItem('currentCompanyData') || 'null');
                            if (stored) {
                                if (!cName && (stored.companyName || stored.name)) cName = stored.companyName || stored.name;
                                if (!cLogo && (stored.logoUrl || stored.logo || stored.companyLogoUrl)) {
                                    cLogo = stored.logoUrl || stored.logo || stored.companyLogoUrl;
                                }
                            }
                        } catch(_) {}
                    }
                    if (!cName || !cLogo) {
                        try {
                            const hdrNameEl = document.getElementById('headerCompanyName');
                            const hdrLogoEl = document.getElementById('headerCompanyLogo');
                            if (!cName && hdrNameEl && hdrNameEl.textContent) cName = hdrNameEl.textContent.trim();
                            if (!cLogo && hdrLogoEl && hdrLogoEl.src) cLogo = hdrLogoEl.src;
                        } catch(_) {}
                    }
                    const nameEl = document.getElementById('mdCompanyName'); if (cName && nameEl) nameEl.textContent = cName;
                    if (cLogo) {
                        const img = document.getElementById('mdCompanyLogo'); if(img){ img.src=cLogo; img.style.display='block'; }
                        const ph = document.getElementById('mdCompanyLogoPH'); if(ph){ ph.style.display='none'; }
                    } else {
                        const ph = document.getElementById('mdCompanyLogoPH'); if(ph){ const base=(cName||'CN').split(/\s+/).map(w=>w[0]).slice(0,3).join('').toUpperCase(); ph.textContent=base; }
                    }
                    const docNumEl = document.getElementById('mdDocNumber'); if(docNumEl) docNumEl.textContent = formattedPositionCode || 'N/A';
                    const docTitleEl = document.getElementById('mdDocTitle'); if(docTitleEl) docTitleEl.textContent = pos.jobTitle ? `Authority to Recruit: ${pos.jobTitle}` : 'Authority to Recruit';
                    // Populate position detail grid (selected key attributes)
                    const grid = document.getElementById('mdPosInfo');
                    if(grid){
                        function stripDuplicateDept(lm, dept){
                            try {
                                if (!lm || !dept) return lm || '';
                                const escapeRe = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                                const norm = s => (s||'').toString().toLowerCase().replace(/[^a-z0-9]/g,'');
                                const deptNorm = norm(dept);
                                let out = lm;
                                // Remove common trailing patterns
                                const reDept = new RegExp(escapeRe(dept), 'i');
                                const patterns = [
                                    new RegExp(`\\s*[-–—]\\s*${escapeRe(dept)}\\s*$`, 'i'),
                                    new RegExp(`\\s*[/|,]\\s*${escapeRe(dept)}\\s*$`, 'i'),
                                    new RegExp(`\\s*\\(${escapeRe(dept)}\\)\\s*$`, 'i'),
                                    new RegExp(`\\s*\\[${escapeRe(dept)}\\]\\s*$`, 'i')
                                ];
                                patterns.forEach(p => { out = out.replace(p,''); });
                                // Token-based removal for variants like Human-Capital vs Human Capital
                                const tokens = out.split(/\s*[-–—,\/()\[\]]\s*/).filter(Boolean);
                                if (tokens.length > 1) {
                                    const kept = tokens.filter(t => norm(t) && norm(t) !== deptNorm);
                                    if (kept.length) out = kept.join(' - ');
                                }
                                out = out.replace(/\s{2,}/g,' ').replace(/\s*[-–—,\/()\[\]]+\s*$/,'').trim();
                                // If entire value equals department after normalization, clear it
                                if (!out || norm(out) === deptNorm) return '';
                                return out || lm;
                            } catch { return lm || ''; }
                        }
                        // Removed Job Title and Department from Position Details per requirements
                        const items = [];
                        let html = items.map(([lbl,val,sl]) => {
                            const safeVal = val || 'N/A';
                            const clazz = sl ? 'info-item single-line' : 'info-item';
                            const titleAttr = `title="${(safeVal+'').replace(/"/g,'&quot;')}"`;
                            return `<div class='${clazz}'><label>${lbl}</label><span ${titleAttr}>${safeVal}</span></div>`;
                        }).join('');
                        // Duo row for Employment Type + Location
                        const empType = formatEmploymentType(pos.employmentType || pos.employment_type || pos.type) || 'N/A';
                        const loc = (pos.workLocation || pos.location || 'N/A');
                        html += `<div class='info-item duo'><div class='sub'><label>Employment Type</label><span>${empType}</span></div><div class='sub'><label>Location</label><span>${loc}</span></div></div>`;
                        // Duo row for Priority + Reason
                        const prio = formatPriority(pos.priority || pos.urgency) || 'N/A';
                        const reason = (pos.recruitmentReason || pos.reason || pos.hiringReason || pos.requestReason || 'N/A');
                        html += `<div class='info-item duo'><div class='sub'><label>Priority</label><span>${prio}</span></div><div class='sub'><label>Reason</label><span>${reason}</span></div></div>`;
                        // Add Line Manager row back into Position Details
                        try {
                            const lmValueRaw = pos.lineManager || '';
                            const strippedDept = stripDuplicateDept(lmValueRaw, pos.department || '');
                            const lmValue = formatLineManagerName(strippedDept);
                            const safeLm = (lmValue || '').toString();
                            const lmTitle = (safeLm || 'N/A').replace(/"/g, '&quot;');
                            html += `<div class='info-item'><label>Line Manager</label><span title="${lmTitle}">${safeLm || 'N/A'}</span></div>`;
                        } catch(_) {
                            html += `<div class='info-item'><label>Line Manager</label><span>N/A</span></div>`;
                        }
                        grid.innerHTML = html;
                    }
                } catch(err) { console.warn('Company header population failed', err); }
            })(position);

            // Add action buttons to modal
            const modalActionButtons = document.getElementById('modalActionButtons');
            modalActionButtons.innerHTML = '';
            
            // Check if current user is an approver for this position
            const currentUserId = getCurrentUserId();
            let isCurrentUserApprover = false;
            let isCurrentUserNextLevelApprover = false; // for sequential flows
            let approvalOrderType = '';
            let approverStatusReady = false; // avoids flicker before async check completes
            let lastButtonsSignature = '';
            
            // We'll check this after loading the approval flow
            const checkApproverStatus = async () => {
                try {
                    approverStatusReady = false;
                    const approvalFlow = await window.fetchRecruitmentApprovalFlow(position.id);
                    if (approvalFlow && approvalFlow.levels) {
                        approvalOrderType = String(approvalFlow.approvalOrder || '').toLowerCase();
                        const norm = v => String(v||'').toLowerCase();
                        const curEmail = norm(typeof getCurrentUserEmail === 'function' ? (getCurrentUserEmail() || '') : '');
                        const globalUserId = getCurrentUserId();
                        const companyUserId = await getCurrentUserIdWithCompanyContext();
                        const idMatches = (val) => (val === globalUserId || val === companyUserId);
                        // Check if current user is an approver in any level
                        for (const level of approvalFlow.levels) {
                            for (const approver of level.approvers) {
                                // Direct ID matches
                                const directMatch = (
                                    (approver.value?.startsWith('user_') && idMatches(approver.value.replace('user_',''))) ||
                                    idMatches(approver.userId) ||
                                    idMatches(approver.approverId) ||
                                    idMatches(approver.value) ||
                                    (curEmail && (norm(approver.email||approver.approverEmail||approver.userEmail||approver.value) === curEmail))
                                );

                                // L+1 functional match (when level defines L+1 and current user is the line manager)
                                const isLPlusOne = (
                                    (approver.value || '').toString().toLowerCase().includes('l+1') ||
                                    (approver.role || '').toString().toLowerCase().includes('l+1') ||
                                    (approver.label || '').toString().toLowerCase().includes('l+1') ||
                                    (approver.text || '').toString().toLowerCase().includes('l+1')
                                );
                                let lPlusOneMatch = false;
                                if (isLPlusOne && position) {
                                    try {
                                        const lmRaw = (position.lineManager || '').toString().trim();
                                        const lmLower = lmRaw.toLowerCase();
                                        const curEmail = (typeof getCurrentUserEmail === 'function' ? (getCurrentUserEmail() || '') : '').toLowerCase();
                                        // Prefer email equality if LM stored as email
                                        if (lmLower && lmLower.includes('@') && curEmail && lmLower === curEmail) {
                                            lPlusOneMatch = true;
                                        } else if (window.authManager && typeof window.authManager.getUserDisplayName === 'function') {
                                            const curName = (window.authManager.getUserDisplayName() || '').toString().trim().toLowerCase();
                                            if (curName && lmLower && (curName === lmLower || curName.includes(lmLower) || lmLower.includes(curName))) {
                                                lPlusOneMatch = true;
                                            }
                                        }
                                    } catch (_) { /* no-op */ }
                                }

                                if (directMatch || lPlusOneMatch) {
                                    isCurrentUserApprover = true;
                                    break;
                                }
                            }
                            if (isCurrentUserApprover) break;
                        }

                        // If sequential, also compute if user is approver on the next unlocked level
                        if (approvalOrderType === 'sequential') {
                            const normStatus = s => String(s||'').toLowerCase();
                            const levels = approvalFlow.levels || [];
                            const nextIdx = levels.findIndex(l => {
                                const st = normStatus(l.status);
                                return st === 'pending' || st === 'partially-approved';
                            });
                            if (nextIdx >= 0) {
                                const level = levels[nextIdx];
                                for (const approver of (level.approvers || [])) {
                                    const directMatch = (
                                        (approver.value?.startsWith('user_') && idMatches(approver.value.replace('user_',''))) ||
                                        idMatches(approver.userId) ||
                                        idMatches(approver.approverId) ||
                                        idMatches(approver.value) ||
                                        (curEmail && (norm(approver.email||approver.approverEmail||approver.userEmail||approver.value) === curEmail))
                                    );
                                    let lPlusOneMatch = false;
                                    const isLPlusOne = (
                                        (approver.value || '').toString().toLowerCase().includes('l+1') ||
                                        (approver.role || '').toString().toLowerCase().includes('l+1') ||
                                        (approver.label || '').toString().toLowerCase().includes('l+1') ||
                                        (approver.text || '').toString().toLowerCase().includes('l+1')
                                    );
                                    if (isLPlusOne && position) {
                                        try {
                                            const lmRaw = (position.lineManager || '').toString().trim();
                                            const lmLower = lmRaw.toLowerCase();
                                            if (lmLower && lmLower.includes('@') && curEmail && lmLower === curEmail) {
                                                lPlusOneMatch = true;
                                            } else if (window.authManager && typeof window.authManager.getUserDisplayName === 'function') {
                                                const curName = (window.authManager.getUserDisplayName() || '').toString().trim().toLowerCase();
                                                if (curName && lmLower && (curName === lmLower || curName.includes(lmLower) || lmLower.includes(curName))) {
                                                    lPlusOneMatch = true;
                                                }
                                            }
                                        } catch (_) { /* no-op */ }
                                    }
                                    const approverPending = normStatus(approver.status) === 'pending';
                                    if ((directMatch || lPlusOneMatch) && approverPending) {
                                        isCurrentUserNextLevelApprover = true;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Could not check approver status:', error);
                    // Default to showing buttons if we can't check (for backward compatibility)
                    isCurrentUserApprover = true;
                } finally {
                    approverStatusReady = true;
                    updateModalButtons();
                }
            };
            
            const updateModalButtons = () => {
                // For sequential flows, avoid drawing before approver status is ready
                if (String(approvalOrderType||'').toLowerCase() === 'sequential' && !approverStatusReady) {
                    return;
                }
                // Clear existing dynamic buttons (keep the close button)
                const existingButtons = modalActionButtons.querySelectorAll('.btn');
                existingButtons.forEach(btn => btn.remove());
                
                // Check current tab and position status
                const currentStatus = (position.status || position.approvalStatus || '').toLowerCase();
                const isPublishedStatus = currentStatus === 'published' || currentStatus === 'approved' || currentStatus === 'released';
                const isPendingLike = !isPublishedStatus && (
                    currentStatus === 'pending' || currentStatus === 'requested' || currentStatus === 'new' || currentStatus === ''
                );
                const perms = (window._recruitEffectivePerms || {});
                // Approval configuration gate: only configured approvers can see approve/decline
                const approverEmails = (window._recruitApprovalConfig && Array.isArray(window._recruitApprovalConfig.approvers)) ? window._recruitApprovalConfig.approvers : [];
                const curEmail = (typeof getCurrentUserEmail === 'function' ? (getCurrentUserEmail() || '') : '').toLowerCase();
                const isApproverConfigured = approverEmails.length === 0 ? true : approverEmails.includes(curEmail);

                // Gating rules:
                // - If approval is sequential, only show buttons when user is approver in the next unlocked level
                // - Otherwise, allow if user is assigned anywhere in the flow OR config is permissive/explicitly includes the user
                const isSequential = String(approvalOrderType || '').toLowerCase() === 'sequential';
                const isAssignedApprover = !!isCurrentUserApprover;
                const isInConfig = approverEmails.includes(curEmail);
                const permissiveConfig = approverEmails.length === 0; // empty list means no restriction
                const flowGate = isSequential ? !!isCurrentUserNextLevelApprover : (isAssignedApprover || permissiveConfig || isInConfig);
                const canSeeApprovalActions = isPendingLike && flowGate;
                const canApprove = (perms.approve !== false); // undefined or true => allow
                const canDecline = (perms.decline !== false);

                // Skip DOM churn if nothing changed
                const signature = [currentStatus, isSequential, isAssignedApprover, isInConfig, permissiveConfig, flowGate, canSeeApprovalActions, canApprove, canDecline].join('|');
                if (signature === lastButtonsSignature) {
                    return;
                }
                lastButtonsSignature = signature;

                if (canSeeApprovalActions) {
                    if (canApprove) {
                        const approveBtn = document.createElement('button');
                        approveBtn.type = 'button';
                        approveBtn.className = 'btn btn-success';
                        approveBtn.onclick = () => approvePosition(position.id);
                        approveBtn.title = 'Approve Position';
                        approveBtn.innerHTML = '<i class="fas fa-check"></i> Approve';
                        modalActionButtons.appendChild(approveBtn);
                    }
                    if (canDecline) {
                        const declineBtn = document.createElement('button');
                        declineBtn.type = 'button';
                        declineBtn.className = 'btn btn-danger';
                        declineBtn.onclick = () => declinePosition(position.id);
                        declineBtn.title = 'Decline Position';
                        declineBtn.innerHTML = '<i class="fas fa-times-circle"></i> Decline';
                        modalActionButtons.appendChild(declineBtn);
                    }
                }
                
                // Add Edit button for published positions in published tab
                if (currentActiveTab === 'published' && isPublishedStatus) {
                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'btn btn-warning';
                    editBtn.onclick = () => editPublishedJob(position.id);
                    editBtn.title = 'Edit Published Job';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Job';
                    modalActionButtons.appendChild(editBtn);
                }
                
                // Only add the Publish button if the status is not "published" and not in published tab
                // Additionally, hide Publish when created with advertiseOption = 'no-advertise'
                const isNoAdvertise = (position.source === 'recruit' && (position.advertiseOption || '').toLowerCase() === 'no-advertise');
                if (!isNoAdvertise && currentStatus !== 'published' && currentActiveTab !== 'published') {
                    const publishBtn = document.createElement('button');
                    publishBtn.type = 'button';
                    publishBtn.className = 'btn btn-primary';
                    publishBtn.onclick = () => viewJobDetails(position.id);
                    publishBtn.title = 'Publish Job';
                    publishBtn.innerHTML = '<i class="fas fa-chart-line"></i> Publish';
                    modalActionButtons.appendChild(publishBtn);
                }
            };
            
            // Defer button setup until approver status is computed to avoid flicker
            checkApproverStatus();
            
            openModal('viewDetailsModal');
            // Load approval flow section content after modal renders
            try { loadApprovalFlowForPosition(position.id, position); } catch (e) { console.warn('Approval flow load failed', e); }
        }

        // Open modal function
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            // Add a small delay to allow the display change to take effect
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        // Close modal function
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            // Wait for animation to complete before hiding
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        // Close view modal
        function closeViewModal() {
            closeModal('viewDetailsModal');
        }

        // Function to display approval flow type
        function displayApprovalFlowType(flowType, container, levelsCount = 0) {
            let flowTypeDisplay = '';
            let flowTypeClass = '';
            let flowTypeIcon = '';
            let flowTypeDescription = '';

            switch (flowType.toLowerCase()) {
                case 'sequential':
                    flowTypeClass = 'flow-type-sequential';
                    flowTypeIcon = 'fas fa-arrow-right';
                    flowTypeDisplay = 'Sequential';
                    flowTypeDescription = `Sequential approval flow - Each level must approve before the next level can act (${levelsCount} level${levelsCount !== 1 ? 's' : ''})`;
                    break;
                case 'parallel':
                    flowTypeClass = 'flow-type-parallel';
                    flowTypeIcon = 'fas fa-code-branch';
                    flowTypeDisplay = 'Parallel';
                    flowTypeDescription = `Parallel approval flow - All levels can approve simultaneously (${levelsCount} level${levelsCount !== 1 ? 's' : ''})`;
                    break;
                case 'mixed':
                    flowTypeClass = 'flow-type-mixed';
                    flowTypeIcon = 'fas fa-random';
                    flowTypeDisplay = 'Mixed';
                    flowTypeDescription = `Mixed approval flow - Combination of sequential and parallel processing (${levelsCount} level${levelsCount !== 1 ? 's' : ''})`;
                    break;
                default:
                    flowTypeClass = 'flow-type-sequential';
                    flowTypeIcon = 'fas fa-arrow-right';
                    flowTypeDisplay = 'Sequential';
                    flowTypeDescription = `Sequential approval flow - Each level must approve before the next level can act (${levelsCount} level${levelsCount !== 1 ? 's' : ''} - default)`;
                    break;
            }

            container.innerHTML = `
                <div class="flow-type-badge ${flowTypeClass}" title="${flowTypeDescription}">
                    <i class="${flowTypeIcon}"></i>
                    ${flowTypeDisplay}
                    ${levelsCount > 0 ? `<span style="margin-left: 0.5rem; font-size: 0.8rem; opacity: 0.8;">(${levelsCount} level${levelsCount !== 1 ? 's' : ''})</span>` : ''}
                </div>
            `;
        }

        // Helper function to display personnel cards
        // REMOVED: displayPersonnel function - People section removed from modal

        // Fallback function to get company personnel when approval flow is not available
        // REMOVED: getCompanyPersonnelFallback function - People section removed from modal

        // Close new recruitment modal
        function closeNewRecruitmentModal() {
            closeModal('newRecruitmentModal');
            
            // Clear the form
            const form = document.getElementById('newRecruitmentForm');
            if (form) {
                form.reset();
            }
            
            // Clear the file display
            const fileDisplay = document.getElementById('fileDisplay');
            if (fileDisplay) {
                fileDisplay.innerHTML = '';
            }
            
            console.log('✅ Recruitment modal closed and form cleared');
        }        // Open new recruitment modal
        function openNewRecruitmentModal() {
            console.log('Opening new recruitment modal...');
            
            // First open the modal to ensure DOM elements are available
            openModal('newRecruitmentModal');
            
            // Use setTimeout to ensure modal is fully rendered before accessing elements
            setTimeout(() => {
                try {                    // Validate that modal fields are available
                    const startDateInput = document.getElementById('newStartDate');
                    const endDateInput = document.getElementById('newEndDate');
                    const notesInput = document.getElementById('newNotes');
                    
                    if (!startDateInput) {
                        console.error('Start date input field not found in modal');
                        return;
                    }
                    
                    if (!endDateInput) {
                        console.error('End date input field not found in modal');
                        return;
                    }
                    
                    if (!notesInput) {
                        console.error('Additional notes input field not found in modal');
                        return;
                    }
                    
                    console.log('Date fields and additional notes field found successfully');
                    
                    // Initialize and display attachment field in real-time
                    const attachmentsInput = document.getElementById('newAttachments');
                    if (attachmentsInput) {
                        // Ensure attachment field is visible and properly styled
                        attachmentsInput.style.display = 'block';
                        attachmentsInput.style.visibility = 'visible';
                        
                        // Add real-time file selection display
                        attachmentsInput.addEventListener('change', function(event) {
                            const files = event.target.files;
                            console.log(`📎 Files selected: ${files.length}`);
                            
                            // Create or update file display
                            let fileDisplay = document.getElementById('fileDisplay');
                            if (!fileDisplay) {
                                fileDisplay = document.createElement('div');
                                fileDisplay.id = 'fileDisplay';
                                fileDisplay.style.marginTop = '0.5rem';
                                attachmentsInput.parentNode.appendChild(fileDisplay);
                            }
                            
                            if (files.length > 0) {
                                let fileListHTML = '<div class="selected-files"><small class="text-success"><i class="fas fa-check-circle"></i> Selected files:</small><ul class="file-list">';
                                
                                for (let i = 0; i < files.length; i++) {
                                    const file = files[i];
                                    const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                                    fileListHTML += `<li><i class="fas fa-file"></i> ${file.name} (${fileSize})</li>`;
                                }
                                
                                fileListHTML += '</ul></div>';
                                fileDisplay.innerHTML = fileListHTML;
                                
                                // Style the file list
                                const fileList = fileDisplay.querySelector('.file-list');
                                if (fileList) {
                                    fileList.style.listStyle = 'none';
                                    fileList.style.padding = '0.5rem';
                                    fileList.style.margin = '0.5rem 0';
                                    fileList.style.backgroundColor = '#f8f9fa';
                                    fileList.style.borderRadius = '4px';
                                    fileList.style.border = '1px solid #e9ecef';
                                }
                                
                                const listItems = fileDisplay.querySelectorAll('li');
                                listItems.forEach(item => {
                                    item.style.padding = '0.25rem 0';
                                    item.style.fontSize = '0.9rem';
                                    item.style.color = '#495057';
                                });
                            } else {
                                fileDisplay.innerHTML = '';
                            }
                        });
                        
                        console.log('✅ Attachment field initialized with real-time display');
                        console.log('Attachment field details:', {
                            id: attachmentsInput.id,
                            type: attachmentsInput.type,
                            accept: attachmentsInput.accept,
                            multiple: attachmentsInput.multiple,
                            visible: attachmentsInput.offsetParent !== null,
                            display: window.getComputedStyle(attachmentsInput).display
                        });
                    } else {
                        console.error('❌ Attachment field not found');
                    }
                    
                    // Ensure all fields start as editable when modal opens
                    makeAllFieldsEditable();
                    
                    populateJobTitleDropdown();
                    
                    // Set default start date to today with better error handling
                    const today = new Date();
                    const formattedToday = formatDateForInput(today.toISOString());
                    startDateInput.value = formattedToday;
                    console.log('Set default start date to:', formattedToday, 'Field value:', startDateInput.value);
                    
                    endDateInput.value = '';
                    console.log('Cleared end date field, Field value:', endDateInput.value);
                    
                    // Test date field functionality
                    console.log('Testing date field functionality...');
                    const testDate = '2024-06-15';
                    const testFormatted = formatDateForInput(testDate);
                    console.log('Test date formatting:', testDate, '→', testFormatted);
                    
                } catch (error) {
                    console.error('Error initializing modal fields:', error);
                    showNotification('Error initializing form fields', 'error');
                }            }, 150); // Increased delay to ensure modal is fully rendered
        }

        // Populate job title dropdown with released positions data
        async function populateJobTitleDropdown() {
            try {
                // Validate company context first
                const currentCompanyId = getCurrentCompanyId();
                if (!currentCompanyId) {
                    console.error('❌ Cannot populate job titles without company context');
                    const jobTitleSelect = document.getElementById('newJobTitle');
                    if (jobTitleSelect) {
                        jobTitleSelect.innerHTML = '<option value="">No company context available</option>';
                    }
                    return;
                }
                
                if (typeof firebase !== 'undefined' && firebase.database) {
                    // Query company-specific released staff data
                    const companyReleasedRef = firebase.database().ref(`companies/${currentCompanyId}/releasedStaff`);
                    const snapshot = await companyReleasedRef.once('value');
                    const releasedData = snapshot.val();
                    
                    const jobTitleSelect = document.getElementById('newJobTitle');
                    
                    if (!jobTitleSelect) {
                        console.error('Job title select element not found');
                        return;
                    }
                    
                    // Clear existing options
                    jobTitleSelect.innerHTML = '<option value="">Select Released Position</option>';
                    
                    if (releasedData) {
                        console.log(`📋 Processing ${Object.keys(releasedData).length} released staff records for company: ${currentCompanyId}`);
                        
                        // Get currently open recruitment positions to exclude from dropdown
                        const existingPositionCodes = new Set();
                        
                        // Collect position codes from current recruitment data
                        if (recruitmentData && recruitmentData.length > 0) {
                            recruitmentData.forEach(position => {
                                if (position.positionCode && position.positionCode.trim()) {
                                    existingPositionCodes.add(position.positionCode.trim());
                                }
                                if (position.id && position.id.trim()) {
                                    existingPositionCodes.add(position.id.trim());
                                }
                            });
                        }
                        
                        console.log('🚫 Existing position codes to exclude:', Array.from(existingPositionCodes));
                        
                        // Create a unique set of job titles with their associated data
                        // Only include released positions that are available for recruitment
                        const jobTitleMap = new Map();
                        let releasedCount = 0;
                        let availableCount = 0;
                        
                        Object.keys(releasedData).forEach(key => {
                            const staff = releasedData[key];
                            
                            // Check if position belongs to current company
                            if (staff.companyId && staff.companyId !== currentCompanyId) {
                                return; // Skip positions from other companies
                            }
                            
                            if (staff.jobTitle && staff.jobTitle.trim()) {
                                const jobTitle = staff.jobTitle.trim();
                                
                                // Include all released positions
                                releasedCount++;
                                
                                // Check if this position is already in recruitment board
                                const isAlreadyInRecruitment = 
                                    (staff.positionCode && existingPositionCodes.has(staff.positionCode.trim())) ||
                                    (staff.id && existingPositionCodes.has(staff.id.trim())) ||
                                    (key && existingPositionCodes.has(key));
                                
                                // Only include if not already in recruitment and not filled
                                if (!isAlreadyInRecruitment && staff.status !== 'filled') {
                                    availableCount++;
                                    
                                    // Store the most complete record for each job title
                                    if (!jobTitleMap.has(jobTitle) || 
                                        (staff.department && staff.lineManager && staff.workLocation)) {
                                        jobTitleMap.set(jobTitle, {
                                            ...staff,
                                            firebaseKey: key,
                                            companyId: currentCompanyId
                                        });
                                    }
                                }
                            }
                        });
                        
                        console.log(`📊 Job Title Summary for company ${currentCompanyId}:`, {
                            totalReleasedRecords: Object.keys(releasedData).length,
                            releasedPositions: releasedCount,
                            availableForRecruitment: availableCount,
                            uniqueJobTitles: jobTitleMap.size
                        });
                        
                        if (jobTitleMap.size === 0) {
                            jobTitleSelect.innerHTML = '<option value="">No released positions available for recruitment</option>';
                            console.warn('⚠️ No released positions available for recruitment');
                            return;
                        }
                        
                        // Sort job titles alphabetically
                        const sortedJobTitles = Array.from(jobTitleMap.keys()).sort();
                        
                        // Add options to the dropdown
                        sortedJobTitles.forEach(jobTitle => {
                            const staffData = jobTitleMap.get(jobTitle);
                            const option = document.createElement('option');
                            option.value = jobTitle;
                            option.textContent = `${jobTitle} (${staffData.department || 'No Dept'})`;
                            option.dataset.staffData = JSON.stringify(staffData);
                            jobTitleSelect.appendChild(option);
                        });
                        
                        console.log(`✅ Populated ${sortedJobTitles.length} released job titles from company: ${currentCompanyId}`);
                        
                        // Add event listener after dropdown is populated
                        jobTitleSelect.removeEventListener('change', handleJobTitleSelection);
                        jobTitleSelect.addEventListener('change', handleJobTitleSelection);
                        console.log('Job title selection event listener added');
                        
                        // Add event listener for position code dropdown
                        const positionCodeSelect = document.getElementById('newPositionCode');
                        if (positionCodeSelect) {
                            positionCodeSelect.removeEventListener('change', handlePositionCodeSelection);
                            positionCodeSelect.addEventListener('change', handlePositionCodeSelection);
                            console.log('Position code selection event listener added');
                        }
                        
                    } else {
                        jobTitleSelect.innerHTML = '<option value="">No released positions found</option>';
                        console.warn(`⚠️ No released staff data found for company: ${currentCompanyId}`);
                    }
                } else {
                    console.error('Firebase not available');
                    const jobTitleSelect = document.getElementById('newJobTitle');
                    if (jobTitleSelect) {
                        jobTitleSelect.innerHTML = '<option value="">Firebase not available</option>';
                    }
                }
            } catch (error) {
                console.error('Error populating job title dropdown:', error);
                const jobTitleSelect = document.getElementById('newJobTitle');
                if (jobTitleSelect) {
                    jobTitleSelect.innerHTML = '<option value="">Error loading positions</option>';
                }
            }
        }

        // Handle job title selection and auto-fill form fields
        function handleJobTitleSelection() {
            const jobTitleSelect = document.getElementById('newJobTitle');
            const positionCodeSelect = document.getElementById('newPositionCode');
            const selectedJobTitle = jobTitleSelect.value;
            
            console.log('Job title selection changed:', selectedJobTitle);
            
            // Clear position code dropdown
            positionCodeSelect.innerHTML = '<option value="">Select Position Code</option>';
            
            // Clear other form fields
            clearFormFields();
            
            if (selectedJobTitle) {
                // Populate position codes for the selected job title
                populatePositionCodeDropdown(selectedJobTitle);
            }
        }
        
        // Clear form fields when job title changes
        function clearFormFields() {
            const fieldsToClear = [
                'newDepartment', 'newLineManager', 'newWorkLocation', 
                'newSalaryMin', 'newSalaryMax', 'newEmploymentType', 
                'newEmploymentStatus', 'newWorkingHours', 'newStartDate', 'newEndDate',
                'newJobDescription', 'newRequiredEducation', 'newRequiredExperience', 'newRequiredSkills',
                'newNotes', 'newUrgency'
            ];
            
            fieldsToClear.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                }
            });
            
            // Also clear the attachment field and its display
            const attachmentField = document.getElementById('newAttachments');
            if (attachmentField) {
                attachmentField.value = '';
            }
            
            const fileDisplay = document.getElementById('fileDisplay');
            if (fileDisplay) {
                fileDisplay.innerHTML = '';
            }
            
            // Reset all fields to editable when clearing
            makeAllFieldsEditable();
        }
        
        // Make all fields read-only except recruitment reason when position is selected
        function makeFieldsReadOnlyExceptRecruitmentReason() {
            console.log('🔒 Making fields read-only except recruitment reason');
            
            // List of all form field IDs that should be made read-only
            const fieldsToMakeReadOnly = [
                'newDepartment', 'newLineManager', 'newWorkLocation', 
                'newSalaryMin', 'newSalaryMax', 'newEmploymentType', 
                'newEmploymentStatus', 'newWorkingHours', 'newStartDate', 'newEndDate',
                'newJobDescription', 'newRequiredEducation', 'newRequiredExperience', 'newRequiredSkills',
                'newNotes', 'newUrgency', 'newAttachments'
            ];
            
            // Make specified fields read-only
            fieldsToMakeReadOnly.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.readOnly = true;
                    field.disabled = false; // Keep enabled for form submission but read-only
                    field.style.backgroundColor = '#f8f9fa';
                    field.style.cursor = 'not-allowed';
                    
                    // Special handling for select elements
                    if (field.tagName.toLowerCase() === 'select') {
                        field.disabled = true;
                        field.style.backgroundColor = '#f8f9fa';
                        field.style.cursor = 'not-allowed';
                    }
                    
                    // Special handling for file inputs
                    if (field.type === 'file') {
                        field.disabled = true;
                        field.style.backgroundColor = '#f8f9fa';
                        field.style.cursor = 'not-allowed';
                    }
                }
            });
            
            // Ensure recruitment reason field stays editable
            const recruitmentReasonField = document.getElementById('newRecruitmentReason');
            if (recruitmentReasonField) {
                recruitmentReasonField.readOnly = false;
                recruitmentReasonField.disabled = false;
                recruitmentReasonField.style.backgroundColor = '';
                recruitmentReasonField.style.cursor = '';
            }
            
            // Add visual indication that fields are auto-filled
            const modal = document.getElementById('newRecruitmentModal');
            if (modal) {
                const existingNotice = modal.querySelector('.auto-fill-notice');
                if (!existingNotice) {
                    const notice = document.createElement('div');
                    notice.className = 'auto-fill-notice';
                    notice.style.cssText = `
                        background: #d1ecf1;
                        color: #0c5460;
                        padding: 0.75rem;
                        border-radius: 6px;
                        margin: 1rem 2rem;
                        border: 1px solid #bee5eb;
                        font-size: 0.9rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    `;
                    notice.innerHTML = `
                        <i class="fas fa-info-circle"></i>
                        <span>Fields have been auto-filled from the selected position. Only the recruitment reason can be modified.</span>
                    `;
                    
                    const modalBody = modal.querySelector('.modal-body');
                    if (modalBody) {
                        modalBody.insertBefore(notice, modalBody.firstChild);
                    }
                }
            }
            
            console.log('✅ Fields set to read-only except recruitment reason');
        }
        
        // Make all fields editable (used when clearing form)
        function makeAllFieldsEditable() {
            console.log('🔓 Making all fields editable');
            
            const allFieldIds = [
                'newDepartment', 'newLineManager', 'newWorkLocation', 
                'newSalaryMin', 'newSalaryMax', 'newEmploymentType', 
                'newEmploymentStatus', 'newWorkingHours', 'newStartDate', 'newEndDate',
                'newJobDescription', 'newRequiredEducation', 'newRequiredExperience', 'newRequiredSkills',
                'newNotes', 'newUrgency', 'newAttachments', 'newRecruitmentReason'
            ];
            
            // Make all fields editable
            allFieldIds.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.readOnly = false;
                    field.disabled = false;
                    field.style.backgroundColor = '';
                    field.style.cursor = '';
                }
            });
            
            // Remove auto-fill notice if it exists
            const modal = document.getElementById('newRecruitmentModal');
            if (modal) {
                const existingNotice = modal.querySelector('.auto-fill-notice');
                if (existingNotice) {
                    existingNotice.remove();
                }
            }
            
            console.log('✅ All fields set to editable');
        }
        
        // Populate position code dropdown based on selected job title from released positions
        async function populatePositionCodeDropdown(selectedJobTitle) {
            try {
                // Validate company context first
                const currentCompanyId = getCurrentCompanyId();
                if (!currentCompanyId) {
                    console.error('Company context not available for position code lookup');
                    const positionCodeSelect = document.getElementById('newPositionCode');
                    if (positionCodeSelect) {
                        positionCodeSelect.innerHTML = '<option value="">Company context required</option>';
                    }
                    return;
                }

                if (typeof firebase !== 'undefined' && firebase.database) {
                    console.log(`🏢 Loading position codes from company scope: companies/${currentCompanyId}/releasedStaff`);
                    
                    // Use company-scoped path for released staff data
                    const companyReleasedRef = firebase.database().ref(`companies/${currentCompanyId}/releasedStaff`);
                    const snapshot = await companyReleasedRef.once('value');
                    const releasedData = snapshot.val();
                    
                    const positionCodeSelect = document.getElementById('newPositionCode');
                    
                    if (!positionCodeSelect) {
                        console.error('Position code select element not found');
                        return;
                    }
                    
                    if (releasedData) {
                        // Get currently approved and open recruitment positions to exclude
                        const existingPositionCodes = new Set();
                        
                        if (recruitmentData && recruitmentData.length > 0) {
                            recruitmentData.forEach(position => {
                                if (position.positionCode && position.positionCode.trim()) {
                                    existingPositionCodes.add(position.positionCode.trim());
                                }
                                if (position.id && position.id.trim()) {
                                    existingPositionCodes.add(position.id.trim());
                                }
                            });
                        }
                        
                        // Find all released positions with the selected job title in this company
                        const matchingPositions = [];
                        
                        console.log('=== DEBUGGING COMPANY-SCOPED POSITION CODE POPULATION ===');
                        console.log('Company ID:', currentCompanyId);
                        console.log('Selected job title:', selectedJobTitle);
                        console.log('Total company released staff records:', Object.keys(releasedData).length);
                        console.log('Existing position codes to exclude:', Array.from(existingPositionCodes));
                        
                        Object.keys(releasedData).forEach(key => {
                            const staff = releasedData[key];
                            
                            // Debug each staff record
                            if (staff.jobTitle && staff.jobTitle.trim() === selectedJobTitle) {
                                console.log(`Found matching job title for key ${key}:`, {
                                    jobTitle: staff.jobTitle,
                                    status: staff.status,
                                    positionCode: staff.positionCode,
                                    id: staff.id,
                                    key: key,
                                    companyId: staff.companyId
                                });
                            }
                            
                            // Check if this position matches the selected job title and belongs to current company
                            if (staff.jobTitle && staff.jobTitle.trim() === selectedJobTitle) {
                                // Released positions are already released, so we include them all
                                console.log(`Position ${key} released position found:`, {
                                    status: staff.status,
                                    positionCode: staff.positionCode,
                                    id: staff.id
                                });
                                
                                // Check if this position is already in recruitment board
                                const positionCode = staff.positionCode || staff.id || key;
                                const isAlreadyInRecruitment = existingPositionCodes.has(positionCode);
                                
                                console.log(`Position ${key} recruitment check:`, {
                                    positionCode: positionCode,
                                    isAlreadyInRecruitment: isAlreadyInRecruitment
                                });
                                
                                // Only include if not already in recruitment and not filled
                                if (!isAlreadyInRecruitment && staff.status !== 'filled') {
                                    matchingPositions.push({
                                        ...staff,
                                        firebaseKey: key,
                                        displayCode: positionCode
                                    });
                                    console.log(`✅ Added company released position ${key} to dropdown`);
                                } else {
                                    console.log(`❌ Skipped position ${key} - already in recruitment or filled`);
                                }
                            }
                        });
                        
                        console.log(`Found ${matchingPositions.length} available released positions for job title "${selectedJobTitle}" in company ${currentCompanyId}`);
                        console.log('Matching positions:', matchingPositions);
                        
                        // Sort positions by position code/ID
                        matchingPositions.sort((a, b) => {
                            const codeA = a.displayCode || '';
                            const codeB = b.displayCode || '';
                            return codeA.localeCompare(codeB);
                        });
                        
                        // Add options to dropdown
                        matchingPositions.forEach(position => {
                            const option = document.createElement('option');
                            option.value = position.displayCode;
                            option.textContent = `${position.displayCode} - ${position.department || 'No Dept'}`;
                            option.dataset.staffData = JSON.stringify(position);
                            positionCodeSelect.appendChild(option);
                        });
                        
                        if (matchingPositions.length === 0) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'No released positions available for this job title in this company';
                            option.disabled = true;
                            positionCodeSelect.appendChild(option);
                        }
                        
                        console.log(`✅ Position code dropdown populated with ${matchingPositions.length} options for company ${currentCompanyId}`);
                        
                    } else {
                        console.warn(`No released staff data available for company: ${currentCompanyId}`);
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'No released staff data found for this company';
                        option.disabled = true;
                        positionCodeSelect.appendChild(option);
                    }
                } else {
                    console.error('Firebase not available');
                    const positionCodeSelect = document.getElementById('newPositionCode');
                    if (positionCodeSelect) {
                        positionCodeSelect.innerHTML = '<option value="">Firebase not available</option>';
                    }
                }
            } catch (error) {
                console.error('Error populating position code dropdown:', error);
                const positionCodeSelect = document.getElementById('newPositionCode');
                if (positionCodeSelect) {
                    positionCodeSelect.innerHTML = '<option value="">Error loading position codes</option>';
                }
            }
        }
        
        // Handle position code selection and auto-fill form fields
        function handlePositionCodeSelection() {
            const positionCodeSelect = document.getElementById('newPositionCode');
            const selectedOption = positionCodeSelect.options[positionCodeSelect.selectedIndex];
            
            console.log('Position code selection changed:', selectedOption.value);                if (selectedOption.value && selectedOption.dataset.staffData) {
                try {
                    const staffData = JSON.parse(selectedOption.dataset.staffData);
                    console.log('Auto-filling form with staff data:', staffData);
                    
                    // Debug: Log all available fields in staff data
                    console.log('=== AVAILABLE STAFF DATA FIELDS ===');
                    console.log('Available fields:', Object.keys(staffData));
                    console.log('Job Description fields:', {
                        jobDescription: staffData.jobDescription,
                        description: staffData.description,
                        jobSummary: staffData.jobSummary
                    });
                    console.log('Experience fields:', {
                        requiredExperience: staffData.requiredExperience,
                        experience: staffData.experience,
                        yearsExperience: staffData.yearsExperience,
                        experienceRequired: staffData.experienceRequired
                    });
                    console.log('Skills fields:', {
                        requiredSkills: staffData.requiredSkills,
                        skills: staffData.skills,
                        skillsRequired: staffData.skillsRequired
                    });
                    console.log('Education fields:', {
                        requiredEducation: staffData.requiredEducation,
                        education: staffData.education,
                        educationLevel: staffData.educationLevel
                    });
                    console.log('Additional Information fields:', {
                        notes: staffData.notes,
                        additionalInfo: staffData.additionalInfo,
                        additionalInformation: staffData.additionalInformation,
                        remarks: staffData.remarks,
                        comments: staffData.comments
                    });
                    console.log('Urgency/Priority fields:', {
                        urgency: staffData.urgency,
                        priority: staffData.priority,
                        hiringUrgency: staffData.hiringUrgency,
                        recruitmentUrgency: staffData.recruitmentUrgency
                    });
                    console.log('Note: Attachments field cannot be auto-filled due to security restrictions');
                    
                    // Debug: Check if attachments field is visible
                    const attachmentsInput = document.getElementById('newAttachments');
                    console.log('Attachments field found:', !!attachmentsInput);
                    if (attachmentsInput) {
                        console.log('Attachments field details:', {
                            type: attachmentsInput.type,
                            id: attachmentsInput.id,
                            name: attachmentsInput.name,
                            accept: attachmentsInput.accept,
                            multiple: attachmentsInput.multiple,
                            visible: attachmentsInput.offsetParent !== null,
                            display: window.getComputedStyle(attachmentsInput).display
                        });
                    }
                    
                    // Auto-fill form fields
                    const departmentInput = document.getElementById('newDepartment');
                    const lineManagerInput = document.getElementById('newLineManager');
                    const workLocationInput = document.getElementById('newWorkLocation');
                    const startDateInput = document.getElementById('newStartDate');
                    const endDateInput = document.getElementById('newEndDate');
                    
                    // Fill basic fields
                    if (departmentInput) departmentInput.value = staffData.department || '';
                    if (lineManagerInput) lineManagerInput.value = staffData.lineManager || '';
                    if (workLocationInput) workLocationInput.value = staffData.workLocation || staffData.location || '';
                    
                    // Fill salary range if available
                    const salaryMinInput = document.getElementById('newSalaryMin');
                    const salaryMaxInput = document.getElementById('newSalaryMax');
                    if (salaryMinInput && staffData.salaryMin) salaryMinInput.value = staffData.salaryMin;
                    if (salaryMaxInput && staffData.salaryMax) salaryMaxInput.value = staffData.salaryMax;
                    
                    // Fill employment details if available
                    const employmentTypeInput = document.getElementById('newEmploymentType');
                    const employmentStatusInput = document.getElementById('newEmploymentStatus');
                    const workingHoursInput = document.getElementById('newWorkingHours');
                    if (employmentTypeInput && staffData.employmentType) employmentTypeInput.value = staffData.employmentType;
                    if (employmentStatusInput && staffData.employmentStatus) employmentStatusInput.value = staffData.employmentStatus;
                    if (workingHoursInput && staffData.workingHours) workingHoursInput.value = staffData.workingHours;
                    
                    // Fill job requirements fields
                    const jobDescriptionInput = document.getElementById('newJobDescription');
                    const requiredEducationInput = document.getElementById('newRequiredEducation');
                    const requiredExperienceInput = document.getElementById('newRequiredExperience');
                    const requiredSkillsInput = document.getElementById('newRequiredSkills');
                    
                    if (jobDescriptionInput) {
                        jobDescriptionInput.value = staffData.jobDescription || 
                                                  staffData.description || 
                                                  staffData.jobSummary || '';
                    }
                    
                    if (requiredEducationInput) {
                        requiredEducationInput.value = staffData.requiredEducation || 
                                                     staffData.education || 
                                                     staffData.educationLevel || '';
                    }
                    
                    if (requiredExperienceInput) {
                        requiredExperienceInput.value = staffData.requiredExperience || 
                                                       staffData.experience || 
                                                       staffData.yearsExperience || 
                                                       staffData.experienceRequired || '';
                    }
                    
                    if (requiredSkillsInput) {
                        requiredSkillsInput.value = staffData.requiredSkills || 
                                                   staffData.skills || 
                                                   staffData.skillsRequired || '';
                    }
                    
                    // Fill additional information/notes field
                    const notesInput = document.getElementById('newNotes');
                    if (notesInput) {
                        notesInput.value = staffData.notes || 
                                         staffData.additionalInfo || 
                                         staffData.additionalInformation || 
                                         staffData.remarks || 
                                         staffData.comments || '';
                    }
                    
                    // Fill urgency/priority field
                    const urgencyInput = document.getElementById('newUrgency');
                    if (urgencyInput) {
                        const urgencyValue = staffData.urgency || 
                                           staffData.priority || 
                                           staffData.hiringUrgency || 
                                           staffData.recruitmentUrgency || '';
                        urgencyInput.value = urgencyValue;
                    }
                    
                    // Note: Attachments field (newAttachments) cannot be auto-filled for security reasons
                    // File inputs cannot be programmatically set due to browser security restrictions
                    
                    console.log('Auto-filled job requirements:', {
                        jobDescription: jobDescriptionInput?.value || 'not found',
                        requiredEducation: requiredEducationInput?.value || 'not found',
                        requiredExperience: requiredExperienceInput?.value || 'not found',
                        requiredSkills: requiredSkillsInput?.value || 'not found',
                        additionalNotes: notesInput?.value || 'not found',
                        urgency: urgencyInput?.value || 'not found'
                    });
                    
                    // Make all fields read-only except recruitment reason when position is selected
                    makeFieldsReadOnlyExceptRecruitmentReason();
                    
                    // Fill start and end dates with better error handling
                    if (startDateInput) {
                        if (staffData.startDate) {
                            const formattedStartDate = formatDateForInput(staffData.startDate);
                            startDateInput.value = formattedStartDate;
                            console.log('Set start date from staff data:', staffData.startDate, '→', formattedStartDate);
                        } else {
                            // Default to today's date if no start date is specified
                            const today = new Date();
                            const formattedToday = formatDateForInput(today.toISOString());
                            startDateInput.value = formattedToday;
                            console.log('Set default start date to today:', formattedToday);
                        }
                    } else {
                        console.error('Start date input field not found');
                    }
                    
                    if (endDateInput) {
                        if (staffData.endDate) {
                            const formattedEndDate = formatDateForInput(staffData.endDate);
                            endDateInput.value = formattedEndDate;
                            console.log('Set end date from staff data:', staffData.endDate, '→', formattedEndDate);
                        } else {
                            console.log('No end date specified in staff data, leaving blank for permanent position');
                        }
                    } else {
                        console.error('End date input field not found');
                    }
                    
                } catch (error) {
                    console.error('Error parsing staff data:', error);
                    console.error('Staff data string:', selectedOption.dataset.staffData);
                }
            } else {
                console.log('No staff data available for auto-fill');
                // Clear form fields when no position is selected
                clearFormFields();
            }
        }

        // Fill position function
        async function fillPosition(positionId) {
            const position = recruitmentData.find(pos => pos.id === positionId);
            if (!position) return;
            
            // Update position status to filled
            position.status = 'filled';
            position.filledDate = new Date().toISOString();
            position.filledBy = getCurrentUserId();
            
            // Determine company ID and appropriate Firebase path
            const companyId = getCurrentCompanyId();
            const isCompanyScoped = companyId && position.companyId === companyId;
            
            // Update in Firebase
            const updates = {};
            if (isCompanyScoped) {
                updates[`/companies/${companyId}/recruit/${positionId}`] = position;
                updates[`/companies/${companyId}/staff/${positionId}`] = position;
            } else {
                updates[`/recruit/${positionId}`] = position;
                updates[`/staff/${positionId}`] = position;
            }
            
            firebase.database().ref().update(updates)
                .then(async () => {
                    showNotification('Position marked as filled', 'success');
                    
                    // Create in-app notifications for relevant users
                    try {
                        console.log('📱 Creating notifications for position filled...');
                        
                        if (window.authManager && typeof window.authManager.getInvolvedUsersForRecruitmentAction === 'function') {
                            const involvedUsers = await window.authManager.getInvolvedUsersForRecruitmentAction(position, 'recruitment_filled');
                            
                            if (involvedUsers.length > 0) {
                                const notificationSuccess = await window.authManager.createNotificationsForAction('recruitment_filled', position, involvedUsers);
                                
                                if (notificationSuccess) {
                                    console.log('✅ Position filled notifications created successfully');
                                } else {
                                    console.warn('⚠️ Failed to create some position filled notifications');
                                }
                            } else {
                                console.log('ℹ️ No users found to notify for position filled');
                            }
                        } else {
                            console.warn('⚠️ AuthManager notification methods not available');
                        }
                    } catch (notificationError) {
                        console.error('❌ Error creating position filled notifications:', notificationError);
                        // Don't fail the entire process if notifications fail
                    }
                    
                    loadApprovedPositions();
                    loadRecruitmentRequests();
                })
                .catch(error => {
                    console.error('Error updating position:', error);
                    showNotification('Error marking position as filled', 'error');
                });
        }

        // Create recruitment request function
        function createRecruitmentRequest() {
            const form = document.getElementById('newRecruitmentForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Get current company ID
            const companyId = getCurrentCompanyId();
            if (!companyId) {
                showNotification('Company context not available', 'error');
                return;
            }
            
            // Gather form data
            const formData = new FormData(form);
            const requestData = Object.fromEntries(formData);
            
            // Explicitly ensure critical fields are captured
            requestData.employmentType = document.getElementById('newEmploymentType').value || '';
            requestData.requiredEducation = document.getElementById('newRequiredEducation').value || '';
            requestData.recruitmentReason = document.getElementById('newRecruitmentReason').value || '';
            requestData.advertiseOption = document.getElementById('newAdvertiseOption').value || '';
            // Capture original select label for exact display fidelity later
            const advertiseSelect = document.getElementById('newAdvertiseOption');
            if (advertiseSelect) {
                const selectedOption = advertiseSelect.options[advertiseSelect.selectedIndex];
                requestData.advertiseOptionLabel = selectedOption ? selectedOption.textContent.trim() : '';
            }
            
            // Generate unique ID for the request
            requestData.id = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            requestData.status = 'pending';
            requestData.source = 'recruit';
            requestData.createdAt = new Date().toISOString();
            requestData.createdBy = getCurrentUserId();
            requestData.companyId = companyId;
            
            console.log('📝 Creating recruitment request:', requestData);
            console.log('🔍 Critical fields check:', {
                employmentType: requestData.employmentType,
                requiredEducation: requestData.requiredEducation,
                recruitmentReason: requestData.recruitmentReason,
                advertiseOption: requestData.advertiseOption,
                advertiseOptionLabel: requestData.advertiseOptionLabel
            });
            
            // Save to company-scoped recruit path
            firebase.database().ref(`companies/${companyId}/recruit`).child(requestData.id).set(requestData)
                .then(async () => {
                    console.log('✅ Recruitment request created successfully:', requestData.id);
                    showNotification('Recruitment request created successfully', 'success');
                    closeNewRecruitmentModal();
                    
                    // Create in-app notifications for relevant users (using staff.html pattern)
                    try {
                        console.log('📱 Creating in-app notifications for recruitment request...');
                        
                        // Always create a confirmation notification for the creator (matches staff.html pattern)
                        const currentUserId = window.authManager.currentUser?.uid;
                        if (currentUserId) {
                            console.log('🔔 Creating confirmation notification for creator');
                            await window.authManager.createNotification(currentUserId, {
                                title: 'Recruitment Request Submitted',
                                message: `Your recruitment request "${requestData.positionTitle}" has been submitted successfully`,
                                type: 'success',
                                relatedData: {
                                    actionType: 'recruitment_created',
                                    recruitmentId: requestData.id
                                }
                            });
                            console.log('✅ Confirmation notification created for submitter');
                        }

                        // Create notifications for involved users if available
                        if (window.authManager && typeof window.authManager.getInvolvedUsersForRecruitmentAction === 'function') {
                            const involvedUsers = await window.authManager.getInvolvedUsersForRecruitmentAction(requestData, 'recruitment_created');
                            console.log('👥 Found involved users:', involvedUsers);
                            
                            if (involvedUsers.length > 0) {
                                console.log('📤 Creating notifications for all involved users...');
                                await window.authManager.createNotificationsForAction('recruitment_created', requestData, involvedUsers);
                                console.log('✅ In-app notifications created successfully for all involved users');
                            } else {
                                console.log('ℹ️ No additional users found to notify beyond submitter');
                            }
                        } else {
                            console.warn('⚠️ AuthManager notification methods not available');
                        }
                    } catch (notificationError) {
                        console.error('❌ Error creating in-app notifications:', notificationError);
                        // Don't fail the entire process if notifications fail
                    }
                    
                    // Send email notifications to submitter and approvers
                    try {
                        console.log('📧 Starting recruitment request notification process...');
                        console.log('📧 EmailJS service available:', !!window.recruitmentEmailService);
                        console.log('📧 EmailJS library loaded:', typeof emailjs !== 'undefined');
                        
                        // Check if the email service is properly initialized
                        if (!window.recruitmentEmailService) {
                            throw new Error('Recruitment email service not initialized');
                        }
                        
                        // Prepare notification data
                        const notificationData = {
                            // Basic recruitment info
                            recruitmentId: requestData.id,
                            positionTitle: requestData.positionTitle || 'Untitled Position',
                            department: requestData.department || 'Not specified',
                            employmentType: requestData.employmentType || 'Not specified',
                            workLocation: requestData.workLocation || requestData.location || 'Not specified',
                            urgency: requestData.urgency || 'Medium',
                            expectedStartDate: requestData.expectedStartDate || 'TBD',
                            createdDate: new Date().toLocaleDateString(),
                            createdBy: getCurrentUserName() || 'System User',
                            
                            // Submitter information (current user)
                            submittedBy: getCurrentUserName() || 'System User',
                            submitterEmail: getCurrentUserEmail() || 'hr@dreamexdatalab.com',
                            
                            // Original position ID if this is from staff management
                            originalPositionId: requestData.originalPositionId || null,
                            
                            // Additional CC recipients if specified
                            ccRecipients: [
                                { name: 'HR Team', email: 'hr@dreamexdatalab.com' },
                                { name: 'Recruitment Team', email: 'recruitment@dreamexdatalab.com' }
                            ]
                        };
                        
                        console.log('📧 Notification data prepared:', notificationData);
                        console.log('📧 Current user name:', getCurrentUserName());
                        console.log('📧 Current user email:', getCurrentUserEmail());
                        
                        // Send notifications using the recruitment email service
                        const notificationResult = await window.recruitmentEmailService.sendRecruitmentRequestNotification(notificationData);
                        
                        console.log('📧 Notification result received:', notificationResult);
                        
                        if (notificationResult.success) {
                            console.log('✅ Recruitment notifications sent successfully:', notificationResult);
                            showNotification(
                                `Recruitment request created and ${notificationResult.successful} notification(s) sent successfully`,
                                'success'
                            );
                        } else {
                            console.warn('⚠️ Recruitment notifications failed:', notificationResult);
                            showNotification(
                                `Recruitment request created, but email notifications failed: ${notificationResult.error}`,
                                'warning'
                            );
                        }
                        
                    } catch (notificationError) {
                        console.error('❌ Error sending recruitment notifications:', notificationError);
                        console.error('❌ Error stack:', notificationError.stack);
                        // Don't fail the entire process if notifications fail
                        showNotification(
                            `Recruitment request created, but email notifications encountered an error: ${notificationError.message}`,
                            'warning'
                        );
                    }
                    
                    // Don't manually reload data - let Firebase real-time listeners handle it
                    // The debounced combineAndRenderData will be called automatically
                })
                .catch(error => {
                    console.error('❌ Error creating recruitment request:', error);
                    showNotification('Error creating request', 'error');
                });
        }

        // Approve position function with authorization check
        async function approvePosition(positionId) {
            try {
                // Confirmation (now clarifies this approves YOUR step, not whole position unless final)
                const confirmed = confirm('Approve your step in the approval flow?\n\nIf this is the final required approval, the position will be marked fully approved.');
                if (!confirmed) { console.log('❌ User cancelled approval action'); return; }

                const currentUserId = getCurrentUserId();
                const currentUserEmail = (typeof getCurrentUserEmail === 'function' ? (getCurrentUserEmail() || '') : '').toLowerCase();
                if (!currentUserId || currentUserId === 'unknown') {
                    showNotification('Cannot approve: user context missing', 'error');
                    return;
                }

                // Fetch latest approval flow
                const flow = await window.fetchRecruitmentApprovalFlow(positionId);
                if (!flow || !Array.isArray(flow.levels)) {
                    showNotification('No approval flow found for this position', 'error');
                    return;
                }

                const isSequential = String(flow.approvalOrder || '').toLowerCase() === 'sequential';
                const norm = v => String(v||'').toLowerCase();

                // Determine target level/approver indices for this user
                let targetLevelIndex = -1; let targetApproverIndex = -1;
                const isLevelUnlocked = (idx) => {
                    if (!isSequential) return true;
                    if (idx === 0) return true;
                    const prev = flow.levels[idx - 1];
                    return ['approved','completed'].includes(norm(prev.status));
                };

                // Helper to test if approver matches user and is pending
                const approverMatches = (approver) => {
                    const directMatch = (
                        (approver.value?.startsWith('user_') && approver.value.replace('user_','') === currentUserId) ||
                        approver.userId === currentUserId ||
                        approver.approverId === currentUserId
                    );
                    // Email match fallback
                    const emailMatch = currentUserEmail && norm(approver.email) === currentUserEmail;
                    // L+1 special match if designated
                    let lPlusOneMatch = false;
                    const isLPlusOne = [approver.value, approver.role, approver.label, approver.text]
                        .some(v => norm(v).includes('l+1'));
                    if (isLPlusOne) {
                        // Compare against position line manager value
                        const pos = recruitmentData.find(p => p.id === positionId) || {};
                        const lmRaw = norm(pos.lineManager);
                        if (lmRaw) {
                            if (lmRaw === currentUserEmail) lPlusOneMatch = true;
                            else if (window.authManager && typeof window.authManager.getUserDisplayName === 'function') {
                                const dn = norm(window.authManager.getUserDisplayName());
                                if (dn && (dn === lmRaw || dn.includes(lmRaw) || lmRaw.includes(dn))) lPlusOneMatch = true;
                            }
                        }
                    }
                    return (directMatch || emailMatch || lPlusOneMatch) && norm(approver.status) === 'pending';
                };

                // Locate approver slot
                for (let li = 0; li < flow.levels.length; li++) {
                    const level = flow.levels[li];
                    if (!isLevelUnlocked(li)) continue; // sequential gating
                    for (let ai = 0; ai < (level.approvers||[]).length; ai++) {
                        const appr = level.approvers[ai];
                        if (approverMatches(appr)) { targetLevelIndex = li; targetApproverIndex = ai; break; }
                    }
                    if (targetLevelIndex >= 0) break;
                    // If sequential and not found in first pending level, stop searching further pending levels
                    if (isSequential && ['pending','partially-approved','locked'].includes(norm(level.status))) break;
                }

                if (targetLevelIndex < 0 || targetApproverIndex < 0) {
                    showNotification('No pending approval step found for you', 'warning');
                    return;
                }

                console.log(`✅ Approving level ${targetLevelIndex+1}, approver ${targetApproverIndex} for position ${positionId}`);
                await updateRecruitmentApprovalStatus(positionId, targetLevelIndex, targetApproverIndex);

                // Fetch updated flow to evaluate level completion
                const updatedFlow = await window.fetchRecruitmentApprovalFlow(positionId);
                const level = updatedFlow.levels[targetLevelIndex];
                const allApproved = level.approvers.every(a => norm(a.status) === 'approved');
                if (allApproved) {
                    console.log(`🎉 Level ${targetLevelIndex+1} fully approved`);
                    try { await updateLevelStatus(positionId, targetLevelIndex, 'approved'); } catch(e){ console.warn('Level status update failed', e); }
                    if (isSequential && targetLevelIndex + 1 < updatedFlow.levels.length) {
                        try { await unlockNextLevel(positionId, targetLevelIndex + 1); } catch(e){ console.warn('Unlock next level failed', e); }
                    }
                } else {
                    // Mark level as in-progress for sequential tracking
                    try { await updateLevelStatus(positionId, targetLevelIndex, 'partially-approved'); } catch(e){ console.warn('Level partial status update failed', e); }
                }

                // If every level now approved mark overall position approved
                const allLevelsApproved = updatedFlow.levels.every(l => ['approved','completed'].includes(norm(l.status)));
                if (allLevelsApproved) {
                    console.log('🏁 All levels approved — updating overall position status');
                    try { await updateOverallPositionStatus(positionId, 'approved'); } catch(e){ console.warn('Overall status update failed', e); }
                }

                // Re-render approval flow section & modal buttons
                try { 
                    await loadApprovalFlowForPosition(positionId); 
                    // Force refresh of modal buttons after approval flow update
                    if (typeof checkApproverStatus === 'function') {
                        await checkApproverStatus();
                    }
                } catch(e){ console.warn('Re-render after approval failed', e); }
                // Refresh modal buttons gating (user may no longer have pending approvals)
                try { /* reuse internal checker by reopening viewDetails or manual minimal refresh */ } catch {}
                showNotification('Approval recorded', 'success');
            } catch (error) {
                console.error('Error processing approval:', error);
                showNotification('Failed to process approval: ' + error.message, 'error');
            }
        }

        // Decline position function with authorization check
        async function declinePosition(positionId) {
            try {
                // Show confirmation dialog
                const confirmed = confirm('Are you sure you want to decline this position?\n\nThis action will change the position status to declined.');
                if (!confirmed) {
                    console.log('❌ User cancelled decline action');
                    return;
                }

                // Check if current user is authorized to decline this position
                const isAuthorized = await checkUserApprovalAuthorization(positionId);
                if (!isAuthorized) {
                    showNotification('You are not authorized to decline this position', 'error');
                    console.warn('⚠️ Unauthorized decline attempt for position:', positionId);
                    return;
                }
                
                console.log('✅ Authorized decline for position:', positionId);
                updatePositionStatus(positionId, 'declined');
            } catch (error) {
                console.error('Error checking decline authorization:', error);
                showNotification('Error verifying authorization', 'error');
            }
        }

        // Helper function to check if current user is authorized to approve/decline a position
        async function checkUserApprovalAuthorization(positionId) {
            try {
                const currentUserId = getCurrentUserId();
                if (!currentUserId || currentUserId === 'unknown') {
                    console.warn('⚠️ No valid user ID found for authorization check');
                    return false;
                }

                // Get the approval flow for this position
                const approvalFlow = await window.fetchRecruitmentApprovalFlow(positionId);
                if (!approvalFlow || !approvalFlow.levels) {
                    console.warn('⚠️ No approval flow found for position:', positionId);
                    return false;
                }

                // Check if current user is an approver in any level
                for (const level of approvalFlow.levels) {
                    for (const approver of level.approvers) {
                        if ((approver.value?.startsWith('user_') && approver.value.replace('user_', '') === currentUserId) ||
                            (approver.userId === currentUserId) ||
                            (approver.approverId === currentUserId)) {
                            console.log(`✅ User ${currentUserId} is authorized as approver in level: ${level.name}`);
                            return true;
                        }
                    }
                }

                console.warn(`⚠️ User ${currentUserId} is not an approver for position: ${positionId}`);
                return false;
            } catch (error) {
                console.error('Error checking user approval authorization:', error);
                return false;
            }
        }

        // Update position status function
        async function updatePositionStatus(positionId, status) {
            const position = recruitmentData.find(pos => pos.id === positionId);
            if (!position) return;
            
            // Update position status
            position.approvalStatus = status;
            
            // Determine company ID and appropriate Firebase path
            const companyId = getCurrentCompanyId();
            const isCompanyScoped = companyId && position.companyId === companyId;
            const dbPath = isCompanyScoped ? 
                `companies/${companyId}/recruit/${positionId}` : 
                `recruit/${positionId}`;
            
            // Prepare update data
            const updateData = { 
                approvalStatus: status
            };
            
            // Add publishedDate when position is approved/published
            if (status === 'approved' || status === 'published' || status === 'released') {
                updateData.publishedDate = new Date().toISOString();
                position.publishedDate = updateData.publishedDate; // Update local data too
            }
            
            // Update in Firebase
            firebase.database().ref(dbPath).update(updateData)
                .then(async () => {
                    const statusText = status === 'approved' ? 'approved' : 'declined';
                    showNotification(`Position ${statusText}`, 'success');
                    
                    // Create in-app notifications for relevant users
                    try {
                        console.log('📱 Creating notifications for position status update...');
                        
                        if (window.authManager && typeof window.authManager.getInvolvedUsersForRecruitmentAction === 'function') {
                            const actionType = status === 'approved' ? 'recruitment_approved' : 'recruitment_declined';
                            const involvedUsers = await window.authManager.getInvolvedUsersForRecruitmentAction(position, actionType);
                            
                            if (involvedUsers.length > 0) {
                                const notificationSuccess = await window.authManager.createNotificationsForAction(actionType, position, involvedUsers);
                                
                                if (notificationSuccess) {
                                    console.log('✅ Status update notifications created successfully');
                                } else {
                                    console.warn('⚠️ Failed to create some status update notifications');
                                }
                            } else {
                                console.log('ℹ️ No users found to notify for status update');
                            }
                        } else {
                            console.warn('⚠️ AuthManager notification methods not available');
                        }
                    } catch (notificationError) {
                        console.error('❌ Error creating status update notifications:', notificationError);
                        // Don't fail the entire process if notifications fail
                    }
                    
                    loadApprovedPositions();
                    loadRecruitmentRequests();
                })
                .catch(error => {
                    console.error('Error updating position status:', error);
                    showNotification('Error updating status', 'error');
                });
        }

        // Edit position function
        function editPosition(positionId) {
            const position = recruitmentData.find(pos => pos.id === positionId);
            if (!position) return;
            
            // Populate form with position data
            const form = document.getElementById('newRecruitmentForm');
            for (const key in position) {
                if (position.hasOwnProperty(key) && form.elements[key]) {
                    form.elements[key].value = position[key];
                }
            }
            
            openNewRecruitmentModal();
        }

        // Delete position function
        function deletePosition(positionId) {
            if (!confirm('Are you sure you want to delete this position?')) return;
            
            firebase.database().ref('recruit').child(positionId).remove()
                .then(() => {
                    showNotification('Position deleted successfully', 'success');
                    loadApprovedPositions();
                    loadRecruitmentRequests();
                })
                .catch(error => {
                    console.error('Error deleting position:', error);
                    showNotification('Error deleting position', 'error');
                });
        }        // Notification functions
        function showNotification(message, type = 'info') {
            // Implement your notification logic here
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Export data function
        function exportData() {
            try {
                if (recruitmentData.length === 0) {
                    showNotification('No data to export', 'warning');
                    return;
                }                // Prepare data for export
                const exportData = recruitmentData.map(position => ({
                    'Position Code': position.id || position.positionCode || '',
                    'Job Title': position.jobTitle || '',
                    'Department': position.department || '',
                    'Employment Type': formatEmploymentType(position.employmentType || ''),
                    'Salary Range': formatSalaryRange(position.salaryMin || 0, position.salaryMax || 0),
                    'Urgency': formatPriority(position.urgency || ''),
                    'Status': formatStatus(position.status || ''),
                    'Posted Date': formatDate(position.postedDate || position.createdAt || ''),
                    'Source': position.source === 'recruit' ? 'Recruitment Board' : 'Staff Management',
                    'Line Manager': position.lineManager || '',
                    'Location': position.workLocation || position.location || ''
                }));

                // Convert to CSV
                const headers = Object.keys(exportData[0]);
                const csvContent = [
                    headers.join(','),
                    ...exportData.map(row => 
                        headers.map(header => 
                            `"${(row[header] || '').toString().replace(/"/g, '""')}"`
                        ).join(',')
                    )
                ].join('\n');

                // Download CSV
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `recruitment_board_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showNotification('Data exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting data:', error);
                showNotification('Error exporting data', 'error');
            }
        }

        // User role and feature visibility
        document.addEventListener('DOMContentLoaded', function() {
            // Check user role and set feature visibility
            const userRole = getCurrentUserRole();
            const isAdmin = userRole === 'admin';
            const isManager = userRole === 'manager';
            const isHR = userRole === 'hr';
            
            // Example: Show/hide elements based on role
            document.querySelectorAll('[data-feature]').forEach(el => {
                const feature = el.getAttribute('data-feature');
                if (isAdmin || el.classList.contains(`feature-${userRole}`)) {
                    el.style.display = 'block';
                } else {
                    el.style.display = 'none';
                }
            });
        });        // Get current user role (mock function)
        function getCurrentUserRole() {
            // Replace with actual role retrieval logic
            return 'admin';
        }

        // Function to redirect to job details page with selected position data
        function viewJobDetails(positionId) {
            // Look for the position in both staffPositions and recruitRequests arrays
            const position = [...staffPositions, ...recruitRequests]
                .find(pos => pos.id === positionId || pos.firebaseKey === positionId);

            if (!position) {
                console.error('Position not found:', positionId);
                showNotification('Error: Position not found', 'error');
                return;
            }

            console.log('Viewing job details for position:', position);
            console.log('Position ID:', position.id);
            console.log('Position Code:', position.positionCode);
            console.log('Passing positionCode parameter as:', position.positionCode || position.id || '');            // Create URL parameters
            const params = new URLSearchParams({
                id: position.id || position.firebaseKey || '',
                positionCode: position.positionCode || position.id || '',
                jobTitle: position.jobTitle || '',
                department: position.department || '',
                employmentType: position.employmentType || '',
                status: position.status || '',
                urgency: position.priority || position.urgency || '',
                postedDate: position.postedDate || position.createdAt || '',
                sourceIndicator: position.source || '',
                salary: `${formatSalaryRange(position.salaryMin, position.salaryMax)}`,
                location: position.location || position.workLocation || '',
                description: position.jobDescription || ''
            });

            // Add extra parameters if available
            if (position.requiredSkills) params.append('skills', position.requiredSkills);
            if (position.requiredEducation) params.append('education', position.requiredEducation);
            if (position.requiredExperience) params.append('experience', position.requiredExperience);
            if (position.lineManager) params.append('lineManager', position.lineManager);
            if (position.workingHours) params.append('workingHours', position.workingHours);
            if (position.endDate) params.append('endDate', position.endDate);
            if (position.notes) params.append('notes', position.notes);            // Redirect to jobdetails.html with the parameters
            window.location.href = `jobdetails.html?${params.toString()}`;
        }

        // Edit published job function
        function editPublishedJob(positionId) {
            // Find the position in all data sources (including published jobs)
            const position = recruitmentData.find(pos => pos.id === positionId || pos.firebaseKey === positionId);

            if (!position) {
                console.error('Position not found:', positionId);
                showNotification('Error: Position not found', 'error');
                return;
            }

            console.log('Editing published job:', position);
            
            // Create URL parameters for editing with comprehensive field mapping
            const params = new URLSearchParams({
                id: position.id || position.firebaseKey || '',
                jobId: position.id || position.firebaseKey || '',
                positionCode: position.positionCode || position.id || '',
                jobTitle: position.jobTitle || '',
                department: position.department || '',
                employmentType: position.employmentType || '',
                status: position.status || '',
                urgency: position.priority || position.urgency || 'medium',
                postedDate: position.postedDate || position.createdAt || '',
                publishedDate: position.publishedDate || '',
                sourceIndicator: position.source || 'published',
                salary: `${formatSalaryRange(position.salaryMin, position.salaryMax)}`,
                location: position.location || position.workLocation || '',
                description: position.jobDescription || '',
                jobDescription: position.jobDescription || '', // Additional mapping for consistency
                editMode: 'true', // Flag to indicate this is an edit operation
                fromPublished: 'true' // Flag to indicate this came from published tab
            });

            // Add additional parameters with proper field mapping
            if (position.requiredSkills) {
                params.append('skills', position.requiredSkills);
                params.append('requiredSkills', position.requiredSkills); // Alternative mapping
            }
            if (position.requiredEducation) {
                params.append('education', position.requiredEducation);
                params.append('requiredEducation', position.requiredEducation); // Alternative mapping
            }
            if (position.requiredExperience) {
                params.append('experience', position.requiredExperience);
                params.append('requiredExperience', position.requiredExperience); // Alternative mapping
            }
            if (position.lineManager) params.append('lineManager', position.lineManager);
            if (position.workingHours) params.append('workingHours', position.workingHours);
            if (position.startDate) params.append('startDate', position.startDate);
            if (position.endDate) params.append('endDate', position.endDate);
            if (position.notes) params.append('notes', position.notes);
            if (position.salaryMin) params.append('salaryMin', position.salaryMin);
            if (position.salaryMax) params.append('salaryMax', position.salaryMax);
            if (position.advertisingClosingDate) params.append('advertisingClosingDate', position.advertisingClosingDate);
            if (position.closingDate) params.append('advertisingClosingDate', position.closingDate); // Alternative mapping

            // Debug: Log all parameters being sent
            console.log('Edit parameters being sent:', Object.fromEntries(params));

            // Redirect to jobdetails.html in edit mode
            window.location.href = `jobdetails.html?${params.toString()}`;
        }
    </script>

    <!-- Recruitment Approval Flow Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Modal is ready for use
        });

        // Build and cache signature lookup maps (by userId and by name)
        async function buildSignatureLookup() {
            try {
                const now = Date.now();
                const cache = window._recruitSigCache || {};
                // Reuse cache for 60 seconds to avoid repeated reads
                if (cache.ts && (now - cache.ts) < 60000 && cache.byId && cache.byName) {
                    return cache;
                }
                const companyId = getCurrentCompanyId();
                if (!companyId || !window.firebase) {
                    return { byId: {}, byName: {}, byEmail: {}, ts: now };
                }
                const snap = await firebase.database().ref(`companies/${companyId}/users`).once('value');
                const users = snap.val() || {};
                // Load signatures collection for default signature resolution
                let signatures = {};
                try {
                    const sigSnap = await firebase.database().ref(`companies/${companyId}/signatures`).once('value');
                    signatures = sigSnap.val() || {};
                } catch (e) { console.warn('Signature collection fetch failed', e); }
                const byId = {};
                const byName = {};
                const byEmail = {};
                Object.entries(users).forEach(([uid, u]) => {
                    if (!u) return;
                    const nm = (u.displayName || u.name || u.fullName || u.email || '').trim();
                    let sig = u.signatureUrl || null;
                    // Resolve default signature via user's defaultSignatureId if missing
                    if (!sig) {
                        const defaultId = u.defaultSignatureId || u.signatureId || u.defaultSigId || null;
                        if (defaultId && signatures[defaultId]) {
                            sig = signatures[defaultId].url || signatures[defaultId].imageUrl || signatures[defaultId].signatureUrl || null;
                        }
                    }
                    if (uid && sig) byId[uid] = sig;
                    if (nm && sig) byName[nm.toLowerCase()] = sig;
                    const email = (u.email || '').trim().toLowerCase();
                    if (email && sig) byEmail[email] = sig;
                });
                const built = { byId, byName, byEmail, ts: now };
                window._recruitSigCache = built;
                return built;
            } catch (e) {
                console.warn('Signature lookup build failed', e);
                return { byId: {}, byName: {}, byEmail: {}, ts: Date.now() };
            }
        }

        // Resolve signature URL for an approver via id list or fallback name
        function resolveSignatureUrl(sigLookup, uidCandidates, displayName, emailCandidate) {
            try {
                if (!sigLookup) return '';
                for (const uid of (uidCandidates || [])) {
                    if (uid && sigLookup.byId && sigLookup.byId[uid]) return sigLookup.byId[uid];
                }
                const key = (displayName || '').toLowerCase().trim();
                if (key && sigLookup.byName && sigLookup.byName[key]) return sigLookup.byName[key];
                const em = (emailCandidate || '').toLowerCase().trim();
                if (em && sigLookup.byEmail && sigLookup.byEmail[em]) return sigLookup.byEmail[em];
                return '';
            } catch { return ''; }
        }

        // Render approval history table (Approved actions) similar to leave tab in profile.html
        async function renderRecruitmentApprovalHistory(positionId, approvalFlow, sigLookup) {
            try {
                const approvalSection = document.getElementById('approvalSection');
                if (!approvalSection) return;
                // Ensure container
                let historyContainer = document.getElementById('approvalHistoryContainer');
                if (!historyContainer) {
                    historyContainer = document.createElement('div');
                    historyContainer.id = 'approvalHistoryContainer';
                    historyContainer.style.marginTop = '12px';
                    approvalSection.appendChild(historyContainer);
                }
                historyContainer.innerHTML = '<div style="font-size:.7rem;color:#475569;margin-bottom:6px;font-weight:600;display:flex;align-items:center;gap:6px;"><i class="fas fa-history"></i> Approval History</div>';
                const companyId = getCurrentCompanyId();
                if (!companyId || !window.firebase) {
                    historyContainer.innerHTML += '<div style="font-size:.65rem;color:#64748b;">Company context unavailable</div>';
                    return;
                }
                const approvalsSnap = await firebase.database().ref(`companies/${companyId}/recruit/${positionId}/approvals`).once('value');
                const approvalsVal = approvalsSnap.val() || {};
                // Build table skeleton
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.fontSize = '.65rem';
                table.innerHTML = `<thead><tr style='background:#f1f5f9;'>
                    <th style='text-align:left;padding:6px;border:1px solid #e2e8f0;'>Level</th>
                    <th style='text-align:left;padding:6px;border:1px solid #e2e8f0;'>Approver</th>
                    <th style='text-align:left;padding:6px;border:1px solid #e2e8f0;'>Status</th>
                    <th style='text-align:left;padding:6px;border:1px solid #e2e8f0;'>Timestamp</th>
                    <th style='text-align:left;padding:6px;border:1px solid #e2e8f0;'>Signature</th>
                </tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                const levels = approvalFlow?.levels || [];
                levels.forEach((lvl, idx) => {
                    const levelNumber = idx + 1;
                    const levelApprovalsPath = approvalsVal[`level${levelNumber}`]?.approvals || {};
                    // Map approvals by approver index or id
                    const approvalRecords = Object.values(levelApprovalsPath);
                    // For each approver in flow show row (approved or pending with no signature)
                    const positionRef = (typeof recruitmentData !== 'undefined') ? recruitmentData.find(p => p.id === positionId) || {} : {};
                    (lvl.approvers || []).forEach((approver, aIdx) => {
                        const tr = document.createElement('tr');
                        let record = approvalRecords.find(r => (r.approverIndex === aIdx) || (r.approverId && approver.approverId && r.approverId === approver.approverId));
                        // Determine actual status from approval record or approver status
                        let status = approver.status || 'pending';
                        if (record && (record.status === 'approved' || record.action === 'approved')) {
                            status = 'approved';
                        }
                        const ts = record?.approvedDateTime || record?.approvedAt || approver.date || '';
                        // Resolve approver display name with multiple fallbacks
                        let approverName = approver.name || approver.displayName || approver.approverName || approver.label || approver.text || '';
                        const isLPlusOne = (approver.value || '').toLowerCase().includes('l+1') || (approver.role || '').toLowerCase().includes('l+1');
                        // Force line manager name for first level if missing or generic
                        if (!approverName || approverName === 'Not assigned' || approverName === 'Pending Approver') {
                            if (idx === 0 && (isLPlusOne || (lvl.approvers.length === 1))) {
                                const rawLM = positionRef.lineManager || positionRef.lineManagerName || positionRef.line_manager || '';
                                if (rawLM) {
                                    if (typeof formatLineManagerName === 'function') {
                                        approverName = formatLineManagerName(rawLM);
                                    } else {
                                        // Extract name portion (before separators, remove parentheses)
                                        approverName = String(rawLM)
                                            .replace(/\([^)]*\)/g,'')
                                            .split(/[,|\-]/)[0]
                                            .trim();
                                    }
                                }
                            }
                        }
                        // Final fallback if still empty
                        if (!approverName) approverName = 'Line Manager';
                        if (!approverName) {
                            // Attempt to derive from user id via a very lightweight lookup of cached signatures mapping names
                            // (sigLookup.byName holds lowercase name->url; reverse attempt not possible. Keep placeholder.)
                            approverName = 'Pending Approver';
                        }
                        // Signature resolution when approved
                        let sig = '';
                        if (status === 'approved') {
                            const uidCandidates = [];
                            if (approver.userId) uidCandidates.push(String(approver.userId));
                            if (approver.approverId) uidCandidates.push(String(approver.approverId));
                            if (approver.value && typeof approver.value === 'string') {
                                if (approver.value.startsWith('user_')) uidCandidates.push(approver.value.replace('user_', ''));
                                else if (/^[A-Za-z0-9_-]{10,}$/.test(approver.value)) uidCandidates.push(approver.value);
                            }
                            const approverEmailCandidate = (approver.email || approver.approverEmail || approver.userEmail || '').trim();
                            sig = resolveSignatureUrl(sigLookup, uidCandidates, approverName, approverEmailCandidate);
                            // Fallback for line manager (L+1) if signature not found yet
                            if (!sig && idx === 0 && isLPlusOne) {
                                const rawLM = (positionRef.lineManager || positionRef.lineManagerName || positionRef.line_manager || '').trim();
                                const rawLower = rawLM.toLowerCase();
                                // Try email presence inside raw line manager string
                                const emailMatch = rawLower.match(/[\w.+-]+@[\w.-]+\.[a-z]{2,}/);
                                if (emailMatch && sigLookup.byName[emailMatch[0]]) {
                                    sig = sigLookup.byName[emailMatch[0]];
                                }
                                if (!sig) {
                                    // Fuzzy token matching against byName keys
                                    const tokens = approverName.toLowerCase().split(/\s+/).filter(t => t.length > 1);
                                    for (const key of Object.keys(sigLookup.byName || {})) {
                                        const hitAll = tokens.every(t => key.includes(t));
                                        if (hitAll) { sig = sigLookup.byName[key]; break; }
                                    }
                                }
                                if (!sig && rawLower) {
                                    // Final attempt: any key fully contained in rawLM
                                    for (const key of Object.keys(sigLookup.byName || {})) {
                                        if (rawLower.includes(key)) { sig = sigLookup.byName[key]; break; }
                                    }
                                }
                            }
                        }
                        tr.innerHTML = `
                            <td style='padding:6px;border:1px solid #e2e8f0;'>${levelNumber}</td>
                            <td style='padding:6px;border:1px solid #e2e8f0;'>${approverName}</td>
                            <td style='padding:6px;border:1px solid #e2e8f0;'>${status.charAt(0).toUpperCase()+status.slice(1)}</td>
                            <td style='padding:6px;border:1px solid #e2e8f0;'>${ts || ''}</td>
                            <td style='padding:6px;border:1px solid #e2e8f0;'>${sig ? `<img src='${sig}' alt='${approverName} signature' style='height:32px;max-width:180px;object-fit:contain;'/>` : ''}</td>`;
                        tbody.appendChild(tr);
                    });
                });
                if (!tbody.children.length) {
                    const empty = document.createElement('div');
                    empty.style.fontSize = '.65rem';
                    empty.style.color = '#64748b';
                    empty.textContent = 'No approval history yet.';
                    historyContainer.appendChild(empty);
                } else {
                    historyContainer.appendChild(table);
                }
            } catch (e) {
                console.warn('Render recruitment approval history failed', e);
            }
        }

        async function loadApprovalFlowForPosition(positionId, position = null) {
            try {
                console.log(`🔄 Loading approval flow for position: ${positionId}`);
                
                // If position not provided, try to find it in global data
                if (!position) {
                    position = recruitmentData.find(p => p.id === positionId) || {};
                }
                
                // Check if modal elements exist
                const modal = document.getElementById('viewDetailsModal');
                const approvalSection = document.getElementById('approvalSection');
                console.log(`🎭 Modal exists:`, !!modal);
                console.log(`📋 Approval section exists:`, !!approvalSection);
                
                if (!approvalSection) {
                    console.error('❌ Approval section not found in modal');
                    return;
                }
                
                const approvalFlow = await window.fetchRecruitmentApprovalFlow(positionId);
                console.log(`📋 Received approval flow:`, approvalFlow);
                console.log(`📊 Approval flow levels:`, approvalFlow?.levels?.length || 0);
                console.log(`👥 First level approvers:`, approvalFlow?.levels?.[0]?.approvers?.map(a => `${a.name} (${a.value})`) || []);

                // Prepare signature lookup for rendering approved signatures (parity with leave modal)
                const sigLookup = await buildSignatureLookup();
                
                // Update approval type display with company context
                const approvalTypeElement = document.querySelector('#approvalSection .approval-type');
                console.log(`🎯 Found approval type element:`, approvalTypeElement);
                
                if (approvalTypeElement) {
                    const approvalIcon = approvalFlow.approvalOrder === 'sequential' ? 'stream' : 'random';
                    
                    approvalTypeElement.innerHTML = `
                        <i class="fas fa-${approvalIcon}"></i>
                        ${approvalFlow.type}
                    `;
                    console.log(`✅ Updated approval type display`);
                } else {
                    console.error('❌ Approval type element not found');
                }

                // Update approval levels
                const approvalLevelsContainer = document.querySelector('#approvalSection .approval-levels');
                console.log(`🎯 Found approval levels container:`, approvalLevelsContainer);
                
                if (approvalLevelsContainer) {
                    // Set display direction based on approvalOrder
                    if (approvalFlow.approvalOrder === 'sequential') {
                        approvalLevelsContainer.style.flexDirection = 'column';
                    } else {
                        approvalLevelsContainer.style.flexDirection = 'row';
                    }
                    approvalLevelsContainer.innerHTML = '';
                    
                    if (approvalFlow.levels && approvalFlow.levels.length > 0) {
                        // If flow type is L+1, surface the direct line manager prominently
                        try {
                            const flowTypeValue = (approvalFlow.type || approvalFlow.flowType || '').toLowerCase();
                            console.log(`🔍 Checking flow type for L+1: "${flowTypeValue}"`);
                            console.log(`📋 Position data:`, position);
                            console.log(`👤 Line manager from position:`, position?.lineManager);
                            
                            if (flowTypeValue.includes('l+1') || flowTypeValue === 'l+1') {
                                const lineManagerName = formatLineManagerName((position?.lineManager || '').trim());
                                console.log(`✅ L+1 flow detected, line manager: "${lineManagerName}"`);
                                
                                if (lineManagerName) {
                                    const lmEl = document.createElement('div');
                                    lmEl.className = 'approval-line-manager-banner';
                                    lmEl.style.cssText = 'background:#f0f9ff;border:1px solid #7dd3fc;border-radius:6px;padding:0.6rem 0.75rem;margin-bottom:0.75rem;font-size:0.8rem;color:#0369a1;display:flex;align-items:center;gap:0.5rem;';
                                    lmEl.innerHTML = `
                                        <i class="fas fa-user-tie" style="color:#0ea5e9;"></i>
                                        <strong>Line Manager (L+1):</strong> <span style="font-weight:600;">${lineManagerName}</span>
                                    `;
                                    approvalLevelsContainer.appendChild(lmEl);
                                } else {
                                    const lmFallback = document.createElement('div');
                                    lmFallback.className = 'approval-line-manager-banner';
                                    lmFallback.style.cssText = 'background:#fff7ed;border:1px solid #fdba74;border-radius:6px;padding:0.6rem 0.75rem;margin-bottom:0.75rem;font-size:0.8rem;color:#9a3412;display:flex;align-items:center;gap:0.5rem;';
                                    lmFallback.innerHTML = `
                                        <i class="fas fa-exclamation-circle" style="color:#f97316;"></i>
                                        <strong>Line Manager (L+1):</strong> <em>Not specified</em>
                                    `;
                                    approvalLevelsContainer.appendChild(lmFallback);
                                }
                            } else {
                                console.log(`ℹ️ Not an L+1 flow type: "${flowTypeValue}"`);
                            }
                        } catch (e) { console.warn('Unable to render L+1 line manager banner:', e); }
                        
                        approvalFlow.levels.forEach((level, levelIndex) => {
                            console.log(`📊 Processing level ${levelIndex + 1}:`, level);
                            
                            const levelElement = document.createElement('div');
                            // Match leave details modal card styling
                            levelElement.className = 'leave-approval-flow-level';
                            levelElement.style.border = '1px solid #e2e8f0';
                            levelElement.style.borderRadius = '6px';
                            levelElement.style.padding = '10px';
                            levelElement.style.background = '#f9fafb';
                            
                            // Enhanced status display based on level completion
                            let statusDisplayHTML = '';
                            if (level.status === 'approved' || level.status === 'completed') {
                                statusDisplayHTML = `
                                    <i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>
                                    <span style="color: #28a745; font-weight: 600;">Approved</span>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                        All ${level.totalApprovers} approvers completed
                                    </div>
                                `;
                            } else if (level.status === 'pending') {
                                const approvedCount = level.approvedCount || level.approvers.filter(app => app.status === 'approved').length;
                                const totalApprovers = level.totalApprovers || level.approvers.length;
                                
                                if (approvedCount > 0) {
                                    statusDisplayHTML = `
                                        <i class="fas fa-clock" style="color: #ffc107; margin-right: 0.5rem;"></i>
                                        <span style="color: #856404; font-weight: 600;">Pending</span>
                                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                            ${approvedCount}/${totalApprovers} approvers completed
                                        </div>
                                    `;
                                } else {
                                    statusDisplayHTML = `
                                        <i class="fas fa-clock" style="color: #ffc107; margin-right: 0.5rem;"></i>
                                        <span style="color: #856404; font-weight: 600;">Pending</span>
                                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                            Awaiting approvals
                                        </div>
                                    `;
                                }
                            } else if (level.status === 'rejected') {
                                statusDisplayHTML = `
                                    <i class="fas fa-times-circle" style="color: #dc3545; margin-right: 0.5rem;"></i>
                                    <span style="color: #dc3545; font-weight: 600;">Rejected</span>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                        Review required
                                    </div>
                                `;
                            } else if (level.status === 'locked') {
                                statusDisplayHTML = `
                                    <i class="fas fa-lock" style="color: #6c757d; margin-right: 0.5rem;"></i>
                                    <span style="color: #6c757d; font-weight: 600;">Locked</span>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                        Previous level required
                                    </div>
                                `;
                            } else {
                                // Fallback for any other status
                                statusDisplayHTML = `
                                    <span style="font-weight: 600;">${level.status.charAt(0).toUpperCase() + level.status.slice(1)}</span>
                                `;
                            }
                            
                            // Process approvers asynchronously to resolve user IDs
                            const processApproversAsync = async () => {
                                const approversHTML = await Promise.all((level.approvers || []).map(async (approver, approverIndex) => {
                                    console.log(`👤 Processing approver ${approverIndex}:`, approver);
                                    
                                    // Check if current user is this approver
                                    const globalUserId = getCurrentUserId();
                                    const companyUserId = await getCurrentUserIdWithCompanyContext();
                                    
                                    console.log(`🔍 Checking approver authorization:`);
                                    console.log(`  - Global User ID: "${globalUserId}"`);
                                    console.log(`  - Company User ID: "${companyUserId}"`);
                                    console.log(`  - Approver data:`, {
                                        value: approver.value,
                                        userId: approver.userId,
                                        approverId: approver.approverId,
                                        name: approver.name,
                                        email: approver.email
                                    });
                                    
                                    // Enhanced user matching - check multiple ID formats and sources
                                    const isCurrentUserApprover = (
                                        // Check against user_ prefixed values
                                        (approver.value?.startsWith('user_') && 
                                         (approver.value.replace('user_', '') === globalUserId || 
                                          approver.value.replace('user_', '') === companyUserId)) ||
                                        // Check against direct user IDs
                                        (approver.userId === globalUserId || approver.userId === companyUserId) ||
                                        (approver.approverId === globalUserId || approver.approverId === companyUserId) ||
                                        // Check against email if available
                                        (approver.email && (approver.email === globalUserId || approver.email === companyUserId)) ||
                                        // Check against approver value directly
                                        (approver.value === globalUserId || approver.value === companyUserId)
                                    );
                                    
                                    console.log(`👤 User authorization check: isCurrentUserApprover=${isCurrentUserApprover} for approver "${approver.name}"`);
                                    
                                    // Check if level is unlocked (for sequential approval)
                                    const isLevelUnlocked = (approvalFlow.approvalOrder !== 'sequential' || 
                                                           levelIndex === 0 || 
                                                           ['approved','completed'].includes(String(approvalFlow.levels[levelIndex - 1].status||'').toLowerCase()));
                                    
                                    console.log(`🔓 Level unlock check: isLevelUnlocked=${isLevelUnlocked}, approvalOrder=${approvalFlow.approvalOrder}, levelIndex=${levelIndex}, previousLevelStatus=${levelIndex > 0 ? approvalFlow.levels[levelIndex - 1].status : 'N/A'}`);
                                    
                                    // User can click if they are the approver, the approver status is pending, 
                                    // the level is not completed, not locked, and level is unlocked
                                    const isClickable = isCurrentUserApprover && 
                                                      approver.status === 'pending' && 
                                                      level.status !== 'approved' && 
                                                      level.status !== 'completed' &&
                                                      level.status !== 'locked' && 
                                                      isLevelUnlocked;
                                    
                                    console.log(`🎯 Final clickable determination: ${isClickable} (isCurrentUserApprover=${isCurrentUserApprover}, approver.status=${approver.status}, level.status=${level.status}, isLevelUnlocked=${isLevelUnlocked})`);
                                    
                                    const isLPlusOne = (
                                        (approver.value || '').toString().toLowerCase().includes('l+1') ||
                                        (approver.role || '').toString().toLowerCase().includes('l+1') ||
                                        (approver.label || '').toString().toLowerCase().includes('l+1') ||
                                        (approver.text || '').toString().toLowerCase().includes('l+1')
                                    );
                                    // Robust approver name resolution
                                    let approverName = approver.name || approver.displayName || approver.approverName || approver.label || approver.text || '';
                                    if (!approverName) {
                                        // Extract email from value if present
                                        const emailMatch = /[\w.+-]+@[\w.-]+\.[A-Za-z]{2,}/.exec(String(approver.value||''));
                                        if (emailMatch) approverName = emailMatch[0];
                                    }
                                    if (isLPlusOne && position && position.lineManager) {
                                        approverName = typeof formatLineManagerName === 'function'
                                            ? formatLineManagerName(position.lineManager)
                                            : String(position.lineManager).split(/[,|\-]/)[0].trim();
                                    }
                                    if (!approverName || approverName === 'Not assigned') approverName = 'Approver';
                                    // Build pill-style name to match leave modal styling and append signature if approved
                                    
                                    console.log(`🎭 Rendering approver ${approverIndex}: name="${approverName}", original="${approver.name}", email="${approver.email || 'none'}", isCurrentUser: ${isCurrentUserApprover}, globalUserId: ${globalUserId}, companyUserId: ${companyUserId}`);

                                    // Determine if approver is approved
                                    const isApproved = (approver.status === 'approved');
                                    // Gather possible userId candidates to resolve signature URL
                                    const uidCandidates = [];
                                    if (approver.userId) uidCandidates.push(String(approver.userId));
                                    if (approver.approverId) uidCandidates.push(String(approver.approverId));
                                    if (approver.value && typeof approver.value === 'string') {
                                        if (approver.value.startsWith('user_')) uidCandidates.push(approver.value.replace('user_', ''));
                                        else if (/^[A-Za-z0-9_-]{10,}$/.test(approver.value)) uidCandidates.push(approver.value);
                                    }
                                    const approverEmailCandidate = (approver.email || approver.approverEmail || approver.userEmail || '').trim();
                                    const sigUrl = isApproved ? resolveSignatureUrl(sigLookup, uidCandidates, approverName, approverEmailCandidate) : '';
                                    const clickableClass = isClickable ? ' clickable' : '';
                                    const dataAttrs = isClickable
                                        ? ` data-level-index="${levelIndex}" data-approver-index="${approverIndex}" data-recruitment-request-id="${positionId}" data-approver-name="${approverName}"`
                                        : '';

                                    if (isApproved && sigUrl) {
                                        return `<div class="approver-pill${clickableClass}"${dataAttrs} style="display:flex; flex-direction:column; gap:4px; align-items:flex-start; cursor:${isClickable ? 'pointer' : 'default'};">
                                            <span class="approver-name" style="font-size:0.65rem; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3;">${approverName}</span>
                                            <img src="${sigUrl}" alt="${approverName} signature" style="height:16px; max-width:140px; object-fit:contain; background:#fff; border:1px solid #e5e7eb; border-radius:4px; padding:2px;"/>
                                        </div>`;
                                    }

                                    return `<span class="approver-pill${clickableClass}"${dataAttrs} style="font-size:0.65rem; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; cursor:${isClickable ? 'pointer' : 'default'};">${approverName}</span>`;
                                }));
                                
                                return approversHTML.join('');
                            };

                            const headerHtml = `<div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-size:0.7rem; font-weight:600;">Level ${levelIndex + 1}</div>
                                <div class="approver-pill-list" style="display:flex; flex-wrap:wrap; gap:6px;"><span style="font-size:0.65rem; color:#6b7280;">Loading approvers...</span></div>
                            </div>`;
                            levelElement.innerHTML = headerHtml;

                            approvalLevelsContainer.appendChild(levelElement);

                            // Process approvers and update the pills container
                            processApproversAsync().then(approversHTML => {
                                const pillList = levelElement.querySelector('.approver-pill-list');
                                if (pillList) {
                                    pillList.innerHTML = approversHTML;
                                    // Attach click handlers for clickable approver pills (current user + unlocked + pending)
                                    pillList.querySelectorAll('.approver-pill.clickable').forEach(pill => {
                                        pill.addEventListener('click', async (e) => {
                                            e.preventDefault();
                                            const lvlIdx = parseInt(pill.getAttribute('data-level-index') || '-1', 10);
                                            const apprIdx = parseInt(pill.getAttribute('data-approver-index') || '-1', 10);
                                            const reqId = pill.getAttribute('data-recruitment-request-id') || positionId;
                                            if (lvlIdx < 0 || apprIdx < 0 || !reqId) return;
                                            const approverName = pill.getAttribute('data-approver-name') || 'Approver';
                                            const confirmed = window.confirm(`Approve this step for ${approverName}?`);
                                            if (!confirmed) return;
                                            try {
                                                await updateRecruitmentApprovalStatus(reqId, lvlIdx, apprIdx);
                                                // Re-render to show updated status and signature
                                                await loadApprovalFlowForPosition(reqId, position);
                                            } catch (err) {
                                                console.error('Approve via pill failed', err);
                                                window.showNotification && window.showNotification('Failed to approve step', 'error');
                                            }
                                        });
                                    });
                                }
                            }).catch(err => {
                                console.warn('Failed to render approvers for level', levelIndex, err);
                                const pillList = levelElement.querySelector('.approver-pill-list');
                                if (pillList) {
                                    pillList.innerHTML = `<span style="font-size:0.65rem; color:#9ca3af;">No approvers configured.</span>`;
                                }
                            });
                        });

                        // After levels render, show approval history table
                // Re-render approval flow and history
                try { 
                    await renderRecruitmentApprovalHistory(positionId, approvalFlow, sigLookup); 
                    // After flow renders, refresh button visibility for sequential approvals
                    const modal = document.getElementById('viewDetailsModal');
                    if (modal && modal.style.display !== 'none') {
                        // Modal is open, refresh button state
                        setTimeout(() => {
                            if (typeof checkApproverStatus === 'function') {
                                checkApproverStatus();
                            }
                        }, 100);
                    }
                } catch(e){ console.warn('History render error', e); }

                        // Remove any existing click handlers before adding new ones
                        document.querySelectorAll('.approver-details').forEach(approver => {
                            const oldClone = approver.cloneNode(true);
                            approver.parentNode.replaceChild(oldClone, approver);
                        });
                        
                        // Add click handlers for approvers - only for clickable elements
                        document.querySelectorAll('.approver-details.clickable').forEach(approver => {
                            approver.addEventListener('click', async function() {
                                console.log('🖱️ Approver click handler triggered');
                                console.log('📊 Current approver element:', this);
                                
                                // Get authorization data from the element
                                const isCurrentUser = this.dataset.isCurrentUser === 'true';
                                const canApprove = this.dataset.canApprove === 'true';
                                
                                // Double-check authorization before processing
                                if (!isCurrentUser || !canApprove) {
                                    console.warn('⚠️ Unauthorized approval attempt:', { isCurrentUser, canApprove });
                                    if (window.showNotification) {
                                        window.showNotification('You are not authorized to approve this step', 'error');
                                    }
                                    return;
                                }

                                // Show confirmation dialog before processing approval
                                const approverName = this.querySelector('.approver-name').textContent.trim().replace('✓', '').trim();
                                const levelName = this.closest('.approval-level').querySelector('.level-header').textContent.split('\n')[0].trim();
                                
                                const confirmed = confirm(`Are you sure you want to approve this step?\n\nLevel: ${levelName}\nApprover: ${approverName}\n\nThis action cannot be undone.`);
                                if (!confirmed) {
                                    console.log('❌ User cancelled approval action');
                                    return;
                                }

                                const levelIndex = this.dataset.levelIndex;
                                const approverIndex = this.dataset.approverIndex;
                                const recruitmentRequestId = this.dataset.recruitmentRequestId;

                                console.log(`✅ Processing approval from authorized user: level ${levelIndex}, approver ${approverIndex}`);

                                try {
                                    // Update the UI immediately for better user feedback
                                    this.classList.remove('pending');
                                    this.classList.add('approved');
                                    this.classList.remove('clickable');
                                    this.classList.add('not-clickable');

                                    const date = new Date().toLocaleDateString();
                                    this.innerHTML = this.innerHTML.replace(
                                        /<span class="approver-status.*?<\/span>/,
                                        `<div class="approval-info">
                                            <i class="fas fa-check-circle"></i>
                                            <span class="approval-date">${date}</span>
                                        </div>`
                                    );

                                    // Make API call to update approval status
                                    await updateRecruitmentApprovalStatus(recruitmentRequestId, levelIndex, approverIndex);

                                    // Update the approver's UI with approval info
                                    this.innerHTML = `
                                        <div class="approver-avatar ${this.querySelector('.approver-avatar').className}">
                                            ${this.querySelector('.approver-avatar').innerHTML}
                                        </div>
                                        <div class="approver-info">
                                            ${this.querySelector('.approver-info').innerHTML}
                                        </div>
                                        <div class="approval-info">
                                            <i class="fas fa-check-circle"></i>
                                            <span class="approval-date">${new Date().toLocaleDateString()}</span>
                                        </div>
                                    `;

                                    // Small delay to ensure Firebase propagation
                                    await new Promise(resolve => setTimeout(resolve, 1000));

                                    // Always refresh the approval flow to get the latest status from Firebase
                                    console.log(`🔄 Fetching updated approval flow after Firebase update...`);
                                    const updatedFlow = await window.fetchRecruitmentApprovalFlow(recruitmentRequestId);
                                    console.log(`📋 Updated flow received:`, updatedFlow);
                                    
                                    // Force re-render the entire approval flow to reflect all changes
                                    console.log(`🔄 Re-rendering approval flow to reflect all status changes...`);
                                    await loadApprovalFlowForPosition(recruitmentRequestId);
                                    
                                    console.log(`✅ Approval flow successfully updated in modal`);
                                    
                                    // Update the level status immediately for better user feedback
                                    const levelElement = this.closest('.approval-level');
                                    const levelStatusElement = levelElement.querySelector('.level-status');
                                    
                                    console.log(`📊 Processing approval completion check after individual approval...`);
                                    
                                    // Get the LATEST level data from the refreshed flow
                                    const currentLevel = updatedFlow.levels[levelIndex];
                                    console.log(`🔍 Latest level data from Firebase:`, currentLevel);
                                    
                                    if (!currentLevel) {
                                        console.error(`❌ Could not find level ${levelIndex} in updated flow`);
                                        return;
                                    }
                                    
                                    // Calculate approval status from the latest data
                                    const approvers = currentLevel.approvers || [];
                                    const approvedCount = approvers.filter(app => app.status === 'approved').length;
                                    const totalApprovers = approvers.length;
                                    
                                    console.log(`📊 Latest approval counts: ${approvedCount}/${totalApprovers}`);
                                    console.log(`🔍 Latest approver statuses:`, approvers.map(a => `${a.name}: ${a.status}`));
                                    
                                    // Check level completion with the latest data
                                    const allApproversApproved = approvers.length > 0 && approvers.every(app => app.status === 'approved');
                                    console.log(`🎯 Level completion check with latest data: ${allApproversApproved}`);
                                    
                                    // Check if level is complete based on the latest data
                                    if (allApproversApproved && approvedCount === totalApprovers) {
                                        console.log(`🎉 Level ${levelIndex + 1} is complete! All ${totalApprovers} approvers have approved.`);
                                        
                                        // Update level status to approved
                                        levelElement.classList.remove('pending');
                                        levelElement.classList.add('approved');
                                        levelElement.classList.add('completed');
                                        
                                        // Update level status display
                                        levelStatusElement.innerHTML = `
                                            <i class="fas fa-check-circle" style="color: #28a745; margin-right: 0.5rem;"></i>
                                            <span style="color: #28a745; font-weight: 600;">Approved</span>
                                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                                <i class="fas fa-clock"></i> ${new Date().toLocaleString()}
                                            </div>
                                        `;
                                        levelStatusElement.className = 'level-status approved completed';
                                        
                                        // Update the level status in Firebase
                                        await updateLevelStatus(recruitmentRequestId, levelIndex, 'approved');
                                        
                                        // Success notification
                                        if (window.showNotification) {
                                            window.showNotification(`🎉 Level "${currentLevel.name}" completed! All approvers have approved.`, 'success');
                                        }
                                        
                                        // Handle sequential unlocking if needed
                                        if (updatedFlow.approvalOrder === 'sequential') {
                                            const nextLevelIndex = parseInt(levelIndex) + 1;
                                            if (nextLevelIndex < updatedFlow.levels.length) {
                                                await unlockNextLevel(recruitmentRequestId, nextLevelIndex);
                                                if (window.showNotification) {
                                                    window.showNotification(`🔓 Next level unlocked and ready for approval!`, 'info');
                                                }
                                            }
                                        }
                                        
                                    } else {
                                        console.log(`⏳ Level ${levelIndex + 1} still in progress: ${approvedCount}/${totalApprovers} approvers completed`);
                                        
                                        // Update progress display
                                        levelStatusElement.innerHTML = `
                                            <i class="fas fa-clock" style="color: #ffc107; margin-right: 0.5rem;"></i>
                                            <span style="color: #856404; font-weight: 600;">Pending</span>
                                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                                ${approvedCount}/${totalApprovers} approvers completed
                                            </div>
                                        `;
                                        levelStatusElement.className = 'level-status pending';
                                            // Persist level status as partially-approved for sequential flows
                                            try { await updateLevelStatus(recruitmentRequestId, levelIndex, 'partially-approved'); } catch(e){ console.warn('Partial level status update failed', e); }
                                        
                                        // Progress notification
                                        if (window.showNotification) {
                                            window.showNotification(`Progress: ${approvedCount}/${totalApprovers} approvers completed`, 'info');
                                        }
                                    }
                                    
                                    console.log(`✅ Individual approval processing completed successfully`);
                                    
                                } catch (error) {
                                    console.error('Error updating approval status:', error);
                                    // Revert UI changes if the update failed
                                    this.classList.remove('approved');
                                    this.classList.add('pending');
                                    this.classList.remove('not-clickable');
                                    this.classList.add('clickable');
                                }
                            });
                        });
                    } else {
                        approvalLevelsContainer.innerHTML = '<p class="no-approver">No approval flow configured</p>';
                        console.log('❌ No approval levels found or empty');
                    }
                } else {
                    console.error('❌ Approval levels container not found');
                }
            } catch (error) {
                console.error('Error rendering recruitment approval flow:', error);
                const approvalLevelsContainer = document.querySelector('#approvalSection .approval-levels');
                if (approvalLevelsContainer) {
                    approvalLevelsContainer.innerHTML = '<p class="no-approver">Error loading approval flow</p>';
                }
            }
        }

        // Function to update recruitment approval status
        async function updateRecruitmentApprovalStatus(recruitmentRequestId, levelIndex, approverIndex) {
            try {
                console.log(`🔄 Updating approval status for: position=${recruitmentRequestId}, level=${levelIndex}, approver=${approverIndex}`);
                
                // Get current company ID
                const companyId = getCurrentCompanyId();
                if (!companyId) {
                    throw new Error('Company context not available');
                }
                
                const timestamp = firebase.database.ServerValue.TIMESTAMP;
                const now = new Date();
                const userId = getCurrentUserId();
                
                // Update all required paths atomically using company-scoped paths
                const updates = {};
                
                // 1. Create approval record in the approvals path
                const approvalRecordPath = `companies/${companyId}/recruit/${recruitmentRequestId}/approvals/level${levelIndex + 1}/approvals`;
                const newApprovalKey = firebase.database().ref(approvalRecordPath).push().key;
                updates[`${approvalRecordPath}/${newApprovalKey}`] = {
                    status: 'approved',
                    approvedAt: now.toISOString(),
                    approvedDateTime: now.toLocaleString(),
                    approverId: userId,
                    approverIndex: approverIndex,
                    timestamp: timestamp
                };
                
                // 2. Update approver status in the flow structure
                const approverPath = `companies/${companyId}/recruit/${recruitmentRequestId}/approvalFlow/levels/${levelIndex}/approvers/${approverIndex}`;
                updates[approverPath] = {
                    status: 'approved',
                    date: now.toLocaleDateString(),
                    approvedAt: now.toISOString(),
                    approvedDateTime: now.toLocaleString(),
                    approverId: userId,
                    timestamp: timestamp
                };
                
                // 3. Update level status path
                const levelStatusPath = `companies/${companyId}/recruit/${recruitmentRequestId}/approvalFlow/levels/${levelIndex}`;
                updates[`${levelStatusPath}/lastUpdate`] = {
                    timestamp: timestamp,
                    updatedBy: userId,
                    action: 'approval'
                };
                
                console.log(`📝 Preparing atomic update with company-scoped paths:`, Object.keys(updates));
                console.log(`📝 Update data:`, updates);

                // Perform all updates atomically
                await firebase.database().ref().update(updates);
                console.log(`✅ All company-scoped paths updated successfully`);
                
                // Verify the updates
                const [approvalVerify, flowVerify] = await Promise.all([
                    firebase.database().ref(approvalRecordPath).once('value'),
                    firebase.database().ref(approverPath).once('value')
                ]);
                
                console.log(`🔍 Verification:
                    Approval Record: ${JSON.stringify(approvalVerify.val())}
                    Flow Status: ${JSON.stringify(flowVerify.val())}
                `);
                
                // Show success notification
                if (window.showNotification) {
                    window.showNotification('Approval submitted successfully', 'success');
                }
                
            } catch (error) {
                console.error('Error updating recruitment approval status:', error);
                
                // Show error notification
                if (window.showNotification) {
                    window.showNotification('Failed to submit approval: ' + error.message, 'error');
                }
                throw error;
            }
        }

        // Function to update level status when all approvers complete
        async function updateLevelStatus(recruitmentRequestId, levelIndex, status) {
            try {
                console.log(`🔄 Updating level ${levelIndex + 1} status to: ${status}`);
                
                // Get current company ID
                const companyId = getCurrentCompanyId();
                if (!companyId) {
                    throw new Error('Company context not available');
                }
                
                // Update both the approval flow and approvals record paths using company scope
                const levelApprovalPath = `companies/${companyId}/recruit/${recruitmentRequestId}/approvals/level${levelIndex + 1}`;
                const levelFlowPath = `companies/${companyId}/recruit/${recruitmentRequestId}/approvalFlow/levels/${levelIndex}`;
                
                const statusUpdate = {
                    status: status,
                    completedAt: new Date().toISOString(),
                    completedDateTime: new Date().toLocaleString(),
                    completedBy: getCurrentUserId()
                };
                
                console.log(`📝 Updating level status in both company-scoped paths:`, statusUpdate);

                // Update both paths simultaneously
                await Promise.all([
                    firebase.database().ref(levelApprovalPath).update(statusUpdate),
                    firebase.database().ref(levelFlowPath).update(statusUpdate)
                ]);
                
                console.log(`✅ Level ${levelIndex + 1} status updated to: ${status} in both company-scoped paths`);
                
                // Verify the updates
                const [approvalVerify, flowVerify] = await Promise.all([
                    firebase.database().ref(levelApprovalPath).once('value'),
                    firebase.database().ref(levelFlowPath).once('value')
                ]);
                
                console.log(`🔍 Verification:
                    Approval Path: ${approvalVerify.val()?.status}
                    Flow Path: ${flowVerify.val()?.status}
                `);
                
            } catch (error) {
                console.error('Error updating level status:', error);
                throw error;
            }
        }

        // Function to unlock the next level in sequential approval flows
        async function unlockNextLevel(recruitmentRequestId, nextLevelIndex) {
            try {
                console.log(`🔓 Unlocking next level ${nextLevelIndex + 1} for position ${recruitmentRequestId}`);
                
                // Get current company ID
                const companyId = getCurrentCompanyId();
                if (!companyId) {
                    throw new Error('Company context not available');
                }
                
                // Update the approver flow structure to unlock the next level using company scope
                const nextLevelPath = `companies/${companyId}/recruit/${recruitmentRequestId}/approvalFlow/levels/${nextLevelIndex}`;
                const unlockData = {
                    status: 'pending',
                    unlockedAt: new Date().toISOString(),
                    unlockedDateTime: new Date().toLocaleString(),
                    unlockedBy: getCurrentUserId()
                };

                await firebase.database().ref(nextLevelPath).update(unlockData);
                console.log(`✅ Next level ${nextLevelIndex + 1} unlocked in company-scoped approval flow`);
                
                // Also update in the approvals path for consistency
                const nextLevelApprovalsPath = `companies/${companyId}/recruit/${recruitmentRequestId}/approvals/level${nextLevelIndex + 1}`;
                const approvalsUnlockData = {
                    status: 'pending',
                    unlockedAt: new Date().toISOString(),
                    unlockedDateTime: new Date().toLocaleString(),
                    unlockedBy: getCurrentUserId()
                };

                await firebase.database().ref(nextLevelApprovalsPath).update(approvalsUnlockData);
                console.log(`✅ Next level ${nextLevelIndex + 1} unlocked in company-scoped approvals path`);
                
                // Update next level approvers to pending status (unlock UI for them)
                const nextLevelApproversPath = `companies/${companyId}/recruit/${recruitmentRequestId}/approvalFlow/levels/${nextLevelIndex}/approvers`;
                const nextLevelApproversSnapshot = await firebase.database().ref(nextLevelApproversPath).once('value');
                const nextLevelApprovers = nextLevelApproversSnapshot.val();
                
                if (nextLevelApprovers) {
                    const approverUpdates = {};
                    Object.keys(nextLevelApprovers).forEach(approverKey => {
                        const cur = nextLevelApprovers[approverKey] || {};
                        const curStatus = String(cur.status || '').toLowerCase();
                        // Only keep terminal states as-is; otherwise set to pending
                        if (!['approved','declined','rejected'].includes(curStatus)) {
                            approverUpdates[`${approverKey}/status`] = 'pending';
                            approverUpdates[`${approverKey}/unlockedAt`] = new Date().toISOString();
                        }
                    });
                    
                    if (Object.keys(approverUpdates).length > 0) {
                        await firebase.database().ref(nextLevelApproversPath).update(approverUpdates);
                        console.log(`✅ Updated next level approvers to pending (count=${Object.keys(approverUpdates).length / 2})`);
                    }
                }
                
            } catch (error) {
                console.error('Error unlocking next level:', error);
                throw error;
            }
        }

        // Function to update overall position approval status
        async function updateOverallPositionStatus(recruitmentRequestId, status) {
            try {
                // Get current company ID
                const companyId = getCurrentCompanyId();
                if (!companyId) {
                    throw new Error('Company context not available');
                }
                
                const positionUpdateData = {
                    approvalStatus: status,
                    finalApprovalAt: new Date().toISOString(),
                    finalApprovalDateTime: new Date().toLocaleString(),
                    finalApprovedBy: getCurrentUserId()
                };

                // Update using company-scoped path
                await firebase.database().ref(`companies/${companyId}/recruit/${recruitmentRequestId}`).update(positionUpdateData);
                console.log(`🎊 Overall position ${recruitmentRequestId} approval status updated to: ${status} in company-scoped path`);
                
                // Refresh the recruitment data to reflect the status change
                if (typeof loadRecruitmentRequests === 'function') {
                    loadRecruitmentRequests();
                }
                if (typeof loadApprovedPositions === 'function') {
                    loadApprovedPositions();
                }
                
            } catch (error) {
                console.error('Error updating overall position status:', error);
                throw error;
            }
        }

        // Helper function to get current user ID (you may need to implement this)
        function getCurrentUserId() {
            // This should return the current logged-in user's ID
            // You can implement this based on your authentication system
            return firebase.auth().currentUser?.uid || 'unknown';
        }

        // Cleanup function to remove transferred recruitment requests (optional)
        async function cleanupTransferredRecruitmentRequests() {
            try {
                const companyId = getCurrentCompanyId();
                if (!companyId) return;

                const recruitRef = firebase.database().ref(`companies/${companyId}/recruit`);
                const snapshot = await recruitRef.once('value');
                
                if (snapshot.exists()) {
                    const recruitData = snapshot.val();
                    let cleanupCount = 0;
                    
                    for (const [recruitId, recruit] of Object.entries(recruitData)) {
                        // Remove recruitment requests that have been transferred to jobs and are older than 24 hours
                        if (recruit.transferredToJobs && recruit.publishedDate) {
                            const publishedTime = new Date(recruit.publishedDate);
                            const now = new Date();
                            const hoursDiff = (now - publishedTime) / (1000 * 60 * 60);
                            
                            if (hoursDiff > 24) {
                                await firebase.database().ref(`companies/${companyId}/recruit/${recruitId}`).remove();
                                console.log(`🧹 Cleaned up transferred recruitment request: ${recruitId}`);
                                cleanupCount++;
                            }
                        }
                    }
                    
                    if (cleanupCount > 0) {
                        console.log(`✅ Cleanup completed: Removed ${cleanupCount} transferred recruitment requests`);
                    }
                }
            } catch (error) {
                console.error('Error during cleanup:', error);
            }
        }

        // Run cleanup periodically (every hour) - commented out for now
        // setInterval(cleanupTransferredRecruitmentRequests, 60 * 60 * 1000);
    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded (styles are embedded, so this should always pass)
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let externalCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('font-awesome') || link.href.includes('cdnjs')) {
      externalCssLoaded = true;
    }
  });
  
  // Check if Font Awesome is loaded
  const testIcon = document.createElement('i');
  testIcon.className = 'fas fa-home';
  testIcon.style.position = 'absolute';
  testIcon.style.left = '-9999px';
  document.body.appendChild(testIcon);
  
  setTimeout(() => {
    const computedStyle = window.getComputedStyle(testIcon, ':before');
    const fontFamily = computedStyle.getPropertyValue('font-family');
    
    if (!fontFamily.includes('Font Awesome')) {
      console.warn('Font Awesome may not be loaded properly - icons might not display');
    }
    
    document.body.removeChild(testIcon);
  }, 100);
  
  // Check if Firebase is loaded
  if (typeof firebase === 'undefined') {
    console.error('Firebase SDK not loaded - page functionality will be limited');
    // Show user-friendly error message
    const errorDiv = document.createElement('div');
    errorDiv.innerHTML = `
      <div style="position: fixed; top: 20px; right: 20px; background: #e74c3c; color: white; padding: 15px; border-radius: 5px; z-index: 10000; max-width: 300px;">
        <strong>⚠️ Connection Error</strong><br>
        Unable to load required services. Please check your internet connection and refresh the page.
      </div>
    `;
    document.body.appendChild(errorDiv);
    
    // Auto-hide error after 10 seconds
    setTimeout(() => {
      if (errorDiv.parentNode) {
        errorDiv.parentNode.removeChild(errorDiv);
      }
    }, 10000);
  }
  
  // Check if all Firebase modules are loaded
  setTimeout(() => {
    if (typeof firebase !== 'undefined') {
      const requiredModules = ['auth', 'database', 'storage'];
      const missingModules = [];
      
      requiredModules.forEach(module => {
        if (!firebase[module]) {
          missingModules.push(module);
        }
      });
      
      if (missingModules.length > 0) {
        console.warn('Missing Firebase modules:', missingModules);
      } else {
        console.log('✅ All required Firebase modules loaded successfully');
      }
    }
  }, 1000);
});

// Global error handler for unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
  console.error('Unhandled promise rejection:', event.reason);
  // Prevent the default browser error handling
  event.preventDefault();
});

// Global error handler for JavaScript errors
window.addEventListener('error', function(event) {
  console.error('JavaScript error:', event.error);
});

// Network connection check
function checkNetworkConnection() {
  if (!navigator.onLine) {
    const offlineDiv = document.createElement('div');
    offlineDiv.innerHTML = `
      <div style="position: fixed; top: 20px; left: 20px; background: #f39c12; color: white; padding: 15px; border-radius: 5px; z-index: 10000;">
        <strong>📡 Offline</strong><br>
        You appear to be offline. Some features may not work properly.
      </div>
    `;
    document.body.appendChild(offlineDiv);
    
    // Remove when back online
    window.addEventListener('online', () => {
      if (offlineDiv.parentNode) {
        offlineDiv.parentNode.removeChild(offlineDiv);
      }
    });
  }
}

// Check network status on load and when it changes
window.addEventListener('load', checkNetworkConnection);
window.addEventListener('offline', checkNetworkConnection);

console.log('📋 Recruitment Board page initialized - Standalone version with all dependencies');
</script>
<script>
// Recruitment Access Control Settings
// Stores per-role recruitment permissions under: companies/{companyId}/recruitmentSettings/access
// Structure: { role: { view: true, create: false, approve: false, ... } }

async function getCurrentCompanyContextForSettings() {
    try {
        if (typeof getCurrentCompanyId === 'function') {
            const id = getCurrentCompanyId();
            if (id) return id;
        }
        // Fallback localStorage
        const stored = localStorage.getItem('currentCompanyId');
        return stored || 'default';
    } catch { return 'default'; }
}

async function loadRecruitmentAccessSettings() {
    // Prevent reloading if already loaded once
    if (window._recruitAccessLoaded) return;
    window._recruitAccessLoaded = true;
    const companyId = await getCurrentCompanyContextForSettings();
    if (!window.firebase || !firebase.database) return;
    try {
        const snap = await firebase.database().ref(`companies/${companyId}/recruitmentSettings/access`).get();
        if (snap.exists()) {
            const data = snap.val();
            applyAccessSettingsToUI(data);
        }
        // Load user overrides
        const overridesSnap = await firebase.database().ref(`companies/${companyId}/recruitmentSettings/userOverrides`).get();
        if (overridesSnap.exists()) {
            const overrides = overridesSnap.val();
            // Make sure company users cache is ready for table rendering
            if (!window._recruitOverrideUserListLoaded) {
                await loadUserListForOverrides();
            }
            renderUserOverrides(overrides);
            window._recruitUserOverridesCache = overrides;
        } else {
            renderUserOverrides({});
        }
    } catch (err) {
        console.error('Failed to load recruitment access settings', err);
        window._recruitAccessLoaded = false; // allow retry
    }
}

// Approval Configuration: Load and Save
window._recruitApprovalConfig = { approvers: [] };

async function loadRecruitmentApprovalConfig() {
    try {
        const companyId = await getCurrentCompanyContextForSettings();
        if (!companyId || !window.firebase || !firebase.database) return;
        const snapshot = await firebase.database().ref(`companies/${companyId}/recruitmentSettings/approval/authorityToRecruit`).once('value');
        const val = snapshot.val() || {};
        const approvers = Array.isArray(val.approvers) ? val.approvers.map(e => (e||'').toLowerCase()) : [];
        window._recruitApprovalConfig = { approvers };
        const ta = document.getElementById('atrApproverList');
        if (ta) ta.value = approvers.join('\n');
        // Ensure user list is ready so we can render names in table
        if (!window._recruitOverrideUserListLoaded) {
            try { await loadUserListForOverrides(); } catch(_) {}
        }
        try { renderApprovalApproversTable(); } catch(_) {}
    } catch (e) { console.warn('Approval config load failed:', e); }
}

async function saveRecruitmentApprovalConfig() {
    try {
        const ta = document.getElementById('atrApproverList');
        const raw = (ta?.value || '').split(/\r?\n/).map(s => s.trim().toLowerCase()).filter(Boolean);
        const unique = Array.from(new Set(raw));
        const companyId = await getCurrentCompanyContextForSettings();
        if (!companyId || !window.firebase || !firebase.database) return;
        await firebase.database().ref(`companies/${companyId}/recruitmentSettings/approval/authorityToRecruit`).update({ approvers: unique });
        window._recruitApprovalConfig = { approvers: unique };
        if (typeof showRecruitmentSettingsNotification === 'function') {
            showRecruitmentSettingsNotification('Approval configuration saved', 'success');
        }
    } catch (e) {
        console.error('Failed to save approval config:', e);
        if (typeof showRecruitmentSettingsNotification === 'function') {
            showRecruitmentSettingsNotification('Failed to save approval configuration', 'error');
        }
    }
}

// Approval Configuration UI: render table of approvers
function renderApprovalApproversTable() {
    const tbody = document.getElementById('approvalConfigTableBody');
    const empty = document.getElementById('approvalConfigEmpty');
    if (!tbody) return;
    tbody.innerHTML = '';
    const approvers = (window._recruitApprovalConfig?.approvers || []).slice().sort();
    if (!approvers.length) { if (empty) empty.style.display = 'block'; return; } else if (empty) empty.style.display = 'none';
    const users = window._recruitOverrideUsersCache || [];
    const emailToUser = new Map(users.filter(u=>u.email).map(u=>[u.email.toLowerCase(), u]));
    approvers.forEach(email => {
        const u = emailToUser.get(email) || { name: '', email };
        const name = u?.name || '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${name ? name : '<span style="color:#94a3b8;">(Unknown)</span>'}</td>
            <td>${email}</td>
            <td style="white-space:nowrap;">
                <button type="button" class="btn btn-danger" style="font-size:.65rem;" onclick="removeApprovalApprover('${email.replace(/'/g, "&#39;")}')"><i class="fas fa-trash"></i> Remove</button>
            </td>`;
        tbody.appendChild(tr);
    });
}

// Collapsible behavior for Approval Configuration card
function toggleApprovalConfigWrap() {
    const card = document.getElementById('approvalConfigCard');
    if (!card) return;
    const btn = document.getElementById('approvalWrapBtn');
    const wasCollapsed = card.classList.contains('collapsed');
    if (wasCollapsed) {
        card.classList.remove('collapsed');
        if (btn) {
            const icon = btn.querySelector('i');
            const label = btn.querySelector('.wrap-label');
            if (icon) icon.className = 'fas fa-chevron-up';
            if (label) label.textContent = 'Wrap';
        }
    } else {
        card.classList.add('collapsed');
        if (btn) {
            const icon = btn.querySelector('i');
            const label = btn.querySelector('.wrap-label');
            if (icon) icon.className = 'fas fa-chevron-down';
            if (label) label.textContent = 'Unwrap';
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const approvalHeader = document.querySelector('#approvalConfigCard .collapsible-header');
    const approvalBtn = document.getElementById('approvalWrapBtn');
    if (approvalHeader) approvalHeader.addEventListener('click', (e) => {
        if (e.target && e.target.closest('#approvalWrapBtn')) return;
        toggleApprovalConfigWrap();
    });
    if (approvalBtn) approvalBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleApprovalConfigWrap(); });
});

// Approver selection modal
function openApprovalApproverModal() {
    const modal = document.getElementById('approvalApproverModal');
    if (!modal) return;
    modal.style.display='flex';
    modal.classList.add('show');
    const select = document.getElementById('approvalApproverSelect');
    const search = document.getElementById('approvalApproverSearch');
    const bind = () => {
        if (search) search.oninput = () => populateApprovalApproverOptions(search.value||'');
        populateApprovalApproverOptions('');
    };
    if (!window._recruitOverrideUserListLoaded) {
        loadUserListForOverrides().then(bind).catch(bind);
    } else { bind(); }
    if (select) select.value = '';
}

function closeApprovalApproverModal() {
    const modal = document.getElementById('approvalApproverModal');
    if (modal) { modal.classList.remove('show'); modal.style.display='none'; }
    const form = document.getElementById('approvalApproverForm');
    if (form) form.reset();
}

function populateApprovalApproverOptions(filter) {
    const select = document.getElementById('approvalApproverSelect');
    if (!select) return;
    const list = (window._recruitOverrideUsersCache || []);
    select.innerHTML = '<option value="">-- Select a user --</option>';
    const f = (filter||'').toLowerCase();
    const existing = new Set((window._recruitApprovalConfig?.approvers||[]).map(e=>e.toLowerCase()));
    list.forEach(u => {
        if (!u.email || existing.has(u.email.toLowerCase())) return;
        const hay = (u.name+' '+u.dept+' '+u.email).toLowerCase();
        if (f && !hay.includes(f)) return;
        const opt = document.createElement('option');
        opt.value = u.email;
        const label = u.dept ? `${u.name} - ${u.dept}` : (u.name || u.email);
        opt.textContent = u.name || u.dept ? `${label} - ${u.email}` : u.email;
        select.appendChild(opt);
    });
}

async function saveApprovalApprover() {
    const select = document.getElementById('approvalApproverSelect');
    if (!select || !select.value) { alert('Please select a user'); return; }
    const email = (select.value||'').toLowerCase();
    const companyId = await getCurrentCompanyContextForSettings();
    try {
        const current = new Set((window._recruitApprovalConfig?.approvers||[]).map(e=>e.toLowerCase()));
        current.add(email);
        const next = Array.from(current);
        await firebase.database().ref(`companies/${companyId}/recruitmentSettings/approval/authorityToRecruit`).update({ approvers: next });
        window._recruitApprovalConfig.approvers = next;
        renderApprovalApproversTable();
        if (typeof showRecruitmentSettingsNotification === 'function') showRecruitmentSettingsNotification('Approver added', 'success');
        closeApprovalApproverModal();
    } catch (e) {
        console.error('Failed to add approver', e);
        if (typeof showRecruitmentSettingsNotification === 'function') showRecruitmentSettingsNotification('Failed to add approver', 'error');
    }
}

async function removeApprovalApprover(email) {
    const companyId = await getCurrentCompanyContextForSettings();
    try {
        const set = new Set((window._recruitApprovalConfig?.approvers||[]).map(e=>e.toLowerCase()));
        set.delete((email||'').toLowerCase());
        const next = Array.from(set);
        await firebase.database().ref(`companies/${companyId}/recruitmentSettings/approval/authorityToRecruit`).update({ approvers: next });
        window._recruitApprovalConfig.approvers = next;
        renderApprovalApproversTable();
        if (typeof showRecruitmentSettingsNotification === 'function') showRecruitmentSettingsNotification('Approver removed', 'success');
    } catch (e) {
        console.error('Failed to remove approver', e);
        if (typeof showRecruitmentSettingsNotification === 'function') showRecruitmentSettingsNotification('Failed to remove approver', 'error');
    }
}

function collectAccessSettingsFromUI() {
    const result = {};
    document.querySelectorAll('#settingsTabContent .access-role-card').forEach(card => {
        const role = card.getAttribute('data-role');
        if (!role) return;
        result[role] = {};
        card.querySelectorAll('input[type="checkbox"][data-perm]').forEach(cb => {
            const perm = cb.getAttribute('data-perm');
            result[role][perm] = cb.checked;
        });
    });
    return result;
}

function applyAccessSettingsToUI(settings) {
    Object.entries(settings).forEach(([role, perms]) => {
        const card = document.querySelector(`#settingsTabContent .access-role-card[data-role="${role}"]`);
        if (!card) return;
        Object.entries(perms).forEach(([perm, val]) => {
            const cb = card.querySelector(`input[data-perm="${perm}"]`);
            if (cb) cb.checked = !!val;
        });
    });
    // Update summary chips for default card after applying settings
    try { updateDefaultPermSummary(); } catch (_) {}
}

// Collapsible Default card: toggle and summary rendering
function toggleDefaultAccessWrap() {
    const card = document.getElementById('defaultAccessCard');
    if (!card) return;
    const btn = document.getElementById('defaultWrapBtn');
    const wasCollapsed = card.classList.contains('collapsed');
    if (wasCollapsed) {
        card.classList.remove('collapsed');
        if (btn) {
            const icon = btn.querySelector('i');
            const label = btn.querySelector('.wrap-label');
            if (icon) icon.className = 'fas fa-chevron-up';
            if (label) label.textContent = 'Wrap';
        }
    } else {
        card.classList.add('collapsed');
        if (btn) {
            const icon = btn.querySelector('i');
            const label = btn.querySelector('.wrap-label');
            if (icon) icon.className = 'fas fa-chevron-down';
            if (label) label.textContent = 'Unwrap';
        }
        // Ensure summary reflects current checkbox state
        updateDefaultPermSummary();
    }
}

function updateDefaultPermSummary() {
    const card = document.getElementById('defaultAccessCard');
    const summaryEl = document.getElementById('defaultPermSummary');
    if (!card || !summaryEl) return;
    const get = k => !!card.querySelector(`input[type="checkbox"][data-perm="${k}"]`)?.checked;
    const actionMap = [
        ['view','View'], ['create','Create ATR'], ['approve','Approve'], ['decline','Decline'],
        ['fill','Fill'], ['edit','Edit'], ['delete','Delete'], ['export','Export'], ['select','Selection']
    ];
    const tabMap = [
        ['showPending','Pending'], ['showPublished','Published'], ['showDeclined','Declined'], ['showArchives','Archives'], ['showSettings','Settings']
    ];
    const actions = actionMap.filter(([k]) => get(k)).map(([,label]) => label);
    const tabs = tabMap.filter(([k]) => get(k)).map(([,label]) => label);

    const chip = (text, color='#eef2ff', fg='#3730a3') => `<span style="display:inline-block;background:${color};color:${fg};border:1px solid #e5e7eb;border-radius:999px;padding:.15rem .5rem;font-size:.6rem;margin:.15rem .25rem 0 0;">${text}</span>`;
    let html = '';
    html += `<div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;padding-top:.25rem;">
                <span style="font-size:.6rem;color:#64748b;min-width:70px;">Actions:</span>
                ${actions.length ? actions.map(a=>chip(a,'#ecfeff','#155e75')).join('') : `<span style='font-size:.6rem;color:#94a3b8;'>None</span>`}
            </div>`;
    html += `<div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;margin-top:.25rem;">
                <span style="font-size:.6rem;color:#64748b;min-width:70px;">Tabs:</span>
                ${tabs.length ? tabs.map(t=>chip(t,'#f0f9ff','#1e40af')).join('') : `<span style='font-size:.6rem;color:#94a3b8;'>None</span>`}
            </div>`;
    summaryEl.innerHTML = html;
}

// Initialize collapsible behavior for Default card
document.addEventListener('DOMContentLoaded', () => {
    const header = document.querySelector('#defaultAccessCard .collapsible-header');
    const btn = document.getElementById('defaultWrapBtn');
    if (header) header.addEventListener('click', (e) => {
        // Avoid double toggle if button clicked (let single handler run)
        if (e.target && e.target.closest('#defaultWrapBtn')) return;
        toggleDefaultAccessWrap();
    });
    if (btn) btn.addEventListener('click', (e) => { e.stopPropagation(); toggleDefaultAccessWrap(); });
    // Update summary when checkboxes change
    document.querySelectorAll('#defaultAccessCard input[type="checkbox"][data-perm]').forEach(cb => {
        cb.addEventListener('change', updateDefaultPermSummary);
    });
    // Initial summary render
    try { updateDefaultPermSummary(); } catch (_) {}
});

async function saveRecruitmentAccessSettings() {
    const companyId = await getCurrentCompanyContextForSettings();
    const data = collectAccessSettingsFromUI();
    if (!window.firebase || !firebase.database) {
        alert('Firebase not ready. Cannot save settings.');
        return;
    }
    try {
        await firebase.database().ref(`companies/${companyId}/recruitmentSettings/access`).set(data);
        showRecruitmentSettingsNotification('Recruitment access settings saved.', 'success');
        applyRecruitmentPermissionsRuntime(data);
    } catch (err) {
        console.error('Error saving recruitment access settings', err);
        showRecruitmentSettingsNotification('Failed to save settings.', 'error');
    }
}

// User Override Modal Logic
function openUserOverrideModal() {
    const modal = document.getElementById('userOverrideModal');
        if (modal) { modal.style.display='flex'; modal.classList.add('show'); }
    // Load user list and wire search
    if (!window._recruitOverrideUserListLoaded) {
        loadUserListForOverrides();
    } else {
        const s = document.getElementById('recruitAcUserSearch');
        if (s) s.oninput = () => populateRecruitOverrideUserOptions(s.value||'');
        populateRecruitOverrideUserOptions('');
    }
        // Reset search and selection
        const search = document.getElementById('recruitAcUserSearch');
        if (search) search.value = '';
        const select = document.getElementById('overrideUserSelect');
        if (select) { select.value = ''; }
        // Default perms (view only checked)
        setOverridePermsUI({ view: true, create: false, approve: false, decline: false, fill: false, edit: false, delete: false, export: false, select: false });
        // Hook select change to prefill existing override if any
        if (select) {
            select.onchange = () => {
                const email = (select.value||'').toLowerCase();
                if (!email) { setOverridePermsUI({ view: true }); return; }
                const key = email.replace(/[^a-z0-9]/gi,'_');
                const overrides = window._recruitUserOverridesCache || {};
                const existing = overrides[key];
                if (existing && existing.perms) setOverridePermsUI(existing.perms); else setOverridePermsUI({ view: true });
            };
        }
}

function closeUserOverrideModal() {
    const modal = document.getElementById('userOverrideModal');
    if (modal) { modal.classList.remove('show'); modal.style.display='none'; }
    const form = document.getElementById('userOverrideForm');
    if (form) form.reset();
}

async function loadUserListForOverrides() {
    try {
        const companyId = await getCurrentCompanyContextForSettings();
        // Prefer company scope users (as in fleet)
        let users = {};
        if (firebase.database) {
            const companyUsersSnap = await firebase.database().ref(`companies/${companyId}/users`).get();
            if (companyUsersSnap.exists()) {
                users = companyUsersSnap.val();
            } else {
                const staffSnap = await firebase.database().ref(`companies/${companyId}/staff`).get();
                if (staffSnap.exists()) users = staffSnap.val();
                else {
                    const usersSnap = await firebase.database().ref('users').get();
                    if (usersSnap.exists()) users = usersSnap.val();
                }
            }
        }
                // Cache users for filter and sort by name
                window._recruitOverrideUsersCache = Object.entries(users || {}).map(([uid,u]) => ({
                    email: (u.email || u.userEmail || '').toLowerCase(),
                    name: (u.displayName || u.name || `${(u.firstName||'')} ${(u.lastName||'')}`.trim()).trim(),
                    dept: (u.jobTitle || u.positionTitle || u.position || u.department || '').trim(),
                    uid: (u.uid || u.id || uid || '').trim()
                })).filter(x => !!x.email).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
                populateRecruitOverrideUserOptions('');
                const s = document.getElementById('recruitAcUserSearch');
                if (s) s.oninput = () => populateRecruitOverrideUserOptions(s.value||'');
        window._recruitOverrideUserListLoaded = true;
    } catch (e) {
        console.warn('Failed loading user list for overrides', e);
    }
}

function populateRecruitOverrideUserOptions(filter) {
    const select = document.getElementById('overrideUserSelect');
    if (!select) return;
    const list = (window._recruitOverrideUsersCache || []);
    select.innerHTML = '<option value="">-- Select a user --</option>';
    const f = (filter||'').toLowerCase();
    const existing = new Set(
        Object.values(window._recruitUserOverridesCache || {})
            .map(o => (o.email||'').toLowerCase())
            .filter(Boolean)
    );
    list.forEach(u => {
        if (existing.has(u.email)) return; // exclude already added, like fleet
        const hay = (u.name+' '+u.dept+' '+u.email).toLowerCase();
        if (f && !hay.includes(f)) return;
        const opt = document.createElement('option');
        opt.value = u.email;
        const label = u.dept ? `${u.name} - ${u.dept}` : (u.name || u.email);
        opt.textContent = u.name || u.dept ? `${label} - ${u.email}` : u.email;
        if (u.uid) opt.dataset.uid = u.uid;
        if (u.name) opt.dataset.name = u.name;
        select.appendChild(opt);
    });
}

function setOverridePermsUI(perms) {
    const def = Object.assign({ view:false, create:false, approve:false, decline:false, fill:false, edit:false, delete:false, export:false, select:false, showPending:true, showPublished:true, showDeclined:true, showArchives:true, showSettings:true }, perms||{});
    document.querySelectorAll('#userOverrideModal input[type="checkbox"][data-user-perm]').forEach(cb => {
        const key = cb.getAttribute('data-user-perm');
        cb.checked = !!def[key];
    });
}

async function saveUserOverride() {
    const userSelect = document.getElementById('overrideUserSelect');
    if (!userSelect || !userSelect.value) {
        alert('Please select a user');
        return;
    }
    const rawEmail = userSelect.value.trim().toLowerCase();
    const key = rawEmail.replace(/[^a-z0-9]/gi,'_');
    const perms = {};
    document.querySelectorAll('#userOverrideModal input[type="checkbox"][data-user-perm]').forEach(cb => {
        perms[cb.getAttribute('data-user-perm')] = cb.checked;
    });
    const companyId = await getCurrentCompanyContextForSettings();
    try {
        const selectedOption = userSelect.options[userSelect.selectedIndex];
        const name = selectedOption?.dataset?.name || '';
        const userId = selectedOption?.dataset?.uid || '';
        await firebase.database().ref(`companies/${companyId}/recruitmentSettings/userOverrides/${key}`).set({
            email: rawEmail,
            name: name,
            userId: userId,
            perms: perms,
            updatedAt: new Date().toISOString()
        });
        showRecruitmentSettingsNotification('User override saved.', 'success');
        // Update UI table
        if (!window._recruitUserOverridesCache) window._recruitUserOverridesCache={};
        window._recruitUserOverridesCache[key] = { email: rawEmail, name: name, userId: userId, perms: perms };
        if (!window._recruitOverrideUserListLoaded) {
            await loadUserListForOverrides();
        }
        renderUserOverrides(window._recruitUserOverridesCache);
        closeUserOverrideModal();
        // Re-apply runtime with overrides precedence
        applyRecruitmentPermissionsRuntimeWithOverrides();
    } catch (e) {
        console.error('Error saving user override', e);
        showRecruitmentSettingsNotification('Failed to save user override.', 'error');
    }
}

function renderUserOverrides(overrides) {
    const tbody = document.getElementById('recruitAccessControlTableBody');
    const empty = document.getElementById('recruitAccessControlEmpty');
    if (!tbody) return; tbody.innerHTML='';
    const entries = Object.entries(overrides || {});
    if (!entries.length) { if (empty) empty.style.display='block'; return; } else if (empty) empty.style.display='none';
    // Build email->user map from cache
    const users = window._recruitOverrideUsersCache || [];
    const emailToUser = new Map(users.filter(u=>u.email).map(u=>[u.email.toLowerCase(), u]));
    entries.forEach(([key, data]) => {
        const u = emailToUser.get((data.email||'').toLowerCase()) || { name: data.name||'', email: data.email||'', dept:'' };
        const name = u.name || '(No name)';
        const email = u.email || data.email || '-';
        const jobTitle = u.dept || '-';
        const p = data.perms || {};
        const tabsSummary = [p.showPending!==false? 'P':'×', p.showPublished!==false? 'Pub':'×', p.showDeclined!==false? 'Dcl':'×', p.showArchives!==false? 'Arc':'×', p.showSettings!==false? 'S':'×'].join(' ');
        const actionsSummary = [p.create!==false? 'Create':'×', p.approve!==false? 'Approve':'×', p.decline!==false? 'Decline':'×', p.fill!==false? 'Fill':'×', p.edit!==false? 'Edit':'×', p.delete!==false? 'Delete':'×', p.export!==false? 'Export':'×'].join('/');
        const tr = document.createElement('tr');
        tr.className = 'recruit-ac-user-row';
        tr.setAttribute('data-key', key);
        tr.innerHTML = `
            <td style="position:relative;">
                <button type="button" class="perm-toggle" data-key="${key}" title="Toggle permissions" style="background:none;border:none;cursor:pointer;padding:0;margin-right:6px;font-size:.7rem;color:#555;">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <span>${name}</span>
            </td>
            <td>${email}</td>
            <td>${jobTitle}</td>
            <td style="font-size:.6rem;text-align:center;white-space:nowrap;">
                <strong>Tabs:</strong> ${tabsSummary} &nbsp; <strong>Actions:</strong> ${actionsSummary}
            </td>`;
        tbody.appendChild(tr);
        const subTr = document.createElement('tr');
        subTr.className='recruit-ac-perms-row';
        subTr.setAttribute('data-key', key);
        subTr.style.display='none';
        subTr.innerHTML = `
            <td colspan="4" style="background:#f8fafc;border-top:1px solid #e2e8f0;">
              <div style="display:flex;flex-wrap:wrap;gap:2rem;padding:.75rem .5rem;font-size:.65rem;">
                <div style="min-width:180px;">
                  <h4 style="margin:0 0 .4rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Tab Visibility</h4>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="showPending" data-key="${key}" ${p.showPending!==false?'checked':''}> Pending</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="showPublished" data-key="${key}" ${p.showPublished!==false?'checked':''}> Published</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="showDeclined" data-key="${key}" ${p.showDeclined!==false?'checked':''}> Declined</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="showArchives" data-key="${key}" ${p.showArchives!==false?'checked':''}> Archives</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="showSettings" data-key="${key}" ${p.showSettings!==false?'checked':''}> Settings</label>
                </div>
                <div style="min-width:260px;">
                  <h4 style="margin:0 0 .4rem;font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;color:#334155;">Actions</h4>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="view" data-key="${key}" ${p.view!==false?'checked':''}> View Board</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="create" data-key="${key}" ${p.create?'checked':''}> Create Request</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="approve" data-key="${key}" ${p.approve?'checked':''}> Approve Position</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="decline" data-key="${key}" ${p.decline?'checked':''}> Decline Position</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="fill" data-key="${key}" ${p.fill?'checked':''}> Fill Position</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="edit" data-key="${key}" ${p.edit?'checked':''}> Edit Request</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="delete" data-key="${key}" ${p.delete?'checked':''}> Delete Request</label>
                  <label style="display:flex;align-items:center;gap:6px;margin:.25rem 0;"><input type="checkbox" data-rperm="export" data-key="${key}" ${p.export?'checked':''}> Export Data</label>
                </div>
                <div style="min-width:140px;align-self:flex-start;">
                  <button type="button" class="btn btn-danger" style="font-size:.65rem;" onclick="deleteUserOverride('${key}')"><i class="fas fa-trash"></i> Delete</button>
                </div>
              </div>
            </td>`;
        tbody.appendChild(subTr);
    });
    // Toggle expand/collapse
    tbody.onclick = (e)=>{
        const toggle = e.target.closest('.perm-toggle');
        if (!toggle) return;
        const key = toggle.getAttribute('data-key');
        const sub = tbody.querySelector(`.recruit-ac-perms-row[data-key="${key}"]`);
        if (!sub) return;
        const icon = toggle.querySelector('i');
        const isHidden = sub.style.display==='none';
        sub.style.display = isHidden? 'table-row':'none';
        if (icon) icon.className = isHidden? 'fas fa-chevron-up':'fas fa-chevron-down';
    };
    // Persist checkbox changes
    tbody.onchange = async (e)=>{
        const t = e.target; if (!t || !t.matches('input[type="checkbox"][data-key]')) return;
        const key = t.getAttribute('data-key');
        const perm = t.getAttribute('data-rperm');
        const companyId = await getCurrentCompanyContextForSettings();
        try {
            const ref = firebase.database().ref(`companies/${companyId}/recruitmentSettings/userOverrides/${key}/perms/${perm}`);
            await ref.set(!!t.checked);
            // Update cache and re-render summaries
            if (!window._recruitUserOverridesCache) window._recruitUserOverridesCache={};
            if (!window._recruitUserOverridesCache[key]) window._recruitUserOverridesCache[key] = { email:'', perms:{} };
            window._recruitUserOverridesCache[key].perms = window._recruitUserOverridesCache[key].perms || {};
            window._recruitUserOverridesCache[key].perms[perm] = !!t.checked;
            renderUserOverrides(window._recruitUserOverridesCache);
            applyRecruitmentPermissionsRuntimeWithOverrides();
        } catch(err) {
            console.error('Recruit override update failed', err);
        }
    };
}

async function deleteUserOverride(key) {
    if (!confirm('Delete this user override?')) return;
    const companyId = await getCurrentCompanyContextForSettings();
    try {
        await firebase.database().ref(`companies/${companyId}/recruitmentSettings/userOverrides/${key}`).remove();
        if (window._recruitUserOverridesCache) {
            delete window._recruitUserOverridesCache[key];
            renderUserOverrides(window._recruitUserOverridesCache);
        }
        showRecruitmentSettingsNotification('Override deleted.', 'success');
        applyRecruitmentPermissionsRuntimeWithOverrides();
    } catch (e) {
        console.error('Failed deleting override', e);
        showRecruitmentSettingsNotification('Failed to delete override.', 'error');
    }
}

// Modified runtime application with override precedence
async function applyRecruitmentPermissionsRuntimeWithOverrides() {
    const companyId = await getCurrentCompanyContextForSettings();
    let settings = {};
    try {
        const snap = await firebase.database().ref(`companies/${companyId}/recruitmentSettings/access`).get();
        if (snap.exists()) settings = snap.val();
        // Migration fallback: if no default but legacy roles exist, derive baseline
        if (!settings.default) {
            const legacyOrder = ['administrator','manager','employee'];
            for (const r of legacyOrder) {
                if (settings[r]) { settings.default = settings[r]; break; }
            }
            // Or merge if multiple present
            if (!settings.default) {
                const merged = {};
                legacyOrder.forEach(r => { if (settings[r]) Object.entries(settings[r]).forEach(([k,v])=> { merged[k] = merged[k] || v; }); });
                if (Object.keys(merged).length) settings.default = merged; 
            }
        }
        let overrides = window._recruitUserOverridesCache;
        if (!overrides) {
            const oSnap = await firebase.database().ref(`companies/${companyId}/recruitmentSettings/userOverrides`).get();
            overrides = oSnap.exists()? oSnap.val(): {};
            window._recruitUserOverridesCache = overrides;
        }
        const currentEmail = (typeof getCurrentUserEmail === 'function') ? getCurrentUserEmail() : (localStorage.getItem('userEmail') || '').toLowerCase();
        const overrideKey = currentEmail.replace(/[^a-z0-9]/gi,'_');
        let perms = settings.default || {};
        if (overrides && overrides[overrideKey] && overrides[overrideKey].perms) {
            perms = overrides[overrideKey].perms; // override precedence
        }
        window._recruitEffectivePerms = perms; // cache effective
        applyRecruitmentPermissionsRuntime({ default: perms });
    } catch (e) {
        console.warn('Override precedence application failed', e);
    }
}

function showRecruitmentSettingsNotification(message, type='info') {
    let box = document.getElementById('recruitAccessNotif');
    if (!box) {
        box = document.createElement('div');
        box.id = 'recruitAccessNotif';
        box.style.position='fixed';
        box.style.bottom='20px';
        box.style.right='20px';
        box.style.padding='10px 14px';
        box.style.borderRadius='8px';
        box.style.fontSize='.7rem';
        box.style.boxShadow='0 4px 12px rgba(0,0,0,.15)';
        box.style.zIndex='3000';
        document.body.appendChild(box);
    }
    const colors = { success: ['#10b981','#ecfdf5'], error:['#ef4444','#fef2f2'], info:['#3b82f6','#eff6ff'] };
    const [fg,bg] = colors[type] || colors.info;
    box.style.background=bg; box.style.color=fg; box.textContent=message;
    box.style.opacity='1';
    setTimeout(()=>{ box.style.transition='opacity .4s'; box.style.opacity='0'; }, 2800);
}

// Apply runtime permission effects: hide/disable actions if current role lacks perms
async function applyRecruitmentPermissionsRuntime(settings) {
    try {
        const perms = settings.default; // single default baseline
        if (!perms) return;
        // Cache effective permissions for downstream gating (e.g., details modal buttons)
        window._recruitEffectivePerms = perms;
        // Create button restrictions
        if (!perms.create) {
            const addBtn = document.querySelector('.btn-add-new');
            if (addBtn) addBtn.style.display='none';
        }
        // Export bulk
        if (!perms.export) {
            document.querySelectorAll('.fa-file-excel').forEach(el=> el.style.pointerEvents='none');
        }
        // Tab button visibility based on permissions
        const tabMap = [
            { key: 'showPending', id: 'pendingTabBtn' },
            { key: 'showPublished', id: 'publishedTabBtn' },
            { key: 'showDeclined', id: 'declinedTabBtn' },
            { key: 'showArchives', id: 'archivesTabBtn' },
            { key: 'showSettings', id: 'settingsTabBtn' }
        ];
        tabMap.forEach(t => {
            const el = document.getElementById(t.id);
            if (!el) return;
            if (t.key in perms && !perms[t.key]) {
                el.style.display = 'none';
            } else {
                el.style.display = '';
            }
        });

        // Approve / decline / fill actions inside rows
        if (!perms.approve || !perms.decline || !perms.fill || !perms.edit || !perms.delete) {
            // After table render, we can conditionally hide / disable
            const adjustRowActions = () => {
                document.querySelectorAll('.action-btn, .btn-icon').forEach(btn => {
                    const title = (btn.getAttribute('title')||'').toLowerCase();
                    if (title.includes('approve') && !perms.approve) btn.style.display='none';
                    if (title.includes('decline') && !perms.decline) btn.style.display='none';
                    if (title.includes('fill') && !perms.fill) btn.style.display='none';
                    if (title.includes('edit') && !perms.edit) btn.style.display='none';
                    if (title.includes('delete') && !perms.delete) btn.style.display='none';
                });
            };
            // Run immediately and after potential re-renders
            adjustRowActions();
            window.addEventListener('recruitmentTableUpdated', adjustRowActions);
        }
    } catch (e) {
        console.warn('Permission runtime application skipped', e); 
    }
}

async function resolveCurrentUserRoleForRecruitment() {
    // Role concept deprecated; now using single default baseline
    return 'default';
}

// Initial runtime application after data loads (optional retry)
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(async () => {
        if (window._recruitAccessLoaded) {
            const companyId = await getCurrentCompanyContextForSettings();
            const snap = await firebase.database().ref(`companies/${companyId}/recruitmentSettings/access`).get();
            if (snap.exists()) {
                const data = snap.val();
                if (data.default) {
                    applyRecruitmentPermissionsRuntime({ default: data.default });
                } else {
                    // Legacy migration attempt on initial load
                    const legacyOrder = ['administrator','manager','employee'];
                    let baseline = {};
                    legacyOrder.forEach(r => { if (data[r]) Object.entries(data[r]).forEach(([k,v])=> { baseline[k] = baseline[k] || v; }); });
                    if (Object.keys(baseline).length) applyRecruitmentPermissionsRuntime({ default: baseline });
                }
            }
        }
    }, 2000);
});
</script>
<style>
/* Scoped Fleet-style modal for user override */
#userOverrideModal.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    z-index: 2500; display: none; align-items: center; justify-content: center;
    opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; padding: 20px;
}
#userOverrideModal.modal.show { display: flex; opacity: 1; visibility: visible; }
#userOverrideModal .modal-content {
    background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
    border-radius: 16px; width: 95%; max-width: 640px; max-height: 90vh; overflow: hidden; position: relative;
    transform: scale(0.95); opacity: 0; transition: all 0.3s ease-in-out;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.05);
}
#userOverrideModal.modal.show .modal-content { transform: scale(1); opacity: 1; }
#userOverrideModal .modal-header {
    padding: 1.5rem 2rem; border-bottom: 1px solid rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.95); position: sticky; top: 0; z-index: 2; box-shadow: 0 2px 15px rgba(0,0,0,0.03);
}
#userOverrideModal .modal-header h5 {
    font-size: 1.1rem; font-weight: 600; color: #1a1a1a; margin: 0; position: relative; display: flex; align-items: center; gap: 10px;
}
#userOverrideModal .modal-header h5::after { content: ''; position: absolute; bottom: -8px; left: 0; width: 40px; height: 3px; background: #3b82f6; border-radius: 2px; }
#userOverrideModal .modal-body {
    padding: 1.25rem 1.5rem; overflow-y: auto; max-height: calc(90vh - 200px); scrollbar-width: thin; scrollbar-color: #ddd transparent; position: relative;
}
#userOverrideModal .modal-body::-webkit-scrollbar { width: 6px; }
#userOverrideModal .modal-body::-webkit-scrollbar-track { background: transparent; }
#userOverrideModal .modal-body::-webkit-scrollbar-thumb { background-color: #ddd; border-radius: 3px; }
#userOverrideModal .modal-body::-webkit-scrollbar-thumb:hover { background-color: #bbb; }
#userOverrideModal .modal-footer {
    padding: 1rem 1.5rem; border-top: 1px solid rgba(0,0,0,0.08); display: flex; gap: .85rem; align-items: center; flex-wrap: wrap; justify-content: flex-end;
    background: rgba(255,255,255,0.95); position: sticky; bottom: 0; z-index: 2; box-shadow: 0 -2px 15px rgba(0,0,0,0.03);
}
#userOverrideModal .form-row { display: flex; gap: 1rem; align-items: flex-start; }
#userOverrideModal .form-row .form-group { flex: 1; margin-bottom: 0.9rem; }
</style>
<style>
/* Collapsible default permissions card (wrap/unwrap) */
#settingsTabContent .collapsible-card .collapsible-body { display: block; }
#settingsTabContent .collapsible-card .collapsible-summary { display: none; }
#settingsTabContent .collapsible-card.collapsed .collapsible-body { display: none !important; }
#settingsTabContent .collapsible-card.collapsed .collapsible-summary { display: block !important; }
#settingsTabContent .collapsible-card .collapsible-header .fa-chevron-up,
#settingsTabContent .collapsible-card.collapsed .collapsible-header .fa-chevron-down { transition: transform .2s ease; }
</style>
<style>
/* Approver selection modal (reuse fleet style) */
#approvalApproverModal.modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    z-index: 2500; display: none; align-items: center; justify-content: center;
    opacity: 0; visibility: hidden; transition: all 0.3s ease-in-out; padding: 20px;
}
#approvalApproverModal.modal.show { display: flex; opacity: 1; visibility: visible; }
#approvalApproverModal .modal-content {
    background: linear-gradient(to bottom right, #ffffff, #f8f9fa);
    border-radius: 16px; width: 95%; max-width: 560px; max-height: 90vh; overflow: hidden; position: relative;
    transform: scale(0.95); opacity: 0; transition: all 0.3s ease-in-out;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
    border: 1px solid rgba(0,0,0,0.05);
}
#approvalApproverModal.modal.show .modal-content { transform: scale(1); opacity: 1; }
#approvalApproverModal .modal-header {
    padding: 1.2rem 1.6rem; border-bottom: 1px solid rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.95); position: sticky; top: 0; z-index: 2; box-shadow: 0 2px 15px rgba(0,0,0,0.03);
}
#approvalApproverModal .modal-header h5 { font-size: .95rem; font-weight: 600; color: #1a1a1a; margin: 0; }
#approvalApproverModal .modal-body { padding: 1rem 1.25rem; overflow-y: auto; max-height: calc(90vh - 180px); }
#approvalApproverModal .modal-footer { padding: .9rem 1.25rem; border-top: 1px solid rgba(0,0,0,0.08); display: flex; gap: .75rem; justify-content: flex-end; }
</style>
<!-- User Override Modal -->
<div id="userOverrideModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 style="font-size:.95rem;display:flex;align-items:center;gap:.5rem;"><i class="fas fa-user-shield"></i> Access control</h5>
            <button type="button" onclick="closeUserOverrideModal()" style="background:none;border:none;font-size:1rem;cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body" style="display:flex;flex-direction:column;gap:1rem;">
            <form id="userOverrideForm" onsubmit="event.preventDefault(); saveUserOverride();" style="display:flex;flex-direction:column;gap:1rem;">
                <div style="display:flex;flex-direction:column;gap:.35rem;">
                    <label style="font-size:.65rem;font-weight:600;">User</label>
                    <div style="display:flex;gap:.5rem;align-items:stretch;">
                        <input id="recruitAcUserSearch" type="text" placeholder="Search by name or job title" style="flex:0 0 40%;min-width:160px;padding:.4rem .55rem;border:1px solid #ced4da;border-radius:6px;font-size:.7rem;"/>
                        <select id="overrideUserSelect" required style="flex:1 1 auto;min-width:220px;padding:.45rem .6rem;border:1px solid #ced4da;border-radius:6px;font-size:.7rem;">
                            <option value="">-- Select a user --</option>
                        </select>
                    </div>
                    <small style="font-size:.55rem;color:#64748b;">Type to filter. Only users not already added will appear.</small>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.6rem;">
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="view" checked> View Board</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="create"> Create Authority to Recruit</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="approve"> Approve Position</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="decline"> Decline Position</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="fill"> Fill Position</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="edit"> Edit Request</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="delete"> Delete Request</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="export"> Export Data</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="select"> Allow Selection (Tick Boxes)</label>
                </div>
                <div style="margin-top:.25rem; font-size:.65rem; font-weight:600; color:#334155;">Tabs</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.6rem;">
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="showPending" checked> Pending Tab</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="showPublished" checked> Published Tab</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="showDeclined" checked> Declined Tab</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="showArchives" checked> Archives Tab</label>
                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-user-perm="showSettings" checked> Settings Tab</label>
                </div>
                <div class="modal-footer" style="padding:0;">
                    <button type="button" class="btn btn-secondary" style="font-size:.65rem;" onclick="closeUserOverrideModal()">Cancel</button>
                    <button type="submit" class="btn btn-success" style="font-size:.65rem;display:inline-flex;align-items:center;gap:6px;"><i class="fas fa-save"></i> Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Approval Approver Modal -->
<div id="approvalApproverModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h5 style="font-size:.95rem;display:flex;align-items:center;gap:.5rem;"><i class="fas fa-user-plus"></i> Configure Approvers</h5>
            <button type="button" onclick="closeApprovalApproverModal()" style="background:none;border:none;font-size:1rem;cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body">
            <form id="approvalApproverForm" onsubmit="event.preventDefault(); saveApprovalApprover();" style="display:flex;flex-direction:column;gap:1rem;">
                <div style="display:flex;flex-direction:column;gap:.35rem;">
                    <label style="font-size:.65rem;font-weight:600;">Select user</label>
                    <div style="display:flex;gap:.5rem;align-items:stretch;">
                        <input id="approvalApproverSearch" type="text" placeholder="Search by name or job title" style="flex:0 0 40%;min-width:160px;padding:.4rem .55rem;border:1px solid #ced4da;border-radius:6px;font-size:.7rem;"/>
                        <select id="approvalApproverSelect" required style="flex:1 1 auto;min-width:220px;padding:.45rem .6rem;border:1px solid #ced4da;border-radius:6px;font-size:.7rem;">
                            <option value="">-- Select a user --</option>
                        </select>
                    </div>
                    <small class="text-muted" style="font-size:.65rem;">Only selected users will see Approve/Decline in position details (unless list is empty).</small>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeApprovalApproverModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveApprovalApprover()"><i class="fas fa-save"></i> Save</button>
        </div>
    </div>
    
</div>
</body>
</html>

