<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gate Pass Request - Dreamex Datalab HSE</title>
    <!-- Firebase v8 CDN (match staff.html pattern) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <!-- EmailJS (if needed later) -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Remove external module firebase-config.js -->
    <!-- <script type="module" src="js/firebase-config.js"></script> -->
    <style>
        /* Existing inline component-specific styles remain above */
        /* === BEGIN Inlined Global styles from css/styles.css (partial) === */
:root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#e74c3c; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --purple:#9b59b6; --orange:#e67e22; --red:#e74c3c; --accent-color:var(--blue); --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:0.9rem; --font-scale:1; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333333; --text-secondary:#666666; --border-color:#e0e0e0; }
[data-theme="dark"] { --bg-primary:#1a1a1a; --bg-secondary:#2d2d2d; --text-primary:#ffffff; --text-secondary:#cccccc; --border-color:#404040; }
[data-contrast="high"] { --text-primary:#000000; --text-secondary:#000000; --bg-primary:#ffffff; --bg-secondary:#ffffff; --border-color:#000000; }
[data-theme="dark"][data-contrast="high"] { --text-primary:#ffffff; --text-secondary:#ffffff; --bg-primary:#000000; --bg-secondary:#000000; --border-color:#ffffff; }
[data-density="comfortable"] { --spacing-unit:1rem; --padding-sm:0.5rem; --padding-md:1rem; --padding-lg:1.5rem; }
[data-density="compact"] { --spacing-unit:0.75rem; --padding-sm:0.25rem; --padding-md:0.75rem; --padding-lg:1rem; }
[data-density="spacious"] { --spacing-unit:1.5rem; --padding-sm:0.75rem; --padding-md:1.5rem; --padding-lg:2rem; }
[data-reduced-motion="none"] { --transition-speed:0.2s; }
[data-reduced-motion="reduced"] { --transition-speed:0.4s; }
[data-reduced-motion="minimal"] { --transition-speed:0s; }
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:var(--font-family); font-size:var(--base-font-size); line-height:calc(1.5 * var(--font-scale)); color:var(--text-primary); background-color:var(--bg-primary); transition:background-color var(--transition-speed), color var(--transition-speed); }
.app-container { display:flex; min-height:100vh; }
.sidebar { width:var(--sidebar-width); background-color:var(--primary-color); color:#fff; padding:1rem; position:fixed; height:100vh; overflow-y:auto; }
.logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); }
.menu { list-style:none; margin-top:2rem; }
.menu li { margin-bottom:0.5rem; }
.menu a { color:#fff; text-decoration:none; display:flex; align-items:center; padding:0.75rem 1rem; border-radius:5px; transition:background-color 0.3s; }
.menu a i { margin-right:10px; }
.menu a:hover,.menu a.active { background-color:var(--secondary-color); }
.menu-dropdown .submenu { display:none; list-style:none; margin-left:2rem; margin-top:0.5rem; }
.menu-dropdown:hover .submenu { display:block; }
/* Menu Visibility Styles - Feature/Role Based Permissions */
/* Hide everything by default, only show when .menu-visible is applied */
[data-feature]:not(.menu-visible) {
  display: none !important;
}

.menu-dropdown:not(.menu-visible) {
  display: none !important;
}

/* During loading, keep everything hidden to avoid flicker */
.menu-loading [data-feature] {
  display: none !important;
}

.menu-loading .menu-dropdown {
  display: none !important;
}
.main-content { flex:1; margin-left:var(--sidebar-width); padding:0.5rem; width:calc(100% - var(--sidebar-width)); box-sizing:border-box; }
.form-container { width:100%; max-width:none; padding:1rem; margin:0; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.content { width:100%; margin:0; padding:1rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.top-nav { display:flex; justify-content:flex-end; align-items:center; padding:1rem; background:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:1rem; position:relative; }
.top-nav-right { display:flex; align-items:center; gap:1.5rem; margin-left:auto; }
.notifications { position:relative; display:flex; align-items:center; }
.notification-btn { background:none; border:none; cursor:pointer; position:relative; font-size:1.2rem; padding:0.5rem; display:flex; align-items:center; justify-content:center; }
.notification-badge { position:absolute; top:-5px; right:-5px; background:var(--accent-color); color:#fff; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.7rem; }
/* === END Inlined Global styles (partial) === */
        
        .supporting-documents-section {
            margin: 20px 0;
        }

        .supporting-documents-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .attachments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .attachment-item {
            display: flex;
            align-items: start;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
        }

        .attachment-item:hover {
            border-color: #3b82f6;
            background: #f0f7ff;
        }

        .attachment-icon {
            font-size: 1.2rem;
            color: #3b82f6;
            margin-right: 12px;
        }

        .attachment-details {
            flex: 1;
            overflow: hidden;
        }

        .attachment-name {
            display: block;
            color: #0066cc;
            text-decoration: none;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .attachment-name:hover {
            color: #3b82f6;
            text-decoration: underline;
        }

        .attachment-meta {
            display: flex;
            gap: 10px;
            font-size: 0.8em;
            color: #6c757d;
        }

        .attachment-size, .attachment-date {
            white-space: nowrap;
        }

        .existing-attachments {
            margin-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 20px;
        }

        .notification-dropdown{display:none;position:absolute;right:0;top:100%;width:320px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:1000;border:1px solid #e9ecef;max-height:400px;overflow:hidden}
        .notification-dropdown.show{display:block;animation:slideDown 0.2s ease-out}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .notification-header{padding:12px 16px;border-bottom:1px solid #e9ecef;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);display:flex;justify-content:space-between;align-items:center}
        .notification-header h3{margin:0;color:#333;font-size:14px;font-weight:600}
        .mark-all-read{background:none;border:none;color:#3498db;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px;transition:all 0.2s ease}
        .mark-all-read:hover{background:#e3f2fd;color:#1976d2}
        .clear-all-notifications{background:none;border:none;color:#e74c3c;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px;transition:all 0.2s ease;margin-left:8px}
        .clear-all-notifications:hover{background:#fdf2f2;color:#c0392b}
        .notification-actions{position:absolute;top:8px;right:8px;display:none;gap:4px}
        .notification-item:hover .notification-actions{display:flex}
        .mark-read-btn,.delete-notification-btn{background:none;border:none;cursor:pointer;padding:4px;border-radius:3px;transition:all 0.2s ease;font-size:12px}
        .mark-read-btn{color:#3498db}
        .mark-read-btn:hover{background:#e3f2fd;color:#1976d2}
        .delete-notification-btn{color:#e74c3c}
        .delete-notification-btn:hover{background:#fdf2f2;color:#c0392b}
        .notification-item.read .mark-read-btn{color:#95a5a6;cursor:default}
        .notification-item.read .mark-read-btn:hover{background:none;color:#95a5a6}
        .notification-list{max-height:320px;overflow-y:auto;padding:0}
        .notification-list::-webkit-scrollbar{width:4px}
        .notification-list::-webkit-scrollbar-track{background:#f1f1f1}
        .notification-list::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:2px}
        .notification-item{padding:12px 16px;border-bottom:1px solid #f1f1f1;cursor:pointer;transition:background-color 0.2s ease;position:relative}
        .notification-item:hover{background:#f8f9fa}
        .notification-item.unread{background:#e8f4fd;border-left:3px solid #3498db}
        .notification-item.unread::before{content:'';position:absolute;top:16px;right:16px;width:8px;height:8px;background:#3498db;border-radius:50%}
        .notification-dot{position:absolute;top:16px;right:16px;width:8px;height:8px;background:#3498db;border-radius:50%}
        .notification-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;margin-right:12px;flex-shrink:0}
        .notification-icon.info{background:#e3f2fd;color:#1976d2}
        .notification-icon.success{background:#e8f5e8;color:#2e7d2e}
        .notification-icon.warning{background:#fff3e0;color:#f57c00}
        .notification-icon.error{background:#ffebee;color:#d32f2f}
        .notification-content{flex:1;min-width:0}
        .notification-title{font-weight:600;font-size:13px;color:#333;margin-bottom:2px;line-height:1.3}
        .notification-message{font-size:12px;color:#666;line-height:1.4;word-wrap:break-word}
        .notification-time{font-size:11px;color:#999;margin-top:4px}
        .notification-empty{padding:40px 20px;text-align:center;color:#999}
        .notification-empty i{font-size:32px;margin-bottom:12px;color:#ddd}
        .notification-empty-title{font-size:14px;font-weight:500;margin-bottom:4px;color:#666}
        .notification-empty-message{font-size:12px;color:#999}
        .profile-btn{background:none;border:none;cursor:pointer;padding:.25rem;display:flex;align-items:center}
        .profile-btn img{width:40px;height:40px;border-radius:50%;object-fit:cover}
        .profile-dropdown{display:none;position:absolute;top:100%;right:0;background:#fff;border-radius:4px;box-shadow:0 2px 10px rgba(0,0,0,.1);min-width:200px;z-index:1000}
        .profile-dropdown.show{display:block}
        .profile-dropdown ul{list-style:none;margin:0;padding:0}
        .profile-dropdown ul li a{display:flex;align-items:center;padding:12px 16px;color:#333;text-decoration:none;transition:background .2s}
        .profile-dropdown ul li a:hover{background:#f8f9fa}
        /* Form specifics already present; ensure modal/button utility */
        .btn{padding:.5rem .85rem;border:none;border-radius:6px;font-size:.8rem;font-weight:500;display:inline-flex;align-items:center;gap:.375rem;cursor:pointer;transition:all .2s ease}
        .btn-approve{background:#27ae60;color:#fff}
        .btn-approve:hover{filter:brightness(1.1)}
        .btn-remove{background:#ef4444;color:#fff}
        .btn-remove:hover{background:#dc2626}
        .form-section{border:1px solid #e0e0e0;border-radius:8px;padding:1rem;margin-bottom:1.5rem;background:#fafbfc}
        .form-section legend{font-weight:600;font-size:.95rem;color:var(--primary-color);padding:0 .5rem;margin-bottom:.5rem}
        .form-row{display:grid;gap:.5rem;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));align-items:start;margin-bottom:.5rem}
        .visitor-row .form-row,.equipment-row .form-row{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
        /* Specific layout for reference number row */
        .form-row.basic-info-row{grid-template-columns:1fr}
        /* Specific layout for personnel information row */
        .form-row.personnel-info-row{grid-template-columns:150px 160px 180px 140px 160px}
        .form-group{display:flex;flex-direction:column;min-width:0;margin-bottom:.5rem}
        .form-group label{font-weight:600;margin-bottom:3px;font-size:.75rem}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:.5rem .65rem;border:1px solid #d0d7de;border-radius:6px;font-size:.75rem;background:#fff}
        /* Ensure file inputs have same height as other form controls */
        .form-group input[type="file"]{padding:.5rem .65rem;height:auto;line-height:1.2}
        .form-group textarea{resize:vertical}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:2px solid var(--secondary-color);outline-offset:0;border-color:var(--secondary-color);box-shadow:0 0 0 2px rgba(52,152,219,.15)}
        fieldset.form-section{padding:1rem}
        .help-text{font-size:.6rem;color:#666;margin-top:3px}
        .checkbox-group .checkbox-label{display:flex;align-items:flex-start;gap:.5rem;font-size:.75rem;line-height:1.3;text-align:left}
        .checkbox-group input[type=checkbox]{margin-top:.2rem}
        @media (max-width:600px){.form-row{grid-template-columns:1fr}}
        /* === END supplemental inline styles === */
        /* Ensure layout parity with staff.html (fixed top-nav, collapsible sidebar) */
    .top-nav{position:fixed;top:0.25rem;right:0.5rem;left:calc(var(--sidebar-width) + 0.5rem);height:50px;min-height:50px;display:flex;align-items:center;justify-content:space-between;padding:0.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);z-index:100;transition:left .3s ease;margin-bottom:0}
    .top-nav-left{display:flex;align-items:center;gap:1rem;font-size:.8rem;font-weight:600;color:var(--text-secondary)}
  #headerCompanyLogo{width:44px;height:44px;border-radius:6px;object-fit:cover;display:none;background:transparent;border:none;box-shadow:none;transition:background .2s,border-color .2s}
    #headerCompanyLogo.placeholder{display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:600;color:#555;object-fit:cover;background:linear-gradient(135deg,#f0f2f5,#e4e8ec);border:1px dashed #c5ccd3}
    #headerCompanyLogo.visible{display:block}
    #headerCompanyName{font-size:.8rem;font-weight:600;letter-spacing:.5px;color:var(--primary-color);max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .avatar-initials{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1rem}
    .main-content{padding-top:3rem;transition:margin-left .3s ease,width .3s ease}
    .main-content.sidebar-collapsed{margin-left:0;width:100%}
    .main-content.sidebar-collapsed .top-nav{left:0.5rem;right:0.5rem;width:auto}
        .sidebar.collapsed{transform:translateX(-100%)}
        .sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.1rem;padding:.5rem;color:#666}
        .sidebar-toggle-btn:hover{background:rgba(0,0,0,.05)}
        .notification-item.read{opacity:.6}
        .notification-header{display:flex;justify-content:space-between;font-size:.65rem;margin-bottom:.25rem;font-weight:600}
        .notification-type{color:var(--secondary-color)}
        .notification-content{font-size:.75rem;line-height:1.2}
    .declaration-text{font-size:.75rem;line-height:1.3;display:block;text-align:left;margin:0}
    /* Ensure declaration checkbox text is truly left-aligned and not centered by parent flex rules */
    .checkbox-group,.checkbox-label{text-align:left !important}
    .checkbox-label{display:flex;align-items:flex-start;gap:.5rem;}
    .checkbox-label input[type=checkbox]{margin-top:2px}
    /* New declaration container layout - text on left, checkbox on right */
    .declaration-container{display:flex;align-items:flex-start;gap:1rem;width:100%}
    .declaration-container .declaration-text{flex:1;text-align:left}
    .checkbox-label-right{display:flex;align-items:center;justify-content:center;min-width:24px}
    .checkbox-label-right input[type=checkbox]{margin:0}
        .form-actions{display:flex;gap:.75rem;justify-content:flex-end;margin-top:1rem}
        .equipment-remove-container,.visitor-controls,.equipment-controls{margin-top:.375rem}
        .btn.btn-add-visitor,.btn.btn-add-equipment{background:var(--secondary-color);color:#fff}
        .btn.btn-add-visitor:hover,.btn.btn-add-equipment:hover{filter:brightness(1.1)}
        .btn-remove i{pointer-events:none}
        /* Responsive */
        @media (max-width:768px){.top-nav{position:relative;left:0;right:0}.main-content{margin-left:0;padding-top:1rem}.sidebar{position:relative;transform:none;width:100%;height:auto}.sidebar.collapsed{display:none}}
        
        /* Page Header Styles (matching accessboard.html) */
    .page-header{
      background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      color:#fff;
      padding:.55rem .75rem;
      border-radius:0; /* removed rounded border per request */
      margin:.35rem 0 .5rem 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 10px 28px rgba(0,0,0,.18),0 6px 16px rgba(0,0,0,.14);
      font-size:.9rem;
    }
        .page-header i{font-size:1rem;}

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        /* Header action button styles */
        .header-right {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
    <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
            <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
            <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="access.html" class="active">Gate Pass</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Gate Pass Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
            <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
            <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
                    </ul>
                </li>
        <li class="menu-dropdown" data-feature="project_management_section">
          <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
          <ul class="submenu">
            <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
            <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
            <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
            <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
          </ul>
        </li>
                <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <img id="headerCompanyLogo" alt="Company Logo">
                    <span id="headerCompanyName"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3><i class="fas fa-bell" style="margin-right: 6px; color: #3498db;"></i>Notifications</h3>
                                <div>
                                    <button class="mark-all-read">Mark all as read</button>
                                    <button class="clear-all-notifications">Clear all</button>
                                </div>
                            </div>
                            <div class="notification-list" id="notificationList">
                                <!-- Empty state -->
                                <div class="notification-empty" id="notificationEmpty">
                                    <i class="fas fa-bell-slash"></i>
                                    <div class="notification-empty-title">No notifications</div>
                                    <div class="notification-empty-message">You're all caught up!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="assets/default-avatar.png" alt="User Avatar">
                        </button>
                        <div class="profile-dropdown">
                            <ul>
                <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                                <li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <!-- Page Header -->
                <div class="page-header">
                    <div style="display: flex; align-items: center; gap: 0.6rem;">
                        <i class="fas fa-key"></i>
                        <span>New Gate Pass</span>
                    </div>
                    <div class="header-right">
                        <!-- Optional action buttons can go here -->
                    </div>
                </div>
                
                <div class="form-container">
                    <form id="accessRequestForm">
            <!-- Basic Information Section -->
                        <fieldset class="form-section">
                            <legend>Basic Information</legend>
                            
                            <div class="form-row basic-info-row">
                                <div class="form-group">
                                    <label for="referenceNumber">Reference Number</label>
                                    <input type="text" id="referenceNumber" name="referenceNumber" readonly>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="purpose">Purpose/Business Justification*</label>
                                <textarea id="purpose" name="purpose" rows="3" required placeholder="Detailed description of work to be performed or reason for gate pass"></textarea>
                            </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="propertyRemoval">Property Removal</label>
                  <input type="text" id="propertyRemoval" name="propertyRemoval" placeholder="Describe any property being removed (if applicable)">
                </div>
                <div class="form-group">
                  <label for="toBeReturned">To be Returned</label>
                  <select id="toBeReturned" name="toBeReturned">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </div>
              </div>
                        </fieldset>

                        <!-- Personnel Information Section -->
                        <fieldset class="form-section">
                            <legend>Personnel Information</legend>
                            <div class="form-row personnel-info-row">
                                <div class="form-group">
                                    <label for="department">Department*</label>
                                    <input type="text" id="department" name="department" readonly required>
                                    <input type="hidden" id="departmentId" name="departmentId">
                                </div>
                                <div class="form-group">
                                    <label for="employeeId">Requester</label>
                                    <input type="text" id="employeeId" name="employeeId" readonly>
                                    <input type="hidden" id="employeeUserId" name="employeeUserId">
                                </div>
                                <div class="form-group">
                                    <label for="companyName">Company/Organization</label>
                                    <input type="text" id="companyName" name="companyName" readonly>
                                    <input type="hidden" id="companyId" name="companyId">
                                </div>
                                <div class="form-group">
                                    <label for="contactPhone">Contact Phone*</label>
                                    <input type="tel" id="contactPhone" name="contactPhone" readonly required>
                                </div>
                                <div class="form-group">
                                    <label for="lineManager">Line Manager</label>
                                    <input type="text" id="lineManager" name="lineManager" readonly>
                                </div>
                            </div>
                        </fieldset>

            <!-- People Section -->
                        <fieldset class="form-section">
              <legend>People</legend>                            <div id="visitors-container">                                <div class="visitor-row">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="visitor-0">Visitor</label>
                                            <input type="text" id="visitor-0" name="visitors[]" class="visitor-select" placeholder="Enter visitor name">
                                        </div>
                                        <div class="form-group">
                                            <label for="visitor-job-0">Job Title</label>
                                            <input type="text" id="visitor-job-0" name="visitor-jobs[]" class="visitor-job" placeholder="Enter job title">
                                        </div>
                                        <div class="form-group">
                                            <label for="visitor-id-0">ID/Passport Number</label>
                                            <input type="text" id="visitor-id-0" name="visitor-ids[]" class="visitor-id" placeholder="Enter ID or passport number">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="visitor-company-0">Company</label>
                                            <input type="text" id="visitor-company-0" name="visitor-companies[]" class="visitor-company" placeholder="Enter company name">
                                        </div>
                                        <div class="form-group">
                                            <label for="visitor-area-0">Area/Location*</label>
                                            <select id="visitor-area-0" name="visitor-areas[]" class="visitor-area" required>
                                                <option value="">Select Area/Location</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="visitor-start-0">Start Date & Time*</label>
                                            <input type="datetime-local" id="visitor-start-0" name="visitor-starts[]" class="visitor-start" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="visitor-end-0">End Date & Time*</label>
                                            <input type="datetime-local" id="visitor-end-0" name="visitor-ends[]" class="visitor-end" required>
                                        </div>
                    <div class="form-group">
                      <label for="visitor-attachment-0">Attachments</label>
                      <input type="file" id="visitor-attachment-0" name="visitor-attachments[]" class="visitor-attachment" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                      <small class="help-text">Upload one or more documents for this visitor</small>
                    </div>
                                    </div>
                                </div>
                <div class="visitor-controls">
                  <button type="button" class="btn btn-add-visitor">
                    <i class="fas fa-plus"></i> Add Person
                  </button>
                </div>
                            </div>
                        </fieldset>

                        <!-- Equipment & Tools Section -->
                        <fieldset class="form-section">
                            <legend>Equipment & Tools</legend>
                              <div id="equipment-container">
                                <div class="equipment-row">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="equipment-name-0">Equipment/Tool Name*</label>
                                            <input type="text" id="equipment-name-0" name="equipment-names[]" class="equipment-name" required placeholder="Enter equipment or tool name">
                                        </div>
                                        <!-- Description field removed per request -->
                                        <div class="form-group" style="align-self:end;display:flex;flex-direction:column;gap:.5rem;">
                                            <label style="visibility:hidden">Remove</label>
                                            <button type="button" class="btn btn-remove remove-equipment" style="display:none;" data-remove-equipment><i class="fas fa-minus"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="equipment-controls">
                                    <button type="button" class="btn btn-add-equipment"><i class="fas fa-plus"></i> Add Equipment</button>
                                </div>
                            </div>
                        </fieldset>

                        <!-- Declaration Section -->
                        <fieldset class="form-section">
                            <legend>Declaration & Acknowledgment</legend>
                            
                            <div class="form-group">
                                <div class="checkbox-group declaration-container">
                                    <span class="declaration-text">
                                        By checking this box, I declare that: I have read and understand all applicable safety rules and procedures; my safety training and certifications are current and valid; I will comply with all security protocols and access restrictions; I will report any safety incidents or security breaches; and all information provided in this request is accurate and complete.*
                                    </span>
                                    <label class="checkbox-label-right">
                                        <input type="checkbox" name="declarations" value="all_declarations" required>
                                    </label>
                                </div>
                            </div>
                        </fieldset>

                        <div class="form-actions">
                            <button type="button" class="btn" onclick="window.location.href='accessboard.html'">Cancel</button>
                            <button type="submit" class="btn btn-approve">Submit Request</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>    <!-- Insert sidebar toggle button inside top-nav (non-destructive) -->
    <script>
        // Sidebar toggle & persistence utilities
          function toggleSidebar(){
                const sb=document.querySelector('.sidebar');
                const mc=document.querySelector('.main-content');
                const top=document.querySelector('.top-nav');
                if(!sb||!mc) return;
                const collapsed=sb.classList.toggle('collapsed');
                mc.classList.toggle('sidebar-collapsed',collapsed);
                if(top){
                  if(collapsed){
                      top.style.left='0.5rem';
                      top.style.right='0.5rem';
                      top.style.width='auto';
                  } else {
                      top.style.left='calc(var(--sidebar-width) + 0.5rem)';
                      top.style.right='0.5rem';
                      top.style.width='auto';
                  }
                }
                localStorage.setItem('sidebarCollapsed', collapsed);
          }
        function restoreSidebarState(){
            const collapsed=localStorage.getItem('sidebarCollapsed')==='true';
            const sb=document.querySelector('.sidebar');
            const mc=document.querySelector('.main-content');
            const top=document.querySelector('.top-nav');
            if(collapsed && sb && mc){
               sb.classList.add('collapsed');
               mc.classList.add('sidebar-collapsed');
               if(top){ top.style.left='0.5rem'; top.style.right='0.5rem'; }
            }
        }
        document.addEventListener('DOMContentLoaded',()=>{
            restoreSidebarState();
            const topNav=document.querySelector('.top-nav');
            if(topNav && !topNav.querySelector('#sidebarToggle')){
                const btn=document.createElement('button');
                btn.id='sidebarToggle';
                btn.className='sidebar-toggle-btn';
                btn.innerHTML='<i class="fas fa-bars"></i>';
                topNav.prepend(btn);
                btn.addEventListener('click',toggleSidebar);
            }
        });
    </script>
    <!-- Full Inline Application Script (Firebase v8 + Managers) -->
    <script>
    /******************** Firebase Initialization (v8) ********************/ 
    (function(){
        const firebaseConfig = { apiKey:"AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc", authDomain:"users-8be65.firebaseapp.com", databaseURL:"https://users-8be65-default-rtdb.firebaseio.com", projectId:"users-8be65", storageBucket:"users-8be65.firebasestorage.app", messagingSenderId:"829083030831", appId:"1:829083030831:web:36a370e62691e560bc3dda" };
        if(!window.firebase?.apps?.length){ firebase.initializeApp(firebaseConfig); console.log('âœ… Firebase v8 initialized'); }
        window.db = firebase.database();
        window.auth = firebase.auth();
        window.storage = firebase.storage();
    })();

    /******************** RoleManager (Stub for missing roles.js) ********************/
    class RoleManager { hasPermission(feature, action='view'){ return true; } }
    window.roleManager = new RoleManager();

    /******************** NotificationManager (Firebase-backed) ********************/
    class NotificationManager{
      constructor(){
        this.db = firebase.database();
        this.notifications = [];
        this.settings = this.loadSettings();
        this.userId = null;
        this.fbRef = null;
        this.initialize();
      }
      initialize(){
        if(document.readyState==='loading'){
          document.addEventListener('DOMContentLoaded',()=>this.setup());
        } else { this.setup(); }
      }
      setup(){
        this.bindUI();
        this.tryAttachFirebase();
        this.startBadgeTimer();
        document.addEventListener('storage',e=>{ if(e.key==='currentUser'){ this.tryAttachFirebase(true); }});
      }
      bindUI(){
        const btn=$('#notificationBtn'); if(btn){btn.onclick=()=>{$('.notification-dropdown')?.classList.toggle('show');};}
        const mark=$('.mark-all-read'); if(mark){mark.onclick=()=>this.markAllAsRead();}
        document.addEventListener('click',e=>{ if(!e.target.closest('.notifications')) $('.notification-dropdown')?.classList.remove('show'); });
      }
      loadSettings(){ const d={emailNotifications:true,notifySubmitter:true,notifyApprovers:true,notifyOnComplete:true,systemUpdates:true,securityAlerts:true,notificationDisplay:'30',showReadNotifications:true}; try{return JSON.parse(localStorage.getItem('notificationSettings'))||d;}catch{return d;} }
      tryAttachFirebase(force=false){
        const uid = window.authManager?.currentUser?.uid || firebase.auth().currentUser?.uid;
        if(!uid){ this.renderNotifications(); this.updateNotificationBadge(); return; }
        if(this.userId===uid && !force){ return; }
        this.userId = uid;
        if(this.fbRef){ this.fbRef.off(); }
        this.fbRef = this.db.ref(`notifications/${uid}`);
        this.fbRef.on('value', snap=>{
          const list=[]; if(snap.exists()){
            snap.forEach(cs=>{ const v=cs.val(); if(v){ list.push(v); }});
          }
          // Sort by timestamp desc
          list.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
          this.notifications = list;
          this.renderNotifications();
          this.updateNotificationBadge();
        });
      }
      markAllAsRead(){ if(!this.userId){ return; } const updates={}; this.notifications.forEach(n=>{ if(!n.read){ updates[`notifications/${this.userId}/${n.id}/read`]=true; }}); if(Object.keys(updates).length){ this.db.ref().update(updates).catch(()=>{}); } }
      updateNotificationBadge(){ const badge=$('.notification-badge'); if(!badge) return; const unread=this.notifications.filter(n=>!n.read).length; if(unread<=0){ badge.style.display='none'; badge.textContent=''; } else { badge.style.display='inline-block'; badge.textContent = unread>99? '99+': String(unread); } }
      renderNotifications(){ const list=$('.notification-list'); if(!list) return; list.innerHTML=''; const days=parseInt(this.settings.notificationDisplay); const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-days);
        const filtered=this.notifications.filter(n=>{ const ts=n.timestamp? new Date(n.timestamp): null; const inRange = ts? (ts>cutoff): true; return inRange && (this.settings.showReadNotifications || !n.read); });
        if(filtered.length===0){ list.innerHTML='<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>'; return; }
        filtered.slice(0,50).forEach(n=>{
          const el=document.createElement('div'); el.className='notification-item '+(n.read?'read':'unread'); const date=n.timestamp? new Date(n.timestamp): new Date(); const timeAgo=this.getTimeAgo(date);
          const title = n.title || (n.type || 'Notification');
          el.innerHTML=`
            <div class="notification-icon ${this.getNotificationIconClass(n.type)}">
              <i class="fas ${this.getNotificationIcon(n.type)}"></i>
            </div>
            <div class="notification-content">
              <div class="notification-title">${this.escapeHtml(title)}</div>
              <div class="notification-message">${this.escapeHtml(n.message||'')}</div>
              <div class="notification-time">${timeAgo}</div>
            </div>
            <div class="notification-actions">
              ${!n.read ? '<button class="mark-read-btn" title="Mark as read"><i class="fas fa-check"></i></button>' : ''}
              <button class="delete-notification-btn" title="Delete"><i class="fas fa-trash"></i></button>
            </div>`;
          const markReadBtn = el.querySelector('.mark-read-btn');
          const deleteBtn = el.querySelector('.delete-notification-btn');
          if(markReadBtn){ markReadBtn.onclick=(e)=>{ e.stopPropagation(); this.setRead(n.id,true); }; }
          if(deleteBtn){ deleteBtn.onclick=(e)=>{ e.stopPropagation(); this.deleteNotification(n.id); }; }
          el.onclick=()=>{ if(!n.read){ this.setRead(n.id,true);} if(n.link) location.href=n.link; };
          list.appendChild(el);
        });
      }
      getTimeAgo(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'm ago';
        if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'h ago';
        if (diffInSeconds < 604800) return Math.floor(diffInSeconds / 86400) + 'd ago';
        return date.toLocaleDateString();
      }
      
      getNotificationIconClass(type) {
        switch ((type || '').toLowerCase()) {
            case 'success': return 'success';
            case 'warning': return 'warning';
            case 'error': return 'error';
            case 'info': return 'info';
            default: return 'info';
        }
      }

      getNotificationIcon(type) {
        switch ((type || '').toLowerCase()) {
            case 'success': return 'fa-check-circle';
            case 'warning': return 'fa-exclamation-triangle';
            case 'error': return 'fa-exclamation-circle';
            case 'info': return 'fa-info-circle';
            default: return 'fa-bell';
        }
      }
      escapeHtml(str){ if(str===undefined||str===null) return ''; return String(str).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
      startBadgeTimer(){ setInterval(()=>this.updateNotificationBadge(),30000); }
      setRead(id, val){ if(!this.userId||!id) return; this.db.ref(`notifications/${this.userId}/${id}/read`).set(!!val).catch(()=>{}); }
      deleteNotification(id){ if(!this.userId||!id) return; this.db.ref(`notifications/${this.userId}/${id}`).remove().catch(()=>{}); }
      async createNotification(recipientUserId, data){
        try{
          const id = data?.id || Date.now().toString();
          const payload = {
            id,
            title: data?.title || 'Notification',
            message: data?.message || '',
            type: data?.type || 'info',
            read: false,
            timestamp: Date.now(),
            createdAt: new Date().toISOString(),
            createdBy: window.authManager?.currentUser?.uid || firebase.auth().currentUser?.uid || 'system',
            createdByName: window.authManager?.getUserDisplayName?.() || 'System',
            companyId: window.authManager?.currentUser?.companyId || null,
            relatedData: data?.relatedData || null,
            link: data?.link || ''
          };
          await this.db.ref(`notifications/${recipientUserId}/${id}`).set(payload);
          return true;
        }catch(e){ console.error('createNotification failed', e); return false; }
      }
    }
    function $(sel){return document.querySelector(sel);} 
    window.notificationManager=new NotificationManager();

        /******************** Centralized AuthManager (from staff.html adapted) ********************/
        class AuthManager {
            constructor(){
                console.log('ðŸ” AuthManager(init) access.html');
                this.currentUser=this.getCurrentUser();
                this.db=firebase.database();
                this.currentCompany=null;
                        this.authorizedFeatures=null; // Set of company-authorized feature keys
                this.initializeAuth();
            }
            getCurrentUser(){ try{return JSON.parse(localStorage.getItem('currentUser')||'null');}catch(e){return null;} }
            setCurrentUser(u){ localStorage.setItem('currentUser',JSON.stringify(u)); localStorage.setItem('user',JSON.stringify(u)); this.currentUser=u; }
            async logout(){ try{ await firebase.auth().signOut(); }catch(e){ console.warn('Logout error',e); } ['currentUser','user'].forEach(k=>{localStorage.removeItem(k);sessionStorage.removeItem(k);}); window.location.href='index.html'; }
            initializeAuth(){ 
        if(!this.currentUser){ 
          console.warn('No user found (redirect disabled) â€“ continuing as guest'); 
          this.currentUser={ uid:'guest', email:'guest@example.com'}; 
        } 
        console.log('âœ… User authenticated:', this.currentUser.email);
        console.log('ðŸ”„ Loading user data...');
        this.loadUserRole(this.currentUser); 
        this.loadUserCompany(); 
        this.updateUIForAuthenticatedUser(); 
        
  // Defer menu visibility until company context is loaded to avoid flicker
        
        this.bindProfileDropdown(); 
      }
            bindProfileDropdown(){ const btn=$('#userProfileBtn'); const dropdown=$('.profile-dropdown'); if(btn && dropdown){ btn.addEventListener('click',e=>{e.stopPropagation(); dropdown.classList.toggle('show');}); document.addEventListener('click',e=>{ if(!btn.contains(e.target)) dropdown.classList.remove('show');}); const logoutLink=dropdown.querySelector('a[href="#"]:has(.fa-sign-out-alt)')||dropdown.querySelector('.fa-sign-out-alt')?.closest('a'); if(logoutLink){ logoutLink.addEventListener('click',e=>{e.preventDefault(); this.logout();}); } } }
                        // Removed resetMenuVisibility and dynamic permission logic (static menu)
            resetMenuVisibility() {
                console.log('ðŸ”§ Resetting menu visibility...');
                const allItems = document.querySelectorAll('[data-feature]');
                const allDropdowns = document.querySelectorAll('.menu-dropdown');
                
                console.log(`Found ${allItems.length} menu items and ${allDropdowns.length} dropdowns`);
                
                allItems.forEach(item => {
                    item.classList.remove('menu-visible');
                });
                allDropdowns.forEach(dropdown => {
                    dropdown.classList.remove('menu-visible');
                });
                
                console.log('âœ… Menu visibility reset complete');
            }

            async updateMenuVisibility() {
                console.log('ðŸŽ¯ Starting feature-based menu authorization for access.html...');
                const sidebar = document.querySelector('.sidebar');
                
                try {
                    if (!this.currentUser) {
                        console.log('âŒ No authenticated user found');
                        this.resetMenuVisibility();
                        sidebar?.classList.remove('menu-loading');
                        return;
                    }
                    
                    // Get user's company ID and role
                    const companyId = this.currentUser.companyId;
                    const userRole = this.currentUser.role;
                    
                    console.log('ðŸ‘¤ User:', this.currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
                    
                    if (!companyId) {
                        console.log('âŒ Missing company ID');
                        this.resetMenuVisibility();
                        sidebar?.classList.remove('menu-loading');
                        return;
                    }
                    
                    // STEP 1: Apply company feature-based authorization
                    console.log('ðŸ¢ STEP 1: Applying company feature authorization...');
                    const authorizedPages = await this.applyFeatureBasedMenuVisibility(companyId);
                    
                    // STEP 2: Filter by user role permissions within authorized features
                    if (userRole && authorizedPages && authorizedPages.length > 0) {
                        console.log('ðŸ‘¤ STEP 2: Applying role-based filtering within authorized features...');
                        await this.applyRoleBasedFiltering(companyId, userRole, authorizedPages);
                    } else {
                        console.log('âš ï¸ STEP 2: Skipping role-based filtering (no role found or no authorized pages)');
                        sidebar?.classList.remove('menu-loading');
                    }
                    
                } catch (error) {
                    console.error('âŒ Error updating menu visibility:', error);
                    this.resetMenuVisibility();
                    sidebar?.classList.remove('menu-loading');
                }
            }

            // Apply feature-based menu visibility (matching staff.html)
            async applyFeatureBasedMenuVisibility(companyId) {
                try {
                    console.log('ðŸ”§ Applying feature-based menu visibility for company:', companyId);
                    
                    // Get platform features
                    const database = firebase.database();
                    const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                    
                    if (!featuresSnapshot.exists()) {
                        console.log('âš ï¸ No platform features found');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    const featuresData = featuresSnapshot.val();
                    
                    // Get company's selected features
                    const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                    const companyData = companySnapshot.val();
                    
                    if (!companyData) {
                        console.error('âŒ Company data not found');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    const subscribedFeatureIds = companyData.selectedFeatures || [];
                    console.log('ðŸ¢ Company subscribed features:', subscribedFeatureIds);
                    
                    if (subscribedFeatureIds.length === 0) {
                        console.log('âš ï¸ Company has no subscribed features');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    // Collect authorized pages from subscribed features
                    const authorizedPages = [];
                    subscribedFeatureIds.forEach(featureId => {
                        const feature = featuresData[featureId];
                        if (feature && feature.status === 'active' && feature.authorizedPages) {
                            console.log(`ðŸ“¦ Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                            authorizedPages.push(...feature.authorizedPages);
                        } else {
                            console.log(`âš ï¸ Feature ${featureId} not found or inactive`);
                        }
                    });
                    
                    console.log('ðŸ” All authorized pages:', authorizedPages);
                    
                    // Reset all menu items first
                    this.resetMenuVisibility();
                    
                    // Create set of authorized features
                    const authorizedFeatures = new Set();
                    authorizedPages.forEach(pageInfo => {
                        if (pageInfo.feature) {
                            authorizedFeatures.add(pageInfo.feature);
                        }
                    });
                    
                    console.log('ðŸŽ¯ Authorized features for access.html:', Array.from(authorizedFeatures));
                    
                    // Apply menu visibility
                    const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                    let visibleCount = 0;
                    
                    allMenuItems.forEach(menuItem => {
                        const featureAttribute = menuItem.getAttribute('data-feature');
                        const isAuthorized = authorizedFeatures.has(featureAttribute);
                        const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                        
                        if (isDropdownContainer) {
                            return; // Handle dropdowns separately after all items are processed
                        }
                        
                        if (isAuthorized) {
                            menuItem.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`âœ… Feature authorized - showing menu item: ${featureAttribute}`);
                        } else {
                            menuItem.classList.remove('menu-visible');
                            console.log(`âŒ Feature not authorized - hiding menu item: ${featureAttribute}`);
                        }
                    });
                    
                    // Handle dropdown menus - show if they have visible children
                    const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                    dropdownMenus.forEach(dropdown => {
                        const dropdownFeature = dropdown.getAttribute('data-feature');
                        const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                        let hasVisibleChildren = false;
                        
                        submenuItems.forEach(submenuItem => {
                            if (submenuItem.classList.contains('menu-visible')) {
                                hasVisibleChildren = true;
                            }
                        });
                        
                        if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                            dropdown.classList.add('menu-visible');
                            console.log(`âœ… Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                        } else {
                            dropdown.classList.remove('menu-visible');
                            console.log(`âŒ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                        }
                    });
                    
                    console.log(`ðŸŽ¯ Company feature authorization completed - ${visibleCount} items initially visible`);
                    
                    // Return authorized pages for role-based filtering
                    return authorizedPages;
                    
                } catch (error) {
                    console.error('âŒ Error applying feature-based menu visibility:', error);
                    this.resetMenuVisibility();
                    return [];
                }
            }

            // Apply role-based filtering within company authorized features
            async applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
                try {
                    console.log('ðŸ‘¤ Applying role-based filtering for role:', userRole);
                    
                    // Get user role permissions from company
                    const database = firebase.database();
                    const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
                    const permissionsSnapshot = await permissionsRef.once('value');
                    
                    if (!permissionsSnapshot.exists()) {
                        console.log(`âš ï¸ No permissions found for role ${userRole} in company ${companyId}`);
                        
                        // CRITICAL: If user is administrator but no permissions found, provide full access as fallback
                        if (userRole === 'administrator') {
                            console.log('ðŸ”‘ ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
                            this.showSidebarAfterAuth();
                            return;
                        }
                        
                        // For other roles without permissions, hide all items with permission requirements
                        console.log('âŒ No valid permissions found - filtering out items requiring permissions');
                        this.hideItemsRequiringPermissions();
                        this.showSidebarAfterAuth();
                        return;
                    }
                    
                    const permissions = permissionsSnapshot.val();
                    console.log('âœ… Loaded role permissions:', permissions);
                    
                    // Apply permission-based filtering
                    this.filterMenuByPermissions(permissions);
                    
                } catch (error) {
                    console.error('âŒ Error applying role-based filtering:', error);
                    // Don't hide everything on error - keep company features visible
                    this.showSidebarAfterAuth();
                }
            }

            // Filter currently visible menu items by role permissions
            filterMenuByPermissions(permissions) {
                console.log('ðŸ” Filtering visible menu items by role permissions...');
                
                if (!permissions) {
                    console.log('âš ï¸ No permissions object provided');
                    this.hideItemsRequiringPermissions();
                    this.showSidebarAfterAuth();
                    return;
                }
                
                // Only check items that are already visible from company features
                const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
                console.log(`ðŸŽ¯ Found ${visibleMenuItems.length} visible menu items requiring permissions to check`);
                
                let hiddenCount = 0;
                
                visibleMenuItems.forEach(item => {
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    const feature = item.getAttribute('data-feature');
                    
                    if (requiresPermission) {
                        const hasPermission = permissions[requiresPermission];
                        const hasViewPermission = hasPermission === true || 
                                                 (hasPermission && hasPermission.view === true);
                        
                        if (!hasViewPermission) {
                            item.classList.remove('menu-visible');
                            hiddenCount++;
                            console.log(`âŒ Hiding menu item (no permission): ${feature} (requires: ${requiresPermission})`);
                        } else {
                            console.log(`âœ… Keeping menu item visible: ${feature} (has permission: ${requiresPermission})`);
                        }
                    }
                });
                
                // Re-check dropdown menus after permission filtering
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    
                    if (submenuItems.length === 0) {
                        dropdown.classList.remove('menu-visible');
                        console.log(`âŒ Hiding dropdown (no visible children): ${dropdownFeature}`);
                    } else {
                        console.log(`âœ… Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
                    }
                });
                
                console.log(`ðŸŽ¯ Role-based filtering completed - ${hiddenCount} items hidden due to lack of permissions`);
                
                // Show sidebar after all filtering is complete
                this.showSidebarAfterAuth();
            }

            // Hide menu items that require permissions (for users without role permissions)
            hideItemsRequiringPermissions() {
                console.log('ðŸ”’ Hiding all menu items that require permissions...');
                
                const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
                let hiddenCount = 0;
                
                itemsRequiringPermissions.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const requiresPermission = item.getAttribute('data-requires-permission');
                    
                    item.classList.remove('menu-visible');
                    hiddenCount++;
                    console.log(`âŒ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
                });
                
                console.log(`ðŸ”’ Hidden ${hiddenCount} items requiring permissions`);
            }

            // Show sidebar and remove loading state after authentication and filtering
            showSidebarAfterAuth() {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                    console.log('âœ… Sidebar loading state removed - menu authorization complete');
                }
            }

            // Emergency fallback menu (basic items only)
            showBasicMenu() {
                console.log('ðŸš¨ Showing basic emergency menu - authorization system failed');
                this.resetMenuVisibility();
                
                // Show only essential menu items
                const essentialItems = [
                    '[data-feature="home_view"]',
                    '[data-feature="communication_view"]',
                    '[data-feature="settings_view"]',
                    '[data-feature="account_settings_view"]'
                ];
                
                essentialItems.forEach(selector => {
                    const item = document.querySelector(`#roleBasedMenu li${selector}`);
                    if (item) {
                        item.classList.add('menu-visible');
                        // Also show parent dropdown if needed
                        const parentDropdown = item.closest('.menu-dropdown');
                        if (parentDropdown) {
                            parentDropdown.classList.add('menu-visible');
                        }
                    }
                });
                
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                console.log('ðŸš¨ Basic emergency menu displayed');
            }

            async loadUserRole(user){ if(user.role||!user.uid) return; try{ const snap=await firebase.database().ref(`users/${user.uid}`).once('value'); if(snap.exists()){ user.role=snap.val().role||'user'; this.setCurrentUser(user); } }catch(e){ console.warn('Role load error',e);} }
            async loadUserCompany(){ 
                if(!this.currentUser) return; 
                try{ 
                    const snap=await firebase.database().ref('companies').once('value'); 
                    if(!snap.exists()) { 
                        this.resetMenuVisibility();
                        return; 
                    } 
                    const companies=snap.val(); 
                    for(const [cid,comp] of Object.entries(companies)){ 
                        if(comp.status!=='active') continue; 
                        if(comp.users){ 
                            for(const [uid,u] of Object.entries(comp.users)){ 
                                if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ 
                                    this.currentUser.companyId=cid; 
                                    this.currentUser.companyName=comp.companyName; 
                                    this.currentUser.role=u.role || u.userRole || 'user'; // Set user role from company user record
                                    this.currentCompany=comp; 
                                    this.setCurrentUser(this.currentUser); 
                                    console.log('âœ… Found user in company:', cid, 'with role:', this.currentUser.role);
                                    this.updateCompanyBranding(); 
                                    // Apply feature-based menu authorization
                                    await this.updateMenuVisibility();
                                    return; 
                                } 
                            } 
                        } 
                    } 
                    console.warn('User not found in any company');
                    this.resetMenuVisibility();
                }catch(e){ 
                    console.error('Company load error',e); 
                    this.resetMenuVisibility();
                } 
            }
            updateCompanyBranding(){ if(!this.currentCompany){ this.showFallbackBranding(); return;} const logoEl=$('#headerCompanyLogo'); const nameEl=$('#headerCompanyName'); if(nameEl && this.currentCompany.companyName) nameEl.textContent=this.currentCompany.companyName; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.classList.remove('placeholder'); logoEl.src=logoUrl; logoEl.style.display='block'; logoEl.classList.add('visible'); } else { // show placeholder initials
                  const initials=this.getCompanyInitials(this.currentCompany.companyName||''); const svg=this.generateCompanyInitialsSVG(initials); logoEl.src=svg; logoEl.style.display='block'; logoEl.classList.add('visible'); logoEl.classList.add('placeholder'); }
              }
              if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color',this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color',this.currentCompany.branding.secondaryColor); }
            }
            showFallbackBranding(){ const logoEl=$('#headerCompanyLogo'); const nameEl=$('#headerCompanyName'); if(nameEl){nameEl.textContent='';} if(logoEl){ const svg=this.generateCompanyInitialsSVG('DX'); logoEl.src=svg; logoEl.style.display='block'; logoEl.classList.add('placeholder','visible'); } }
            getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
            generateCompanyInitialsSVG(initials){ const bg='#f0f3f6'; const txt='#495057'; const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="${bg}"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="${txt}" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
            getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=(v)=> (typeof v==='string'? v.trim().replace(/\s+/g,' '):''); const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){ const cleaned=n(c); if(cleaned) return cleaned; } if(this.currentUser.email){ return n(this.currentUser.email.split('@')[0])||'User'; } return 'User'; }
            getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
            getUserEmail(){ return this.currentUser?.email||''; }
            async getUserAvatarUrl(){ if(!this.currentUser) return null; try{ const ref=firebase.storage().ref(`avatars/${this.currentUser.uid}/profile.jpg`); return await ref.getDownloadURL(); }catch(e){ return null; } }
            generateInitialsAvatar(name,img){ if(!img) return; const initials=this.getUserInitials(); const colors=['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6','#1abc9c']; const bg=colors[name.length%colors.length]; const svg=`<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="${bg}"/><text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text></svg>`; img.src='data:image/svg+xml;base64,'+btoa(svg); img.alt=name+' Avatar'; }
            async updateUIForAuthenticatedUser(){ const btn=$('#userProfileBtn'); const dropdownList=document.querySelector('.profile-dropdown ul'); if(!btn||!dropdownList||!this.currentUser) return; const displayName=this.getUserDisplayName(); const email=this.getUserEmail(); const avatarUrl=await this.getUserAvatarUrl(); const img=btn.querySelector('img'); if(img){ if(avatarUrl){ img.src=avatarUrl; img.alt=displayName+' Avatar'; } else { this.generateInitialsAvatar(displayName,img); } }
                const dropdownAvatarHtml= avatarUrl? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
                dropdownList.innerHTML=`<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${dropdownAvatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="#"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`;
                const logoutLink=dropdownList.querySelector('a[href="#"]'); if(logoutLink){ logoutLink.addEventListener('click',e=>{e.preventDefault(); this.logout();}); }
            }
    }
    window.authManager=new AuthManager();

    /******************** EmailNotificationService (Enhanced) ********************/
    class EmailNotificationService{ 
      constructor(){ 
        this.emailjsServiceId = 'service_p2e9swy'; // Using existing EmailJS service ID
        this.emailjsTemplateId = 'template_veu0kvg'; // Access request approval template ID
        this.emailjsPublicKey = 'fHs6oaqQgkcPoUwpv'; // Using existing EmailJS public key
        this.maxRetries = 2; 
        
        // Initialize EmailJS if not already done
        if (typeof emailjs !== 'undefined' && !emailjs._userID) {
          emailjs.init(this.emailjsPublicKey);
        }
      }
      
      async resolveApproversFromLevels(approvalFlow, companyId) {
        console.log('ðŸ” Resolving approvers from approval flow levels...', approvalFlow);
        
        try {
          if (!approvalFlow.selectedRoles) {
            console.warn('âŒ No selectedRoles configured in approval flow');
            return [];
          }
          
          // Get the first level from selectedRoles
          const firstLevelKey = 'level1'; // Start with level1
          const firstLevelRoles = approvalFlow.selectedRoles[firstLevelKey];
          
          if (!firstLevelRoles || !Array.isArray(firstLevelRoles) || firstLevelRoles.length === 0) {
            console.warn('âŒ No approvers configured in first level (selectedRoles.level1)');
            return [];
          }
          
          console.log(`ðŸ“‹ Found ${firstLevelRoles.length} approvers in level1:`, firstLevelRoles);
          
          const approvers = [];
          
          for (const roleConfig of firstLevelRoles) {
            console.log('ðŸ” Processing role config:', roleConfig);
            
            if (roleConfig.approverType === 'name' && roleConfig.value) {
              // Direct user assignment - get user by ID
              const userId = roleConfig.value.replace('user_', ''); // Remove 'user_' prefix if present
              console.log(`ðŸ‘¤ Looking up user: ${userId}`);
              
              try {
                // Try company users first
                const companyUserSnapshot = await firebase.database().ref(`companies/${companyId}/users/${userId}`).once('value');
                if (companyUserSnapshot.exists()) {
                  const userData = companyUserSnapshot.val();
                  if (userData.email) {
                    approvers.push({
                      id: userId,
                      email: userData.email,
                      name: userData.name || userData.displayName || roleConfig.text || 'Unknown User',
                      source: 'company_users'
                    });
                    console.log(`âœ… Found in company users: ${userData.name} (${userData.email})`);
                    continue;
                  }
                }
                
                // Try global users collection
                const globalUserSnapshot = await firebase.database().ref(`users/${userId}`).once('value');
                if (globalUserSnapshot.exists()) {
                  const userData = globalUserSnapshot.val();
                  if (userData.email) {
                    approvers.push({
                      id: userId,
                      email: userData.email,
                      name: userData.name || userData.displayName || roleConfig.text || 'Unknown User',
                      source: 'global_users'
                    });
                    console.log(`âœ… Found in global users: ${userData.name} (${userData.email})`);
                    continue;
                  }
                }
                
                console.warn(`âš ï¸ User ${userId} not found or has no email`);
                
              } catch (error) {
                console.error(`âŒ Error looking up user ${userId}:`, error);
              }
            } 
            else if (roleConfig.approverType === 'function' && roleConfig.value) {
              // Function-based assignment - find users with matching job functions
              console.log(`ðŸŽ¯ Resolving function-based approver: ${roleConfig.value}`);
              
              const usersSnapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
              if (usersSnapshot.exists()) {
                const users = usersSnapshot.val();
                const targetFunction = roleConfig.value;
                
                // Extract the role keyword from function_ prefix
                const roleKeyword = targetFunction.replace('function_', '');
                console.log(`ðŸŽ¯ Looking for users with role keyword: "${roleKeyword}"`);
                
                for (const [uid, userData] of Object.entries(users)) {
                  let isMatch = false;
                  
                  // Check user's role field
                  if (userData.role && userData.role.toLowerCase().includes(roleKeyword.toLowerCase())) {
                    isMatch = true;
                    console.log(`âœ… Role match: ${userData.name} - Role: ${userData.role}`);
                  }
                  
                  // Check user's job title field
                  if (!isMatch && userData.jobTitle) {
                    const jobTitle = userData.jobTitle.toLowerCase();
                    const roleKeywordLower = roleKeyword.toLowerCase();
                    
                    // Define common variations for different role types
                    const roleVariations = {
                      'supervisor': ['supervisor', 'team lead', 'team leader', 'lead', 'section head'],
                      'manager': ['manager', 'director', 'head of', 'department head', 'senior manager'],
                      'admin': ['admin', 'administrator', 'system admin'],
                      'hr': ['hr', 'human resources', 'hr manager', 'hr director'],
                      'finance': ['finance', 'financial', 'accountant', 'finance manager'],
                      'it': ['it', 'information technology', 'tech', 'technical']
                    };
                    
                    // Get variations for the role keyword, or use the keyword itself
                    const variations = roleVariations[roleKeywordLower] || [roleKeywordLower];
                    
                    for (const variation of variations) {
                      if (jobTitle.includes(variation)) {
                        isMatch = true;
                        console.log(`âœ… Job title match: ${userData.name} - Job Title: ${userData.jobTitle} (matched "${variation}")`);
                        break;
                      }
                    }
                  }
                  
                  if (isMatch && userData.email) {
                    approvers.push({
                      id: uid,
                      email: userData.email,
                      name: userData.name || userData.displayName || 'Unknown User',
                      role: userData.role || '',
                      jobTitle: userData.jobTitle || '',
                      source: 'function_based'
                    });
                    console.log(`âœ… Added function-based approver: ${userData.name} (${userData.email})`);
                  }
                }
              }
            }
            else if (roleConfig.approverType === 'role' && roleConfig.value) {
              // Role-based assignment - find users with specific role
              console.log(`ðŸŽ¯ Resolving role-based approver: ${roleConfig.value}`);
              
              const usersSnapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
              if (usersSnapshot.exists()) {
                const users = usersSnapshot.val();
                for (const [uid, userData] of Object.entries(users)) {
                  if (userData.role === roleConfig.value && userData.email) {
                    approvers.push({
                      id: uid,
                      email: userData.email,
                      name: userData.name || userData.displayName || 'Unknown User',
                      role: userData.role,
                      source: 'role_based'
                    });
                    console.log(`âœ… Added role-based approver: ${userData.name} (${userData.email}) - Role: ${userData.role}`);
                  }
                }
              }
            }
          }
          
          console.log(`ðŸ“§ Resolved ${approvers.length} approvers:`, approvers.map(a => `${a.name} (${a.email}) [${a.source}]`));
          return approvers;
          
        } catch (error) {
          console.error('âŒ Error resolving approvers from levels:', error);
          return [];
        }
      }
      
      async sendApprovalNotificationEmails(accessRequest, requestId, isUpdate = false) {
        console.log('ðŸ”„ Sending approval notification emails...', {requestId, isUpdate});
        console.log('ðŸ“‹ Access request data:', accessRequest);
        
        try {
          // Get company ID from current user or access request
          let companyId = null;
          
          // Try to get from current user
          if (window.authManager?.currentUser?.companyId) {
            companyId = window.authManager.currentUser.companyId;
            console.log(`ðŸŽ¯ Using company ID from current user: ${companyId}`);
          }
          // Try to get from access request
          else if (accessRequest.companyId) {
            companyId = accessRequest.companyId;
            console.log(`ðŸŽ¯ Using company ID from access request: ${companyId}`);
          }
          // Fallback to default company ID (can be configured)
          else {
            companyId = '-OVdOmV_CnbwZ0d7JrkB'; // Default fallback
            console.log(`âš ï¸ Using fallback company ID: ${companyId}`);
          }
          
          if (!companyId) {
            console.error('âŒ No company ID available');
            return {success: false, error: 'No company ID available', emailsSent: 0};
          }
          
          console.log(`ðŸŽ¯ Final company ID: ${companyId}`);
          
          const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
          const flowSnap = await approvalFlowRef.once('value');
          
          if (!flowSnap.exists()) {
            console.warn('âŒ No approval flow configured for access requests');
            console.warn('ðŸ” Checked path:', `companies/${companyId}/approvalFlows/access`);
            return {success: false, error: 'No approval flow', emailsSent: 0};
          }
          
          const approvalFlow = flowSnap.val();
          console.log('ðŸ“‹ Loaded approval flow:', approvalFlow);
          
          // Use the new resolver function to get approvers from levels configuration
          const approverEmails = await this.resolveApproversFromLevels(approvalFlow, companyId);
          
          if (approverEmails.length === 0) {
            console.warn('âŒ No valid approver emails found');
            return {success: false, error: 'No approvers configured in first level', emailsSent: 0};
          }
          
          console.log(`ðŸ“§ Sending emails to ${approverEmails.length} approvers:`, approverEmails);
          
          // Send emails to all first-level approvers
          let emailsSent = 0;
          const results = [];
          
          for (const approver of approverEmails) {
            try {
              console.log(`ðŸ“¤ Sending email to: ${approver.email}`);
              const emailResult = await this.sendSingleApprovalEmail(accessRequest, approver, 1, approvalFlow.levels?.length || 1);
              if (emailResult.success) {
                emailsSent++;
                console.log(`âœ… Email sent to ${approver.email}`);
              } else {
                console.error(`âŒ Failed to send email to ${approver.email}:`, emailResult.error);
              }
              results.push({approver: approver.email, result: emailResult});
            } catch (error) {
              console.error(`âŒ Failed to send email to ${approver.email}:`, error);
              results.push({approver: approver.email, error: error.message});
            }
          }
          
          // Add notification for submitter
          window.notificationManager?.addNotification({
            type: 'Email',
            message: `Approval notifications sent to ${emailsSent} approver${emailsSent !== 1 ? 's' : ''} for ${accessRequest.referenceNumber}`
          });
          
          console.log(`ðŸ“Š Email sending complete: ${emailsSent}/${approverEmails.length} emails sent successfully`);
          
          return {
            success: emailsSent > 0,
            emailsSent,
            totalApprovers: approverEmails.length,
            results
          };
          
        } catch (error) {
          console.error('âŒ Error sending approval notifications:', error);
          return {success: false, error: error.message, emailsSent: 0};
        }
      }
      
      async sendSingleApprovalEmail(accessRequest, approver, currentLevel, totalLevels) {
        if (typeof emailjs === 'undefined') {
          console.error('âŒ EmailJS not loaded');
          return {success: false, error: 'EmailJS not available'};
        }
        
        try {
          // Helper function to sanitize template values
          const sanitize = (value, defaultValue = '') => {
            if (value === null || value === undefined) return defaultValue;
            if (typeof value === 'string') return value.trim() || defaultValue;
            return String(value) || defaultValue;
          };
          
          // Ensure accessRequest has all required fields
          const safeAccessRequest = {
            referenceNumber: sanitize(accessRequest.referenceNumber, 'AR-UNKNOWN'),
            status: sanitize(accessRequest.status, 'Submitted'),
            requesterName: sanitize(accessRequest.requesterName, 'Unknown Requester'),
            requesterEmail: sanitize(accessRequest.requesterEmail, ''),
            companyName: sanitize(accessRequest.companyName, 'Unknown Company'),
            departmentName: sanitize(accessRequest.departmentName, 'Unknown Department'),
            startDateTime: accessRequest.startDateTime || new Date().toISOString(),
            endDateTime: accessRequest.endDateTime || new Date().toISOString(),
            area: sanitize(accessRequest.area, 'Unspecified Area'),
            purpose: sanitize(accessRequest.purpose, 'Business purpose'),
            visitors: accessRequest.visitors || [],
            equipment: accessRequest.equipment || [],
            id: sanitize(accessRequest.id, 'TEMP-ID')
          };
          
          // Ensure approver has all required fields
          const safeApprover = {
            email: sanitize(approver.email, 'noreply@example.com'),
            name: sanitize(approver.name, 'Approver')
          };
          
          // Prepare template parameters with validation
          const templateParams = {
            // Recipient email (required by EmailJS)
            to_email: safeApprover.email,
            to_name: safeApprover.name,
            
            // Approver info
            approver_name: safeApprover.name,
            
            // Request details
            reference_number: safeAccessRequest.referenceNumber,
            status: safeAccessRequest.status,
            
            // Requester
            requester_name: safeAccessRequest.requesterName,
            requester_email: safeAccessRequest.requesterEmail,
            company_name: safeAccessRequest.companyName,
            department_name: safeAccessRequest.departmentName,
            
            // Access details
            start_datetime: this.formatDateTime(safeAccessRequest.startDateTime),
            end_datetime: this.formatDateTime(safeAccessRequest.endDateTime),
            area: safeAccessRequest.area,
            
            // Content
            purpose: safeAccessRequest.purpose,
            visitors_list: this.generateVisitorsList(safeAccessRequest.visitors),
            equipment_list: this.generateEquipmentList(safeAccessRequest.equipment),
            
            // Attachments
            attachments_summary: this.generateAttachmentsSummary(safeAccessRequest),
            
            // Approval flow
            current_level: String(currentLevel || 1),
            total_levels: String(totalLevels || 1),
            
            // Action URL
            approval_url: `${window.location.origin}/accessboard.html?id=${safeAccessRequest.id}&action=review`
          };
          
          // Validate all template parameters are strings
          const validatedParams = {};
          for (const [key, value] of Object.entries(templateParams)) {
            validatedParams[key] = sanitize(value, '');
          }
          
          console.log('ðŸ“§ Sending email to:', safeApprover.email);
          console.log('ðŸ“‹ Validated template parameters:', validatedParams);
          
          // Final validation: ensure no undefined/null values
          const hasInvalidValues = Object.values(validatedParams).some(value => 
            value === null || value === undefined || value === 'undefined' || value === 'null'
          );
          
          if (hasInvalidValues) {
            console.error('âŒ Template parameters still contain invalid values:', validatedParams);
            return {success: false, error: 'Template parameters validation failed'};
          }
          
          // Send email via EmailJS
          const result = await emailjs.send(
            this.emailjsServiceId,
            this.emailjsTemplateId,
            validatedParams
          );
          
          console.log('âœ… EmailJS send result:', result);
          return {success: true, result};
          
        } catch (error) {
          console.error('âŒ EmailJS send error:', error);
          console.error('âŒ Error details:', error.text || error.message || error);
          return {success: false, error: error.text || error.message || error.toString()};
        }
      }
      
      formatDateTime(dateTimeString) {
        if (!dateTimeString) return 'Not specified';
        try {
          const formatted = new Date(dateTimeString).toLocaleString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
          });
          return formatted || String(dateTimeString);
        } catch (error) {
          return String(dateTimeString) || 'Invalid date';
        }
      }
      
      generateVisitorsList(visitors) {
        if (!visitors || !Array.isArray(visitors) || visitors.length === 0) {
          return 'No visitors specified';
        }
        
        try {
          return visitors.map(visitor => {
            const name = String(visitor?.name || 'Unnamed visitor');
            const jobTitle = visitor?.jobTitle ? ` â€“ ${String(visitor.jobTitle)}` : '';
            const company = visitor?.company ? ` â€“ ${String(visitor.company)}` : '';
            return `<div class="list-item">${name}${jobTitle}${company}</div>`;
          }).join('') || 'No visitors specified';
        } catch (error) {
          console.error('Error generating visitors list:', error);
          return 'Error generating visitors list';
        }
      }
      
      generateEquipmentList(equipment) {
        if (!equipment || !Array.isArray(equipment) || equipment.length === 0) {
          return 'No equipment specified';
        }
        
        try {
          return equipment.map(item => {
            const name = String(item?.name || 'Unnamed equipment');
            const description = item?.description ? ` â€“ ${String(item.description)}` : '';
            return `<div class="list-item">${name}${description}</div>`;
          }).join('') || 'No equipment specified';
        } catch (error) {
          console.error('Error generating equipment list:', error);
          return 'Error generating equipment list';
        }
      }
      
      generateAttachmentsSummary(accessRequest) {
        try {
          let totalVisitorDocs = 0;
          if (Array.isArray(accessRequest?.visitors)) {
            accessRequest.visitors.forEach(v => {
              if (Array.isArray(v?.attachments)) totalVisitorDocs += v.attachments.length;
              else if (v?.attachment && v.attachment.url) totalVisitorDocs += 1;
            });
          }
          const parts = [];
          if (totalVisitorDocs > 0) parts.push(`${totalVisitorDocs} attachment${totalVisitorDocs > 1 ? 's' : ''}`);
          return parts.length > 0 ? parts.join(', ') : 'No attachments';
        } catch (error) {
          console.error('Error generating attachments summary:', error);
          return 'No attachments';
        }
      }
      
      async createSubmitterNotification(accessRequest, requestId) { 
        window.notificationManager?.addNotification({
          type: 'Submission',
          message: `Gate pass request ${accessRequest.referenceNumber || requestId} submitted and sent for approval.`
        });
      }
    }

    /******************** AccessManager (converted to v8) ********************/
    class AccessManager{ constructor(){ this.db=firebase.database(); this.auth=firebase.auth(); this.storage=firebase.storage(); this.emailService=new EmailNotificationService(); this.users=[]; this.departmentOptions={}; this.companyOptions={}; this.locationOptions={}; this.visitorCount=0; this.equipmentCount=0; this.initializeForm(); this.initializeVisitorHandlers(); this.initializeEquipmentHandlers(); 
      
      // Delay initialization to allow auth state to settle
      setTimeout(() => {
        this.initializeData();
      }, 1000);
    }
      async initializeData(){ try{ await Promise.all([this.loadLocations(),this.loadCompanyOptions(),this.setCurrentUserAsRequester(),this.setCurrentUserCompany(),this.setCurrentUserDepartment(),this.setCurrentUserContactPhone(),this.setCurrentUserLineManager()]); await this.loadAccessRequestData(); this.generateReferenceNumber(); this.initializeVisitor0Fields(); }catch(e){ console.error('Data load error',e); window.notificationManager?.addNotification({type:'Error',message:'Failed to load form data.'}); } }
      qs(id){return document.getElementById(id);} val(id){return this.qs(id)?.value||'';}
      initializeForm(){ const form=this.qs('accessRequestForm'); if(!form)return; form.addEventListener('submit',e=>{e.preventDefault(); this.submitAccessRequest(form);}); 
        
        // Note: Date validation is now handled per visitor in setupVisitorDateValidation()
        // Note: Department field is now read-only and auto-populated, no event listeners needed
      }
      initializeVisitorHandlers(){ const addBtn=document.querySelector('.btn-add-visitor'); if(addBtn){ addBtn.addEventListener('click',()=>this.addVisitorRow()); }}
      
      initializeVisitor0Fields() {
        // Initialize area dropdown for visitor-0
        const visitor0Area = document.querySelector('#visitor-area-0');
        if (visitor0Area) {
          this.loadVisitorAreaDropdown(visitor0Area);
        }
        
        // Initialize date validation for visitor-0
        const visitor0Container = document.querySelector('.visitor-row');
        if (visitor0Container) {
          this.setupVisitorDateValidation(visitor0Container, 0);
        }
        // Bind selected-files preview for visitor-0 attachments
        const visitor0Attach = document.querySelector('#visitor-attachment-0');
        if (visitor0Attach) {
          this.setupAttachmentPreview(visitor0Attach);
        }
      }
      initializeEquipmentHandlers(){ const addBtn=document.querySelector('.btn-add-equipment'); if(addBtn){ addBtn.addEventListener('click',()=>this.addEquipmentRow()); }}
      generateReferenceNumber(){ 
        const refField=this.qs('referenceNumber'); 
        if(!refField) return;
        
        // Get company ID and department ID from form fields
        const companyId = this.qs('companyId')?.value || '';
        const departmentId = this.qs('departmentId')?.value || '';
        
        // Get actual names from fields (company name directly, department name from options)
        const companyName = this.qs('companyName')?.value || ''; // Now directly the company name
        const departmentName = this.qs('department')?.value || ''; // Now directly the department name
        
        // Only generate reference number if both company and department are available
        if (!companyName || !departmentName) {
          console.log('â³ Waiting for company and department to be populated before generating reference number');
          return;
        }
        
        // Generate company initials (first letter of each word) from company NAME
        const companyInitials = companyName
          .split(' ')
          .map(word => word.charAt(0).toUpperCase())
          .join('')
          .substring(0, 3) || 'CO'; // Default to 'CO' if no company
        
        // Generate department initials (first letter of each word) from department NAME
        const departmentInitials = departmentName
          .split(' ')
          .map(word => word.charAt(0).toUpperCase())
          .join('')
          .substring(0, 3) || 'DP'; // Default to 'DP' if no department
        
        // Generate unique number (timestamp-based)
        const uniqueNumber = Date.now().toString().slice(-6); // Last 6 digits of timestamp
        
        // Format: AR-CompanyInitials-DepartmentInitials-Number
        const referenceNumber = `AR-${companyInitials}-${departmentInitials}-${uniqueNumber}`;
        refField.value = referenceNumber;
        
        console.log(`ðŸ”¢ Generated reference number: ${referenceNumber} (Company: ${companyName}, Department: ${departmentName})`);
      }
      async loadDepartments(){ 
        const select=this.qs('department'); 
        if(!select) return; 
        
        select.disabled=true; 
        select.innerHTML='<option>Loading...</option>'; 
        
        // Get company ID from AuthManager
        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId) {
          console.warn('Company ID not found for loading departments');
          select.innerHTML='<option value="">Select Department</option><option value="">No company context</option>';
          select.disabled=false;
          return;
        }
        
        try {
          // Load departments from company scope field configuration
          const snap = await firebase.database().ref(`companies/${companyId}/fieldOptions/department`).once('value'); 
          
          select.innerHTML='<option value="">Select Department</option>'; 
          
          if(!snap.exists()) { 
            console.warn(`No departments found for company: ${companyId} at path: companies/${companyId}/fieldOptions/department`);
            select.innerHTML+='<option value="">No departments available</option>'; 
            select.disabled=false; 
            return;
          } 
          
          // Process each department
          snap.forEach(cs=>{ 
            const dept=cs.val(); 
            const id=cs.key; 
            const label=dept.label||dept.value||dept.name||id; 
            this.departmentOptions[id]=label; 
            const opt=document.createElement('option'); 
            opt.value=id; 
            opt.textContent=label; 
            select.appendChild(opt); 
          }); 
          
          console.log(`âœ… Loaded ${snap.numChildren()} departments for company: ${companyId} from path: companies/${companyId}/fieldOptions/department`);
          
        } catch(error) {
          console.error('Error loading departments:', error);
          select.innerHTML='<option value="">Select Department</option><option value="">Error loading options</option>';
        }
        
        select.disabled=false; 
      }
      async loadUsers(){ 
        // This function now only loads users for visitor dropdowns
        const visitorSel=document.getElementById('visitor-0'); 
        const snap=await firebase.database().ref('users').once('value'); 
        if(!snap.exists()) return; 
        this.users=[]; 
        snap.forEach(cs=>{ 
          const u=cs.val(); 
          const id=cs.key; 
          const name=`${u.firstName||''} ${u.lastName||''}`.trim()||u.email||id; 
          this.users.push({id,name}); 
        }); 
        // Note: Visitor field is now a text input, no dropdown loading needed
      }
      async loadLocations(){ 
        const areaSel=this.qs('area'); 
        if(!areaSel) return; 
        
        areaSel.disabled=true;
        areaSel.innerHTML='<option>Loading...</option>';
        
        // Get company ID from AuthManager
        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId) {
          console.warn('Company ID not found for loading work areas');
          areaSel.innerHTML='<option value="">Select Area/Location</option><option value="">No company context</option>';
          areaSel.disabled=false;
          return;
        }
        
        try {
          // Load work areas from company scope field configuration (from settings.html 'area' field)
          const snap = await firebase.database().ref(`companies/${companyId}/fieldOptions/area`).once('value');
          
          areaSel.innerHTML='<option value="">Select Area/Location</option>';
          
          if(!snap.exists()) {
            console.warn(`No work areas found for company: ${companyId} at path: companies/${companyId}/fieldOptions/area`);
            areaSel.innerHTML+='<option value="">No work areas configured</option>';
            areaSel.disabled=false;
            return;
          }
          
          // Process each work area - data can be stored as array or object
          const areasData = snap.val();
          
          if (Array.isArray(areasData)) {
            // Handle array format
            areasData.forEach((area, index) => {
              if (area && area.enabled !== false) { // Only show enabled areas
                const option = document.createElement('option');
                option.value = area.value || area.label || `area-${index}`;
                option.textContent = area.label || area.value || `Area ${index + 1}`;
                areaSel.appendChild(option);
              }
            });
          } else if (typeof areasData === 'object') {
            // Handle object format where each key is an area
            Object.entries(areasData).forEach(([key, area]) => {
              if (area && area.enabled !== false) { // Only show enabled areas
                const option = document.createElement('option');
                option.value = area.value || key;
                option.textContent = area.label || area.value || key;
                areaSel.appendChild(option);
              }
            });
          }
          
          console.log(`âœ… Loaded work areas for company: ${companyId} from path: companies/${companyId}/fieldOptions/area`);
          
        } catch(error) {
          console.error('Error loading work areas:', error);
          areaSel.innerHTML='<option value="">Select Area/Location</option><option value="">Error loading work areas</option>';
        }
        
        areaSel.disabled=false;
      }
      
      async loadCompanyOptions(){ 
        // Get company ID from AuthManager
        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId) {
          console.warn('Company ID not found for loading company options');
          return;
        }
        
        try {
          // Load company options from company scope field configuration
          const snap = await firebase.database().ref(`companies/${companyId}/fieldOptions/company`).once('value');
          
          // Store company options for visitor dropdowns
          this.companyOptions = {};
          
          if(!snap.exists()) {
            console.warn(`No company options found for company: ${companyId} at path: companies/${companyId}/fieldOptions/company`);
            return;
          }
          
          // Process each company option
          snap.forEach(companySnap => {
            const company = companySnap.val();
            const id = companySnap.key;
            const label = company.label || company.name || company.value || id;
            
            this.companyOptions[id] = label;
          });
          
          console.log(`âœ… Loaded ${snap.numChildren()} company options for company: ${companyId} from path: companies/${companyId}/fieldOptions/company`);
          
        } catch(error) {
          console.error('Error loading company options:', error);
        }
      }
      
      async setCurrentUserAsRequester(){ 
        const requesterField = this.qs('employeeId');
        const userIdField = this.qs('employeeUserId');
        
        if(!requesterField) return;
        
        try {
          // Get current user info from AuthManager
          const currentUser = window.authManager?.currentUser;
          if(!currentUser || !currentUser.uid) {
            console.warn('No authenticated user found for requester setup');
            requesterField.value = 'Not authenticated';
            return;
          }
          
          const companyId = currentUser.companyId;
          if(!companyId) {
            console.warn('No company ID found for requester setup');
            requesterField.value = 'No company context';
            return;
          }
          
          console.log(`ðŸ” Setting requester for user: ${currentUser.uid} in company: ${companyId}`);
          
          // Get user data from company users directory (where companymanagement.html stores user info)
          const companyUserSnap = await firebase.database().ref(`companies/${companyId}/users/${currentUser.uid}`).once('value');
          
          if(companyUserSnap.exists()) {
            const userData = companyUserSnap.val();
            console.log('ðŸ“‹ Company user data loaded:', userData);
            
            // Set the display name (requester name)
            const displayName = userData.name || 
                               `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 
                               userData.displayName ||
                               userData.fullName ||
                               userData.email || 
                               currentUser.email || 
                               'Current User';
            
            requesterField.value = displayName;
            
            // Set the employeeUserId field with the actual employee ID from companymanagement.html
            if(userIdField) {
              // Use employeeId from company user record if available, otherwise fall back to UID
              const employeeIdFromCompany = userData.employeeId || userData.employeeCode || userData.empCode;
              if(employeeIdFromCompany) {
                userIdField.value = employeeIdFromCompany;
                console.log(`âœ… Set employee ID: ${employeeIdFromCompany}`);
              } else {
                userIdField.value = currentUser.uid;
                console.log(`âš ï¸ No employee ID found in company record, using UID: ${currentUser.uid}`);
              }
            }
            
            console.log(`âœ… Set requester from company users: ${displayName} (Employee ID: ${userIdField?.value})`);
            return;
          }
          
          // Fallback: Get user details from global users database
          console.log('ðŸ”„ Company user data not found, trying global users...');
          const globalUserSnap = await firebase.database().ref(`users/${currentUser.uid}`).once('value');
          
          if(globalUserSnap.exists()) {
            const userData = globalUserSnap.val();
            const displayName = userData.name ||
                               `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 
                               userData.displayName || 
                               userData.email || 
                               currentUser.email || 
                               'Current User';
            
            requesterField.value = displayName;
            if(userIdField) {
              // Check for employee ID in global user record
              const employeeIdFromGlobal = userData.employeeId || userData.employeeCode || userData.empCode;
              if(employeeIdFromGlobal) {
                userIdField.value = employeeIdFromGlobal;
                console.log(`âœ… Set employee ID from global users: ${employeeIdFromGlobal}`);
              } else {
                userIdField.value = currentUser.uid;
                console.log(`âš ï¸ No employee ID found in global record, using UID: ${currentUser.uid}`);
              }
            }
            
            console.log(`âœ… Set requester from global users: ${displayName} (Employee ID: ${userIdField?.value})`);
          } else {
            // Final fallback to auth info if user not found in database
            const displayName = currentUser.displayName || currentUser.email || 'Current User';
            requesterField.value = displayName;
            if(userIdField) {
              userIdField.value = currentUser.uid;
            }
            
            console.log(`âš ï¸ User not found in database, using auth info: ${displayName} (UID: ${currentUser.uid})`);
          }
          
        } catch(error) {
          console.error('Error setting current user as requester:', error);
          requesterField.value = 'Error loading user';
          
          // Try to get basic info from AuthManager as fallback
          try {
            const authUser = window.authManager?.currentUser;
            if(authUser) {
              const fallbackName = authUser.email || authUser.displayName || 'Current User';
              requesterField.value = fallbackName;
              if(userIdField) {
                userIdField.value = authUser.uid || '';
              }
              console.log(`ðŸ”„ Used AuthManager fallback: ${fallbackName}`);
            }
          } catch(fallbackError) {
            console.error('Fallback also failed:', fallbackError);
          }
        }
      }
      
      // Manual retry function for requester field
      async retrySetRequester() {
        console.log('ðŸ”„ Manually retrying requester field setup...');
        await this.setCurrentUserAsRequester();
      }
      
      async setCurrentUserCompany(){
        const companyField = this.qs('companyName');
        const companyIdField = this.qs('companyId');
        
        if(!companyField) return;
        
        try {
          // Get company ID from AuthManager
          const companyId = window.authManager?.currentUser?.companyId;
          if(!companyId) {
            console.warn('Company ID not found for setting company field');
            companyField.value = 'No company context';
            return;
          }
          
          // Get company details from database
          const companySnap = await firebase.database().ref(`companies/${companyId}`).once('value');
          
          if(companySnap.exists()) {
            const companyData = companySnap.val();
            const companyName = companyData.companyName || 
                               companyData.name || 
                               companyData.displayName || 
                               'Current Company';
            
            companyField.value = companyName;
            if(companyIdField) {
              companyIdField.value = companyId;
            }
            
            console.log(`âœ… Set company to: ${companyName} (${companyId})`);
          } else {
            // Fallback if company not found in database
            companyField.value = 'Company not found';
            if(companyIdField) {
              companyIdField.value = companyId;
            }
            
            console.warn(`âš ï¸ Company data not found for ID: ${companyId}`);
          }
          
        } catch(error) {
          console.error('Error setting current user company:', error);
          companyField.value = 'Error loading company';
          
          // Try to get basic info from AuthManager as fallback
          try {
            const companyId = window.authManager?.currentUser?.companyId;
            const companyName = window.authManager?.currentUser?.companyName;
            if(companyName) {
              companyField.value = companyName;
              if(companyIdField) {
                companyIdField.value = companyId || '';
              }
              console.log(`ðŸ”„ Used AuthManager fallback: ${companyName}`);
            }
          } catch(fallbackError) {
            console.error('Company fallback also failed:', fallbackError);
          }
        }
      }
      
      // Manual retry function for company field
      async retrySetCompany() {
        console.log('ðŸ”„ Manually retrying company field setup...');
        await this.setCurrentUserCompany();
      }
      
      async setCurrentUserDepartment(){
        const departmentField = this.qs('department');
        const departmentIdField = this.qs('departmentId');
        
        if(!departmentField) return;
        
        try {
          // Get current user info from AuthManager
          const currentUser = window.authManager?.currentUser;
          if(!currentUser || !currentUser.uid) {
            console.warn('No authenticated user found for department setup');
            departmentField.value = 'Not authenticated';
            return;
          }
          
          const companyId = currentUser.companyId;
          if(!companyId) {
            console.warn('No company ID found for department setup');
            departmentField.value = 'No company context';
            return;
          }
          
          // First try company-scoped user data (where companymanagement.html stores user info)
          const companyUserSnap = await firebase.database().ref(`companies/${companyId}/users/${currentUser.uid}`).once('value');
          
          if(companyUserSnap.exists()) {
            const userData = companyUserSnap.val();
            console.log('ðŸ“‹ Company user data loaded:', userData);
            
            // Get department - could be stored as name or ID
            let departmentValue = userData.department || userData.departmentName;
            let departmentName = '';
            let departmentId = '';
            
            if(departmentValue) {
              // First, try to resolve department ID to name from field options
              try {
                const deptOptionsSnap = await firebase.database().ref(`companies/${companyId}/fieldOptions/department`).once('value');
                if(deptOptionsSnap.exists()) {
                  const deptOptions = deptOptionsSnap.val() || {};
                  
                  // Check if departmentValue is an ID that maps to a department option
                  if(deptOptions[departmentValue]) {
                    const deptData = deptOptions[departmentValue];
                    departmentName = deptData.label || deptData.name || deptData.value || departmentValue;
                    departmentId = departmentValue;
                    console.log(`âœ… Resolved department ID "${departmentValue}" to name "${departmentName}"`);
                  } else {
                    // Look for matching label in department options
                    const foundDept = Object.entries(deptOptions).find(([key, val]) => {
                      if (typeof val === 'object' && val.label) {
                        return val.label === departmentValue || val.name === departmentValue || val.value === departmentValue;
                      }
                      return val === departmentValue;
                    });
                    
                    if(foundDept) {
                      const [key, val] = foundDept;
                      departmentName = typeof val === 'object' ? (val.label || val.name || val.value) : val;
                      departmentId = key;
                      console.log(`âœ… Found department by name match: "${departmentName}" (${departmentId})`);
                    } else {
                      // Use the raw value as department name (exact value from user record)
                      departmentName = departmentValue;
                      departmentId = userData.departmentId || departmentValue;
                      console.log(`âœ… Using exact department name from user record: "${departmentName}"`);
                    }
                  }
                } else {
                  // No department options available, use exact value from user record
                  departmentName = departmentValue;
                  departmentId = userData.departmentId || departmentValue;
                  console.log(`âœ… No department options found, using exact value: "${departmentName}"`);
                }
              } catch(e) {
                console.warn('Error resolving department name:', e);
                departmentName = departmentValue;
                departmentId = userData.departmentId || departmentValue;
              }
              
              departmentField.value = departmentName;
              if(departmentIdField && departmentId) {
                departmentIdField.value = departmentId;
              }
              
              // Store in departmentOptions for reference number generation
              if(departmentId) {
                this.departmentOptions[departmentId] = departmentName;
              }
              
              console.log(`âœ… Set department from company users: ${departmentName}${departmentId ? ` (${departmentId})` : ''}`);
              return;
            }
          }
          
          // Fallback to global user data if company user data doesn't exist or has no department
          console.log('ðŸ”„ Trying global user data as fallback...');
          const globalUserSnap = await firebase.database().ref(`users/${currentUser.uid}`).once('value');
          
          if(globalUserSnap.exists()) {
            const userData = globalUserSnap.val();
            const userDepartmentId = userData.department || userData.departmentId;
            
            if(userDepartmentId) {
              // Try to get department name from company field options
              const deptSnap = await firebase.database().ref(`companies/${companyId}/fieldOptions/department/${userDepartmentId}`).once('value');
              
              if(deptSnap.exists()) {
                const deptData = deptSnap.val();
                const departmentName = deptData.label || deptData.name || deptData.value || userDepartmentId;
                
                departmentField.value = departmentName;
                if(departmentIdField) {
                  departmentIdField.value = userDepartmentId;
                }
                
                this.departmentOptions[userDepartmentId] = departmentName;
                console.log(`âœ… Set department from global user + field options: ${departmentName} (${userDepartmentId})`);
              } else {
                // Use department ID as display name
                departmentField.value = userDepartmentId;
                if(departmentIdField) {
                  departmentIdField.value = userDepartmentId;
                }
                this.departmentOptions[userDepartmentId] = userDepartmentId;
                console.warn(`âš ï¸ Department name not found in field options, using ID: ${userDepartmentId}`);
              }
            } else {
              departmentField.value = 'No department assigned';
              console.warn(`âš ï¸ User has no department assigned`);
            }
          } else {
            departmentField.value = 'User not found in database';
            console.warn(`âš ï¸ User data not found for: ${currentUser.uid}`);
          }
          
        } catch(error) {
          console.error('Error setting current user department:', error);
          departmentField.value = 'Error loading department';
        }
      }
      
      async setCurrentUserContactPhone(){
        const contactPhoneField = this.qs('contactPhone');
        
        if(!contactPhoneField) return;
        
        try {
          // Get current user info from AuthManager
          const currentUser = window.authManager?.currentUser;
          if(!currentUser || !currentUser.uid) {
            console.warn('No authenticated user found for contact phone setup');
            contactPhoneField.value = 'Not authenticated';
            return;
          }
          
          const companyId = currentUser.companyId;
          if(!companyId) {
            console.warn('No company ID found for contact phone setup');
            contactPhoneField.value = 'No company context';
            return;
          }
          
          // First try company-scoped user data (where companymanagement.html stores user info)
          const companyUserSnap = await firebase.database().ref(`companies/${companyId}/users/${currentUser.uid}`).once('value');
          
          if(companyUserSnap.exists()) {
            const userData = companyUserSnap.val();
            console.log('ðŸ“‹ Company user data loaded for contact phone:', userData);
            
            // Use phone from company user record
            const userPhone = userData.phone || userData.contactPhone || userData.phoneNumber;
            
            if(userPhone) {
              contactPhoneField.value = userPhone;
              console.log(`âœ… Set contact phone from company users: ${userPhone}`);
              return;
            }
          }
          
          // Fallback to global user data if company user data doesn't exist or has no phone
          console.log('ðŸ”„ Trying global user data for contact phone...');
          const globalUserSnap = await firebase.database().ref(`users/${currentUser.uid}`).once('value');
          
          if(globalUserSnap.exists()) {
            const userData = globalUserSnap.val();
            const userPhone = userData.phone || userData.contactPhone || userData.phoneNumber;
            
            if(userPhone) {
              contactPhoneField.value = userPhone;
              console.log(`âœ… Set contact phone from global users: ${userPhone}`);
            } else {
              contactPhoneField.value = '';
              console.warn(`âš ï¸ User has no contact phone assigned`);
            }
          } else {
            contactPhoneField.value = 'User not found in database';
            console.warn(`âš ï¸ User data not found for: ${currentUser.uid}`);
          }
          
        } catch(error) {
          console.error('Error setting current user contact phone:', error);
          contactPhoneField.value = 'Error loading contact phone';
        }
      }
      
      async setCurrentUserLineManager(){
        const lineManagerField = this.qs('lineManager');
        
        if(!lineManagerField) return;
        
        try {
          // Get current user info from AuthManager
          const currentUser = window.authManager?.currentUser;
          if(!currentUser || !currentUser.uid) {
            console.warn('No authenticated user found for line manager setup');
            lineManagerField.value = 'Not authenticated';
            return;
          }
          
          const companyId = currentUser.companyId;
          if(!companyId) {
            console.warn('No company ID found for line manager setup');
            lineManagerField.value = 'No company context';
            return;
          }
          
          // Get user data from company users directory (where companymanagement.html stores user info)
          const companyUserSnap = await firebase.database().ref(`companies/${companyId}/users/${currentUser.uid}`).once('value');
          
          if(companyUserSnap.exists()) {
            const userData = companyUserSnap.val();
            console.log('ðŸ“‹ Company user data loaded for line manager:', userData);
            
            // Get line manager name and job title from company user record
            let lineManagerName = userData.lineManager || userData.lineManagerName || '';
            let lineManagerJobTitle = '';
            
            // If we have lineManagerId but no name, resolve ID to name and get job title
            if ((!lineManagerName || /^(uid_|[A-Za-z0-9_-]{15,})$/.test(String(lineManagerName).trim())) && userData.lineManagerId) {
              const managerSnap = await firebase.database().ref(`companies/${companyId}/users/${userData.lineManagerId}`).once('value');
              if(managerSnap.exists()) {
                const managerData = managerSnap.val();
                lineManagerName = managerData.name || managerData.displayName || managerData.fullName || '';
                lineManagerJobTitle = managerData.jobTitle || managerData.role || '';
                console.log(`ðŸ”„ Resolved line manager ID to name: ${lineManagerName}, job title: ${lineManagerJobTitle}`);
              }
            } else if (userData.lineManagerId) {
              // If we have the name but need to get the job title from the line manager's user record
              const managerSnap = await firebase.database().ref(`companies/${companyId}/users/${userData.lineManagerId}`).once('value');
              if(managerSnap.exists()) {
                const managerData = managerSnap.val();
                lineManagerJobTitle = managerData.jobTitle || managerData.role || '';
                console.log(`ðŸ”„ Got line manager job title: ${lineManagerJobTitle}`);
              }
            }
            
            // Clean formatting like "Name (Dept - Title)"
            if (lineManagerName) {
              const nameOnly = lineManagerName.match(/^([^()\-]+?)(?:\s*\([^)]*\))?(?:\s*-\s*.*)?$/);
              lineManagerField.value = (nameOnly ? nameOnly[1] : lineManagerName).trim();
              console.log(`âœ… Set line manager: ${lineManagerField.value}`);
              
              // Store job title in a data attribute for later use in form submission
              if (lineManagerJobTitle) {
                lineManagerField.setAttribute('data-job-title', lineManagerJobTitle);
                console.log(`âœ… Set line manager job title: ${lineManagerJobTitle}`);
              }
            } else {
              lineManagerField.value = 'No line manager assigned';
              console.warn(`âš ï¸ User has no line manager assigned`);
            }
          } else {
            // Fallback to global user data
            console.log('ðŸ”„ Trying global user data for line manager...');
            const globalUserSnap = await firebase.database().ref(`users/${currentUser.uid}`).once('value');
            
            if(globalUserSnap.exists()) {
              const userData = globalUserSnap.val();
              const lineManagerName = userData.lineManager || userData.lineManagerName || '';
              
              if(lineManagerName) {
                lineManagerField.value = lineManagerName;
                console.log(`âœ… Set line manager from global users: ${lineManagerName}`);
              } else {
                lineManagerField.value = 'No line manager assigned';
                console.warn(`âš ï¸ User has no line manager in global record`);
              }
            } else {
              lineManagerField.value = 'User not found in database';
              console.warn(`âš ï¸ User data not found for: ${currentUser.uid}`);
            }
          }
          
        } catch(error) {
          console.error('Error setting current user line manager:', error);
          lineManagerField.value = 'Error loading line manager';
        }
      }
      
  async loadAccessRequestData(){
        const params=new URLSearchParams(location.search);
        const editId=params.get('id');
        if(!editId) return; // create mode

        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId){ console.error('Company ID not found for loading access request data'); return; }

        const refPath=`companies/${companyId}/access/${editId}`;
        const snap=await firebase.database().ref(refPath).once('value');
        if(!snap.exists()){ console.warn(`Access request not found at: ${refPath}`); return; }

        const data=snap.val();
        const form=this.qs('accessRequestForm');
        form.dataset.editId=editId;

  // Basic fields (include referenceNumber for edit)
  Object.entries({referenceNumber:'referenceNumber',purpose:'purpose',contactPhone:'contactPhone',propertyRemoval:'propertyRemoval',toBeReturned:'toBeReturned'}).forEach(([k,id])=>{ if(data[k] && this.qs(id)) this.qs(id).value=data[k]; });

        // Requester/company/department
        if(data.requesterName && this.qs('employeeId')) this.qs('employeeId').value=data.requesterName;
        if(data.employeeId && this.qs('employeeUserId')) this.qs('employeeUserId').value=data.employeeId;
        if(data.companyName && this.qs('companyName')) this.qs('companyName').value=data.companyName;
        if(data.companyId && this.qs('companyId')) this.qs('companyId').value=data.companyId;
        if(data.departmentName && this.qs('department')) this.qs('department').value=data.departmentName;
        if(data.department && this.qs('departmentId')) this.qs('departmentId').value=data.department;

        // Populate visitors (including existing attachment links)
        if(Array.isArray(data.visitors) && data.visitors.length){
          const container=document.getElementById('visitors-container');
          if(container){
            // Remove default extra rows except first
            const baseRow=container.querySelector('.visitor-row');
            // Fill first row
            const first=data.visitors[0];
            if(first){
              baseRow.querySelector('.visitor-select').value=first.name||'';
              baseRow.querySelector('.visitor-job').value=first.jobTitle||'';
              baseRow.querySelector('.visitor-id').value=first.identification||'';
              baseRow.querySelector('.visitor-company').value=first.company||'';
              baseRow.querySelector('.visitor-area').value=first.area||'';
              baseRow.querySelector('.visitor-start').value=first.startDateTime||'';
              baseRow.querySelector('.visitor-end').value=first.endDateTime||'';
              const fileInput0 = baseRow.querySelector('.visitor-attachment');
              if(first.attachments && Array.isArray(first.attachments) && first.attachments.length){
                this.insertExistingFileDisplay(fileInput0, first.attachments);
              } else if(first.attachment && first.attachment.url){
                this.insertExistingFileDisplay(fileInput0, first.attachment);
              }
            }
            // Remaining rows
            for(let i=1;i<data.visitors.length;i++){
              this.addVisitorRow();
              const row=container.querySelectorAll('.visitor-row')[i];
              const v=data.visitors[i];
              if(!row) continue;
              row.querySelector('.visitor-select').value=v.name||'';
              row.querySelector('.visitor-job').value=v.jobTitle||'';
              row.querySelector('.visitor-id').value=v.identification||'';
              row.querySelector('.visitor-company').value=v.company||'';
              row.querySelector('.visitor-area').value=v.area||'';
              row.querySelector('.visitor-start').value=v.startDateTime||'';
              row.querySelector('.visitor-end').value=v.endDateTime||'';
              const vInput = row.querySelector('.visitor-attachment');
              if(v.attachments && Array.isArray(v.attachments) && v.attachments.length){
                this.insertExistingFileDisplay(vInput, v.attachments);
              } else if(v.attachment && v.attachment.url){
                this.insertExistingFileDisplay(vInput, v.attachment);
              }
            }
          }
        }

        // Populate equipment
        if(Array.isArray(data.equipment) && data.equipment.length){
          const container=document.getElementById('equipment-container');
            if(container){
              const baseRow=container.querySelector('.equipment-row');
              const first=data.equipment[0];
              if(first){
                baseRow.querySelector('.equipment-name').value=first.name||'';
                // description field removed; skip assigning description
              }
              for(let i=1;i<data.equipment.length;i++){
                this.addEquipmentRow();
                const row=container.querySelectorAll('.equipment-row')[i];
                const eq=data.equipment[i];
                if(!row) continue;
                row.querySelector('.equipment-name').value=eq.name||'';
                // description field removed; skip assigning description
              }
            }
        }

        console.log(`âœ… Access request loaded: ${refPath}`);

        // Start real-time listener for attachments & nested arrays (visitors/equipment) in edit mode
        this.startRealtimeSync(editId, companyId);
      }
      startRealtimeSync(editId, companyId){
        if(!editId||!companyId) return;
        const path=`companies/${companyId}/access/${editId}`;
        if(this._rtListener){ this._rtListener.off && this._rtListener.off(); }
        firebase.database().ref(path).on('value', snap=>{
          if(!snap.exists()) return;
            const data=snap.val();
            // Only re-render attachment link sections to avoid overwriting user edits mid-form
            this.refreshAttachmentDisplays(data);
        });
      }
      refreshAttachmentDisplays(data){
        // Visitor attachments
        if(Array.isArray(data.visitors)){
          const visitorRows=[...document.querySelectorAll('.visitor-row')];
          data.visitors.forEach((v,i)=>{
            if(!v || !visitorRows[i]) return;
            const input=visitorRows[i].querySelector('.visitor-attachment');
            if(!input) return;
            if(Array.isArray(v.attachments) && v.attachments.length){
              this.insertExistingFilesDisplay(input, v.attachments);
            } else if(v.attachment && v.attachment.url){
              this.insertExistingFilesDisplay(input, v.attachment);
            }
          });
        }
      }
      insertExistingFileDisplay(inputEl, attachment){
        // Wrapper to keep backward compatibility when single object is passed
        this.insertExistingFilesDisplay(inputEl, attachment);
      }
      insertExistingFilesDisplay(inputEl, attachments){
        if(!inputEl) return;
        const parent = inputEl.parentElement;
        if(!parent) return;
        // Clear previous markers
        parent.querySelectorAll('.existing-file-link,.existing-files-wrap').forEach(el=>el.remove());
        // Normalize to list of attachments
        let list = [];
        if(Array.isArray(attachments)){
          list = attachments.filter(a=>a && a.url);
        } else if(attachments && attachments.url){
          list = [attachments];
        }
        if(list.length===0) return;
        const wrap = document.createElement('div');
        wrap.className = 'existing-files-wrap';
        wrap.style.marginTop = '4px';
        wrap.style.display = 'flex';
        wrap.style.flexDirection = 'column';
        wrap.style.gap = '4px';
        list.forEach((att, idx)=>{
          const row = document.createElement('div');
          row.className = 'existing-file-link';
          row.innerHTML = `<a href="${att.url}" target="_blank" style="font-size:.7rem;color:#1d6fd8;text-decoration:none;">Existing${list.length>1? ` #${idx+1}`:''}: ${att.name||'file'}</a>`;
          wrap.appendChild(row);
        });
        parent.appendChild(wrap);
      }
      // Show a live preview of files selected (not yet uploaded) below the input
      setupAttachmentPreview(inputEl){
        if(!inputEl || inputEl.dataset.previewBound==='1') return;
        inputEl.dataset.previewBound = '1';
        inputEl.addEventListener('change', ()=>{
          const parent = inputEl.parentElement;
          if(!parent) return;
          // Remove previous selected files preview
          const prev = parent.querySelector('.selected-files-wrap');
          if(prev) prev.remove();
          const files = Array.from(inputEl.files || []);
          if(files.length===0) return;
          const wrap = document.createElement('div');
          wrap.className = 'selected-files-wrap';
          wrap.style.marginTop = '6px';
          wrap.style.borderTop = '1px dashed #e2e8f0';
          wrap.style.paddingTop = '6px';
          wrap.style.display = 'flex';
          wrap.style.flexDirection = 'column';
          wrap.style.gap = '4px';
          const title = document.createElement('div');
          title.textContent = 'Selected files';
          title.style.fontSize = '.7rem';
          title.style.color = '#555';
          title.style.fontWeight = '600';
          wrap.appendChild(title);
          files.forEach(f=>{
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.alignItems = 'center';
            row.style.justifyContent = 'space-between';
            row.style.gap = '8px';
            const name = document.createElement('span');
            name.textContent = f.name;
            name.style.fontSize = '.72rem';
            name.style.color = '#1d6fd8';
            name.style.whiteSpace = 'nowrap';
            name.style.overflow = 'hidden';
            name.style.textOverflow = 'ellipsis';
            const size = document.createElement('span');
            size.textContent = this.formatFileSize(f.size);
            size.style.fontSize = '.68rem';
            size.style.color = '#666';
            row.appendChild(name);
            row.appendChild(size);
            wrap.appendChild(row);
          });
          parent.appendChild(wrap);
        });
      }
      formatFileSize(bytes){ if(!bytes && bytes!==0) return ''; const sizes=['B','KB','MB','GB']; let i=0; let val=bytes; while(val>=1024 && i<sizes.length-1){ val/=1024; i++; } return `${val.toFixed( (i===0)?0:1 )} ${sizes[i]}`; }
      
      loadVisitorAreaDropdown(select) {
        if (!select) return;
        
        select.innerHTML='<option value="">Select Area/Location</option>';
        
        // Get company ID from AuthManager
        const companyId = window.authManager?.currentUser?.companyId;
        if(!companyId) {
          select.innerHTML+='<option value="">No company context</option>';
          return;
        }
        
        // Load work areas from company field configuration (same as main area field)
        firebase.database().ref(`companies/${companyId}/fieldOptions/area`).once('value').then(snap => {
          if(!snap.exists()) {
            select.innerHTML+='<option value="">No work areas configured</option>';
            return;
          }
          
          const areasData = snap.val();
          
          if (Array.isArray(areasData)) {
            areasData.forEach((area, index) => {
              if (area && area.enabled !== false) {
                const option = document.createElement('option');
                option.value = area.value || area.label || `area-${index}`;
                option.textContent = area.label || area.value || `Area ${index + 1}`;
                select.appendChild(option);
              }
            });
          } else if (typeof areasData === 'object') {
            Object.entries(areasData).forEach(([key, area]) => {
              if (area && area.enabled !== false) {
                const option = document.createElement('option');
                option.value = area.value || key;
                option.textContent = area.label || area.value || key;
                select.appendChild(option);
              }
            });
          }
        }).catch(error => {
          console.error('Error loading visitor area options:', error);
          select.innerHTML+='<option value="">Error loading areas</option>';
        });
      }
      
      setupVisitorDateValidation(wrap, idx) {
        const startField = wrap.querySelector(`#visitor-start-${idx}`);
        const endField = wrap.querySelector(`#visitor-end-${idx}`);
        
        if (!startField || !endField) return;
        
        // Set minimum date to today
        const today = new Date().toISOString().slice(0, 16);
        startField.setAttribute('min', today);
        endField.setAttribute('min', today);
        
        // Update end field minimum when start field changes
        startField.addEventListener('change', () => {
          endField.min = startField.value;
          // Validate if end is before start
          if (endField.value && startField.value && endField.value <= startField.value) {
            endField.setCustomValidity('End date/time must be after start date/time');
          } else {
            endField.setCustomValidity('');
          }
        });
        
        // Validate when end field changes
        endField.addEventListener('change', () => {
          if (endField.value && startField.value && endField.value <= startField.value) {
            endField.setCustomValidity('End date/time must be after start date/time');
          } else {
            endField.setCustomValidity('');
          }
        });
      }
  addVisitorRow(){
    const container=document.getElementById('visitors-container'); if(!container) return;
    const idx=++this.visitorCount;
    const wrap=document.createElement('div');
    wrap.className='visitor-row';
    wrap.innerHTML=`<div class="form-row"><div class="form-group"><label for="visitor-${idx}">Visitor</label><input type="text" id="visitor-${idx}" name="visitors[]" class="visitor-select" placeholder="Enter visitor name"></div><div class="form-group"><label for="visitor-job-${idx}">Job Title</label><input type="text" id="visitor-job-${idx}" name="visitor-jobs[]" class="visitor-job" placeholder="Enter job title"></div><div class="form-group"><label for="visitor-id-${idx}">ID/Passport Number</label><input type="text" id="visitor-id-${idx}" name="visitor-ids[]" class="visitor-id" placeholder="Enter ID or passport number"></div></div><div class="form-row"><div class="form-group"><label for="visitor-company-${idx}">Company</label><input type="text" id="visitor-company-${idx}" name="visitor-companies[]" class="visitor-company" placeholder="Enter company name"></div><div class="form-group"><label for="visitor-area-${idx}">Area/Location*</label><select id="visitor-area-${idx}" name="visitor-areas[]" class="visitor-area" required><option value="">Select Area/Location</option></select></div></div><div class="form-row"><div class="form-group"><label for="visitor-start-${idx}">Start Date & Time*</label><input type="datetime-local" id="visitor-start-${idx}" name="visitor-starts[]" class="visitor-start" required></div><div class="form-group"><label for="visitor-end-${idx}">End Date & Time*</label><input type="datetime-local" id="visitor-end-${idx}" name="visitor-ends[]" class="visitor-end" required></div><div class="form-group"><label for="visitor-attachment-${idx}">Attachments</label><input type="file" id="visitor-attachment-${idx}" name="visitor-attachments[]" class="visitor-attachment" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple><small class="help-text">Upload one or more documents for this visitor</small></div></div><div class="form-row"><div class="form-group"><button type="button" class="btn btn-remove" data-remove-visitor><i class="fas fa-minus"></i></button></div></div>`;
    container.insertBefore(wrap, container.querySelector('.visitor-controls'));
    this.loadVisitorAreaDropdown(wrap.querySelector('.visitor-area'));
    this.setupVisitorDateValidation(wrap, idx);
    const inputEl = wrap.querySelector('.visitor-attachment');
    if(inputEl){ this.setupAttachmentPreview(inputEl); }
    wrap.querySelector('[data-remove-visitor]').onclick=()=>wrap.remove();
  }
  addEquipmentRow(){ const container=document.getElementById('equipment-container'); if(!container) return; const idx=++this.equipmentCount; const wrap=document.createElement('div'); wrap.className='equipment-row'; wrap.innerHTML=`<div class="form-row"><div class="form-group"><label for="equipment-name-${idx}">Equipment/Tool Name*</label><input type="text" id="equipment-name-${idx}" name="equipment-names[]" class="equipment-name" required></div><div class="form-group"><button type="button" class="btn btn-remove" data-remove-equipment><i class="fas fa-minus"></i></button></div></div>`; container.insertBefore(wrap, container.querySelector('.equipment-controls')); wrap.querySelector('[data-remove-equipment]').onclick=()=>wrap.remove(); }
      async submitAccessRequest(form){
        try{
          const editId=form.dataset.editId;
          const currentUser=firebase.auth().currentUser;
          if(!currentUser) throw new Error('Not authenticated');
          const companyId=window.authManager?.currentUser?.companyId;
          if(!companyId) throw new Error('Company ID not found. Please ensure you are properly authenticated.');

          const accessId = editId || Date.now().toString();
          const basePath = `companies/${companyId}/access/${accessId}`;
          const refPath = basePath; // db path

          // If editing, pull existing to preserve attachments not replaced
            let existingData={};
            if(editId){
              const existingSnap=await firebase.database().ref(refPath).once('value');
              if(existingSnap.exists()) existingData=existingSnap.val();
            }

          // Build visitors with (possible) attachments
          const visitorRows=[...document.querySelectorAll('.visitor-row')];
          const visitors=[];
          for(let i=0;i<visitorRows.length;i++){
            const r=visitorRows[i];
            const fileInput=r.querySelector('.visitor-attachment');
            const existingVisitor = existingData.visitors && existingData.visitors[i] ? existingData.visitors[i] : {};
            let attachments = [];
            if (Array.isArray(existingVisitor.attachments)) {
              attachments = [...existingVisitor.attachments];
            } else if (existingVisitor.attachment && existingVisitor.attachment.url) {
              attachments = [existingVisitor.attachment];
            }
            if(fileInput && fileInput.files && fileInput.files.length){
              for(let fIdx=0; fIdx<fileInput.files.length; fIdx++){
                const file=fileInput.files[fIdx];
                const storageRef=firebase.storage().ref().child(`${basePath}/visitors/${i}-${Date.now()}-${file.name}`);
                await storageRef.put(file);
                const url=await storageRef.getDownloadURL();
                attachments.push({ name:file.name,size:file.size,type:file.type,url, path:storageRef.fullPath, uploadedAt:new Date().toISOString() });
              }
            }
            const attachmentMeta = attachments.length ? attachments[0] : null;
            visitors.push({
              name:r.querySelector('.visitor-select')?.value||'',
              jobTitle:r.querySelector('.visitor-job')?.value||'',
              identification:r.querySelector('.visitor-id')?.value||'',
              company:r.querySelector('.visitor-company')?.value||'',
              area:r.querySelector('.visitor-area')?.value||'',
              startDateTime:r.querySelector('.visitor-start')?.value||'',
              endDateTime:r.querySelector('.visitor-end')?.value||'',
              attachment:attachmentMeta,
              attachments:attachments
            });
          }

          // Build equipment 
          const equipmentRows=[...document.querySelectorAll('.equipment-row')];
          const equipment=[];
          for(let i=0;i<equipmentRows.length;i++){
            const r=equipmentRows[i];
            equipment.push({
              name:r.querySelector('.equipment-name')?.value||'',
              // description removed
            });
          }

          // Payload
          const now=new Date().toISOString();
          
          // Ensure requester name is the current logged-in user's name
          let requesterName = this.val('employeeId');
          if(!requesterName || requesterName === 'Not authenticated' || requesterName === 'Error loading user' || requesterName === 'Current User') {
            // Get name from AuthManager first
            requesterName = window.authManager?.getUserDisplayName?.() || '';
            if(!requesterName || requesterName === 'User') {
              // Try from authManager currentUser
              const authUser = window.authManager?.currentUser;
              if(authUser) {
                requesterName = authUser.name || authUser.displayName || `${authUser.firstName || ''} ${authUser.lastName || ''}`.trim() || authUser.email || 'Current User';
              } else {
                requesterName = currentUser.displayName || currentUser.email || 'Current User';
              }
            }
          }
          
          
          // Get actual employee ID from company users record for storage
          let actualEmployeeId = this.val('employeeUserId') || currentUser.uid;
          try {
            const companyId = window.authManager?.currentUser?.companyId;
            if (companyId) {
              const companyUserSnap = await firebase.database().ref(`companies/${companyId}/users/${currentUser.uid}`).once('value');
              if (companyUserSnap.exists()) {
                const userData = companyUserSnap.val();
                const employeeIdFromCompany = userData.employeeId || userData.employeeCode || userData.empCode;
                if (employeeIdFromCompany) {
                  actualEmployeeId = employeeIdFromCompany;
                  console.log(`âœ… Using employee ID from company record: ${actualEmployeeId}`);
                } else {
                  console.warn(`âš ï¸ No employee ID found in company record for ${currentUser.uid}, using UID`);
                }
              }
            }
          } catch (e) {
            console.warn('Failed to get employee ID from company record:', e);
          }
          
          const payload={
            referenceNumber:this.val('referenceNumber'),
            purpose:this.val('purpose'),
            propertyRemoval:this.val('propertyRemoval'),
            toBeReturned:this.val('toBeReturned'),
            department:this.val('departmentId')||this.val('department'),
            departmentName:this.val('department'),
            employeeId: actualEmployeeId,
            requesterName: requesterName,
            requesterLineManager: this.val('lineManager'),
            requesterLineManagerTitle: this.qs('lineManager')?.getAttribute('data-job-title') || '',
            submittedBy: currentUser.uid,
            submittedByName: requesterName,
            companyName:this.val('companyName'),
            companyId:this.val('companyId')||companyId,
            contactPhone:this.val('contactPhone'),
            visitors,
            equipment,
            status: editId? 'updated':'submitted',
            createdAt: existingData.createdAt || now,
            updatedAt: now,
            userId: existingData.userId || currentUser.uid,
            companyId: companyId
          };

          await firebase.database().ref(refPath).set(payload);
          console.log(`âœ… Gate pass request saved (with attachments) to: ${refPath}`);
          // Notify submitter in Firebase so bell count matches staff.html
          try{
            await window.notificationManager?.createNotification(currentUser.uid, {
              title: 'Gate Pass Submitted',
              message: `Your gate pass request ${payload.referenceNumber} was submitted.`,
              type: 'info',
              relatedData: { requestId: accessId, referenceNumber: payload.referenceNumber },
              link: `access.html?id=${accessId}`
            });
          }catch(_e){}
          
          // Send submitter notification
          this.emailService.createSubmitterNotification(payload, accessId);
          
          // Send approval notifications to first-level approvers (only for new submissions, not edits)
          if (!editId) {
            console.log('ðŸ”„ Sending approval notifications...');
            try {
              // Add the request ID to payload for email service
              payload.id = accessId;
              
              const emailResult = await this.emailService.sendApprovalNotificationEmails(payload, accessId, false);
              if (emailResult.success) {
                console.log(`âœ… Sent approval emails to ${emailResult.emailsSent} approver(s)`);
                await window.notificationManager?.createNotification(currentUser.uid, {
                  title: 'Approval Emails Sent',
                  message: `Approval notifications sent to ${emailResult.emailsSent} approver(s).`,
                  type: 'info',
                  relatedData: { requestId: accessId }
                });
              } else {
                console.warn('âš ï¸ Failed to send some approval emails:', emailResult.error);
                await window.notificationManager?.createNotification(currentUser.uid, {
                  title: 'Approval Emails Warning',
                  message: 'Request saved but some approval notifications may not have been sent.',
                  type: 'warning',
                  relatedData: { requestId: accessId }
                });
              }
            } catch (emailError) {
              console.error('âŒ Error sending approval notifications:', emailError);
              await window.notificationManager?.createNotification(currentUser.uid, {
                title: 'Approval Emails Failed',
                message: 'Request saved but approval notifications failed to send.',
                type: 'warning',
                relatedData: { requestId: accessId }
              });
            }
          }
          
          setTimeout(()=>location.href='accessboard.html',1200); // Slightly longer delay for email processing
        }catch(e){
          console.error('Submit error',e);
          window.notificationManager?.addNotification({type:'Error',message:e.message||'Submission failed'});
        }
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{ 
      console.log('ðŸš€ DOM loaded, initializing AccessManager...');
      window.accessManager=new AccessManager(); 
      
      // Schedule menu visibility update after initialization
      setTimeout(async () => {
        console.log('ðŸ”„ Initializing feature-based menu visibility system...');
        try {
          if (window.authManager && window.authManager.currentUser) {
            await window.authManager.updateMenuVisibility();
          } else {
            console.warn('âš ï¸ AuthManager not ready, scheduling retry...');
            setTimeout(async () => {
              if (window.authManager && window.authManager.currentUser) {
                await window.authManager.updateMenuVisibility();
              } else {
                console.warn('âš ï¸ AuthManager still not ready, using fallback');
                showBasicMenu();
              }
            }, 1000);
          }
        } catch (error) {
          console.error('âŒ Error updating menu visibility:', error);
          showBasicMenu();
        }
      }, 500);
      
            // Make feature-based menu update available globally
      window.updateMenuWithFeatureAuthorization = async function() {
        console.log('ðŸŽ¯ Global feature-based menu authorization for access.html...');
        try {
          if (window.authManager && window.authManager.currentUser && window.authManager.currentUser.companyId) {
            await window.authManager.updateMenuVisibility();
          } else {
            console.warn('âš ï¸ AuthManager or company ID not available');
            showBasicMenu();
          }
        } catch (error) {
          console.error('âŒ Error in global feature-based menu authorization:', error);
          showBasicMenu();
        }
      };
      
      // Emergency fallback - show ONLY home
            function showBasicMenu() {
                console.log('ðŸ”§ Fallback: showing only home_view');
                document.querySelectorAll('[data-feature]').forEach(el => el.classList.remove('menu-visible'));
                const homeItem = document.querySelector('[data-feature="home_view"]');
                if (homeItem) {
                    homeItem.classList.add('menu-visible');
                    console.log('âœ… Home visible (fallback)');
                }
            }
      
      // Make showBasicMenu available globally
      window.showBasicMenu = showBasicMenu;
      
            // Minimal debug helper - optional force show specific features (default: home only)
            window.forceShowTargetMenus = function(features = ['home_view']) {
                console.log('ðŸ§ª forceShowTargetMenus ->', features);
                document.querySelectorAll('[data-feature]').forEach(el => el.classList.remove('menu-visible'));
                features.forEach(f => {
                    const el = document.querySelector(`[data-feature="${f}"]`);
                    if (el) {
                        el.classList.add('menu-visible');
                        console.log('âœ… Forced:', f);
                    } else {
                        console.log('âŒ Not found:', f);
                    }
                });
                // Show parent dropdowns if a child is forced
                document.querySelectorAll('.menu-dropdown').forEach(dd => {
                    if (dd.querySelector('.submenu li.menu-visible')) dd.classList.add('menu-visible');
                });
                const sidebar = document.querySelector('.sidebar');
                sidebar?.classList.remove('menu-loading');
            };
      
      // Auto-run removed to allow dynamic permission system to work properly
      // Call window.forceShowTargetMenus() manually in console if needed for testing
      
      // Debug function to check current auth state
      window.debugAuthState = function() {
        console.log('ðŸ” DEBUG: Current Auth State');
        console.log('AuthManager exists:', !!window.authManager);
        console.log('Current user:', window.authManager?.currentUser);
        console.log('Current company:', window.authManager?.currentCompany);
        
        if (window.authManager?.currentUser) {
          const { companyId, role } = window.authManager.currentUser;
          if (companyId && role) {
            const path = `companies/${companyId}/roles/${role}/permissions`;
            console.log('Checking permissions at:', path);
            firebase.database().ref(path).once('value').then(snap => {
              if (snap.exists()) {
                console.log('âœ… Current permissions:', snap.val());
              } else {
                console.log('âŒ No permissions found at path');
              }
            });
          }
        }
      };
      
      // Auto-run debug removed to prevent interference with dynamic permissions
      // Call window.debugAuthState() manually in console if needed for debugging
      // Call window.accessManager.retrySetRequester() if requester field shows "Not authenticated"
      // Call window.accessManager.retrySetCompany() if company field shows error
      
      // Restored permission-based menu visibility system
    });
    </script>
    <!-- Removed old inline module loader (replaced by above) -->
</body>
</html>