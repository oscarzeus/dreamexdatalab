<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DMS Editor - Dreamex Datalab HSE</title>

  <!-- External deps (match versions used across staff/recruitboard) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>

  <style>
    :root {
      /* Core palette and layout (aligned with accessdaily.html) */
      --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db;
      --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px;
      --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: var(--font-family); font-size: var(--base-font-size); background: var(--bg-color); color: var(--text-color); }
    .app-container { display: flex; min-height: 100vh; }
    /* Sidebar + Menu (match accessdaily visual + behavior) */
    .sidebar { width: var(--sidebar-width); background: var(--primary-color); color: #fff; padding: 1rem; position: fixed; height: 100vh; overflow-y: auto; transition: transform .3s ease; }
    .sidebar.collapsed { transform: translateX(-100%); }
    .logo h2 { margin: 0; padding: 1rem 0; text-align: center; border-bottom: 1px solid rgba(255,255,255,.1); font-size: 1.05rem; }
    .menu { list-style: none; margin-top: 1.5rem; padding: 0; }
    .menu li { margin-bottom: .45rem; }
    .menu a { color: #fff; text-decoration: none; display: flex; align-items: center; padding: .65rem .9rem; border-radius: 6px; font-size: .78rem; gap: .55rem; letter-spacing: .25px; transition: background .25s; }
    .menu a:hover, .menu a.active { background: var(--secondary-color); }
    .menu-dropdown .submenu { display: none; list-style: none; margin-left: 1.2rem; margin-top: .35rem; }
    .menu-dropdown:hover .submenu { display: block; }

    /* Feature-gated visibility (accessdaily pattern) */
    [data-feature]:not(.menu-visible) { display: none !important; }
    .menu-dropdown:not(.menu-visible) { display: none !important; }
    /* Hide ALL menu items during loading */
    .sidebar.menu-loading .menu-item,
    .sidebar.menu-loading .menu-dropdown,
    .sidebar.menu-loading li[data-feature],
    .sidebar.menu-loading [data-feature] { display: none !important; }

    .main-content { flex: 1; margin-left: var(--sidebar-width); padding: .5rem; transition: margin-left 0.3s ease; }
    .main-content.sidebar-collapsed { margin-left: 0; }
  .top-nav { position: sticky; top: .25rem; z-index: 10; display: flex; align-items: center; justify-content: space-between; background: #fff; padding: .5rem .75rem; border-radius: 0; box-shadow: 0 2px 6px rgba(0,0,0,.08); margin: .25rem .25rem .5rem; }
    .top-nav-left { display: flex; align-items: center; gap: .75rem; }
    .sidebar-toggle-btn { background: none; border: none; cursor: pointer; color: var(--text-color); font-size: 1.2rem; padding: .5rem; border-radius: 5px; transition: background-color 0.3s ease; }
    .sidebar-toggle-btn:hover { background-color: rgba(0, 0, 0, 0.1); }
  /* Match dmstable.html: logo not forced square, no border, no background */
  .header-company-logo { height:35px; width:auto; max-width:140px; border-radius:4px; object-fit:contain; display:none; background:transparent; border:none; box-shadow:none; }
  .header-company-logo.visible { display: block; }
  .header-logo-placeholder { width:44px; height:44px; border-radius:6px; background:#f8f9fa; border:2px dashed #ced4da; display:flex; align-items:center; justify-content:center; color:#6c757d; }
    .company-name-header { font-weight: 600; color: #2c3e50; font-size: 1rem; }
    .top-nav-right { display: flex; align-items: center; gap: 1rem; }
  /* User profile dropdown — align with project-list.html */
  .user-profile { position: relative; }
  .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; padding:0; }
  .profile-btn img { width:100%; height:100%; object-fit:cover; display:none; }
  .avatar-initials { width:38px; height:38px; border-radius:50%; background:#3498db; color:#fff; display:none; align-items:center; justify-content:center; font-weight:600; font-size:.85rem; box-shadow:0 0 0 2px #fff, 0 1px 3px rgba(0,0,0,.15); }
  .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); border:1px solid #e9ecef; overflow:hidden; z-index:1000; }
  .profile-dropdown.show { display:block; }
  .profile-dropdown ul { list-style:none; margin:0; padding:0; }
  .profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
  .profile-dropdown li a:hover { background:#f1f5f9; }

    /* Notifications */
    .notifications { position: relative; }
    .notification-btn { background: none; border: 0; cursor: pointer; position: relative; padding: .4rem; font-size: 1.1rem; }
    .notification-badge { position: absolute; top: -6px; right: -6px; background: var(--accent-color); color: #fff; border-radius: 999px; padding: 0 .4rem; font-size: .7rem; display: none; }
    .notification-dropdown { display: none; position: absolute; top: calc(100% + 6px); right: 0; width: 320px; background: #fff; border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,.12); max-height: 420px; overflow: hidden; }
    .notification-dropdown.show { display: block; }
    .notification-header { display: flex; align-items: center; justify-content: space-between; padding: .6rem .75rem; border-bottom: 1px solid #e9ecef; }
    .notification-list { max-height: 340px; overflow-y: auto; }
    .notification-item { padding: .65rem .75rem; border-bottom: 1px solid #f1f3f5; }
    .notification-item.unread { background: #e8f4fd; border-left: 3px solid #3498db; }

    .content { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.08); padding: .75rem; }

  /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid #e9ecef; }
    .tab-btn { background: none; border: none; padding: .6rem .9rem; cursor: pointer; font-weight: 600; color: #64748b; }
    .tab-btn.active { color: #1e293b; border-bottom: 2px solid var(--secondary-color); }
    .tab-panel { display: none; padding: .75rem; }
    .tab-panel.active { display: block; }

    textarea#dmsEditor { width: 100%; min-height: 50vh; padding: .75rem; border: 1px solid #e1e5ea; border-radius: 8px; font: 14px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  .preview-area, .flowchart-area { min-height: 50vh; border: 1px dashed #e1e5ea; border-radius: 8px; padding: .75rem; background: #fafbfc; }
  .editor-grid { display: grid; grid-template-columns: 1fr; gap: .75rem; }
  .field { display: flex; flex-direction: column; gap: .3rem; }
  .field label { font-weight: 600; font-size: .9rem; color: #374151; }
  .field input[type="text"],
  .field input[type="date"],
  .field select,
  .field textarea { padding: .55rem .65rem; border: 1px solid #e1e5ea; border-radius: 8px; width: 100%; }
  .muted { color: #6b7280; font-size: .85rem; }
  .row { display:flex; gap:.75rem; flex-wrap:wrap; }
  .row .col { flex:1 1 240px; }
  .steps { border: 1px solid #e5e7eb; border-radius: 8px; padding: .5rem; }
  .step { display:flex; gap:.5rem; align-items:center; margin:.4rem 0; }
  .step input { flex:1; }
  .btn { background:#3498db; color:#fff; border:0; padding:.45rem .7rem; border-radius:6px; cursor:pointer; }
  .btn.secondary { background:#6b7280; }
  .btn.ghost { background:transparent; border:1px solid #d1d5db; color:#374151; }
  .toolbar { display:flex; gap:.5rem; justify-content:flex-end; margin:.5rem 0; }

    @media (max-width: 768px) {
      .sidebar { position: static; width: 100%; height: auto; }
      .main-content { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <nav class="sidebar menu-loading">
      <div class="logo"><h2>Dreamex Datalab</h2></div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
        <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
        <!-- Risk Management (separate section) -->
        <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
          <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
          <ul class="submenu">
            <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
          </ul>
        </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
            <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
            <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li></ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
          <ul class="submenu">
            <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
            <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
          </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                        <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                        <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                        <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
    </nav>

    <main class="main-content">
      <header class="top-nav">
        <div class="top-nav-left">
          <button id="sidebarToggle" class="sidebar-toggle-btn">
            <i class="fas fa-bars"></i>
          </button>
          <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo" />
          <div id="headerLogoPlaceholder" class="header-logo-placeholder"><i class="fas fa-building"></i></div>
          <span id="headerCompanyName" class="company-name-header"></span>
        </div>
        <div class="top-nav-right">
          <div class="lang-switcher" style="margin-right:.5rem;">
            <select id="langSelect" title="Language" style="padding:.25rem .5rem; border:1px solid #e5e7eb; border-radius:6px;">
              <option value="en">English</option>
              <option value="fr">Français</option>
            </select>
          </div>
          <div class="notifications">
            <button id="notificationBtn" class="notification-btn" title="Notifications">
              <i class="fas fa-bell"></i>
              <span class="notification-badge">0</span>
            </button>
            <div class="notification-dropdown" id="notificationDropdown">
              <div class="notification-header">
                <h3 style="margin:0;font-size:.95rem;">Notifications</h3>
                <button id="markAllReadBtn" class="btn-link" style="background:none;border:0;color:#3498db;cursor:pointer;font-size:.85rem;">Mark all as read</button>
              </div>
              <div class="notification-list" id="notificationList"></div>
            </div>
          </div>
          <div class="user-profile">
            <button id="userProfileBtn" class="profile-btn">
              <img id="userAvatar" alt="User Avatar" />
              <div id="userInitials" class="avatar-initials">U</div>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
              <ul>
                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                <li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <div class="content">
        <div class="tabs" role="tablist">
          <button class="tab-btn active" data-tab="editor" data-i18n="tab.editor">Editor</button>
          <button class="tab-btn" data-tab="preview" data-i18n="tab.preview">Preview</button>
          <button class="tab-btn" data-tab="flowchart" data-i18n="tab.flowchart">Flowchart</button>
        </div>

        <section id="tab-editor" class="tab-panel active" role="tabpanel" aria-labelledby="tab-editor">
          <div class="editor-grid">
            <div class="row">
              <div class="col field">
                <label for="docTitle" data-i18n="label.title">Title</label>
                <input id="docTitle" type="text" placeholder="e.g., Incident Reporting Procedure" data-i18n-placeholder="ph.docTitle" />
              </div>
              <div class="col field">
                <label for="docType" data-i18n="label.type">Type</label>
                <select id="docType">
                  <option value="procedure" data-i18n="option.type.procedure">Procedure</option>
                  <option value="policy" data-i18n="option.type.policy">Policy</option>
                  <option value="work_instruction" data-i18n="option.type.work_instruction">Work Instruction</option>
                  <option value="form" data-i18n="option.type.form">Form</option>
                  <option value="guideline" data-i18n="option.type.guideline">Guideline</option>
                  <option value="standard" data-i18n="option.type.standard">Standard</option>
                  <option value="manual" data-i18n="option.type.manual">Manual</option>
                  <option value="checklist" data-i18n="option.type.checklist">Checklist</option>
                </select>
              </div>
              <div class="col field">
                <label for="docCategory" data-i18n="label.department">Department</label>
                <input id="docCategory" type="text" placeholder="Department" data-i18n-placeholder="ph.department" readonly />
                <div class="muted">Derived from your profile</div>
              </div>
            </div>
            <div class="row">
              <div class="col field">
                <label for="docNumber" data-i18n="label.docNumber">Document Number</label>
                <input id="docNumber" type="text" placeholder="e.g., HSE-PROC-001" data-i18n-placeholder="ph.docNumber" readonly />
                <div class="muted">Auto-generated: Company-Dept-Type-Number</div>
              </div>
              <div class="col field">
                <label for="docEffectiveDate" data-i18n="label.effectiveDate">Effective Date</label>
                <input id="docEffectiveDate" type="date" />
              </div>
              <div class="col field">
                <label for="docExpiryDate" data-i18n="label.nextReviewDate">Next Review Date</label>
                <input id="docExpiryDate" type="date" />
              </div>
            </div>
            <!-- Reordered: Classification before Purpose & Scope -->
            <div class="row">
              <div class="col field">
                <label for="docClassification" data-i18n="label.classification">Classification</label>
                <select id="docClassification">
                  <option value="public" data-i18n="option.classification.public">Public</option>
                  <option value="internal" data-i18n="option.classification.internal">Internal</option>
                  <option value="confidential" data-i18n="option.classification.confidential">Confidential</option>
                  <option value="restricted" data-i18n="option.classification.restricted">Restricted</option>
                </select>
              </div>
            </div>
            <!-- Split Purpose and Scope into separate full-width rows (after effective info) -->
            <div class="row">
              <div class="col field">
                <label for="docOwner" data-i18n="label.initiator">Initiator</label>
                <input id="docOwner" type="text" placeholder="Initiator (auto)" data-i18n-placeholder="ph.initiator" readonly />
                <div class="muted">Auto-filled from your profile</div>
              </div>
            </div>
            <div class="row">
              <div class="col field" style="flex:1 1 100%">
                <label for="docPurpose" data-i18n="label.purpose">Purpose</label>
                <textarea id="docPurpose" rows="3" placeholder="Define the objective and rationale for this document" data-i18n-placeholder="ph.purpose"></textarea>
              </div>
            </div>
            <div class="row">
              <div class="col field" style="flex:1 1 100%">
                <label for="docScope" data-i18n="label.scope">Scope</label>
                <textarea id="docScope" rows="3" placeholder="Define what is covered and what is excluded" data-i18n-placeholder="ph.scope"></textarea>
              </div>
            </div>
            <div class="field">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:.75rem;">
                <label data-i18n="section.definitions">Definitions</label>
                <button id="addDefBtn" class="btn ghost" type="button"><i class="fas fa-plus"></i> <span data-i18n="btn.addDefinition">Add Definition</span></button>
              </div>
              <div id="definitionsContainer"></div>
            </div>
            <div class="field">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:.75rem;">
                <label data-i18n="section.roles">Roles & Responsibilities</label>
                <button id="addRoleBtn" class="btn ghost" type="button"><i class="fas fa-plus"></i> <span data-i18n="btn.addRole">Add Role</span></button>
              </div>
              <div id="rolesContainer"></div>
            </div>
            
            <div class="row">
              <div class="col field" style="flex:1 1 100%">
                <label for="docDistribution" data-i18n="label.distribution">Distribution List</label>
                <textarea id="docDistribution" rows="3" placeholder="Specify roles, departments, or individuals who should receive this document" data-i18n-placeholder="ph.distribution"></textarea>
              </div>
            </div>
            <div class="row">
              <div class="col field" style="flex:1 1 100%">
                <label for="docRisk" data-i18n="label.risk">Risk Assessment</label>
                <textarea id="docRisk" rows="3" placeholder="Describe potential risks and impacts if this document is not followed" data-i18n-placeholder="ph.risk"></textarea>
                <div class="muted">Provide a brief assessment of risks related to this document</div>
              </div>
            </div>
            <div class="row">
              <div class="col field" style="flex:1 1 100%">
                <label for="docRevision" data-i18n="label.revision">Revision History</label>
                <textarea id="docRevision" rows="3" placeholder="Summary of changes in this version" data-i18n-placeholder="ph.revision" readonly></textarea>
                <div class="muted">Automatically managed by system</div>
              </div>
            </div>
            
            <div class="field">
              <label data-i18n="section.operatingProcedure">Operating procedure</label>
              <div id="proceduresContainer"></div>
              <div><button id="addProcedureBtn" class="btn ghost" type="button"><i class="fas fa-plus"></i> <span data-i18n="btn.addProcedure">Add Operating procedure</span></button></div>
            </div>
            <div class="field">
              <label for="docReferences" data-i18n="label.references">References</label>
              <textarea id="docReferences" rows="2" placeholder="Link or reference notes" data-i18n-placeholder="ph.references"></textarea>
            </div>
            <div class="toolbar">
              <button id="saveDraftBtn" class="btn" type="button" data-i18n="btn.saveDraft">Save Draft</button>
              <button id="submitReviewBtn" class="btn secondary" type="button" data-i18n="btn.submitReview">Submit for Review</button>
            </div>
          </div>
        </section>

        <section id="tab-preview" class="tab-panel" role="tabpanel" aria-labelledby="tab-preview">
          <div class="toolbar">
            <button id="exportPdfBtn" class="btn ghost" type="button"><i class="fas fa-file-pdf"></i> Export PDF</button>
            <button id="exportDocxBtn" class="btn ghost" type="button"><i class="fas fa-file-word"></i> Export DOCX</button>
          </div>
          <div id="previewArea" class="preview-area">Live preview will render here.</div>
        </section>

        <section id="tab-flowchart" class="tab-panel" role="tabpanel" aria-labelledby="tab-flowchart">
          <div id="flowchartArea" class="flowchart-area">Flowchart visualization will render here.</div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // Firebase v8 configuration (aligned with staff.html)
    const firebaseConfig = {
      apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
      authDomain: "users-8be65.firebaseapp.com",
      databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
      projectId: "users-8be65",
      storageBucket: "users-8be65.firebasestorage.app",
      messagingSenderId: "909025468149",
      appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
      measurementId: "G-XHFMRCJQEZ"
    };

  function initializeFirebase() {
      if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
        window.firebase.initializeApp(firebaseConfig);
      }
      return window.firebase;
    }

    const Auth = {
      currentUser: null,
      db: null,
      async ensureAuth() {
        try {
          // If already authenticated, ensure currentUser is populated and return
          const existing = firebase.auth().currentUser;
          if (existing) {
            if (!this.currentUser || !this.currentUser.uid) {
              this.currentUser = {
                ...(this.currentUser || {}),
                uid: existing.uid,
                authUid: existing.uid,
                email: existing.email,
                displayName: existing.displayName,
                photoURL: existing.photoURL
              };
            }
            return existing;
          }
          // Wait briefly for any ongoing auth state to settle
          const user = await new Promise((resolve) => {
            const timeout = setTimeout(() => resolve(null), 800);
            try {
              firebase.auth().onAuthStateChanged((u) => {
                if (u) {
                  clearTimeout(timeout);
                  resolve(u);
                }
              });
            } catch {
              // ignore
            }
          });
          if (user) {
            if (!this.currentUser || !this.currentUser.uid) {
              this.currentUser = {
                ...(this.currentUser || {}),
                uid: user.uid,
                authUid: user.uid,
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL
              };
            }
            return user;
          }
          // Fall back to anonymous auth so database rules (auth != null) allow writes/reads
          try {
            await firebase.auth().signInAnonymously();
            const anon = firebase.auth().currentUser;
            if (anon) {
              this.currentUser = {
                ...(this.currentUser || {}),
                uid: anon.uid,
                authUid: anon.uid,
                email: anon.email,
                displayName: anon.displayName,
                photoURL: anon.photoURL
              };
            }
            return anon;
          } catch (e) {
            console.warn('[DMS] Anonymous sign-in failed', e);
            return null;
          }
        } catch (err) {
          console.warn('[DMS] ensureAuth error', err);
          return null;
        }
      },
      init() {
        initializeFirebase();
        this.db = firebase.database();
        this.currentUser = this.getStoredUser();
        this.wireHeader();
        this.wireNotifications();
        this.loadCompanyAndBranding();
        this.applyMenuVisibility();
  this.wireTabs();
  this.initEditor();
  this.updateUserProfileUI();
  try { firebase.auth().onAuthStateChanged(u => { if (u) { this.currentUser = { ...(this.currentUser||{}), uid: u.uid, email: u.email, displayName: u.displayName, photoURL: u.photoURL }; } this.updateUserProfileUI(); }); } catch {}
      },
      getStoredUser() {
        try { return JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch { return null; }
      },
      async loadCompanyAndBranding() {
        const headerLogo = document.getElementById('headerCompanyLogo');
        const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
        const headerCompanyName = document.getElementById('headerCompanyName');
        if (!this.currentUser) { headerCompanyName.textContent = ''; return; }
        try {
          const companiesSnap = await this.db.ref('companies').once('value');
          if (!companiesSnap.exists()) return;
          const companies = companiesSnap.val();
          let companyId = this.currentUser.companyId || null;
          if (!companyId) {
            // search membership
            for (const [cId, company] of Object.entries(companies)) {
              if (company?.status !== 'active') continue;
              if (company?.users && (company.users[this.currentUser.uid] || company.users[this.currentUser.authUid])) {
                companyId = cId; break;
              }
            }
          }
          if (companyId && companies[companyId]) {
            const c = companies[companyId];
            headerCompanyName.textContent = c.companyName || '';
            const logoUrl = c.logoUrl || c.logo || '';
            if (logoUrl) {
              headerLogo.src = logoUrl; headerLogo.classList.add('visible'); headerLogo.style.display = 'block';
              headerLogoPlaceholder.style.display = 'none';
            } else {
              headerLogo.style.display = 'none'; headerLogoPlaceholder.style.display = 'flex';
            }
            document.title = document.title.replace('Dreamex Datalab HSE', `${c.companyName || ''} HSE`);
            // Refresh doc number placeholder after branding/company name updates
            try { this.updateDocNumberPlaceholder(); this.tryAutoAssignDocNumber(); } catch {}
          } else {
            headerCompanyName.textContent = '';
            headerLogo.style.display = 'none'; headerLogoPlaceholder.style.display = 'flex';
            try { this.updateDocNumberPlaceholder(); } catch {}
          }
        } catch (e) { console.warn('Branding load error', e); }
      },
      async applyMenuVisibility() {
        console.log('[DMS] Starting strict menu visibility update...');
        const sidebar = document.querySelector('.sidebar');
        // Hide everything first (remove visibility classes)
        document.querySelectorAll('[data-feature]').forEach(el => el.classList.remove('menu-visible'));
        const ctx = await this.loadCompanyContext();
        if (!ctx) {
          console.log('[DMS] No company context resolved. Applying basic fallback menu.');
          this.showBasicMenu();
          if (sidebar) sidebar.classList.remove('menu-loading');
          return;
        }
        const { companyId, role } = ctx;
        try {
          console.log(`[DMS] Loading permissions for role="${role}" company="${companyId}"`);
          const permSnap = await this.db.ref(`companies/${companyId}/roles/${role}/permissions`).once('value');
          if (!permSnap.exists()) {
            console.log('[DMS] No permissions node found. Using fallback basic menu.');
            this.showBasicMenu();
            return;
          }
            const permissions = permSnap.val() || {};
          const featuresCount = Object.keys(permissions).length;
          console.log(`[DMS] Permissions loaded (${featuresCount} keys). Applying visibility...`);

          // Core strict logic: show only items whose feature permission has view=true
          let shown = 0;
          const items = document.querySelectorAll('[data-feature]');
          items.forEach(item => {
            const feature = item.getAttribute('data-feature');
            const perm = permissions[feature];
            if (perm && (perm === true || perm.view === true || perm.access === 'view' || perm.read === true)) {
              item.classList.add('menu-visible');
              shown++;
            }
          });

          // Ensure parent dropdowns become visible if any child submenu item is visible
          document.querySelectorAll('.menu-dropdown').forEach(dd => {
            const visibleChildren = dd.querySelectorAll('.submenu li.menu-visible');
            if (visibleChildren.length > 0) dd.classList.add('menu-visible');
          });

          // If nothing is visible, fallback to basic set
          if (shown === 0) {
            console.log('[DMS] No menu items matched permissions. Falling back to basic menu.');
            this.showBasicMenu();
          } else {
            console.log(`[DMS] Menu visibility applied. Visible items: ${shown}`);
          }
        } catch (err) {
          console.warn('[DMS] Menu visibility error (strict mode fallback).', err);
          this.showBasicMenu();
        } finally {
          if (sidebar) sidebar.classList.remove('menu-loading');
        }
      },
      hasViewPermission(feature) {
        const el = document.querySelector(`[data-feature="${feature}"]`);
        return el?.classList?.contains('menu-visible');
      },
      async loadCompanyContext() {
        if (!this.currentUser) return null;
        try {
          const companiesSnap = await this.db.ref('companies').once('value');
          if (!companiesSnap.exists()) return null;
          const companies = companiesSnap.val();
          let companyId = this.currentUser.companyId || null;
          if (!companyId) {
            for (const [cId, company] of Object.entries(companies)) {
              if (company?.status !== 'active') continue;
              if (company?.users && (company.users[this.currentUser.uid] || company.users[this.currentUser.authUid])) { companyId = cId; break; }
            }
          }
          if (!companyId) return null;
          // Get role from company users
          const userSnap = await this.db.ref(`companies/${companyId}/users/${this.currentUser.uid}`).once('value');
          const role = userSnap.exists() ? (userSnap.val()?.role || this.currentUser.role) : (this.currentUser.role || 'employee');
          this._dmsCtx = { companyId, role };
          return this._dmsCtx;
        } catch { return null; }
      },
      // Legacy helper removed; strict permission logic is embedded in applyMenuVisibility.
      updateMenuWithPermissionsAndFeatures() {
        // Intentionally left as no-op for backward compatibility (other code may call it).
      },
      showBasicMenu() {
        // Show essential menu items when role-based permissions aren't available
        const basicMenuItems = [
          'home_view',
          'communication_view'
        ];
        
        // Add settings items if user is logged in (basic admin capability)
        if (this.currentUser) {
          basicMenuItems.push('settings_view', 'account_settings_view', 'role_permissions_view', 'approval_settings_view');
        }
        
        basicMenuItems.forEach(feature => {
          const element = document.querySelector(`[data-feature="${feature}"]`);
          if (element) element.classList.add('menu-visible');
        });
        // Show parent dropdowns if they have any visible children
        document.querySelectorAll('.menu-dropdown').forEach(dd => {
          const anyChild = dd.querySelectorAll('.submenu li.menu-visible').length > 0;
          if (anyChild || dd.matches('.menu-visible')) dd.classList.add('menu-visible');
        });
      },
      updateUserProfileUI() {
        try {
          const img = document.getElementById('userAvatar');
          const initialsBox = document.getElementById('userInitials');
          if (!img || !initialsBox) return;
          const stored = this.currentUser || {};
          // Prefer firebase auth currentUser
          const authUser = (window.firebase?.auth?.()).currentUser || null;
          const displayName = stored.name || stored.fullName || authUser?.displayName || stored.displayName || stored.email || 'User';
          const photo = stored.photoURL || stored.photo || stored.avatarUrl || stored.imageUrl || authUser?.photoURL || null;
          const initials = (displayName || 'User')
            .split(/\s+/)
            .filter(Boolean)
            .slice(0,2)
            .map(s => s.charAt(0).toUpperCase())
            .join('') || 'U';
          initialsBox.textContent = initials;
          const showInitials = () => { img.style.display='none'; initialsBox.style.display='flex'; };
          if (photo) {
            img.onload = () => { img.style.display='block'; initialsBox.style.display='none'; };
            img.onerror = () => { showInitials(); };
            if (img.src !== photo) img.src = photo;
          } else {
            showInitials();
          }
        } catch (e) { console.warn('[DMS] updateUserProfileUI error', e); }
      },
      wireHeader() {
        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.sidebar');
        const mainContent = document.querySelector('.main-content');
        if (sidebarToggle && sidebar && mainContent) {
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            mainContent.classList.toggle('sidebar-collapsed');
          });
        }

        const btn = document.getElementById('userProfileBtn');
        const dd = document.getElementById('profileDropdown');
        const logout = document.getElementById('logoutLink');
        if (btn && dd) {
          // Clean toggling like project-list: toggle .show class and close on outside click
          btn.addEventListener('click', (e) => { e.stopPropagation(); dd.classList.toggle('show'); });
          document.addEventListener('click', (e) => { if (!dd.contains(e.target) && !btn.contains(e.target)) dd.classList.remove('show'); });
        }
        if (logout) logout.addEventListener('click', (e) => { e.preventDefault(); try { firebase.auth().signOut(); } catch {} localStorage.removeItem('currentUser'); window.location.href = 'index.html'; });
      },
      async wireNotifications() {
        const btn = document.getElementById('notificationBtn');
        const dd = document.getElementById('notificationDropdown');
        const list = document.getElementById('notificationList');
        const badge = document.querySelector('.notification-badge');
        const markAll = document.getElementById('markAllReadBtn');
        const uid = this.currentUser?.uid;
        const db = this.db;
        function render(notifs) {
          list.innerHTML = '';
          if (!Array.isArray(notifs) || notifs.length === 0) { list.innerHTML = '<div style="padding:.75rem;color:#6c757d;">No notifications</div>'; badge.style.display = 'none'; return; }
          const unread = notifs.filter(n => !n.read).length;
          if (unread > 0) { badge.textContent = unread > 99 ? '99+' : String(unread); badge.style.display = 'block'; } else { badge.style.display = 'none'; }
          notifs.slice(0, 10).forEach(n => {
            const div = document.createElement('div');
            div.className = `notification-item ${n.read ? '' : 'unread'}`;
            div.innerHTML = `<div style="font-weight:600;font-size:.9rem;">${n.title || 'Notification'}</div><div style="font-size:.85rem;color:#555;margin-top:2px;">${n.message || ''}</div>`;
            list.appendChild(div);
          });
        }
        let cache = [];
        async function load() {
          if (!uid) return render([]);
          try {
            const snap = await db.ref(`notifications/${uid}`).once('value');
            if (!snap.exists()) return render([]);
            const data = snap.val();
            cache = Object.keys(data).map(k => ({ id: k, ...data[k] }))
              .sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
            render(cache);
          } catch (e) { render([]); }
        }
        if (btn && dd) {
          btn.addEventListener('click', (e) => { e.stopPropagation(); dd.classList.toggle('show'); });
          document.addEventListener('click', (e) => { if (!dd.contains(e.target) && !btn.contains(e.target)) dd.classList.remove('show'); });
        }
        if (markAll && uid) {
          markAll.addEventListener('click', async () => {
            const ref = db.ref(`notifications/${uid}`);
            const snap = await ref.once('value');
            if (!snap.exists()) return;
            const updates = {};
            Object.keys(snap.val()).forEach(k => updates[`${k}/read`] = true);
            await ref.update(updates);
            load();
          });
        }
        load();
      },
      wireTabs() {
        const buttons = document.querySelectorAll('.tab-btn');
        const panels = { editor: document.getElementById('tab-editor'), preview: document.getElementById('tab-preview'), flowchart: document.getElementById('tab-flowchart') };
        buttons.forEach(b => b.addEventListener('click', () => {
          buttons.forEach(x => x.classList.remove('active')); b.classList.add('active');
          Object.values(panels).forEach(p => p.classList.remove('active'));
          const key = b.getAttribute('data-tab'); panels[key]?.classList.add('active');
          if (key === 'preview') {
            this.renderPreview();
          }
          if (key === 'flowchart') {
            this.renderFlowchart();
          }
        }));
        // Load approval settings for DMS process type
        this.fetchApprovalFlowConfig();
        // If editing a specific doc, load it
        this.loadDocumentFromQuery();
      }
      ,
      initEditor() {
        // Mermaid config
        if (window.mermaid && !this._mermaidInit) {
          window.mermaid.initialize({ startOnLoad: false, securityLevel: 'loose', theme: 'default' });
          this._mermaidInit = true;
        }
        // Autofill Document Owner with current user's full name if creating new doc
        const docOwnerInput = document.getElementById('docOwner');
        if (docOwnerInput && (!docOwnerInput.value || docOwnerInput.value === '')) {
          let name = '';
          if (this.currentUser) {
            name = this.currentUser.fullName || this.currentUser.name || this.currentUser.displayName || this.currentUser.email || '';
          }
          if (name) docOwnerInput.value = name;
        }
        // Load current user's department and populate read-only field
        (async () => {
          try {
            const ctx = await this.loadCompanyContext();
            if (!ctx) return;
            const { companyId } = ctx;
            const uid = this.currentUser?.uid;
            if (!uid) return;
            const [userSnap, optsSnap] = await Promise.all([
              this.db.ref(`companies/${companyId}/users/${uid}`).once('value'),
              this.db.ref(`companies/${companyId}/fieldOptions/department`).once('value')
            ]);
            const u = userSnap.exists() ? userSnap.val() : {};
            const opts = optsSnap.exists() ? optsSnap.val() : {};
            const rawDept = u.department || u.dept || u.departmentName || '';
            const resolveDept = (val) => {
              if (!val) return '';
              const meta = opts[val];
              if (meta) {
                return typeof meta === 'string' ? meta : (meta.label || meta.value || val);
              }
              return val;
            };
            const dept = resolveDept(rawDept);
            const input = document.getElementById('docCategory');
            if (input) {
              input.value = dept;
              this.updateDocNumberPlaceholder();
              this.tryAutoAssignDocNumber();
            }
          } catch (e) { console.warn('Could not load user department', e); }
        })();
        // Operating procedures (multiple sections with nested steps)
        const proceduresContainer = document.getElementById('proceduresContainer');
        const addProcBtn = document.getElementById('addProcedureBtn');
        const addStepRow = (stepsHost, name = '', description = '') => {
          const div = document.createElement('div');
          div.className = 'step';
          div.style.display = 'grid';
          div.style.gridTemplateColumns = '1fr auto';
          div.style.gridTemplateRows = 'auto auto';
          div.style.gap = '.5rem';
          div.style.margin = '6px 0';
          div.innerHTML = `
            <input class="step-name" type="text" placeholder="Step name" value="${(name||'').replace(/"/g,'&quot;')}">
            <button class="btn ghost" type="button" title="Remove">&times;</button>
            <textarea class="step-desc" rows="3" placeholder="Description" style="grid-column: 1 / span 2;">${(description||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
          `;
          const nameEl = div.querySelector('.step-name');
          const descEl = div.querySelector('.step-desc');
          [nameEl, descEl].forEach(el => el.addEventListener('input', () => this.persistLocalDraft()));
          const rBtn = div.querySelector('button');
          rBtn.addEventListener('click', () => { div.remove(); this.persistLocalDraft(); });
          stepsHost.appendChild(div);
        };
        const addProcedure = (title = '', steps = []) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'procedure';
          wrapper.style.border = '1px solid #e5e7eb';
          wrapper.style.borderRadius = '8px';
          wrapper.style.padding = '.75rem';
          wrapper.style.margin = '8px 0';
          wrapper.innerHTML = `
            <div style="display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center;margin-bottom:.5rem;">
              <input class="proc-title" type="text" placeholder="Procedure title (e.g., Transport)" value="${(title||'').replace(/"/g,'&quot;')}">
              <div>
                <button class="btn ghost add-step" type="button" title="Add step"><i class="fas fa-plus"></i> Add Step</button>
                <button class="btn ghost" type="button" title="Remove procedure">&times;</button>
              </div>
            </div>
            <div class="steps"></div>
          `;
          const titleEl = wrapper.querySelector('.proc-title');
          titleEl.addEventListener('input', () => this.persistLocalDraft());
          const rmProcBtn = wrapper.querySelectorAll('button')[1];
          rmProcBtn.addEventListener('click', () => { wrapper.remove(); this.persistLocalDraft(); });
          const addStepBtn = wrapper.querySelector('.add-step');
          const stepsHost = wrapper.querySelector('.steps');
          addStepBtn.addEventListener('click', () => addStepRow(stepsHost, '', ''));
          if (!steps || !steps.length) {
            addStepRow(stepsHost, 'Start', '');
          } else {
            steps.forEach(s => addStepRow(stepsHost, s.name || '', s.description || ''));
          }
          proceduresContainer.appendChild(wrapper);
        };
        addProcBtn.addEventListener('click', () => addProcedure('', []));
        // Seed one empty procedure
        if (!proceduresContainer.children.length) addProcedure('', []);
        // Definitions (dynamic rows)
        const defContainer = document.getElementById('definitionsContainer');
        const addDefBtn = document.getElementById('addDefBtn');
        const addDef = (term = '', text = '') => {
          const row = document.createElement('div');
          row.style.display = 'grid';
          row.style.gridTemplateColumns = '1fr 3fr auto';
          row.style.gap = '.5rem';
          row.style.margin = '6px 0';
          row.innerHTML = `
            <input type="text" placeholder="Term" value="${(term||'').replace(/"/g,'&quot;')}">
            <input type="text" placeholder="Definition" value="${(text||'').replace(/"/g,'&quot;')}">
            <button class="btn ghost" type="button" title="Remove">&times;</button>
          `;
          const [tEl, dEl, rBtn] = row.children;
          [tEl, dEl].forEach(el => el.addEventListener('input', () => this.persistLocalDraft()));
          rBtn.addEventListener('click', () => { row.remove(); this.persistLocalDraft(); });
          defContainer.appendChild(row);
        };
        addDefBtn.addEventListener('click', () => addDef('', ''));
        // Roles & Responsibilities (dynamic rows)
        const rolesContainer = document.getElementById('rolesContainer');
        const addRoleBtn = document.getElementById('addRoleBtn');
        const addRole = (role = '', responsibility = '') => {
          const row = document.createElement('div');
          row.style.display = 'grid';
          row.style.gridTemplateColumns = '1fr 3fr auto';
          row.style.gap = '.5rem';
          row.style.margin = '6px 0';
          row.innerHTML = `
            <input type="text" placeholder="Role" value="${(role||'').replace(/"/g,'&quot;')}">
            <input type="text" placeholder="Responsibility" value="${(responsibility||'').replace(/"/g,'&quot;')}">
            <button class="btn ghost" type="button" title="Remove">&times;</button>
          `;
          const [rEl, respEl, rmBtn] = row.children;
          [rEl, respEl].forEach(el => el.addEventListener('input', () => this.persistLocalDraft()));
          rmBtn.addEventListener('click', () => { row.remove(); this.persistLocalDraft(); });
          rolesContainer.appendChild(row);
        };
        addRoleBtn.addEventListener('click', () => addRole('', ''));
        // Save and submit
        document.getElementById('saveDraftBtn').addEventListener('click', () => this.saveDocument('draft'));
        document.getElementById('submitReviewBtn').addEventListener('click', () => this.saveDocument('in_review'));
        // Exports
        document.getElementById('exportPdfBtn').addEventListener('click', () => this.exportPdf());
        document.getElementById('exportDocxBtn').addEventListener('click', () => this.exportDocx());
        // Auto local draft
        ['docTitle','docType','docCategory','docNumber','docPurpose','docScope','docOwner','docDistribution','docRisk','docReferences'].forEach(id => {
          const el = document.getElementById(id); if (!el) return; el.addEventListener('input', () => this.persistLocalDraft());
        });
        // Update doc number placeholder when type changes
        const typeEl = document.getElementById('docType'); if (typeEl) typeEl.addEventListener('change', () => { this.updateDocNumberPlaceholder(); this.tryAutoAssignDocNumber(); });
        // Initial placeholder and attempt auto number
        try { this.updateDocNumberPlaceholder(); this.tryAutoAssignDocNumber(); } catch {}
      },
      async tryAutoAssignDocNumber() {
        const input = document.getElementById('docNumber');
        if (!input || (input.value && input.value.trim() !== '')) return; // respect existing value
        const prefix = this.buildDocNumberPrefix();
        if (!prefix) return;
        const ctx = await this.loadCompanyContext();
        if (!ctx) return;
        const seq = await this.allocateSequentialNumber(ctx.companyId, prefix);
        if (!seq) return;
        input.value = `${prefix}-${this.formatSeq(seq)}`;
      },
      // Compute a live placeholder for document number based on selected fields
      updateDocNumberPlaceholder() {
        const prefix = this.buildDocNumberPrefix();
        const input = document.getElementById('docNumber');
        if (input) input.placeholder = prefix ? `${prefix}-001` : 'e.g., C-DEPT-TYPE-001';
      },
      // Helpers to build doc number pieces
      getCompanyInitial() {
        const name = (document.getElementById('headerCompanyName')?.textContent || '').trim();
        const m = name.match(/[A-Za-z]/);
        return m ? m[0].toUpperCase() : 'C';
      },
      getDepartmentInitials() {
        const label = (document.getElementById('docCategory')?.value || '').trim();
        if (!label) return 'GEN';
        // Preserve acronyms like HSE
        if (/^[A-Z]{2,6}$/.test(label)) return label;
        const parts = label.split(/[^A-Za-z]+/).filter(Boolean);
        const initials = parts.map(w => w.charAt(0).toUpperCase()).join('');
        return initials || 'GEN';
      },
      getDocTypeInitial() {
        const v = (document.getElementById('docType')?.value || '').toString();
        // Use first letter of the first word (ignore underscores)
        const firstWord = v.split('_')[0] || v;
        const m = firstWord.match(/[A-Za-z]/);
        return m ? m[0].toUpperCase() : 'D';
      },
      buildDocNumberPrefix() {
        try {
          const c = this.getCompanyInitial();
          const d = this.getDepartmentInitials();
          const t = this.getDocTypeInitial();
          return `${c}-${d}-${t}`;
        } catch { return ''; }
      },
      formatSeq(seq) {
        const n = Number(seq) || 0;
        return String(n).padStart(3, '0');
      },
      allocateSequentialNumber(companyId, prefix) {
        const ref = this.db.ref(`companies/${companyId}/dms/counters/${prefix}`);
        return new Promise((resolve) => {
          ref.transaction(
            current => (typeof current === 'number' ? current + 1 : 1),
            (error, committed, snapshot) => {
              if (error || !committed) return resolve(null);
              const val = snapshot && snapshot.val ? snapshot.val() : null;
              resolve(val);
            }
          );
        });
      },
      getDocId() {
        const params = new URLSearchParams(window.location.search);
        return params.get('doc') || `DMS-${Date.now()}`;
      },
      buildDocModel(statusOverride = null) {
        const tags = [];
        const procedures = Array.from(document.querySelectorAll('#proceduresContainer .procedure')).map(proc => {
          const title = proc.querySelector('.proc-title')?.value?.trim() || '';
          const steps = Array.from(proc.querySelectorAll('.steps > .step')).map(row => {
            const nameEl = row.querySelector('.step-name');
            const descEl = row.querySelector('.step-desc');
            return { name: nameEl?.value?.trim() || '', description: descEl?.value?.trim() || '' };
          }).filter(s => s.name || s.description);
          return { title, steps };
        }).filter(p => p.title || (p.steps && p.steps.length));

        // Get current revision history
        let revisionHistory = document.getElementById('docRevision').value?.trim() || '';
        
        // Check if we have a cached approved change request for revision history
        if (this._approvedChangeRequest) {
          // Add new revision entry
          const currentDate = new Date().toLocaleDateString();
          const currentUserName = this.currentUser?.displayName || this.currentUser?.email || 'Unknown User';
          const newRevisionEntry = `\n${currentDate} - Revised by ${currentUserName} (Change Request: ${this._approvedChangeRequest.title || this._approvedChangeRequest.id})`;
          
          // Append to existing revision history
          revisionHistory = revisionHistory ? revisionHistory + newRevisionEntry : newRevisionEntry.trim();
          
          // Update the revision history field in the UI
          document.getElementById('docRevision').value = revisionHistory;
        }
        
        // Add status change entries to revision history
        if (statusOverride && this._loadedDoc && statusOverride !== this._loadedDoc.status) {
          const currentDate = new Date().toLocaleDateString();
          const currentUserName = this.currentUser?.displayName || this.currentUser?.email || 'Unknown User';
          let statusEntry = '';
          
          switch (statusOverride) {
            case 'in_review':
              statusEntry = `\n${currentDate} - Submitted for review by ${currentUserName}`;
              break;
            case 'approved':
              statusEntry = `\n${currentDate} - Approved by ${currentUserName}`;
              break;
            case 'declined':
              statusEntry = `\n${currentDate} - Declined by ${currentUserName}`;
              break;
            case 'draft':
              statusEntry = `\n${currentDate} - Returned to draft by ${currentUserName}`;
              break;
            default:
              statusEntry = `\n${currentDate} - Status changed to ${statusOverride} by ${currentUserName}`;
          }
          
          // Append to existing revision history
          revisionHistory = revisionHistory ? revisionHistory + statusEntry : statusEntry.trim();
          
          // Update the revision history field in the UI
          document.getElementById('docRevision').value = revisionHistory;
        }

        const model = {
          id: this.getDocId(),
          title: document.getElementById('docTitle').value || '',
          type: document.getElementById('docType').value || 'procedure',
          category: document.getElementById('docCategory').value || '',
          documentNumber: document.getElementById('docNumber').value?.trim() || '',
          tags,
          purpose: document.getElementById('docPurpose').value || '',
          scope: document.getElementById('docScope').value || '',
          definitions: Array.from(document.querySelectorAll('#definitionsContainer > div')).map(row => {
            const inputs = row.querySelectorAll('input');
            return { term: inputs[0]?.value?.trim() || '', text: inputs[1]?.value?.trim() || '' };
          }).filter(x => x.term || x.text),
          owner: document.getElementById('docOwner').value?.trim() || '',
          effectiveDate: document.getElementById('docEffectiveDate').value || '',
          expiryDate: document.getElementById('docExpiryDate').value || '',
          classification: document.getElementById('docClassification').value || 'internal',
          roles: Array.from(document.querySelectorAll('#rolesContainer > div')).map(row => {
            const inputs = row.querySelectorAll('input');
            return { role: inputs[0]?.value?.trim() || '', responsibility: inputs[1]?.value?.trim() || '' };
          }).filter(x => x.role || x.responsibility),
          distribution: document.getElementById('docDistribution').value?.trim() || '',
          riskLevel: document.getElementById('docRisk').value?.trim() || '',
          revisionHistory: revisionHistory,
          steps: procedures,
          references: document.getElementById('docReferences').value || '',
          status: statusOverride || (this._loadedDoc && this._loadedDoc.status) || 'draft',
          updated: Date.now(),
          updatedBy: this.currentUser?.uid || null
        };
        return model;
      },
      async checkForApprovedChangeRequest(documentId) {
        // Check if there's an approved change request for this document
        try {
          const ctx = await this.loadCompanyContext();
          if (!ctx) return null;
          
          const { companyId } = ctx;
          const changeRequestsRef = this.db.ref(`companies/${companyId}/changeRequests`);
          const snapshot = await changeRequestsRef.orderByChild('documentId').equalTo(documentId).once('value');
          
          if (!snapshot.exists()) return null;
          
          const requests = snapshot.val();
          // Find the most recent approved change request
          let mostRecentApproved = null;
          
          Object.values(requests).forEach(request => {
            if (request.status === 'approved') {
              if (!mostRecentApproved || new Date(request.requestedAt) > new Date(mostRecentApproved.requestedAt)) {
                mostRecentApproved = request;
              }
            }
          });
          
          return mostRecentApproved;
        } catch (error) {
          console.error('Error checking for approved change request:', error);
          return null;
        }
      },
      async buildComprehensiveRevisionHistory(documentId) {
        try {
          const ctx = await this.loadCompanyContext();
          if (!ctx) return '';
          
          const { companyId } = ctx;
          let revisionEntries = [];
          
          // Get document data
          const docSnap = await this.db.ref(`companies/${companyId}/dms/documents/${documentId}`).once('value');
          if (!docSnap.exists()) return '';
          
          const doc = docSnap.val();
          
          // Add creation entry
          if (doc.created || doc.updated) {
            const createdDate = new Date(doc.created || doc.updated).toLocaleDateString();
            const createdBy = doc.createdBy || doc.updatedBy || 'Unknown User';
            // Get user name if available
            if (createdBy && createdBy !== 'Unknown User') {
              try {
                const userSnap = await this.db.ref(`users/${createdBy}`).once('value');
                if (userSnap.exists()) {
                  const userData = userSnap.val();
                  const userName = userData.displayName || userData.name || userData.email || createdBy;
                  const rolesArr = [];
                  if (userData.role) rolesArr.push(userData.role);
                  if (userData.roles && Array.isArray(userData.roles)) rolesArr.push(...userData.roles.filter(Boolean));
                  if (userData.jobTitle) rolesArr.push(userData.jobTitle);
                  if (userData.position) rolesArr.push(userData.position);
                  if (userData.function) rolesArr.push(userData.function);
                  const roleStr = rolesArr.filter(Boolean).join(', ');
                  revisionEntries.push({
                    date: new Date(doc.created || doc.updated),
                    entry: `${createdDate} - Created by ${userName}${roleStr ? ' — ' + roleStr : ''}`
                  });
                } else {
                  revisionEntries.push({
                    date: new Date(doc.created || doc.updated),
                    entry: `${createdDate} - Created by ${createdBy}`
                  });
                }
              } catch (error) {
                revisionEntries.push({
                  date: new Date(doc.created || doc.updated),
                  entry: `${createdDate} - Created by ${createdBy}`
                });
              }
            } else {
              revisionEntries.push({
                date: new Date(doc.created || doc.updated),
                entry: `${createdDate} - Document created`
              });
            }
          }
          
          // Check for approval history
          const approvalSnap = await this.db.ref(`companies/${companyId}/dms/documents/${documentId}/approvalStatus`).once('value');
          if (approvalSnap.exists()) {
            const approvalData = approvalSnap.val();
            if (approvalData.approvedAt) {
              const approvedDate = new Date(approvalData.approvedAt).toLocaleDateString();
              const approvedBy = approvalData.approvedBy || 'Unknown Approver';
              
              // Get approver name if available
              if (approvedBy && approvedBy !== 'Unknown Approver') {
                try {
                  const userSnap = await this.db.ref(`users/${approvedBy}`).once('value');
                  if (userSnap.exists()) {
                    const userData = userSnap.val();
                    const userName = userData.displayName || userData.name || userData.email || approvedBy;
                    const rolesArr = [];
                    if (userData.role) rolesArr.push(userData.role);
                    if (userData.roles && Array.isArray(userData.roles)) rolesArr.push(...userData.roles.filter(Boolean));
                    if (userData.jobTitle) rolesArr.push(userData.jobTitle);
                    if (userData.position) rolesArr.push(userData.position);
                    if (userData.function) rolesArr.push(userData.function);
                    const roleStr = rolesArr.filter(Boolean).join(', ');
                    revisionEntries.push({
                      date: new Date(approvalData.approvedAt),
                      entry: `${approvedDate} - Approved by ${userName}${roleStr ? ' — ' + roleStr : ''}`
                    });
                  } else {
                    revisionEntries.push({
                      date: new Date(approvalData.approvedAt),
                      entry: `${approvedDate} - Approved by ${approvedBy}`
                    });
                  }
                } catch (error) {
                  revisionEntries.push({
                    date: new Date(approvalData.approvedAt),
                    entry: `${approvedDate} - Approved by ${approvedBy}`
                  });
                }
              } else {
                revisionEntries.push({
                  date: new Date(approvalData.approvedAt),
                  entry: `${approvedDate} - Document approved`
                });
              }
            }
          }
          
          // Get change request history
          const changeRequestsSnap = await this.db.ref(`companies/${companyId}/changeRequests`).orderByChild('documentId').equalTo(documentId).once('value');
          if (changeRequestsSnap.exists()) {
            const requests = changeRequestsSnap.val();
            for (const request of Object.values(requests)) {
              if (request.status === 'approved' && request.approvedAt) {
                const approvedDate = new Date(request.approvedAt).toLocaleDateString();
                const approvedBy = request.approvedBy || 'Unknown Approver';
                let approverEntry = `${approvedDate} - Change Request approved`;
                if (approvedBy && approvedBy !== 'Unknown Approver') {
                  try {
                    const userSnap = await this.db.ref(`users/${approvedBy}`).once('value');
                    if (userSnap.exists()) {
                      const userData = userSnap.val();
                      const userName = userData.displayName || userData.name || userData.email || approvedBy;
                      const rolesArr = [];
                      if (userData.role) rolesArr.push(userData.role);
                      if (userData.roles && Array.isArray(userData.roles)) rolesArr.push(...userData.roles.filter(Boolean));
                      if (userData.jobTitle) rolesArr.push(userData.jobTitle);
                      if (userData.position) rolesArr.push(userData.position);
                      if (userData.function) rolesArr.push(userData.function);
                      const roleStr = rolesArr.filter(Boolean).join(', ');
                      approverEntry = `${approvedDate} - Change Request approved by ${userName}${roleStr ? ' — ' + roleStr : ''} (${request.title || request.id})`;
                    } else {
                      approverEntry = `${approvedDate} - Change Request approved by ${approvedBy} (${request.title || request.id})`;
                    }
                  } catch (e) {
                    approverEntry = `${approvedDate} - Change Request approved by ${approvedBy} (${request.title || request.id})`;
                  }
                } else {
                  approverEntry = `${approvedDate} - Change Request approved (${request.title || request.id})`;
                }
                revisionEntries.push({
                  date: new Date(request.approvedAt),
                  entry: approverEntry
                });
              }
            }
          }
          
          // Add existing revision history if present
          if (doc.revisionHistory) {
            const existingEntries = doc.revisionHistory.split('\n').filter(entry => entry.trim());
            existingEntries.forEach(entry => {
              // Try to extract date from existing entries to maintain chronological order
              const dateMatch = entry.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
              if (dateMatch) {
                try {
                  const entryDate = new Date(dateMatch[1]);
                  revisionEntries.push({
                    date: entryDate,
                    entry: entry.trim()
                  });
                } catch (error) {
                  // If date parsing fails, use current date
                  revisionEntries.push({
                    date: new Date(),
                    entry: entry.trim()
                  });
                }
              } else {
                // If no date found, use current date
                revisionEntries.push({
                  date: new Date(),
                  entry: entry.trim()
                });
              }
            });
          }
          
          // Sort by date (oldest first)
          revisionEntries.sort((a, b) => a.date - b.date);
          
          // Return formatted revision history
          return revisionEntries.map(entry => entry.entry).join('\n');
          
        } catch (error) {
          console.error('Error building comprehensive revision history:', error);
          return '';
        }
      },
      clearApprovedChangeRequest() {
        // Clear the stored approved change request to prevent duplicate revision entries
        delete this._approvedChangeRequest;
      },
      async saveDocument(nextStatus) {
  // Permission check removed to allow all logged-in users to submit or edit documents
        console.log('🚀 saveDocument called with status:', nextStatus);
        console.log('📱 Current user:', this.currentUser);
        
        // Ensure Firebase auth is present to satisfy Realtime Database rules
        console.log('🔐 Ensuring Firebase auth...');
        const authResult = await this.ensureAuth();
        console.log('🔐 Auth result:', authResult);
        
        // Check for approved change request before building the model
        const docId = this.getDocId();
        console.log('📄 Document ID:', docId);
        this._approvedChangeRequest = await this.checkForApprovedChangeRequest(docId);
        
        console.log('🏗️ Building document model...');
        const model = this.buildDocModel(nextStatus);
        console.log('🏗️ Document model built:', model);
        
        // Persist local draft regardless
        this.persistLocalDraft(model);
        console.log('💾 Local draft saved');
        
        console.log('🏢 Loading company context...');
        const ctx = await this.loadCompanyContext();
        console.log('🏢 Company context:', ctx);
        if (!ctx) { 
          console.error('❌ No company context available');
          alert('No company context. Draft saved locally.'); 
          return; 
        }
        const { companyId } = ctx;
        const refPath = `companies/${companyId}/dms/documents/${model.id}`;
        console.log('🎯 Firebase path:', refPath);
        
        try {
          console.log('🔍 Checking for existing document...');
          // append version if exists
          const existing = await this.db.ref(refPath).once('value');
          console.log('🔍 Existing document:', existing.exists() ? 'found' : 'not found');
          if (existing.exists()) {
            const prev = existing.val();
            const versions = prev.versions || [];
            // Store a compact snapshot of prior content; align keys with current model
            const snapshot = {
              timestamp: prev.updated || Date.now(),
              title: prev.title || '',
              purpose: prev.purpose || '',
              scope: prev.scope || '',
              roles: Array.isArray(prev.roles) ? prev.roles : [],
              steps: Array.isArray(prev.steps) ? prev.steps : [],
              references: prev.references || '',
              updatedBy: this.currentUser?.uid || null
            };
            versions.push(snapshot);
            model.versions = versions.slice(-10); // keep last 10
            model.created = prev.created || prev.updated || Date.now();
            model.createdBy = prev.createdBy || prev.updatedBy || this.currentUser?.uid || null;
            console.log('📝 Updated existing document with versions');
          } else {
            model.created = model.updated;
            model.createdBy = model.updatedBy;
            // Assign document number if missing, using pattern: C-DEP-T-NNN
            if (!model.documentNumber) {
              const prefix = this.buildDocNumberPrefix();
              let seq = await this.allocateSequentialNumber(companyId, prefix);
              if (!seq) { seq = 1; }
              model.documentNumber = `${prefix}-${this.formatSeq(seq)}`;
              const dnEl = document.getElementById('docNumber'); if (dnEl) dnEl.value = model.documentNumber;
              console.log('🔢 Generated document number:', model.documentNumber);
            }
            console.log('🆕 Creating new document');
          }
          // Derive owner/version
          const ownerName = (this.currentUser?.name) || (this.currentUser?.displayName) || (this.currentUser?.email) || 'Unknown';
          model.owner = ownerName;
          model.version = String((model.versions?.length || 0) + 1);
          console.log('👤 Document owner:', ownerName, 'version:', model.version);

          // If submitting for review, resolve approvers first (non-fatal if this block fails)
          let pendingApprovers = [];
          if (nextStatus === 'in_review') {
            console.log('📋 Resolving approvers for review...');
            try {
              if (!this._approvalFlow) { await this.fetchApprovalFlowConfig(); }
              const flow = this._approvalFlow || {};
              const selectedRoles = flow.selectedRoles || {};
              const lvl1 = selectedRoles['level1'] || [];
              console.log('👥 Level 1 approvers configured:', lvl1);
              const usersSnap = await this.db.ref(`companies/${companyId}/users`).once('value');
              const allUsers = usersSnap.exists() ? usersSnap.val() : {};
              const jobTitlesSnap = await this.db.ref(`companies/${companyId}/configuration/jobTitles`).once('value');
              const jobTitles = jobTitlesSnap.exists() ? jobTitlesSnap.val() : {};
              const jobTitleValueById = (id) => {
                const jt = jobTitles?.[id];
                return (jt && (jt.value || jt.label || id)) || id;
              };
              const approverUids = new Set();
              for (const sel of lvl1) {
                const val = sel?.value || '';
                if (val.startsWith('user_')) approverUids.add(val.replace('user_',''));
                else if (val.startsWith('function_')) {
                  const jtId = val.replace('function_',''); const target = jobTitleValueById(jtId);
                  Object.entries(allUsers).forEach(([uid, u]) => {
                    if (!u || u.status === 'inactive') return;
                    const jt = u.jobTitle || u.designation || '';
                    if (String(jt).toLowerCase() === String(target).toLowerCase()) approverUids.add(uid);
                  });
                } else if (/^L\+\d+$/.test(val)) {
                  console.warn('Level-based approver not implemented:', val);
                }
              }
              pendingApprovers = Array.from(approverUids);
              console.log('✅ Resolved approvers:', pendingApprovers);
            } catch (apErr) {
              console.warn('Approver resolution failed, continuing without approvers', apErr);
              pendingApprovers = [];
            }
            model.approval = { currentLevel: 1, pending: pendingApprovers, history: model.approval?.history || [] };
          }

          // Save the document first (primary objective)
          console.log('💾 Saving document to Firebase...');
          console.log('💾 Model to save:', JSON.stringify(model, null, 2));
          const cleanModel = this.sanitizeForFirebase(model);
          await this.db.ref(refPath).set(cleanModel);
          console.log('✅ Document saved successfully to Firebase!');

          // Fire notifications in a non-blocking try/catch so save success isn't lost
          if (nextStatus === 'in_review' && pendingApprovers.length) {
            console.log('📬 Sending notifications to approvers...');
            try {
              const link = `dmsedit.html?doc=${encodeURIComponent(model.id)}&mode=view`;
              const now = Date.now();
              const title = 'Document Review Requested';
              const message = `${ownerName} submitted "${model.title || 'Untitled Document'}" for review.`;
              for (const uid of pendingApprovers) {
                const nref = this.db.ref(`notifications/${uid}`).push();
                await nref.set({ title, message, link, read: false, timestamp: now });
              }
              console.log('✅ Notifications sent successfully');
            } catch (nErr) {
              console.warn('Notification dispatch failed (document saved successfully):', nErr);
            }
          }
          
          // Clear the approved change request after successful save
          this.clearApprovedChangeRequest();
          
          alert(nextStatus === 'in_review' ? 'Submitted for review.' : 'Draft saved.');
        } catch (e) {
          console.error('❌ Save error details:', e);
          if (e && (e.message || e.code || e.stack)) {
            console.error('❌ Error message:', e.message);
            console.error('❌ Error code:', e.code);
            console.error('❌ Error stack:', e.stack);
          }
          const msg = e && (e.message || e.code) ? `Error saving: ${e.message || e.code}. Draft is stored locally.` : 'Error saving. Draft is stored locally.';
          alert(msg);
        }
      },
      // Remove any undefined values recursively; Firebase RTDB does not allow undefined
      sanitizeForFirebase(value) {
        if (value === undefined) return null; // convert root undefined to null (shouldn't happen for objects)
        if (value === null) return null;
        if (Array.isArray(value)) {
          return value
            .map(v => this.sanitizeForFirebase(v))
            .filter(v => v !== undefined); // keep nulls if present, drop undefined
        }
        if (typeof value === 'object') {
          const out = {};
          for (const [k, v] of Object.entries(value)) {
            if (v === undefined) continue; // drop undefined keys
            const sv = this.sanitizeForFirebase(v);
            // Allow nulls and other primitives
            out[k] = sv;
          }
          return out;
        }
        return value; // primitives (string, number, boolean)
      },
      persistLocalDraft(model = null) {
        try {
          const data = model || this.buildDocModel();
          localStorage.setItem(`dms_draft_${data.id}`, JSON.stringify(data));
        } catch {}
      },
      tryLoadLocalDraft(docId) {
        try { const raw = localStorage.getItem(`dms_draft_${docId}`); return raw ? JSON.parse(raw) : null; } catch { return null; }
      },
      renderPreview() {
        const doc = this.buildDocModel();
        const headerLogo = document.getElementById('headerCompanyLogo');
        const companyName = document.getElementById('headerCompanyName')?.textContent || '';
        const logoHtml = headerLogo?.src ? `<img src="${headerLogo.src}" style="height:40px;border-radius:6px;border:1px solid #e5e7eb;"/>` : '';
        const esc = (t) => (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const md = (raw) => {
          const text = String(raw||'');
          const safe = esc(text);
          const lines = safe.split(/\r?\n/);
          const out = [];
          let inList = false;
          const flushList = () => { if (inList) { out.push('</ul>'); inList = false; } };
          for (const line of lines) {
            const m = line.match(/^\s*([\-*•])\s+(.*)$/);
            if (m) {
              if (!inList) { out.push('<ul>'); inList = true; }
              const li = m[2].replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
              out.push(`<li>${li}</li>`);
            } else if (line.trim() === '') {
              flushList();
              out.push('<br>');
            } else {
              flushList();
              const txt = line.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
              out.push(txt + '<br>');
            }
          }
          flushList();
          return out.join('');
        };
        const listSteps = (arr) => arr && arr.length ? `<ol>${arr.map(s=>`<li>${esc(s.name||'Step')}${s.description ? ' — ' + md(s.description) : ''}</li>`).join('')}</ol>` : '<em class="muted" data-i18n="preview.noSteps">No steps</em>';
        const listProcedures = (procs) => procs && procs.length ? procs.map(p => `
            <div style="margin-bottom:.5rem;">
              ${p.title ? `<h5 style="margin:0 0 .25rem 0;">${esc(p.title)}</h5>` : ''}
              ${listSteps(p.steps)}
            </div>
        `).join('') : '<em class="muted" data-i18n="preview.noProcedures">No operating procedure</em>';
        const html = `
          <div style="display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem;">
            ${logoHtml}
            <div>
              <div style="font-size:1.1rem;font-weight:700;">${esc(doc.title||'Untitled Document')}</div>
              <div class="muted">${esc(companyName)} • ${doc.type ? `<span data-i18n="option.type.${esc(doc.type)}">${esc(doc.type)}</span>` : ''}</div>
            </div>
          </div>
          <h4 data-i18n="label.purpose">Purpose</h4><p>${md(doc.purpose)}</p>
          <h4 data-i18n="label.scope">Scope</h4><p>${md(doc.scope)}</p>
          ${doc.definitions && doc.definitions.length ? `<h4 data-i18n="section.definitions">Definitions</h4>${(() => {
            const rows = doc.definitions.map(d => `<div><strong>${esc(d.term)}</strong>${d.term && d.text ? ' — ' : ''}${esc(d.text)}</div>`).join('');
            return `<div>${rows}</div>`;
          })()}` : ''}
          ${doc.owner ? `<h4 data-i18n="label.initiator">Initiator</h4><p>${esc(doc.owner)}</p>` : ''}
          
          ${doc.effectiveDate ? `<h4 data-i18n="label.effectiveDate">Effective Date</h4><p>${doc.effectiveDate}</p>` : ''}
          ${doc.expiryDate ? `<h4 data-i18n="label.nextReviewDate">Next Review Date</h4><p>${doc.expiryDate}</p>` : ''}
          ${doc.classification ? `<h4 data-i18n="label.classification">Classification</h4><p><span data-i18n="option.classification.${esc(doc.classification)}">${doc.classification.charAt(0).toUpperCase() + doc.classification.slice(1)}</span></p>` : ''}
          ${doc.roles && doc.roles.length ? `<h4 data-i18n="section.roles">Roles & Responsibilities</h4>${(() => {
            const rows = doc.roles.map(r => `<div><strong>${esc(r.role)}</strong>${r.role && r.responsibility ? ' — ' : ''}${esc(r.responsibility)}</div>`).join('');
            return `<div>${rows}</div>`;
          })()}` : ''}
          
          ${doc.distribution ? `<h4 data-i18n="label.distribution">Distribution List</h4><p>${md(doc.distribution)}</p>` : ''}
          ${doc.riskLevel ? `<h4 data-i18n="label.risk">Risk Assessment</h4><p>${md(doc.riskLevel)}</p>` : ''}
          
          <h4 data-i18n="section.operatingProcedure">Operating procedure</h4>${listProcedures(doc.steps)}
          <h4 data-i18n="label.references">References</h4><p>${md(doc.references)}</p>
        `;
        const prev = document.getElementById('previewArea');
        prev.innerHTML = html;
        if (window.__i18nApply) window.__i18nApply(prev);
      },
      async renderFlowchart() {
        if (!window.mermaid) return;
  const procs = this.buildDocModel().steps || [];
  const all = procs.flatMap(p => p.steps || []);
  const labels = all.length ? all.map(s => String(s.name || 'Step')) : ['Start'];
        let def = 'flowchart TD\n';
        labels.forEach((label, idx) => {
          const safe = label.replace(/\[/g,'(').replace(/\]/g,')');
          def += `A${idx}[${safe}]\n`;
        });
        for (let i=0;i<labels.length-1;i++) def += `A${i} --> A${i+1}\n`;
        try {
          const { svg } = await window.mermaid.render(`dms_flow_${Date.now()}`, def);
          document.getElementById('flowchartArea').innerHTML = svg;
          this._lastFlowSvg = svg;
        } catch (e) {
          document.getElementById('flowchartArea').textContent = 'Flowchart render error.';
        }
      },
      async exportPdf() {
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) return alert('PDF engine not available');
        const docModel = this.buildDocModel();
        if (!this._lastFlowSvg) { await this.renderFlowchart(); }
        const t = (window.__i18nT || ((k)=>k));
        const split = (pdf, text, maxWidth) => pdf.splitTextToSize(String(text||''), maxWidth);
        const drawWrapped = (pdf, text, x, y, lineHeight, maxWidth) => {
          const lines = split(pdf, text, maxWidth);
          const pageH2 = pdf.internal.pageSize.getHeight();
          lines.forEach((ln) => {
            if (y > pageH2 - (bottomMargin)) { pdf.addPage(); y = 60; }
            pdf.text(ln, x, y);
            y += lineHeight;
          });
          return y;
        };
               const svgToPngDataUrl = async (svgString, width = 800) => {

          if (!svgString) return null;
          return new Promise((resolve) => {
            const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            const img = new Image();
            img.onload = () => {
              const w = width;
              const h = Math.max(100, Math.floor((img.height / img.width) * w));
              const canvas = document.createElement('canvas');
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d');
              ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h);
              ctx.drawImage(img, 0, 0, w, h);
              const dataUrl = canvas.toDataURL('image/png');
              URL.revokeObjectURL(url);
              resolve({ dataUrl, width: w, height: h });
            };
            img.onerror = () => { URL.revokeObjectURL(url); resolve(null); };
            img.src = url;
          });
        };
        const imgUrlToPngDataUrl = async (url, maxW = 100) => {
          if (!url) return null;
          return new Promise((resolve) => {
            const img = new Image(); img.crossOrigin = 'anonymous';
            img.onload = () => {
              const ratio = img.height / img.width;
              const w = Math.min(maxW, img.width); const h = Math.round(w * ratio);
              const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d'); ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img, 0, 0, w, h);
              resolve({ dataUrl: canvas.toDataURL('image/png'), width: w, height: h });
            };
            img.onerror = () => resolve(null);
            img.src = url;
          });
        };
  const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
  let y = 70; const x = 50; const pageW = pdf.internal.pageSize.getWidth(); const pageH = pdf.internal.pageSize.getHeight(); const maxW = pageW - 100; const bottomMargin = 60;
        // Sidebar gradient colors: #334155 (RGB: 51,65,85) to #1e293b (RGB: 30,41,59)
        const primaryColor = [51,65,85]; // #334155 - sidebar gradient start
        const accentColor = [30,41,59]; // #1e293b - sidebar gradient end  
        const lightBlue = [248,250,252]; // slate-50 for background contrast
        const lineColor = [203,213,225]; // slate-300
        const labelColor = [71,85,105]; // slate-600
        const headingColor = [15,23,42]; // slate-900
        const mutedColor = [100,116,139]; // slate-500
        const hr = () => {
          if (y > pageH - (10 + bottomMargin)) { pdf.addPage(); y = 70; }
          pdf.setDrawColor(...lineColor); pdf.setLineWidth(1.0);
          pdf.line(x, y, pageW - x, y); y += 16;
        };
        const headerHr = () => {
          pdf.setDrawColor(...primaryColor); pdf.setLineWidth(2.0);
          pdf.line(x, y, pageW - x, y); y += 18;
        };
        const ensureSpace = (needed=50) => { if (y > pageH - (needed + bottomMargin)) { pdf.addPage(); y = 70; } };
        const logoEl = document.getElementById('headerCompanyLogo');
        const logoSrc = logoEl && logoEl.src ? logoEl.src : null;
        const logoPng = await imgUrlToPngDataUrl(logoSrc, 100);
        
        // Enhanced header with sidebar gradient colors
        // Background with lighter gradient color
        pdf.setFillColor(...lightBlue);
        pdf.rect(x - 10, y - 20, maxW + 20, 60, 'F');
        
        // Add accent strip with darker gradient color for visual depth
        pdf.setFillColor(...accentColor);
        pdf.rect(x - 10, y - 20, maxW + 20, 8, 'F');
        
        if (logoPng) { pdf.addImage(logoPng.dataUrl, 'PNG', pageW - 60 - logoPng.width, y - 15, logoPng.width, logoPng.height); }
        const companyLine = String((document.getElementById('headerCompanyName')?.textContent) || '');
        pdf.setFont('helvetica','normal'); pdf.setFontSize(12); pdf.setTextColor(...mutedColor);
        if (companyLine) { pdf.text(companyLine, x, y); y += 18; }
        pdf.setTextColor(...primaryColor);
        pdf.setFont('helvetica','bold'); pdf.setFontSize(20); 
        pdf.text(String(docModel.title || t('misc.untitled') || 'Untitled Document'), x, y); y += 28;
  const typeLabel = docModel.type ? (t(`option.type.${docModel.type}`) || docModel.type) : '';
        headerHr();
        
        // Summary section - single line format without border
        pdf.setFont('helvetica','bold'); pdf.setFontSize(14); pdf.setTextColor(...primaryColor);
        pdf.text(t('section.summary') || 'Summary', x, y); y += 20;
        
        pdf.setFont('helvetica','normal'); pdf.setFontSize(10); pdf.setTextColor(0,0,0);
        const lineH = 16;
        const statusLabel = (s) => ({ draft: (t('status.draft')||'Draft'), in_review: (t('status.in_review')||'In Review'), approved: (t('status.approved')||'Approved'), declined: (t('status.declined')||'Declined') }[s] || (s || ''));
        const fields = [
          [t('label.type')||'Type', typeLabel],
          [t('label.department')||'Department', String(docModel.category||'')],
          [t('label.docNumber')||'Document Number', String(docModel.documentNumber||'')],
          [t('label.status')||'Status', statusLabel(docModel.status)],
          [t('label.classification')||'Classification', docModel.classification ? (t(`option.classification.${docModel.classification}`) || (docModel.classification.charAt(0).toUpperCase()+docModel.classification.slice(1))) : ''],
          [t('label.effectiveDate')||'Effective Date', String(docModel.effectiveDate||'')],
          [t('label.nextReviewDate')||'Next Review Date', String(docModel.expiryDate||'')],
          [t('label.initiator')||'Initiator', String(docModel.owner||'')]
        ];
        
        // dynamic label width to avoid overlapping values (especially in FR)
        const allLabels = fields.map(([label]) => label).filter(Boolean);
        let labelW = 120;
        if (allLabels.length) {
          const measured = Math.max(...allLabels.map(lbl => pdf.getTextWidth(String(lbl + ':'))));
          labelW = Math.min(200, Math.max(120, measured + 8));
        }
        const valueGap = 10;
        
        fields.forEach(([label, value]) => {
          if (value) {
            ensureSpace(lineH + 4);
            pdf.setFont('helvetica','bold'); pdf.setTextColor(...labelColor);
            pdf.text(label + ':', x, y);
            pdf.setFont('helvetica','normal'); pdf.setTextColor(0,0,0);
            const valueLines = split(pdf, value, maxW - (labelW + valueGap));
            valueLines.forEach((line, idx) => {
              pdf.text(line, x + labelW + valueGap, y + idx * lineH);
            });
            y += Math.max(lineH, valueLines.length * lineH) + 4;
          }
        });
        y += 16; hr();
        const section = (name, text) => {
          pdf.setFont('helvetica','bold'); pdf.setFontSize(14); pdf.setTextColor(...primaryColor);
          ensureSpace(50);
          pdf.text(name, x, y);
          y += 12; pdf.setDrawColor(...accentColor); pdf.setLineWidth(1.5); pdf.line(x, y, pageW - x, y); y += 12;
          pdf.setFont('helvetica','normal'); pdf.setFontSize(11); pdf.setTextColor(0,0,0);
          y = drawWrapped(pdf, text || '', x, y, 16, maxW); y += 12;
        };
        section(t('label.purpose') || 'Purpose', docModel.purpose);
        section(t('label.scope') || 'Scope', docModel.scope);
        if ((docModel.definitions||[]).length) {
          pdf.setFont('helvetica','bold'); pdf.setFontSize(14); pdf.setTextColor(...primaryColor);
          pdf.text(t('section.definitions') || 'Definitions', x, y);
          y += 12; pdf.setDrawColor(...accentColor); pdf.setLineWidth(1.5); pdf.line(x, y, pageW - x, y); y += 12;
          pdf.setFont('helvetica','normal'); pdf.setFontSize(11); pdf.setTextColor(0,0,0);
          (docModel.definitions||[]).forEach(d => {
            const line = `${d.term ? '• ' + d.term + (d.text ? ' — ' : '') : '• '}${d.text || ''}`;
            y = drawWrapped(pdf, line, x, y, 16, maxW);
          });
          y += 12;
        }
        if ((docModel.roles||[]).length) {
          pdf.setFont('helvetica','bold'); pdf.setFontSize(14); pdf.setTextColor(...primaryColor);
          pdf.text(t('section.roles') || 'Roles & Responsibilities', x, y);
          y += 12; pdf.setDrawColor(...accentColor); pdf.setLineWidth(1.5); pdf.line(x, y, pageW - x, y); y += 12;
          pdf.setFont('helvetica','normal'); pdf.setFontSize(11); pdf.setTextColor(0,0,0);
          (docModel.roles||[]).forEach(r => {
            const line = `${r.role ? '• ' + r.role + (r.responsibility ? ' — ' : '') : '• '}${r.responsibility || ''}`;
            y = drawWrapped(pdf, line, x, y, 16, maxW);
          });
          y += 12;
        }
        
        if (docModel.distribution) section(t('label.distribution') || 'Distribution List', docModel.distribution);
        if (docModel.riskLevel) section(t('label.risk') || 'Risk Assessment', docModel.riskLevel);
        
        pdf.setFont('helvetica','bold'); pdf.setFontSize(14); pdf.setTextColor(...primaryColor);
        pdf.text(t('section.operatingProcedure') || 'Operating procedure', x, y);
        y += 12; pdf.setDrawColor(...accentColor); pdf.setLineWidth(1.5); pdf.line(x, y, pageW - x, y); y += 12;
        pdf.setFont('helvetica','normal'); pdf.setFontSize(11); pdf.setTextColor(0,0,0);
        (docModel.steps||[]).forEach((p) => {
          if (p.title) { 
            pdf.setFont('helvetica','bold'); pdf.setFontSize(12); pdf.setTextColor(...headingColor);
            y = drawWrapped(pdf, p.title, x, y, 16, maxW); 
            pdf.setFont('helvetica','normal'); pdf.setFontSize(11); pdf.setTextColor(0,0,0);
          }
          (p.steps||[]).forEach((s, i) => {
            const line = `${i+1}. ${s.name || (t('dyn.proc.stepName')||'Step')}${s.description ? ' — ' + s.description : ''}`;
            y = drawWrapped(pdf, line, x + 15, y, 16, maxW - 15);
          });
          y += 8;
        });
        y += 12;
        section(t('label.references') || 'References', docModel.references);
        const flowPng = await svgToPngDataUrl(this._lastFlowSvg, Math.min(700, maxW));
        if (flowPng) {
          if (y > pdf.internal.pageSize.getHeight() - (flowPng.height + bottomMargin + 20)) { pdf.addPage(); y = 70; }
          pdf.setFont('helvetica','bold'); pdf.setFontSize(14); pdf.setTextColor(...primaryColor);
          pdf.text((t('section.flowchart') || 'Process Flowchart'), x, y);
          y += 12; pdf.setDrawColor(...accentColor); pdf.setLineWidth(1.5); pdf.line(x, y, pageW - x, y); y += 12;
          pdf.addImage(flowPng.dataUrl, 'PNG', x, y, flowPng.width, flowPng.height);
        }
        // Enhanced footer with branding
        const pageCount = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          pdf.setPage(i);
          pdf.setDrawColor(...primaryColor); pdf.setLineWidth(1.0);
          pdf.line(50, pageH - 40, pageW - 50, pageH - 40);
          pdf.setFont('helvetica','normal'); pdf.setFontSize(9); pdf.setTextColor(...mutedColor);
          pdf.text(`Page ${i} of ${pageCount}`, pageW/2, pageH - 25, { align: 'center' });
          const companyFooter = String((document.getElementById('headerCompanyName')?.textContent) || '');
          if (companyFooter) pdf.text(companyFooter, 50, pageH - 25);
          // Add document number on the right
          const docNumber = String(docModel.documentNumber || '');
          if (docNumber) {
            const docLabel = t('label.docNumber') || 'Document Number';
            pdf.text(`${docLabel}: ${docNumber}`, pageW - 50, pageH - 25, { align: 'right' });
          }
        }
        pdf.save(`${(docModel.title||'document').replace(/[^a-z0-9\-_]+/gi,'_')}.pdf`);
      },
      async exportDocx() {
        if (!window.docx) return alert('DOCX engine not available');
        const { Document, Packer, Paragraph, HeadingLevel, ImageRun } = window.docx;
        const m = this.buildDocModel();
        if (!this._lastFlowSvg) { await this.renderFlowchart(); }
        const dataUrlToUint8 = async (dataUrl) => { const res = await fetch(dataUrl); const buf = await res.arrayBuffer(); return new Uint8Array(buf); };
        const svgToPngDataUrl = async (svgString, width = 1200) => new Promise((resolve) => {
          if (!svgString) return resolve(null);
          const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = () => {
            const w = width; const h = Math.max(200, Math.floor((img.height / img.width) * w));
            const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
            const out = canvas.toDataURL('image/png'); URL.revokeObjectURL(url); resolve({ dataUrl: out, width: w, height: h });
          };
          img.onerror = () => { URL.revokeObjectURL(url); resolve(null); };
          img.src = url;
        });
        const imgUrlToPngDataUrl = async (url, maxW = 300) => new Promise((resolve) => {
          if (!url) return resolve(null);
          const img = new Image(); img.crossOrigin = 'anonymous';
          img.onload = () => {
            const ratio = img.height / img.width; const w = Math.min(maxW, img.width); const h = Math.round(w * ratio);
            const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,w,h); ctx.drawImage(img,0,0,w,h);
            resolve({ dataUrl: canvas.toDataURL('image/png'), width: w, height: h });
          };
          img.onerror = () => resolve(null);
          img.src = url;
        });
        const logoEl = document.getElementById('headerCompanyLogo');
        const logo = await imgUrlToPngDataUrl(logoEl && logoEl.src ? logoEl.src : null, 300);
        const flow = await svgToPngDataUrl(this._lastFlowSvg, 1200);
        const paras = [];
        if (logo) { paras.push(new Paragraph({ children: [ new ImageRun({ data: await dataUrlToUint8(logo.dataUrl), transformation: { width: 120, height: Math.round(120*(logo.height/logo.width)) } }) ] })); }
        paras.push(new Paragraph({ text: m.title || 'Untitled Document', heading: HeadingLevel.TITLE }));
        paras.push(new Paragraph({ text: `${(document.getElementById('headerCompanyName')?.textContent)||''} • ${m.type}` }));
        paras.push(new Paragraph({ text: 'Purpose', heading: HeadingLevel.HEADING_2 }));
        (m.purpose||'').split('\n').forEach(s=>paras.push(new Paragraph(s)));
        paras.push(new Paragraph({ text: 'Scope', heading: HeadingLevel.HEADING_2 }));
        (m.scope||'').split('\n').forEach(s=>paras.push(new Paragraph(s)));
        if ((m.definitions||[]).length) { 
          paras.push(new Paragraph({ text: 'Definitions', heading: HeadingLevel.HEADING_2 }));
          (m.definitions||[]).forEach(d => {
            const text = `${d.term ? d.term + (d.text ? ' — ' : '') : ''}${d.text || ''}`;
            paras.push(new Paragraph(text));
          });
        }
  if (m.owner) { paras.push(new Paragraph({ text: 'Initiator', heading: HeadingLevel.HEADING_2 })); paras.push(new Paragraph(m.owner)); }
        
        if (m.effectiveDate) { paras.push(new Paragraph({ text: 'Effective Date', heading: HeadingLevel.HEADING_2 })); paras.push(new Paragraph(m.effectiveDate)); }
        if (m.expiryDate) { paras.push(new Paragraph({ text: 'Next Review Date', heading: HeadingLevel.HEADING_2 })); paras.push(new Paragraph(m.expiryDate)); }
        if (m.classification) { paras.push(new Paragraph({ text: 'Classification', heading: HeadingLevel.HEADING_2 })); paras.push(new Paragraph(m.classification.charAt(0).toUpperCase() + m.classification.slice(1))); }
        if ((m.roles||[]).length) { 
          paras.push(new Paragraph({ text: 'Roles & Responsibilities', heading: HeadingLevel.HEADING_2 }));
          (m.roles||[]).forEach(r => {
            const text = `${r.role ? r.role + (r.responsibility ? ' — ' : '') : ''}${r.responsibility || ''}`;
            paras.push(new Paragraph(text));
          });
        }
        
        if (m.distribution) { paras.push(new Paragraph({ text: 'Distribution List', heading: HeadingLevel.HEADING_2 })); (m.distribution||'').split('\n').forEach(s=>paras.push(new Paragraph(s))); }
        if (m.riskLevel) { 
          paras.push(new Paragraph({ text: 'Risk Assessment', heading: HeadingLevel.HEADING_2 })); 
          (m.riskLevel||'').split('\n').forEach(s=>paras.push(new Paragraph(s))); 
        }
        
        paras.push(new Paragraph({ text: 'Operating procedure', heading: HeadingLevel.HEADING_2 }));
        (m.steps||[]).forEach((p)=>{
          if (p.title) { paras.push(new Paragraph({ text: p.title, heading: HeadingLevel.HEADING_3 })); }
          (p.steps||[]).forEach((s,i)=>{
            const text = `${i+1}. ${s.name || 'Step'}${s.description ? ' — ' + s.description : ''}`;
            paras.push(new Paragraph(text));
          });
        });
        paras.push(new Paragraph({ text: 'References', heading: HeadingLevel.HEADING_2 }));
        (m.references||'').split('\n').forEach(s=>paras.push(new Paragraph(s)));
        if (flow) {
          paras.push(new Paragraph({ text: 'Process Flowchart', heading: HeadingLevel.HEADING_2 }));
          const flowW = 600; const flowH = Math.round(flowW * (flow.height/flow.width));
          paras.push(new Paragraph({ children: [ new ImageRun({ data: await dataUrlToUint8(flow.dataUrl), transformation: { width: flowW, height: flowH } }) ] }));
        }
        const docxDoc = new Document({ sections: [{ children: paras }] });
        const blob = await Packer.toBlob(docxDoc);
        window.saveAs(blob, `${(m.title||'document').replace(/[^a-z0-9\-_]+/gi,'_')}.docx`);
      },
      async fetchApprovalFlowConfig() {
        try {
          const ctx = await this.loadCompanyContext();
          if (!ctx) return;
          const { companyId } = ctx;
          const snap = await this.db.ref(`companies/${companyId}/approvalFlows/dms`).once('value');
          this._approvalFlow = snap.exists() ? snap.val() : null;
        } catch (e) { console.warn('Approval flow fetch error', e); }
      },
      async loadDocumentFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const docId = params.get('doc');
        const mode = params.get('mode');
        const autoPdf = params.get('autopdf') === '1';
        const local = this.tryLoadLocalDraft(docId || this.getDocId());
        if (local) this.fillEditorFromModel(local);
        if (!docId) return;
        const ctx = await this.loadCompanyContext();
        if (!ctx) return;
        try {
          const snap = await this.db.ref(`companies/${ctx.companyId}/dms/documents/${docId}`).once('value');
          if (snap.exists()) {
            const doc = snap.val();
            
            // Always store the loaded document
            this._loadedDoc = doc;
            
            // For PDF export, also load the approval status to get the correct status
            if (autoPdf) {
              try {
                const statusSnap = await this.db.ref(`companies/${ctx.companyId}/dms/documents/${docId}/approvalStatus`).once('value');
                const approvalStatus = statusSnap.val();
                
                // Determine the actual status based on approval status
                let actualStatus = doc.status || 'draft';
                if (approvalStatus) {
                  if (approvalStatus.state === 'approved') {
                    actualStatus = 'approved';
                  } else if (approvalStatus.state === 'declined') {
                    actualStatus = 'declined';
                  } else if (approvalStatus.state === 'pending') {
                    actualStatus = 'in_review';
                  }
                }
                
                // Update the stored document with the correct status for PDF generation
                this._loadedDoc = { ...doc, status: actualStatus };
                this._approvalStatus = approvalStatus;
              } catch (e) {
                console.warn('Could not load approval status for PDF', e);
              }
            }
            
            // Build comprehensive revision history
            const comprehensiveHistory = await this.buildComprehensiveRevisionHistory(docId);
            const docWithHistory = { ...doc, revisionHistory: comprehensiveHistory };
            
            this.fillEditorFromModel(docWithHistory);
            if (mode === 'view') {
              // disable inputs
              document.querySelectorAll('#tab-editor input, #tab-editor textarea, #tab-editor select, #addProcedureBtn, #saveDraftBtn, #submitReviewBtn').forEach(el => { el.disabled = true; el.style.opacity = .7; });
            }
            if (autoPdf) {
              // ensure preview/flowchart rendered then export
              try {
                await this.renderFlowchart();
              } catch (e) {}
              setTimeout(() => this.exportPdf(), 300);
            }
          }
        } catch (e) { console.warn('Doc load error', e); }
      }
      ,
      fillEditorFromModel(m) {
        if (!m) return;
        const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
        set('docTitle', m.title);
        set('docType', m.type);
        set('docCategory', m.category);
        set('docNumber', m.documentNumber);
        set('docEffectiveDate', m.effectiveDate);
        set('docExpiryDate', m.expiryDate);
        set('docClassification', m.classification);
        set('docOwner', m.owner);
  set('docDefTerm', m.definitionTerm);
  set('docDefText', m.definitionText);
        set('docDistribution', m.distribution);
  set('docRisk', m.riskLevel || m.risk);
        set('docPurpose', m.purpose);
        set('docScope', m.scope);
        set('docReferences', m.references);
        set('docRevision', m.revisionHistory || m.revision);
        // Operating procedure (load)
        const proceduresContainer = document.getElementById('proceduresContainer');
        proceduresContainer.innerHTML = '';
        const addStepRowLoad = (stepsHost, name = '', description = '') => {
          const div = document.createElement('div');
          div.className = 'step';
          div.style.display = 'grid';
          div.style.gridTemplateColumns = '1fr auto';
          div.style.gridTemplateRows = 'auto auto';
          div.style.gap = '.5rem';
          div.style.margin = '6px 0';
          div.innerHTML = `
            <input class="step-name" type="text" placeholder="Step name" value="${(name||'').replace(/"/g,'&quot;')}">
            <button class="btn ghost" type="button" title="Remove">&times;</button>
            <textarea class="step-desc" rows="3" placeholder="Description" style="grid-column: 1 / span 2;">${(description||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
          `;
          const nameEl = div.querySelector('.step-name');
          const descEl = div.querySelector('.step-desc');
          [nameEl, descEl].forEach(el => el.addEventListener('input', () => this.persistLocalDraft()));
          const rBtn = div.querySelector('button');
          rBtn.addEventListener('click', () => { div.remove(); this.persistLocalDraft(); });
          stepsHost.appendChild(div);
        };
        const addProcedureLoad = (title = '', steps = []) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'procedure';
          wrapper.style.border = '1px solid #e5e7eb';
          wrapper.style.borderRadius = '8px';
          wrapper.style.padding = '.75rem';
          wrapper.style.margin = '8px 0';
          wrapper.innerHTML = `
            <div style="display:grid;grid-template-columns:1fr auto;gap:.5rem;align-items:center;margin-bottom:.5rem;">
              <input class="proc-title" type="text" placeholder="Procedure title (e.g., Transport)" value="${(title||'').replace(/"/g,'&quot;')}">
              <div>
                <button class="btn ghost add-step" type="button" title="Add step"><i class="fas fa-plus"></i> Add Step</button>
                <button class="btn ghost" type="button" title="Remove procedure">&times;</button>
              </div>
            </div>
            <div class="steps"></div>
          `;
          const titleEl = wrapper.querySelector('.proc-title');
          titleEl.addEventListener('input', () => this.persistLocalDraft());
          const rmProcBtn = wrapper.querySelectorAll('button')[1];
          rmProcBtn.addEventListener('click', () => { wrapper.remove(); this.persistLocalDraft(); });
          const addStepBtn = wrapper.querySelector('.add-step');
          const stepsHost = wrapper.querySelector('.steps');
          addStepBtn.addEventListener('click', () => addStepRowLoad(stepsHost, '', ''));
          if (!steps || !steps.length) {
            addStepRowLoad(stepsHost, 'Start', '');
          } else {
            steps.forEach(s => addStepRowLoad(stepsHost, s.name || '', s.description || ''));
          }
          proceduresContainer.appendChild(wrapper);
        };
        if (Array.isArray(m.steps) && m.steps.length) {
          m.steps.forEach(p => addProcedureLoad(p.title || '', p.steps || []));
        } else {
          addProcedureLoad('', []);
        }
        // Roles
        const rolesContainer = document.getElementById('rolesContainer');
        if (rolesContainer) {
          rolesContainer.innerHTML = '';
          const addRow = (role='', responsibility='') => {
            const row = document.createElement('div');
            row.style.display = 'grid'; row.style.gridTemplateColumns = '1fr 3fr auto'; row.style.gap = '.5rem'; row.style.margin = '6px 0';
            row.innerHTML = `
              <input type=\"text\" placeholder=\"Role\" value=\"${(role||'').replace(/\"/g,'&quot;')}\">
              <input type=\"text\" placeholder=\"Responsibility\" value=\"${(responsibility||'').replace(/\"/g,'&quot;')}\">
              <button class=\"btn ghost\" type=\"button\" title=\"Remove\">&times;</button>
            `;
            const rBtn = row.querySelector('button'); rBtn.addEventListener('click', () => row.remove());
            rolesContainer.appendChild(row);
          };
          (Array.isArray(m.roles) ? m.roles : []).forEach(r => addRow(r.role, r.responsibility));
        }
        // Definitions
        const defContainer = document.getElementById('definitionsContainer');
        if (defContainer) {
          defContainer.innerHTML = '';
          const addRow = (term='', text='') => {
            const row = document.createElement('div');
            row.style.display = 'grid'; row.style.gridTemplateColumns = '1fr 3fr auto'; row.style.gap = '.5rem'; row.style.margin = '6px 0';
            row.innerHTML = `
              <input type="text" placeholder="Term" value="${(term||'').replace(/"/g,'&quot;')}">
              <input type="text" placeholder="Definition" value="${(text||'').replace(/"/g,'&quot;')}">
              <button class="btn ghost" type="button" title="Remove">&times;</button>
            `;
            const rBtn = row.querySelector('button'); rBtn.addEventListener('click', () => row.remove());
            defContainer.appendChild(row);
          };
          (m.definitions||[]).forEach(d => addRow(d.term, d.text));
        }
      }
    };

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => Auth.init());
  </script>
</body>
<script>
  (function() {
    const i18n = {
      en: {
        'misc.untitled': 'Untitled Document',
        'section.flowchart': 'Process Flowchart',
        'section.summary': 'Summary',
        'preview.noSteps': 'No steps',
        'preview.noProcedures': 'No operating procedure',
        'tab.editor': 'Editor',
        'tab.preview': 'Preview',
        'tab.flowchart': 'Flowchart',
        'label.title': 'Title',
        'label.type': 'Type',
        'label.department': 'Department',
        'label.docNumber': 'Document Number',
        'label.effectiveDate': 'Effective Date',
        'label.nextReviewDate': 'Next Review Date',
        'label.classification': 'Classification',
        'label.initiator': 'Initiator',
        'label.approver': 'Approver',
        'label.purpose': 'Purpose',
        'label.scope': 'Scope',
        'section.definitions': 'Definitions',
        'btn.addDefinition': 'Add Definition',
        'section.roles': 'Roles & Responsibilities',
        'btn.addRole': 'Add Role',
        'label.training': 'Training Requirements',
        'label.compliance': 'Compliance References',
        'label.distribution': 'Distribution List',
        'label.risk': 'Risk Assessment',
        'label.revision': 'Revision History',
        'label.legacy': 'Legacy Responsibilities',
        'section.operatingProcedure': 'Operating procedure',
        'btn.addProcedure': 'Add Operating procedure',
        'label.references': 'References',
        'btn.saveDraft': 'Save Draft',
        'btn.submitReview': 'Submit for Review',
        'option.type.procedure': 'Procedure',
        'option.type.policy': 'Policy',
        'option.type.work_instruction': 'Work Instruction',
        'option.type.form': 'Form',
        'option.type.guideline': 'Guideline',
        'option.type.standard': 'Standard',
        'option.type.manual': 'Manual',
        'option.type.checklist': 'Checklist',
        'option.classification.public': 'Public',
        'option.classification.internal': 'Internal',
        'option.classification.confidential': 'Confidential',
        'option.classification.restricted': 'Restricted',
        // placeholders
        'ph.docTitle': 'e.g., Incident Reporting Procedure',
        'ph.department': 'Department',
        'ph.docNumber': 'e.g., HSE-PROC-001',
        'ph.initiator': 'Initiator (auto)',
        'ph.approver': 'Name or role of approving authority',
        'ph.purpose': 'Define the objective and rationale for this document',
        'ph.scope': 'Define what is covered and what is excluded',
        'ph.training': 'Specify any training required for personnel affected by this document',
        'ph.compliance': 'List applicable regulations, standards, or legal requirements (e.g., ISO 9001, OSHA, etc.)',
        'ph.distribution': 'Specify roles, departments, or individuals who should receive this document',
        'ph.risk': 'Describe potential risks and impacts if this document is not followed',
        'ph.revision': 'Summary of changes in this version',
        'ph.legacy': 'One per line (role: responsibility)',
        'ph.references': 'Link or reference notes',
        // dynamic blocks
        'dyn.def.term': 'Term',
        'dyn.def.definition': 'Definition',
        'dyn.role.role': 'Role',
        'dyn.role.responsibility': 'Responsibility',
        'dyn.proc.title': 'Operating procedure title',
        'dyn.proc.stepName': 'Step name',
        'dyn.proc.stepDesc': 'Step description'
      },
      fr: {
        'misc.untitled': 'Document sans titre',
        'section.flowchart': 'Organigramme du processus',
        'section.summary': 'Résumé',
        'preview.noSteps': 'Aucune étape',
        'preview.noProcedures': 'Aucune procédure opérationnelle',
        'tab.editor': 'Éditeur',
        'tab.preview': 'Aperçu',
        'tab.flowchart': 'Organigramme',
        'label.title': 'Titre',
        'label.type': 'Type',
        'label.department': 'Département',
        'label.docNumber': 'Numéro du document',
        'label.effectiveDate': 'Date d’entrée en vigueur',
        'label.nextReviewDate': 'Prochaine date de révision',
        'label.classification': 'Classification',
        'label.initiator': 'Initiateur',
        'label.approver': 'Approbateur',
        'label.purpose': 'Objectif',
        'label.scope': 'Périmètre',
        'section.definitions': 'Définitions',
        'btn.addDefinition': 'Ajouter une définition',
        'section.roles': 'Rôles et responsabilités',
        'btn.addRole': 'Ajouter un rôle',
        'label.training': 'Exigences de formation',
        'label.compliance': 'Références de conformité',
        'label.distribution': 'Liste de distribution',
        'label.risk': 'Évaluation des risques',
        'label.revision': 'Historique des révisions',
        'label.legacy': 'Responsabilités héritées',
        'section.operatingProcedure': 'Procédure opérationnelle',
        'btn.addProcedure': 'Ajouter une procédure opérationnelle',
        'label.references': 'Références',
        'btn.saveDraft': 'Enregistrer le brouillon',
        'btn.submitReview': 'Soumettre pour révision',
        'option.type.procedure': 'Procédure',
        'option.type.policy': 'Politique',
        'option.type.work_instruction': 'Instruction de travail',
        'option.type.form': 'Formulaire',
        'option.type.guideline': 'Guide',
        'option.type.standard': 'Norme',
        'option.type.manual': 'Manuel',
        'option.type.checklist': 'Liste de contrôle',
        'option.classification.public': 'Public',
        'option.classification.internal': 'Interne',
        'option.classification.confidential': 'Confidentiel',
        'option.classification.restricted': 'Restreint',
        // placeholders
        'ph.docTitle': 'ex.: Procédure de déclaration d’incident',
        'ph.department': 'Département',
        'ph.docNumber': 'ex.: HSE-PROC-001',
        'ph.initiator': 'Initiateur (auto)',
        'ph.approver': 'Nom ou rôle de l’autorité approbatrice',
        'ph.purpose': 'Définir l’objectif et la raison d’être de ce document',
        'ph.scope': 'Définir ce qui est couvert et ce qui est exclu',
        'ph.training': 'Préciser les formations requises pour le personnel concerné',
        'ph.compliance': 'Lister les règlements, normes ou exigences légales applicables (ex.: ISO 9001, OSHA, etc.)',
        'ph.distribution': 'Préciser les rôles, départements ou personnes devant recevoir ce document',
        'ph.risk': 'Décrire les risques potentiels et impacts si ce document n’est pas respecté',
        'ph.revision': 'Résumé des changements dans cette version',
        'ph.legacy': 'Une par ligne (rôle : responsabilité)',
        'ph.references': 'Lien ou notes de référence',
        // dynamic blocks
        'dyn.def.term': 'Terme',
        'dyn.def.definition': 'Définition',
        'dyn.role.role': 'Rôle',
        'dyn.role.responsibility': 'Responsabilité',
        'dyn.proc.title': 'Titre de la procédure opérationnelle',
        'dyn.proc.stepName': 'Nom de l’étape',
        'dyn.proc.stepDesc': 'Description de l’étape'
      }
    };

    function t(key) {
      const lang = localStorage.getItem('app_lang') || 'en';
      return (i18n[lang] && i18n[lang][key]) || (i18n.en[key] || '');
    }

    function applyI18n(root=document) {
      const nodes = root.querySelectorAll('[data-i18n]');
      nodes.forEach(el => {
        const key = el.getAttribute('data-i18n');
        const val = t(key);
        if (val) el.textContent = val;
      });
      const phNodes = root.querySelectorAll('[data-i18n-placeholder]');
      phNodes.forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        const val = t(key);
        if (val) el.setAttribute('placeholder', val);
      });
      // translate <option data-i18n="...">
      const optNodes = root.querySelectorAll('option[data-i18n]');
      optNodes.forEach(el => {
        const key = el.getAttribute('data-i18n');
        const val = t(key);
        if (val) el.textContent = val;
      });
  }

    function translateDynamicBlocks() {
      // Definitions rows
      document.querySelectorAll('#definitionsContainer .definition-row').forEach(row => {
        const term = row.querySelector('input[name="term"]');
        const def = row.querySelector('input[name="definition"]');
        if (term && !term.getAttribute('data-i18n-placeholder')) term.setAttribute('data-i18n-placeholder','dyn.def.term');
        if (def && !def.getAttribute('data-i18n-placeholder')) def.setAttribute('data-i18n-placeholder','dyn.def.definition');
      });

      // Roles rows
      document.querySelectorAll('#rolesContainer .role-row').forEach(row => {
        const role = row.querySelector('input[name="role"]');
        const resp = row.querySelector('input[name="responsibility"]');
        if (role && !role.getAttribute('data-i18n-placeholder')) role.setAttribute('data-i18n-placeholder','dyn.role.role');
        if (resp && !resp.getAttribute('data-i18n-placeholder')) resp.setAttribute('data-i18n-placeholder','dyn.role.responsibility');
      });

      // Procedures and steps
      document.querySelectorAll('#proceduresContainer .procedure-block').forEach(block => {
        const titleInput = block.querySelector('input[name="procedureTitle"]');
        if (titleInput && !titleInput.getAttribute('data-i18n-placeholder')) titleInput.setAttribute('data-i18n-placeholder','dyn.proc.title');
        block.querySelectorAll('.step-row').forEach(stepRow => {
          const sname = stepRow.querySelector('input[name="stepName"]');
          const sdesc = stepRow.querySelector('textarea[name="stepDescription"]');
          if (sname && !sname.getAttribute('data-i18n-placeholder')) sname.setAttribute('data-i18n-placeholder','dyn.proc.stepName');
          if (sdesc && !sdesc.getAttribute('data-i18n-placeholder')) sdesc.setAttribute('data-i18n-placeholder','dyn.proc.stepDesc');
        });
      });
      applyI18n(document);
    }

    function initI18n() {
      const sel = document.getElementById('langSelect');
      const saved = localStorage.getItem('app_lang') || 'en';
      if (sel) sel.value = saved;
      applyI18n(document);
      translateDynamicBlocks();
      if (sel) sel.addEventListener('change', () => {
        localStorage.setItem('app_lang', sel.value);
        applyI18n(document);
        translateDynamicBlocks();
        const previewTabActive = document.getElementById('tab-preview')?.classList.contains('active');
        if (previewTabActive && window.Auth && typeof window.Auth.renderPreview === 'function') {
          try { window.Auth.renderPreview(); } catch {}
        }
      });

      // Observe dynamic DOM changes to apply i18n placeholders for newly added items
      const observer = new MutationObserver((mutations) => {
        let needs = false;
        for (const m of mutations) {
          if (m.addedNodes && m.addedNodes.length) { needs = true; break; }
        }
        if (needs) translateDynamicBlocks();
      });
      const defs = document.getElementById('definitionsContainer');
      const roles = document.getElementById('rolesContainer');
      const procs = document.getElementById('proceduresContainer');
      if (defs) observer.observe(defs, { childList: true, subtree: true });
      if (roles) observer.observe(roles, { childList: true, subtree: true });
      if (procs) observer.observe(procs, { childList: true, subtree: true });
    }

    // expose minimal hooks for other code
    window.__i18nApply = applyI18n;
    window.__i18nT = t;
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initI18n);
    } else {
      initI18n();
    }
  })();
</script>
</html>
