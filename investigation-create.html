<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Investigation - Dreamex Datalab</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase v8 Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --sidebar-width: 250px;
            --transition-speed: .25s;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f7fa; color: #222; overflow: hidden; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--primary-color); color: #fff; padding: 1rem; position: fixed; top: 0; left: 0; bottom: 0; overflow-y: auto; transition: transform .3s ease; z-index: 1000; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 0.3rem; padding-top: 3.2rem; transition: margin-left .3s ease; height: 100vh; overflow: hidden; }
        .main-content.sidebar-collapsed { margin-left: 0; }
        .main-content.sidebar-collapsed .top-nav { left: 0.5rem; }
        .logo h2 { text-align: center; padding: 1rem 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.05rem; letter-spacing: .5px; }
        .menu { list-style: none; margin-top: 2rem; }
        .menu li { margin-bottom: 0.45rem; }
        .menu a { display: flex; align-items: center; gap: 10px; color: #fff; text-decoration: none; padding: 0.6rem 0.75rem; border-radius: 6px; font-size: 0.82rem; font-weight: 500; transition: background .25s; }
        .menu a:hover, .menu a.active { background: rgba(255,255,255,0.12); }
        .submenu { list-style: none; margin-left: 0.75rem; display: none; margin-top: 0.25rem; }
        .menu-dropdown:hover .submenu { display: block; }
        .submenu a { font-size: 0.75rem; padding: 0.45rem 0.65rem; }
        
        /* Menu Visibility Styles */
        [data-feature]:not(.menu-visible) { display: none !important; }
        .menu-dropdown:not(.menu-visible) { display: none !important; }
        .sidebar.menu-loading .menu-item, .sidebar.menu-loading .menu-dropdown, .sidebar.menu-loading li[data-feature], .sidebar.menu-loading [data-feature] { display: none !important; }
        .sidebar.menu-loading .menu-visible, .sidebar.menu-loading li.menu-visible, .sidebar.menu-loading [data-feature].menu-visible { display: block !important; }
        .menu-loading [data-feature] { display: none !important; }
        .menu-loading .menu-dropdown { display: none !important; }
        .menu-visible { display: block !important; }
        li.menu-visible, [data-feature].menu-visible { display: block !important; }

    .top-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0.75rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:0.3rem; position:fixed; top:0.25rem; right:0.5rem; left:calc(var(--sidebar-width) + 0.5rem); height:50px; min-height:50px; z-index:100; transition:left 0.3s ease; }
    .sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
    .top-nav-left { display:flex; align-items:center; gap:0.75rem; }
    .company-branding { display:flex; align-items:center; gap:0.5rem; }
    #headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
    /* Show the logo once AuthManager sets it */
    #headerCompanyLogo.visible { display:inline-block; }
    #headerCompanyName { font-weight:600; font-size:0.85rem; }
    .header-company-logo { height:32px; width:auto; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .company-name-header { font-weight:700; color:var(--dark-color); font-size:1rem; letter-spacing:0.5px; white-space:nowrap; }
    .top-nav-right { display:flex; align-items:center; gap:1rem; }
    .notifications { position:relative; display:flex; align-items:center; }
    .notification-btn { background:none; border:none; cursor:pointer; position:relative; font-size:1.2rem; padding:0.5rem; display:flex; align-items:center; justify-content:center; }
    .notification-badge { position:absolute; top:-5px; right:-5px; background-color:var(--accent-color); color:white; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.7rem; display:none; }
    .notification-dropdown { display:none; position:absolute; right:0; top:100%; width:320px; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); z-index:1000; border:1px solid #e9ecef; max-height:400px; overflow:hidden; }
    .notification-dropdown.show { display:block; animation: slideDown 0.2s ease-out; }
    @keyframes slideDown { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
    .notification-header { padding:12px 16px; border-bottom:1px solid #e9ecef; background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%); display:flex; justify-content:space-between; align-items:center; }
    .notification-header h3 { margin:0; color:#333; font-size:14px; font-weight:600; }
    .mark-all-read { background:none; border:none; color:#3498db; cursor:pointer; font-size:12px; padding:4px 8px; border-radius:4px; transition:all .2s ease; }
    .mark-all-read:hover { background:#e3f2fd; color:#1976d2; }
    .clear-all-notifications { background:none; border:none; color:#e74c3c; cursor:pointer; font-size:12px; padding:4px 8px; border-radius:4px; transition:all .2s ease; margin-left:8px; }
    .clear-all-notifications:hover { background:#fdf2f2; color:#c0392b; }
    .notification-list { max-height:320px; overflow-y:auto; padding:0; }
    .notification-list::-webkit-scrollbar { width:4px; }
    .notification-list::-webkit-scrollbar-track { background:#f1f1f1; }
    .notification-list::-webkit-scrollbar-thumb { background:#c1c1c1; border-radius:2px; }
    .notification-item { padding:12px 16px; border-bottom:1px solid #f1f1f1; cursor:pointer; transition:background-color .2s ease; position:relative; }
    .notification-item:hover { background:#f8f9fa; }
    .notification-item.unread { background:#e8f4fd; border-left:3px solid #3498db; }
    .notification-dot { position:absolute; top:16px; right:16px; width:8px; height:8px; background:#3498db; border-radius:50%; }
    .notification-actions { position:absolute; top:8px; right:8px; display:none; gap:4px; }
    .notification-item:hover .notification-actions { display:flex; }
    .mark-read-btn, .delete-notification-btn { background:none; border:none; cursor:pointer; padding:4px; border-radius:3px; transition:all .2s ease; font-size:12px; }
    .mark-read-btn { color:#3498db; }
    .mark-read-btn:hover { background:#e3f2fd; color:#1976d2; }
    .delete-notification-btn { color:#e74c3c; }
    .delete-notification-btn:hover { background:#fdf2f2; color:#c0392b; }
    .notification-empty { padding:40px 20px; text-align:center; color:#999; display:none; }
    .notification-empty i { font-size:32px; margin-bottom:12px; color:#ddd; }
    .notification-empty-title { font-size:14px; font-weight:500; margin-bottom:4px; color:#666; }
    .notification-empty-message { font-size:12px; color:#999; }
    .user-profile { position:relative; }
    .profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
    .profile-btn img { width:100%; height:100%; object-fit:cover; }
    .profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; }
    .profile-dropdown.show { display:block; }
    .profile-dropdown ul { list-style:none; }
    .profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
    .profile-dropdown li a:hover { background:#f1f5f9; }

        /* Content Styles */
        .content { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 0; overflow: hidden; display: flex; flex-direction: column; height: calc(100vh - 4.5rem); }
        .page-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; padding: 0.55rem 0.75rem; border-radius: 0; margin: 0.35rem 0 0.5rem 0; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14); font-size: 0.9rem; }
        .page-header h1 { color: #fff; display: flex; align-items: center; gap: 0.6rem; font-size: 0.9rem; margin: 0; font-weight: 600; }

        /* Tab Navigation - Enhanced pill style (aligned with staff UI feel) */
        .tab-navigation {
            display: flex;
            gap: 0.5rem;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 0.5rem;
            margin: 0;
            overflow-x: auto;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .tab-navigation::-webkit-scrollbar { height: 6px; }
        .tab-navigation::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .tab-btn {
            padding: 0.5rem 0.9rem;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            cursor: pointer;
            font-size: 0.74rem;
            font-weight: 600;
            color: #475569;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-radius: 999px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .tab-btn:hover { background: #f3f4f6; border-color: #d1d5db; }
        .tab-btn.active {
            color: #0ea5e9;
            background: #e0f2fe;
            border-color: #7dd3fc;
            box-shadow: 0 2px 6px rgba(14,165,233,0.15);
        }

        /* Tab Content */
        .tab-content { display: none; padding: 1rem; overflow-y: auto; }
        .tab-content.active { display: block; flex: 1; }

        /* Form Styles */
        .form-section { margin-bottom: 2rem; }
        .section-title { font-size: 1.1rem; font-weight: 600; color: #374151; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e5e7eb; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group label { font-size: 0.85rem; font-weight: 600; color: #374151; }
        .form-group input, .form-group select, .form-group textarea { padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.85rem; }
        .form-group textarea { min-height: 100px; resize: vertical; }

        /* File Upload */
        .file-upload { border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .file-upload:hover { border-color: #3b82f6; background: #f8fafc; }
        .file-upload input { display: none; }
        .file-preview { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem; }
        .file-item { position: relative; display: inline-block; margin: 0.5rem; }
        .file-item img { width: 100px; height: 100px; object-fit: cover; border-radius: 6px; }
        .file-item .remove-btn { position: absolute; top: -5px; right: -5px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 0.7rem; }

        /* Timeline Styles */
        .timeline-container { margin-top: 1rem; }
        .timeline-item { display: flex; gap: 0.75rem; margin-bottom: 1rem; padding: 0.6rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; }
        .timeline-time { min-width: 100px; font-weight: 600; color: #374151; }
        .timeline-content { flex: 1; }
        .timeline-content h4 { color: #1f2937; margin-bottom: 0.5rem; }
        .timeline-content p { color: #64748b; }
        .timeline-actions { display: flex; gap: 0.5rem; }
        .timeline-btn { padding: 0.25rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; }
        .btn-edit-timeline { background: #dcfce7; color: #059669; }
        .btn-delete-timeline { background: #fee2e2; color: #dc2626; }

        /* Chart Container */
        .chart-container { margin-top: 2rem; background: #f8fafc; padding: 1.5rem; border-radius: 8px; }
        .chart-wrapper { position: relative; height: 400px; }

        /* Chronological Event Timeline Visualization */
        .event-timeline-viz { position: relative; padding: 1rem 0; }
        .event-timeline-viz .timeline-track { display: flex; flex-wrap: wrap; align-items: flex-start; position: relative; padding: 0 0.5rem; gap: 6rem 0; }
        .event-timeline-viz .timeline-event-node { display: flex; flex-direction: column; align-items: center; min-width: 110px; max-width: 140px; width: calc(16.66% - 0.25rem); position: relative; z-index: 1; padding: 0.25rem; margin-bottom: 4.5rem; }
        .event-timeline-viz .event-time-badge { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: #fff; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.68rem; font-weight: 600; margin-bottom: 0.35rem; box-shadow: 0 2px 6px rgba(59,130,246,0.3); z-index: 2; }
        .event-timeline-viz .event-dot { width: 14px; height: 14px; background: #fff; border: 3px solid #3b82f6; border-radius: 50%; margin-bottom: 0.35rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 2; }
        .event-timeline-viz .event-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.4rem; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06); width: 100%; z-index: 2; }
        .event-timeline-viz .event-card .event-title { font-weight: 600; color: #1e293b; font-size: 0.72rem; margin-bottom: 0.15rem; word-break: break-word; }
        .event-timeline-viz .event-card .event-desc { color: #64748b; font-size: 0.68rem; word-break: break-word; }
        .event-timeline-viz .timeline-empty { text-align: center; color: #94a3b8; padding: 1.5rem; font-size: 0.85rem; }
        /* Timeline connectors */
        .event-timeline-viz .timeline-connector { position: absolute; background: linear-gradient(90deg, #3b82f6, #8b5cf6); z-index: 0; }
        .event-timeline-viz .timeline-connector.horizontal { height: 3px; }
        .event-timeline-viz .timeline-connector.vertical { width: 3px; }
        .event-timeline-viz .timeline-connector .arrow { position: absolute; width: 0; height: 0; }
        .event-timeline-viz .timeline-connector .arrow-right { right: -6px; top: -4px; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 7px solid #8b5cf6; }
        .event-timeline-viz .timeline-connector .arrow-down { bottom: -6px; left: -4px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 7px solid #8b5cf6; }
        /* Draggable timeline nodes */
        .event-timeline-viz .timeline-event-node { cursor: grab; transition: transform 0.15s ease, box-shadow 0.15s ease; }
        .event-timeline-viz .timeline-event-node:hover { transform: scale(1.03); }
        .event-timeline-viz .timeline-event-node.dragging { opacity: 0.5; cursor: grabbing; transform: scale(1.05); z-index: 100; }
        .event-timeline-viz .timeline-event-node.drag-over { transform: scale(1.08); box-shadow: 0 0 12px rgba(59,130,246,0.5); }
        .event-timeline-viz .timeline-event-node .drag-handle { position: absolute; top: 2px; right: 2px; color: #94a3b8; font-size: 0.65rem; cursor: grab; padding: 2px; }
        .event-timeline-viz .timeline-event-node .drag-handle:hover { color: #3b82f6; }

        /* Team Member Styles */
        .team-member { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; margin-bottom: 1rem; }
        .team-member-avatar { width: 50px; height: 50px; border-radius: 50%; background: #3b82f6; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .team-member-info { flex: 1; }
        .team-member-name { font-weight: 600; color: #374151; }
        .team-member-role { color: #64748b; font-size: 0.85rem; }
        .team-member-actions { display: flex; gap: 0.5rem; }

        /* Action Buttons */
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-success { background: #059669; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-outline { background: transparent; border: 1px solid #d1d5db; color: #374151; }

        /* Button Group */
        .button-group { display: flex; gap: 1rem; padding: 1rem; border-top: 1px solid #e5e7eb; justify-content: flex-end; background: #fff; position: sticky; bottom: 0; z-index: 10; margin-top: auto; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }

        /* Tags (chips) for comma-separated inputs */
        .tags-container { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.4rem; }
        .tag { display: inline-flex; align-items: center; background: #e0f2fe; color: #0369a1; border: 1px solid #7dd3fc; border-radius: 999px; padding: 0.15rem 0.5rem; font-size: 0.78rem; cursor: pointer; transition: all 0.2s ease; }
        .tag:hover { transform: scale(1.05); box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .tag .tag-remove { margin-left: 0.4rem; background: transparent; border: none; color: #0ea5e9; cursor: pointer; font-weight: 700; line-height: 1; }
        .tag .tag-remove:hover { color: #0369a1; }
        /* Contributing Factor Tag (Red) */
        .tag.contributing { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
        .tag.contributing .tag-remove { color: #dc2626; }
        .tag.contributing .tag-remove:hover { color: #991b1b; }
        .tag.contributing .tag-indicator { background: #dc2626; }
        /* Non-Contributing Factor Tag (Yellow) */
        .tag.non-contributing { background: #fef3c7; color: #92400e; border-color: #fcd34d; }
        .tag.non-contributing .tag-remove { color: #f59e0b; }
        .tag.non-contributing .tag-remove:hover { color: #92400e; }
        .tag.non-contributing .tag-indicator { background: #f59e0b; }
        /* Tag indicator dot */
        .tag .tag-indicator { width: 8px; height: 8px; border-radius: 50%; margin-right: 0.3rem; display: none; }
        .tag.contributing .tag-indicator, .tag.non-contributing .tag-indicator { display: inline-block; }
        /* Tag Classification Popup */
        .tag-classification-popup { position: fixed; background: #fff; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 3000; min-width: 180px; overflow: hidden; display: none; }
        .tag-classification-popup.show { display: block; animation: fadeIn 0.15s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .tag-classification-popup .popup-header { padding: 0.5rem 0.75rem; background: #f8fafc; border-bottom: 1px solid #e5e7eb; font-size: 0.75rem; font-weight: 600; color: #64748b; }
        .tag-classification-popup .popup-option { display: flex; align-items: center; gap: 0.5rem; padding: 0.6rem 0.75rem; cursor: pointer; font-size: 0.8rem; transition: background 0.15s; }
        .tag-classification-popup .popup-option:hover { background: #f1f5f9; }
        .tag-classification-popup .popup-option .option-dot { width: 12px; height: 12px; border-radius: 50%; }
        .tag-classification-popup .popup-option.contributing .option-dot { background: #dc2626; }
        .tag-classification-popup .popup-option.non-contributing .option-dot { background: #f59e0b; }
        .tag-classification-popup .popup-option.clear .option-dot { background: #3b82f6; border: 2px solid #93c5fd; }
        .tag-input-row { display: flex; gap: 0.5rem; margin-top: 0.4rem; }
        .tag-input-row input { flex: 1; padding: 0.45rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem; }
        .btn.btn-sm { padding: 0.35rem 0.6rem; font-size: 0.78rem; }
        /* Failed Defense Entry - Simple form style */
        .defense-entries-container { display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.75rem; }
        .defense-entry-row { display: flex; align-items: center; gap: 0.5rem; }
        .defense-entry-row .defense-label { font-size: 0.85rem; font-weight: 600; color: #374151; white-space: nowrap; min-width: 200px; }
        .defense-entry-row .defense-comment { flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.85rem; }
        .defense-entry-row .defense-remove { background: none; border: none; color: #dc2626; cursor: pointer; font-size: 0.85rem; padding: 0.15rem 0.3rem; opacity: 0.7; transition: opacity 0.2s; }
        .defense-entry-row .defense-remove:hover { opacity: 1; }

        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: #fff; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: #fff; padding: 1rem 1.25rem; display: flex; align-items: center; justify-content: space-between; }
        .modal-header h3 { margin: 0; font-size: 1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: #fff; font-size: 1.25rem; cursor: pointer; padding: 0.25rem; opacity: 0.8; }
        .modal-close:hover { opacity: 1; }
        .modal-body { padding: 1.25rem; overflow-y: auto; max-height: calc(90vh - 140px); }
        .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem; }

        /* Statements Table Styles */
        .statements-table { width: 100%; border-collapse: collapse; margin-top: 0.75rem; font-size: 0.85rem; }
        .statements-table th, .statements-table td { padding: 0.6rem 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .statements-table th { background: #f8fafc; font-weight: 600; color: #374151; font-size: 0.8rem; }
        .statements-table tr:hover { background: #f8fafc; }
        .statements-table .actions-cell { width: 80px; text-align: center; }
        .statements-empty { text-align: center; color: #94a3b8; padding: 2rem; font-size: 0.85rem; }
        
        /* Status badges for verification items */
        .status-badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-in-progress { background: #dbeafe; color: #1e40af; }
        .status-verified { background: #dcfce7; color: #166534; }
        .status-not-effective { background: #fee2e2; color: #991b1b; }
        .status-requires-rework { background: #fce7f3; color: #9d174d; }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: relative; height: auto; }
            .main-content { margin-left: 0; width: 100%; padding-top: 5rem; }
            .top-nav { left: 0.5rem; right: 0.5rem; }
            .tab-navigation { flex-direction: column; }
            .form-grid { grid-template-columns: 1fr; }
        }
        /* Attachment info row inside corrective action modal */
        .attachment-info { display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem; font-size:0.8rem; color:#374151; }
        .attachment-info .filename { font-weight:600; }
        .attachment-actions { display:flex; align-items:center; gap:0.25rem; }
        .attachment-actions .btn-icon { background:none; border:1px solid #e5e7eb; cursor:pointer; color:#374151; padding:0.25rem 0.4rem; border-radius:6px; font-size:0.8rem; }
        .attachment-actions .btn-icon:hover { background:#f3f4f6; }
        /* Corrective Actions table row clickable */
        .ca-row { cursor: pointer; }

        /* Collapsible Section Styles */
        .section-title.collapsible { cursor: pointer; display: flex; align-items: center; justify-content: space-between; user-select: none; }
        .section-title.collapsible:hover { color: #1d4ed8; }
        .section-title.collapsible .collapse-icon { transition: transform 0.25s ease; font-size: 0.85rem; color: #64748b; }
        .section-title.collapsible .collapse-icon.collapsed { transform: rotate(-90deg); }
        .section-content { transition: max-height 0.3s ease, opacity 0.25s ease, padding 0.25s ease; overflow: hidden; }
        .section-content.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0 !important; padding-bottom: 0 !important; }
    </style>

    <!-- Firebase will be initialized in-page to match project-list.html header behavior -->
</head>
<body>
    <div class="app-container">
        <!-- Sidebar copied to match project-list.html exactly -->
        <nav class="sidebar menu-loading" id="sidebar">
            <div class="logo"><h2>Dreamex Datalab</h2></div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
                <li class="menu-dropdown" data-feature="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-hard-hat"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <!-- Risk Management (separate section) -->
                <li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
                    <a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
                    <ul class="submenu">
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
                    <a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
                    <ul class="submenu">
                        <li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
                        <li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
                        <li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html" class="active">Create Investigation</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                            <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                        <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                        <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
                        <li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                        <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
                    <a href="#"><i class="fas fa-bed"></i> Accommodation</a>
                    <ul class="submenu">
                        <li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                        <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html">Payroll</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_section">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                    <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                    <ul class="submenu">
                        <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                        <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                        <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                        <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                        <li data-feature="inventory_approvals_view" data-requires-permission="inventory_approvals_view"><a href="inventory-approvals.html"><i class="fas fa-check-circle"></i> Approvals</a></li>
                        <li data-feature="inventory_issue_view" data-requires-permission="inventory_issue_view"><a href="inventory-issue.html"><i class="fas fa-shipping-fast"></i> Material Issue</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Navigation aligned with project-list.html -->
            <nav class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                    <div class="company-branding">
                        <img id="headerCompanyLogo" alt="Company Logo" />
                        <span id="headerCompanyName"></span>
                    </div>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list"></div>
                            <div class="notification-empty">
                                <i class="fas fa-inbox"></i>
                                <div class="notification-empty-title">No notifications</div>
                                <div class="notification-empty-message">You're all caught up</div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile" style="position:relative;">
                        <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                        <div class="profile-dropdown"><ul></ul></div>
                    </div>
                </div>
            </nav>

            <!-- Page Content -->
            <div class="content">
                <div class="page-header">
                    <h1><i class="fas fa-plus-circle"></i> Create New Investigation</h1>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="summary">Define</button>
                    <button class="tab-btn" data-tab="peepo1">Measure</button>
                    <button class="tab-btn" data-tab="data-analysis">Analyze</button>
                    <button class="tab-btn" data-tab="corrective-actions">Improve</button>
                    <button class="tab-btn" data-tab="control">Control</button>
                </div>

                <!-- Tab Contents -->
                <div id="summary" class="tab-content active">
                    <!-- Section Control Buttons -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="expandTabSections('summary')" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                            <i class="fas fa-expand-alt"></i> Expand All
                        </button>
                        <button type="button" class="btn btn-outline" onclick="collapseTabSections('summary')" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                            <i class="fas fa-compress-alt"></i> Collapse All
                        </button>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-info-circle" style="margin-right:0.5rem;"></i>Introduction</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="incidentTitle">Investigation Title *</label>
                                <input type="text" id="incidentTitle" name="incidentTitle" required>
                            </div>
                            <div class="form-group">
                                <label for="referenceNumber">Reference Number</label>
                                <input type="text" id="referenceNumber" name="referenceNumber" readonly style="background-color: #f1f5f9; cursor: not-allowed;">
                            </div>
                            <div class="form-group full-width">
                                <label for="investigationPurpose">Purpose of Investigation</label>
                                <textarea id="investigationPurpose" name="investigationPurpose" rows="3" placeholder="Describe the purpose and objectives of this investigation..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="investigationScope">Investigation Scope</label>
                                <textarea id="investigationScope" name="investigationScope" rows="3" placeholder="Define the scope and boundaries of this investigation..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="investigationMethod">Investigation Methodology</label>
                                <textarea id="investigationMethod" name="investigationMethod" rows="3" placeholder="Describe the methodology and approach used for this investigation..."></textarea>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-file-alt" style="margin-right:0.5rem;"></i>Incident Summary</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="incidentDate">Incident Date *</label>
                                <input type="datetime-local" id="incidentDate" name="incidentDate" required>
                            </div>
                            <div class="form-group">
                                <label for="reportedDate">Reported Date *</label>
                                <input type="datetime-local" id="reportedDate" name="reportedDate" required>
                            </div>
                            <div class="form-group">
                                <label for="location">Location *</label>
                                <select id="location" name="location" required>
                                    <option value="">Select Location</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="department">Business Unit / Department</label>
                                <select id="department" name="department">
                                    <option value="">Select Department</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="incidentType">Incident Type *</label>
                                <select id="incidentType" name="incidentType" required>
                                    <option value="">Select Type</option>
                                    <option value="Near Miss">Near Miss</option>
                                    <option value="Property Damage">Property Damage</option>
                                    <option value="Environmental">Environmental</option>
                                    <option value="Equipment Failure">Equipment Failure</option>
                                    <option value="Personal Injury">Personal Injury</option>
                                    <option value="Process Safety">Process Safety</option>
                                    <option value="Security">Security</option>
                                    <option value="Quality">Quality/Product</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="severityActual">Severity (Actual)</label>
                                <select id="severityActual" name="severityActual">
                                    <option>Insignificant</option>
                                    <option>Minor</option>
                                    <option>Moderate</option>
                                    <option>Major</option>
                                    <option>Catastrophic</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="severityPotential">Potential Severity</label>
                                <select id="severityPotential" name="severityPotential">
                                    <option>Insignificant</option>
                                    <option>Minor</option>
                                    <option>Moderate</option>
                                    <option>Major</option>
                                    <option>Catastrophic</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="likelihood">Likelihood (Pre-incident)</label>
                                <select id="likelihood" name="likelihood">
                                    <option>Rare</option>
                                    <option>Unlikely</option>
                                    <option>Possible</option>
                                    <option>Likely</option>
                                    <option>Almost Certain</option>
                                </select>
                            </div>
                            <div class="form-group full-width">
                                <label for="description">Incident Description *</label>
                                <textarea id="description" name="description" rows="4" required placeholder="Provide a detailed description of what happened..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="immediateActions">Immediate Actions Taken</label>
                                <textarea id="immediateActions" name="immediateActions" rows="3" placeholder="What was done right after the incident"></textarea>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)" style="display: flex; align-items: center; justify-content: space-between;">
                            <span><i class="fas fa-tools" style="margin-right:0.5rem;"></i>Equipment Involved</span>
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <button type="button" class="btn btn-outline" onclick="event.stopPropagation(); addEquipmentInvolved()" title="Add Equipment" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <i class="fas fa-chevron-down collapse-icon"></i>
                            </span>
                        </h2>
                        <div class="section-content">
                        <div id="equipmentInvolvedContainer"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-users" style="margin-right:0.5rem;"></i>People</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <div style="margin-bottom: 1.5rem;">
                            <h3 style="font-size: 0.95rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Persons Involved</h3>
                            <button type="button" class="btn btn-primary" onclick="addIncidentPerson()" style="margin-bottom:0.75rem;" title="Add Person Involved">
                                <i class="fas fa-user-plus"></i> Add Person
                            </button>
                            <div id="incidentPersonsContainer"></div>
                        </div>
                        <div>
                            <h3 style="font-size: 0.95rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Investigation Team</h3>
                            <button type="button" class="btn btn-primary" onclick="addIntroTeamMember()" style="margin-bottom:0.75rem;">
                                <i class="fas fa-user-plus"></i> Add Person
                            </button>
                            <div id="introTeamContainer"></div>
                        </div>
                        </div>
                    </div>
                </div>

                <div id="peepo1" class="tab-content">
                    <!-- Section Control Buttons -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="expandTabSections('peepo1')" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                            <i class="fas fa-expand-alt"></i> Expand All
                        </button>
                        <button type="button" class="btn btn-outline" onclick="collapseTabSections('peepo1')" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                            <i class="fas fa-compress-alt"></i> Collapse All
                        </button>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-project-diagram" style="margin-right:0.5rem;"></i>Peepo Analysis</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="peopleFactors">People Factors</label>
                                <input type="hidden" id="peopleFactors">
                                <div id="peopleFactorsTags" class="tags-container"></div>
                                <div class="tag-input-row">
                                    <input type="text" id="peopleFactorsNew" placeholder="Add element">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addPeepoTag('peopleFactors')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="equipmentFactors">Equipment Factors</label>
                                <input type="hidden" id="equipmentFactors">
                                <div id="equipmentFactorsTags" class="tags-container"></div>
                                <div class="tag-input-row">
                                    <input type="text" id="equipmentFactorsNew" placeholder="Add element">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addPeepoTag('equipmentFactors')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="form-group full-width">
                                <label for="environmentFactors">Environmental Factors</label>
                                <input type="hidden" id="environmentFactors">
                                <div id="environmentFactorsTags" class="tags-container"></div>
                                <div class="tag-input-row">
                                    <input type="text" id="environmentFactorsNew" placeholder="Add element">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addPeepoTag('environmentFactors')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="procedures">Procedures</label>
                                <input type="hidden" id="procedures">
                                <div id="proceduresTags" class="tags-container"></div>
                                <div class="tag-input-row">
                                    <input type="text" id="proceduresNew" placeholder="Add element">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addPeepoTag('procedures')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>

                            <div class="form-group full-width">
                                <label for="organizationFactorsP1">Organization</label>
                                <input type="hidden" id="organizationFactorsP1">
                                <div id="organizationFactorsP1Tags" class="tags-container"></div>
                                <div class="tag-input-row">
                                    <input type="text" id="organizationFactorsP1New" placeholder="Add element">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addPeepoTag('organizationFactorsP1')"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-map-marker-alt" style="margin-right:0.5rem;"></i>Incident Location Map</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="incidentLatitude">Latitude</label>
                                <input type="number" id="incidentLatitude" step="any" placeholder="e.g., 25.276987">
                            </div>
                            <div class="form-group">
                                <label for="incidentLongitude">Longitude</label>
                                <input type="number" id="incidentLongitude" step="any" placeholder="e.g., 55.296249">
                            </div>
                            <div class="form-group" style="flex-direction: row; align-items: flex-end; gap: 0.5rem;">
                                <button type="button" class="btn btn-primary" onclick="updateIncidentMap()">
                                    <i class="fas fa-sync-alt"></i> Update Map
                                </button>
                                <button type="button" class="btn btn-outline" onclick="getCurrentLocation()">
                                    <i class="fas fa-crosshairs"></i> Use Current Location
                                </button>
                            </div>
                        </div>
                        <div id="incidentMapContainer" style="margin-top: 1rem; height: 350px; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; background: #f8fafc;">
                            <div id="incidentMap" style="width: 100%; height: 100%;"></div>
                        </div>
                        <p id="mapLocationText" style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;"></p>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)" style="display: flex; align-items: center; justify-content: space-between;">
                            <span><i class="fas fa-images" style="margin-right:0.5rem;"></i>Photos & Evidence</span>
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <button type="button" class="btn btn-outline" onclick="event.stopPropagation(); document.getElementById('evidenceFiles').click()" title="Add Photo/Evidence" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <i class="fas fa-chevron-down collapse-icon"></i>
                            </span>
                        </h2>
                        <div class="section-content">
                        <input type="file" id="evidenceFiles" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
                        <!-- Evidence Files Table -->
                        <table class="statements-table" id="evidenceFilesTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">Preview</th>
                                    <th>File Name</th>
                                    <th style="width: 120px;">Type</th>
                                    <th style="width: 100px;">Size</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="evidenceFilesTableBody"></tbody>
                        </table>
                        <div id="evidenceFilesEmpty" class="statements-empty" style="display: block;">
                            <i class="fas fa-folder-open" style="font-size: 2rem; color: #d1d5db; margin-bottom: 0.5rem;"></i>
                            <p>No files uploaded yet</p>
                        </div>
                        <div id="filePreview" class="file-preview" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-clock" style="margin-right:0.5rem;"></i>Timeline</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <button type="button" class="btn btn-primary" onclick="addTimelineEvent()">
                            <i class="fas fa-plus"></i> Add Event
                        </button>
                        <div id="timelineContainer" class="timeline-container">
                            <!-- Timeline events will be added here -->
                        </div>
                        
                        <div class="chart-container">
                            <h3>Timeline Visualization</h3>
                            <div class="event-timeline-viz">
                                <div id="timelineVizTrack" class="timeline-track">
                                    <div class="timeline-line"></div>
                                    <div class="timeline-empty">Add events above to see the chronological timeline</div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <!-- Statements Section -->
                    <div class="form-section">
                        <h2 class="section-title" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;" onclick="toggleStatementsSection()">
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <i id="statementsCollapseIcon" class="fas fa-chevron-down" style="font-size: 0.75rem; transition: transform 0.2s;"></i>
                                Witness Statements
                            </span>
                            <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); openStatementModal()" title="Add Statement" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </h2>
                        <div id="statementsTableContainer">
                            <table class="statements-table" id="statementsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Role/Position</th>
                                        <th>Date</th>
                                        <th>Summary</th>
                                        <th class="actions-cell">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="statementsTableBody">
                                    <!-- Statements will be added here -->
                                </tbody>
                            </table>
                            <div id="statementsEmpty" class="statements-empty" style="display: block;">
                                <i class="fas fa-comment-dots" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                                No statements recorded yet. Click "+" to record a witness statement.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="data-analysis" class="tab-content">
                    <!-- Section Control Buttons -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="expandTabSections('data-analysis')" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                            <i class="fas fa-expand-alt"></i> Expand All
                        </button>
                        <button type="button" class="btn btn-outline" onclick="collapseTabSections('data-analysis')" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                            <i class="fas fa-compress-alt"></i> Collapse All
                        </button>
                    </div>

                    <!-- Contributing Factors Summary Section -->
                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-exclamation-triangle" style="margin-right:0.5rem;"></i>Contributing Factors Summary</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">Factors marked as <span style="color: #dc2626; font-weight: 600;">Contributing</span> (red) from the PEEPO analysis in the Measure tab will appear here automatically.</p>
                        <div id="contributingFactorsSummary" class="tags-container" style="min-height: 40px; padding: 0.75rem; background: #fef2f2; border: 1px dashed #fca5a5; border-radius: 8px;">
                            <span style="color: #94a3b8; font-size: 0.85rem;">No contributing factors identified yet. Go to Measure tab, click on tags and select "Contributing Factor" to add them here.</span>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-shield-alt" style="margin-right:0.5rem;"></i>Absent/Failed Defenses (ICAM)</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">Identify defenses that were absent, failed, or not used that could have prevented the incident or mitigated its consequences. Select from standardized defense types below.</p>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Add Failed/Absent Defense</label>
                                <input type="hidden" id="failedDefenses">
                                <input type="hidden" id="failedDefensesData">
                                <div class="tag-input-row">
                                    <select id="failedDefensesSelect" style="flex: 1; padding: 0.45rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                        <option value="">-- Select Defense Type --</option>
                                        <optgroup label="Physical/Engineering Controls">
                                            <option value="DF01 - Machine Guarding">DF01 - Machine Guarding</option>
                                            <option value="DF02 - Safety Interlocks">DF02 - Safety Interlocks</option>
                                            <option value="DF03 - Isolation/Lockout Systems">DF03 - Isolation/Lockout Systems</option>
                                            <option value="DF04 - Containment/Barriers">DF04 - Containment/Barriers</option>
                                            <option value="DF05 - Pressure Relief Devices">DF05 - Pressure Relief Devices</option>
                                            <option value="DF06 - Ventilation/Extraction Systems">DF06 - Ventilation/Extraction Systems</option>
                                            <option value="DF07 - Fire Suppression Systems">DF07 - Fire Suppression Systems</option>
                                            <option value="DF08 - Fall Protection Systems">DF08 - Fall Protection Systems</option>
                                            <option value="DF09 - Emergency Shutdown Systems">DF09 - Emergency Shutdown Systems</option>
                                            <option value="DF10 - Electrical Protection Devices">DF10 - Electrical Protection Devices</option>
                                        </optgroup>
                                        <optgroup label="Administrative Controls">
                                            <option value="DF11 - Safe Work Procedures">DF11 - Safe Work Procedures</option>
                                            <option value="DF12 - Permit to Work System">DF12 - Permit to Work System</option>
                                            <option value="DF13 - Risk Assessment/JSA">DF13 - Risk Assessment/JSA</option>
                                            <option value="DF14 - Inspection/Audit Program">DF14 - Inspection/Audit Program</option>
                                            <option value="DF15 - Maintenance Program">DF15 - Maintenance Program</option>
                                            <option value="DF16 - Change Management">DF16 - Change Management</option>
                                            <option value="DF17 - Contractor Management">DF17 - Contractor Management</option>
                                            <option value="DF18 - Fatigue Management">DF18 - Fatigue Management</option>
                                            <option value="DF19 - Drug & Alcohol Policy">DF19 - Drug & Alcohol Policy</option>
                                            <option value="DF20 - Access Control/Authorization">DF20 - Access Control/Authorization</option>
                                        </optgroup>
                                        <optgroup label="Warnings & Communication">
                                            <option value="DF21 - Safety Signage">DF21 - Safety Signage</option>
                                            <option value="DF22 - Warning Labels/Markings">DF22 - Warning Labels/Markings</option>
                                            <option value="DF23 - Audible Alarms">DF23 - Audible Alarms</option>
                                            <option value="DF24 - Visual Alarms/Lights">DF24 - Visual Alarms/Lights</option>
                                            <option value="DF25 - Safety Data Sheets (SDS)">DF25 - Safety Data Sheets (SDS)</option>
                                            <option value="DF26 - Communication Protocols">DF26 - Communication Protocols</option>
                                            <option value="DF27 - Toolbox Talks/Briefings">DF27 - Toolbox Talks/Briefings</option>
                                        </optgroup>
                                        <optgroup label="Personal Protective Equipment">
                                            <option value="DF28 - Head Protection">DF28 - Head Protection</option>
                                            <option value="DF29 - Eye/Face Protection">DF29 - Eye/Face Protection</option>
                                            <option value="DF30 - Hearing Protection">DF30 - Hearing Protection</option>
                                            <option value="DF31 - Respiratory Protection">DF31 - Respiratory Protection</option>
                                            <option value="DF32 - Hand Protection">DF32 - Hand Protection</option>
                                            <option value="DF33 - Foot Protection">DF33 - Foot Protection</option>
                                            <option value="DF34 - Body Protection/Coveralls">DF34 - Body Protection/Coveralls</option>
                                            <option value="DF35 - Fall Arrest Equipment">DF35 - Fall Arrest Equipment</option>
                                            <option value="DF36 - High Visibility Clothing">DF36 - High Visibility Clothing</option>
                                            <option value="DF37 - Chemical Protective Equipment">DF37 - Chemical Protective Equipment</option>
                                        </optgroup>
                                        <optgroup label="Training & Competency">
                                            <option value="DF38 - Induction Training">DF38 - Induction Training</option>
                                            <option value="DF39 - Task-Specific Training">DF39 - Task-Specific Training</option>
                                            <option value="DF40 - Refresher Training">DF40 - Refresher Training</option>
                                            <option value="DF41 - Competency Assessment">DF41 - Competency Assessment</option>
                                            <option value="DF42 - Certification/Licensing">DF42 - Certification/Licensing</option>
                                            <option value="DF43 - Emergency Response Training">DF43 - Emergency Response Training</option>
                                            <option value="DF44 - Hazard Awareness Training">DF44 - Hazard Awareness Training</option>
                                        </optgroup>
                                        <optgroup label="Supervision & Monitoring">
                                            <option value="DF45 - Direct Supervision">DF45 - Direct Supervision</option>
                                            <option value="DF46 - Safety Observations">DF46 - Safety Observations</option>
                                            <option value="DF47 - CCTV/Remote Monitoring">DF47 - CCTV/Remote Monitoring</option>
                                            <option value="DF48 - Gas/Environmental Monitoring">DF48 - Gas/Environmental Monitoring</option>
                                            <option value="DF49 - Process Monitoring Systems">DF49 - Process Monitoring Systems</option>
                                            <option value="DF50 - Lone Worker Systems">DF50 - Lone Worker Systems</option>
                                        </optgroup>
                                        <optgroup label="Emergency Response">
                                            <option value="DF51 - Emergency Response Plan">DF51 - Emergency Response Plan</option>
                                            <option value="DF52 - Evacuation Procedures">DF52 - Evacuation Procedures</option>
                                            <option value="DF53 - First Aid Provisions">DF53 - First Aid Provisions</option>
                                            <option value="DF54 - Emergency Equipment">DF54 - Emergency Equipment</option>
                                            <option value="DF55 - Spill Response Equipment">DF55 - Spill Response Equipment</option>
                                            <option value="DF56 - Rescue Equipment">DF56 - Rescue Equipment</option>
                                            <option value="DF57 - Emergency Communication">DF57 - Emergency Communication</option>
                                            <option value="DF58 - Muster Points/Assembly Areas">DF58 - Muster Points/Assembly Areas</option>
                                        </optgroup>
                                        <optgroup label="Design & Planning">
                                            <option value="DF59 - Inherently Safer Design">DF59 - Inherently Safer Design</option>
                                            <option value="DF60 - Ergonomic Design">DF60 - Ergonomic Design</option>
                                            <option value="DF61 - Hazard Elimination">DF61 - Hazard Elimination</option>
                                            <option value="DF62 - Substitution of Hazards">DF62 - Substitution of Hazards</option>
                                            <option value="DF63 - Pre-Task Planning">DF63 - Pre-Task Planning</option>
                                        </optgroup>
                                        <optgroup label="Organizational">
                                            <option value="DF64 - Safety Management System">DF64 - Safety Management System</option>
                                            <option value="DF65 - Leadership/Safety Culture">DF65 - Leadership/Safety Culture</option>
                                            <option value="DF66 - Resource Allocation">DF66 - Resource Allocation</option>
                                            <option value="DF67 - Staffing Levels">DF67 - Staffing Levels</option>
                                            <option value="DF68 - Incident Reporting System">DF68 - Incident Reporting System</option>
                                            <option value="DF69 - Corrective Action System">DF69 - Corrective Action System</option>
                                            <option value="DF70 - Document Control">DF70 - Document Control</option>
                                        </optgroup>
                                    </select>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addFailedDefense()"><i class="fas fa-plus"></i></button>
                                </div>
                                <div id="failedDefensesEntries" class="defense-entries-container"></div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-user-cog" style="margin-right:0.5rem;"></i>Individual or Team Actions</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">Identify individual or team actions that contributed to the incident. Consider errors, violations, and decisions made by individuals or teams.</p>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Add Individual/Team Action</label>
                                <input type="hidden" id="individualTeamActions">
                                <input type="hidden" id="individualTeamActionsData">
                                <div class="tag-input-row">
                                    <select id="individualTeamActionsSelect" style="flex: 1; padding: 0.45rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                        <option value="">-- Select Action Type --</option>
                                        <optgroup label="Errors">
                                            <option value="ITA01 - Slip/Lapse">ITA01 - Slip/Lapse</option>
                                            <option value="ITA02 - Mistake">ITA02 - Mistake</option>
                                            <option value="ITA03 - Memory Failure">ITA03 - Memory Failure</option>
                                            <option value="ITA04 - Attention Failure">ITA04 - Attention Failure</option>
                                            <option value="ITA05 - Perception Error">ITA05 - Perception Error</option>
                                            <option value="ITA06 - Decision Error">ITA06 - Decision Error</option>
                                            <option value="ITA07 - Communication Error">ITA07 - Communication Error</option>
                                        </optgroup>
                                        <optgroup label="Violations">
                                            <option value="ITA08 - Routine Violation">ITA08 - Routine Violation</option>
                                            <option value="ITA09 - Situational Violation">ITA09 - Situational Violation</option>
                                            <option value="ITA10 - Exceptional Violation">ITA10 - Exceptional Violation</option>
                                            <option value="ITA11 - Optimizing Violation">ITA11 - Optimizing Violation</option>
                                            <option value="ITA12 - Shortcut Taken">ITA12 - Shortcut Taken</option>
                                        </optgroup>
                                        <optgroup label="Team Factors">
                                            <option value="ITA13 - Poor Team Communication">ITA13 - Poor Team Communication</option>
                                            <option value="ITA14 - Inadequate Handover">ITA14 - Inadequate Handover</option>
                                            <option value="ITA15 - Lack of Coordination">ITA15 - Lack of Coordination</option>
                                            <option value="ITA16 - Leadership Failure">ITA16 - Leadership Failure</option>
                                            <option value="ITA17 - Group Think">ITA17 - Group Think</option>
                                            <option value="ITA18 - Role Confusion">ITA18 - Role Confusion</option>
                                        </optgroup>
                                        <optgroup label="Individual Factors">
                                            <option value="ITA19 - Complacency">ITA19 - Complacency</option>
                                            <option value="ITA20 - Overconfidence">ITA20 - Overconfidence</option>
                                            <option value="ITA21 - Risk Normalization">ITA21 - Risk Normalization</option>
                                            <option value="ITA22 - Inadequate Skills">ITA22 - Inadequate Skills</option>
                                            <option value="ITA23 - Inexperience">ITA23 - Inexperience</option>
                                            <option value="ITA24 - Physical Impairment">ITA24 - Physical Impairment</option>
                                            <option value="ITA25 - Mental State">ITA25 - Mental State</option>
                                        </optgroup>
                                    </select>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addIndividualTeamAction()"><i class="fas fa-plus"></i></button>
                                </div>
                                <div id="individualTeamActionsEntries" class="defense-entries-container"></div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-tasks" style="margin-right:0.5rem;"></i>Task / Environmental Conditions</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">Identify task-related and environmental conditions that contributed to the incident.</p>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Add Task/Environmental Condition</label>
                                <input type="hidden" id="taskEnvConditions">
                                <input type="hidden" id="taskEnvConditionsData">
                                <div class="tag-input-row">
                                    <select id="taskEnvConditionsSelect" style="flex: 1; padding: 0.45rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                        <option value="">-- Select Condition Type --</option>
                                        <optgroup label="Task Conditions">
                                            <option value="TEC01 - Time Pressure">TEC01 - Time Pressure</option>
                                            <option value="TEC02 - High Workload">TEC02 - High Workload</option>
                                            <option value="TEC03 - Task Complexity">TEC03 - Task Complexity</option>
                                            <option value="TEC04 - Unfamiliar Task">TEC04 - Unfamiliar Task</option>
                                            <option value="TEC05 - Inadequate Tools/Equipment">TEC05 - Inadequate Tools/Equipment</option>
                                            <option value="TEC06 - Poor Task Design">TEC06 - Poor Task Design</option>
                                            <option value="TEC07 - Conflicting Goals">TEC07 - Conflicting Goals</option>
                                            <option value="TEC08 - Monotonous/Repetitive Work">TEC08 - Monotonous/Repetitive Work</option>
                                            <option value="TEC09 - Interruptions/Distractions">TEC09 - Interruptions/Distractions</option>
                                            <option value="TEC10 - Concurrent Tasks">TEC10 - Concurrent Tasks</option>
                                        </optgroup>
                                        <optgroup label="Physical Environment">
                                            <option value="TEC11 - Poor Lighting">TEC11 - Poor Lighting</option>
                                            <option value="TEC12 - Excessive Noise">TEC12 - Excessive Noise</option>
                                            <option value="TEC13 - Extreme Temperature">TEC13 - Extreme Temperature</option>
                                            <option value="TEC14 - Weather Conditions">TEC14 - Weather Conditions</option>
                                            <option value="TEC15 - Poor Housekeeping">TEC15 - Poor Housekeeping</option>
                                            <option value="TEC16 - Confined Space">TEC16 - Confined Space</option>
                                            <option value="TEC17 - Working at Height">TEC17 - Working at Height</option>
                                            <option value="TEC18 - Vibration">TEC18 - Vibration</option>
                                            <option value="TEC19 - Hazardous Atmosphere">TEC19 - Hazardous Atmosphere</option>
                                            <option value="TEC20 - Workspace Layout">TEC20 - Workspace Layout</option>
                                        </optgroup>
                                        <optgroup label="Work Conditions">
                                            <option value="TEC21 - Shift Work/Night Work">TEC21 - Shift Work/Night Work</option>
                                            <option value="TEC22 - Extended Hours">TEC22 - Extended Hours</option>
                                            <option value="TEC23 - Fatigue">TEC23 - Fatigue</option>
                                            <option value="TEC24 - Inadequate Breaks">TEC24 - Inadequate Breaks</option>
                                            <option value="TEC25 - Remote/Isolated Location">TEC25 - Remote/Isolated Location</option>
                                        </optgroup>
                                    </select>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addTaskEnvCondition()"><i class="fas fa-plus"></i></button>
                                </div>
                                <div id="taskEnvConditionsEntries" class="defense-entries-container"></div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-building" style="margin-right:0.5rem;"></i>Organisational Factors</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">Identify organisational factors that contributed to the incident. Consider management systems, culture, and resources.</p>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Add Organisational Factor</label>
                                <input type="hidden" id="orgFactors">
                                <input type="hidden" id="orgFactorsData">
                                <div class="tag-input-row">
                                    <select id="orgFactorsSelect" style="flex: 1; padding: 0.45rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                        <option value="">-- Select Factor Type --</option>
                                        <optgroup label="Management Systems">
                                            <option value="OF01 - Inadequate Policies/Procedures">OF01 - Inadequate Policies/Procedures</option>
                                            <option value="OF02 - Poor Risk Management">OF02 - Poor Risk Management</option>
                                            <option value="OF03 - Inadequate Change Management">OF03 - Inadequate Change Management</option>
                                            <option value="OF04 - Poor Contractor Management">OF04 - Poor Contractor Management</option>
                                            <option value="OF05 - Inadequate Audit/Review">OF05 - Inadequate Audit/Review</option>
                                            <option value="OF06 - Poor Incident Investigation">OF06 - Poor Incident Investigation</option>
                                            <option value="OF07 - Inadequate Documentation">OF07 - Inadequate Documentation</option>
                                        </optgroup>
                                        <optgroup label="Resources">
                                            <option value="OF08 - Inadequate Staffing">OF08 - Inadequate Staffing</option>
                                            <option value="OF09 - Budget Constraints">OF09 - Budget Constraints</option>
                                            <option value="OF10 - Poor Equipment Maintenance">OF10 - Poor Equipment Maintenance</option>
                                            <option value="OF11 - Inadequate Training Resources">OF11 - Inadequate Training Resources</option>
                                            <option value="OF12 - Time/Schedule Pressure">OF12 - Time/Schedule Pressure</option>
                                        </optgroup>
                                        <optgroup label="Communication">
                                            <option value="OF13 - Poor Communication Systems">OF13 - Poor Communication Systems</option>
                                            <option value="OF14 - Information Not Shared">OF14 - Information Not Shared</option>
                                            <option value="OF15 - Language Barriers">OF15 - Language Barriers</option>
                                            <option value="OF16 - Inadequate Feedback Systems">OF16 - Inadequate Feedback Systems</option>
                                        </optgroup>
                                        <optgroup label="Culture & Leadership">
                                            <option value="OF17 - Poor Safety Culture">OF17 - Poor Safety Culture</option>
                                            <option value="OF18 - Production Over Safety">OF18 - Production Over Safety</option>
                                            <option value="OF19 - Lack of Management Commitment">OF19 - Lack of Management Commitment</option>
                                            <option value="OF20 - Blame Culture">OF20 - Blame Culture</option>
                                            <option value="OF21 - Weak Enforcement">OF21 - Weak Enforcement</option>
                                        </optgroup>
                                        <optgroup label="Training & Competency">
                                            <option value="OF22 - Inadequate Training Program">OF22 - Inadequate Training Program</option>
                                            <option value="OF23 - Poor Competency Management">OF23 - Poor Competency Management</option>
                                            <option value="OF24 - Inadequate Supervision">OF24 - Inadequate Supervision</option>
                                            <option value="OF25 - Poor Knowledge Transfer">OF25 - Poor Knowledge Transfer</option>
                                        </optgroup>
                                        <optgroup label="Planning & Design">
                                            <option value="OF26 - Poor Work Planning">OF26 - Poor Work Planning</option>
                                            <option value="OF27 - Inadequate Design Review">OF27 - Inadequate Design Review</option>
                                            <option value="OF28 - Procurement Issues">OF28 - Procurement Issues</option>
                                            <option value="OF29 - Organizational Change">OF29 - Organizational Change</option>
                                            <option value="OF30 - External Pressures">OF30 - External Pressures</option>
                                        </optgroup>
                                    </select>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="addOrgFactor()"><i class="fas fa-plus"></i></button>
                                </div>
                                <div id="orgFactorsEntries" class="defense-entries-container"></div>
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-chart-bar" style="margin-right:0.5rem;"></i>Data Analysis</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="dataCollected">Data Collected</label>
                                <textarea id="dataCollected" rows="4" placeholder="Document all data collected during investigation..."></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label for="keyFindings">Key Findings</label>
                                <textarea id="keyFindings" rows="4" placeholder="Summarize key findings from data analysis..."></textarea>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <div id="corrective-actions" class="tab-content">
                    <div class="form-section">
                        <h2 class="section-title" style="display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-tasks" style="font-size: 0.9rem;"></i>
                                Corrective Actions
                            </span>
                            <button type="button" class="btn btn-outline" onclick="openCorrectiveActionModal()" title="Add Action" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </h2>
                        <div id="correctiveActionsTableContainer">
                            <table class="statements-table" id="correctiveActionsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Action Owner</th>
                                        <th>Due Date</th>
                                        <th>Action Type</th>
                                        <th>Status</th>
                                        <th>Description</th>
                                        <th class="actions-cell">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="correctiveActionsTableBody">
                                </tbody>
                            </table>
                            <div id="correctiveActionsEmpty" class="statements-empty" style="display: block;">
                                <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                                No corrective actions added yet. Click "+" to add a corrective action.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="control" class="tab-content">
                    <!-- Section Control Buttons -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="expandTabSections('control')" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                            <i class="fas fa-expand-alt"></i> Expand All
                        </button>
                        <button type="button" class="btn btn-outline" onclick="collapseTabSections('control')" style="padding: 0.4rem 0.75rem; font-size: 0.78rem;">
                            <i class="fas fa-compress-alt"></i> Collapse All
                        </button>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)" style="display: flex; align-items: center; justify-content: space-between;">
                            <span><i class="fas fa-clipboard-check" style="margin-right:0.5rem;"></i>Improvement Verification</span>
                            <span style="display: flex; align-items: center; gap: 0.5rem;">
                                <button type="button" class="btn btn-outline" onclick="event.stopPropagation(); addVerificationItem()" title="Add Verification" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <i class="fas fa-chevron-down collapse-icon"></i>
                            </span>
                        </h2>
                        <div class="section-content">
                        <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">Track and verify the implementation of corrective actions and improvements identified in this investigation.</p>
                        <div id="verificationItemsContainer">
                            <table class="statements-table" id="verificationItemsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Action/Improvement</th>
                                        <th>Verified By</th>
                                        <th>Verification Date</th>
                                        <th>Status</th>
                                        <th>Effectiveness</th>
                                        <th class="actions-cell">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="verificationItemsTableBody"></tbody>
                            </table>
                            <div id="verificationItemsEmpty" class="statements-empty" style="display: block;">
                                <i class="fas fa-clipboard-check" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                                No verification items added yet. Click "+" to add a verification record.
                            </div>
                        </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2 class="section-title collapsible" onclick="toggleSectionCollapse(this)">
                            <span><i class="fas fa-book" style="margin-right:0.5rem;"></i>Lessons Learned</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </h2>
                        <div class="section-content">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="lessonsLearned">Key Lessons Learned</label>
                                <textarea id="lessonsLearned" rows="4" placeholder="Document key lessons learned from this investigation that should be shared across the organization..."></textarea>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="button-group">
                    <button type="button" class="btn btn-outline" onclick="saveDraft()">
                        <i class="fas fa-save"></i> Save Draft
                    </button>
                    <button type="button" class="btn btn-primary" onclick="submitForReview()">
                        <i class="fas fa-paper-plane"></i> Submit for Review
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveInvestigation()">
                        <i class="fas fa-check"></i> Save Investigation
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Safe reverse geocoding to prevent load errors
        async function reverseGeocode(latitude, longitude) {
            try {
                if (typeof latitude !== 'number' || typeof longitude !== 'number') {
                    return '';
                }
                const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(latitude)}&lon=${encodeURIComponent(longitude)}`;
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) {
                    return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                }
                const data = await res.json();
                const display = data && (data.display_name || (data.address && Object.values(data.address).join(', ')));
                return display || `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            } catch (e) {
                return `${latitude?.toFixed?.(6) ?? latitude}, ${longitude?.toFixed?.(6) ?? longitude}`;
            }
        }
        class InvestigationCreate {
            constructor() {
                this.currentTab = 'summary';
                this.timelineEvents = [];
                this.recommendations = [];
                this.correctiveActions = [];
                this.teamMembers = [];
                this.introTeamMembers = [];
                this.pendingEvidenceFiles = [];
                this.existingEvidence = [];
                this.timelineChart = null;
                this.editingId = null;
                this.originalCreatedDate = null;
                this.tagClassifications = {}; // Track PEEPO tag classifications (contributing/non-contributing)
                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.initializeTimelineChart();
                // Make sure dropdown data is ready before populating fields on edit
                await this.populateDepartments();
                await this.populateLocations();
                await this.loadActionOwnerEmployees();
                
                // Collapse all sections on page load
                collapseAllSections();
                
                // Check if editing an existing investigation
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit');
                if (editId) {
                    await this.loadInvestigationForEdit(editId);
                } else {
                    // Generate reference number for new investigation
                    await this.generateAndDisplayReferenceNumber();
                }
            }

            async generateAndDisplayReferenceNumber() {
                try {
                    const { companyId } = await this.resolveCompanyContext();
                    if (!companyId) {
                        console.warn('No company context for reference number generation');
                        return;
                    }
                    
                    console.log('Generating reference number for company:', companyId);
                    const referenceNumber = await this.generateInvestigationId(companyId);
                    console.log('Generated reference number:', referenceNumber);
                    
                    const refField = document.getElementById('referenceNumber');
                    if (refField) {
                        refField.value = referenceNumber;
                        this.generatedReferenceNumber = referenceNumber;
                        console.log('Reference number set in field:', refField.value);
                    } else {
                        console.error('Reference number field not found');
                    }
                } catch (error) {
                    console.error('Error generating reference number:', error);
                    // Set a fallback value
                    const refField = document.getElementById('referenceNumber');
                    if (refField) {
                        refField.value = `INVST-${Date.now()}`;
                    }
                }
            }

            async loadInvestigationForEdit(investigationId) {
                try {
                    const { companyId } = await this.resolveCompanyContext();
                    if (!companyId) {
                        alert('Error: Could not determine company context');
                        return;
                    }

                    const db = firebase.database();
                    const snapshot = await db.ref(`companies/${companyId}/investigations/${investigationId}`).once('value');
                    
                    if (!snapshot.exists()) {
                        alert('Investigation not found');
                        return;
                    }

                    const data = snapshot.val();
                    this.editingId = investigationId;
                    this.originalCreatedDate = data.createdDate;

                    // Update page title
                    const pageTitle = document.querySelector('.page-header h1');
                    if (pageTitle) pageTitle.textContent = 'Edit Investigation';

                    // Populate basic fields
                    this.setFieldValue('incidentTitle', data.title);
                    this.setFieldValue('referenceNumber', data.id);
                    // Introduction fields
                    this.setFieldValue('investigationPurpose', data.investigationPurpose);
                    this.setFieldValue('investigationScope', data.investigationScope);
                    this.setFieldValue('investigationMethod', data.investigationMethod);
                    this.setFieldValue('incidentDate', data.incidentDate);
                    // Reported Date
                    this.setFieldValue('reportedDate', data.reportedDate);
                    this.setFieldValue('incidentTime', data.incidentTime);
                    this.setFieldValue('location', data.location);
                    this.setFieldValue('department', data.department);
                    this.setFieldValue('incidentType', data.incidentType);
                    this.setFieldValue('classification', data.classification);
                    this.setFieldValue('severity', data.priority);
                    this.setFieldValue('severityActual', data.severityActual);
                    this.setFieldValue('severityPotential', data.severityPotential);
                    this.setFieldValue('likelihood', data.likelihood);
                    this.setFieldValue('description', data.description);
                    this.setFieldValue('immediateActions', data.immediateActions);
                    
                    // Load Location Coordinates and update map
                    // Support both new format (incidentLocation) and legacy format (locationCoordinates)
                    let lat = null, lng = null;
                    if (data.incidentLocation) {
                        lat = data.incidentLocation.latitude;
                        lng = data.incidentLocation.longitude;
                    } else if (data.locationCoordinates) {
                        lat = data.locationCoordinates.lat;
                        lng = data.locationCoordinates.lng;
                    }
                    if (lat && lng) {
                        // Set the coordinate fields
                        const latField = document.getElementById('incidentLatitude');
                        const lngField = document.getElementById('incidentLongitude');
                        if (latField) latField.value = lat;
                        if (lngField) lngField.value = lng;
                        
                        // Update the map if it's initialized
                        if (typeof incidentMap !== 'undefined' && incidentMap) {
                            const latNum = parseFloat(lat);
                            const lngNum = parseFloat(lng);
                            if (!isNaN(latNum) && !isNaN(lngNum)) {
                                incidentMap.setView([latNum, lngNum], 15);
                                if (typeof incidentMarker !== 'undefined' && incidentMarker) {
                                    incidentMarker.setLatLng([latNum, lngNum]);
                                } else {
                                    incidentMarker = L.marker([latNum, lngNum], { draggable: true }).addTo(incidentMap);
                                    incidentMarker.on('dragend', function(e) {
                                        const pos = e.target.getLatLng();
                                        updateMapCoordinatesDisplay(pos.lat, pos.lng);
                                        reverseGeocode(pos.lat, pos.lng);
                                    });
                                }
                                // Try to get the address for the location
                                reverseGeocode(latNum, lngNum);
                            }
                        }
                    }
                    
                    // Evidence already saved
                    this.existingEvidence = data.evidence || [];
                    if (this.existingEvidence.length) {
                        this.renderExistingEvidence(this.existingEvidence);
                    }

                    // Load Introduction Team Members
                    if (data.introTeamMembers && Array.isArray(data.introTeamMembers)) {
                        for (const member of data.introTeamMembers) {
                            await this.addIntroTeamMemberWithData(member);
                        }
                    }

                    // Load Persons Involved
                    if (data.personsInvolved && Array.isArray(data.personsInvolved)) {
                        for (const person of data.personsInvolved) {
                            this.addIncidentPersonWithData(person);
                        }
                    }

                    // Load Equipment Involved
                    if (data.equipmentInvolved && Array.isArray(data.equipmentInvolved)) {
                        for (const equipment of data.equipmentInvolved) {
                            this.addEquipmentWithData(equipment);
                        }
                    }

                    // Load Timeline Events
                    if (data.timelineEvents && Array.isArray(data.timelineEvents)) {
                        this.timelineEvents = data.timelineEvents;
                        data.timelineEvents.forEach(event => this.addTimelineEventWithData(event));
                        this.updateTimelineChart();
                    }

                    // Sequence Analysis
                    this.setFieldValue('fiveWhys', data.fiveWhys);
                    this.setFieldValue('eventTree', data.eventTree);

                    // Load PEEPO Analysis
                    if (data.peepo) {
                        // Load tag classifications first (before rendering tags)
                        if (data.peepo.tagClassifications) {
                            this.tagClassifications = data.peepo.tagClassifications;
                        }
                        
                        this.setFieldValue('peopleFactors', data.peepo.peopleFactors);
                        this.setFieldValue('equipmentFactors', data.peepo.equipmentFactors);
                        this.setFieldValue('environmentFactors', data.peepo.environmentFactors);
                        // Procedures replaces Barriers; support fallback
                        this.setFieldValue('procedures', data.peepo.procedures || data.peepo.barriers);
                        // Render tags for comma-separated values after setting fields
                        this.renderTagsForField('peopleFactors', 'peopleFactorsTags');
                        this.renderTagsForField('equipmentFactors', 'equipmentFactorsTags');
                        this.renderTagsForField('environmentFactors', 'environmentFactorsTags');
                        this.renderTagsForField('procedures', 'proceduresTags');
                        // Organization (Phase 1) optional
                        if (data.peepo.organizationFactorsP1) {
                            this.setFieldValue('organizationFactorsP1', data.peepo.organizationFactorsP1);
                            this.renderTagsForField('organizationFactorsP1', 'organizationFactorsP1Tags');
                        }
                        // Update Contributing Factors Summary after loading tags
                        this.renderContributingFactorsSummary();
                        // PEEPO 2 removed; no longer loading these fields
                    }

                    // Data Analysis
                    if (data.dataAnalysis) {
                        this.setFieldValue('dataCollected', data.dataAnalysis.dataCollected);
                        this.setFieldValue('analysisMethod', data.dataAnalysis.analysisMethod);
                        this.setFieldValue('keyFindings', data.dataAnalysis.keyFindings);
                        this.setFieldValue('exposureHours', data.dataAnalysis.exposureHours);
                        this.setFieldValue('trifr', data.dataAnalysis.trifr);
                        this.setFieldValue('ltifr', data.dataAnalysis.ltifr);
                        this.setFieldValue('riskResidual', data.dataAnalysis.riskResidual);
                        this.setFieldValue('dataSources', data.dataAnalysis.dataSources);
                        this.setFieldValue('analysisSummary', data.dataAnalysis.analysisSummary);
                        
                        // Load Statements
                        if (data.dataAnalysis.statements && Array.isArray(data.dataAnalysis.statements)) {
                            loadStatements(data.dataAnalysis.statements);
                        }
                    }

                    // Root Causes
                    if (data.rootCauseAnalysis) {
                        this.setFieldValue('immediateCauses', data.rootCauseAnalysis.immediateCauses);
                        // Absent/Failed Defenses (ICAM)
                        if (data.rootCauseAnalysis.failedDefensesData) {
                            // New format with comments
                            try {
                                const defData = typeof data.rootCauseAnalysis.failedDefensesData === 'string' 
                                    ? JSON.parse(data.rootCauseAnalysis.failedDefensesData) 
                                    : data.rootCauseAnalysis.failedDefensesData;
                                loadFailedDefenses(defData);
                            } catch (e) {
                                console.error('Error parsing failedDefensesData:', e);
                            }
                        } else if (data.rootCauseAnalysis.failedDefenses) {
                            // Legacy format - convert to new format
                            const codes = data.rootCauseAnalysis.failedDefenses.split(',').map(c => c.trim()).filter(c => c);
                            const legacyData = codes.map(code => ({ code, comment: '' }));
                            loadFailedDefenses(legacyData);
                        }
                        // Individual or Team Actions
                        if (data.rootCauseAnalysis.individualTeamActionsData) {
                            try {
                                const actData = typeof data.rootCauseAnalysis.individualTeamActionsData === 'string' 
                                    ? JSON.parse(data.rootCauseAnalysis.individualTeamActionsData) 
                                    : data.rootCauseAnalysis.individualTeamActionsData;
                                loadIndividualTeamActions(actData);
                            } catch (e) {
                                console.error('Error parsing individualTeamActionsData:', e);
                            }
                        }
                        // Task / Environmental Conditions
                        if (data.rootCauseAnalysis.taskEnvConditionsData) {
                            try {
                                const tecData = typeof data.rootCauseAnalysis.taskEnvConditionsData === 'string' 
                                    ? JSON.parse(data.rootCauseAnalysis.taskEnvConditionsData) 
                                    : data.rootCauseAnalysis.taskEnvConditionsData;
                                loadTaskEnvConditions(tecData);
                            } catch (e) {
                                console.error('Error parsing taskEnvConditionsData:', e);
                            }
                        }
                        // Organisational Factors
                        if (data.rootCauseAnalysis.orgFactorsData) {
                            try {
                                const ofData = typeof data.rootCauseAnalysis.orgFactorsData === 'string' 
                                    ? JSON.parse(data.rootCauseAnalysis.orgFactorsData) 
                                    : data.rootCauseAnalysis.orgFactorsData;
                                loadOrgFactors(ofData);
                            } catch (e) {
                                console.error('Error parsing orgFactorsData:', e);
                            }
                        }
                    }

                    // Contributing Factors
                    if (data.contributingFactors) {
                        this.setFieldValue('contributingFactors', data.contributingFactors.analysis);
                        this.setFieldValue('humanFactors', data.contributingFactors.humanFactors);
                        this.setFieldValue('msFactors', data.contributingFactors.msFactors);
                        this.setFieldValue('technicalFactors', data.contributingFactors.technicalFactors);
                        this.setFieldValue('additionalFactors', data.contributingFactors.additionalFactors);
                    }

                    // Load Recommendations
                    if (data.recommendations && Array.isArray(data.recommendations)) {
                        this.recommendations = data.recommendations;
                        data.recommendations.forEach(rec => this.addRecommendationWithData(rec));
                    }
                    if (data.recommendationsMeta) {
                        this.setFieldValue('recOwner', data.recommendationsMeta.owner);
                        this.setFieldValue('recTargetDate', data.recommendationsMeta.targetDate);
                        this.setFieldValue('recPriority', data.recommendationsMeta.priority);
                        this.setFieldValue('recVerification', data.recommendationsMeta.verification);
                    }

                    // Load Corrective Actions into the global array and render table
                    if (data.correctiveActions && Array.isArray(data.correctiveActions)) {
                        // Clear any existing data and populate the global array
                        if (typeof correctiveActionsData !== 'undefined') {
                            correctiveActionsData.length = 0; // Clear array
                            data.correctiveActions.forEach(action => {
                                const normalized = {
                                    id: String(action.id || Date.now()),
                                    owner: action.owner || action.actionOwner || action.assignee || '',
                                    dueDate: action.dueDate || action.actionDueDate || '',
                                    type: action.type || action.actionType || '',
                                    status: action.status || action.actionStatus || 'Pending',
                                    description: action.description || action.title || action.actionDescription || '',
                                    attachment: action.attachment || action.actionAttachment || ''
                                };
                                correctiveActionsData.push(normalized);
                            });
                            // Render the table with loaded data
                            if (typeof renderCorrectiveActionsTable === 'function') {
                                renderCorrectiveActionsTable();
                            }
                        }
                        this.correctiveActions = data.correctiveActions;
                    }

                    // Load Control tab fields
                    this.setFieldValue('lessonsLearned', data.lessonsLearned);
                    
                    // Load Verification Items
                    if (data.verificationItems && Array.isArray(data.verificationItems)) {
                        verificationItems = data.verificationItems;
                        // Update the counter to avoid ID conflicts
                        if (verificationItems.length > 0) {
                            verificationIdCounter = Math.max(...verificationItems.map(v => v.id || 0)) + 1;
                        }
                        renderVerificationItems();
                    }

                    // Load Approval fields
                    this.setFieldValue('investigationStatus', data.investigationStatus);
                    this.setFieldValue('approver', data.approver);
                    this.setFieldValue('approverComments', data.approverComments);
                    this.setFieldValue('preparedBy', data.preparedBy);
                    this.setFieldValue('preparedDate', data.preparedDate);
                    this.setFieldValue('reviewedBy', data.reviewedBy);
                    this.setFieldValue('reviewDate', data.reviewDate);
                    this.setFieldValue('approvedBy', data.approvedBy);
                    this.setFieldValue('approvalDate', data.approvalDate);
                    this.setFieldValue('approvalComments2', data.approvalComments2);

                    console.log('Investigation loaded for editing:', investigationId);

                } catch (error) {
                    console.error('Error loading investigation for edit:', error);
                    alert('Error loading investigation: ' + error.message);
                }
            }

            setFieldValue(fieldId, value) {
                const field = document.getElementById(fieldId);
                if (field && value !== undefined && value !== null) {
                    field.value = value;
                }
            }

            // --- Comma-tagging helpers for PEEPO 1 ---
            parseCommaList(text) {
                return String(text || '')
                    .split(',')
                    .map(s => s.trim())
                    .filter(Boolean);
            }

            renderTagsForField(fieldId, containerId) {
                const container = document.getElementById(containerId);
                const input = document.getElementById(fieldId);
                if (!container || !input) return;
                const items = this.parseCommaList(input.value || '');
                container.innerHTML = '';
                
                // Get classifications from storage
                const classifications = this.tagClassifications || {};
                
                items.forEach(item => {
                    const tag = document.createElement('span');
                    const classificationKey = `${fieldId}:${item}`;
                    const classification = classifications[classificationKey] || '';
                    tag.className = 'tag' + (classification ? ` ${classification}` : '');
                    tag.setAttribute('data-field', fieldId);
                    tag.setAttribute('data-value', item);
                    const safeItem = item.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    tag.innerHTML = `<span class="tag-indicator"></span><span class="tag-text">${safeItem}</span> <button type="button" class="tag-remove" title="Remove" onclick="event.stopPropagation(); investigationCreate.removeTagFromField('${fieldId}','${containerId}','${safeItem}')"></button>`;
                    
                    // Add click handler for classification
                    tag.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('tag-remove')) {
                            investigationCreate.showTagClassificationPopup(e, fieldId, item, containerId);
                        }
                    });
                    
                    container.appendChild(tag);
                });
            }

            bindCommaTagging(fieldId, containerId) {
                const input = document.getElementById(fieldId);
                if (!input) return;
                const handler = () => this.renderTagsForField(fieldId, containerId);
                input.addEventListener('input', handler);
                // initial render
                handler();
            }

            addTagFromInput(fieldId, containerId, inputId) {
                const inputEl = document.getElementById(inputId);
                const fieldEl = document.getElementById(fieldId);
                if (!inputEl || !fieldEl) return;
                const raw = (inputEl.value || '').trim();
                if (!raw) return;
                const parts = raw.split(',').map(s => s.trim()).filter(Boolean);
                const list = this.parseCommaList(fieldEl.value || '');
                parts.forEach(p => { if (!list.includes(p)) list.push(p); });
                fieldEl.value = list.join(', ');
                inputEl.value = '';
                this.renderTagsForField(fieldId, containerId);
            }

            removeTagFromField(fieldId, containerId, value) {
                const fieldEl = document.getElementById(fieldId);
                if (!fieldEl) return;
                const list = this.parseCommaList(fieldEl.value || '');
                const filtered = list.filter(item => item !== value);
                fieldEl.value = filtered.join(', ');
                // Also remove classification
                const classificationKey = `${fieldId}:${value}`;
                if (this.tagClassifications) {
                    delete this.tagClassifications[classificationKey];
                }
                this.renderTagsForField(fieldId, containerId);
            }

            showTagClassificationPopup(event, fieldId, value, containerId) {
                event.stopPropagation();
                
                // Remove any existing popup
                const existingPopup = document.querySelector('.tag-classification-popup');
                if (existingPopup) existingPopup.remove();
                
                // Create popup
                const popup = document.createElement('div');
                popup.className = 'tag-classification-popup show';
                popup.innerHTML = `
                    <div class="popup-header">Classify Factor</div>
                    <div class="popup-option contributing" data-classification="contributing">
                        <span class="option-dot"></span>
                        <span>Contributing Factor</span>
                    </div>
                    <div class="popup-option non-contributing" data-classification="non-contributing">
                        <span class="option-dot"></span>
                        <span>Non-Contributing Factor</span>
                    </div>
                    <div class="popup-option clear" data-classification="">
                        <span class="option-dot"></span>
                        <span>Clear Classification</span>
                    </div>
                `;
                
                // Position popup near the clicked tag
                const rect = event.currentTarget.getBoundingClientRect();
                popup.style.left = `${rect.left}px`;
                popup.style.top = `${rect.bottom + 5}px`;
                
                // Handle option clicks
                popup.querySelectorAll('.popup-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const classification = option.getAttribute('data-classification');
                        this.setTagClassification(fieldId, value, classification, containerId);
                        popup.remove();
                    });
                });
                
                document.body.appendChild(popup);
                
                // Close popup when clicking outside
                const closePopup = (e) => {
                    if (!popup.contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closePopup);
                    }
                };
                setTimeout(() => document.addEventListener('click', closePopup), 10);
            }

            setTagClassification(fieldId, value, classification, containerId) {
                if (!this.tagClassifications) {
                    this.tagClassifications = {};
                }
                const classificationKey = `${fieldId}:${value}`;
                if (classification) {
                    this.tagClassifications[classificationKey] = classification;
                } else {
                    delete this.tagClassifications[classificationKey];
                }
                this.renderTagsForField(fieldId, containerId);
                this.renderContributingFactorsSummary();
            }

            renderContributingFactorsSummary() {
                const container = document.getElementById('contributingFactorsSummary');
                if (!container) return;
                
                const classifications = this.tagClassifications || {};
                const contributingFactors = [];
                
                // Field labels for display
                const fieldLabels = {
                    'peopleFactors': 'People',
                    'equipmentFactors': 'Equipment',
                    'environmentFactors': 'Environment',
                    'procedures': 'Procedures',
                    'organizationFactorsP1': 'Organization'
                };
                
                // Collect all contributing factors
                Object.entries(classifications).forEach(([key, classification]) => {
                    if (classification === 'contributing') {
                        const [fieldId, ...valueParts] = key.split(':');
                        const value = valueParts.join(':'); // In case value contains colons
                        const category = fieldLabels[fieldId] || fieldId;
                        contributingFactors.push({ value, category, fieldId });
                    }
                });
                
                if (contributingFactors.length === 0) {
                    container.innerHTML = '<span style="color: #94a3b8; font-size: 0.85rem;">No contributing factors identified yet. Click on tags above and select "Contributing Factor" to add them here.</span>';
                    return;
                }
                
                container.innerHTML = contributingFactors.map(factor => {
                    const safeValue = factor.value.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    return `<span class="tag contributing" title="Category: ${factor.category}">
                        <span class="tag-indicator"></span>
                        <span class="tag-text">${safeValue}</span>
                        <span style="font-size: 0.65rem; color: #b91c1c; margin-left: 0.3rem;">(${factor.category})</span>
                    </span>`;
                }).join('');
            }

            async addIntroTeamMemberWithData(memberData) {
                // Use the existing addIntroTeamMember logic but pre-fill data
                if (this._addingTeamMember) return;
                this._addingTeamMember = true;

                try {
                    const { companyId } = await this.resolveCompanyContext();
                    if (!companyId) return;

                    const db = firebase.database();
                    const usersRef = db.ref(`companies/${companyId}/users`);
                    const snapshot = await usersRef.once('value');

                    let optionsHtml = '<option value="">Select Employee</option>';
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        Object.entries(users).forEach(([uid, userData]) => {
                            if (userData.role !== 'admin') {
                                const displayName = userData.displayName || userData.name || userData.email || 'Unknown';
                                let jobTitle = userData.jobTitle || userData.position || '';
                                if (jobTitle) {
                                    jobTitle = jobTitle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                                }
                                const displayText = jobTitle ? `${displayName} (${jobTitle})` : displayName;
                                const selected = memberData.employeeId === uid ? 'selected' : '';
                                optionsHtml += `<option value="${uid}" ${selected}>${displayText}</option>`;
                            }
                        });
                    }

                    const memberId = memberData.id || Date.now();
                    const container = document.getElementById('introTeamContainer');
                    if (!container) return;

                    const memberHtml = `
                        <div class="intro-team-member" data-member-id="${memberId}" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Employee:</label>
                                    <select class="intro-employee-select" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                        ${optionsHtml}
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Role:</label>
                                    <select class="intro-role-select" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                        <option value="">Select Role</option>
                                        <option value="Lead Investigator" ${memberData.role === 'Lead Investigator' ? 'selected' : ''}>Lead Investigator</option>
                                        <option value="HSE Representative" ${memberData.role === 'HSE Representative' ? 'selected' : ''}>HSE Representative</option>
                                        <option value="Supervisor" ${memberData.role === 'Supervisor' ? 'selected' : ''}>Supervisor</option>
                                        <option value="Technical Expert" ${memberData.role === 'Technical Expert' ? 'selected' : ''}>Technical Expert</option>
                                        <option value="Team Member" ${memberData.role === 'Team Member' ? 'selected' : ''}>Team Member</option>
                                        <option value="Observer" ${memberData.role === 'Observer' ? 'selected' : ''}>Observer</option>
                                    </select>
                                </div>
                                <button class="btn btn-danger" onclick="removeIntroTeamMember('${memberId}')" style="font-size: 0.8rem; padding: 0.5rem 0.75rem; height: fit-content;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                    container.insertAdjacentHTML('beforeend', memberHtml);
                    this.introTeamMembers.push(memberId);
                } finally {
                    this._addingTeamMember = false;
                }
            }

            addTimelineEventWithData(event) {
                const eventId = event.id || Date.now();
                const timelineContainer = document.getElementById('timelineContainer');
                // Build default datetime value
                const now = new Date();
                const defaultDateTime = event.datetime || (event.date && event.time ? `${event.date}T${event.time}` : `${now.toISOString().slice(0,10)}T${now.toTimeString().slice(0,5)}`);
                
                const eventHtml = `
                    <div data-event-id="${eventId}" style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="min-width: 180px;">
                            <input type="datetime-local" value="${defaultDateTime}" style="padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; width: 100%;">
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex: 1;">
                            <input type="text" value="${event.title || ''}" placeholder="Event title" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <input type="text" value="${event.description || ''}" placeholder="Event description" style="flex: 2; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" onclick="updateTimelineChart()" title="Save & Update Timeline" style="padding: 0.25rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; background: #dcfce7; color: #059669;">
                                <i class="fas fa-save"></i>
                            </button>
                            <button type="button" onclick="removeTimelineEvent('${eventId}')" style="padding: 0.25rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; background: #fee2e2; color: #dc2626;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                timelineContainer.insertAdjacentHTML('beforeend', eventHtml);
                this.updateTimelineChart();
            }

            addRecommendationWithData(rec) {
                const recommendationId = rec.id || Date.now();
                const container = document.getElementById('recommendationsContainer');
                
                const recommendationHtml = `
                    <div class="form-section" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-top: 1rem;" data-recommendation-id="${recommendationId}">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Priority</label>
                                <select class="rec-priority">
                                    <option value="High" ${rec.priority === 'High' ? 'selected' : ''}>High</option>
                                    <option value="Medium" ${rec.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                    <option value="Low" ${rec.priority === 'Low' ? 'selected' : ''}>Low</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Target Date</label>
                                <input type="date" class="rec-date" value="${rec.targetDate || ''}">
                            </div>
                            <div class="form-group full-width">
                                <label>Recommendation</label>
                                <textarea class="rec-text" rows="3" placeholder="Enter recommendation details...">${rec.description || rec.title || ''}</textarea>
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger" style="margin-top: 1rem;" onclick="removeRecommendation('${recommendationId}')">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', recommendationHtml);
            }

            addCorrectiveActionWithData(action) {
                const actionId = action.id || Date.now();
                const container = document.getElementById('correctiveActionsContainer');
                
                // Hide empty state when adding an action
                const emptyState = document.getElementById('correctiveActionsEmpty');
                if (emptyState) emptyState.style.display = 'none';

                // Sync with modal/table data model so editing works
                try {
                    if (typeof correctiveActionsData !== 'undefined') {
                        const normalized = {
                            id: String(actionId),
                            owner: action.owner || action.actionOwner || '',
                            dueDate: action.dueDate || action.actionDueDate || '',
                            type: action.type || action.actionType || '',
                            status: action.status || action.actionStatus || 'Pending',
                            description: action.description || action.title || action.actionDescription || '',
                            attachment: action.attachment || action.actionAttachment || ''
                        };
                        // Avoid duplicates when reloading
                        const exists = correctiveActionsData.some(a => String(a.id) === String(normalized.id));
                        if (!exists) correctiveActionsData.push(normalized);
                        // Ensure table reflects loaded data
                        if (typeof renderCorrectiveActionsTable === 'function') {
                            renderCorrectiveActionsTable();
                        }
                    }
                } catch(e) { /* noop */ }
                
                const actionHtml = `
                    <div class="form-section" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.5rem; margin-bottom: 0.25rem; font-size: 0.8rem;" data-action-id="${actionId}">
                        <div style="display: flex; flex-wrap: nowrap; gap: 0.5rem; align-items: flex-end; margin-bottom: 0.25rem;">
                            <div style="display: flex; flex-direction: column; gap: 0.2rem; flex: 1; min-width: 120px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: #374151;">Action Owner</label>
                                <select class="action-owner-select" data-action-owner="${actionId}" style="font-size: 0.75rem; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="">-- Select --</option>
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.2rem; min-width: 100px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: #374151;">Due Date</label>
                                <input type="date" class="action-date" value="${action.dueDate || ''}" style="font-size: 0.75rem; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.2rem; min-width: 110px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: #374151;">Action Type</label>
                                <select class="action-type" style="font-size: 0.75rem; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="Elimination" ${action.type === 'Elimination' ? 'selected' : ''}>Elimination</option>
                                    <option value="Substitution" ${action.type === 'Substitution' ? 'selected' : ''}>Substitution</option>
                                    <option value="Engineering Control" ${action.type === 'Engineering Control' ? 'selected' : ''}>Engineering Control</option>
                                    <option value="Administrative Control" ${action.type === 'Administrative Control' ? 'selected' : ''}>Administrative Control</option>
                                    <option value="PPE" ${action.type === 'PPE' ? 'selected' : ''}>PPE</option>
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.2rem; min-width: 90px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: #374151;">Status</label>
                                <select class="action-status" style="font-size: 0.75rem; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="Pending" ${action.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="In Progress" ${action.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Completed" ${action.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: flex-end; margin-bottom: 0.25rem;">
                            <div style="display: flex; flex-direction: column; gap: 0.2rem; flex: 1;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: #374151;">Description</label>
                                <input type="text" class="action-desc" placeholder="Action description" value="${action.description || action.title || ''}" style="font-size: 0.75rem; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 0.2rem; min-width: 120px;">
                                <label style="font-size: 0.7rem; font-weight: 600; color: #374151;">Attachment</label>
                                <input type="file" class="action-attachment" accept="image/*,.pdf,.doc,.docx" style="font-size: 0.7rem;">
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button type="button" class="btn btn-danger" style="font-size: 0.7rem; padding: 0.3rem 0.5rem;" onclick="removeCorrectiveAction('${actionId}')" title="Remove">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', actionHtml);
                
                // Load employees into the action owner dropdown
                this.loadEmployeesForActionOwner(actionId, action.assignee || action.owner || '');
            }

            async loadEmployeesForActionOwner(actionId, selectedValue) {
                const select = document.querySelector(`[data-action-owner="${actionId}"]`);
                if (!select) return;
                
                try {
                    const { companyId } = await this.resolveCompanyContext();
                    const snapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
                    const users = snapshot.val() || {};
                    
                    const employees = Object.entries(users).filter(([_, user]) => user.role !== 'admin');
                    
                    employees.forEach(([userId, user]) => {
                        const option = document.createElement('option');
                        option.value = userId;
                        const name = user.name || user.displayName || user.email || 'Unknown';
                        let jobTitle = user.jobTitleLabel || user.jobTitle || '';
                        if (jobTitle.includes('-')) {
                            jobTitle = jobTitle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        }
                        option.textContent = `${name}${jobTitle ? ` (${jobTitle})` : ''}`;
                        if (userId === selectedValue || name === selectedValue) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading employees for action owner:', error);
                }
            }

            collectTimelineEvents() {
                const events = [];
                const timelineContainer = document.getElementById('timelineContainer');
                if (!timelineContainer) return events;
                timelineContainer.querySelectorAll('[data-event-id]').forEach(el => {
                    const datetimeValue = el.querySelector('input[type="datetime-local"]')?.value || '';
                    const [datePart, timePart] = datetimeValue.split('T');
                    const inputs = el.querySelectorAll('input[type="text"]');
                    const title = inputs[0]?.value || '';
                    const description = inputs[1]?.value || '';
                    if (datetimeValue || title || description) {
                        events.push({ id: el.dataset.eventId, datetime: datetimeValue, date: datePart || '', time: timePart || '', title, description });
                    }
                });
                return events;
            }

            collectRecommendations() {
                const recs = [];
                document.querySelectorAll('[data-recommendation-id]').forEach(el => {
                    const priority = el.querySelector('.rec-priority')?.value || '';
                    const targetDate = el.querySelector('.rec-date')?.value || '';
                    const description = el.querySelector('.rec-text')?.value || '';
                    if (priority || targetDate || description) {
                        recs.push({ id: el.dataset.recommendationId, priority, targetDate, description });
                    }
                });
                return recs;
            }

            collectCorrectiveActions() {
                // Read from the correctiveActionsData array managed by the modal/table UI
                if (typeof correctiveActionsData !== 'undefined' && Array.isArray(correctiveActionsData)) {
                    return correctiveActionsData.map(action => ({
                        id: action.id || '',
                        type: action.type || '',
                        owner: action.owner || '',
                        dueDate: action.dueDate || '',
                        status: action.status || 'Pending',
                        description: action.description || '',
                        attachment: action.attachment || ''
                    }));
                }
                return [];
            }

            async uploadEvidenceFiles(companyId, investigationId) {
                if (!this.pendingEvidenceFiles.length) return [];
                const storage = firebase.storage();
                const folderRef = storage.ref(`companies/${companyId}/investigations/${investigationId}/evidence`);
                const uploads = this.pendingEvidenceFiles.map(async (fileEntry) => {
                    // Support both old format (File object) and new format (fileEntry object)
                    const file = fileEntry.file || fileEntry;
                    const customName = fileEntry.customName || file.name;
                    const safeName = `${Date.now()}-${customName}`;
                    const fileRef = folderRef.child(safeName);
                    await fileRef.put(file);
                    const url = await fileRef.getDownloadURL();
                    return {
                        name: customName,
                        originalName: fileEntry.originalName || file.name,
                        type: file.type,
                        size: file.size,
                        url,
                        storagePath: fileRef.fullPath,
                        uploadedAt: Date.now()
                    };
                });
                const results = await Promise.all(uploads);
                // Clear pending list after upload
                this.pendingEvidenceFiles = [];
                return results;
            }

            renderExistingEvidence(list) {
                const tableBody = document.getElementById('evidenceFilesTableBody');
                if (!tableBody) return;
                // Clear then render existing evidence files
                tableBody.innerHTML = '';
                
                list.forEach(item => {
                    const row = document.createElement('tr');
                    row.dataset.existing = 'true';
                    row.dataset.url = item.url;
                    
                    // Preview cell
                    const previewCell = document.createElement('td');
                    if (item.type && item.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = item.url;
                        img.style.cssText = 'width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer;';
                        img.onclick = () => window.open(item.url, '_blank');
                        previewCell.appendChild(img);
                    } else {
                        const iconMap = {
                            'application/pdf': 'fa-file-pdf',
                            'application/msword': 'fa-file-word',
                            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fa-file-word'
                        };
                        const iconClass = iconMap[item.type] || 'fa-file';
                        previewCell.innerHTML = `<i class="fas ${iconClass}" style="font-size: 1.5rem; color: #64748b; cursor: pointer;" onclick="window.open('${item.url}', '_blank')"></i>`;
                    }
                    row.appendChild(previewCell);
                    
                    // File name cell
                    const nameCell = document.createElement('td');
                    const link = document.createElement('a');
                    link.href = item.url;
                    link.target = '_blank';
                    link.rel = 'noopener noreferrer';
                    link.textContent = item.name || 'Evidence file';
                    link.style.cssText = 'color: #3b82f6; text-decoration: none; word-break: break-all;';
                    nameCell.appendChild(link);
                    row.appendChild(nameCell);
                    
                    // Type cell
                    const typeCell = document.createElement('td');
                    const extension = (item.name || '').split('.').pop().toUpperCase() || 'FILE';
                    typeCell.textContent = extension;
                    typeCell.style.color = '#64748b';
                    row.appendChild(typeCell);
                    
                    // Size cell
                    const sizeCell = document.createElement('td');
                    sizeCell.textContent = item.size ? this.formatFileSize(item.size) : '-';
                    sizeCell.style.color = '#64748b';
                    row.appendChild(sizeCell);
                    
                    // Actions cell (view, edit, and delete buttons for existing files)
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'actions-cell';
                    actionsCell.style.cssText = 'display: flex; gap: 0.25rem; justify-content: center;';
                    
                    // Edit/Rename button
                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.className = 'btn-icon edit-btn';
                    editBtn.title = 'Rename';
                    editBtn.style.cssText = 'background: none; border: 1px solid #e5e7eb; cursor: pointer; padding: 0.25rem 0.4rem; border-radius: 4px;';
                    editBtn.innerHTML = '<i class="fas fa-edit" style="color: #3b82f6;"></i>';
                    
                    // Create editable input for renaming (hidden by default)
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = item.name || 'Evidence file';
                    nameInput.style.cssText = 'width: 100%; padding: 0.35rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem; display: none;';
                    nameInput.className = 'evidence-file-input';
                    nameCell.appendChild(nameInput);
                    
                    editBtn.onclick = () => {
                        const isEditing = nameInput.style.display !== 'none';
                        if (isEditing) {
                            // Save the new name
                            const newName = nameInput.value.trim() || item.name || 'Evidence file';
                            item.name = newName;
                            link.textContent = newName;
                            link.style.display = '';
                            nameInput.style.display = 'none';
                            editBtn.innerHTML = '<i class="fas fa-edit" style="color: #3b82f6;"></i>';
                            editBtn.title = 'Rename';
                        } else {
                            // Enter edit mode
                            nameInput.value = item.name || 'Evidence file';
                            link.style.display = 'none';
                            nameInput.style.display = '';
                            nameInput.focus();
                            nameInput.select();
                            editBtn.innerHTML = '<i class="fas fa-check" style="color: #059669;"></i>';
                            editBtn.title = 'Save';
                        }
                    };
                    
                    // Handle Enter key to save
                    nameInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            editBtn.click();
                        } else if (e.key === 'Escape') {
                            // Cancel editing
                            link.style.display = '';
                            nameInput.style.display = 'none';
                            editBtn.innerHTML = '<i class="fas fa-edit" style="color: #3b82f6;"></i>';
                            editBtn.title = 'Rename';
                        }
                    });
                    
                    actionsCell.appendChild(editBtn);
                    
                    // View button
                    const viewBtn = document.createElement('button');
                    viewBtn.type = 'button';
                    viewBtn.className = 'btn-icon view-btn';
                    viewBtn.title = 'View/Download';
                    viewBtn.style.cssText = 'background: none; border: 1px solid #e5e7eb; cursor: pointer; padding: 0.25rem 0.4rem; border-radius: 4px;';
                    viewBtn.innerHTML = '<i class="fas fa-external-link-alt" style="color: #3b82f6;"></i>';
                    viewBtn.onclick = () => window.open(item.url, '_blank');
                    actionsCell.appendChild(viewBtn);
                    
                    // Delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'btn-icon delete-btn';
                    deleteBtn.title = 'Delete';
                    deleteBtn.style.cssText = 'background: none; border: 1px solid #e5e7eb; cursor: pointer; padding: 0.25rem 0.4rem; border-radius: 4px;';
                    deleteBtn.innerHTML = '<i class="fas fa-trash" style="color: #dc2626;"></i>';
                    deleteBtn.onclick = () => {
                        if (confirm('Are you sure you want to delete this evidence file?')) {
                            // Remove from existingEvidence array
                            const index = this.existingEvidence.findIndex(e => e.url === item.url);
                            if (index > -1) {
                                this.existingEvidence.splice(index, 1);
                            }
                            row.remove();
                            this.updateEvidenceTableVisibility();
                        }
                    };
                    actionsCell.appendChild(deleteBtn);
                    
                    row.appendChild(actionsCell);
                    
                    tableBody.appendChild(row);
                });
                
                this.updateEvidenceTableVisibility();
            }

            addIncidentPersonWithData(personData) {
                if (!window.incidentPersons) window.incidentPersons = [];
                const personId = personData.id || Date.now();
                const container = document.getElementById('incidentPersonsContainer');
                if (!container) return;

                const personHtml = `
                    <div class="incident-person" data-person-id="${personId}" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Name:</label>
                                <input type="text" class="incident-person-name" value="${personData.name || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Full Name">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Company:</label>
                                <input type="text" class="incident-person-company" value="${personData.company || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Company Name">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Job Title:</label>
                                <input type="text" class="incident-person-jobtitle" value="${personData.jobTitle || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Job Title">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Phone Number:</label>
                                <input type="text" class="incident-person-phone" value="${personData.phone || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Phone Number">
                            </div>
                            <button class="btn btn-danger" onclick="removeIncidentPerson('${personId}')" style="font-size: 0.8rem; padding: 0.5rem 0.75rem; height: fit-content;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', personHtml);
                window.incidentPersons.push(personId);
            }

            addEquipmentWithData(equipmentData) {
                if (!window.equipmentInvolved) window.equipmentInvolved = [];
                const equipmentId = equipmentData.id || Date.now();
                const container = document.getElementById('equipmentInvolvedContainer');
                if (!container) return;

                const conditionOptions = ['', 'Good', 'Damaged', 'Defective', 'Unknown'].map(opt => 
                    `<option value="${opt}" ${equipmentData.condition === opt ? 'selected' : ''}>${opt || 'Select Condition'}</option>`
                ).join('');

                const equipmentHtml = `
                    <div class="equipment-involved" data-equipment-id="${equipmentId}" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Equipment Name:</label>
                                <input type="text" class="equipment-name" value="${equipmentData.name || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Equipment Name">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Equipment ID/Serial:</label>
                                <input type="text" class="equipment-serial" value="${equipmentData.serial || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="ID or Serial Number">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Type/Category:</label>
                                <input type="text" class="equipment-type" value="${equipmentData.type || ''}" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Type or Category">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Condition:</label>
                                <select class="equipment-condition" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                    ${conditionOptions}
                                </select>
                            </div>
                            <button class="btn btn-danger" onclick="removeEquipmentInvolved('${equipmentId}')" style="font-size: 0.8rem; padding: 0.5rem 0.75rem; height: fit-content;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', equipmentHtml);
                window.equipmentInvolved.push(equipmentId);
            }

            renderTimelineEvent(event) {
                const container = document.getElementById('timelineContainer');
                if (!container) return;
                
                const eventHtml = `
                    <div class="timeline-event" data-event-id="${event.id}">
                        <div class="event-time">${event.time || ''}</div>
                        <div class="event-content">
                            <h4>${event.title || ''}</h4>
                            <p>${event.description || ''}</p>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeTimelineEvent('${event.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', eventHtml);
            }

            renderRecommendation(rec) {
                const container = document.getElementById('recommendationsContainer');
                if (!container) return;
                
                const recHtml = `
                    <div class="recommendation-item" data-rec-id="${rec.id}">
                        <div class="rec-content">
                            <strong>${rec.title || ''}</strong>
                            <p>${rec.description || ''}</p>
                            <span class="badge">${rec.priority || ''}</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeRecommendation('${rec.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', recHtml);
            }

            renderCorrectiveAction(action) {
                const container = document.getElementById('correctiveActionsContainer');
                if (!container) return;
                
                const actionHtml = `
                    <div class="action-item" data-action-id="${action.id}">
                        <div class="action-content">
                            <strong>${action.title || ''}</strong>
                            <p>${action.description || ''}</p>
                            <span class="badge">${action.status || ''}</span>
                            <span class="badge">${action.assignee || ''}</span>
                            <span class="due-date">${action.dueDate || ''}</span>
                        </div>
                        <button class="btn btn-danger btn-sm" onclick="removeCorrectiveAction('${action.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', actionHtml);
            }

            async resolveCompanyContext(){
                const user = window.authManager?.currentUser || null;
                const companyId = user?.companyId || null;
                const userId = user?.uid || user?.id || null;
                if(!companyId){
                    // Attempt fallback lookup similar to AuthManager
                    try{
                        const localUser = JSON.parse(localStorage.getItem('currentUser')||'null');
                        if(localUser?.companyId){
                            return { companyId: localUser.companyId, userId: localUser.uid || localUser.id || null };
                        }
                    }catch(e){ /* noop */ }
                }
                return { companyId, userId };
            }

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });

                // File upload
                const evidenceInput = document.getElementById('evidenceFiles');
                if (evidenceInput) {
                    evidenceInput.addEventListener('change', (e) => {
                        this.handleFileUpload(e.target.files);
                    });
                }
                // Header/profile and sidebar interactions are handled by the shared AuthManager/initializePage logic

                // Bind comma-tagging for PEEPO 1 fields
                this.bindCommaTagging('peopleFactors', 'peopleFactorsTags');
                this.bindCommaTagging('equipmentFactors', 'equipmentFactorsTags');
                this.bindCommaTagging('environmentFactors', 'environmentFactorsTags');
                this.bindCommaTagging('procedures', 'proceduresTags');
                this.bindCommaTagging('organizationFactorsP1', 'organizationFactorsP1Tags');
            }

            switchTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });

                // Remove active from all buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Show selected tab
                document.getElementById(tabName).classList.add('active');
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                this.currentTab = tabName;
            }

            handleFileUpload(files) {
                const tableBody = document.getElementById('evidenceFilesTableBody');
                const table = document.getElementById('evidenceFilesTable');
                const emptyState = document.getElementById('evidenceFilesEmpty');
                if (!tableBody) return;

                Array.from(files).forEach(file => {
                    // Store with custom name support
                    const fileEntry = {
                        file: file,
                        originalName: file.name,
                        customName: file.name,
                        id: Date.now() + Math.random().toString(36).substr(2, 9)
                    };
                    this.pendingEvidenceFiles.push(fileEntry);

                    const row = document.createElement('tr');
                    row.dataset.fileId = fileEntry.id;
                    
                    // Preview cell
                    const previewCell = document.createElement('td');
                    if (file.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = URL.createObjectURL(file);
                        img.style.cssText = 'width: 40px; height: 40px; object-fit: cover; border-radius: 4px;';
                        previewCell.appendChild(img);
                    } else {
                        const iconMap = {
                            'application/pdf': 'fa-file-pdf',
                            'application/msword': 'fa-file-word',
                            'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fa-file-word'
                        };
                        const iconClass = iconMap[file.type] || 'fa-file';
                        previewCell.innerHTML = `<i class="fas ${iconClass}" style="font-size: 1.5rem; color: #64748b;"></i>`;
                    }
                    row.appendChild(previewCell);

                    // File name cell with editable input
                    const nameCell = document.createElement('td');
                    const nameWrapper = document.createElement('div');
                    nameWrapper.style.cssText = 'display: flex; align-items: center; gap: 0.5rem;';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'evidence-file-name';
                    nameSpan.textContent = fileEntry.customName;
                    nameSpan.style.cssText = 'flex: 1; word-break: break-all;';
                    
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = fileEntry.customName;
                    nameInput.style.cssText = 'flex: 1; padding: 0.35rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem; display: none;';
                    nameInput.className = 'evidence-file-input';
                    
                    nameWrapper.appendChild(nameSpan);
                    nameWrapper.appendChild(nameInput);
                    nameCell.appendChild(nameWrapper);
                    row.appendChild(nameCell);

                    // Type cell
                    const typeCell = document.createElement('td');
                    const extension = file.name.split('.').pop().toUpperCase();
                    typeCell.textContent = extension;
                    typeCell.style.color = '#64748b';
                    row.appendChild(typeCell);

                    // Size cell
                    const sizeCell = document.createElement('td');
                    sizeCell.textContent = this.formatFileSize(file.size);
                    sizeCell.style.color = '#64748b';
                    row.appendChild(sizeCell);

                    // Actions cell
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'actions-cell';
                    actionsCell.innerHTML = `
                        <button type="button" class="btn-icon rename-btn" title="Rename" style="background: none; border: 1px solid #e5e7eb; cursor: pointer; padding: 0.25rem 0.4rem; border-radius: 4px; margin-right: 0.25rem;">
                            <i class="fas fa-edit" style="color: #3b82f6;"></i>
                        </button>
                        <button type="button" class="btn-icon delete-btn" title="Delete" style="background: none; border: 1px solid #e5e7eb; cursor: pointer; padding: 0.25rem 0.4rem; border-radius: 4px;">
                            <i class="fas fa-trash" style="color: #dc2626;"></i>
                        </button>
                    `;
                    
                    // Rename button handler
                    const renameBtn = actionsCell.querySelector('.rename-btn');
                    renameBtn.addEventListener('click', () => {
                        const isEditing = nameInput.style.display !== 'none';
                        if (isEditing) {
                            // Save
                            fileEntry.customName = nameInput.value || fileEntry.originalName;
                            nameSpan.textContent = fileEntry.customName;
                            nameSpan.style.display = '';
                            nameInput.style.display = 'none';
                            renameBtn.innerHTML = '<i class="fas fa-edit" style="color: #3b82f6;"></i>';
                            renameBtn.title = 'Rename';
                        } else {
                            // Edit
                            nameInput.value = fileEntry.customName;
                            nameSpan.style.display = 'none';
                            nameInput.style.display = '';
                            nameInput.focus();
                            nameInput.select();
                            renameBtn.innerHTML = '<i class="fas fa-check" style="color: #059669;"></i>';
                            renameBtn.title = 'Save';
                        }
                    });
                    
                    // Save on Enter key
                    nameInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            renameBtn.click();
                        } else if (e.key === 'Escape') {
                            nameInput.value = fileEntry.customName;
                            nameSpan.style.display = '';
                            nameInput.style.display = 'none';
                            renameBtn.innerHTML = '<i class="fas fa-edit" style="color: #3b82f6;"></i>';
                            renameBtn.title = 'Rename';
                        }
                    });
                    
                    // Delete button handler
                    const deleteBtn = actionsCell.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', () => {
                        this.pendingEvidenceFiles = this.pendingEvidenceFiles.filter(f => f.id !== fileEntry.id);
                        row.remove();
                        this.updateEvidenceTableVisibility();
                    });
                    
                    row.appendChild(actionsCell);
                    tableBody.appendChild(row);
                });
                
                this.updateEvidenceTableVisibility();
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            updateEvidenceTableVisibility() {
                const table = document.getElementById('evidenceFilesTable');
                const emptyState = document.getElementById('evidenceFilesEmpty');
                const hasFiles = this.pendingEvidenceFiles.length > 0 || (this.existingEvidence && this.existingEvidence.length > 0);
                
                if (table) table.style.display = hasFiles ? 'table' : 'none';
                if (emptyState) emptyState.style.display = hasFiles ? 'none' : 'block';
            }

            addTimelineEvent() {
                this.addTimelineEventWithData({});
            }

            removeTimelineEvent(eventId) {
                document.querySelector(`[data-event-id="${eventId}"]`).remove();
                this.updateTimelineChart();
            }

            addRecommendation() {
                this.addRecommendationWithData({});
            }

            removeRecommendation(recommendationId) {
                document.querySelector(`[data-recommendation-id="${recommendationId}"]`).remove();
            }

            addCorrectiveAction() {
                openCorrectiveActionModal();
            }

            removeCorrectiveAction(actionId) {
                document.querySelector(`[data-action-id="${actionId}"]`).remove();
                
                // Show empty state if no actions remain
                const container = document.getElementById('correctiveActionsContainer');
                const emptyState = document.getElementById('correctiveActionsEmpty');
                if (container && emptyState && container.children.length === 0) {
                    emptyState.style.display = 'block';
                }
            }

            addTeamMember() {
                const memberId = Date.now();
                const container = document.getElementById('teamMembersContainer');
                
                const memberHtml = `
                    <div class="team-member" data-member-id="${memberId}">
                        <div class="team-member-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="team-member-info">
                            <input type="text" placeholder="Team member name" class="team-member-name" style="border: none; background: none; font-weight: 600; width: 100%;">
                            <input type="text" placeholder="Role/Position" class="team-member-role" style="border: none; background: none; font-size: 0.85rem; color: #64748b; width: 100%;">
                        </div>
                        <div class="team-member-actions">
                            <button class="btn btn-danger" onclick="removeTeamMember(${memberId})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', memberHtml);
            }

            removeTeamMember(memberId) {
                document.querySelector(`[data-member-id="${memberId}"]`).remove();
            }

            async addIntroTeamMember() {
                // Prevent double execution
                if (this._addingTeamMember) return;
                this._addingTeamMember = true;

                const memberId = Date.now();
                const container = document.getElementById('introTeamContainer');
                if (!container) {
                    this._addingTeamMember = false;
                    return;
                }

                let employeeOptions = '<option value="">Select Employee</option>';
                try {
                    const { companyId } = await this.resolveCompanyContext();
                    const snapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
                    const users = snapshot.val() || {};
                    const employees = Object.entries(users).filter(([_, user]) => user.role !== 'admin');
                    employees.forEach(([userId, user]) => {
                        const displayName = user.name || user.displayName || user.email || 'Unknown';
                        let jobTitle = user.jobTitleLabel || user.jobTitle || user.position || '';
                        if (jobTitle) jobTitle = jobTitle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        const displayText = jobTitle ? `${displayName} (${jobTitle})` : displayName;
                        employeeOptions += `<option value="${userId}" data-name="${displayName}" data-jobtitle="${jobTitle || user.role || 'Employee'}">${displayText}</option>`;
                    });
                } catch (error) {
                    console.error('Error loading employees for team member:', error);
                    employeeOptions = '<option value="">Error loading employees</option>';
                }

                // Match markup with edit-mode renderer so collection works
                const memberHtml = `
                    <div class="intro-team-member" data-member-id="${memberId}" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Employee:</label>
                                <select class="intro-employee-select" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                    ${employeeOptions}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Role:</label>
                                <select class="intro-role-select" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                    <option value="">Select Role</option>
                                    <option value="Lead Investigator">Lead Investigator</option>
                                    <option value="HSE Representative">HSE Representative</option>
                                    <option value="Supervisor">Supervisor</option>
                                    <option value="Technical Expert">Technical Expert</option>
                                    <option value="Team Member">Team Member</option>
                                    <option value="Observer">Observer</option>
                                </select>
                            </div>
                            <button class="btn btn-danger" onclick="removeIntroTeamMember('${memberId}')" style="font-size: 0.8rem; padding: 0.5rem 0.75rem; height: fit-content;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', memberHtml);
                this.introTeamMembers.push(memberId);
                this._addingTeamMember = false;
            }

            removeIntroTeamMember(memberId) {
                const el = document.querySelector(`[data-member-id="${memberId}"]`);
                if (el) el.remove();
                this.introTeamMembers = this.introTeamMembers.filter(id => id !== Number(memberId) && `intro-${id}` !== memberId);
            }

            async loadActionOwnerEmployees() {
                const select = document.getElementById('actionOwner');
                if (!select) return;
                
                try {
                    const { companyId } = await this.resolveCompanyContext();
                    const snapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
                    const users = snapshot.val() || {};
                    
                    // Filter to get only employees (non-admin users)
                    const employees = Object.entries(users).filter(([_, user]) => user.role !== 'admin');
                    
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">-- Select Action Owner --</option>';
                    
                    if (employees.length === 0) {
                        select.innerHTML = '<option value="">No employees found</option>';
                        return;
                    }
                    
                    // Add employee options - format: Name (Job Title)
                    employees.forEach(([userId, user]) => {
                        const option = document.createElement('option');
                        option.value = userId;
                        const name = user.name || user.displayName || user.email || 'Unknown';
                        let jobTitle = user.jobTitleLabel || user.jobTitle || '';
                        if (jobTitle.includes('-')) {
                            jobTitle = jobTitle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        }
                        option.textContent = `${name}${jobTitle ? ` (${jobTitle})` : ''}`;
                        option.setAttribute('data-name', name);
                        select.appendChild(option);
                    });
                    
                } catch (error) {
                    console.error('Error loading employees for action owner:', error);
                    select.innerHTML = '<option value="">Error loading employees</option>';
                }
            }

            async loadEmployeesForTeamMember(memberId) {
                const select = document.querySelector(`[data-member="${memberId}"]`);
                const loadingEl = select?.parentElement.querySelector('.employee-loading');
                
                if (!select) return;
                
                try {
                    if (loadingEl) loadingEl.style.display = 'block';
                    
                    const { companyId } = await this.resolveCompanyContext();
                    const snapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
                    const users = snapshot.val() || {};
                    
                    // Filter to get only employees (non-admin users)
                    const employees = Object.entries(users).filter(([_, user]) => user.role !== 'admin');
                    
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">-- Select an employee --</option>';
                    
                    if (employees.length === 0) {
                        select.innerHTML = '<option value="">No employees found</option>';
                        return;
                    }
                    
                    // Add employee options - format: Name (Job Title)
                    employees.forEach(([userId, user]) => {
                        const option = document.createElement('option');
                        option.value = userId;
                        const name = user.name || user.displayName || user.email || 'Unknown';
                        // Use jobTitleLabel if available, otherwise convert jobTitle slug to readable format
                        let jobTitle = user.jobTitleLabel || user.jobTitle || '';
                        // Replace dashes with spaces and capitalize words
                        if (jobTitle.includes('-')) {
                            jobTitle = jobTitle.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        }
                        // Format: Name (Job Title)
                        option.textContent = `${name}${jobTitle ? ` (${jobTitle})` : ''}`;
                        option.setAttribute('data-name', name);
                        option.setAttribute('data-jobtitle', jobTitle || user.role || 'Employee');
                        select.appendChild(option);
                    });
                    
                } catch (error) {
                    console.error('Error loading employees for team member:', error);
                    select.innerHTML = '<option value="">Error loading employees</option>';
                } finally {
                    if (loadingEl) loadingEl.style.display = 'none';
                }
            }

            initializeTimelineChart() {
                // Timeline visualization is now rendered as HTML nodes
                this.updateTimelineChart();
            }

            updateTimelineChart() {
                const events = document.querySelectorAll('[data-event-id]');
                const track = document.getElementById('timelineVizTrack');
                if (!track) return;

                // Collect event data
                const eventData = [];
                events.forEach((event) => {
                    const datetimeInput = event.querySelector('input[type="datetime-local"]');
                    const inputs = event.querySelectorAll('input[type="text"]');
                    const titleInput = inputs[0];
                    const descInput = inputs[1];
                    if (datetimeInput) {
                        const dtValue = datetimeInput.value || '';
                        const [datePart, timePart] = dtValue.split('T');
                        eventData.push({
                            datetime: dtValue,
                            date: datePart || '',
                            time: timePart || '00:00',
                            title: titleInput?.value || 'Untitled',
                            description: descInput?.value || ''
                        });
                    }
                });

                // Sort by date then time
                eventData.sort((a, b) => {
                    const dateA = a.date + ' ' + a.time;
                    const dateB = b.date + ' ' + b.time;
                    return dateA.localeCompare(dateB);
                });

                // Build timeline HTML
                if (eventData.length === 0) {
                    track.innerHTML = '<div class="timeline-empty">Add events above to see the chronological timeline</div>';
                    return;
                }

                let html = '';
                eventData.forEach((ev, idx) => {
                    const safeTitle = (ev.title || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const safeDesc = (ev.description || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    // Format date for display
                    let dateDisplay = '';
                    if (ev.date) {
                        const d = new Date(ev.date);
                        dateDisplay = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ';
                    }
                    html += `
                        <div class="timeline-event-node" data-idx="${idx}" draggable="true">
                            <div class="drag-handle" title="Drag to reorder"><i class="fas fa-grip-vertical"></i></div>
                            <div class="event-time-badge">${dateDisplay}${ev.time}</div>
                            <div class="event-dot"></div>
                            <div class="event-card">
                                <div class="event-title">${safeTitle}</div>
                                ${safeDesc ? `<div class="event-desc">${safeDesc}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                track.innerHTML = html;

                // Setup drag and drop handlers
                this.setupTimelineDragDrop(track, eventData);

                // Draw continuous connectors after nodes are rendered
                requestAnimationFrame(() => this.drawTimelineConnectors());
            }

            drawTimelineConnectors() {
                const track = document.getElementById('timelineVizTrack');
                if (!track) return;

                // Remove old connectors
                track.querySelectorAll('.timeline-connector').forEach(c => c.remove());

                const nodes = track.querySelectorAll('.timeline-event-node');
                if (nodes.length < 2) return;

                const trackRect = track.getBoundingClientRect();
                const rightEdgeX = trackRect.width - 15;
                const leftEdgeX = 15;

                for (let i = 0; i < nodes.length - 1; i++) {
                    const current = nodes[i];
                    const next = nodes[i + 1];
                    const currDot = current.querySelector('.event-dot');
                    const nextDot = next.querySelector('.event-dot');
                    if (!currDot || !nextDot) continue;

                    const currRect = currDot.getBoundingClientRect();
                    const nextRect = nextDot.getBoundingClientRect();

                    const currCenterX = currRect.left + currRect.width / 2 - trackRect.left;
                    const currCenterY = currRect.top + currRect.height / 2 - trackRect.top;
                    const nextCenterX = nextRect.left + nextRect.width / 2 - trackRect.left;
                    const nextCenterY = nextRect.top + nextRect.height / 2 - trackRect.top;

                    // Check if same row (Y difference small) or different row
                    const sameRow = Math.abs(currCenterY - nextCenterY) < 20;
                    const isLastConnection = (i === nodes.length - 2);

                    if (sameRow) {
                        // Horizontal connector with arrow pointing right
                        const line = document.createElement('div');
                        line.className = 'timeline-connector horizontal';
                        line.style.left = currCenterX + 'px';
                        line.style.top = (currCenterY - 1.5) + 'px';
                        line.style.width = (nextCenterX - currCenterX) + 'px';
                        // Add arrow only on last segment
                        if (isLastConnection) {
                            line.innerHTML = '<div class="arrow arrow-right"></div>';
                        }
                        track.appendChild(line);
                    } else {
                        // Different row: continuous 90-degree turns
                        // The line goes: right  down at right edge  left along bottom  down to next row Y  right to next node
                        
                        // Calculate midpoint Y between rows for the horizontal run
                        const midY = currCenterY + (nextCenterY - currCenterY) / 2;

                        // 1. Horizontal from current dot to right edge
                        const h1 = document.createElement('div');
                        h1.className = 'timeline-connector horizontal';
                        h1.style.left = currCenterX + 'px';
                        h1.style.top = (currCenterY - 1.5) + 'px';
                        h1.style.width = (rightEdgeX - currCenterX) + 'px';
                        track.appendChild(h1);

                        // 2. Vertical down from right edge to midpoint
                        const v1 = document.createElement('div');
                        v1.className = 'timeline-connector vertical';
                        v1.style.left = (rightEdgeX - 1.5) + 'px';
                        v1.style.top = currCenterY + 'px';
                        v1.style.height = (midY - currCenterY) + 'px';
                        track.appendChild(v1);

                        // 3. Horizontal from right edge to left edge at midpoint (connecting the two verticals)
                        const h2 = document.createElement('div');
                        h2.className = 'timeline-connector horizontal';
                        h2.style.left = leftEdgeX + 'px';
                        h2.style.top = (midY - 1.5) + 'px';
                        h2.style.width = (rightEdgeX - leftEdgeX) + 'px';
                        track.appendChild(h2);

                        // 4. Vertical down from left edge at midpoint to next row Y level
                        const v2 = document.createElement('div');
                        v2.className = 'timeline-connector vertical';
                        v2.style.left = (leftEdgeX - 1.5) + 'px';
                        v2.style.top = midY + 'px';
                        v2.style.height = (nextCenterY - midY) + 'px';
                        track.appendChild(v2);

                        // 5. Horizontal from left edge to next node
                        const h3 = document.createElement('div');
                        h3.className = 'timeline-connector horizontal';
                        h3.style.left = leftEdgeX + 'px';
                        h3.style.top = (nextCenterY - 1.5) + 'px';
                        h3.style.width = (nextCenterX - leftEdgeX) + 'px';
                        // Add arrow only on last segment
                        if (isLastConnection) {
                            h3.innerHTML = '<div class="arrow arrow-right"></div>';
                        }
                        track.appendChild(h3);
                    }
                }
            }

            setupTimelineDragDrop(track, eventData) {
                const nodes = track.querySelectorAll('.timeline-event-node');
                let draggedNode = null;
                let draggedIdx = null;

                nodes.forEach((node) => {
                    // Drag start
                    node.addEventListener('dragstart', (e) => {
                        draggedNode = node;
                        draggedIdx = parseInt(node.dataset.idx);
                        node.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', draggedIdx);
                    });

                    // Drag end
                    node.addEventListener('dragend', () => {
                        if (draggedNode) {
                            draggedNode.classList.remove('dragging');
                        }
                        nodes.forEach(n => n.classList.remove('drag-over'));
                        draggedNode = null;
                        draggedIdx = null;
                    });

                    // Drag over
                    node.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        if (node !== draggedNode) {
                            node.classList.add('drag-over');
                        }
                    });

                    // Drag leave
                    node.addEventListener('dragleave', () => {
                        node.classList.remove('drag-over');
                    });

                    // Drop
                    node.addEventListener('drop', (e) => {
                        e.preventDefault();
                        node.classList.remove('drag-over');
                        
                        const targetIdx = parseInt(node.dataset.idx);
                        if (draggedIdx !== null && targetIdx !== draggedIdx) {
                            // Reorder the timeline items in the DOM
                            this.reorderTimelineItems(draggedIdx, targetIdx);
                        }
                    });
                });
            }

            reorderTimelineItems(fromIdx, toIdx) {
                const container = document.getElementById('timelineContainer');
                const items = Array.from(container.querySelectorAll('.timeline-item'));
                
                if (fromIdx < 0 || fromIdx >= items.length || toIdx < 0 || toIdx >= items.length) {
                    return;
                }

                // Get the item to move
                const itemToMove = items[fromIdx];
                
                // Remove it from current position
                container.removeChild(itemToMove);
                
                // Re-query items after removal
                const remainingItems = Array.from(container.querySelectorAll('.timeline-item'));
                
                // Insert at new position
                if (toIdx >= remainingItems.length) {
                    container.appendChild(itemToMove);
                } else {
                    container.insertBefore(itemToMove, remainingItems[toIdx]);
                }

                // Update the visualization
                this.updateTimelineChart();
            }

            saveDraft() {
                this.saveToFirebase('Draft');
            }

            submitForReview() {
                this.saveToFirebase('Under Review');
            }

            saveInvestigation() {
                this.saveToFirebase('In Progress');
            }

            async saveToFirebase(status) {
                try {
                    const { companyId, userId } = await this.resolveCompanyContext();
                    if (!companyId) {
                        alert('Error: Could not determine company context. Please log in again.');
                        return;
                    }

                    const db = firebase.database();
                    
                    // Use existing ID if editing, or use the pre-generated reference number
                    let investigationId = this.editingId;
                    if (!investigationId) {
                        // Use the reference number from the form field (already generated on page load)
                        investigationId = document.getElementById('referenceNumber')?.value || this.generatedReferenceNumber;
                        if (!investigationId) {
                            // Fallback: generate new ID if somehow not available
                            investigationId = await this.generateInvestigationId(companyId);
                        }
                    }
                    
                    // Upload evidence (if any) and combine with existing evidence
                    let evidenceUploads = [];
                    try {
                        evidenceUploads = await this.uploadEvidenceFiles(companyId, investigationId);
                    } catch (e) {
                        console.error('Evidence upload failed:', e);
                        alert('Evidence upload failed. Please try again.');
                        return;
                    }

                    const combinedEvidence = [...(this.existingEvidence || []), ...evidenceUploads];
                    this.existingEvidence = combinedEvidence;

                    // Collect all form data
                    const investigationData = {
                        id: investigationId,
                        title: document.getElementById('incidentTitle')?.value || '',
                        // Introduction section fields
                        investigationPurpose: document.getElementById('investigationPurpose')?.value || '',
                        investigationScope: document.getElementById('investigationScope')?.value || '',
                        investigationMethod: document.getElementById('investigationMethod')?.value || '',
                        status: status,
                        priority: document.getElementById('severity')?.value || 'Medium',
                        incidentDate: document.getElementById('incidentDate')?.value || '',
                        reportedDate: document.getElementById('reportedDate')?.value || '',
                        incidentTime: document.getElementById('incidentTime')?.value || '',
                        location: document.getElementById('location')?.value || '',
                        department: document.getElementById('department')?.value || '',
                        incidentType: document.getElementById('incidentType')?.value || '',
                        classification: document.getElementById('classification')?.value || '',
                        severityActual: document.getElementById('severityActual')?.value || '',
                        severityPotential: document.getElementById('severityPotential')?.value || '',
                        likelihood: document.getElementById('likelihood')?.value || '',
                        description: document.getElementById('description')?.value || '',
                        immediateActions: document.getElementById('immediateActions')?.value || '',
                        
                        // Incident Location Map coordinates
                        incidentLocation: {
                            latitude: document.getElementById('incidentLatitude')?.value || '',
                            longitude: document.getElementById('incidentLongitude')?.value || ''
                        },
                        
                        // Investigation Team from Introduction section
                        introTeamMembers: this.collectIntroTeamMembers(),
                        
                        // Persons Involved
                        personsInvolved: this.collectPersonsInvolved(),
                        
                        // Equipment Involved
                        equipmentInvolved: this.collectEquipmentInvolved(),
                        
                        // Timeline events
                        timelineEvents: this.collectTimelineEvents(),
                        
                        // Sequence Analysis
                        fiveWhys: document.getElementById('fiveWhys')?.value || '',
                        eventTree: document.getElementById('eventTree')?.value || '',

                        // PEEPO Analysis
                        peepo: {
                            // Phase 1
                            peopleFactors: document.getElementById('peopleFactors')?.value || '',
                            peopleFactorsList: this.parseCommaList(document.getElementById('peopleFactors')?.value || ''),
                            equipmentFactors: document.getElementById('equipmentFactors')?.value || '',
                            equipmentFactorsList: this.parseCommaList(document.getElementById('equipmentFactors')?.value || ''),
                            environmentFactors: document.getElementById('environmentFactors')?.value || '',
                            environmentFactorsList: this.parseCommaList(document.getElementById('environmentFactors')?.value || ''),
                            procedures: document.getElementById('procedures')?.value || '',
                            proceduresList: this.parseCommaList(document.getElementById('procedures')?.value || ''),
                            organizationFactorsP1: document.getElementById('organizationFactorsP1')?.value || '',
                            organizationFactorsP1List: this.parseCommaList(document.getElementById('organizationFactorsP1')?.value || ''),
                            // Tag classifications (contributing/non-contributing)
                            tagClassifications: this.tagClassifications || {},
                            // Phase 2 removed
                        },

                        // Data Analysis
                        dataAnalysis: {
                            dataCollected: document.getElementById('dataCollected')?.value || '',
                            analysisMethod: document.getElementById('analysisMethod')?.value || '',
                            keyFindings: document.getElementById('keyFindings')?.value || '',
                            exposureHours: document.getElementById('exposureHours')?.value || '',
                            trifr: document.getElementById('trifr')?.value || '',
                            ltifr: document.getElementById('ltifr')?.value || '',
                            riskResidual: document.getElementById('riskResidual')?.value || '',
                            dataSources: document.getElementById('dataSources')?.value || '',
                            analysisSummary: document.getElementById('analysisSummary')?.value || '',
                            statements: collectStatements()
                        },

                        // Root Causes
                        rootCauseAnalysis: {
                            immediateCauses: document.getElementById('immediateCauses')?.value || '',
                            // Absent/Failed Defenses (ICAM)
                            failedDefenses: document.getElementById('failedDefenses')?.value || '',
                            failedDefensesData: document.getElementById('failedDefensesData')?.value || '[]',
                            // Individual or Team Actions
                            individualTeamActions: document.getElementById('individualTeamActions')?.value || '',
                            individualTeamActionsData: document.getElementById('individualTeamActionsData')?.value || '[]',
                            // Task / Environmental Conditions
                            taskEnvConditions: document.getElementById('taskEnvConditions')?.value || '',
                            taskEnvConditionsData: document.getElementById('taskEnvConditionsData')?.value || '[]',
                            // Organisational Factors
                            orgFactors: document.getElementById('orgFactors')?.value || '',
                            orgFactorsData: document.getElementById('orgFactorsData')?.value || '[]'
                        },

                        // Contributing Factors
                        contributingFactors: {
                            analysis: document.getElementById('contributingFactors')?.value || '',
                            humanFactors: document.getElementById('humanFactors')?.value || '',
                            msFactors: document.getElementById('msFactors')?.value || '',
                            technicalFactors: document.getElementById('technicalFactors')?.value || '',
                            additionalFactors: document.getElementById('additionalFactors')?.value || ''
                        },
                        
                        // Recommendations
                        recommendations: this.collectRecommendations(),
                        recommendationsMeta: {
                            owner: document.getElementById('recOwner')?.value || '',
                            targetDate: document.getElementById('recTargetDate')?.value || '',
                            priority: document.getElementById('recPriority')?.value || '',
                            verification: document.getElementById('recVerification')?.value || ''
                        },
                        
                        // Corrective Actions - collected from modal/table data
                        correctiveActions: this.collectCorrectiveActions(),
                        // Note: correctiveActionsMeta is legacy; each action now has its own fields
                        
                        // Control tab fields
                        verificationItems: typeof verificationItems !== 'undefined' ? verificationItems : [],
                        lessonsLearned: document.getElementById('lessonsLearned')?.value || '',
                        
                        // Approval
                        investigationStatus: status,
                        approver: document.getElementById('approver')?.value || '',
                        approverComments: document.getElementById('approverComments')?.value || '',
                        preparedBy: document.getElementById('preparedBy')?.value || '',
                        preparedDate: document.getElementById('preparedDate')?.value || '',
                        reviewedBy: document.getElementById('reviewedBy')?.value || '',
                        reviewDate: document.getElementById('reviewDate')?.value || '',
                        approvedBy: document.getElementById('approvedBy')?.value || '',
                        approvalDate: document.getElementById('approvalDate')?.value || '',
                        approvalComments2: document.getElementById('approvalComments2')?.value || '',
                        // Evidence
                        evidence: combinedEvidence,
                        
                        // Metadata
                        createdBy: userId,
                        createdDate: this.editingId ? (this.originalCreatedDate || new Date().toISOString()) : new Date().toISOString(),
                        updatedDate: new Date().toISOString(),
                        companyId: companyId
                    };

                    // Debug logging to verify data capture
                    console.log('=== Investigation Data Being Saved ===');
                    console.log('Timeline Events:', investigationData.timelineEvents);
                    console.log('PEEPO Data:', investigationData.peepo);
                    console.log('Corrective Actions:', investigationData.correctiveActions);
                    console.log('Full Investigation Data:', investigationData);

                    // Save to Firebase
                    await db.ref(`companies/${companyId}/investigations/${investigationId}`).set(investigationData);
                    
                    alert(`Investigation ${status === 'Draft' ? 'saved as draft' : status === 'Under Review' ? 'submitted for review' : 'saved'} successfully!`);
                    window.location.href = 'investigation-list.html';
                    
                } catch (error) {
                    console.error('Error saving investigation:', error);
                    alert('Error saving investigation: ' + error.message);
                }
            }

            collectIntroTeamMembers() {
                const members = [];
                document.querySelectorAll('.intro-team-member').forEach(el => {
                    const employeeSelect = el.querySelector('.intro-employee-select');
                    const roleSelect = el.querySelector('.intro-role-select');
                    if (employeeSelect?.value) {
                        members.push({
                            id: el.dataset.memberId,
                            employeeId: employeeSelect.value,
                            employeeName: employeeSelect.options[employeeSelect.selectedIndex]?.text || '',
                            role: roleSelect?.value || ''
                        });
                    }
                });
                return members;
            }

            collectPersonsInvolved() {
                const persons = [];
                document.querySelectorAll('.incident-person').forEach(el => {
                    const name = el.querySelector('.incident-person-name')?.value || '';
                    const company = el.querySelector('.incident-person-company')?.value || '';
                    const jobTitle = el.querySelector('.incident-person-jobtitle')?.value || '';
                    const phone = el.querySelector('.incident-person-phone')?.value || '';
                    if (name || company || jobTitle || phone) {
                        persons.push({ id: el.dataset.personId, name, company, jobTitle, phone });
                    }
                });
                return persons;
            }

            collectEquipmentInvolved() {
                const equipment = [];
                document.querySelectorAll('.equipment-involved').forEach(el => {
                    const name = el.querySelector('.equipment-name')?.value || '';
                    const serial = el.querySelector('.equipment-serial')?.value || '';
                    const type = el.querySelector('.equipment-type')?.value || '';
                    const condition = el.querySelector('.equipment-condition')?.value || '';
                    if (name || serial || type || condition) {
                        equipment.push({ id: el.dataset.equipmentId, name, serial, type, condition });
                    }
                });
                return equipment;
            }

            async generateInvestigationId(companyId) {
                try {
                    const db = firebase.database();
                    
                    // Get company initials
                    let companyInitials = 'CO';
                    const companySnapshot = await db.ref(`companies/${companyId}`).once('value');
                    if (companySnapshot.exists()) {
                        const companyData = companySnapshot.val();
                        const companyName = companyData.companyName || companyData.name || '';
                        companyInitials = this.getCompanyInitials(companyName);
                    }
                    
                    // Get current date in YYYYMMDD format
                    const now = new Date();
                    const dateStr = now.getFullYear().toString() +
                        String(now.getMonth() + 1).padStart(2, '0') +
                        String(now.getDate()).padStart(2, '0');
                    
                    // Get sequence number for today
                    const investigationsRef = db.ref(`companies/${companyId}/investigations`);
                    const snapshot = await investigationsRef.once('value');
                    
                    let sequenceNumber = 1;
                    if (snapshot.exists()) {
                        const investigations = snapshot.val();
                        // Count investigations created today with same prefix
                        const todayPrefix = `INVST-${companyInitials} - ${dateStr}-`;
                        const todayInvestigations = Object.keys(investigations).filter(id => id.startsWith(todayPrefix));
                        sequenceNumber = todayInvestigations.length + 1;
                    }
                    
                    // Format: INVST-{CompanyInitials} - {YYYYMMDD}-{###}
                    const investigationId = `INVST-${companyInitials} - ${dateStr}-${String(sequenceNumber).padStart(3, '0')}`;
                    
                    return investigationId;
                } catch (error) {
                    console.error('Error generating investigation ID:', error);
                    // Fallback to timestamp-based ID
                    return `INVST-${Date.now()}`;
                }
            }

            getCompanyInitials(name) {
                if (!name) return 'CO';
                const parts = name.trim().split(/\s+/);
                if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }

            async populateDepartments() {
                try {
                    const select = document.getElementById('department');
                    if (!select) return;
                    
                    const user = window.authManager?.currentUser;
                    const companyId = user?.companyId;
                    if (!companyId) return;

                    const db = firebase.database();
                    // Use the exact path from settings - companies/{companyId}/settings/fieldOptions/department
                    const departmentRef = db.ref(`companies/${companyId}/settings/fieldOptions/department`);
                    
                    const snapshot = await departmentRef.once('value');
                    if (!snapshot.exists()) {
                        console.warn('No departments found at fieldOptions/department path');
                        return;
                    }

                    const departments = snapshot.val();
                    const options = [];

                    // Handle different data structures - prioritize label field
                    if (Array.isArray(departments)) {
                        departments.forEach(dept => {
                            if (dept && dept.label) {
                                options.push(dept.label);
                            } else if (dept && typeof dept === 'string') {
                                options.push(dept);
                            } else if (dept && dept.value) {
                                options.push(dept.value);
                            } else if (dept && dept.name) {
                                options.push(dept.name);
                            }
                        });
                    } else if (typeof departments === 'object') {
                        Object.values(departments).forEach(dept => {
                            if (dept && dept.label) {
                                options.push(dept.label);
                            } else if (dept && typeof dept === 'string') {
                                options.push(dept);
                            } else if (dept && dept.value) {
                                options.push(dept.value);
                            } else if (dept && dept.name) {
                                options.push(dept.name);
                            }
                        });
                    }

                    // Sort alphabetically
                    options.sort((a, b) => a.localeCompare(b));

                    // Clear and populate select
                    select.innerHTML = '<option value="">Select Department</option>';
                    options.forEach(deptName => {
                        const option = document.createElement('option');
                        option.value = deptName;
                        option.textContent = deptName;
                        select.appendChild(option);
                    });

                    console.log(`Loaded ${options.length} departments from fieldOptions`);

                } catch (err) {
                    console.error('Failed to load departments:', err);
                }
            }

            async populateLocations() {
                try {
                    const select = document.getElementById('location');
                    if (!select) return;
                    
                    const user = window.authManager?.currentUser;
                    const companyId = user?.companyId;
                    if (!companyId) return;

                    const db = firebase.database();
                    // Use the exact path for work areas - companies/{companyId}/settings/fieldOptions/area
                    const areaRef = db.ref(`companies/${companyId}/settings/fieldOptions/area`);
                    
                    const snapshot = await areaRef.once('value');
                    if (!snapshot.exists()) {
                        console.warn('No work areas found at fieldOptions/area path');
                        return;
                    }

                    const areas = snapshot.val();
                    const options = [];

                    // Handle different data structures - prioritize label field
                    if (Array.isArray(areas)) {
                        areas.forEach(area => {
                            if (area && area.label) {
                                options.push(area.label);
                            } else if (area && typeof area === 'string') {
                                options.push(area);
                            } else if (area && area.value) {
                                options.push(area.value);
                            } else if (area && area.name) {
                                options.push(area.name);
                            }
                        });
                    } else if (typeof areas === 'object') {
                        Object.values(areas).forEach(area => {
                            if (area && area.label) {
                                options.push(area.label);
                            } else if (area && typeof area === 'string') {
                                options.push(area);
                            } else if (area && area.value) {
                                options.push(area.value);
                            } else if (area && area.name) {
                                options.push(area.name);
                            }
                        });
                    }

                    // Sort alphabetically
                    options.sort((a, b) => a.localeCompare(b));

                    // Clear and populate select
                    select.innerHTML = '<option value="">Select Location</option>';
                    options.forEach(areaName => {
                        const option = document.createElement('option');
                        option.value = areaName;
                        option.textContent = areaName;
                        select.appendChild(option);
                    });

                    console.log(`Loaded ${options.length} work areas from fieldOptions`);

                } catch (err) {
                    console.error('Failed to load work areas:', err);
                }
            }
        }

        // Global functions for onclick handlers
        function addTimelineEvent() {
            investigationCreate.addTimelineEvent();
        }

        function removeTimelineEvent(eventId) {
            investigationCreate.removeTimelineEvent(eventId);
        }

        function updateTimelineChart() {
            investigationCreate.updateTimelineChart();
        }

        function addRecommendation() {
            investigationCreate.addRecommendation();
        }

        function removeRecommendation(recommendationId) {
            investigationCreate.removeRecommendation(recommendationId);
        }

        function addCorrectiveAction() {
            investigationCreate.addCorrectiveAction();
        }

        function removeCorrectiveAction(actionId) {
            investigationCreate.removeCorrectiveAction(actionId);
        }

        // Verification Items for Control tab
        let verificationItems = [];
        let verificationIdCounter = 1;

        function addVerificationItem() {
            const id = verificationIdCounter++;
            const item = {
                id: id,
                actionDescription: '',
                verifiedBy: '',
                verificationDate: '',
                status: 'Pending',
                effectiveness: ''
            };
            verificationItems.push(item);
            renderVerificationItems();
            // Open edit modal for new item
            editVerificationItem(id);
        }

        function renderVerificationItems() {
            const table = document.getElementById('verificationItemsTable');
            const tbody = document.getElementById('verificationItemsTableBody');
            const empty = document.getElementById('verificationItemsEmpty');

            if (verificationItems.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = verificationItems.map(item => `
                <tr>
                    <td>${item.actionDescription || '<em style="color:#94a3b8;">Not specified</em>'}</td>
                    <td>${item.verifiedBy || '-'}</td>
                    <td>${item.verificationDate || '-'}</td>
                    <td><span class="status-badge status-${item.status.toLowerCase().replace(/\s+/g, '-')}">${item.status}</span></td>
                    <td>${item.effectiveness || '-'}</td>
                    <td class="actions-cell">
                        <button class="btn btn-sm" style="background:#dcfce7;color:#059669;padding:0.25rem 0.5rem;" onclick="editVerificationItem(${item.id})" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm" style="background:#fee2e2;color:#dc2626;padding:0.25rem 0.5rem;" onclick="removeVerificationItem(${item.id})" title="Delete"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function editVerificationItem(id) {
            const item = verificationItems.find(v => v.id === id);
            if (!item) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay show';
            modal.id = 'verificationModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 550px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-clipboard-check" style="margin-right:0.5rem;"></i>Verification Record</h3>
                        <button class="modal-close" onclick="closeVerificationModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="margin-bottom:1rem;">
                            <label>Action/Improvement Description *</label>
                            <textarea id="verifyActionDesc" rows="3" style="width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:6px;">${item.actionDescription}</textarea>
                        </div>
                        <div class="form-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                            <div class="form-group">
                                <label>Verified By</label>
                                <input type="text" id="verifyBy" value="${item.verifiedBy}" style="width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:6px;">
                            </div>
                            <div class="form-group">
                                <label>Verification Date</label>
                                <input type="date" id="verifyDate" value="${item.verificationDate}" style="width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:6px;">
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="verifyStatus" style="width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:6px;">
                                    <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="In Progress" ${item.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="Verified" ${item.status === 'Verified' ? 'selected' : ''}>Verified</option>
                                    <option value="Not Effective" ${item.status === 'Not Effective' ? 'selected' : ''}>Not Effective</option>
                                    <option value="Requires Rework" ${item.status === 'Requires Rework' ? 'selected' : ''}>Requires Rework</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Effectiveness</label>
                                <select id="verifyEffectiveness" style="width:100%;padding:0.75rem;border:1px solid #d1d5db;border-radius:6px;">
                                    <option value="" ${!item.effectiveness ? 'selected' : ''}>Select...</option>
                                    <option value="Highly Effective" ${item.effectiveness === 'Highly Effective' ? 'selected' : ''}>Highly Effective</option>
                                    <option value="Effective" ${item.effectiveness === 'Effective' ? 'selected' : ''}>Effective</option>
                                    <option value="Partially Effective" ${item.effectiveness === 'Partially Effective' ? 'selected' : ''}>Partially Effective</option>
                                    <option value="Not Effective" ${item.effectiveness === 'Not Effective' ? 'selected' : ''}>Not Effective</option>
                                    <option value="Not Yet Assessed" ${item.effectiveness === 'Not Yet Assessed' ? 'selected' : ''}>Not Yet Assessed</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeVerificationModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveVerificationItem(${id})"><i class="fas fa-save"></i> Save</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveVerificationItem(id) {
            const item = verificationItems.find(v => v.id === id);
            if (!item) return;

            item.actionDescription = document.getElementById('verifyActionDesc').value;
            item.verifiedBy = document.getElementById('verifyBy').value;
            item.verificationDate = document.getElementById('verifyDate').value;
            item.status = document.getElementById('verifyStatus').value;
            item.effectiveness = document.getElementById('verifyEffectiveness').value;

            closeVerificationModal();
            renderVerificationItems();
        }

        function removeVerificationItem(id) {
            if (!confirm('Are you sure you want to remove this verification record?')) return;
            verificationItems = verificationItems.filter(v => v.id !== id);
            renderVerificationItems();
        }

        function closeVerificationModal() {
            const modal = document.getElementById('verificationModal');
            if (modal) modal.remove();
        }

        // Toggle Section Collapse/Expand
        function toggleSectionCollapse(titleElement) {
            const sectionContent = titleElement.nextElementSibling;
            const collapseIcon = titleElement.querySelector('.collapse-icon');
            
            if (sectionContent && sectionContent.classList.contains('section-content')) {
                sectionContent.classList.toggle('collapsed');
                if (collapseIcon) {
                    collapseIcon.classList.toggle('collapsed');
                }
            }
        }

        function collapseAllSections() {
            document.querySelectorAll('.section-title.collapsible').forEach(titleElement => {
                const sectionContent = titleElement.nextElementSibling;
                const collapseIcon = titleElement.querySelector('.collapse-icon');
                
                if (sectionContent && sectionContent.classList.contains('section-content')) {
                    sectionContent.classList.add('collapsed');
                    if (collapseIcon) {
                        collapseIcon.classList.add('collapsed');
                    }
                }
            });
        }

        function expandTabSections(tabId) {
            const tab = document.getElementById(tabId);
            if (!tab) return;
            tab.querySelectorAll('.section-title.collapsible').forEach(titleElement => {
                const sectionContent = titleElement.nextElementSibling;
                const collapseIcon = titleElement.querySelector('.collapse-icon');
                
                if (sectionContent && sectionContent.classList.contains('section-content')) {
                    sectionContent.classList.remove('collapsed');
                    if (collapseIcon) {
                        collapseIcon.classList.remove('collapsed');
                    }
                }
            });
        }

        function collapseTabSections(tabId) {
            const tab = document.getElementById(tabId);
            if (!tab) return;
            tab.querySelectorAll('.section-title.collapsible').forEach(titleElement => {
                const sectionContent = titleElement.nextElementSibling;
                const collapseIcon = titleElement.querySelector('.collapse-icon');
                
                if (sectionContent && sectionContent.classList.contains('section-content')) {
                    sectionContent.classList.add('collapsed');
                    if (collapseIcon) {
                        collapseIcon.classList.add('collapsed');
                    }
                }
            });
        }

        function addTeamMember() {
            investigationCreate.addTeamMember();
        }
        function addIntroTeamMember() {
            investigationCreate.addIntroTeamMember();
        }

        function removeIntroTeamMember(memberId) {
            investigationCreate.removeIntroTeamMember(memberId);
        }

        // PEEPO tag add wrappers
        function addPeepoTag(key) {
            const map = {
                peopleFactors: { field: 'peopleFactors', container: 'peopleFactorsTags', input: 'peopleFactorsNew' },
                equipmentFactors: { field: 'equipmentFactors', container: 'equipmentFactorsTags', input: 'equipmentFactorsNew' },
                environmentFactors: { field: 'environmentFactors', container: 'environmentFactorsTags', input: 'environmentFactorsNew' },
                procedures: { field: 'procedures', container: 'proceduresTags', input: 'proceduresNew' },
                organizationFactorsP1: { field: 'organizationFactorsP1', container: 'organizationFactorsP1Tags', input: 'organizationFactorsP1New' }
            };
            const cfg = map[key];
            if (!cfg) return;
            investigationCreate.addTagFromInput(cfg.field, cfg.container, cfg.input);
        }

        function addFailedDefense() {
            const select = document.getElementById('failedDefensesSelect');
            const container = document.getElementById('failedDefensesEntries');
            
            if (!select || !select.value) return;
            
            const value = select.value;
            const defenseId = 'defense_' + Date.now();
            
            // Check for duplicates
            const existingDefenses = container.querySelectorAll('.defense-entry-row');
            for (const row of existingDefenses) {
                if (row.dataset.defenseCode === value) {
                    alert('This defense has already been added.');
                    select.value = '';
                    return;
                }
            }
            
            // Create defense entry row (matching Barrier Failures style)
            const row = document.createElement('div');
            row.className = 'defense-entry-row';
            row.id = defenseId;
            row.dataset.defenseCode = value;
            row.innerHTML = `
                <label class="defense-label">${value}</label>
                <input type="text" class="defense-comment" placeholder="Describe how this defense failed or was absent..." onchange="updateFailedDefensesData()">
                <button type="button" class="defense-remove" onclick="removeFailedDefense('${defenseId}')" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(row);
            updateFailedDefensesData();
            
            // Reset dropdown
            select.value = '';
        }
        
        function removeFailedDefense(defenseId) {
            const row = document.getElementById(defenseId);
            if (row) {
                row.remove();
                updateFailedDefensesData();
            }
        }
        
        function updateFailedDefensesData() {
            const container = document.getElementById('failedDefensesEntries');
            const dataInput = document.getElementById('failedDefensesData');
            const legacyInput = document.getElementById('failedDefenses');
            
            const entries = [];
            const codes = [];
            
            container.querySelectorAll('.defense-entry-row').forEach(row => {
                const code = row.dataset.defenseCode;
                const comment = row.querySelector('.defense-comment')?.value || '';
                entries.push({ code, comment });
                codes.push(code);
            });
            
            dataInput.value = JSON.stringify(entries);
            legacyInput.value = codes.join(', ');
        }
        
        function loadFailedDefenses(data) {
            const container = document.getElementById('failedDefensesEntries');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!data || !Array.isArray(data)) return;
            
            data.forEach((item, index) => {
                const defenseId = 'defense_' + Date.now() + '_' + index;
                const value = item.code || item;
                const comment = item.comment || '';
                
                const row = document.createElement('div');
                row.className = 'defense-entry-row';
                row.id = defenseId;
                row.dataset.defenseCode = value;
                row.innerHTML = `
                    <label class="defense-label">${value}</label>
                    <input type="text" class="defense-comment" placeholder="Describe how this defense failed or was absent..." onchange="updateFailedDefensesData()" value="${comment}">
                    <button type="button" class="defense-remove" onclick="removeFailedDefense('${defenseId}')" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(row);
            });
            
            updateFailedDefensesData();
        }

        // ========== Individual or Team Actions ==========
        function addIndividualTeamAction() {
            const select = document.getElementById('individualTeamActionsSelect');
            const container = document.getElementById('individualTeamActionsEntries');
            
            if (!select || !select.value) return;
            
            const value = select.value;
            const actionId = 'action_' + Date.now();
            
            // Check for duplicates
            const existingActions = container.querySelectorAll('.defense-entry-row');
            for (const row of existingActions) {
                if (row.dataset.actionCode === value) {
                    alert('This action has already been added.');
                    select.value = '';
                    return;
                }
            }
            
            const row = document.createElement('div');
            row.className = 'defense-entry-row';
            row.id = actionId;
            row.dataset.actionCode = value;
            row.innerHTML = `
                <label class="defense-label">${value}</label>
                <input type="text" class="defense-comment" placeholder="Describe the action and its contribution to the incident..." onchange="updateIndividualTeamActionsData()">
                <button type="button" class="defense-remove" onclick="removeIndividualTeamAction('${actionId}')" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(row);
            updateIndividualTeamActionsData();
            select.value = '';
        }
        
        function removeIndividualTeamAction(actionId) {
            const row = document.getElementById(actionId);
            if (row) {
                row.remove();
                updateIndividualTeamActionsData();
            }
        }
        
        function updateIndividualTeamActionsData() {
            const container = document.getElementById('individualTeamActionsEntries');
            const dataInput = document.getElementById('individualTeamActionsData');
            const legacyInput = document.getElementById('individualTeamActions');
            
            const entries = [];
            const codes = [];
            
            container.querySelectorAll('.defense-entry-row').forEach(row => {
                const code = row.dataset.actionCode;
                const comment = row.querySelector('.defense-comment')?.value || '';
                entries.push({ code, comment });
                codes.push(code);
            });
            
            dataInput.value = JSON.stringify(entries);
            legacyInput.value = codes.join(', ');
        }
        
        function loadIndividualTeamActions(data) {
            const container = document.getElementById('individualTeamActionsEntries');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!data || !Array.isArray(data)) return;
            
            data.forEach((item, index) => {
                const actionId = 'action_' + Date.now() + '_' + index;
                const value = item.code || item;
                const comment = item.comment || '';
                
                const row = document.createElement('div');
                row.className = 'defense-entry-row';
                row.id = actionId;
                row.dataset.actionCode = value;
                row.innerHTML = `
                    <label class="defense-label">${value}</label>
                    <input type="text" class="defense-comment" placeholder="Describe the action and its contribution to the incident..." onchange="updateIndividualTeamActionsData()" value="${comment}">
                    <button type="button" class="defense-remove" onclick="removeIndividualTeamAction('${actionId}')" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(row);
            });
            
            updateIndividualTeamActionsData();
        }

        // ========== Task / Environmental Conditions ==========
        function addTaskEnvCondition() {
            const select = document.getElementById('taskEnvConditionsSelect');
            const container = document.getElementById('taskEnvConditionsEntries');
            
            if (!select || !select.value) return;
            
            const value = select.value;
            const conditionId = 'condition_' + Date.now();
            
            // Check for duplicates
            const existingConditions = container.querySelectorAll('.defense-entry-row');
            for (const row of existingConditions) {
                if (row.dataset.conditionCode === value) {
                    alert('This condition has already been added.');
                    select.value = '';
                    return;
                }
            }
            
            const row = document.createElement('div');
            row.className = 'defense-entry-row';
            row.id = conditionId;
            row.dataset.conditionCode = value;
            row.innerHTML = `
                <label class="defense-label">${value}</label>
                <input type="text" class="defense-comment" placeholder="Describe the condition and its impact..." onchange="updateTaskEnvConditionsData()">
                <button type="button" class="defense-remove" onclick="removeTaskEnvCondition('${conditionId}')" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(row);
            updateTaskEnvConditionsData();
            select.value = '';
        }
        
        function removeTaskEnvCondition(conditionId) {
            const row = document.getElementById(conditionId);
            if (row) {
                row.remove();
                updateTaskEnvConditionsData();
            }
        }
        
        function updateTaskEnvConditionsData() {
            const container = document.getElementById('taskEnvConditionsEntries');
            const dataInput = document.getElementById('taskEnvConditionsData');
            const legacyInput = document.getElementById('taskEnvConditions');
            
            const entries = [];
            const codes = [];
            
            container.querySelectorAll('.defense-entry-row').forEach(row => {
                const code = row.dataset.conditionCode;
                const comment = row.querySelector('.defense-comment')?.value || '';
                entries.push({ code, comment });
                codes.push(code);
            });
            
            dataInput.value = JSON.stringify(entries);
            legacyInput.value = codes.join(', ');
        }
        
        function loadTaskEnvConditions(data) {
            const container = document.getElementById('taskEnvConditionsEntries');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!data || !Array.isArray(data)) return;
            
            data.forEach((item, index) => {
                const conditionId = 'condition_' + Date.now() + '_' + index;
                const value = item.code || item;
                const comment = item.comment || '';
                
                const row = document.createElement('div');
                row.className = 'defense-entry-row';
                row.id = conditionId;
                row.dataset.conditionCode = value;
                row.innerHTML = `
                    <label class="defense-label">${value}</label>
                    <input type="text" class="defense-comment" placeholder="Describe the condition and its impact..." onchange="updateTaskEnvConditionsData()" value="${comment}">
                    <button type="button" class="defense-remove" onclick="removeTaskEnvCondition('${conditionId}')" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(row);
            });
            
            updateTaskEnvConditionsData();
        }

        // ========== Organisational Factors ==========
        function addOrgFactor() {
            const select = document.getElementById('orgFactorsSelect');
            const container = document.getElementById('orgFactorsEntries');
            
            if (!select || !select.value) return;
            
            const value = select.value;
            const factorId = 'orgfactor_' + Date.now();
            
            // Check for duplicates
            const existingFactors = container.querySelectorAll('.defense-entry-row');
            for (const row of existingFactors) {
                if (row.dataset.factorCode === value) {
                    alert('This factor has already been added.');
                    select.value = '';
                    return;
                }
            }
            
            const row = document.createElement('div');
            row.className = 'defense-entry-row';
            row.id = factorId;
            row.dataset.factorCode = value;
            row.innerHTML = `
                <label class="defense-label">${value}</label>
                <input type="text" class="defense-comment" placeholder="Describe the organisational factor and its contribution..." onchange="updateOrgFactorsData()">
                <button type="button" class="defense-remove" onclick="removeOrgFactor('${factorId}')" title="Remove">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(row);
            updateOrgFactorsData();
            select.value = '';
        }
        
        function removeOrgFactor(factorId) {
            const row = document.getElementById(factorId);
            if (row) {
                row.remove();
                updateOrgFactorsData();
            }
        }
        
        function updateOrgFactorsData() {
            const container = document.getElementById('orgFactorsEntries');
            const dataInput = document.getElementById('orgFactorsData');
            const legacyInput = document.getElementById('orgFactors');
            
            const entries = [];
            const codes = [];
            
            container.querySelectorAll('.defense-entry-row').forEach(row => {
                const code = row.dataset.factorCode;
                const comment = row.querySelector('.defense-comment')?.value || '';
                entries.push({ code, comment });
                codes.push(code);
            });
            
            dataInput.value = JSON.stringify(entries);
            legacyInput.value = codes.join(', ');
        }
        
        function loadOrgFactors(data) {
            const container = document.getElementById('orgFactorsEntries');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!data || !Array.isArray(data)) return;
            
            data.forEach((item, index) => {
                const factorId = 'orgfactor_' + Date.now() + '_' + index;
                const value = item.code || item;
                const comment = item.comment || '';
                
                const row = document.createElement('div');
                row.className = 'defense-entry-row';
                row.id = factorId;
                row.dataset.factorCode = value;
                row.innerHTML = `
                    <label class="defense-label">${value}</label>
                    <input type="text" class="defense-comment" placeholder="Describe the organisational factor and its contribution..." onchange="updateOrgFactorsData()" value="${comment}">
                    <button type="button" class="defense-remove" onclick="removeOrgFactor('${factorId}')" title="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(row);
            });
            
            updateOrgFactorsData();
        }

        // Update team member info when employee is selected
        function updateTeamMemberInfo(memberId) {
            const select = document.querySelector(`[data-member="${memberId}"]`);
            const container = document.querySelector(`[data-member-id="${memberId}"]`);
            if (!select || !container) return;
            
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) { return; }
            
            const jobtitleInlineEl = container.querySelector('.employee-jobtitle-inline');
            const jt = selectedOption.getAttribute('data-jobtitle') || '-';
            
            if (jobtitleInlineEl) jobtitleInlineEl.textContent = jt;
        }

        function removeTeamMember(memberId) {
            investigationCreate.removeTeamMember(memberId);
        }

        function saveDraft() {
            investigationCreate.saveDraft();
        }

        function submitForReview() {
            investigationCreate.submitForReview();
        }

        function saveInvestigation() {
            investigationCreate.saveInvestigation();
        }

        // Person involved functions
        async function addIncidentPerson() {
            if (!window.incidentPersons) window.incidentPersons = [];
            const personId = Date.now();
            const container = document.getElementById('incidentPersonsContainer');
            if (!container) return;

            const personHtml = `
                <div class="incident-person" data-person-id="${personId}" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Name:</label>
                            <input type="text" class="incident-person-name" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Full Name">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Company:</label>
                            <input type="text" class="incident-person-company" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Company Name">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Job Title:</label>
                            <input type="text" class="incident-person-jobtitle" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Job Title">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Phone Number:</label>
                            <input type="text" class="incident-person-phone" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Phone Number">
                        </div>
                        <button class="btn btn-danger" onclick="removeIncidentPerson('${personId}')" style="font-size: 0.8rem; padding: 0.5rem 0.75rem; height: fit-content;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', personHtml);
            window.incidentPersons.push(personId);
        }

        function removeIncidentPerson(personId) {
            const el = document.querySelector(`[data-person-id="${personId}"]`);
            if (el) el.remove();
            if (window.incidentPersons) window.incidentPersons = window.incidentPersons.filter(id => id !== personId);
        }

        // Equipment involved functions
        async function addEquipmentInvolved() {
            if (!window.equipmentInvolved) window.equipmentInvolved = [];
            const equipmentId = Date.now();
            const container = document.getElementById('equipmentInvolvedContainer');
            if (!container) return;

            const equipmentHtml = `
                <div class="equipment-involved" data-equipment-id="${equipmentId}" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Equipment Name:</label>
                            <input type="text" class="equipment-name" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Equipment Name">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Equipment ID/Serial:</label>
                            <input type="text" class="equipment-serial" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="ID or Serial Number">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Type/Category:</label>
                            <input type="text" class="equipment-type" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;" placeholder="Type or Category">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.85rem;">Condition:</label>
                            <select class="equipment-condition" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.85rem;">
                                <option value="">Select Condition</option>
                                <option value="Good">Good</option>
                                <option value="Damaged">Damaged</option>
                                <option value="Defective">Defective</option>
                                <option value="Unknown">Unknown</option>
                            </select>
                        </div>
                        <button class="btn btn-danger" onclick="removeEquipmentInvolved('${equipmentId}')" style="font-size: 0.8rem; padding: 0.5rem 0.75rem; height: fit-content;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', equipmentHtml);
            window.equipmentInvolved.push(equipmentId);
        }

        function removeEquipmentInvolved(equipmentId) {
            const el = document.querySelector(`[data-equipment-id="${equipmentId}"]`);
            if (el) el.remove();
            if (window.equipmentInvolved) window.equipmentInvolved = window.equipmentInvolved.filter(id => id !== equipmentId);
        }

        // Initialize when DOM is loaded
        let investigationCreate;
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize shared header/auth/notifications like project-list.html
            // Firebase configuration and initialization
            const firebaseConfig = {
                apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
                authDomain: "users-8be65.firebaseapp.com",
                databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
                projectId: "users-8be65",
                storageBucket: "users-8be65.firebasestorage.app",
                messagingSenderId: "909025468149",
                appId: "1:909025468149:web:fb4e7c4a8b4bd6d1076e4d",
                measurementId: "G-XHFMRCJQEZ"
            };
            function initializeFirebase() {
                if (!window.firebase || !window.firebase.apps || window.firebase.apps.length === 0) {
                    window.firebase.initializeApp(firebaseConfig);
                    console.log(' Firebase v8 initialized successfully for centralized auth');
                }
                return window.firebase;
            }
            const firebase = initializeFirebase();

            class AuthManager {
                constructor() { this.currentUser = this.getCurrentUser(); this.currentCompany = null; this.init(); }
                getCurrentUser() { try { return JSON.parse(localStorage.getItem('currentUser') || 'null'); } catch { return null; } }
                setCurrentUser(u) { localStorage.setItem('currentUser', JSON.stringify(u)); localStorage.setItem('user', JSON.stringify(u)); this.currentUser = u; }
                async init() { if (!this.currentUser) { window.location.href = 'login.html'; return; } await this.loadUserCompany(); this.updateCompanyBranding(); await this.updateUIForAuthenticatedUser(); this.bindProfileDropdown(); }
                async loadUserCompany() { if (!this.currentUser) return; try { const snap = await firebase.database().ref('companies').once('value'); if (!snap.exists()) return; const companies = snap.val(); for (const [cid, comp] of Object.entries(companies)) { if (comp.status !== 'active') continue; if (comp.users) { for (const [uid, u] of Object.entries(comp.users)) { if (u.authUid === this.currentUser.uid || uid === this.currentUser.uid) { this.currentUser.companyId = cid; this.currentUser.companyName = comp.companyName; this.currentUser.role = u.role || u.userRole || 'user'; this.currentCompany = comp; this.setCurrentUser(this.currentUser); return; } } } } } catch (e) { } }
                updateCompanyBranding() { const logoEl = document.getElementById('headerCompanyLogo'); const nameEl = document.getElementById('headerCompanyName'); if (!this.currentCompany) { this.showFallbackBranding(); return; } if (nameEl) nameEl.textContent = this.currentCompany.companyName || ''; const logoUrl = this.currentCompany.logo || this.currentCompany.logoUrl; if (logoEl) { if (logoUrl) { logoEl.src = logoUrl; logoEl.classList.add('visible'); } else { const svg = this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName || '')); logoEl.src = svg; logoEl.classList.add('visible'); } } if (this.currentCompany.branding) { const root = document.documentElement; if (this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if (this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); } }
                showFallbackBranding() { const logoEl = document.getElementById('headerCompanyLogo'); if (logoEl) { const svg = this.generateCompanyInitialsSVG('DX'); logoEl.src = svg; logoEl.classList.add('visible'); } }
                getCompanyInitials(name) { if (!name) return 'CO'; const parts = name.trim().split(/\s+/); if (parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
                generateCompanyInitialsSVG(initials) { const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
                getUserDisplayName() { if (!this.currentUser) return 'User'; const n=v=>typeof v==='string'? v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){const cleaned=n(c); if(cleaned) return cleaned;} if (this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
                getUserInitials() { const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
                async getUserAvatarUrl() { if (!this.currentUser) return null; const companyId=this.currentUser.companyId||'default'; const possiblePaths=[`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,`avatars/${this.currentUser.uid}/profile.jpg`,`avatars/${this.currentUser.uid}/profile.png`,`avatars/${this.currentUser.uid}/avatar.jpg`,`avatars/${this.currentUser.uid}/avatar.png`,`profiles/${this.currentUser.uid}/profile.jpg`,`profiles/${this.currentUser.uid}/profile.png`]; for (const path of possiblePaths) { try { const ref=firebase.storage().ref(path); const url=await ref.getDownloadURL(); return url; } catch(err){ continue; } } return null; }
                async updateUIForAuthenticatedUser() { const btn=document.getElementById('userProfileBtn'); const list=document.querySelector('.profile-dropdown ul'); if(!btn||!list||!this.currentUser) return; const displayName=this.getUserDisplayName(); const email=this.currentUser.email||''; let avatarUrl=null; try{ avatarUrl=await this.getUserAvatarUrl(); } catch(e){} const btnImg=btn.querySelector('img'); if (avatarUrl && btnImg) { btnImg.src=avatarUrl; btnImg.alt=displayName+' Avatar'; btnImg.style.display='block'; btnImg.onerror=()=>{ btnImg.style.display='none'; btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`; }; } else { btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`; } const avatarHtml = avatarUrl ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style=\"width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;\">${this.getUserInitials()}</div>`; list.innerHTML = `<li style=\"border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;\"><div style=\"display:flex;align-items:center;gap:12px;\">${avatarHtml}<div><div style=\"font-weight:600;color:#333;font-size:14px;margin-bottom:2px;\">${displayName}</div><div style=\"color:#666;font-size:12px;\">${email}</div></div></div></li><li><a href=\"profile.html\"><i class=\"fas fa-user\"></i> Profile</a></li><li><a href=\"account.html\"><i class=\"fas fa-cog\"></i> Account Settings</a></li><li><a href=\"#\" id=\"logoutLink\"><i class=\"fas fa-sign-out-alt\"></i> Sign out</a></li>`; list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); }); }
                bindProfileDropdown() { const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn&&dd){ btn.addEventListener('click',e=>{ e.stopPropagation(); dd.classList.toggle('show'); }); document.addEventListener('click',e=>{ if(!btn.contains(e.target)) dd.classList.remove('show'); }); } }
                async logout(){ try{ await firebase.auth().signOut(); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; } catch(error){ console.error('Logout error:', error); localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; } }
            }

            function initializePage() { const sidebarToggle=document.getElementById('sidebarToggle'); const sidebar=document.getElementById('sidebar'); const mainContent=document.getElementById('mainContent'); if (sidebarToggle) sidebarToggle.addEventListener('click', ()=>{ sidebar.classList.toggle('collapsed'); mainContent.classList.toggle('sidebar-collapsed'); }); }
            function getAuthUser(){ if (window.authManager && window.authManager.currentUser) return window.authManager.currentUser; try{ return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch{ return null; } }
            async function loadNotificationsOnce(){ const user=getAuthUser(); if(!user) return []; const db=firebase.database(); const snap=await db.ref(`notifications/${user.uid}`).once('value'); if(!snap.exists()) return []; const list=Object.entries(snap.val()).map(([id,v])=>({id,...v})); list.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0)); return list; }
            async function markAllNotificationsAsRead(){ const user=getAuthUser(); if(!user) return; const db=firebase.database(); const ref=db.ref(`notifications/${user.uid}`); const snap=await ref.once('value'); if(!snap.exists()) return; const updates={}; Object.keys(snap.val()).forEach(k=> updates[`${k}/read`]=true); await ref.update(updates); updateNotificationBadgeCount([]); }
            async function markNotificationAsRead(id){ const user=getAuthUser(); if(!user||!id) return; await firebase.database().ref(`notifications/${user.uid}/${id}/read`).set(true); }
            async function deleteNotificationWithConfirm(id){ if(!confirm('Delete this notification?')) return; const user=getAuthUser(); if(!user||!id) return; await firebase.database().ref(`notifications/${user.uid}/${id}`).remove(); const notifications=await loadNotificationsOnce(); populateNotificationDropdown(notifications); }
            async function clearAllNotifications(){ if(!confirm('Delete all notifications? This cannot be undone.')) return; const user=getAuthUser(); if(!user) return; await firebase.database().ref(`notifications/${user.uid}`).remove(); }
            function formatTimeAgo(ts){ if(!ts) return 'Just now'; const diff=Date.now()-ts; const m=Math.floor(diff/60000); const h=Math.floor(diff/3600000); const d=Math.floor(diff/86400000); if(m<1) return 'Just now'; if(m<60) return `${m}m ago`; if(h<24) return `${h}h ago`; return `${d}d ago`; }
            function updateNotificationBadgeCount(notifications){ const badge=document.querySelector('.notification-badge'); if(!badge) return; const unread=notifications.filter(n=>!n.read).length; if(unread>0){ badge.textContent= unread>99 ? '99+' : String(unread); badge.style.display='block'; } else { badge.style.display='none'; } }
            function populateNotificationDropdown(notifications){ const listEl=document.querySelector('.notification-list'); const emptyEl=document.querySelector('.notification-empty'); if(!listEl) return; listEl.innerHTML=''; if(!notifications || notifications.length===0){ if(emptyEl) emptyEl.style.display='block'; updateNotificationBadgeCount([]); return; } if(emptyEl) emptyEl.style.display='none'; notifications.slice(0,10).forEach(n=>{ const div=document.createElement('div'); div.className=`notification-item ${n.read ? 'read' : 'unread'}`; div.innerHTML = `
                    <div class=\"notification-content\">\n                        <div class=\"notification-title\">${escapeHtml(n.title || 'New Notification')}</div>\n                        <div class=\"notification-message\">${escapeHtml(n.message || '')}</div>\n                        <div class=\"notification-time\">${formatTimeAgo(n.timestamp)}</div>\n                    </div>\n                    <div class=\"notification-actions\">\n                        ${!n.read ? `<button class=\\\"mark-read-btn\\\" title=\\\"Mark as read\\\" onclick=\\\"markNotificationAsRead('${n.id}')\\\"><i class=\\\"fas fa-check\\\"></i></button>` : `<button class=\\\"mark-read-btn\\\" title=\\\"Already read\\\" disabled><i class=\\\"fas fa-check\\\"></i></button>`}\n                        <button class=\"delete-notification-btn\" title=\"Delete notification\" onclick=\"deleteNotificationWithConfirm('${n.id}')\"><i class=\"fas fa-trash\"></i></button>\n                    </div>\n                    ${!n.read ? '<div class=\"notification-dot\"></div>' : ''}
                `; listEl.appendChild(div); }); updateNotificationBadgeCount(notifications); }
            function wireNotificationUI(){ const btn=document.getElementById('notificationBtn'); const dropdown=document.querySelector('.notification-dropdown'); const profileDropdown=document.querySelector('.profile-dropdown'); if(!btn||!dropdown) return; const header=dropdown.querySelector('.notification-header'); if(header && !header.querySelector('.clear-all-notifications')){ const clearBtn=document.createElement('button'); clearBtn.className='clear-all-notifications'; clearBtn.textContent='Clear all'; clearBtn.addEventListener('click', async ()=>{ await clearAllNotifications(); const list=await loadNotificationsOnce(); populateNotificationDropdown(list); }); header.appendChild(clearBtn); const markBtn=header.querySelector('.mark-all-read'); if(markBtn) markBtn.addEventListener('click', async ()=>{ await markAllNotificationsAsRead(); const list=await loadNotificationsOnce(); populateNotificationDropdown(list); }); }
                btn.addEventListener('click', async (e)=>{ e.stopPropagation(); dropdown.classList.toggle('show'); if(profileDropdown) profileDropdown.classList.remove('show'); if(dropdown.classList.contains('show')){ const list=await loadNotificationsOnce(); populateNotificationDropdown(list); } });
                document.addEventListener('click', (e)=>{ if(!btn.contains(e.target) && !dropdown.contains(e.target)) dropdown.classList.remove('show'); }); }
            function subscribeNotifications(){ try{ const user=getAuthUser(); if(!user) return; const ref=firebase.database().ref(`notifications/${user.uid}`); ref.on('value', (snap)=>{ if(!snap.exists()){ updateNotificationBadgeCount([]); return; } const list=Object.values(snap.val()); updateNotificationBadgeCount(list); }); } catch(e) { /* noop */ } }
            function escapeHtml(str){ return String(str||'').replace(/[&<>"]+/g, (c)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

            // Initialize shared header bits
            window.authManager = new AuthManager();
            initializePage();
            wireNotificationUI();
            subscribeNotifications();
            if (typeof initializeMenuAuthorization === 'function') {
                initializeMenuAuthorization();
            } else if (typeof updateMenuWithFeatureAuthorization === 'function') {
                updateMenuWithFeatureAuthorization();
            }
            setTimeout(() => { const sb=document.querySelector('.sidebar'); if (sb && sb.classList.contains('menu-loading')) sb.classList.remove('menu-loading'); }, 800);

            // Preload employees for corrective action owner dropdowns
            (async function preloadEmployees(){
                try {
                    const user = getAuthUser();
                    const companyId = user?.companyId || 'default';
                    const snap = await firebase.database().ref(`companies/${companyId}/users`).once('value');
                    const users = snap.val() || {};
                    const employees = Object.values(users)
                        .filter(u => (u && u.role !== 'admin'))
                        .map(u => ({
                            id: u.uid || u.id || u.userId || '',
                            name: u.name || u.displayName || u.email || 'Unknown',
                            jobTitle: u.jobTitleLabel || u.jobTitle || u.position || ''
                        }));
                    window.employees = employees;
                } catch(e) {
                    window.employees = [];
                    console.warn('Failed to preload employees:', e);
                }
            })();

            // Finally, initialize the ICAM page logic
            investigationCreate = new InvestigationCreate();
        });

        // ========== Corrective Actions Modal Functions ==========
        let correctiveActionsData = [];
        let editingActionId = null;
        
        function openCorrectiveActionModal(actionId = null) {
            const modal = document.getElementById('correctiveActionModal');
            const modalTitle = document.getElementById('correctiveActionModalTitle');
            const form = document.getElementById('correctiveActionForm');
            
            // Reset form
            form.reset();
            editingActionId = actionId;
            
            if (actionId) {
                modalTitle.textContent = 'Edit Corrective Action';
                // Load existing action data
                const actionData = correctiveActionsData.find(action => action.id == actionId);
                if (actionData) {
                    document.getElementById('actionOwner').value = actionData.owner || '';
                    document.getElementById('actionDueDate').value = actionData.dueDate || '';
                    document.getElementById('actionType').value = actionData.type || '';
                    document.getElementById('actionStatus').value = actionData.status || 'Pending';
                    document.getElementById('actionDescription').value = actionData.description || '';
                    // Show existing attachment name (file inputs cannot be prefilled)
                    const attInfo = document.getElementById('actionAttachmentInfo');
                    if (attInfo) {
                        const name = actionData.attachment || '';
                        attInfo.textContent = name ? `Current: ${name}` : 'No attachment';
                        attInfo.style.display = 'block';
                    }
                }
            } else {
                modalTitle.textContent = 'Add Corrective Action';
                document.getElementById('actionStatus').value = 'Pending';
                const attInfo = document.getElementById('actionAttachmentInfo');
                if (attInfo) { attInfo.textContent = ''; attInfo.style.display = 'none'; }
            }
            
            // Load employees into action owner dropdown
            loadEmployeesForActionOwner();
            
            modal.classList.add('show');
        }

        function closeCorrectiveActionModal() {
            const modal = document.getElementById('correctiveActionModal');
            modal.classList.remove('show');
            editingActionId = null;
        }

        function loadEmployeesForActionOwner() {
            const select = document.getElementById('actionOwner');
            const originalValue = select.value;
            
            // Clear existing options except the first
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Add employees from the global employees list
            if (window.employees && Array.isArray(window.employees)) {
                window.employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.name;
                    option.textContent = emp.name;
                    select.appendChild(option);
                });
            }
            
            // Restore original value if it exists
            if (originalValue) {
                select.value = originalValue;
            }
        }

        function saveCorrectiveAction() {
            const form = document.getElementById('correctiveActionForm');
            
            // Validate required fields
            const requiredFields = [
                { id: 'actionOwner', name: 'Action Owner' },
                { id: 'actionDueDate', name: 'Due Date' },
                { id: 'actionType', name: 'Action Type' },
                { id: 'actionDescription', name: 'Description' }
            ];
            
            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    alert(`Please fill in the ${field.name} field.`);
                    element.focus();
                    return;
                }
            }
            
            const newFile = document.getElementById('actionAttachment').files[0];
            const existing = editingActionId ? (correctiveActionsData.find(a => a.id == editingActionId)?.attachment || '') : '';
            const actionData = {
                id: editingActionId || Date.now().toString(),
                owner: document.getElementById('actionOwner').value,
                dueDate: document.getElementById('actionDueDate').value,
                type: document.getElementById('actionType').value,
                status: document.getElementById('actionStatus').value,
                description: document.getElementById('actionDescription').value,
                attachment: newFile ? newFile.name : existing
            };
            
            if (editingActionId) {
                // Update existing action
                const index = correctiveActionsData.findIndex(action => action.id == editingActionId);
                if (index !== -1) {
                    correctiveActionsData[index] = actionData;
                }
            } else {
                // Add new action
                correctiveActionsData.push(actionData);
            }
            
            renderCorrectiveActionsTable();
            closeCorrectiveActionModal();
        }

        function renderCorrectiveActionsTable() {
            const table = document.getElementById('correctiveActionsTable');
            const tbody = document.getElementById('correctiveActionsTableBody');
            const emptyState = document.getElementById('correctiveActionsEmpty');
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            if (!correctiveActionsData || correctiveActionsData.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            table.style.display = 'table';
            
            correctiveActionsData.forEach(action => {
                const row = document.createElement('tr');
                row.setAttribute('data-ca-row', 'true');
                row.setAttribute('data-action-id', action.id);
                row.classList.add('ca-row');
                const statusClass = action.status === 'Completed' ? 'contributing' : 
                                  action.status === 'In Progress' ? 'non-contributing' : '';
                
                row.innerHTML = `
                    <td>${escapeHtmlGlobal(action.owner)}</td>
                    <td>${escapeHtmlGlobal(action.dueDate)}</td>
                    <td>${escapeHtmlGlobal(action.type)}</td>
                    <td>
                        <span class="tag ${statusClass}">
                            ${escapeHtmlGlobal(action.status || 'Pending')}
                        </span>
                    </td>
                    <td>${escapeHtmlGlobal(action.description)}</td>
                    <td class="actions-cell">
                        <button type="button" onclick="event.stopPropagation(); openCorrectiveActionModal('${action.id}')" style="background: #dcfce7; color: #059669; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.25rem;" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="event.stopPropagation(); removeCorrectiveActionFromTable('${action.id}')" style="background: #fee2e2; color: #dc2626; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function removeCorrectiveActionFromTable(actionId) {
            if (confirm('Are you sure you want to remove this corrective action?')) {
                correctiveActionsData = correctiveActionsData.filter(action => action.id != actionId);
                renderCorrectiveActionsTable();
            }
        }

        // Initialize corrective actions table on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                renderCorrectiveActionsTable();
            }, 100);
        });

        // ========== Statement Modal Functions ==========
        let statements = [];
        let editingStatementId = null;
        
        // Utility function for escaping HTML (global scope for statements)
        function escapeHtmlGlobal(str) {
            return String(str || '').replace(/[&<>"']/g, function(c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c] || c;
            });
        }
        
        // Initialize statements table on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for the DOM to be fully ready
            setTimeout(function() {
                renderStatementsTable();
            }, 100);
        });

        function openStatementModal(statementId = null) {
            const modal = document.getElementById('statementModal');
            const modalTitle = document.getElementById('statementModalTitle');
            const form = document.getElementById('statementForm');
            const nameDropdown = document.getElementById('statementName');
            const roleField = document.getElementById('statementRole');
            
            // Populate dropdown with persons involved from summary tab
            nameDropdown.innerHTML = '<option value="">Select Person Involved</option>';
            document.querySelectorAll('.incident-person').forEach(el => {
                const name = el.querySelector('.incident-person-name')?.value || '';
                const jobTitle = el.querySelector('.incident-person-jobtitle')?.value || '';
                const phone = el.querySelector('.incident-person-phone')?.value || '';
                if (name) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    option.dataset.jobTitle = jobTitle;
                    option.dataset.phone = phone;
                    nameDropdown.appendChild(option);
                }
            });
            
            // Add change event to auto-populate role and contact when person is selected
            nameDropdown.onchange = function() {
                const selectedOption = nameDropdown.options[nameDropdown.selectedIndex];
                if (selectedOption && selectedOption.dataset.jobTitle) {
                    roleField.value = selectedOption.dataset.jobTitle;
                } else {
                    roleField.value = '';
                }
                if (selectedOption && selectedOption.dataset.phone) {
                    document.getElementById('statementContact').value = selectedOption.dataset.phone;
                } else {
                    document.getElementById('statementContact').value = '';
                }
            };
            
            if (statementId) {
                // Edit mode
                editingStatementId = statementId;
                modalTitle.textContent = 'Edit Statement';
                const statement = statements.find(s => s.id === statementId);
                if (statement) {
                    // Try to select the person in dropdown, or add as custom option
                    let found = false;
                    for (let i = 0; i < nameDropdown.options.length; i++) {
                        if (nameDropdown.options[i].value === statement.name) {
                            nameDropdown.selectedIndex = i;
                            found = true;
                            break;
                        }
                    }
                    if (!found && statement.name) {
                        // Add as option if not in list (for previously saved statements)
                        const option = document.createElement('option');
                        option.value = statement.name;
                        option.textContent = statement.name + ' (not in persons involved)';
                        nameDropdown.appendChild(option);
                        nameDropdown.value = statement.name;
                    }
                    document.getElementById('statementRole').value = statement.role || '';
                    document.getElementById('statementDate').value = statement.date || '';
                    document.getElementById('statementContact').value = statement.contact || '';
                    document.getElementById('statementText').value = statement.statement || '';
                }
            } else {
                // Add mode
                editingStatementId = null;
                modalTitle.textContent = 'Record Statement';
                form.reset();
                roleField.value = '';
                // Set default date to today
                document.getElementById('statementDate').value = new Date().toISOString().split('T')[0];
            }
            
            modal.classList.add('show');
        }

        function closeStatementModal() {
            const modal = document.getElementById('statementModal');
            modal.classList.remove('show');
            editingStatementId = null;
        }

        function saveStatement() {
            try {
                const nameEl = document.getElementById('statementName');
                const roleEl = document.getElementById('statementRole');
                const dateEl = document.getElementById('statementDate');
                const contactEl = document.getElementById('statementContact');
                const textEl = document.getElementById('statementText');
                
                const name = nameEl ? nameEl.value : '';
                const role = roleEl ? roleEl.value : '';
                const date = dateEl ? dateEl.value : '';
                const contact = contactEl ? contactEl.value : '';
                const statementText = textEl ? textEl.value.trim() : '';

                if (!name) {
                    alert('Please select a person from the dropdown.');
                    return;
                }
                if (!statementText) {
                    alert('Please enter the statement.');
                    return;
                }

                if (editingStatementId) {
                    // Update existing statement
                    const index = statements.findIndex(s => s.id === editingStatementId);
                    if (index !== -1) {
                        statements[index] = {
                            ...statements[index],
                            name,
                            role,
                            date,
                            contact,
                            statement: statementText,
                            updatedAt: new Date().toISOString()
                        };
                    }
                } else {
                    // Add new statement
                    statements.push({
                        id: 'stmt_' + Date.now(),
                        name,
                        role,
                        date,
                        contact,
                        statement: statementText,
                        createdAt: new Date().toISOString()
                    });
                }

                renderStatementsTable();
                // Persist to Firebase under company/investigation scope
                persistStatementsToDB();
                closeStatementModal();
            } catch (err) {
                console.error('Error in saveStatement:', err);
                alert('Error saving statement: ' + err.message);
            }
        }

        function deleteStatement(statementId) {
            if (!confirm('Are you sure you want to delete this statement?')) return;
            statements = statements.filter(s => s.id !== statementId);
            renderStatementsTable();
        }

        function renderStatementsTable() {
            const tbody = document.getElementById('statementsTableBody');
            const emptyMsg = document.getElementById('statementsEmpty');
            const table = document.getElementById('statementsTable');

            if (!tbody) {
                console.error('statementsTableBody not found');
                return;
            }

            tbody.innerHTML = '';

            if (statements.length === 0) {
                table.style.display = 'none';
                emptyMsg.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            emptyMsg.style.display = 'none';

            statements.forEach(stmt => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                const summary = (stmt.statement || '').substring(0, 50) + ((stmt.statement || '').length > 50 ? '...' : '');
                tr.innerHTML = `
                    <td>${escapeHtmlGlobal(stmt.name)}</td>
                    <td>${escapeHtmlGlobal(stmt.role || '-')}</td>
                    <td>${stmt.date || '-'}</td>
                    <td title="${escapeHtmlGlobal(stmt.statement)}">${escapeHtmlGlobal(summary)}</td>
                    <td class="actions-cell" onclick="event.stopPropagation();">
                        <button type="button" onclick="openStatementModal('${stmt.id}')" style="background: #dcfce7; color: #059669; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; margin-right: 0.25rem;" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" onclick="deleteStatement('${stmt.id}')" style="background: #fee2e2; color: #dc2626; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                // Add click handler to open view modal
                tr.addEventListener('click', function() {
                    viewStatementDetails(stmt.id);
                });
                tbody.appendChild(tr);
            });
        }
        
        // View statement details in a read-only modal
        function viewStatementDetails(statementId) {
            const stmt = statements.find(s => s.id === statementId);
            if (!stmt) return;
            
            const modal = document.getElementById('statementViewModal');
            if (!modal) return;
            
            // Populate modal fields
            document.getElementById('viewStatementName').textContent = stmt.name || '-';
            document.getElementById('viewStatementRole').textContent = stmt.role || '-';
            document.getElementById('viewStatementDate').textContent = stmt.date || '-';
            document.getElementById('viewStatementContact').textContent = stmt.contact || '-';
            document.getElementById('viewStatementText').textContent = stmt.statement || '-';
            
            modal.classList.add('show');
        }
        
        function closeStatementViewModal() {
            const modal = document.getElementById('statementViewModal');
            if (modal) modal.classList.remove('show');
        }
        
        // Toggle collapse/expand for Witness Statements section
        function toggleStatementsSection() {
            const container = document.getElementById('statementsTableContainer');
            const icon = document.getElementById('statementsCollapseIcon');
            if (!container || !icon) return;
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                container.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }

        // Collect statements for saving
        function collectStatements() {
            return statements;
        }

        // Load statements when editing (from provided data)
        function loadStatements(statementsData) {
            if (Array.isArray(statementsData)) {
                statements = statementsData;
                renderStatementsTable();
            }
        }

        // --- Firebase Persistence for Statements ---
        async function getInvestigationPath() {
            try {
                // Resolve companyId via the InvestigationCreate instance
                const ctx = await investigationCreate.resolveCompanyContext();
                const companyId = ctx?.companyId;
                // Derive investigationId from URL param (edit) or the reference number field
                const urlParams = new URLSearchParams(window.location.search);
                const editId = urlParams.get('edit');
                const refField = document.getElementById('referenceNumber');
                const investigationId = editId || (refField && refField.value ? refField.value : null);
                if (!companyId || !investigationId) {
                    console.warn('Missing companyId or investigationId; cannot persist statements yet.', { companyId, investigationId });
                    return null;
                }
                const path = `companies/${companyId}/investigations/${investigationId}/dataAnalysis/statements`;
                return { companyId, investigationId, path };
            } catch (e) {
                console.error('Error resolving investigation path:', e);
                return null;
            }
        }

        async function persistStatementsToDB() {
            const info = await getInvestigationPath();
            if (!info) return; // Skip if context not ready
            try {
                const db = firebase.database();
                await db.ref(info.path).set(statements);
                console.log('Statements persisted to DB at', info.path);
            } catch (e) {
                console.error('Failed to persist statements:', e);
            }
        }

        async function loadStatementsFromDB(setupRealtime = false) {
            const info = await getInvestigationPath();
            if (!info) return;
            try {
                const db = firebase.database();
                const ref = db.ref(info.path);
                const snap = await ref.once('value');
                const data = snap.val();
                if (Array.isArray(data)) {
                    statements = data;
                } else {
                    statements = Array.isArray(statements) ? statements : [];
                }
                renderStatementsTable();
                // Optionally set up realtime listener
                if (setupRealtime) {
                    ref.on('value', (s) => {
                        const d = s.val();
                        if (Array.isArray(d)) {
                            statements = d;
                        } else {
                            statements = [];
                        }
                        renderStatementsTable();
                    });
                }
            } catch (e) {
                console.error('Failed to load statements from DB:', e);
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('statementModal');
            if (e.target === modal) {
                closeStatementModal();
            }
            const viewModal = document.getElementById('statementViewModal');
            if (e.target === viewModal) {
                closeStatementViewModal();
            }
            const correctiveModal = document.getElementById('correctiveActionModal');
            if (e.target === correctiveModal) {
                closeCorrectiveActionModal();
            }
        });
        
        // Initial load of statements from Firebase once DOM and reference are ready
        document.addEventListener('DOMContentLoaded', () => {
            // Try loading immediately; also attempt a delayed retry to ensure referenceNumber is set
            loadStatementsFromDB(true);
            setTimeout(() => loadStatementsFromDB(false), 1000);
        });
    </script>

    <!-- Statement Modal -->
    <div id="statementModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="statementModalTitle">Record Statement</h3>
                <button type="button" class="modal-close" onclick="closeStatementModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="statementForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="statementName">Person Name *</label>
                            <select id="statementName" required>
                                <option value="">Select Person Involved</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="statementRole">Role / Position</label>
                            <input type="text" id="statementRole" placeholder="e.g., Operator, Supervisor" readonly style="background-color: #f1f5f9;">
                        </div>
                        <div class="form-group">
                            <label for="statementDate">Date of Statement</label>
                            <input type="date" id="statementDate">
                        </div>
                        <div class="form-group">
                            <label for="statementContact">Contact Info</label>
                            <input type="text" id="statementContact" placeholder="Phone or email" readonly style="background-color: #f1f5f9;">
                        </div>
                        <div class="form-group full-width">
                            <label for="statementText">Statement *</label>
                            <textarea id="statementText" rows="6" placeholder="Record the witness statement in detail..." required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeStatementModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStatement()">
                    <i class="fas fa-save"></i> Save Statement
                </button>
            </div>
        </div>
    </div>

    <!-- Corrective Action Modal -->
    <div id="correctiveActionModal" class="modal-overlay">
    <script>
    // Make corrective action rows clickable to open details modal
    (function(){
        function getTable(){ return document.getElementById('correctiveActionsTable'); }
        function openView(actionId){
            if(typeof window.openCorrectiveActionModal === 'function'){
                window.openCorrectiveActionModal(actionId, 'view');
            }
        }
        document.addEventListener('click', function(e){
            const row = e.target.closest('[data-ca-row]');
            if(row){
                const id = row.getAttribute('data-action-id') || row.dataset.actionId;
                if(id){ openView(id); }
            }
        });
        const observer = new MutationObserver(function(){
            const tbl = getTable(); if(!tbl) return;
            tbl.querySelectorAll('[data-ca-row]').forEach(r => r.classList.add('ca-row'));
        });
        document.addEventListener('DOMContentLoaded', function(){
            const tbl = getTable(); if(tbl){ observer.observe(tbl, { childList: true, subtree: true }); }
        });
    })();
    </script>
    <script>
    // Enhance corrective action modal to support up to two attachments
    (function(){
        const MAX_ATTACHMENTS = 2;
        function infoEl(){ return document.getElementById('actionAttachmentInfo'); }
        function fileInput(){ return document.getElementById('actionAttachment'); }

        function readList(){
            const el = infoEl();
            if(!el) return [];
            try {
                const raw = el.dataset.attachments || '[]';
                const arr = JSON.parse(raw);
                if(Array.isArray(arr)) return arr.slice(0, MAX_ATTACHMENTS);
                return [];
            } catch { return []; }
        }
        function writeList(list){
            const el = infoEl(); if(!el) return;
            el.dataset.attachments = JSON.stringify((list||[]).slice(0, MAX_ATTACHMENTS));
        }
        function renderList(){
            const el = infoEl(); if(!el) return;
            const list = readList();
            el.innerHTML = '';
            if(list.length === 0){ el.textContent = 'No attachments'; return; }
            list.forEach((att, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'attachment-info';
                wrap.dataset.slot = String(idx);
                const nameSpan = document.createElement('span');
                nameSpan.className = 'filename';
                nameSpan.textContent = att.name || 'Unnamed';
                const actions = document.createElement('div');
                actions.className = 'attachment-actions';
                const downloadBtn = document.createElement('button');
                downloadBtn.type = 'button'; downloadBtn.className = 'btn-icon'; downloadBtn.title = 'Download';
                downloadBtn.innerHTML = '<i class="fas fa-download"></i>';
                downloadBtn.addEventListener('click', function(){ if(att.url){ window.open(att.url, '_blank'); } else { alert('Attachment URL not available'); } });
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button'; removeBtn.className = 'btn-icon'; removeBtn.title = 'Remove';
                removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
                removeBtn.addEventListener('click', function(){ removeSlot(idx); });
                actions.appendChild(downloadBtn);
                actions.appendChild(removeBtn);
                wrap.appendChild(nameSpan);
                wrap.appendChild(actions);
                el.appendChild(wrap);
            });
        }
        function removeSlot(slot){
            const list = readList();
            const newList = list.filter((_, i) => i !== slot);
            writeList(newList);
            renderList();
            // mark removal flags for saving logic, if present
            const flag = document.getElementById('actionAttachmentRemoved');
            if(flag) { flag.value = 'true'; }
        }

        // Public API so existing modal code can set existing attachments
        window.CorrectiveActionAttachmentUI = {
            setList: function(items){ writeList(items||[]); renderList(); },
            clear: function(){ writeList([]); renderList(); },
            getList: function(){ return readList(); }
        };

        // Enforce file input to accept up to two files
        document.addEventListener('DOMContentLoaded', function(){
            const input = fileInput();
            if(input){
                input.multiple = true;
                input.addEventListener('change', function(){
                    const files = Array.from(input.files || []);
                    if(files.length > MAX_ATTACHMENTS){
                        alert('You can select up to two attachments. Keeping the first two.');
                        // Create a new DataTransfer to trim selection
                        const dt = new DataTransfer();
                        files.slice(0, MAX_ATTACHMENTS).forEach(f => dt.items.add(f));
                        input.files = dt.files;
                    }
                });
            }
        });
    })();
    </script>
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="correctiveActionModalTitle">Add Corrective Action</h3>
                <button type="button" class="modal-close" onclick="closeCorrectiveActionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="correctiveActionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="actionOwner">Action Owner *</label>
                            <select id="actionOwner" required>
                                <option value="">-- Select --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="actionDueDate">Due Date *</label>
                            <input type="date" id="actionDueDate" required>
                        </div>
                        <div class="form-group">
                            <label for="actionType">Action Type *</label>
                            <select id="actionType" required>
                                <option value="">-- Select --</option>
                                <option value="Elimination">Elimination</option>
                                <option value="Substitution">Substitution</option>
                                <option value="Engineering Control">Engineering Control</option>
                                <option value="Administrative Control">Administrative Control</option>
                                <option value="PPE">PPE</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="actionStatus">Status</label>
                            <select id="actionStatus">
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="actionDescription">Description *</label>
                            <textarea id="actionDescription" rows="3" placeholder="Describe the corrective action in detail..." required></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="actionAttachment">Attachment</label>
                            <input type="file" id="actionAttachment" accept="image/*,.pdf,.doc,.docx">
                            <div id="actionAttachmentInfo" style="font-size:0.8rem;color:#64748b;margin-top:0.35rem;display:none;"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeCorrectiveActionModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCorrectiveAction()">
                    <i class="fas fa-save"></i> Save Action
                </button>
            </div>
        </div>
    </div>

    <!-- Statement View Modal (Read-only) -->
    <div id="statementViewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Statement Details</h3>
                <button type="button" class="modal-close" onclick="closeStatementViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; gap: 1rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-size: 0.75rem; color: #64748b; font-weight: 600; display: block; margin-bottom: 0.25rem;">Person Name</label>
                            <div id="viewStatementName" style="font-size: 0.9rem; color: #1e293b; font-weight: 500; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">-</div>
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: #64748b; font-weight: 600; display: block; margin-bottom: 0.25rem;">Role / Position</label>
                            <div id="viewStatementRole" style="font-size: 0.9rem; color: #1e293b; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">-</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="font-size: 0.75rem; color: #64748b; font-weight: 600; display: block; margin-bottom: 0.25rem;">Date of Statement</label>
                            <div id="viewStatementDate" style="font-size: 0.9rem; color: #1e293b; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">-</div>
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: #64748b; font-weight: 600; display: block; margin-bottom: 0.25rem;">Contact Info</label>
                            <div id="viewStatementContact" style="font-size: 0.9rem; color: #1e293b; padding: 0.5rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">-</div>
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: #64748b; font-weight: 600; display: block; margin-bottom: 0.25rem;">Statement</label>
                        <div id="viewStatementText" style="font-size: 0.9rem; color: #1e293b; padding: 0.75rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0; min-height: 150px; white-space: pre-wrap; line-height: 1.6;">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeStatementViewModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Incident Location Map Script -->
    <script>
        let incidentMap = null;
        let incidentMarker = null;
        const defaultLat = 25.276987;
        const defaultLng = 55.296249;

        function initIncidentMap() {
            const mapContainer = document.getElementById('incidentMap');
            if (!mapContainer || incidentMap) return;

            // Initialize map with default location (Dubai)
            incidentMap = L.map('incidentMap').setView([defaultLat, defaultLng], 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: ' <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(incidentMap);

            // Add default marker
            incidentMarker = L.marker([defaultLat, defaultLng], { draggable: true }).addTo(incidentMap);
            incidentMarker.bindPopup('Incident Location').openPopup();

            // Update coordinates when marker is dragged
            incidentMarker.on('dragend', function(e) {
                const pos = incidentMarker.getLatLng();
                document.getElementById('incidentLatitude').value = pos.lat.toFixed(6);
                document.getElementById('incidentLongitude').value = pos.lng.toFixed(6);
                updateMapLocationText(pos.lat, pos.lng);
            });

            // Allow clicking on map to move marker
            incidentMap.on('click', function(e) {
                incidentMarker.setLatLng(e.latlng);
                document.getElementById('incidentLatitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('incidentLongitude').value = e.latlng.lng.toFixed(6);
                updateMapLocationText(e.latlng.lat, e.latlng.lng);
            });
        }

        function updateIncidentMap() {
            const lat = parseFloat(document.getElementById('incidentLatitude').value);
            const lng = parseFloat(document.getElementById('incidentLongitude').value);

            if (isNaN(lat) || isNaN(lng)) {
                alert('Please enter valid latitude and longitude values.');
                return;
            }

            if (!incidentMap) {
                initIncidentMap();
            }

            incidentMap.setView([lat, lng], 15);
            incidentMarker.setLatLng([lat, lng]);
            incidentMarker.openPopup();
            updateMapLocationText(lat, lng);
        }

        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    document.getElementById('incidentLatitude').value = lat.toFixed(6);
                    document.getElementById('incidentLongitude').value = lng.toFixed(6);
                    updateIncidentMap();
                },
                function(error) {
                    let msg = 'Unable to retrieve your location.';
                    if (error.code === 1) msg = 'Location access denied. Please allow location access.';
                    else if (error.code === 2) msg = 'Location unavailable. Please try again.';
                    else if (error.code === 3) msg = 'Location request timed out. Please try again.';
                    alert(msg);
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function updateMapLocationText(lat, lng) {
            const textEl = document.getElementById('mapLocationText');
            if (textEl) {
                textEl.innerHTML = `<i class="fas fa-map-pin"></i> Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        // Initialize map when Summary tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize on page load if summary tab is active
            setTimeout(function() {
                if (document.getElementById('summary')?.classList.contains('active')) {
                    initIncidentMap();
                }
            }, 500);

            // Re-init map when tab changes (Leaflet needs container to be visible)
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.dataset.tab === 'summary') {
                        setTimeout(function() {
                            if (!incidentMap) {
                                initIncidentMap();
                            } else {
                                incidentMap.invalidateSize();
                            }
                        }, 100);
                    }
                });
            });
        });
    </script>
</body>
</html>