<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Matrix - Application Analysis & Ranking - Dreamex Datalab HSE</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Embedded CSS from styles.css -->
    <style>
        /* External styles.css content embedded inline */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
            --sidebar-width: 250px;
            /* Theme Colors */
            --blue: #3498db;
            --green: #2ecc71;
            --purple: #9b59b6;
            --orange: #e67e22;
            --red: #e74c3c;
            
            /* Default Values */
            --accent-color: var(--blue);
            --font-family: 'Inter', system-ui, -apple-system, sans-serif;
            --base-font-size: 0.9rem; /* Standardized, reduced from 14px */
            --font-scale: 1;
            
            /* Theme-specific variables */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
        }

        /* Dark theme */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #404040;
        }

        /* High contrast mode */
        [data-contrast="high"] {
            --text-primary: #000000;
            --text-secondary: #000000;
            --bg-primary: #ffffff;
            --bg-secondary: #ffffff;
            --border-color: #000000;
        }

        [data-theme="dark"][data-contrast="high"] {
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --bg-primary: #000000;
            --bg-secondary: #000000;
            --border-color: #ffffff;
        }

        /* Layout density */
        [data-density="comfortable"] {
            --spacing-unit: 1rem;
            --padding-sm: 0.5rem;
            --padding-md: 1rem;
            --padding-lg: 1.5rem;
        }

        [data-density="compact"] {
            --spacing-unit: 0.75rem;
            --padding-sm: 0.25rem;
            --padding-md: 0.75rem;
            --padding-lg: 1rem;
        }

        [data-density="spacious"] {
            --spacing-unit: 1.5rem;
            --padding-sm: 0.75rem;
            --padding-md: 1.5rem;
            --padding-lg: 2rem;
        }

        /* Animation settings */
        [data-reduced-motion="none"] {
            --transition-speed: 0.2s;
        }

        [data-reduced-motion="reduced"] {
            --transition-speed: 0.4s;
        }

        [data-reduced-motion="minimal"] {
            --transition-speed: 0s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            font-size: var(--base-font-size);
            line-height: calc(1.5 * var(--font-scale));
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .logo h2 {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu {
            list-style: none;
            margin-top: 2rem;
        }

        .menu li {
            margin-bottom: 0.5rem;
        }

        .menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .menu a i {
            margin-right: 10px;
        }

        .menu a:hover, .menu a.active {
            background-color: var(--secondary-color);
        }

        .menu-dropdown .submenu {
            display: none;
            list-style: none;
            margin-left: 2rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown:hover .submenu {
            display: block;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 0.5rem;
            width: calc(100% - var(--sidebar-width));
            box-sizing: border-box;
        }

        /* Form Container Styles */
        .form-container {
            width: 100%;
            max-width: none;
            padding: 1rem;
            margin: 0;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Content Container */
        .content {
            width: 100%;
            margin: 0;
            padding: 1rem;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .top-nav {
            display: flex;
            justify-content: space-between;  /* Changed back to space-between to accommodate left content */
            align-items: center;
            padding: 0.75rem;
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 0.75rem;
            position: relative;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        .search-bar {
            position: absolute;
            left: 1rem;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;  /* Increased from 1rem for better spacing */
            margin-left: auto;
        }

        /* Notification Styles */
        .notifications {
            position: relative;
            display: flex;
            align-items: center;
        }

        .notification-btn {
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            width: 300px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .notification-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .notification-actions h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .notification-link {
            text-decoration: none;
            color: #3498db;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .notification-link:hover {
            background: #f8f9fa;
            color: #2980b9;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .mark-all-read:hover {
            background: #f8f9fa;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #f5f5f5;
        }

        /* User Profile Styles */
        .user-profile {
            position: relative;
            display: flex;
            align-items: center;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 280px;
            z-index: 9999;
            overflow: visible;
        }

        .profile-dropdown.show {
            display: block !important;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .profile-dropdown ul li {
            padding: 0;
        }

        .profile-dropdown ul li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .profile-dropdown ul li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown ul li a i {
            margin-right: 10px;
            width: 16px;
            color: #666;
        }

        /* Profile header styles */
        .profile-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .avatar-initials {
            color: white;
            font-weight: 600;
            font-size: 18px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-email {
            color: #666;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-divider {
            height: 1px;
            background: #e9ecef;
            margin: 0 0 8px 0;
        }

        /* Ensure the profile button looks interactive */
        .profile-btn {
            cursor: pointer;
            padding: 0;
            border: none;
            background: none;
            display: flex;
            align-items: center;
        }

        /* User Profile Dropdown Styles */
        .user-info {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .admin-crown-icon {
            color: #ffd700; /* Gold color for the crown */
            margin-left: 0.5rem;
            font-size: 0.9rem;
            vertical-align: middle;
            animation: crown-glow 2s ease-in-out infinite alternate;
        }

        @keyframes crown-glow {
            from {
                text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
            to {
                text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 15px rgba(255, 215, 0, 0.6);
            }
        }

        .user-email {
            font-size: 0.9rem;
            color: #666;
        }

        .user-status {
            margin-top: 0.25rem;
        }

        .divider {
            height: 1px;
            background-color: #eee;
            margin: 0.5rem 0;
        }

        /* Profile Dropdown Status Badge */
        .user-status .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        /* Content Styles */
        .content {
            margin-top: 0.75rem; /* Reduced from 2rem */
            padding: 0.5rem; /* Reduced from 1rem */
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem; /* Reduced from 1rem */
        }

        .data-table th,
        .data-table td {
            padding: 0.25rem 0.5rem; /* Reduced from 0.75rem 1rem */
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .btn {
            padding: var(--padding-sm) var(--padding-md);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
        }

        .btn-edit {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-approve {
            background-color: #27ae60;
            color: white;
        }

        .btn-decline {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: white;
        }

        .btn-icon i {
            font-size: 0.9rem;
        }

        .btn-icon.btn-approve {
            background-color: #2ecc71;
        }

        .btn-icon.btn-approve:hover {
            background-color: #27ae60;
        }

        .btn-icon.btn-decline {
            background-color: #e74c3c;
        }

        .btn-icon.btn-decline:hover {
            background-color: #c0392b;
        }

        .btn-icon.btn-export {
            background-color: #9b59b6;
        }

        .btn-icon.btn-export:hover {
            background-color: #8e44ad;
        }

        .btn-icon.btn-delete {
            background-color: #e74c3c;
        }

        .btn-icon.btn-delete:hover {
            background-color: #c0392b;
        }

        .btn-icon:not(:last-child) {
            margin-right: 0.25rem;
        }

        /* Form Styles */
        .form-container {
            width: 100%;
            max-width: none;
            margin: 1rem 0; /* Removed auto centering */
            padding: 1rem; /* Reduced from 2rem */
            background-color: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: var(--spacing-unit);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            margin-top: 1.25rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Login Page Styles */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }

        .login-box {
            background-color: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-color);
            opacity: 0.8;
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon input {
            padding-left: 40px;
            width: 100%;
            height: 45px;
        }

        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-color);
            opacity: 0.5;
        }

        .btn-login {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            height: 45px;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .btn-login:hover {
            background-color: var(--secondary-color);
        }

        .error-message {
            color: var(--accent-color);
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Role Badge Styles */
        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-guest {
            background-color: #95a5a6;
            color: white;
        }

        .role-standard {
            background-color: #3498db;
            color: white;
        }

        .role-editor {
            background-color: #2ecc71;
            color: white;
        }

        .role-admin {
            background-color: #e67e22;
            color: white;
        }

        .role-superuser {
            background-color: #9b59b6;
            color: white;
        }

        /* Form Hint Style */
        .form-hint {
            color: #666;
            font-size: 0.8rem;
            margin-top: 4px;
            display: block;
        }

        /* Content Header with Button */
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        /* User Table Status Styles */
        .status-active {
            background-color: #2ecc71;
            color: white;
        }

        .status-inactive {
            background-color: #95a5a6;
            color: white;
        }

        /* Modal Header Styles */
        .modal-header {
            border-bottom: 1px solid #ddd;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        /* Modal Footer Styles */
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 0.85rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-start; /* Changed from flex-end to flex-start to align buttons to the left */
            background: rgba(255, 255, 255, 0.95);
            position: sticky;
            bottom: 0;
            z-index: 2;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
        }

        .modal-footer .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        /* Color coding for different action buttons */
        .btn-edit {
            background-color: #3b82f6; /* Blue */
            color: white;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
        }

        .btn-edit:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .btn-success {
            background-color: #10b981; /* Green */
            color: white;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background-color: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
            box-shadow: 0 2px 5px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
        }

        .btn-delete {
            background-color: #f43f5e; /* Pink/Red */
            color: white;
            box-shadow: 0 2px 5px rgba(244, 63, 94, 0.3);
        }

        .btn-delete:hover {
            background-color: #e11d48;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(244, 63, 94, 0.4);
        }

        .btn-secondary {
            background-color: #6b7280; /* Gray */
            color: white;
            box-shadow: 0 2px 5px rgba(107, 114, 128, 0.3);
        }

        .btn-secondary:hover {
            background-color: #4b5563;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
        }

        /* New warning color button - Yellow/Amber */
        .btn-warning {
            background-color: #f59e0b;
            color: white;
            box-shadow: 0 2px 5px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }

        /* New info color button - Light blue */
        .btn-info {
            background-color: #0ea5e9;
            color: white;
            box-shadow: 0 2px 5px rgba(14, 165, 233, 0.3);
        }

        .btn-info:hover {
            background-color: #0284c7;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.4);
        }

        /* Disabled button styling */
        .btn:disabled,
        .btn.btn-disabled {
            opacity: 1; /* Changed from 0.6 */
            cursor: pointer; /* Changed from not-allowed */
            pointer-events: auto; /* Changed from none */
            position: relative;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn:disabled:hover,
        .btn.btn-disabled:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn.btn-success:disabled,
        .btn.btn-success.btn-disabled {
            background-color: #10b981; /* Changed from #92d3b5 to full color */
            color: #ffffff;
        }

        /* Add tooltip styling for disabled buttons */
        .btn.btn-disabled::before {
            content: attr(title);
            position: absolute;
            background-color: rgba(51, 51, 51, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            bottom: calc(100% + 10px);
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .btn.btn-disabled::after {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 5px;
            border-style: solid;
            border-color: rgba(51, 51, 51, 0.9) transparent transparent transparent;
            opacity: 0;
            transition: opacity 0.3s;
        }
    </style>
    <style>
        .matrix-container {
            padding: 1rem;
            width: 100%;
            margin: 0;
        }

        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 0;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            padding: 1.25rem;
            margin: 0 1rem 1rem 1rem;
            transition: box-shadow 0.3s ease;
        }

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            flex-shrink: 0;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: white;
            margin: 0 0 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-title i {
            color: white;
            font-size: 1.8rem;
            opacity: 0.9;
        }

        .page-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
            color: white;
        }

        .stat-cards {
            display: flex;
            gap: 0.5rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0;
            padding: 0.75rem;
            text-align: center;
            min-width: 100px;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .stat-card:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 0.25rem;
        }

        .stat-card div:last-child {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
        }

        .matrix-tabs {
            display: flex;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
            margin: 0 1rem;
        }

        .matrix-tab {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            transition: all 0.2s;
            border-radius: 0;
        }

        .matrix-tab:hover {
            color: #007bff;
            background: #f8f9fa;
        }

        .matrix-tab.active {
            color: #ffffff;
            background: #007bff;
        }

        /* Specific tab colors when active */
        .matrix-tab.active[onclick*="criteria"] {
            background: #28a745; /* Green for criteria */
        }

        .matrix-tab.active[onclick*="algorithm"] {
            background: #ffc107; /* Yellow for algorithm */
            color: #212529;
        }

        .matrix-tab.active[onclick*="preview"] {
            background: #17a2b8; /* Teal for preview */
        }

        .matrix-tab.active[onclick*="analytics"] {
            background: #dc3545; /* Red for analytics */
        }

        .tab-content {
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem;
            display: none;
            margin: 0 1rem 1rem 1rem;
        }

        .tab-content.active {
            display: block;
        }        .criteria-section {
            margin-bottom: 0.75rem;
        }        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 1.1rem;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;        }        .criteria-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            width: 100%;
            max-width: 100%;
        }.criteria-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 0;
            padding: 0.75rem;
            transition: all 0.3s;
        }

        .criteria-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 15px rgba(0,123,255,0.1);
        }

        .criteria-card.enabled {
            border-color: #28a745;
            background: #f8fff9;
        }        .criteria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .criteria-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #28a745;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(26px);
        }        .criteria-config {
            display: grid;
            gap: 0.25rem;
        }        .config-row {
            display: grid;
            grid-template-columns: 1fr 100px;
            gap: 0.25rem;
            align-items: center;
        }

        .config-label {
            font-weight: 500;
            color: #495057;
        }

        .config-input {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
        }        .weight-slider {
            width: 100%;
            margin: 0.25rem 0;
        }        .weight-display {
            text-align: center;
            font-weight: 600;
            color: #007bff;
            margin-top: 0.25rem;
        }.keywords-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
        }

        .algorithm-section {
            background: #f8f9fa;
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.25rem;
        }

        .algorithm-header {
            margin-bottom: 1rem;
        }

        .algorithm-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .algorithm-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .algorithm-card:hover {
            border-color: #007bff;
        }

        .algorithm-card.selected {
            border-color: #007bff;
            background: #f0f8ff;
        }

        .algorithm-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .algorithm-description {
            color: #6c757d;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .scoring-preview {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.25rem;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #e9ecef;
        }

        .preview-title {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .preview-table th {
            background: #f8f9fa;
            padding: 0.5rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }

        .preview-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .score-bar {
            width: 100px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            transition: width 0.3s;
        }        .rank-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .rank-1 { background: #ffd700; color: #856404; }
        .rank-2 { background: #c0c0c0; color: #495057; }
        .rank-3 { background: #cd7f32; color: white; }
        .rank-other { background: #6c757d; color: white; }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.excellent { background: #d4edda; color: #155724; }
        .status-badge.good { background: #cce7ff; color: #004085; }
        .status-badge.average { background: #fff3cd; color: #856404; }
        .status-badge.below-average { background: #f8d7da; color: #721c24; }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .analytics-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .analytics-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .analytics-number {
            font-size: 2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .analytics-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .threshold-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.25rem;
        }

        .threshold-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            color: #856404;
            font-weight: 600;
        }

        .threshold-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        .threshold-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .threshold-label {
            font-weight: 500;
            color: #495057;
        }        .threshold-input {
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
        }

        /* Percentage Validation Styles */
        .percentage-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #e1bee7;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.25rem;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .percentage-summary.valid {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            border-color: #4caf50;
        }

        .percentage-summary.error {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            border-color: #f44336;
        }

        .percentage-total {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .percentage-total.valid {
            color: #4caf50;
        }

        .percentage-total.error {
            color: #f44336;
        }

        .criteria-percentage-input {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            color: #495057;
            width: 80px;
            transition: all 0.2s;
        }

        .criteria-percentage-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .criteria-percentage-input.error {
            border-color: #dc3545;
            background: #ffe6e6;
            color: #dc3545;
        }        .percentage-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        /* Sub-percentage Styles */
        .sub-percentage-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .sub-percentage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .sub-percentage-title {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sub-percentage-total {
            font-weight: 700;
            color: #007bff;
            font-size: 0.9rem;
        }

        .sub-percentage-total.valid {
            color: #28a745;
        }

        .sub-percentage-total.error {
            color: #dc3545;
        }

        .sub-percentage-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .sub-percentage-item:hover {
            border-color: #007bff;
            box-shadow: 0 2px 5px rgba(0,123,255,0.1);
        }

        .sub-percentage-keyword {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .sub-percentage-input {
            width: 60px;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .sub-percentage-input.error {
            border-color: #dc3545;
            background: #fff5f5;
            color: #dc3545;
        }

        .sub-percentage-delete {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }

        .sub-percentage-delete:hover {
            background: #c82333;
        }

        .add-sub-percentage {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }

        .add-sub-percentage:hover {
            background: #218838;
        }

        .sub-percentage-mode-toggle {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .sub-percentage-mode-toggle.active {
            background: #007bff;
        }

        .sub-percentage-mode-toggle:hover {
            background: #5a6268;
        }

        .sub-percentage-mode-toggle.active:hover {
            background: #0056b3;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .matrix-container {
                padding: 1rem;
            }

            .matrix-tabs {
                flex-direction: column;
                margin: 0 1rem;
            }

            .matrix-tab {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .tab-content {
                margin: 0 1rem 2rem 1rem;
                padding: 1rem;
            }

            .page-header {
                margin: 0 1rem 1.5rem 1rem;
                padding: 1.5rem;
            }

            .header-top-row {
                flex-direction: column;
                gap: 1rem;
            }

            .stat-cards {
                justify-content: center;
                flex-wrap: wrap;
            }

            .stat-card {
                min-width: 80px;
                padding: 0.75rem;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .page-title i {
                font-size: 1.3rem;
            }

            .page-subtitle {
                font-size: 1rem;
            }            .criteria-grid,
            .algorithm-grid {
                grid-template-columns: 1fr;
            }

            .config-row {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* Job Selection Section Styles */
        .job-selection-section {
            margin: 0 2rem 0.75rem 2rem;
        }

        .job-selection-card {
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .job-selection-header {
            background: transparent;
            color: #2c3e50;
            padding: 0.75rem 2rem;
        }

        .job-selection-title {
            font-size: 1.3rem;
            margin: 0 0 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .job-selection-subtitle {
            margin: 0;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .job-selection-content {
            padding: 1rem 2rem 1.5rem 2rem;
        }

        .job-dropdown-wrapper {
            margin-bottom: 0.5rem;
        }

        .job-dropdown-label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .job-dropdown {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s;
        }

        .job-dropdown:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .job-dropdown:hover {
            border-color: #28a745;
        }

        .selected-job-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .job-info-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
        }

        .job-info-content {
            display: grid;
            gap: 0.75rem;
        }

        .job-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .job-info-row:last-child {
            border-bottom: none;
        }

        .job-info-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .job-info-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9rem;
        }        /* Responsive adjustments for job selection */
        @media (max-width: 768px) {
            .job-selection-header {
                padding: 1rem 1.5rem;
            }

            .job-selection-content {
                padding: 1.5rem;
            }

            .job-info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
        }

        /* Job Notice Banner */
        .job-notice {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin: 0 2rem 1.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .job-notice.hidden {
            display: none;
        }

        .job-notice-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .job-notice i {
            font-size: 1.1rem;
            opacity: 0.9;
        }        @media (max-width: 768px) {
            .job-notice {
                padding: 0.75rem 1.5rem;
                margin-bottom: 1.5rem;
            }

            .job-notice-content {
                font-size: 0.9rem;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            position: relative;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            margin: 0.5rem 0 0 0;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 2rem;
        }

        .score-overview {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            position: relative;
        }

        .score-circle::before {
            content: '';
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
            position: absolute;
        }

        .score-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            z-index: 1;
        }

        .score-rating {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .score-details {
            display: grid;
            gap: 1.5rem;
        }

        .criteria-breakdown {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .criteria-breakdown-header {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .criteria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .criteria-item:last-child {
            border-bottom: none;
        }

        .criteria-name {
            font-weight: 500;
            color: #495057;
        }

        .criteria-score {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .criteria-bar {
            width: 100px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .criteria-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
            transition: width 0.3s;
        }

        .criteria-percentage {
            font-weight: 600;
            color: #2c3e50;
            min-width: 45px;
            text-align: right;
        }

        .ai-insights {
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
            border: 1px solid #2196f3;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .ai-insights-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 1rem;
        }

        .ai-insight-item {
            background: white;
            border: 1px solid #e3f2fd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            color: #495057;
        }        .ai-insight-item:last-child {
            margin-bottom: 0;
        }

        /* Analysis Tabs Styles */
        .analysis-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.25rem;
            margin-bottom: 2rem;
            gap: 0.25rem;
        }

        .analysis-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .analysis-tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .analysis-tab.active {
            background: #007bff;
            color: white;
        }

        .analysis-content {
            display: none;
        }

        .analysis-content.active {
            display: block;
        }

        /* Detailed Analysis Styles */
        .detailed-scoring {
            display: grid;
            gap: 2rem;
        }

        .scoring-section,
        .keyword-matching,
        .ai-algorithm-details,
        .raw-data-section,
        .calculation-steps {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .scoring-header {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .criteria-detail {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .criteria-detail:last-child {
            margin-bottom: 0;
        }

        .criteria-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .criteria-detail-name {
            font-weight: 600;
            color: #495057;
            font-size: 1rem;
        }

        .criteria-detail-score {
            font-weight: 700;
            color: #007bff;
            font-size: 1rem;
        }

        .criteria-calculation {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .keyword-match {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .keyword-match:last-child {
            border-bottom: none;
        }

        .keyword-text {
            font-weight: 500;
            color: #495057;
        }

        .keyword-found {
            color: #28a745;
            font-weight: 600;
        }

        .keyword-not-found {
            color: #dc3545;
            font-weight: 600;
        }

        .keyword-score {
            font-weight: 600;
            color: #007bff;
        }

        .calculation-step {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 8px 8px 0;
        }

        .calculation-step:last-child {
            margin-bottom: 0;
        }

        .step-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .step-calculation {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            color: #495057;
        }

        .step-result {
            font-weight: 600;
            color: #007bff;
            margin-top: 0.5rem;
        }

        .raw-data-content {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #495057;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .ai-strength-area,
        .ai-weakness-area,
        .ai-unique-factor {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            margin: 0.25rem 0.25rem 0.25rem 0;
        }

        .ai-strength-area {
            background: #d4edda;
            color: #155724;
        }

        .ai-weakness-area {
            background: #f8d7da;
            color: #721c24;
        }        .ai-unique-factor {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Chart Styles */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-toggle {
            padding: 0.5rem 1rem;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.2s;
        }

        .chart-toggle.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .chart-toggle:hover {
            border-color: #007bff;
        }

        .chart-canvas-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .chart-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e9ecef;
        }

        .chart-stat {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .chart-stat-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .chart-stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 1rem;
            }

            .modal-header {
                padding: 1.5rem;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .score-circle {
                width: 100px;
                height: 100px;
            }

            .score-circle::before {
                width: 80px;
                height: 80px;
            }

            .score-value {
                font-size: 1.5rem;
            }
        }

        /* Mobile responsive adjustments for header branding */
        @media (max-width: 768px) {
            .top-nav {
                padding: 0.75rem 1rem;
                border-radius: 0;
            }
            
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 32px;
                height: 32px;
            }
        }
    </style>
    <!-- GitHub Pages Fix Script -->
    <script>
        // Empty github-pages-fix.js content embedded (file was empty)
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                        <li data-feature="hr_matrix_view" data-requires-permission="hr_matrix_view"><a href="matrixhr.html" class="active">HR Matrix</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <img id="headerCompanyLogo" class="header-company-logo" src="" alt="Company Logo">
                    <div id="headerLogoPlaceholder" class="header-logo-placeholder">
                        <i class="fas fa-building"></i>
                    </div>
                    <span id="headerCompanyName" class="company-name-header">Loading...</span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <div id="userAvatarContainer" style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                                <img id="userAvatarImage" src="assets/default-avatar.png" alt="User Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: none;">
                                <div id="userAvatarInitials" style="font-size: 14px;">U</div>
                            </div>
                        </button>
                        <div class="profile-dropdown">
                            <div class="profile-header">
                                <div class="profile-avatar">
                                    <img id="dropdownUserAvatar" src="assets/default-avatar.png" alt="User Avatar" style="display: none;">
                                    <div id="dropdownUserInitials" class="avatar-initials">U</div>
                                </div>
                                <div class="profile-info">
                                    <div id="dropdownUserName" class="profile-name">User Name</div>
                                    <div id="dropdownUserEmail" class="profile-email">user@example.com</div>
                                </div>
                            </div>
                            <div class="profile-divider"></div>
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">

            <!-- HR Matrix Content -->
            <div class="matrix-container">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="header-top-row">
                        <div class="header-left">
                            <h1 class="page-title">
                                <i class="fas fa-brain"></i>
                                HR Analysis Matrix
                            </h1>
                        </div>
                    </div>
                </div>

                <!-- Job Selection Section -->
                <div class="job-selection-section">
                    <div class="job-selection-card">
                        <div class="job-selection-header">
                        </div>
                        <div class="job-selection-content">
                            <div class="job-dropdown-wrapper">
                                <label for="jobSelector" class="job-dropdown-label">
                                </label>
                                <select id="jobSelector" class="job-dropdown">
                                    <option value="">Select a job to analyze...</option>
                                    <!-- Jobs will be populated dynamically -->
                                </select>
                            </div>
                            <div class="selected-job-info" id="selectedJobInfo" style="display: none;">
                                <div class="job-info-header">
                                    <i class="fas fa-info-circle"></i>
                                    Selected Job Details
                                </div>
                                <div class="job-info-content">
                                    <div class="job-info-row">
                                        <span class="job-info-label">Position:</span>
                                        <span class="job-info-value" id="selectedJobTitle">-</span>
                                    </div>
                                    <div class="job-info-row">
                                        <span class="job-info-label">Department:</span>
                                        <span class="job-info-value" id="selectedJobDepartment">-</span>
                                    </div>
                                    <div class="job-info-row">
                                        <span class="job-info-label">Type:</span>
                                        <span class="job-info-value" id="selectedJobType">-</span>
                                    </div>
                                    <div class="job-info-row">
                                        <span class="job-info-label">Applications:</span>
                                        <span class="job-info-value" id="selectedJobApplications">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                </div>

                <!-- Matrix Tabs -->
                <div class="matrix-tabs">
                    <button class="matrix-tab active" onclick="switchTab('criteria')">
                        <i class="fas fa-list-check"></i>
                        Criteria Setup
                    </button>
                    <button class="matrix-tab" onclick="switchTab('algorithm')">
                        <i class="fas fa-calculator"></i>
                        Scoring Algorithm
                    </button>
                    <button class="matrix-tab" onclick="switchTab('preview')">
                        <i class="fas fa-chart-line"></i>
                        Preview & Test
                    </button>
                    <button class="matrix-tab" onclick="switchTab('analytics')">
                        <i class="fas fa-chart-bar"></i>
                        Analytics
                    </button>
                </div>                <!-- Criteria Setup Tab -->
                <div class="tab-content active" id="criteriaTab">                    <!-- Percentage Summary -->
                    <div class="percentage-summary" id="percentageSummary">
                        <div class="percentage-summary-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="percentage-summary-title" style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chart-pie"></i>
                                Criteria Weight Distribution
                            </h3>
                            <div class="percentage-total" id="totalPercentage" style="font-size: 1.2rem; font-weight: 600; color: #007bff;">0%</div>
                        </div>
                        <div class="percentage-progress">
                            <div class="percentage-progress-fill" id="percentageProgressFill" style="width: 0%"></div>
                        </div>
                        <p class="percentage-message" id="percentageMessage">
                            <i class="fas fa-info-circle"></i>
                            Add criteria and assign percentages. Total must equal 100%.
                        </p>
                        <div class="percentage-breakdown" id="percentageBreakdown">
                            <!-- Individual criteria percentages will appear here -->
                        </div>
                    </div>

                    <!-- Skills & Experience Criteria -->
                    <div class="criteria-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-tools"></i>
                                Skills & Experience Criteria
                            </h2>
                            <button class="btn btn-primary" onclick="addCriteria('skills')">
                                <i class="fas fa-plus"></i>
                                Add Criteria
                            </button>
                        </div>
                        <div class="criteria-grid" id="skillsCriteria">
                            <!-- Skills criteria will be populated here -->
                        </div>
                    </div>

                    <!-- Education Criteria -->
                    <div class="criteria-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-graduation-cap"></i>
                                Education Criteria
                            </h2>
                            <button class="btn btn-primary" onclick="addCriteria('education')">
                                <i class="fas fa-plus"></i>
                                Add Criteria
                            </button>
                        </div>
                        <div class="criteria-grid" id="educationCriteria">
                            <!-- Education criteria will be populated here -->
                        </div>
                    </div>

                    <!-- Personal Attributes -->
                    <div class="criteria-section">
                        <div class="section-header">
                            <h2 class="section-title">
                                <i class="fas fa-user-check"></i>
                                Personal Attributes
                            </h2>
                            <button class="btn btn-primary" onclick="addCriteria('personal')">
                                <i class="fas fa-plus"></i>
                                Add Criteria
                            </button>
                        </div>
                        <div class="criteria-grid" id="personalCriteria">
                            <!-- Personal criteria will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Algorithm Tab -->
                <div class="tab-content" id="algorithmTab">
                    <div class="algorithm-section">
                        <div class="algorithm-header">
                            <h2 class="section-title">
                                <i class="fas fa-cogs"></i>
                                Choose Scoring Algorithm
                            </h2>
                            <p style="color: #6c757d; margin: 0.5rem 0 0 0;">Select how applicant scores will be calculated and ranked</p>
                        </div>                        <div class="algorithm-grid">
                            <div class="algorithm-card selected" data-algorithm="percentage">
                                <div class="algorithm-title">
                                    <i class="fas fa-percentage"></i>
                                    Percentage Match
                                </div>
                                <div class="algorithm-description">
                                    Calculates percentage of criteria met. Shows how closely applicants match the ideal candidate profile.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Threshold Settings -->
                    <div class="threshold-section">
                        <div class="threshold-header">
                            <i class="fas fa-sliders-h"></i>
                            Score Thresholds & Classification
                        </div>
                        <div class="threshold-grid">
                            <div class="threshold-item">
                                <label class="threshold-label">Excellent Candidate (Top Tier)</label>
                                <input type="number" class="threshold-input" id="excellentThreshold" value="85" min="0" max="100">
                                <small style="color: #6c757d;">Score ≥ 85%</small>
                            </div>
                            <div class="threshold-item">
                                <label class="threshold-label">Good Candidate (Second Tier)</label>
                                <input type="number" class="threshold-input" id="goodThreshold" value="70" min="0" max="100">
                                <small style="color: #6c757d;">Score 70-84%</small>
                            </div>
                            <div class="threshold-item">
                                <label class="threshold-label">Average Candidate (Third Tier)</label>
                                <input type="number" class="threshold-input" id="averageThreshold" value="50" min="0" max="100">
                                <small style="color: #6c757d;">Score 50-69%</small>
                            </div>
                            <div class="threshold-item">
                                <label class="threshold-label">Below Standard (Reject)</label>
                                <input type="number" class="threshold-input" id="rejectThreshold" value="49" min="0" max="100" readonly>
                                <small style="color: #6c757d;">Score < 50%</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Tab -->
                <div class="tab-content" id="previewTab">
                    <div class="scoring-preview">
                        <div class="preview-header">
                            <h3 class="preview-title">
                                <i class="fas fa-eye"></i>
                                Live Scoring Preview
                            </h3>
                            <button class="btn btn-primary" onclick="refreshPreview()">
                                <i class="fas fa-refresh"></i>
                                Refresh Data
                            </button>
                        </div>                        <table class="preview-table">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Applicant</th>
                                    <th>Job Position</th>
                                    <th>Overall Score</th>
                                    <th>Classification</th>
                                    <th>Top Matching Criteria</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                                <!-- Preview data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Analytics Tab -->
                <div class="tab-content" id="analyticsTab">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-icon" style="color: #007bff;">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="analytics-number" id="totalAnalyzed">0</div>
                            <div class="analytics-label">Total Analyzed</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon" style="color: #28a745;">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="analytics-number" id="excellentCandidates">0</div>
                            <div class="analytics-label">Excellent Candidates</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon" style="color: #ffc107;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="analytics-number" id="averageScore">0%</div>
                            <div class="analytics-label">Average Score</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon" style="color: #dc3545;">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="analytics-number" id="rejectedCount">0</div>
                            <div class="analytics-label">Auto-Rejected</div>
                        </div>
                    </div>                    <!-- Detailed Analytics Charts -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                Candidate Distribution
                            </h3>
                            <div class="chart-controls">
                                <button class="chart-toggle active" onclick="switchChartType('pie')">
                                    <i class="fas fa-chart-pie"></i> Pie
                                </button>
                                <button class="chart-toggle" onclick="switchChartType('bar')">
                                    <i class="fas fa-chart-bar"></i> Bar
                                </button>
                                <button class="chart-toggle" onclick="switchChartType('doughnut')">
                                    <i class="fas fa-circle-notch"></i> Doughnut
                                </button>
                            </div>
                        </div>
                        <div class="chart-canvas-container">
                            <canvas id="candidateDistributionChart"></canvas>
                        </div>
                        <div class="chart-stats" id="chartStats">
                            <!-- Chart statistics will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="saveAsDraft()">
                        <i class="fas fa-save"></i>
                        Save as Draft
                    </button>
                    <button class="btn btn-primary" onclick="saveMatrix()">
                        <i class="fas fa-check"></i>
                        Save Matrix Configuration
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Verify Firebase Storage is properly initialized
        console.log('🔥 Firebase initialized with:');
        console.log('- Database:', !!database);
        console.log('- Auth:', !!auth);
        console.log('- Storage:', !!storage);
        console.log('- Storage Bucket:', firebaseConfig.storageBucket);

        // Centralized Authentication Manager Class
        class AuthManager {
            constructor() {
                this.currentUser = this.getCurrentUser();
                this.db = database;
                this.currentCompany = null;
                
                console.log('🔐 AuthManager initialized');
                console.log('Current user:', this.currentUser);
                
                this.initializeAuth();
            }

            initializeAuth() {
                // Skip authentication check for certain conditions or allow access without redirect
                if (window.location.pathname.includes('matrixhr.html')) {
                    console.log('Initializing Matrix HR page...');
                    
                    if (this.currentUser) {
                        console.log('✅ User authenticated successfully');
                        this.loadUserRole(this.currentUser);
                        this.loadUserCompany();
                        this.updateUIForAuthenticatedUser();
                        this.updateMenuVisibility();
                    } else {
                        console.log('⚠️ No authenticated user - continuing with limited functionality');
                        this.initializeHeaderFallback();
                    }
                } else {
                    // Standard authentication check for other pages
                    if (!this.currentUser) {
                        console.log('❌ No user authenticated, redirecting to login');
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    console.log('✅ User authenticated successfully');
                    this.loadUserRole(this.currentUser);
                    this.loadUserCompany();
                    this.updateUIForAuthenticatedUser();
                    this.updateMenuVisibility();
                }

                // Handle logout
                const logoutBtn = document.querySelector('.profile-dropdown a[href="#"]');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.logout();
                    });
                }
            }

            getCurrentUser() {
                try {
                    return JSON.parse(localStorage.getItem('currentUser') || 'null');
                } catch (error) {
                    console.error('Error parsing current user:', error);
                    return null;
                }
            }

            setCurrentUser(userData) {
                localStorage.setItem('currentUser', JSON.stringify(userData));
                localStorage.setItem('user', JSON.stringify(userData));
                this.currentUser = userData;
            }

            async logout() {
                try {
                    await auth.signOut();
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    sessionStorage.removeItem('currentUser');
                    sessionStorage.removeItem('user');
                    this.currentUser = null;
                    console.log('✅ User logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                    // Clear local data anyway
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('user');
                    sessionStorage.removeItem('currentUser');
                    sessionStorage.removeItem('user');
                }
            }

            async loadUserRole(userData) {
                // Load user role from Firebase if not available
                if (!userData.role && userData.uid) {
                    try {
                        const userRef = database.ref(`users/${userData.uid}`);
                        const userSnapshot = await userRef.once('value');
                        if (userSnapshot.exists()) {
                            const userRole = userSnapshot.val().role || 'user';
                            userData.role = userRole;
                            this.setCurrentUser(userData);
                        }
                    } catch (error) {
                        console.error('Error loading user role:', error);
                    }
                }
                
                // Initialize RoleManager if available and user has company
                if (this.roleManager && userData.companyId && userData.uid) {
                    try {
                        await this.roleManager.loadUserRole(userData.uid, userData.companyId);
                        console.log('✅ RoleManager initialized for user');
                    } catch (error) {
                        console.error('Error initializing RoleManager:', error);
                    }
                }
            }

            async loadUserCompany() {
                if (!this.currentUser) return;

                try {
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        let foundCompany = null;
                        
                        // Search through all companies for user
                        for (const [companyId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            // Check in company users
                            if (company.users) {
                                for (const [userId, user] of Object.entries(company.users)) {
                                    if (user.authUid === this.currentUser.uid || userId === this.currentUser.uid) {
                                        foundCompany = company;
                                        this.currentUser.companyId = companyId;
                                        this.currentUser.companyName = company.companyName;
                                        break;
                                    }
                                }
                            }
                            
                            if (foundCompany) break;
                        }
                        
                        if (foundCompany) {
                            this.currentCompany = foundCompany;
                            this.userCompanyId = this.currentUser.companyId;
                            this.updateCompanyBranding();
                            
                            // Initialize RoleManager after company is loaded
                            if (this.roleManager && this.currentUser.uid) {
                                try {
                                    await this.roleManager.loadUserRole(this.currentUser.uid, this.currentUser.companyId);
                                    console.log('✅ RoleManager initialized after company loading');
                                } catch (error) {
                                    console.error('Error initializing RoleManager after company loading:', error);
                                }
                            }
                            
                            // Trigger job loading for matrix after company context is available
                            if (window.loadJobsFromFirebase && typeof window.loadJobsFromFirebase === 'function') {
                                console.log('🎯 Triggering job reload after company loading');
                                setTimeout(() => {
                                    window.loadJobsFromFirebase();
                                }, 500);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading user company:', error);
                }
            }

            updateCompanyBranding() {
                console.log('🏢 Updating company branding in header...');
                
                // Update header logo and name
                const headerLogo = document.getElementById('headerCompanyLogo');
                const headerLogoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const companyNameHeader = document.getElementById('headerCompanyName');

                // Get company name from various sources
                const companyName = this.currentCompany?.companyName || 
                                  this.currentUser?.companyName || 
                                  'Dreamex Datalab HSE';

                // Update company logo
                if (this.currentCompany && this.currentCompany.logo && headerLogo) {
                    headerLogo.src = this.currentCompany.logo;
                    headerLogo.classList.add('visible');
                    headerLogo.style.display = 'block';
                    if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'none';
                    
                    headerLogo.onerror = function() {
                        console.log('❌ Company logo failed to load, showing placeholder');
                        headerLogo.style.display = 'none';
                        headerLogo.classList.remove('visible');
                        if (headerLogoPlaceholder) headerLogoPlaceholder.style.display = 'flex';
                    };
                    
                    console.log('✅ Company logo displayed in header');
                } else {
                    // Show placeholder when no logo is available
                    if (headerLogoPlaceholder) {
                        headerLogoPlaceholder.style.display = 'flex';
                    }
                    if (headerLogo) {
                        headerLogo.classList.remove('visible');
                        headerLogo.style.display = 'none';
                    }
                    console.log('✅ Company logo placeholder displayed in header');
                }

                // Update company name
                if (companyNameHeader) {
                    companyNameHeader.textContent = companyName;
                    companyNameHeader.style.display = 'inline-block';
                    console.log('✅ Company name updated in header:', companyName);
                }

                // Update page title if needed
                const title = document.title;
                if (title.includes('Dreamex Datalab HSE')) {
                    document.title = title.replace('Dreamex Datalab HSE', `${companyName} HSE`);
                }

                // Apply company branding colors if available
                if (this.currentCompany && this.currentCompany.branding) {
                    const root = document.documentElement;
                    if (this.currentCompany.branding.primaryColor) {
                        root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor);
                    }
                    if (this.currentCompany.branding.secondaryColor) {
                        root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor);
                    }
                }
                
                console.log('🏢 Company branding update completed');
            }

            async updateUIForAuthenticatedUser() {
                const userAvatarImage = document.getElementById('userAvatarImage');
                const userAvatarInitials = document.getElementById('userAvatarInitials');
                
                if (this.currentUser) {
                    // Show loading state (optional: add a small loading indicator)
                    console.log('🖼️ Loading user avatar...');
                    
                    // Load user company context first
                    await this.loadUserCompany();
                    
                    // Get user avatar URL with error handling
                    try {
                        const avatarUrl = await this.getUserAvatarUrl();
                        
                        if (avatarUrl && userAvatarImage) {
                            // Test if the image loads successfully
                            const img = new Image();
                            img.onload = () => {
                                userAvatarImage.src = avatarUrl;
                                userAvatarImage.style.display = 'block';
                                if (userAvatarInitials) userAvatarInitials.style.display = 'none';
                                console.log('✅ Profile picture loaded successfully');
                            };
                            img.onerror = () => {
                                console.log('❌ Failed to load profile picture, showing initials');
                                this.showUserInitials(userAvatarInitials, userAvatarImage);
                            };
                            img.src = avatarUrl;
                        } else if (userAvatarInitials) {
                            // No avatar found, show initials
                            console.log('📝 No profile picture found, showing initials');
                            this.showUserInitials(userAvatarInitials, userAvatarImage);
                        }
                    } catch (error) {
                        console.log('⚠️ Error loading avatar:', error);
                        if (userAvatarInitials) {
                            this.showUserInitials(userAvatarInitials, userAvatarImage);
                        }
                    }
                    
                    // Update profile dropdown with user information
                    this.updateProfileDropdown();
                    
                    // Update menu visibility based on user permissions
                    await this.updateMenuVisibility();
                }
            }

            // Helper method to show user initials
            showUserInitials(userAvatarInitials, userAvatarImage) {
                if (!userAvatarInitials) return;
                
                const name = this.getUserDisplayName();
                const initials = this.getUserInitials();
                userAvatarInitials.textContent = initials;
                if (userAvatarImage) userAvatarImage.style.display = 'none';
                userAvatarInitials.style.display = 'block';
            }

            // Initialize header with fallback values when no user is authenticated
            initializeHeaderFallback() {
                const companyNameHeader = document.getElementById('headerCompanyName');
                const logoPlaceholder = document.getElementById('headerLogoPlaceholder');
                const headerLogo = document.getElementById('headerCompanyLogo');
                
                // Show default company name
                if (companyNameHeader && companyNameHeader.textContent === 'Loading...') {
                    setTimeout(() => {
                        if (companyNameHeader.textContent === 'Loading...') {
                            companyNameHeader.textContent = 'Dreamex Datalab HSE';
                            companyNameHeader.style.display = 'inline-block';
                        }
                    }, 2000);
                }
                
                // Show logo placeholder
                if (logoPlaceholder && headerLogo) {
                    setTimeout(() => {
                        if (!headerLogo.classList.contains('visible')) {
                            logoPlaceholder.style.display = 'flex';
                        }
                    }, 2000);
                }
            }

            async updateMenuVisibility() {
                console.log('🔧 Starting menu visibility update...');
                
                // Remove loading class
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('menu-loading');
                }
                
                try {
                    if (!this.currentUser) {
                        console.log('❌ No authenticated user found');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    // Initialize roleManager if connected and not loaded
                    if (this.roleManager && !this.roleManager.currentRole) {
                        await this.roleManager.loadUserRole(this.currentUser.uid, this.userCompanyId);
                    }
                    
                    if (!this.roleManager || !this.roleManager.currentRole) {
                        console.log('❌ Role manager not ready or role not loaded');
                        this.resetMenuVisibility();
                        return;
                    }
                    
                    console.log(`👤 User: role=${this.roleManager.currentRole}, companyId=${this.userCompanyId}`);
                    
                    // Update menu visibility based on RoleManager permissions
                    this.updateMenuWithRoleManager();
                    
                } catch (error) {
                    console.error('❌ Error updating menu visibility:', error);
                    this.resetMenuVisibility();
                }
            }

            resetMenuVisibility() {
                // Hide all menu items with data-feature attributes
                document.querySelectorAll('[data-feature]').forEach(item => {
                    item.classList.remove('menu-visible');
                    item.style.display = 'none';
                });
                
                // Hide all dropdown containers
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('menu-visible');
                    dropdown.style.display = 'none';
                });
                
                console.log('🔄 Menu visibility reset - all items hidden');
            }

            updateMenuWithRoleManager() {
                console.log('🎯 Updating menu with RoleManager permissions...');
                
                // Reset menu visibility first
                this.resetMenuVisibility();
                
                if (!this.roleManager) {
                    console.log('⚠️ No RoleManager available');
                    return;
                }
                
                let visibleCount = 0;
                
                // Handle all menu items with data-feature attributes (this is the proper way matching roles.html)
                const menuItems = document.querySelectorAll('[data-feature]');
                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const isDropdownContainer = item.classList.contains('menu-dropdown');
                    
                    // Skip dropdown containers - they will be handled separately
                    if (isDropdownContainer) {
                        return;
                    }
                    
                    // Check if user has permission for this feature
                    if (feature && this.roleManager.hasPermission(feature, 'view')) {
                        item.classList.add('menu-visible');
                        item.style.display = '';
                        visibleCount++;
                        console.log(`✅ Showing menu item: ${feature}`);
                    } else {
                        item.classList.remove('menu-visible');
                        item.style.display = 'none';
                        console.log(`❌ Hiding menu item: ${feature} - no permission`);
                    }
                });
                
                // Handle parent dropdowns - show only if they have visible children
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    const feature = dropdown.getAttribute('data-feature');
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    const hasVisibleChildren = visibleSubmenuItems.length > 0;
                    
                    // Check if the dropdown itself has permissions or if it has visible children
                    const hasDropdownPermission = feature ? this.roleManager.hasPermission(feature, 'view') : false;
                    
                    if (hasDropdownPermission || hasVisibleChildren) {
                        dropdown.classList.add('menu-visible');
                        dropdown.style.display = '';
                        console.log(`✅ Showing dropdown: ${feature} (permission: ${hasDropdownPermission}, children: ${hasVisibleChildren})`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        dropdown.style.display = 'none';
                        console.log(`❌ Hiding dropdown: ${feature} - no permission and no visible children`);
                    }
                });
                
                console.log(`🎯 Menu visibility update completed with RoleManager - ${visibleCount} items visible`);
            }

            updateMenuWithPermissions(permissions) {
                console.log('🎯 Updating menu with permissions...');
                
                // Reset menu visibility first
                this.resetMenuVisibility();
                
                if (!permissions) {
                    console.log('⚠️ No permissions object provided');
                    return;
                }
                
                // Update menu visibility based on permissions
                const menuItems = document.querySelectorAll('[data-feature]');
                let visibleCount = 0;
                
                menuItems.forEach(item => {
                    const feature = item.getAttribute('data-feature');
                    const isDropdownContainer = item.classList.contains('menu-dropdown');
                    
                    // Skip dropdown containers - they will be handled separately
                    if (isDropdownContainer) {
                        return;
                    }
                    
                    // Check if user has permission for this feature
                    if (feature && permissions[feature]) {
                        const hasViewPermission = permissions[feature].view === true || permissions[feature] === true;
                        if (hasViewPermission) {
                            item.classList.add('menu-visible');
                            visibleCount++;
                            console.log(`✅ Showing menu item: ${feature}`);
                        }
                    }
                });
                
                // Handle parent dropdowns - show only if they have visible children
                document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                    const visibleSubmenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
                    const hasVisibleChildren = visibleSubmenuItems.length > 0;
                    
                    if (hasVisibleChildren) {
                        dropdown.classList.add('menu-visible');
                    }
                });
                
                console.log(`🎯 Menu visibility update completed - ${visibleCount} items visible`);
            }

            // Get user display name
            getUserDisplayName() {
                if (!this.currentUser) return 'User';
                
                const cleanName = (name) => {
                    if (!name || typeof name !== 'string') return '';
                    return name.trim().replace(/\s+/g, ' ');
                };
                
                const potentialNames = [
                    this.currentUser.displayName,
                    this.currentUser.name,
                    this.currentUser.username
                ];
                
                for (const name of potentialNames) {
                    const cleaned = cleanName(name);
                    if (cleaned) return cleaned;
                }
                
                if (this.currentUser.email) {
                    const emailUsername = this.currentUser.email.split('@')[0];
                    const cleaned = cleanName(emailUsername);
                    if (cleaned) return cleaned;
                }
                
                return 'User';
            }

            // Get user initials for avatar display
            getUserInitials() {
                const displayName = this.getUserDisplayName();
                
                if (!displayName || displayName === 'User') return 'U';
                
                const words = displayName.split(' ').filter(word => word.length > 0);
                if (words.length === 1) {
                    return words[0].substring(0, 2).toUpperCase();
                } else {
                    return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
                }
            }

            // Get user email
            getUserEmail() {
                return this.currentUser?.email || '';
            }

            // Get user avatar URL
            async getUserAvatarUrl() {
                if (!this.currentUser) return null;
                
                try {
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    // Try alternative path formats for backward compatibility
                    try {
                        const storage = firebase.storage();
                        const alternativePaths = [
                            `avatars/${this.currentUser.uid}/avatar.jpg`,
                            `avatars/${this.currentUser.uid}/profile.png`,
                            `avatars/${this.currentUser.uid}/avatar.png`,
                            `user-avatars/${this.currentUser.uid}.jpg`,
                            `user-avatars/${this.currentUser.uid}.png`
                        ];
                        
                        for (const altPath of alternativePaths) {
                            try {
                                const altRef = storage.ref(altPath);
                                return await altRef.getDownloadURL();
                            } catch (altError) {
                                // Continue to next path
                                continue;
                            }
                        }
                    } catch (fallbackError) {
                        console.log('No custom avatar found, using initials');
                    }
                    
                    // No custom avatar found
                    return null;
                }
            }

            // Upload user avatar (for future functionality)
            async uploadUserAvatar(file) {
                if (!this.currentUser) {
                    throw new Error('User not authenticated');
                }
                
                try {
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    // Upload the file
                    const snapshot = await avatarRef.put(file);
                    
                    // Get the download URL
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    
                    // Update the avatar display
                    await this.updateUIForAuthenticatedUser();
                    
                    return downloadURL;
                } catch (error) {
                    console.error('Error uploading avatar:', error);
                    throw error;
                }
            }

            // Delete user avatar
            async deleteUserAvatar() {
                if (!this.currentUser) {
                    throw new Error('User not authenticated');
                }
                
                try {
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${this.currentUser.uid}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    
                    await avatarRef.delete();
                    
                    // Update the avatar display
                    await this.updateUIForAuthenticatedUser();
                    
                    return true;
                } catch (error) {
                    console.error('Error deleting avatar:', error);
                    return false;
                }
            }

            // Update profile dropdown with authenticated user information
            async updateProfileDropdown() {
                const dropdownUserAvatar = document.getElementById('dropdownUserAvatar');
                const dropdownUserInitials = document.getElementById('dropdownUserInitials');
                const dropdownUserName = document.getElementById('dropdownUserName');
                const dropdownUserEmail = document.getElementById('dropdownUserEmail');

                if (!this.currentUser) return;

                // Update user name
                if (dropdownUserName) {
                    const displayName = this.getUserDisplayName();
                    dropdownUserName.textContent = displayName;
                }

                // Update user email
                if (dropdownUserEmail) {
                    const email = this.getUserEmail();
                    dropdownUserEmail.textContent = email;
                }

                // Update avatar in dropdown with enhanced loading
                try {
                    const avatarUrl = await this.getUserAvatarUrl();
                    if (avatarUrl && dropdownUserAvatar) {
                        // Test image loading for dropdown avatar as well
                        const img = new Image();
                        img.onload = () => {
                            dropdownUserAvatar.src = avatarUrl;
                            dropdownUserAvatar.style.display = 'block';
                            if (dropdownUserInitials) dropdownUserInitials.style.display = 'none';
                        };
                        img.onerror = () => {
                            // Fallback to initials for dropdown
                            this.showDropdownInitials(dropdownUserInitials, dropdownUserAvatar);
                        };
                        img.src = avatarUrl;
                    } else if (dropdownUserInitials) {
                        // No avatar found, show initials
                        this.showDropdownInitials(dropdownUserInitials, dropdownUserAvatar);
                    }
                } catch (error) {
                    console.log('⚠️ Error loading dropdown avatar:', error);
                    if (dropdownUserInitials) {
                        this.showDropdownInitials(dropdownUserInitials, dropdownUserAvatar);
                    }
                }
            }

            // Helper method to show initials in dropdown
            showDropdownInitials(dropdownUserInitials, dropdownUserAvatar) {
                if (!dropdownUserInitials) return;
                
                const initials = this.getUserInitials();
                dropdownUserInitials.textContent = initials;
                if (dropdownUserAvatar) dropdownUserAvatar.style.display = 'none';
                dropdownUserInitials.style.display = 'flex';
            }
        }

        // RoleManager class for permission management
        class RoleManager {
            constructor() {
                this.db = database;
                this.roles = [];
                this.currentRole = null;
                this.standardPermissions = ['view', 'create', 'edit', 'delete', 'export'];
                this.features = {
                    home_view: { name: 'Home', actions: ['view'] },
                    health_view: { name: 'Health', actions: this.standardPermissions },
                    health_assessment_view: { name: 'Health Assessment', actions: this.standardPermissions },
                    health_consultation_view: { name: 'Health Consultation', actions: this.standardPermissions },
                    medical_folder_view: { name: 'Medical Folder', actions: this.standardPermissions },
                    safety_view: { name: 'Safety', actions: this.standardPermissions },
                    training_view: { name: 'Training', actions: this.standardPermissions },
                    risk_view: { name: 'Risk Management', actions: this.standardPermissions },
                    jsa_view: { name: 'Job Safety Analysis', actions: this.standardPermissions },
                    ptw_view: { name: 'Permit to Work', actions: this.standardPermissions },
                    incident_view: { name: 'Incident Reports', actions: this.standardPermissions },
                    inspection_view: { name: 'Inspection', actions: this.standardPermissions },
                    audit_view: { name: 'Audit', actions: this.standardPermissions },
                    audit_log_view: { name: 'Audit Log', actions: ['view', 'export'] },
                    environment_view: { name: 'Environment', actions: this.standardPermissions },
                    water_view: { name: 'Water Quality', actions: this.standardPermissions },
                    security_view: { name: 'Security', actions: this.standardPermissions },
                    access_view: { name: 'Access Request', actions: this.standardPermissions },
                    removal_view: { name: 'Property Removal', actions: this.standardPermissions },
                    logistics_view: { name: 'Logistics', actions: this.standardPermissions },
                    fleet_view: { name: 'Fleet Management', actions: this.standardPermissions },
                    lms_view: { name: 'Learning Management System', actions: this.standardPermissions },
                    // HR Management Features
                    hr_view: { name: 'HR Management', actions: ['view'] },
                    staff_management_view: { name: 'Staff Management', actions: [...this.standardPermissions, 'approve', 'import'] },
                    authority_to_recruit_view: { name: 'Authority to Recruit', actions: this.standardPermissions },
                    job_advertising_view: { name: 'Job Advertising', actions: this.standardPermissions },
                    screening_view: { name: 'Screening', actions: this.standardPermissions },
                    interview_view: { name: 'Interview', actions: this.standardPermissions },
                    hiring_view: { name: 'Hiring Management', actions: ['view'] },
                    offer_view: { name: 'Offer Management', actions: this.standardPermissions },
                    contract_view: { name: 'Contract Management', actions: this.standardPermissions },
                    onboarding_view: { name: 'Onboarding', actions: this.standardPermissions },
                    kpi_view: { name: 'KPI Management', actions: ['view'] },
                    kpi_create_view: { name: 'Create KPI', actions: this.standardPermissions },
                    kpi_dashboard_view: { name: 'KPI Dashboard', actions: this.standardPermissions },
                    // Matrix HR specific features
                    matrixhr_view: { name: 'HR Matrix Analysis', actions: ['view'] },
                    settings_view: { name: 'Settings', actions: ['view'] },
                    account_settings_view: { name: 'Account Settings', actions: ['view', 'edit'] },
                    company_management_view: { name: 'Company Management', actions: this.standardPermissions },
                    approval_settings_view: { name: 'Approval Flow Settings', actions: ['view', 'edit'] },
                    field_setup_view: { name: 'Field Setup', actions: ['view', 'create', 'edit', 'delete', 'import', 'export'] },
                    preferences_view: { name: 'Preferences', actions: ['view', 'edit'] },
                    notification_settings_view: { name: 'Notification Settings', actions: ['view', 'edit'] },
                    user_management_view: { name: 'User Management', actions: this.standardPermissions },
                    role_permissions_view: { name: 'Role Permissions', actions: this.standardPermissions }
                };
                
                console.log('🎯 RoleManager initialized for Matrix HR page');
            }

            async loadUserRole(userId, companyId) {
                if (!userId || !companyId) {
                    console.log('❌ Missing userId or companyId for RoleManager');
                    return null;
                }
                
                try {
                    console.log(`🔍 Loading user role for userId: ${userId}, companyId: ${companyId}`);
                    
                    // First get the user's role from the users collection
                    const userRef = database.ref(`users/${userId}`);
                    const userSnapshot = await userRef.once('value');
                    
                    if (!userSnapshot.exists()) {
                        console.log(`❌ User ${userId} not found in database`);
                        return null;
                    }
                    
                    const userData = userSnapshot.val();
                    const userRole = userData.role;
                    
                    if (!userRole) {
                        console.log(`❌ No role found for user ${userId}`);
                        return null;
                    }
                    
                    console.log(`👤 User role found: ${userRole}`);
                    
                    // Now get the role permissions from the company
                    const roleRef = database.ref(`companies/${companyId}/roles/${userRole}`);
                    const roleSnapshot = await roleRef.once('value');
                    
                    if (roleSnapshot.exists()) {
                        this.currentRole = {
                            name: userRole,
                            permissions: roleSnapshot.val().permissions || {},
                            ...roleSnapshot.val()
                        };
                        
                        console.log('✅ Role permissions loaded:', {
                            role: this.currentRole.name,
                            permissionCount: Object.keys(this.currentRole.permissions).length,
                            permissions: this.currentRole.permissions
                        });
                        
                        return this.currentRole;
                    } else {
                        console.log(`❌ Role ${userRole} not found in company ${companyId}`);
                        return null;
                    }
                } catch (error) {
                    console.error('❌ Error loading user role:', error);
                    return null;
                }
            }

            hasPermission(feature, action) {
                if (!this.currentRole || !this.currentRole.permissions) {
                    console.log(`❌ No role or permissions available for ${feature}.${action}`);
                    return false;
                }
                
                // Check if the feature exists in the role's permissions
                const featurePermissions = this.currentRole.permissions[feature];
                if (!featurePermissions) {
                    console.log(`❌ Feature ${feature} not found in permissions`);
                    return false;
                }

                // Check if the action is allowed for this feature
                const hasAccess = featurePermissions[action] === true;
                console.log(`🔍 Permission check: ${feature}.${action} = ${hasAccess}`);
                return hasAccess;
            }

            getCurrentRole() {
                return this.currentRole;
            }

            // Set role and permissions for the current user
            setRole(roleData) {
                this.currentRole = roleData;
                console.log('🎯 Role set:', this.currentRole);
            }
        }

        // Firebase utility functions (adapted from firebase-config.js)
        const loginWithEmail = async (email, password) => {
            try {
                const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Get user role and other data from the database
                return new Promise((resolve, reject) => {
                    firebase.database().ref(`users/${user.uid}`).once('value', (snapshot) => {
                        const userData = snapshot.val() || {};
                        resolve({
                            uid: user.uid,
                            email: user.email,
                            role: userData.role || 'standard',
                            name: userData.name || user.email.split('@')[0],
                            department: userData.department || 'Unknown'
                        });
                    });
                });
            } catch (error) {
                throw error;
            }
        };

        const logoutUser = async () => {
            try {
                await firebase.auth().signOut();
                return true;
            } catch (error) {
                console.error('Logout error:', error);
                return false;
            }
        };

        const resetPassword = async (email) => {
            try {
                await firebase.auth().sendPasswordResetEmail(email);
                return { success: true };
            } catch (error) {
                console.error('Password reset error:', error);
                return { success: false, error: error.code };
            }
        };

        // Initialize centralized authentication manager
        let authManager;
        let roleManager;
        
        // Initialize AuthManager after Firebase is ready
        if (firebase.apps.length > 0) {
            authManager = new AuthManager();
            roleManager = new RoleManager();
            
            window.authManager = authManager;
            window.roleManager = roleManager;
            
            // Connect roleManager to authManager
            authManager.roleManager = roleManager;
            
            // Make authentication utilities globally available
            window.getCurrentUser = () => authManager.currentUser;
            window.getUserDisplayName = () => authManager.getUserDisplayName();
            window.getUserRole = () => authManager.currentUser?.role || 'Guest';
            window.getCompanyInfo = () => ({
                id: authManager.currentUser?.companyId,
                name: authManager.currentUser?.companyName || authManager.currentCompany?.companyName
            });

            // Make Firebase Storage utilities globally available
            window.checkStorageConnection = async () => {
                try {
                    const storage = firebase.storage();
                    const testRef = storage.ref('test-connection');
                    await testRef.getMetadata();
                    return true;
                } catch (error) {
                    console.log('Storage connection test (expected for new buckets):', error.code);
                    return error.code !== 'storage/object-not-found'; // This error is expected for test
                }
            };

            window.getUserAvatar = async (userId = null) => {
                const targetUserId = userId || authManager.currentUser?.uid;
                if (!targetUserId) return null;
                
                try {
                    const storage = firebase.storage();
                    const avatarPath = `avatars/${targetUserId}/profile.jpg`;
                    const avatarRef = storage.ref(avatarPath);
                    return await avatarRef.getDownloadURL();
                } catch (error) {
                    return null;
                }
            };
            
            console.log('🔐 Centralized AuthManager initialized and available globally');
            
            // Make job loading function globally available for matrix page
            if (window.location.pathname.includes('matrixhr.html')) {
                window.loadJobsFromFirebase = loadJobsFromFirebase;
                console.log('🎯 Matrix HR job loading function made globally available');
            }
        }

        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sidebar dropdowns
            initializeSidebar();
            
            // Initialize notifications
            initializeNotifications();
            
            // Initialize user profile dropdown with a small delay to ensure DOM is ready
            setTimeout(() => {
                initializeUserProfile();
            }, 100);
            
            // Initialize matrix functionality
            setTimeout(() => {
                initializeMatrix();
            }, 200);
        });

        // Initialize sidebar dropdown functionality
        function initializeSidebar() {
            const menuDropdowns = document.querySelectorAll('.menu-dropdown');
            
            menuDropdowns.forEach(dropdown => {
                const link = dropdown.querySelector('a');
                const submenu = dropdown.querySelector('.submenu');
                
                if (link && submenu) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Close other dropdowns
                        menuDropdowns.forEach(otherDropdown => {
                            if (otherDropdown !== dropdown) {
                                otherDropdown.classList.remove('active');
                            }
                        });
                        
                        // Toggle current dropdown
                        dropdown.classList.toggle('active');
                    });
                }
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.menu-dropdown')) {
                    menuDropdowns.forEach(dropdown => {
                        dropdown.classList.remove('active');
                    });
                }
            });
        }

        // Initialize notifications
        function initializeNotifications() {
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.querySelector('.notification-dropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationDropdown.classList.toggle('show');
                });
                
                // Close when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.notifications')) {
                        notificationDropdown.classList.remove('show');
                    }
                });
            }
        }

        // Initialize user profile dropdown
        function initializeUserProfile() {
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                    console.log('🔽 Profile dropdown toggled:', profileDropdown.classList.contains('show'));
                });
                
                // Close when clicking outside
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.user-profile')) {
                        profileDropdown.classList.remove('show');
                    }
                });
            } else {
                console.warn('⚠️ Profile dropdown elements not found:', {
                    userProfileBtn: !!userProfileBtn,
                    profileDropdown: !!profileDropdown
                });
            }
            
            // Logout functionality
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handleLogout();
                });
            }
        }

        // Handle logout
        function handleLogout() {
            if (window.authManager) {
                window.authManager.logout();
            } else {
                // Fallback logout
                if (confirm('Are you sure you want to logout?')) {
                    auth.signOut().then(() => {
                        // Clear any stored authentication data
                        localStorage.removeItem('userToken');
                        localStorage.removeItem('userData');
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('user');
                        sessionStorage.clear();
                        
                        // User logged out successfully
                        console.log('User logged out successfully');
                    }).catch((error) => {
                        console.error('Logout error:', error);
                        // Fallback: clear local data anyway
                        localStorage.removeItem('userToken');
                        localStorage.removeItem('userData');
                        localStorage.removeItem('currentUser');
                        localStorage.removeItem('user');
                        sessionStorage.clear();
                    });
                }
            }
        }

        // Initialize matrix functionality
        function initializeMatrix() {
            console.log('🎯 Initializing matrix functionality...');
            
            // Wait for AuthManager to be ready and load jobs
            if (window.authManager && window.authManager.currentUser) {
                console.log('✅ AuthManager ready, loading jobs immediately');
                loadJobsFromFirebase();
            } else {
                console.log('⏳ Waiting for AuthManager to be ready...');
                // Wait for AuthManager to initialize and load user data
                setTimeout(() => {
                    if (window.authManager && window.authManager.currentUser) {
                        console.log('✅ AuthManager ready after delay, loading jobs');
                        loadJobsFromFirebase();
                    } else {
                        console.log('⚠️ AuthManager still not ready, retrying...');
                        // Retry loading jobs with a longer delay
                        setTimeout(loadJobsFromFirebase, 2000);
                    }
                }, 1000);
            }
            
            // Initialize other matrix components
            setupEventListeners();
            
            // Initialize default criteria first (will be loaded per job when selected)
            initializeDefaultCriteria();
            
            // Initialize percentage summary after a short delay to ensure DOM is ready
            setTimeout(() => {
                updatePercentageSummary();
            }, 800);
        }        // Global variables
        let matrixConfig = {
            criteria: {
                skills: [],
                education: [],
                personal: []
            },
            algorithm: 'percentage',
            thresholds: {
                excellent: 85,
                good: 70,
                average: 50
            }
        };

        let selectedJobId = null;
        let availableJobs = [];
        let lastAnalyzedApplications = []; // Store last analyzed applications for detailed view

        // Setup event listeners
        function setupEventListeners() {
            // Algorithm selection
            document.querySelectorAll('.algorithm-card').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.algorithm-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    matrixConfig.algorithm = this.dataset.algorithm;
                });            });

            // Threshold inputs
            ['excellent', 'good', 'average'].forEach(threshold => {
                const input = document.getElementById(`${threshold}Threshold`);
                if (input) {
                    input.addEventListener('change', function() {
                        matrixConfig.thresholds[threshold] = parseInt(this.value);
                        updateRejectThreshold();
                    });
                }
            });

            // Job selector
            const jobSelector = document.getElementById('jobSelector');
            if (jobSelector) {
                jobSelector.addEventListener('change', function() {
                    handleJobSelection(this.value);
                });
            }
        }

        // Switch between tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.matrix-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}Tab`).classList.add('active');

            // Load specific tab data
            if (tabName === 'preview') {
                refreshPreview();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }        }        // Load jobs from Firebase
        function loadJobsFromFirebase() {
            console.log('Loading jobs from Firebase...');
            
            // Get company ID from AuthManager
            const companyInfo = window.getCompanyInfo ? window.getCompanyInfo() : null;
            const currentCompanyId = companyInfo?.id || window.authManager?.currentUser?.companyId || window.authManager?.userCompanyId;
            
            if (!currentCompanyId) {
                console.log('Company ID not available yet, retrying...');
                setTimeout(loadJobsFromFirebase, 1000);
                return;
            }
            
            console.log(`🏢 Loading jobs for company: ${currentCompanyId}`);
            
            // Load both active jobs and closed jobs
            const activeJobsRef = database.ref(`companies/${currentCompanyId}/jobs`);
            const closedJobsRef = database.ref(`companies/${currentCompanyId}/jobclosed`);
            
            Promise.all([
                activeJobsRef.once('value'),
                closedJobsRef.once('value')
            ]).then(([activeSnapshot, closedSnapshot]) => {
                try {
                    const activeJobsData = activeSnapshot.val();
                    const closedJobsData = closedSnapshot.val();
                    availableJobs = [];
                    
                    console.log('Raw active jobs data from Firebase:', activeJobsData);
                    console.log('Raw closed jobs data from Firebase:', closedJobsData);
                    
                    // Process active jobs
                    if (activeJobsData) {
                        Object.entries(activeJobsData).forEach(([jobId, job]) => {
                            console.log('Processing active job:', jobId, job);
                            // Include all jobs (active, published, and draft) for matrix analysis
                            if (job && typeof job === 'object') {
                                // Count applications for this job
                                const applicationCount = job.applications ? Object.keys(job.applications).length : (job.applicationCount || 0);
                                
                                availableJobs.push({
                                    id: jobId,
                                    title: job.jobTitle || job.title || job.position || 'Untitled Job',
                                    department: job.department || 'N/A',
                                    employmentType: job.employmentType || job.jobType || 'Full-time',
                                    applicationCount: applicationCount,
                                    datePosted: job.datePosted || job.postedDate || job.createdAt,
                                    status: job.status || 'draft',
                                    source: 'active'
                                });
                            }
                        });
                    }
                    
                    // Process closed jobs
                    if (closedJobsData) {
                        Object.entries(closedJobsData).forEach(([jobId, job]) => {
                            console.log('Processing closed job:', jobId, job);
                            if (job && typeof job === 'object') {
                                // Count applications for this job
                                const applicationCount = job.applications ? Object.keys(job.applications).length : (job.applicationCount || 0);
                                
                                availableJobs.push({
                                    id: jobId,
                                    title: job.jobTitle || job.title || job.position || 'Untitled Job',
                                    department: job.department || 'N/A',
                                    employmentType: job.employmentType || job.jobType || 'Full-time',
                                    applicationCount: applicationCount,
                                    datePosted: job.datePosted || job.postedDate || job.createdAt,
                                    dateClosed: job.dateClosed || job.closedDate,
                                    status: 'closed',
                                    source: 'closed',
                                    closureReason: job.closureReason || 'Position filled'
                                });
                            }
                        });
                    }
                    
                    populateJobDropdown();
                    console.log('Loaded jobs for matrix:', availableJobs.length, availableJobs);
                } catch (error) {
                    console.error('Error loading jobs:', error);
                    showJobLoadError();
                }
            }).catch((error) => {
                console.error('Firebase error loading jobs:', error);
                showJobLoadError();
            });
        }        // Populate job dropdown
        function populateJobDropdown() {
            const jobSelector = document.getElementById('jobSelector');
            console.log('🔄 Populating job dropdown, element found:', !!jobSelector);
            console.log('📊 Available jobs to populate:', availableJobs);
              if (!jobSelector) {
                console.error('❌ Job selector element not found! Retrying in 1 second...');
                // Retry after DOM is fully loaded
                setTimeout(() => {
                    populateJobDropdown();
                }, 1000);
                return;
            }
            
            // Clear existing options except the first one
            jobSelector.innerHTML = '<option value="">Select a job to analyze...</option>';
              if (availableJobs.length === 0) {
                const companyInfo = window.getCompanyInfo ? window.getCompanyInfo() : null;
                const companyName = companyInfo?.name || 'this company';
                jobSelector.innerHTML = `<option value="">No jobs found for ${companyName}</option>`;
                console.log('📭 No jobs available to populate dropdown for company:', companyName);
                return;
            }
            
            // Sort jobs by date posted (newest first), then by status (active first, then closed)
            availableJobs.sort((a, b) => {
                // First sort by status - active jobs first
                if (a.status === 'closed' && b.status !== 'closed') return 1;
                if (a.status !== 'closed' && b.status === 'closed') return -1;
                
                // Then sort by date posted (newest first)
                const dateA = new Date(a.datePosted || 0);
                const dateB = new Date(b.datePosted || 0);
                return dateB - dateA;
            });
            
            // Add job options with enhanced display for closed jobs
            availableJobs.forEach(job => {
                const option = document.createElement('option');
                option.value = job.id;
                
                let statusText = '';
                let jobTitle = `${job.title} - ${job.department} (${job.applicationCount} applications)`;
                
                if (job.status === 'closed') {
                    statusText = ' [CLOSED]';
                    // Add closure information if available
                    if (job.dateClosed) {
                        const closedDate = new Date(job.dateClosed).toLocaleDateString();
                        statusText += ` - Closed: ${closedDate}`;
                    }
                    if (job.closureReason) {
                        statusText += ` - ${job.closureReason}`;
                    }
                } else if (job.status && job.status !== 'active' && job.status !== 'published') {
                    statusText = ` [${job.status.toUpperCase()}]`;
                }
                
                option.textContent = jobTitle + statusText;
                
                // Add visual styling for closed jobs
                if (job.status === 'closed') {
                    option.style.color = '#6c757d';
                    option.style.fontStyle = 'italic';
                }
                
                jobSelector.appendChild(option);
                console.log(`📝 Added job option: ${job.title} - Department: ${job.department} - Status: ${job.status} - Applications: ${job.applicationCount} - Source: ${job.source || 'active'}`);
            });
            
            console.log(`✅ Dropdown populated with ${availableJobs.length} jobs from company scope (including closed jobs)`);
        }// Handle job selection
        function handleJobSelection(jobId) {
            selectedJobId = jobId;
            const jobNotice = document.getElementById('jobNotice');
            
            if (!jobId) {
                if (jobNotice) {
                    jobNotice.classList.remove('hidden');
                }
                // Update stat cards when no job is selected
                updateStatCards();
                return;
            }
            
            const selectedJob = availableJobs.find(job => job.id === jobId);
            if (!selectedJob) {
                if (jobNotice) {
                    jobNotice.classList.remove('hidden');
                }
                // Update stat cards when job not found
                updateStatCards();
                return;
            }
            
            // Hide the job notice banner
            if (jobNotice) {
                jobNotice.classList.add('hidden');
            }
            
            // Load matrix configuration for this specific job
            loadMatrixConfig();
            
            // Update stat cards with selected job data
            updateStatCards();
            
            console.log('Selected job for matrix analysis:', selectedJob);
        }

        // Show job loading error
        function showJobLoadError() {
            const jobSelector = document.getElementById('jobSelector');
            if (jobSelector) {
                jobSelector.innerHTML = '<option value="">Error loading jobs. Please refresh the page.</option>';
                jobSelector.disabled = true;
            }
        }

        // Format employment type helper
        function formatEmploymentType(type) {
            const types = {
                'full-time': 'Full Time',
                'part-time': 'Part Time',
                'contract': 'Contract',
                'internship': 'Internship',
                'temporary': 'Temporary'
            };
            return types[type?.toLowerCase()] || type || 'Full Time';
        }

        // Initialize default criteria        function initializeDefaultCriteria() {
            // Default skills criteria (50% total)
            addCriteriaCard('skills', {
                name: 'Programming Languages',
                weight: 30,
                keywords: 'JavaScript, Python, Java, C#, PHP, React, Angular, Vue',
                enabled: true
            });

            addCriteriaCard('skills', {
                name: 'Years of Experience',
                weight: 20,
                keywords: 'experience, years, senior, junior, lead',
                enabled: true
            });

            // Default education criteria (25% total)
            addCriteriaCard('education', {
                name: 'Degree Level',
                weight: 25,
                keywords: 'Bachelor, Master, PhD, Degree, University, College',
                enabled: true
            });

            // Default personal criteria (25% total)
            addCriteriaCard('personal', {
                name: 'Communication Skills',
                weight: 25,
                keywords: 'communication, presentation, writing, speaking, teamwork',
                enabled: true
            });
        // Add new criteria
        function addCriteria(type) {
            // Calculate suggested percentage based on remaining percentage
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            const currentTotal = allCriteria.reduce((sum, criteria) => sum + (criteria.weight || 0), 0);
            const remaining = Math.max(0, 100 - currentTotal);
            const suggestedPercentage = Math.min(remaining, 20); // Suggest up to 20% for new criteria

            const criteria = {
                name: `New ${type.charAt(0).toUpperCase() + type.slice(1)} Criteria`,
                weight: suggestedPercentage,
                keywords: '',
                enabled: true
            };
            addCriteriaCard(type, criteria);
        }// Add criteria card to UI
        function addCriteriaCard(type, criteria) {
            const container = document.getElementById(`${type}Criteria`);
            // Use existing ID if available, otherwise generate new one
            const criteriaId = criteria.id || `${type}_${Date.now()}`;

            const card = document.createElement('div');
            card.className = `criteria-card ${criteria.enabled ? 'enabled' : ''}`;            card.innerHTML = `
                <div class="criteria-header">
                    <div class="criteria-name">
                        <i class="fas fa-${getTypeIcon(type)}"></i>
                        <input type="text" value="${criteria.name}" class="config-input" style="border: none; background: none; font-weight: 600; font-size: 1.1rem;" onchange="updateCriteriaName('${criteriaId}', this.value)">
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <input type="number" 
                                   class="criteria-percentage-input" 
                                   id="percentage_${criteriaId}"
                                   min="0" 
                                   max="100" 
                                   value="${criteria.weight || 0}" 
                                   onchange="updatePercentage('${criteriaId}', this.value)"
                                   onblur="validateTotalPercentage()"
                                   style="width: 50px; padding: 0.25rem; font-size: 0.85rem;">
                            <span style="font-weight: 600; color: #6c757d; font-size: 0.85rem;">%</span>
                        </div>
                        <button class="sub-percentage-mode-toggle" id="toggle_${criteriaId}" onclick="toggleSubPercentageMode('${criteriaId}')" title="Enable keyword-level percentage breakdown" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                            <i class="fas fa-cogs"></i>
                            Sub-%
                        </button>
                        <button class="btn" style="background: #dc3545; color: white; padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="deleteCriteria('${criteriaId}')" title="Delete Criteria">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="toggle-switch ${criteria.enabled ? 'active' : ''}" onclick="toggleCriteria('${criteriaId}', this)"></div>
                    </div>
                </div>
                <div class="criteria-config">
                    <div style="margin-top: 1rem;">
                        <label class="config-label" style="margin-bottom: 0.5rem; display: block;">Keywords/Criteria:</label>
                        <div id="simple_mode_${criteriaId}">
                            <textarea class="keywords-input" placeholder="Enter keywords, skills, or criteria to match..." onchange="updateKeywords('${criteriaId}', this.value)">${criteria.keywords}</textarea>
                        </div>
                        <div id="sub_percentage_mode_${criteriaId}" style="display: none;">
                            <div class="sub-percentage-section">
                                <div class="sub-percentage-header">
                                    <div class="sub-percentage-title">
                                        <i class="fas fa-list"></i>
                                        Keyword Breakdown
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div class="sub-percentage-total" id="sub_total_${criteriaId}">0%</div>
                                        <button class="add-sub-percentage" onclick="addSubPercentage('${criteriaId}')">
                                            <i class="fas fa-plus"></i>
                                            Add Keyword
                                        </button>
                                    </div>
                                </div>
                                <div id="sub_percentage_list_${criteriaId}">
                                    <!-- Sub-percentage items will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(card);

            // Store criteria in config
            if (!matrixConfig.criteria[type]) {
                matrixConfig.criteria[type] = [];
            }
            matrixConfig.criteria[type].push({
                id: criteriaId,
                ...criteria
            });

            // Update percentage summary
            updatePercentageSummary();
        }

        // Get icon for criteria type
        function getTypeIcon(type) {
            const icons = {
                skills: 'tools',
                education: 'graduation-cap',
                personal: 'user-check'
            };
            return icons[type] || 'check';
        }        // Toggle criteria enabled/disabled
        function toggleCriteria(criteriaId, toggle) {
            toggle.classList.toggle('active');
            const card = toggle.closest('.criteria-card');
            card.classList.toggle('enabled');

            // Update config
            Object.values(matrixConfig.criteria).forEach(typeArray => {
                const criteria = typeArray.find(c => c.id === criteriaId);
                if (criteria) {
                    criteria.enabled = toggle.classList.contains('active');
                }
            });

            // Update percentage summary
            updatePercentageSummary();
        }

        // Update criteria percentage
        function updatePercentage(criteriaId, percentage) {
            const percentageValue = parseInt(percentage) || 0;
            
            // Get current total without this criteria
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);
            
            const currentCriteria = allCriteria.find(c => c.id === criteriaId);
            const currentWeight = currentCriteria ? currentCriteria.weight || 0 : 0;
            const totalWithoutCurrent = allCriteria
                .filter(c => c.id !== criteriaId)
                .reduce((sum, criteria) => sum + (criteria.weight || 0), 0);
            
            // Check if new percentage would exceed 100%
            const newTotal = totalWithoutCurrent + percentageValue;
            if (newTotal > 100) {
                const maxAllowed = 100 - totalWithoutCurrent;
                alert(`Cannot set ${percentageValue}%. This would make the total ${newTotal}% (exceeding 100%). Maximum allowed for this criteria is ${maxAllowed}%.`);
                
                // Reset the input to the current value
                const input = document.getElementById(`percentage_${criteriaId}`);
                if (input) {
                    input.value = currentWeight;
                }
                return;
            }
            
            // Update config
            Object.values(matrixConfig.criteria).forEach(typeArray => {
                const criteria = typeArray.find(c => c.id === criteriaId);
                if (criteria) {
                    criteria.weight = percentageValue;
                }
            });

            // Update percentage summary and validate
            updatePercentageSummary();
            validateTotalPercentage();
        }

        // Auto-balance percentages among enabled criteria
        function autoBalancePercentages() {
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            if (allCriteria.length === 0) {
                alert('Please add and enable some criteria before using auto-balance.');
                return;
            }

            // Distribute 100% equally among all enabled criteria
            const percentagePerCriteria = Math.floor(100 / allCriteria.length);
            const remainder = 100 - (percentagePerCriteria * allCriteria.length);

            allCriteria.forEach((criteria, index) => {
                // Give the remainder to the first few criteria
                const finalPercentage = percentagePerCriteria + (index < remainder ? 1 : 0);
                criteria.weight = finalPercentage;

                // Update the UI input
                const input = document.getElementById(`percentage_${criteria.id}`);
                if (input) {
                    input.value = finalPercentage;
                }
            });

            // Update the summary display
            updatePercentageSummary();
            validateTotalPercentage();
        }

        // Update percentage summary display
        function updatePercentageSummary() {
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            // Debug logging to help identify duplicate issues
            console.log('📊 Percentage Summary Debug:');
            console.log('Skills criteria:', matrixConfig.criteria.skills?.map(c => `${c.name} (ID: ${c.id}, Weight: ${c.weight}%)`));
            console.log('Education criteria:', matrixConfig.criteria.education?.map(c => `${c.name} (ID: ${c.id}, Weight: ${c.weight}%)`));
            console.log('Personal criteria:', matrixConfig.criteria.personal?.map(c => `${c.name} (ID: ${c.id}, Weight: ${c.weight}%)`));
            console.log('All enabled criteria:', allCriteria.map(c => `${c.name} (ID: ${c.id}, Weight: ${c.weight}%)`));

            const totalPercentage = allCriteria.reduce((sum, criteria) => sum + (criteria.weight || 0), 0);
            console.log('Total percentage calculated:', totalPercentage + '%');
            
            const percentageSummary = document.getElementById('percentageSummary');
            const totalElement = document.getElementById('totalPercentage');
            const progressFill = document.getElementById('percentageProgressFill');
            const messageElement = document.getElementById('percentageMessage');
            const breakdownElement = document.getElementById('percentageBreakdown');

            // Update total display
            totalElement.textContent = totalPercentage + '%';
            progressFill.style.width = Math.min(totalPercentage, 100) + '%';

            // Update summary status
            percentageSummary.className = 'percentage-summary';
            totalElement.className = 'percentage-total';

            if (totalPercentage === 100) {
                percentageSummary.classList.add('valid');
                totalElement.classList.add('valid');
                messageElement.innerHTML = '';
            } else if (totalPercentage > 100) {
                percentageSummary.classList.add('error');
                totalElement.classList.add('error');
                messageElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Total exceeds 100% by ${totalPercentage - 100}%. Please reduce some percentages.`;
            } else {
                messageElement.innerHTML = `<i class="fas fa-info-circle"></i> Total is ${totalPercentage}%. You need ${100 - totalPercentage}% more to reach 100%.`;
            }

            // Update breakdown - removed to hide individual percentages
            breakdownElement.innerHTML = '';

            // Update stat cards in header
            updateStatCards(allCriteria, totalPercentage);
        }

        // Update stat cards in the header
        function updateStatCards(allCriteria = null, totalWeight = null) {
            // Get criteria data if not provided
            if (!allCriteria) {
                allCriteria = [
                    ...(matrixConfig.criteria.skills || []),
                    ...(matrixConfig.criteria.education || []),
                    ...(matrixConfig.criteria.personal || [])
                ].filter(criteria => criteria.enabled);
            }

            if (totalWeight === null) {
                totalWeight = allCriteria.reduce((sum, criteria) => sum + (criteria.weight || 0), 0);
            }

            // Update active criteria count
            const totalCriteriaEl = document.getElementById('totalCriteria');
            if (totalCriteriaEl) {
                totalCriteriaEl.textContent = allCriteria.length;
            }

            // Update total weight
            const totalWeightEl = document.getElementById('totalWeight');
            if (totalWeightEl) {
                totalWeightEl.textContent = `${totalWeight}%`;
                totalWeightEl.style.color = totalWeight === 100 ? '#28a745' : (totalWeight > 100 ? '#dc3545' : '#007bff');
            }

            // Update selected job applications count
            const selectedJobAppsEl = document.getElementById('selectedJobApps');
            if (selectedJobAppsEl) {
                const selectedJob = availableJobs.find(job => job.id === selectedJobId);
                const appCount = selectedJob ? selectedJob.applicationCount : 0;
                selectedJobAppsEl.textContent = appCount;
            }
        }        // Validate total percentage and highlight errors
        function validateTotalPercentage() {
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ];

            const totalPercentage = allCriteria
                .filter(criteria => criteria.enabled)
                .reduce((sum, criteria) => sum + (criteria.weight || 0), 0);

            // Update input field styles
            allCriteria.forEach(criteria => {
                const input = document.getElementById(`percentage_${criteria.id}`);
                if (input) {
                    input.className = 'criteria-percentage-input';
                    if (totalPercentage > 100) {
                        input.classList.add('error');
                    }
                }
            });

            // Return whether total is valid
            return totalPercentage === 100;
        }

        // Toggle sub-percentage mode for a criteria
        function toggleSubPercentageMode(criteriaId) {
            const simpleMode = document.getElementById(`simple_mode_${criteriaId}`);
            const subPercentageMode = document.getElementById(`sub_percentage_mode_${criteriaId}`);
            const toggleButton = document.getElementById(`toggle_${criteriaId}`);

            if (simpleMode.style.display === 'none') {
                // Switch to simple mode
                simpleMode.style.display = 'block';
                subPercentageMode.style.display = 'none';
                toggleButton.classList.remove('active');
                toggleButton.innerHTML = '<i class="fas fa-cogs"></i> Sub-Percentages';
            } else {
                // Switch to sub-percentage mode
                simpleMode.style.display = 'none';
                subPercentageMode.style.display = 'block';
                toggleButton.classList.add('active');
                toggleButton.innerHTML = '<i class="fas fa-list"></i> Simple Mode';
                
                // Initialize sub-percentages from existing keywords if any
                initializeSubPercentagesFromKeywords(criteriaId);
            }
        }

        // Initialize sub-percentages from existing keywords
        function initializeSubPercentagesFromKeywords(criteriaId) {
            const criteria = findCriteriaById(criteriaId);
            if (!criteria || criteria.subPercentages) return; // Already initialized

            criteria.subPercentages = [];
            
            if (criteria.keywords) {
                const keywords = criteria.keywords.split(',').map(k => k.trim()).filter(k => k);
                const percentagePerKeyword = keywords.length > 0 ? Math.floor(100 / keywords.length) : 0;
                const remainder = 100 - (percentagePerKeyword * keywords.length);

                keywords.forEach((keyword, index) => {
                    criteria.subPercentages.push({
                        id: `sub_${criteriaId}_${Date.now()}_${index}`,
                        keyword: keyword,
                        percentage: percentagePerKeyword + (index < remainder ? 1 : 0)
                    });
                });
            }

            renderSubPercentages(criteriaId);
        }

        // Add a new sub-percentage item
        function addSubPercentage(criteriaId) {
            const criteria = findCriteriaById(criteriaId);
            if (!criteria) return;

            if (!criteria.subPercentages) {
                criteria.subPercentages = [];
            }

            const newSubPercentage = {
                id: `sub_${criteriaId}_${Date.now()}`,
                keyword: '',
                percentage: 0
            };

            criteria.subPercentages.push(newSubPercentage);
            renderSubPercentages(criteriaId);
        }

        // Render sub-percentage list
        function renderSubPercentages(criteriaId) {
            const criteria = findCriteriaById(criteriaId);
            const container = document.getElementById(`sub_percentage_list_${criteriaId}`);
            
            if (!criteria || !container) return;

            container.innerHTML = '';

            if (criteria.subPercentages) {
                criteria.subPercentages.forEach(subItem => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'sub-percentage-item';
                    itemDiv.innerHTML = `
                        <input type="text" 
                               class="sub-percentage-keyword" 
                               placeholder="Enter keyword/skill..." 
                               value="${subItem.keyword}"
                               onchange="updateSubKeyword('${criteriaId}', '${subItem.id}', this.value)">
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <input type="number" 
                                   class="sub-percentage-input" 
                                   min="0" 
                                   max="100" 
                                   value="${subItem.percentage}"
                                   onchange="updateSubPercentage('${criteriaId}', '${subItem.id}', this.value)">
                            <span style="font-size: 0.8rem; color: #6c757d;">%</span>
                        </div>
                        <button class="sub-percentage-delete" onclick="deleteSubPercentage('${criteriaId}', '${subItem.id}')" title="Delete this keyword">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    container.appendChild(itemDiv);
                });
            }

            updateSubPercentageTotal(criteriaId);
        }

        // Update sub-percentage keyword
        function updateSubKeyword(criteriaId, subId, keyword) {
            const criteria = findCriteriaById(criteriaId);
            if (!criteria || !criteria.subPercentages) return;

            const subItem = criteria.subPercentages.find(s => s.id === subId);
            if (subItem) {
                subItem.keyword = keyword;
                updateCombinedKeywords(criteriaId);
            }
        }

        // Update sub-percentage value
        function updateSubPercentage(criteriaId, subId, percentage) {
            const criteria = findCriteriaById(criteriaId);
            if (!criteria || !criteria.subPercentages) return;

            const subItem = criteria.subPercentages.find(s => s.id === subId);
            if (!subItem) return;
            
            const percentageValue = parseInt(percentage) || 0;
            const currentValue = subItem.percentage || 0;
            
            // Calculate total without this sub-percentage
            const totalWithoutCurrent = criteria.subPercentages
                .filter(s => s.id !== subId)
                .reduce((sum, sub) => sum + (sub.percentage || 0), 0);
            
            // Check if new percentage would exceed 100%
            const newTotal = totalWithoutCurrent + percentageValue;
            if (newTotal > 100) {
                const maxAllowed = 100 - totalWithoutCurrent;
                alert(`Cannot set ${percentageValue}%. This would make the sub-total ${newTotal}% (exceeding 100%). Maximum allowed for this keyword is ${maxAllowed}%.`);
                
                // Reset the input to the current value
                const input = document.getElementById(`sub_percentage_${subId}`);
                if (input) {
                    input.value = currentValue;
                }
                return;
            }
            
            // Update the value
            subItem.percentage = percentageValue;
            updateSubPercentageTotal(criteriaId);
            validateSubPercentages(criteriaId);
        }

        // Delete sub-percentage item
        function deleteSubPercentage(criteriaId, subId) {
            const criteria = findCriteriaById(criteriaId);
            if (!criteria || !criteria.subPercentages) return;

            criteria.subPercentages = criteria.subPercentages.filter(s => s.id !== subId);
            renderSubPercentages(criteriaId);
            updateCombinedKeywords(criteriaId);
        }

        // Update sub-percentage total display
        function updateSubPercentageTotal(criteriaId) {
            const criteria = findCriteriaById(criteriaId);
            const totalElement = document.getElementById(`sub_total_${criteriaId}`);
            
            if (!criteria || !totalElement) return;

            const total = criteria.subPercentages ? 
                criteria.subPercentages.reduce((sum, sub) => sum + (sub.percentage || 0), 0) : 0;

            totalElement.textContent = total + '%';
            totalElement.className = 'sub-percentage-total';

            if (total === 100) {
                totalElement.classList.add('valid');
            } else if (total > 100) {
                totalElement.classList.add('error');
            }
        }

        // Validate sub-percentages
        function validateSubPercentages(criteriaId) {
            const criteria = findCriteriaById(criteriaId);
            if (!criteria || !criteria.subPercentages) return true;

            const total = criteria.subPercentages.reduce((sum, sub) => sum + (sub.percentage || 0), 0);
            
            // Update input styles
            criteria.subPercentages.forEach(subItem => {
                const inputs = document.querySelectorAll(`input[onchange*="${subItem.id}"]`);
                inputs.forEach(input => {
                    if (input.type === 'number') {
                        input.className = 'sub-percentage-input';
                        if (total > 100) {
                            input.classList.add('error');
                        }
                    }
                });
            });

            return total === 100;
        }

        // Update combined keywords from sub-percentages
        function updateCombinedKeywords(criteriaId) {
            const criteria = findCriteriaById(criteriaId);
            if (!criteria || !criteria.subPercentages) return;

            const keywords = criteria.subPercentages
                .filter(sub => sub.keyword.trim())
                .map(sub => sub.keyword.trim())
                .join(', ');

            criteria.keywords = keywords;
        }

        // Find criteria by ID helper
        function findCriteriaById(criteriaId) {
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ];
            return allCriteria.find(c => c.id === criteriaId);
        }// Add delete functionality for criteria
        function deleteCriteria(criteriaId) {
            if (confirm('Are you sure you want to delete this criteria?')) {
                // Remove from UI
                const card = document.querySelector(`[onclick*="${criteriaId}"]`).closest('.criteria-card');
                card.remove();

                // Remove from config
                Object.keys(matrixConfig.criteria).forEach(type => {
                    matrixConfig.criteria[type] = matrixConfig.criteria[type].filter(c => c.id !== criteriaId);
                });

                // Update percentage summary
                updatePercentageSummary();
            }
        }

        // Auto-balance percentages among enabled criteria
        function autoBalancePercentages() {
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            if (allCriteria.length === 0) {
                alert('Please add and enable some criteria before using auto-balance.');
                return;
            }

            // Distribute 100% equally among all enabled criteria
            const percentagePerCriteria = Math.floor(100 / allCriteria.length);
            const remainder = 100 - (percentagePerCriteria * allCriteria.length);

            allCriteria.forEach((criteria, index) => {
                // Give the remainder to the first few criteria
                const finalPercentage = percentagePerCriteria + (index < remainder ? 1 : 0);
                criteria.weight = finalPercentage;

                // Update the UI input
                const input = document.getElementById(`percentage_${criteria.id}`);
                if (input) {
                    input.value = finalPercentage;
                }
            });

            // Update the summary display
            updatePercentageSummary();
            validateTotalPercentage();
        }

        // Update criteria keywords
        function updateKeywords(criteriaId, keywords) {
            Object.values(matrixConfig.criteria).forEach(typeArray => {
                const criteria = typeArray.find(c => c.id === criteriaId);
                if (criteria) {
                    criteria.keywords = keywords;
                }
            });
        }

        // Update criteria name
        function updateCriteriaName(criteriaId, name) {
            Object.values(matrixConfig.criteria).forEach(typeArray => {
                const criteria = typeArray.find(c => c.id === criteriaId);
                if (criteria) {
                    criteria.name = name;
                }
            });
        }

        // Update reject threshold
        function updateRejectThreshold() {
            const rejectInput = document.getElementById('rejectThreshold');
            const averageThreshold = parseInt(document.getElementById('averageThreshold').value);
            rejectInput.value = averageThreshold - 1;
        }        // Refresh preview data
        function refreshPreview() {
            console.log('Refreshing preview data...');
            const tbody = document.getElementById('previewTableBody');
              // Check if a job is selected
            if (!selectedJobId) {
                console.log('No job selected for preview');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6c757d;"><i class="fas fa-exclamation-triangle"></i> Please select a job first to preview applications</td></tr>';
                return;
            }
            
            // Get company ID from AuthManager
            const companyInfo = window.getCompanyInfo ? window.getCompanyInfo() : null;
            const currentCompanyId = companyInfo?.id || window.authManager?.currentUser?.companyId || window.authManager?.userCompanyId;
            
            if (!currentCompanyId) {
                console.log('No company context available for preview');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Company context not available. Please refresh and try again.</td></tr>';
                return;
            }
            
            // Find the selected job to determine its source (active or closed)
            const selectedJob = availableJobs.find(job => job.id === selectedJobId);
            if (!selectedJob) {
                console.log('Selected job not found in available jobs');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Selected job not found. Please refresh and try again.</td></tr>';
                return;
            }
            
            console.log('Loading applications for job:', selectedJobId, 'in company:', currentCompanyId, 'source:', selectedJob.source);
            
            // Show different loading message for AI algorithm
            const loadingMessage = matrixConfig.algorithm === 'ai' 
                ? '<i class="fas fa-robot fa-spin"></i> AI analyzing CVs and ranking applicants...'
                : '<i class="fas fa-spinner fa-spin"></i> Loading applications for analysis...';
            
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6c757d;">${loadingMessage}</td></tr>`;

            // Determine the correct Firebase path based on job source
            const jobPath = selectedJob.source === 'closed' ? 'jobclosed' : 'jobs';
            
            // Load applications from the appropriate path: companies/{companyId}/jobs/{jobId}/applications or companies/{companyId}/jobclosed/{jobId}/applications
            const applicationsRef = database.ref(`companies/${currentCompanyId}/${jobPath}/${selectedJobId}/applications`);
            applicationsRef.once('value', (snapshot) => {
                const applicationsData = snapshot.val();
                
                console.log(`Raw applications data loaded from company scope for ${selectedJob.source} job:`, selectedJobId, applicationsData);
                  if (!applicationsData) {
                    const jobStatusText = selectedJob.source === 'closed' ? 'closed position' : 'position';
                    console.log('No applications found for job:', selectedJobId, 'in company:', currentCompanyId);
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6c757d;"><i class="fas fa-inbox"></i> No applications found for this ${jobStatusText}</td></tr>`;
                    return;
                }
                
                // Convert to array and analyze
                const applications = Object.keys(applicationsData).map(id => ({
                    id,
                    ...applicationsData[id]
                }));
                
                console.log(`Converted applications array for analysis: ${applications.length} applications from company scope (${selectedJob.source} job)`);
                
                // Log sample application structure for debugging
                if (applications.length > 0) {
                    console.log('Sample application structure for name extraction:', {
                        id: applications[0].id,
                        personalInfo: applications[0].personalInfo,
                        availableFields: Object.keys(applications[0])
                    });
                }
                  // Show AI processing message if AI algorithm is selected
                if (matrixConfig.algorithm === 'ai') {
                    const jobStatusText = selectedJob.source === 'closed' ? ' (from closed position)' : '';
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #007bff;">
                        <i class="fas fa-robot fa-spin"></i> 
                        <strong>AI Analysis in Progress...</strong><br>
                        <small>Scanning ${applications.length} CVs with advanced criteria matching${jobStatusText}</small>
                    </td></tr>`;
                      // Add a slight delay to show AI processing (simulate AI thinking time)
                    setTimeout(() => {
                        const scoredApplications = analyzeApplications(applications);
                        console.log('AI analysis completed, displaying', scoredApplications.length, 'applications');
                        lastAnalyzedApplications = scoredApplications; // Store for detailed view
                        displayScoredApplications(scoredApplications);
                    }, 2000);
                } else {
                    // Analyze and score applications immediately for other algorithms
                    const scoredApplications = analyzeApplications(applications);
                    console.log('Standard analysis completed, displaying', scoredApplications.length, 'applications');
                    lastAnalyzedApplications = scoredApplications; // Store for detailed view
                    displayScoredApplications(scoredApplications);
                }
                
            }).catch((error) => {
                console.error('Error loading applications from Firebase:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #dc3545;"><i class="fas fa-exclamation-circle"></i> Error loading applications. Please try again.</td></tr>';
            });
        }
          // Analyze applications based on matrix criteria
        function analyzeApplications(applications) {
            console.log(`Analyzing ${applications.length} applications using ${matrixConfig.algorithm} algorithm`);
            
            // Special handling for AI algorithm
            if (matrixConfig.algorithm === 'ai') {
                return analyzeApplicationsWithAI(applications);
            }
            
            return applications.map(app => {
                const score = calculateApplicationScore(app);
                const rating = getScoreRating(score);
                
                return {
                    ...app,
                    matrixScore: score,
                    rating: rating,
                    keyHighlights: extractKeyHighlights(app)
                };
            }).sort((a, b) => b.matrixScore - a.matrixScore); // Sort by score descending
        }
        
        // AI-Enhanced application analysis
        function analyzeApplicationsWithAI(applications) {
            console.log('Starting AI-enhanced analysis of applications...');
            
            // First pass: Calculate individual scores
            const scoredApplications = applications.map(app => {
                const score = calculateAIEnhancedScore(app);
                const rating = getScoreRating(score);
                
                return {
                    ...app,
                    matrixScore: score,
                    rating: rating,
                    keyHighlights: extractKeyHighlights(app),
                    aiAnalysis: performDetailedAIAnalysis(app)
                };
            });
            
            // Second pass: Comparative analysis and ranking optimization
            const rankedApplications = performComparativeAIAnalysis(scoredApplications);
            
            console.log('AI analysis completed. Final rankings:', rankedApplications.map(app => ({
                name: app.personalInfo?.fullName || 'Unknown',
                score: app.matrixScore,
                rating: app.rating
            })));
            
            return rankedApplications.sort((a, b) => b.matrixScore - a.matrixScore);
        }
        
        // Perform detailed AI analysis for each application
        function performDetailedAIAnalysis(application) {
            const analysis = {
                strengthAreas: [],
                weaknessAreas: [],
                uniqueFactors: [],
                overallFit: 0
            };
            
            // Analyze strength areas
            const skillsStrength = analyzeSkillsStrength(application);
            const experienceStrength = analyzeExperienceStrength(application);
            const educationStrength = analyzeEducationStrength(application);
            
            if (skillsStrength > 70) analysis.strengthAreas.push('Technical Skills');
            if (experienceStrength > 70) analysis.strengthAreas.push('Work Experience');
            if (educationStrength > 70) analysis.strengthAreas.push('Educational Background');
            
            // Analyze weakness areas
            if (skillsStrength < 40) analysis.weaknessAreas.push('Technical Skills Gap');
            if (experienceStrength < 40) analysis.weaknessAreas.push('Limited Experience');
            if (educationStrength < 40) analysis.weaknessAreas.push('Educational Mismatch');
            
            // Identify unique factors
            analysis.uniqueFactors = identifyUniqueFactors(application);
            
            // Calculate overall fit
            analysis.overallFit = Math.round((skillsStrength + experienceStrength + educationStrength) / 3);
            
            return analysis;
        }
        
        // Perform comparative AI analysis
        function performComparativeAIAnalysis(scoredApplications) {
            console.log('Performing comparative AI analysis...');
            
            if (scoredApplications.length <= 1) return scoredApplications;
            
            // Calculate relative rankings and adjust scores
            const enhancedApplications = scoredApplications.map((app, index) => {
                // Comparative analysis against other applications
                const competitiveScore = calculateCompetitiveScore(app, scoredApplications);
                
                // Adjust final score based on competitive analysis
                const adjustedScore = Math.round((app.matrixScore * 0.8) + (competitiveScore * 0.2));
                
                return {
                    ...app,
                    matrixScore: Math.max(0, Math.min(100, adjustedScore)),
                    competitiveRanking: competitiveScore,
                    aiInsights: generateAIInsights(app, scoredApplications)
                };
            });
            
            return enhancedApplications;
        }
        
        // Calculate competitive score relative to other applications
        function calculateCompetitiveScore(application, allApplications) {
            const scores = allApplications.map(app => app.matrixScore);
            const maxScore = Math.max(...scores);
            const minScore = Math.min(...scores);
            const avgScore = scores.reduce((sum, score) => sum + score, 0) / scores.length;
            
            let competitiveScore = application.matrixScore;
            
            // Boost if significantly above average
            if (application.matrixScore > avgScore + 10) {
                competitiveScore += 5;
            }
            
            // Slight boost if in top quartile
            const topQuartile = scores.sort((a, b) => b - a)[Math.floor(scores.length * 0.25)];
            if (application.matrixScore >= topQuartile) {
                competitiveScore += 2;
            }
            
            return Math.max(0, Math.min(100, competitiveScore));
        }
        
        // Generate AI insights for application
        function generateAIInsights(application, allApplications) {
            const insights = [];
            
            const rank = allApplications
                .sort((a, b) => b.matrixScore - a.matrixScore)
                .findIndex(app => app.id === application.id) + 1;
            
            if (rank === 1) {
                insights.push("🏆 Top candidate with excellent overall match");
            } else if (rank <= 3) {
                insights.push("⭐ Strong candidate in top tier");
            } else if (rank <= allApplications.length * 0.5) {
                insights.push("✅ Above average candidate with good potential");
            }
            
            // Add specific insights based on AI analysis
            if (application.aiAnalysis?.strengthAreas.length > 2) {
                insights.push("💪 Multiple strong areas identified");
            }
            
            if (application.aiAnalysis?.uniqueFactors.length > 0) {
                insights.push("🌟 Unique qualifications found");
            }
            
            if (application.aiAnalysis?.weaknessAreas.length === 0) {
                insights.push("✨ No significant gaps identified");
            }
            
            return insights;
        }
        
        // Analyze skills strength
        function analyzeSkillsStrength(application) {
            const skillsText = [
                application.skills || '',
                application.personalInfo?.skills || '',
                application.technicalSkills || ''
            ].join(' ').toLowerCase();
            
            const techSkills = ['javascript', 'python', 'java', 'react', 'angular', 'node', 'sql', 'html', 'css'];
            const foundSkills = techSkills.filter(skill => skillsText.includes(skill));
            
            return Math.round((foundSkills.length / techSkills.length) * 100);
        }
        
        // Analyze experience strength
        function analyzeExperienceStrength(application) {
            const experienceText = [
                application.experience || '',
                application.personalInfo?.experience || ''
            ].join(' ').toLowerCase();
            
            let strength = 0;
            
            // Check for years of experience
            const yearsMatch = experienceText.match(/(\d+)\s*years?/);
            if (yearsMatch) {
                const years = parseInt(yearsMatch[1]);
                strength += Math.min(50, years * 10); // Up to 50 points for 5+ years
            }
            
            // Check for relevant experience keywords
            const relevantTerms = ['developer', 'engineer', 'programming', 'software', 'web', 'application'];
            relevantTerms.forEach(term => {
                if (experienceText.includes(term)) strength += 8;
            });
            
            return Math.min(100, strength);
        }
        
        // Analyze education strength
        function analyzeEducationStrength(application) {
            const educationText = [
                application.education || '',
                application.personalInfo?.education || ''
            ].join(' ').toLowerCase();
            
            let strength = 0;
            
            // Check for relevant degrees
            if (educationText.includes('computer science')) strength += 40;
            else if (educationText.includes('engineering')) strength += 35;
            else if (educationText.includes('information technology')) strength += 35;
            else if (educationText.includes('mathematics')) strength += 25;
            
            // Check for degree level
            if (educationText.includes('master') || educationText.includes('phd')) strength += 20;
            else if (educationText.includes('bachelor')) strength += 15;
            
            // Check for certifications
            const certTerms = ['certified', 'certification', 'aws', 'azure', 'google cloud'];
            certTerms.forEach(term => {
                if (educationText.includes(term)) strength += 5;
            });
            
            return Math.min(100, strength);
        }
        
        // Identify unique factors in application
        function identifyUniqueFactors(application) {
            const uniqueFactors = [];
            
            const allText = [
                application.resume || '',
                application.skills || '',
                application.experience || ''
            ].join(' ').toLowerCase();
            
            // Check for leadership experience
            if (allText.includes('lead') || allText.includes('manager') || allText.includes('team lead')) {
                uniqueFactors.push('Leadership Experience');
            }
            
            // Check for startup experience
            if (allText.includes('startup') || allText.includes('entrepreneur')) {
                uniqueFactors.push('Startup Experience');
            }
            
            // Check for open source contributions
            if (allText.includes('open source') || allText.includes('github') || allText.includes('contribution')) {
                uniqueFactors.push('Open Source Contributor');
            }
            
            // Check for multiple programming languages
            const languages = ['javascript', 'python', 'java', 'c++', 'c#', 'go', 'rust', 'swift'];
            const foundLanguages = languages.filter(lang => allText.includes(lang));
            if (foundLanguages.length >= 3) {
                uniqueFactors.push('Polyglot Programmer');
            }
            
            return uniqueFactors;
        }
          // Calculate application score based on matrix criteria
        function calculateApplicationScore(application) {
            // Check if AI-enhanced algorithm is selected
            if (matrixConfig.algorithm === 'ai') {
                return calculateAIEnhancedScore(application);
            }
            
            let totalScore = 0;
            let totalWeight = 0;
            
            // Get all enabled criteria
            const allCriteria = [
                ...matrixConfig.criteria.skills,
                ...matrixConfig.criteria.education,
                ...matrixConfig.criteria.personal
            ].filter(criteria => criteria.enabled);
            
            if (allCriteria.length === 0) {
                return 0; // No criteria enabled
            }
            
            allCriteria.forEach(criteria => {
                const criteriaScore = evaluateCriteria(application, criteria);
                totalScore += criteriaScore * criteria.weight;
                totalWeight += criteria.weight;
            });
            
            return totalWeight > 0 ? Math.round(totalScore / totalWeight) : 0;
        }
        
        // AI-Enhanced scoring algorithm
        function calculateAIEnhancedScore(application) {
            console.log('Calculating AI-enhanced score for application:', application.id);
            
            let totalScore = 0;
            let totalWeight = 0;
            
            // Get all enabled criteria
            const allCriteria = [
                ...matrixConfig.criteria.skills,
                ...matrixConfig.criteria.education,
                ...matrixConfig.criteria.personal
            ].filter(criteria => criteria.enabled);
            
            if (allCriteria.length === 0) {
                return 0;
            }
            
            allCriteria.forEach(criteria => {
                const aiScore = evaluateAICriteria(application, criteria);
                totalScore += aiScore * criteria.weight;
                totalWeight += criteria.weight;
                console.log(`AI Criteria "${criteria.name}" scored: ${aiScore}% (weight: ${criteria.weight}%)`);
            });
            
            // Apply AI enhancement factors
            let finalScore = totalWeight > 0 ? Math.round(totalScore / totalWeight) : 0;
            
            // AI enhancement: Analyze overall CV quality and coherence
            const qualityBonus = analyzeOverallCVQuality(application);
            const experienceRelevance = analyzeExperienceRelevance(application);
            const educationAlignment = analyzeEducationAlignment(application);
            
            // Apply AI enhancement (up to 15% bonus/penalty)
            const aiEnhancement = (qualityBonus + experienceRelevance + educationAlignment) / 3;
            finalScore = Math.max(0, Math.min(100, finalScore + aiEnhancement));
            
            console.log(`Final AI-enhanced score: ${Math.round(finalScore)}% (base: ${Math.round(totalScore/totalWeight)}%, enhancement: ${Math.round(aiEnhancement)}%)`);
            
            return Math.round(finalScore);
        }
        
        // Evaluate criteria using AI-enhanced analysis
        function evaluateAICriteria(application, criteria) {
            const keywords = criteria.keywords.toLowerCase().split(',').map(k => k.trim()).filter(k => k);
            if (keywords.length === 0) return 0;
            
            // Get all application text
            const searchableFields = [
                application.resume || '',
                application.coverLetter || '',
                application.skills || '',
                application.experience || '',
                application.education || '',
                application.personalInfo?.fullName || '',
                application.personalInfo?.skills || '',
                application.personalInfo?.experience || '',
                application.personalInfo?.education || '',
                application.technicalSkills || '',
                application.keySkills || '',
                JSON.stringify(application.workExperience || []),
                JSON.stringify(application.educationDetails || [])
            ];
            
            const fullText = searchableFields.join(' ').toLowerCase();
            
            // AI-enhanced keyword matching with context awareness
            let contextualMatches = 0;
            let exactMatches = 0;
            let partialMatches = 0;
            
            keywords.forEach(keyword => {
                const keywordLower = keyword.toLowerCase();
                
                // Exact matches (highest score)
                if (fullText.includes(keywordLower)) {
                    exactMatches++;
                    
                    // Contextual analysis: check if keyword appears in meaningful context
                    const contextScore = analyzeKeywordContext(fullText, keywordLower, criteria.name);
                    if (contextScore > 0.7) {
                        contextualMatches++;
                    }
                }
                
                // Partial/related matches (medium score)
                const relatedTerms = getRelatedTerms(keywordLower, criteria.name);
                relatedTerms.forEach(term => {
                    if (fullText.includes(term)) {
                        partialMatches++;
                    }
                });
            });
            
            // Calculate AI score with weighted components
            const exactScore = (exactMatches / keywords.length) * 100;
            const contextualScore = (contextualMatches / keywords.length) * 20; // Bonus for contextual relevance
            const partialScore = (partialMatches / (keywords.length * 3)) * 15; // Bonus for related terms
            
            const finalScore = Math.min(100, exactScore + contextualScore + partialScore);
            
            console.log(`AI Criteria Analysis - ${criteria.name}:`, {
                exactMatches,
                contextualMatches,
                partialMatches,
                totalKeywords: keywords.length,
                finalScore: Math.round(finalScore)
            });
            
            return Math.round(finalScore);
        }
        
        // Analyze keyword context relevance
        function analyzeKeywordContext(text, keyword, criteriaType) {
            const keywordIndex = text.indexOf(keyword);
            if (keywordIndex === -1) return 0;
            
            // Extract context around the keyword (50 characters before and after)
            const contextStart = Math.max(0, keywordIndex - 50);
            const contextEnd = Math.min(text.length, keywordIndex + keyword.length + 50);
            const context = text.substring(contextStart, contextEnd);
            
            // Define positive context indicators for different criteria types
            const positiveIndicators = {
                'skills': ['proficient', 'expert', 'experienced', 'advanced', 'skilled', 'years', 'project', 'development'],
                'education': ['degree', 'graduated', 'university', 'college', 'certification', 'course', 'studied'],
                'personal': ['excellent', 'strong', 'effective', 'proven', 'demonstrated', 'successful']
            };
            
            const indicators = positiveIndicators[criteriaType.toLowerCase()] || positiveIndicators['skills'];
            
            let contextScore = 0;
            indicators.forEach(indicator => {
                if (context.includes(indicator)) {
                    contextScore += 0.1;
                }
            });
            
            return Math.min(1, contextScore);
            let qualityScore = 0;
            
            // Check for completeness
            const completenessFactors = [
                application.personalInfo?.fullName,
                application.personalInfo?.email,
                application.skills || application.personalInfo?.skills,
                application.experience || application.personalInfo?.experience,
                application.education || application.personalInfo?.education
            ];
            
            const completeness = completenessFactors.filter(factor => factor && factor.trim()).length / completenessFactors.length;
            qualityScore += completeness * 5; // Up to 5 points for completeness
            
            // Check for detail richness
            const allText = [
                application.resume || '',
                application.coverLetter || '',
                application.skills || '',
                application.experience || ''
            ].join(' ');
            
            if (allText.length > 1000) qualityScore += 3; // Detailed application
            else if (allText.length > 500) qualityScore += 1.5;
            
            // Check for structured information
            if (application.workExperience && Array.isArray(application.workExperience) && application.workExperience.length > 0) {
                qualityScore += 2;
            }
            if (application.educationDetails && Array.isArray(application.educationDetails) && application.educationDetails.length > 0) {
                qualityScore += 2;
            }
            
            return Math.min(5, qualityScore); // Cap at 5% bonus
        }
        
        // Analyze experience relevance
        function analyzeExperienceRelevance(application) {
            const jobRelatedTerms = ['software', 'development', 'programming', 'coding', 'technical', 'engineer', 'developer'];
            
            const experienceText = [
                application.experience || '',
                application.personalInfo?.experience || '',
                JSON.stringify(application.workExperience || [])
            ].join(' ').toLowerCase();
            
            let relevanceScore = 0;
            jobRelatedTerms.forEach(term => {
                if (experienceText.includes(term)) {
                    relevanceScore += 0.5;
                }
            });
            
            // Check for quantifiable achievements
            const quantifiablePatterns = /\d+\s*(years?|months?|projects?|applications?|users?|%)/gi;
            const quantifiableMatches = experienceText.match(quantifiablePatterns);
            if (quantifiableMatches && quantifiableMatches.length > 0) {
                relevanceScore += 2;
            }
            
            return Math.min(5, relevanceScore); // Cap at 5% bonus
        }
        
        // Analyze education alignment
        function analyzeEducationAlignment(application) {
            const techEducationTerms = ['computer science', 'software engineering', 'information technology', 'engineering', 'mathematics', 'programming'];
            
            const educationText = [
                application.education || '',
                application.personalInfo?.education || '',
                JSON.stringify(application.educationDetails || [])
            ].join(' ').toLowerCase();
            
            let alignmentScore = 0;
            techEducationTerms.forEach(term => {
                if (educationText.includes(term)) {
                    alignmentScore += 1;
                }
            });
            
            // Check for relevant certifications
            const certificationTerms = ['certification', 'certified', 'aws', 'azure', 'google cloud', 'oracle', 'microsoft'];
            certificationTerms.forEach(term => {
                if (educationText.includes(term)) {
                    alignmentScore += 0.5;
                }
            });
            
            return Math.min(5, alignmentScore); // Cap at 5% bonus
        }
          // Evaluate individual criteria against application
        function evaluateCriteria(application, criteria) {
            const keywords = criteria.keywords.toLowerCase().split(',').map(k => k.trim()).filter(k => k);
            if (keywords.length === 0) return 0;
            
            // Combine all searchable text from application (handle various data structures)
            const searchableFields = [
                application.resume || '',
                application.coverLetter || '',
                application.skills || '',
                application.experience || '',
                application.education || '',
                application.personalInfo?.fullName || '',
                application.personalInfo?.email || '',
                application.personalInfo?.phone || '',
                application.personalInfo?.skills || '',
                application.personalInfo?.experience || '',
                application.personalInfo?.education || '',
                application.personalInfo?.desiredPosition || '',
                application.technicalSkills || '',
                application.keySkills || '',
                application.yearsOfExperience || '',
                JSON.stringify(application.workExperience || []),
                JSON.stringify(application.educationDetails || []),
                JSON.stringify(application.additionalInfo || {}),
                // Handle any other nested objects
                JSON.stringify(application)
            ];
            
            const searchText = searchableFields.join(' ').toLowerCase();
            
            console.log('Evaluating criteria:', criteria.name, 'Keywords:', keywords);
            console.log('Search text length:', searchText.length);
            
            // Count keyword matches
            let matches = 0;
            keywords.forEach(keyword => {
                if (searchText.includes(keyword)) {
                    matches++;
                    console.log('Found keyword:', keyword);
                }
            });
            
            // Calculate score as percentage of keywords matched
            const score = keywords.length > 0 ? Math.round((matches / keywords.length) * 100) : 0;
            console.log('Criteria score:', score, 'Matches:', matches, 'Total keywords:', keywords.length);
            
            return score;
        }
        
        // Get score rating based on thresholds
        function getScoreRating(score) {
            if (score >= matrixConfig.thresholds.excellent) return 'Excellent';
            if (score >= matrixConfig.thresholds.good) return 'Good';
            if (score >= matrixConfig.thresholds.average) return 'Average';
            return 'Below Average';
        }
          // Extract key highlights from application
        function extractKeyHighlights(application) {
            const highlights = [];
            
            // Add key skills if available (check multiple possible locations)
            const skills = application.skills || 
                          application.personalInfo?.skills || 
                          application.technicalSkills || 
                          application.keySkills;
            if (skills) {
                highlights.push(skills.substring(0, 50) + (skills.length > 50 ? '...' : ''));
            }
            
            // Add experience if available
            const experience = application.experience || 
                              application.workExperience || 
                              application.personalInfo?.experience;
            if (experience) {
                if (typeof experience === 'string') {
                    highlights.push(experience.substring(0, 50) + (experience.length > 50 ? '...' : ''));
                } else if (Array.isArray(experience) && experience.length > 0) {
                    const expText = experience[0].position || experience[0].title || 'Work Experience';
                    highlights.push(expText.substring(0, 50) + (expText.length > 50 ? '...' : ''));
                }
            }
            
            // Add education if available
            const education = application.education || 
                             application.educationDetails || 
                             application.personalInfo?.education;
            if (education) {
                if (typeof education === 'string') {
                    highlights.push(education.substring(0, 50) + (education.length > 50 ? '...' : ''));
                } else if (Array.isArray(education) && education.length > 0) {
                    const eduText = education[0].degree || education[0].qualification || 'Education';
                    highlights.push(eduText.substring(0, 50) + (eduText.length > 50 ? '...' : ''));
                }
            }
            
            // Add years of experience if available
            const yearsExp = application.yearsOfExperience || 
                            application.personalInfo?.yearsOfExperience;
            if (yearsExp) {
                highlights.push(`${yearsExp} years exp`);
            }
            
            return highlights.length > 0 ? highlights.join(', ') : 'No highlights available';
        }        // Display scored applications in the table
        function displayScoredApplications(applications) {
            console.log('Starting to display', applications.length, 'scored applications in preview table');
            const tbody = document.getElementById('previewTableBody');
              if (applications.length === 0) {
                console.log('No applications to display');
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6c757d;"><i class="fas fa-inbox"></i> No applications to analyze</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            console.log('Cleared table body, starting to render rows...');
            
            applications.forEach((app, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';// Extract applicant name with enhanced fallback logic
                let fullName = 'Unknown Applicant';
                
                // Try multiple possible name field combinations in order of preference
                if (app.personalInfo?.fullName && app.personalInfo.fullName.trim()) {
                    fullName = app.personalInfo.fullName.trim();
                } else if (app.fullName && app.fullName.trim()) {
                    fullName = app.fullName.trim();
                } else if (app.name && app.name.trim()) {
                    fullName = app.name.trim();
                } else if (app.applicantName && app.applicantName.trim()) {
                    fullName = app.applicantName.trim();
                } else if (app.candidateName && app.candidateName.trim()) {
                    fullName = app.candidateName.trim();
                } else if (app.personalInfo?.name && app.personalInfo.name.trim()) {
                    fullName = app.personalInfo.name.trim();
                } else if (app.personalInfo?.firstName && app.personalInfo.firstName.trim()) {
                    const lastName = app.personalInfo?.lastName?.trim() || '';
                    fullName = `${app.personalInfo.firstName.trim()} ${lastName}`.trim();
                } else if (app.firstName && app.firstName.trim()) {
                    const lastName = app.lastName?.trim() || '';
                    fullName = `${app.firstName.trim()} ${lastName}`.trim();
                } else if (app.personalInfo?.contactInfo?.name && app.personalInfo.contactInfo.name.trim()) {
                    fullName = app.personalInfo.contactInfo.name.trim();
                } else if (app.contactInfo?.name && app.contactInfo.name.trim()) {
                    fullName = app.contactInfo.name.trim();
                } else if (app.personalInfo?.applicantName && app.personalInfo.applicantName.trim()) {
                    fullName = app.personalInfo.applicantName.trim();
                } else if (app.profile?.name && app.profile.name.trim()) {
                    fullName = app.profile.name.trim();
                } else if (app.profile?.fullName && app.profile.fullName.trim()) {
                    fullName = app.profile.fullName.trim();
                }
                
                // If still no name found, try to extract from email
                if (fullName === 'Unknown Applicant') {
                    const email = app.personalInfo?.email || app.email || app.contactEmail || '';
                    if (email && email.includes('@')) {
                        const emailPart = email.split('@')[0];
                        // Convert email part to a readable name format
                        fullName = emailPart.replace(/[._-]/g, ' ')
                                          .split(' ')
                                          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                                          .join(' ') || 'Anonymous Applicant';
                    }
                }                // Final validation to ensure we have a meaningful name
                if (!fullName || fullName.trim() === '' || fullName === 'Unknown Applicant') {
                    fullName = `Applicant #${index + 1}`;
                }
                
                console.log('Final applicant name for display:', fullName);
                
                const email = app.personalInfo?.email || 
                             app.email || 
                             app.contactEmail ||
                             app.personalInfo?.contactInfo?.email ||
                             app.contactInfo?.email ||
                             'Email Not Available';
                             
                const position = app.personalInfo?.desiredPosition || 
                               app.position || 
                               app.jobTitle ||
                               app.personalInfo?.jobTitle ||
                               app.appliedPosition ||
                               'Position Not Specified';                
                // Enhanced debug logging for name extraction
                console.log('Enhanced name extraction for application:', app.id, {
                    extractedName: fullName,
                    rawApplication: app,
                    nameFields: {
                        'personalInfo.fullName': app.personalInfo?.fullName,
                        'fullName': app.fullName,
                        'name': app.name,
                        'applicantName': app.applicantName,
                        'candidateName': app.candidateName,
                        'personalInfo.name': app.personalInfo?.name,
                        'personalInfo.firstName': app.personalInfo?.firstName,
                        'personalInfo.lastName': app.personalInfo?.lastName,
                        'firstName': app.firstName,
                        'lastName': app.lastName,
                        'personalInfo.contactInfo.name': app.personalInfo?.contactInfo?.name,
                        'contactInfo.name': app.contactInfo?.name,
                        'profile.name': app.profile?.name,
                        'profile.fullName': app.profile?.fullName
                    },
                    emailFields: {
                        'personalInfo.email': app.personalInfo?.email,
                        'email': app.email,
                        'contactEmail': app.contactEmail
                    }
                });
                
                // Prepare highlights - use AI insights if available
                let highlights = app.keyHighlights;
                if (matrixConfig.algorithm === 'ai' && app.aiInsights && app.aiInsights.length > 0) {
                    highlights = app.aiInsights.slice(0, 2).join(' '); // Show first 2 AI insights
                }
                
                console.log('Displaying application:', {
                    id: app.id,
                    fullName,
                    email,
                    position,
                    score: app.matrixScore,
                    rating: app.rating,
                    algorithm: matrixConfig.algorithm,
                    hasAIInsights: !!(app.aiInsights && app.aiInsights.length > 0)
                });
                  const row = document.createElement('tr');
                
                // Make row clickable
                row.style.cursor = 'pointer';
                row.onclick = () => openApplicationModal(app);
                
                // Add hover effect
                row.addEventListener('mouseenter', () => {
                    row.style.backgroundColor = '#f8f9fa';
                });
                row.addEventListener('mouseleave', () => {
                    row.style.backgroundColor = '';
                });
                
                // Add special styling for AI-enhanced results
                if (matrixConfig.algorithm === 'ai') {
                    row.style.background = rank <= 3 ? 'linear-gradient(45deg, #f8f9ff, #ffffff)' : '';
                    row.style.borderLeft = rank === 1 ? '4px solid #007bff' : rank <= 3 ? '3px solid #28a745' : '';
                }
                  row.innerHTML = `
                    <td><span class="rank-badge ${rankClass}">${rank}</span></td>
                    <td>
                        <strong>${fullName}</strong><br>
                        <small>${email}</small>
                        ${matrixConfig.algorithm === 'ai' && app.aiAnalysis ? 
                            `<br><small style="color: #007bff;"><i class="fas fa-robot"></i> AI Fit: ${app.aiAnalysis.overallFit}%</small>` : ''}
                    </td>
                    <td>${position}</td>
                    <td>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${app.matrixScore}%"></div>
                        </div>
                        <div style="text-align: center; margin-top: 0.25rem; font-weight: 600; color: #495057;">
                            ${app.matrixScore}%
                        </div>
                        ${matrixConfig.algorithm === 'ai' && app.competitiveRanking ? 
                            `<small style="color: #6c757d;">Competitive: ${Math.round(app.competitiveRanking)}%</small>` : ''}
                    </td>
                    <td>
                        <span class="status-badge ${app.rating.toLowerCase().replace(' ', '-')}">${app.rating}</span>
                        ${matrixConfig.algorithm === 'ai' && app.aiAnalysis?.strengthAreas.length > 0 ? 
                            `<br><small style="color: #28a745;">💪 ${app.aiAnalysis.strengthAreas.length} strengths</small>` : ''}
                    </td>
                    <td style="font-size: 0.85rem; color: #6c757d;">${highlights}</td>
                `;
                tbody.appendChild(row);
            });
            
            // Add AI analysis summary if AI algorithm was used
            if (matrixConfig.algorithm === 'ai' && applications.length > 0) {
                const summaryRow = document.createElement('tr');
                summaryRow.style.background = '#f8f9ff';
                summaryRow.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 1rem; border-top: 2px solid #007bff;">
                        <i class="fas fa-robot" style="color: #007bff;"></i>
                        <strong style="color: #007bff;">AI Analysis Complete</strong> - 
                        Analyzed ${applications.length} applications with advanced criteria matching and comparative ranking
                    </td>
                `;
                tbody.appendChild(summaryRow);            }
            
            console.log('Successfully displayed', applications.length, 'applications in preview table');
            console.log('Applicant names displayed:', applications.map(app => app.personalInfo?.fullName || app.fullName || app.name || 'Unknown'));
            console.log('Display process completed using', matrixConfig.algorithm, 'algorithm');
        }
          // View application details (enhanced for AI analysis)
        function viewApplicationDetails(applicationId) {
            // Find the application in the current analyzed data
            const tbody = document.getElementById('previewTableBody');
            const currentApplications = window.lastAnalyzedApplications || [];
            const application = currentApplications.find(app => app.id === applicationId);
            
            if (application && matrixConfig.algorithm === 'ai' && application.aiAnalysis) {
                // Show detailed AI analysis
                const aiAnalysis = application.aiAnalysis;
                const aiInsights = application.aiInsights || [];
                
                let analysisDetails = `🤖 AI ANALYSIS REPORT\n` +
                    `Application ID: ${applicationId}\n` +
                    `Applicant: ${application.personalInfo?.fullName || 'Unknown'}\n\n` +
                    `📊 OVERALL ASSESSMENT\n` +
                    `AI Fit Score: ${aiAnalysis.overallFit}%\n` +
                    `Matrix Score: ${application.matrixScore}%\n` +
                    `Rating: ${application.rating}\n\n`;
                
                if (aiAnalysis.strengthAreas.length > 0) {
                    analysisDetails += `💪 STRENGTH AREAS\n`;
                    aiAnalysis.strengthAreas.forEach(area => {
                        analysisDetails += `• ${area}\n`;
                    });
                    analysisDetails += `\n`;
                }
                
                if (aiAnalysis.weaknessAreas.length > 0) {
                    analysisDetails += `⚠️ AREAS FOR IMPROVEMENT\n`;
                    aiAnalysis.weaknessAreas.forEach(area => {
                        analysisDetails += `• ${area}\n`;
                    });
                    analysisDetails += `\n`;
                }
                
                if (aiAnalysis.uniqueFactors.length > 0) {
                    analysisDetails += `🌟 UNIQUE QUALIFICATIONS\n`;
                    aiAnalysis.uniqueFactors.forEach(factor => {
                        analysisDetails += `• ${factor}\n`;
                    });
                    analysisDetails += `\n`;
                }
                
                if (aiInsights.length > 0) {
                    analysisDetails += `🔍 AI INSIGHTS\n`;
                    aiInsights.forEach(insight => {
                        analysisDetails += `${insight}\n`;
                    });
                    analysisDetails += `\n`;
                }
                
                if (application.competitiveRanking) {
                    analysisDetails += `🏆 COMPETITIVE ANALYSIS\n`;
                    analysisDetails += `Competitive Score: ${Math.round(application.competitiveRanking)}%\n`;
                    analysisDetails += `Relative Performance: Above average candidate pool\n\n`;
                }
                
                analysisDetails += `📋 RECOMMENDATION\n`;
                if (application.matrixScore >= 85) {
                    analysisDetails += `Highly recommended for immediate interview. Excellent match across all criteria.`;
                } else if (application.matrixScore >= 70) {
                    analysisDetails += `Recommended for interview. Strong candidate with good potential.`;
                } else if (application.matrixScore >= 50) {
                    analysisDetails += `Consider for interview. Average candidate with some gaps to address.`;
                } else {
                    analysisDetails += `Not recommended at this time. Significant gaps in required criteria.`;
                }
                
                alert(analysisDetails);
            } else {
                // Standard application details view
                alert(`Viewing details for application: ${applicationId}\n\nThis would open the detailed application view.\n\n${matrixConfig.algorithm === 'ai' ? 'AI analysis data not available.' : 'Switch to AI algorithm for enhanced analysis.'}`);
            }
        }// Load analytics data
        function loadAnalytics() {
            // Check if a job is selected
            if (!selectedJobId) {
                document.getElementById('totalAnalyzed').textContent = '0';
                document.getElementById('excellentCandidates').textContent = '0';
                document.getElementById('averageScore').textContent = '0%';
                document.getElementById('rejectedCount').textContent = '0';
                return;
            }

            // Load applications from company scope: companies/{companyId}/jobs/{jobId}/applications
            const companyInfo = window.getCompanyInfo ? window.getCompanyInfo() : null;
            const currentCompanyId = companyInfo?.id || window.authManager?.currentUser?.companyId || window.authManager?.userCompanyId;
            
            if (!currentCompanyId) {
                console.log('No company context available for analytics');
                document.getElementById('totalAnalyzed').textContent = '0';
                document.getElementById('excellentCandidates').textContent = '0';
                document.getElementById('averageScore').textContent = '0%';
                document.getElementById('rejectedCount').textContent = '0';
                return;
            }
            
            const applicationsRef = database.ref(`companies/${currentCompanyId}/jobs/${selectedJobId}/applications`);
            applicationsRef.once('value', (snapshot) => {
                const applicationsData = snapshot.val();
                
                console.log('Analytics - Applications data for job:', selectedJobId, 'in company:', currentCompanyId, applicationsData);
                
                if (!applicationsData) {
                    document.getElementById('totalAnalyzed').textContent = '0';
                    document.getElementById('excellentCandidates').textContent = '0';
                    document.getElementById('averageScore').textContent = '0%';
                    document.getElementById('rejectedCount').textContent = '0';
                    return;
                }
                
                // Convert to array and analyze
                const applications = Object.keys(applicationsData).map(id => ({
                    id,
                    ...applicationsData[id]
                }));
                
                // Analyze applications for analytics
                const analyzedApplications = analyzeApplications(applications);
                
                // Calculate analytics
                const totalAnalyzed = analyzedApplications.length;
                const excellentCandidates = analyzedApplications.filter(app => app.rating === 'Excellent').length;
                const rejectedCount = analyzedApplications.filter(app => app.matrixScore < matrixConfig.thresholds.average).length;
                const averageScore = totalAnalyzed > 0 ? 
                    Math.round(analyzedApplications.reduce((sum, app) => sum + app.matrixScore, 0) / totalAnalyzed) : 0;
                  // Update UI
                document.getElementById('totalAnalyzed').textContent = totalAnalyzed.toString();
                document.getElementById('excellentCandidates').textContent = excellentCandidates.toString();
                document.getElementById('averageScore').textContent = averageScore + '%';
                document.getElementById('rejectedCount').textContent = rejectedCount.toString();
                
                // Generate chart data and create chart
                generateCandidateDistributionChart(analyzedApplications);
                
                console.log('Analytics calculated from company scope:', {
                    totalAnalyzed,
                    excellentCandidates,
                    averageScore,
                    rejectedCount
                });
                
            }).catch((error) => {
                console.error('Error loading analytics from company scope:', error);
                // Show zeros on error
                document.getElementById('totalAnalyzed').textContent = '0';
                document.getElementById('excellentCandidates').textContent = '0';
                document.getElementById('averageScore').textContent = '0%';
                document.getElementById('rejectedCount').textContent = '0';
            });
        }        // Save matrix configuration
        function saveMatrix() {
            // Check if a job is selected
            if (!selectedJobId) {
                alert('Please select a job first before saving the matrix configuration.');
                return;
            }

            // Validate percentage total
            if (!validateTotalPercentage()) {
                const allCriteria = [
                    ...matrixConfig.criteria.skills || [],
                    ...matrixConfig.criteria.education || [],
                    ...matrixConfig.criteria.personal || []
                ].filter(criteria => criteria.enabled);

                const currentTotal = allCriteria.reduce((sum, criteria) => sum + (criteria.weight || 0), 0);
                
                alert(`Cannot save matrix: Total percentage is ${currentTotal}%. Please adjust criteria percentages to equal exactly 100%.`);
                return;
            }

            // Validate sub-percentages for criteria in sub-percentage mode
            const invalidSubPercentages = [];
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            allCriteria.forEach(criteria => {
                if (criteria.subPercentages && criteria.subPercentages.length > 0) {
                    const subTotal = criteria.subPercentages.reduce((sum, sub) => sum + (sub.percentage || 0), 0);
                    if (subTotal !== 100) {
                        invalidSubPercentages.push(`${criteria.name}: ${subTotal}%`);
                    }
                }
            });

            if (invalidSubPercentages.length > 0) {
                alert(`Cannot save matrix: The following criteria have sub-percentages that don't total 100%:\n\n${invalidSubPercentages.join('\n')}\n\nPlease adjust the keyword percentages within each criteria to equal exactly 100%.`);
                return;
            }
            
            // Get company ID from AuthManager
            const companyInfo = window.getCompanyInfo ? window.getCompanyInfo() : null;
            const currentCompanyId = companyInfo?.id || window.authManager?.currentUser?.companyId || window.authManager?.userCompanyId;
            
            if (!currentCompanyId) {
                alert('Error: No company context available. Please ensure you are logged in.');
                return;
            }
            
            console.log('💾 Saving matrix configuration to job scope:', selectedJobId, 'in company:', currentCompanyId);
            
            // Prepare matrix configuration to save to company scope
            const matrixConfigToSave = {
                criteria: matrixConfig.criteria,
                algorithm: matrixConfig.algorithm,
                thresholds: matrixConfig.thresholds,
                lastUpdated: Date.now(),
                updatedBy: window.authManager?.currentUser?.uid || 'unknown',
                isPublished: true // Mark as published
            };
            
            // Save matrix configuration to companies/{companyId}/jobs/{jobId}/matrixHRConfig
            const jobMatrixRef = database.ref(`companies/${currentCompanyId}/jobs/${selectedJobId}/matrixHRConfig`);
            jobMatrixRef.set(matrixConfigToSave).then(() => {
                alert('HR Matrix configuration saved successfully for the selected job!');
                console.log('✅ Matrix saved for job:', selectedJobId, 'in company:', currentCompanyId);
                showSuccessMessage('Matrix configuration published successfully!');
            }).catch((error) => {
                console.error('Error saving matrix to job:', error);
                alert('Error saving configuration. Please try again.');
            });
        }

        // Save as draft
        function saveAsDraft() {
            // Check if a job is selected
            if (!selectedJobId) {
                alert('Please select a job first before saving the matrix configuration as draft.');
                return;
            }
            
            // Get company ID from AuthManager
            const companyInfo = window.getCompanyInfo ? window.getCompanyInfo() : null;
            const currentCompanyId = companyInfo?.id || window.authManager?.currentUser?.companyId || window.authManager?.userCompanyId;
            
            if (!currentCompanyId) {
                alert('Error: No company context available. Please ensure you are logged in.');
                return;
            }
            
            console.log('💾 Saving matrix configuration as draft to job scope:', selectedJobId, 'in company:', currentCompanyId);
            
            // Prepare matrix configuration for draft
            const draftConfigToSave = {
                criteria: matrixConfig.criteria,
                algorithm: matrixConfig.algorithm,
                thresholds: matrixConfig.thresholds,
                lastUpdated: Date.now(),
                updatedBy: window.authManager?.currentUser?.uid || 'unknown',
                isDraft: true
            };
            
            // Save draft to companies/{companyId}/jobs/{jobId}/matrixHRConfigDraft
            const jobDraftRef = database.ref(`companies/${currentCompanyId}/jobs/${selectedJobId}/matrixHRConfigDraft`);
            jobDraftRef.set(draftConfigToSave).then(() => {
                alert('Configuration saved as draft for the selected job!');
                console.log('✅ Draft saved for job:', selectedJobId, 'in company:', currentCompanyId);
                showSuccessMessage('Matrix configuration saved as draft!');
            }).catch((error) => {
                console.error('Error saving draft to job:', error);
                alert('Error saving draft. Please try again.');
            });
        }// Load matrix configuration from Firebase
        // Save matrix configuration to job scope within company
        function saveMatrixConfig() {
            // Check if a job is selected
            if (!selectedJobId) {
                alert('Please select a job first before saving matrix configuration.');
                return;
            }
            
            const companyInfo = window.getCompanyInfo ? window.getCompanyInfo() : null;
            const currentCompanyId = companyInfo?.id || window.authManager?.currentUser?.companyId || window.authManager?.userCompanyId;
            
            if (!currentCompanyId) {
                alert('Error: No company context available. Please ensure you are logged in.');
                return;
            }
            
            // Validate configuration before saving
            if (!validateMatrixConfig()) {
                return;
            }
            
            console.log('💾 Saving matrix configuration to job scope:', selectedJobId, 'in company:', currentCompanyId);
            
            const configToSave = {
                criteria: matrixConfig.criteria,
                algorithm: matrixConfig.algorithm,
                thresholds: matrixConfig.thresholds,
                lastUpdated: Date.now(),
                updatedBy: window.authManager?.currentUser?.uid || 'unknown'
            };
            
            // Save to companies/{companyId}/jobs/{jobId}/matrixHRConfig
            const jobMatrixRef = database.ref(`companies/${currentCompanyId}/jobs/${selectedJobId}/matrixHRConfig`);
            
            jobMatrixRef.set(configToSave)
                .then(() => {
                    console.log('✅ Matrix configuration saved successfully for job:', selectedJobId);
                    showSuccessMessage('Matrix configuration saved for this job successfully!');
                })
                .catch((error) => {
                    console.error('❌ Error saving matrix configuration:', error);
                    alert('Error saving configuration: ' + error.message);
                });
        }
        
        // Validate matrix configuration before saving
        function validateMatrixConfig() {
            // Check if there are any enabled criteria
            const allCriteria = [
                ...matrixConfig.criteria.skills || [],
                ...matrixConfig.criteria.education || [],
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);
            
            if (allCriteria.length === 0) {
                alert('Please add and enable at least one criteria before saving.');
                return false;
            }
            
            // Check if total percentage equals 100%
            const totalPercentage = allCriteria.reduce((sum, criteria) => sum + (criteria.weight || 0), 0);
            if (totalPercentage !== 100) {
                if (!confirm(`Total percentage is ${totalPercentage}% (not 100%). Do you want to save anyway?`)) {
                    return false;
                }
            }
            
            // Check if all criteria have names and keywords
            for (const criteria of allCriteria) {
                if (!criteria.name || criteria.name.trim() === '') {
                    alert('All criteria must have a name. Please check your criteria.');
                    return false;
                }
                if (!criteria.keywords || criteria.keywords.trim() === '') {
                    if (!confirm(`Criteria "${criteria.name}" has no keywords. Do you want to save anyway?`)) {
                        return false;
                    }
                }
            }
            
            return true;
        }
        
        // Clear existing criteria from UI
        function clearExistingCriteria() {
            const containers = ['skillsCriteria', 'educationCriteria', 'personalCriteria'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                }
            });
        }
        
        // Rebuild criteria from loaded configuration
        function rebuildCriteriaFromConfig() {
            // Store original criteria before clearing
            const originalCriteria = {
                skills: [...(matrixConfig.criteria.skills || [])],
                education: [...(matrixConfig.criteria.education || [])],
                personal: [...(matrixConfig.criteria.personal || [])]
            };
            
            // Clear the config arrays first before rebuilding
            matrixConfig.criteria = { skills: [], education: [], personal: [] };
            
            // Rebuild skills criteria
            if (originalCriteria.skills && originalCriteria.skills.length > 0) {
                originalCriteria.skills.forEach(criteria => {
                    addCriteriaCard('skills', criteria);
                });
            }
            
            // Rebuild education criteria
            if (originalCriteria.education && originalCriteria.education.length > 0) {
                originalCriteria.education.forEach(criteria => {
                    addCriteriaCard('education', criteria);
                });
            }
            
            // Rebuild personal criteria
            if (originalCriteria.personal && originalCriteria.personal.length > 0) {
                originalCriteria.personal.forEach(criteria => {
                    addCriteriaCard('personal', criteria);
                });
            }
        }
        
        // Show success message
        function showSuccessMessage(message) {
            // Create a temporary success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s ease;
            `;
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function loadMatrixConfig() {
            // Only load configuration if a job is selected
            if (!selectedJobId) {
                console.log('📝 No job selected, using default configuration');
                return;
            }
            
            // Load matrix configuration from job scope within company if available
            const companyInfo = window.getCompanyInfo ? window.getCompanyInfo() : null;
            const currentCompanyId = companyInfo?.id || window.authManager?.currentUser?.companyId || window.authManager?.userCompanyId;
            
            if (currentCompanyId) {
                console.log('🔄 Loading matrix configuration from job scope:', selectedJobId, 'in company:', currentCompanyId);
                
                // First try to load published configuration
                const jobMatrixRef = database.ref(`companies/${currentCompanyId}/jobs/${selectedJobId}/matrixHRConfig`);
                
                jobMatrixRef.once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // Load saved configuration from job
                        matrixConfig = {
                            criteria: data.criteria || { skills: [], education: [], personal: [] },
                            algorithm: data.algorithm || 'percentage',
                            thresholds: data.thresholds || { excellent: 85, good: 70, average: 50 }
                        };
                        
                        console.log('✅ Matrix configuration loaded from job scope (published):', matrixConfig);
                        
                        // Clear existing UI and rebuild with loaded config
                        clearExistingCriteria();
                        rebuildCriteriaFromConfig();
                        updateUIWithMatrixConfig();
                        
                    } else {
                        // If no published config, try to load draft
                        console.log('📝 No published config found, checking for draft...');
                        const jobDraftRef = database.ref(`companies/${currentCompanyId}/jobs/${selectedJobId}/matrixHRConfigDraft`);
                        
                        jobDraftRef.once('value', (draftSnapshot) => {
                            const draftData = draftSnapshot.val();
                            if (draftData) {
                                // Load draft configuration
                                matrixConfig = {
                                    criteria: draftData.criteria || { skills: [], education: [], personal: [] },
                                    algorithm: draftData.algorithm || 'percentage',
                                    thresholds: draftData.thresholds || { excellent: 85, good: 70, average: 50 }
                                };
                                
                                console.log('✅ Matrix configuration loaded from job scope (draft):', matrixConfig);
                                
                                // Clear existing UI and rebuild with loaded config
                                clearExistingCriteria();
                                rebuildCriteriaFromConfig();
                                updateUIWithMatrixConfig();
                                
                                // Show draft indicator
                                showSuccessMessage('Draft configuration loaded for this job');
                                
                            } else {
                                console.log('📝 No saved matrix configuration found for this job, using defaults');
                                // Use default configuration - this will be set by initializeDefaultCriteria
                            }
                        }).catch((error) => {
                            console.error('❌ Error loading draft configuration from job:', error);
                        });
                    }
                }).catch((error) => {
                    console.error('❌ Error loading matrix configuration from job:', error);
                });
            } else {
                console.log('⚠️ No company context available, using default configuration');
            }
        }        // Load matrix configuration for a specific job
        function loadJobMatrixConfig(jobId) {
            if (!jobId) {
                console.log('No job selected, using default matrix configuration');
                return;
            }
            
            // First check for published configuration
            const jobMatrixRef = database.ref(`jobs/${jobId}/hrMatrix`);
            jobMatrixRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    matrixConfig = {
                        criteria: data.criteria || { skills: [], education: [], personal: [] },
                        algorithm: data.algorithm || 'weighted',
                        thresholds: data.thresholds || { excellent: 85, good: 70, average: 50 }
                    };
                    
                    // Update UI with loaded configuration
                    updateUIWithMatrixConfig();
                    console.log('Matrix configuration loaded for job:', jobId, matrixConfig);
                } else {
                    console.log('No published matrix configuration found for job:', jobId);
                    // Check for draft configuration
                    loadJobMatrixDraft(jobId);
                }
            }).catch((error) => {
                console.error('Error loading matrix configuration for job:', jobId, error);
                // Try loading draft as fallback
                loadJobMatrixDraft(jobId);
            });
        }

        // Load draft matrix configuration for a specific job
        function loadJobMatrixDraft(jobId) {
            if (!jobId) return;
            
            const jobDraftRef = database.ref(`jobs/${jobId}/hrMatrixDraft`);
            jobDraftRef.once('value', (snapshot) => {
                const draftData = snapshot.val();
                if (draftData && draftData.isDraft) {
                    if (confirm('A draft configuration exists for this job. Would you like to load it?')) {
                        matrixConfig = {
                            criteria: draftData.criteria || { skills: [], education: [], personal: [] },
                            algorithm: draftData.algorithm || 'weighted',
                            thresholds: draftData.thresholds || { excellent: 85, good: 70, average: 50 }
                        };
                        
                        // Update UI with loaded draft configuration
                        updateUIWithMatrixConfig();
                        console.log('Draft configuration loaded for job:', jobId, matrixConfig);
                    }
                }
            }).catch((error) => {
                console.error('Error loading draft configuration for job:', jobId, error);
            });
        }

        // Update UI with matrix configuration
        function updateUIWithMatrixConfig() {
            // Update algorithm selection
            document.querySelectorAll('.algorithm-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.algorithm === matrixConfig.algorithm) {
                    card.classList.add('selected');
                }
            });
            
            // Update threshold inputs
            Object.entries(matrixConfig.thresholds).forEach(([threshold, value]) => {
                const input = document.getElementById(`${threshold}Threshold`);
                if (input) {
                    input.value = value;
                }
            });
            
            // Update reject threshold
            updateRejectThreshold();
        }

        // Manual job refresh function for testing
        function refreshJobsList() {
            console.log('Manually refreshing jobs list...');
            availableJobs = [];
            loadJobsFromFirebase();
        }        // Add this function to global scope for testing
        window.refreshJobsList = refreshJobsList;
        window.testJobData = () => {
            console.log('Current available jobs:', availableJobs);
            console.log('Job selector element:', document.getElementById('jobSelector'));
        };        // Modal functions
        function openApplicationModal(application) {
            console.log('Opening modal for application:', application);
            
            const modal = document.getElementById('applicationModal');
            const modalApplicantName = document.getElementById('modalApplicantName');
            const modalApplicantEmail = document.getElementById('modalApplicantEmail');
            const modalScore = document.getElementById('modalScore');
            const modalRating = document.getElementById('modalRating');
            const modalAIFit = document.getElementById('modalAIFit');
            const modalAIFitValue = document.getElementById('modalAIFitValue');
            const modalCriteriaBreakdown = document.getElementById('modalCriteriaBreakdown');
            const modalAIInsights = document.getElementById('modalAIInsights');
            const modalAIInsightsList = document.getElementById('modalAIInsightsList');

            // Extract applicant name with same logic as in displayScoredApplications
            let fullName = 'Unknown Applicant';
            if (application.personalInfo?.fullName && application.personalInfo.fullName.trim()) {
                fullName = application.personalInfo.fullName.trim();
            } else if (application.fullName && application.fullName.trim()) {
                fullName = application.fullName.trim();
            } else if (application.name && application.name.trim()) {
                fullName = application.name.trim();
            } else if (application.applicantName && application.applicantName.trim()) {
                fullName = application.applicantName.trim();
            } else if (application.personalInfo?.firstName && application.personalInfo.firstName.trim()) {
                const lastName = application.personalInfo?.lastName?.trim() || '';
                fullName = `${application.personalInfo.firstName.trim()} ${lastName}`.trim();
            }

            const email = application.personalInfo?.email || 
                         application.email || 
                         application.contactEmail || 
                         'Email Not Available';

            // Populate modal content
            modalApplicantName.textContent = fullName;
            modalApplicantEmail.textContent = email;
            modalScore.textContent = application.matrixScore + '%';
            modalRating.textContent = application.rating;
            modalRating.className = 'score-rating status-badge ' + application.rating.toLowerCase().replace(' ', '-');

            // Show AI fit if available
            if (matrixConfig.algorithm === 'ai' && application.aiAnalysis) {
                modalAIFit.style.display = 'block';
                modalAIFitValue.textContent = application.aiAnalysis.overallFit + '%';
            } else {
                modalAIFit.style.display = 'none';
            }

            // Populate all analysis tabs
            populateOverviewTab(application);
            populateDetailedAnalysisTab(application);
            populateRawDataTab(application);

            // Show AI insights if available
            if (matrixConfig.algorithm === 'ai' && application.aiInsights && application.aiInsights.length > 0) {
                modalAIInsights.style.display = 'block';
                modalAIInsightsList.innerHTML = '';
                application.aiInsights.forEach(insight => {
                    const insightItem = document.createElement('div');
                    insightItem.className = 'ai-insight-item';
                    insightItem.textContent = insight;
                    modalAIInsightsList.appendChild(insightItem);
                });
            } else {
                modalAIInsights.style.display = 'none';
            }

            // Show modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeApplicationModal() {
            const modal = document.getElementById('applicationModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        function switchAnalysisTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.analysis-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.analysis-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Analysis').classList.add('active');
        }

        function populateOverviewTab(application) {
            const container = document.getElementById('modalCriteriaBreakdown');
            populateCriteriaBreakdown(application, container);
        }

        function populateDetailedAnalysisTab(application) {
            populateDetailedScoring(application);
            populateKeywordMatching(application);
            
            if (matrixConfig.algorithm === 'ai') {
                populateAIAlgorithmDetails(application);
            }
        }

        function populateRawDataTab(application) {
            populateRawApplicationData(application);
            populateCalculationSteps(application);
        }

        function populateDetailedScoring(application) {
            const container = document.getElementById('detailedScoringBreakdown');
            container.innerHTML = '';
            
            // Get all enabled criteria
            const allCriteria = [
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            if (allCriteria.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No criteria configured</p>';
                return;
            }

            allCriteria.forEach(criteria => {
                const criteriaDetail = document.createElement('div');
                criteriaDetail.className = 'criteria-detail';
                
                // Calculate detailed scores
                const rawScore = evaluateCriteria(application, criteria);
                const maxScore = criteria.weight || 0;
                const normalizedScore = maxScore > 0 ? (rawScore / maxScore) * 100 : 0;
                
                // Get text sources for analysis
                const textSources = extractTextSources(application);
                const matchingResults = analyzeKeywordMatches(textSources, criteria.keywords);
                
                criteriaDetail.innerHTML = `
                    <div class="criteria-detail-header">
                        <span class="criteria-detail-name">${criteria.name}</span>
                        <span class="criteria-detail-score">${rawScore.toFixed(2)}/${maxScore} (${normalizedScore.toFixed(1)}%)</span>
                    </div>
                    <div class="criteria-calculation">
                        <strong>Keywords:</strong> ${criteria.keywords}<br>
                        <strong>Weight:</strong> ${criteria.weight}%<br>
                        <strong>Raw Score:</strong> ${rawScore.toFixed(2)}<br>
                        <strong>Calculation:</strong> (${rawScore.toFixed(2)} / ${maxScore}) × 100 = ${normalizedScore.toFixed(1)}%<br>
                        <strong>Weighted Score:</strong> ${normalizedScore.toFixed(1)}% × ${criteria.weight}% = ${(normalizedScore * criteria.weight / 100).toFixed(2)}%
                    </div>
                    <div style="margin-top: 0.75rem;">
                        <strong>Matches Found:</strong><br>
                        ${matchingResults.matches.length > 0 ? 
                            matchingResults.matches.map(match => `<span style="color: #28a745;">✓ ${match}</span>`).join('<br>') :
                            '<span style="color: #dc3545;">No matches found</span>'
                        }
                    </div>
                `;
                
                container.appendChild(criteriaDetail);
            });
        }

        function populateKeywordMatching(application) {
            const container = document.getElementById('keywordMatchingDetails');
            container.innerHTML = '';
            
            const allCriteria = [
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            const textSources = extractTextSources(application);
            const combinedText = Object.values(textSources).join(' ').toLowerCase();

            allCriteria.forEach(criteria => {
                const keywordSection = document.createElement('div');
                keywordSection.style.marginBottom = '1.5rem';
                
                const keywords = criteria.keywords.toLowerCase().split(',').map(k => k.trim()).filter(k => k);
                let matchingHtml = `<h4 style="margin-bottom: 0.75rem; color: #495057;">${criteria.name}</h4>`;
                
                keywords.forEach(keyword => {
                    const isFound = combinedText.includes(keyword);
                    const contexts = findKeywordContexts(combinedText, keyword, 30);
                    
                    matchingHtml += `
                        <div class="keyword-match">
                            <span class="keyword-text">"${keyword}"</span>
                            <span class="${isFound ? 'keyword-found' : 'keyword-not-found'}">
                                ${isFound ? '✓ Found' : '✗ Not Found'}
                            </span>
                        </div>
                    `;
                    
                    if (isFound && contexts.length > 0) {
                        matchingHtml += `<div style="font-size: 0.85rem; color: #6c757d; margin: 0.5rem 0; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">`;
                        contexts.forEach(context => {
                            matchingHtml += `<div style="margin-bottom: 0.25rem;">"...${context}..."</div>`;
                        });
                        matchingHtml += `</div>`;
                    }
                });
                
                keywordSection.innerHTML = matchingHtml;
                container.appendChild(keywordSection);
            });
        }

        function populateAIAlgorithmDetails(application) {
            const container = document.getElementById('aiAlgorithmDetails');
            const detailsContainer = document.getElementById('aiAlgorithmBreakdown');
            
            if (!application.aiAnalysis) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const aiAnalysis = application.aiAnalysis;
            
            detailsContainer.innerHTML = `
                <div class="ai-analysis-section">
                    <h4 style="color: #495057; margin-bottom: 1rem;">AI Analysis Components</h4>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <strong>Overall Fit Score:</strong> ${aiAnalysis.overallFit}%<br>
                        <small style="color: #6c757d;">Calculated from skills, experience, and education alignment</small>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <strong>Strength Areas:</strong><br>
                        ${aiAnalysis.strengthAreas.length > 0 ? 
                            aiAnalysis.strengthAreas.map(area => `<span class="ai-strength-area">${area}</span>`).join('') :
                            '<span style="color: #6c757d;">No specific strengths identified</span>'
                        }
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <strong>Weakness Areas:</strong><br>
                        ${aiAnalysis.weaknessAreas.length > 0 ? 
                            aiAnalysis.weaknessAreas.map(area => `<span class="ai-weakness-area">${area}</span>`).join('') :
                            '<span style="color: #28a745;">No significant weaknesses identified</span>'
                        }
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <strong>Unique Factors:</strong><br>
                        ${aiAnalysis.uniqueFactors.length > 0 ? 
                            aiAnalysis.uniqueFactors.map(factor => `<span class="ai-unique-factor">${factor}</span>`).join('') :
                            '<span style="color: #6c757d;">No unique factors identified</span>'
                        }
                    </div>
                </div>
            `;
        }

        function populateRawApplicationData(application) {
            const container = document.getElementById('rawApplicationData');
            
            // Create a clean view of the application data
            const cleanData = {
                personalInfo: application.personalInfo || {},
                technicalSkills: application.technicalSkills || '',
                experience: application.experience || '',
                education: application.education || '',
                matrixScore: application.matrixScore,
                rating: application.rating,
                keyHighlights: application.keyHighlights || '',
                aiAnalysis: application.aiAnalysis || null,
                aiInsights: application.aiInsights || []
            };
            
            container.innerHTML = `
                <div class="raw-data-content">
${JSON.stringify(cleanData, null, 2)}
                </div>
            `;
        }

        function populateCalculationSteps(application) {
            const container = document.getElementById('calculationSteps');
            container.innerHTML = '';
            
            const allCriteria = [
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            let totalScore = 0;
            let stepNumber = 1;
            
            // Step 1: Individual criteria calculations
            allCriteria.forEach(criteria => {
                const rawScore = evaluateCriteria(application, criteria);
                const weightedScore = rawScore;
                totalScore += weightedScore;
                
                const step = document.createElement('div');
                step.className = 'calculation-step';
                step.innerHTML = `
                    <div class="step-title">Step ${stepNumber}: ${criteria.name} Calculation</div>
                    <div class="step-calculation">
                        Keywords: "${criteria.keywords}"
                        Weight: ${criteria.weight}%
                        Raw Score: ${rawScore.toFixed(2)}
                        Weighted Score: ${weightedScore.toFixed(2)}
                    </div>
                    <div class="step-result">Result: ${weightedScore.toFixed(2)} points</div>
                `;
                container.appendChild(step);
                stepNumber++;
            });
            
            // Final step: Total score calculation
            const finalStep = document.createElement('div');
            finalStep.className = 'calculation-step';
            finalStep.innerHTML = `
                <div class="step-title">Step ${stepNumber}: Final Score Calculation</div>
                <div class="step-calculation">
                    Total Raw Score: ${totalScore.toFixed(2)}
                    Final Percentage: ${application.matrixScore}%
                    Rating: ${application.rating}
                </div>
                <div class="step-result">Final Score: ${application.matrixScore}%</div>
            `;
            container.appendChild(finalStep);
        }

        function extractTextSources(application) {
            return {
                personalInfo: JSON.stringify(application.personalInfo || {}),
                technicalSkills: application.technicalSkills || '',
                experience: application.experience || '',
                education: application.education || '',
                workExperience: JSON.stringify(application.workExperience || []),
                educationDetails: JSON.stringify(application.educationDetails || []),
                skills: JSON.stringify(application.skills || [])
            };
        }

        function analyzeKeywordMatches(textSources, keywords) {
            const keywordList = keywords.toLowerCase().split(',').map(k => k.trim()).filter(k => k);
            const combinedText = Object.values(textSources).join(' ').toLowerCase();
            
            const matches = keywordList.filter(keyword => combinedText.includes(keyword));
            const misses = keywordList.filter(keyword => !combinedText.includes(keyword));
            
            return { matches, misses, total: keywordList.length };
        }

        function findKeywordContexts(text, keyword, contextLength = 30) {
            const contexts = [];
            const regex = new RegExp(`.{0,${contextLength}}\\b${keyword}\\b.{0,${contextLength}}`, 'gi');
            let match;
            
            while ((match = regex.exec(text)) !== null && contexts.length < 3) {
                contexts.push(match[0].trim());
            }
            
            return contexts;
        }

        function populateCriteriaBreakdown(application, container) {
            container.innerHTML = '';
            
            // Get all enabled criteria
            const allCriteria = [
                ...matrixConfig.criteria.personal || []
            ].filter(criteria => criteria.enabled);

            if (allCriteria.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">No criteria configured</p>';
                return;
            }

            allCriteria.forEach(criteria => {
                // Calculate individual criteria score
                const criteriaScore = evaluateCriteria(application, criteria);
                const maxScore = criteria.weight || 0;
                const percentage = maxScore > 0 ? Math.round((criteriaScore / maxScore) * 100) : 0;

                const criteriaItem = document.createElement('div');
                criteriaItem.className = 'criteria-item';
                
                criteriaItem.innerHTML = `
                    <div class="criteria-name">
                        <strong>${criteria.name}</strong>
                        <br><small style="color: #6c757d;">Weight: ${criteria.weight}%</small>
                    </div>
                    <div class="criteria-score">
                        <div class="criteria-bar">
                            <div class="criteria-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                        <span class="criteria-percentage">${criteriaScore.toFixed(1)}/${maxScore}</span>
                    </div>
                `;
                
                container.appendChild(criteriaItem);
            });
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('applicationModal');
            if (event.target === modal) {
                closeApplicationModal();
            }
        });        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeApplicationModal();
            }
        });

        // Chart functionality
        let candidateChart = null;
        let currentChartType = 'pie';

        function generateCandidateDistributionChart(applications) {
            if (applications.length === 0) {
                updateChartStats({ excellent: 0, good: 0, average: 0, belowAverage: 0 });
                return;
            }

            // Calculate distribution by rating
            const distribution = {
                excellent: applications.filter(app => app.rating === 'Excellent').length,
                good: applications.filter(app => app.rating === 'Good').length,
                average: applications.filter(app => app.rating === 'Average').length,
                belowAverage: applications.filter(app => app.rating === 'Below Average').length
            };

            // Create chart data
            const chartData = {
                labels: ['Excellent', 'Good', 'Average', 'Below Average'],
                datasets: [{
                    data: [distribution.excellent, distribution.good, distribution.average, distribution.belowAverage],
                    backgroundColor: [
                        '#28a745', // Green for Excellent
                        '#007bff', // Blue for Good
                        '#ffc107', // Yellow for Average
                        '#dc3545'  // Red for Below Average
                    ],
                    borderColor: [
                        '#1e7e34',
                        '#0056b3',
                        '#e0a800',
                        '#c82333'
                    ],
                    borderWidth: 2,
                    hoverOffset: 4
                }]
            };

            createChart(chartData);
            updateChartStats(distribution);
        }

        function createChart(chartData) {
            const ctx = document.getElementById('candidateDistributionChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (candidateChart) {
                candidateChart.destroy();
            }

            const config = {
                type: currentChartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: currentChartType === 'bar' ? 'top' : 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: currentChartType === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    } : {}
                }
            };

            candidateChart = new Chart(ctx, config);
        }

        function switchChartType(type) {
            currentChartType = type;
            
            // Update active button
            document.querySelectorAll('.chart-toggle').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Recreate chart with new type if we have data
            if (candidateChart) {
                const chartData = candidateChart.data;
                createChart(chartData);
            }
        }

        function updateChartStats(distribution) {
            const total = distribution.excellent + distribution.good + distribution.average + distribution.belowAverage;
            const statsContainer = document.getElementById('chartStats');
            
            statsContainer.innerHTML = `
                <div class="chart-stat">
                    <div class="chart-stat-number" style="color: #28a745;">${distribution.excellent}</div>
                    <div class="chart-stat-label">Excellent Candidates</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-number" style="color: #007bff;">${distribution.good}</div>
                    <div class="chart-stat-label">Good Candidates</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-number" style="color: #ffc107;">${distribution.average}</div>
                    <div class="chart-stat-label">Average Candidates</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-number" style="color: #dc3545;">${distribution.belowAverage}</div>
                    <div class="chart-stat-label">Below Average</div>
                </div>
                <div class="chart-stat">
                    <div class="chart-stat-number" style="color: #2c3e50;">${total}</div>
                    <div class="chart-stat-label">Total Candidates</div>
                </div>
            `;
        }
    </script>    <!-- Application Details Modal -->
    <div id="applicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-user-circle"></i>
                    <span id="modalApplicantName">Applicant Details</span>
                </h2>
                <p class="modal-subtitle" id="modalApplicantEmail"></p>
                <button class="modal-close" onclick="closeApplicationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="score-overview">
                    <div class="score-circle">
                        <span class="score-value" id="modalScore">0%</span>
                    </div>
                    <div class="score-rating" id="modalRating">Loading...</div>
                    <div id="modalAIFit" style="display: none;">
                        <small style="color: #007bff;">
                            <i class="fas fa-robot"></i> AI Fit: <span id="modalAIFitValue">0%</span>
                        </small>
                    </div>
                </div>

                <!-- Algorithm Analysis Tabs -->
                <div class="analysis-tabs">
                    <button class="analysis-tab active" onclick="switchAnalysisTab('overview')">
                        <i class="fas fa-chart-pie"></i> Overview
                    </button>
                    <button class="analysis-tab" onclick="switchAnalysisTab('detailed')">
                        <i class="fas fa-calculator"></i> Detailed Analysis
                    </button>
                    <button class="analysis-tab" onclick="switchAnalysisTab('raw-data')">
                        <i class="fas fa-database"></i> Raw Data
                    </button>
                </div>

                <!-- Overview Tab -->
                <div id="overviewAnalysis" class="analysis-content active">
                    <div class="criteria-breakdown">
                        <div class="criteria-breakdown-header">
                            <i class="fas fa-chart-bar"></i>
                            Criteria Breakdown
                        </div>
                        <div id="modalCriteriaBreakdown">
                            <!-- Criteria details will be populated here -->
                        </div>
                    </div>

                    <div id="modalAIInsights" class="ai-insights" style="display: none;">
                        <div class="ai-insights-header">
                            <i class="fas fa-robot"></i>
                            AI Analysis Insights
                        </div>
                        <div id="modalAIInsightsList">
                            <!-- AI insights will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis Tab -->
                <div id="detailedAnalysis" class="analysis-content">
                    <div class="detailed-scoring">
                        <div class="scoring-section">
                            <div class="scoring-header">
                                <i class="fas fa-microscope"></i>
                                Complete Algorithm Analysis
                            </div>
                            <div id="detailedScoringBreakdown">
                                <!-- Detailed scoring will be populated here -->
                            </div>
                        </div>
                        
                        <div class="keyword-matching">
                            <div class="scoring-header">
                                <i class="fas fa-search"></i>
                                Keyword Matching Analysis
                            </div>
                            <div id="keywordMatchingDetails">
                                <!-- Keyword matching details will be populated here -->
                            </div>
                        </div>

                        <div id="aiAlgorithmDetails" class="ai-algorithm-details" style="display: none;">
                            <div class="scoring-header">
                                <i class="fas fa-robot"></i>
                                AI Algorithm Details
                            </div>
                            <div id="aiAlgorithmBreakdown">
                                <!-- AI algorithm details will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Raw Data Tab -->
                <div id="rawDataAnalysis" class="analysis-content">
                    <div class="raw-data-section">
                        <div class="scoring-header">
                            <i class="fas fa-code"></i>
                            Application Raw Data
                        </div>
                        <div id="rawApplicationData">
                            <!-- Raw application data will be populated here -->
                        </div>
                    </div>
                    
                    <div class="calculation-steps">
                        <div class="scoring-header">
                            <i class="fas fa-list-ol"></i>
                            Step-by-Step Calculation
                        </div>
                        <div id="calculationSteps">
                            <!-- Calculation steps will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Embedded Notification Manager (from notifications.js) -->
    <script>
        class NotificationManager {
            constructor() {
                this.notifications = this.loadNotifications();
                this.settings = this.loadSettings();
                this.firebaseInitialized = false;
                this.firebaseListener = null;
                
                this.initializeNotifications();
                this.initializePermissions();
                this.initializeSettings();
                this.initializeFirebase();
            }

            initializePermissions() {
                this.updateSettingsAccessibility();
                window.addEventListener('roleChanged', () => {
                    this.updateSettingsAccessibility();
                });
            }

            updateSettingsAccessibility() {
                const hasEditPermission = window.roleManager?.hasPermission('notification_settings_view', 'edit');
                
                const notifySubmitter = document.getElementById('notifySubmitter');
                const notifyApprovers = document.getElementById('notifyApprovers');
                const notifyOnComplete = document.getElementById('notifyOnComplete');
                const saveButton = document.getElementById('saveNotificationSettings');
                
                [notifySubmitter, notifyApprovers, notifyOnComplete].forEach(checkbox => {
                    if (checkbox) {
                        checkbox.disabled = !hasEditPermission;
                    }
                });

                if (saveButton) {
                    saveButton.style.display = hasEditPermission ? '' : 'none';
                }
            }

            initializeSettings() {
                const form = document.getElementById('notificationSettingsForm');
                if (!form) return;

                Object.entries(this.settings).forEach(([key, value]) => {
                    const input = form[key];
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = value;
                        } else {
                            input.value = value;
                        }
                    }
                });

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveSettings(form);
                });
            }

            loadSettings() {
                const defaultSettings = {
                    emailNotifications: true,
                    notifySubmitter: true,
                    notifyApprovers: true,
                    notifyOnComplete: true,
                    systemUpdates: true,
                    securityAlerts: true,
                    notificationDisplay: '30',
                    showReadNotifications: true
                };

                const savedSettings = localStorage.getItem('notificationSettings');
                return savedSettings ? JSON.parse(savedSettings) : defaultSettings;
            }

            saveSettings(form) {
                const settings = {};
                Array.from(form.elements).forEach(input => {
                    if (input.name && input.type !== 'submit') {
                        settings[input.name] = input.type === 'checkbox' ? input.checked : input.value;
                    }
                });

                this.settings = settings;
                localStorage.setItem('notificationSettings', JSON.stringify(settings));

                this.addNotification({
                    type: 'Success',
                    message: 'Notification settings saved successfully.'
                });

                this.renderNotifications();
            }

            initializeNotifications() {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        this.setupNotificationElements();
                    });
                } else {
                    this.setupNotificationElements();
                }
            }

            setupNotificationElements() {
                const notificationBtn = document.getElementById('notificationBtn');
                if (notificationBtn) {
                    notificationBtn.addEventListener('click', () => {
                        const dropdown = document.querySelector('.notification-dropdown');
                        if (dropdown) {
                            dropdown.classList.toggle('show');
                        }
                    });
                }

                const markAllReadBtn = document.querySelector('.mark-all-read');
                if (markAllReadBtn) {
                    markAllReadBtn.addEventListener('click', () => {
                        this.markAllAsRead();
                    });
                }

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.notifications')) {
                        const dropdown = document.querySelector('.notification-dropdown');
                        if (dropdown) {
                            dropdown.classList.remove('show');
                        }
                    }
                });

                this.updateNotificationBadge();
                this.renderNotifications();
                this.startPeriodicBadgeUpdate();
                this.setupStorageSync();
                this.addSampleNotificationsIfEmpty();
            }

            setupStorageSync() {
                window.addEventListener('storage', (e) => {
                    if (e.key === 'notifications') {
                        this.notifications = this.loadNotifications();
                        this.updateNotificationBadge();
                        this.renderNotifications();
                    }
                });
            }

            startPeriodicBadgeUpdate() {
                setInterval(() => {
                    this.updateNotificationBadge();
                }, 30000);
            }

            addSampleNotificationsIfEmpty() {
                if (this.notifications.length === 0) {
                    this.addNotification({
                        type: 'System Update',
                        message: 'Welcome to the HSE Management System! Your dashboard is ready to use.'
                    });
                    
                    this.addNotification({
                        type: 'Approval Required',
                        message: 'New safety training request requires your review.'
                    });
                    
                    this.addNotification({
                        type: 'Reminder',
                        message: 'Monthly safety inspection is due next week.'
                    });
                }
            }

            loadNotifications() {
                const notifications = localStorage.getItem('notifications');
                return notifications ? JSON.parse(notifications) : [];
            }

            saveNotifications() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
                
                setTimeout(() => {
                    this.updateNotificationBadge();
                }, 10);
                
                this.renderNotifications();
            }

            addNotification(notification) {
                const newNotification = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    read: false,
                    ...notification
                };

                this.notifications.unshift(newNotification);
                this.saveNotifications();

                if (this.settings.emailNotifications && 
                    (notification.type === 'Approval Required' || 
                     notification.type === 'Security Alert' ||
                     notification.type === 'System Update')) {
                    this.sendEmailNotification(newNotification);
                }
            }

            markAsRead(notificationId) {
                const notification = this.notifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                    this.saveNotifications();
                }
            }

            markAllAsRead() {
                this.notifications.forEach(notification => {
                    notification.read = true;
                });
                this.saveNotifications();
            }

            deleteNotification(notificationId) {
                this.notifications = this.notifications.filter(n => n.id !== notificationId);
                this.saveNotifications();
            }

            updateNotificationBadge() {
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    const userNotifications = this.getUserNotifications();
                    const unreadCount = userNotifications.filter(n => !n.read).length;
                    badge.textContent = unreadCount.toString();
                    
                    if (unreadCount > 0) {
                        badge.style.display = 'inline-block';
                        badge.setAttribute('data-count', unreadCount);
                    } else {
                        badge.style.display = 'none';
                        badge.removeAttribute('data-count');
                    }
                } else {
                    setTimeout(() => {
                        const retryBadge = document.querySelector('.notification-badge');
                        if (retryBadge) {
                            const userNotifications = this.getUserNotifications();
                            const unreadCount = userNotifications.filter(n => !n.read).length;
                            retryBadge.textContent = unreadCount.toString();
                            
                            if (unreadCount > 0) {
                                retryBadge.style.display = 'inline-block';
                                retryBadge.setAttribute('data-count', unreadCount);
                            } else {
                                retryBadge.style.display = 'none';
                                retryBadge.removeAttribute('data-count');
                            }
                        }
                    }, 100);
                }
            }

            getUserNotifications() {
                const currentUser = window.authManager?.currentUser;
                if (!currentUser) {
                    return this.notifications;
                }

                return this.notifications.filter(notification => {
                    if (!notification.recipientUserId && !notification.recipientEmail) {
                        return true;
                    }
                    
                    if (notification.recipientUserId === currentUser.uid) {
                        return true;
                    }
                    
                    if (notification.recipientEmail === currentUser.email) {
                        return true;
                    }
                    
                    if (notification.type === 'Success' || 
                        notification.type === 'System Update' || 
                        notification.type === 'Info') {
                        return true;
                    }
                    
                    return false;
                });
            }

            renderNotifications() {
                const notificationList = document.querySelector('.notification-list');
                if (!notificationList) return;

                notificationList.innerHTML = '';

                let filteredNotifications = this.getUserNotifications();
                
                const daysToShow = parseInt(this.settings.notificationDisplay);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysToShow);
                
                filteredNotifications = filteredNotifications.filter(notification => 
                    new Date(notification.timestamp) > cutoffDate
                );

                if (!this.settings.showReadNotifications) {
                    filteredNotifications = filteredNotifications.filter(n => !n.read);
                }

                if (filteredNotifications.length === 0) {
                    notificationList.innerHTML = '<div class="notification-item">No notifications</div>';
                    return;
                }

                filteredNotifications.forEach(notification => {
                    const notificationElement = document.createElement('div');
                    notificationElement.className = `notification-item ${notification.read ? 'read' : 'unread'}`;
                    
                    const date = new Date(notification.timestamp);
                    const timeString = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                    notificationElement.innerHTML = `
                        <div class="notification-header">
                            <span class="notification-type">${notification.type}</span>
                            <span class="notification-time">${timeString}</span>
                        </div>
                        <div class="notification-content">${notification.message}</div>
                    `;

                    notificationElement.addEventListener('click', () => {
                        this.markAsRead(notification.id);
                        if (notification.link) {
                            window.location.href = notification.link;
                        }
                    });

                    notificationList.appendChild(notificationElement);
                });
            }

            sendEmailNotification(notification) {
                console.log('Sending email notification:', notification);
            }

            async initializeFirebase() {
                try {
                    if (window.auth && window.db) {
                        this.setupFirebaseListener();
                    } else {
                        setTimeout(() => this.initializeFirebase(), 1000);
                    }
                } catch (error) {
                    console.error('Error initializing Firebase for notifications:', error);
                }
            }

            async setupFirebaseListener() {
                if (!window.authManager?.currentUser || this.firebaseListener) return;

                try {
                    const notificationsRef = firebase.database().ref('notifications');
                    
                    this.firebaseListener = notificationsRef.on('value', (snapshot) => {
                        if (snapshot.exists()) {
                            const firebaseNotifications = [];
                            snapshot.forEach((childSnapshot) => {
                                const notification = {
                                    firebaseId: childSnapshot.key,
                                    ...childSnapshot.val()
                                };
                                firebaseNotifications.push(notification);
                            });
                            
                            this.mergeFirebaseNotifications(firebaseNotifications);
                        }
                    });
                    
                    this.firebaseInitialized = true;
                } catch (error) {
                    console.error('Error setting up Firebase listener:', error);
                }
            }

            mergeFirebaseNotifications(firebaseNotifications) {
                const currentUser = window.authManager?.currentUser;
                if (!currentUser) return;

                const userFirebaseNotifications = firebaseNotifications.filter(notification => {
                    if (notification.recipientUserId === currentUser.uid) return true;
                    if (notification.recipientEmail === currentUser.email) return true;
                    if (!notification.recipientUserId && !notification.recipientEmail) return true;
                    return false;
                });

                const convertedNotifications = userFirebaseNotifications.map(fbNotification => ({
                    id: fbNotification.firebaseId ? `fb_${fbNotification.firebaseId}` : Date.now(),
                    timestamp: fbNotification.createdAt || new Date().toISOString(),
                    read: fbNotification.status === 'read',
                    type: fbNotification.type || 'Info',
                    message: fbNotification.message || fbNotification.title || 'New notification',
                    link: fbNotification.link,
                    firebaseId: fbNotification.firebaseId,
                    recipientUserId: fbNotification.recipientUserId,
                    recipientEmail: fbNotification.recipientEmail,
                    title: fbNotification.title
                }));

                const mergedNotifications = [...this.notifications];
                
                convertedNotifications.forEach(fbNotification => {
                    const existingIndex = mergedNotifications.findIndex(n => 
                        n.firebaseId === fbNotification.firebaseId || n.id === fbNotification.id
                    );
                    
                    if (existingIndex >= 0) {
                        mergedNotifications[existingIndex] = fbNotification;
                    } else {
                        mergedNotifications.unshift(fbNotification);
                    }
                });

                mergedNotifications.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                this.notifications = mergedNotifications;
                this.saveNotifications();
            }

            cleanup() {
                if (this.firebaseListener && window.db) {
                    try {
                        firebase.database().ref('notifications').off('value', this.firebaseListener);
                    } catch (error) {
                        console.error('Error cleaning up Firebase listener:', error);
                    }
                }
            }
        }

        // Initialize notification manager
        const notificationManager = new NotificationManager();
        window.notificationManager = notificationManager;

        // Monitor authentication state changes
        if (window.authManager) {
            // AuthManager is available, use it for authentication monitoring
            const checkAuthState = () => {
                if (window.authManager.currentUser && !notificationManager.firebaseInitialized) {
                    notificationManager.initializeFirebase();
                } else if (!window.authManager.currentUser && notificationManager.firebaseListener) {
                    notificationManager.cleanup();
                    notificationManager.firebaseInitialized = false;
                }
            };
            
            // Check initial state
            checkAuthState();
            
            // Monitor for changes (check periodically since AuthManager doesn't emit events)
            setInterval(checkAuthState, 1000);
        } else if (window.auth) {
            // Fallback to Firebase auth monitoring
            window.auth.onAuthStateChanged((user) => {
                if (user && !notificationManager.firebaseInitialized) {
                    notificationManager.initializeFirebase();
                } else if (!user && notificationManager.firebaseListener) {
                    notificationManager.cleanup();
                    notificationManager.firebaseInitialized = false;
                }
            });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (notificationManager) {
                notificationManager.cleanup();
            }
        });

        window.addEventListener('load', () => {
            if (window.notificationManager) {
                window.notificationManager.updateNotificationBadge();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (window.notificationManager) {
                setTimeout(() => {
                    window.notificationManager.updateNotificationBadge();
                }, 100);
            }
        });
    </script>

    <!-- Empty common-components.js embedded (file was empty) -->
    <script>
        // Empty common-components.js content (file was empty)
    </script>

</body>
</html>

