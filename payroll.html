<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Payroll Management - Dreamex Datalab</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<!-- Firebase v8 Scripts for Centralized Authentication -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<style>
:root { --primary-color:#2c3e50; --secondary-color:#34495e; --accent-color:#e74c3c; --success-color:#27ae60; --warning-color:#f39c12; --info-color:#3498db; --light-color:#ecf0f1; --dark-color:#2c3e50; --sidebar-width:250px; --transition-speed:.25s; --primary:#2c3e50; --secondary:#3498db; --accent:#667eea; --danger:#e74c3c; --bg:#f5f6fa; --border:#e2e8f0; --radius:10px; --green:#16a34a; }
* { box-sizing:border-box; margin:0; padding:0; }
body { font-family: 'Segoe UI', Arial, sans-serif; background:#f5f7fa; color:#222; }
.app-container { display:flex; min-height:100vh; }
.sidebar { width:var(--sidebar-width); background:var(--primary-color); color:#fff; padding:1rem; position:fixed; top:0; left:0; bottom:0; overflow-y:auto; transition:transform .3s ease; z-index:1000; }
.sidebar.collapsed { transform:translateX(-100%); }
.main-content { flex:1; margin-left:var(--sidebar-width); padding:0.3rem; padding-top:3.2rem; transition:margin-left .3s ease; }
.main-content.sidebar-collapsed { margin-left:0; }
.main-content.sidebar-collapsed .top-nav { left:0.5rem; }
.logo h2 { text-align:center; padding:1rem 0; border-bottom:1px solid rgba(255,255,255,0.1); font-size:1.05rem; letter-spacing:.5px; }
.menu { list-style:none; margin-top:2rem; }
.menu li { margin-bottom:0.45rem; }
.menu a { display:flex; align-items:center; gap:10px; color:#fff; text-decoration:none; padding:0.6rem 0.75rem; border-radius:6px; font-size:0.82rem; font-weight:500; transition:background .25s; }
.menu a:hover, .menu a.active { background:rgba(255,255,255,0.12); }
.submenu { list-style:none; margin-left:0.75rem; display:none; margin-top:0.25rem; }
.menu-dropdown:hover .submenu { display:block; }
.submenu a { font-size:0.75rem; padding:0.45rem 0.65rem; }
[data-feature]:not(.menu-visible) { display:none !important; }
.menu-dropdown:not(.menu-visible) { display:none !important; }

/* Hide ALL menu items by default during loading */
.sidebar.menu-loading .menu-item,
.sidebar.menu-loading .menu-dropdown,
.sidebar.menu-loading li[data-feature],
.sidebar.menu-loading [data-feature] {
    display: none !important;
}

/* Allow menu-visible items to show even during loading */
.sidebar.menu-loading .menu-visible,
.sidebar.menu-loading li.menu-visible,
.sidebar.menu-loading [data-feature].menu-visible {
    display: block !important;
}

.menu-loading [data-feature] {
    display: none !important;
}

.menu-loading .menu-dropdown {
    display: none !important;
}

/* Ensure menu-visible items are always shown */
.menu-visible {
    display: block !important;
}

li.menu-visible,
[data-feature].menu-visible {
    display: block !important;
}
.top-nav { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0.75rem; background-color:#fff; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:0.3rem; position:fixed; top:0.25rem; right:0.5rem; left:calc(var(--sidebar-width) + 0.5rem); height:50px; min-height:50px; z-index:100; transition:left 0.3s ease; }
.sidebar-toggle-btn { background:none; border:none; cursor:pointer; font-size:1.1rem; padding:0.4rem; color:#555; }
.top-nav-left { display:flex; align-items:center; gap:0.75rem; }
.company-branding { display:flex; align-items:center; gap:0.5rem; }
#headerCompanyLogo { width:32px; height:32px; object-fit:contain; display:none; }
#headerCompanyName { font-weight:600; font-size:0.85rem; }
.header-company-logo { height:32px; width:auto; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
.company-name-header { font-weight:700; color:var(--dark-color); font-size:1rem; letter-spacing:0.5px; white-space:nowrap; }
.top-nav-right { display:flex; align-items:center; gap:1rem; }
.notifications { position:relative; display:flex; align-items:center; }
.notification-btn { background:none; border:none; cursor:pointer; position:relative; font-size:1.2rem; padding:0.5rem; display:flex; align-items:center; justify-content:center; }
.notification-badge { position:absolute; top:-5px; right:-5px; background-color:var(--accent-color); color:white; border-radius:50%; padding:0.2rem 0.5rem; font-size:0.7rem; display:none; }
.notification-dropdown { display:none; position:absolute; right:0; top:100%; width:320px; background:#fff; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); z-index:1000; border:1px solid #e9ecef; max-height:400px; overflow:hidden; }
.notification-dropdown.show { display:block; animation: slideDown 0.2s ease-out; }
@keyframes slideDown { from { opacity:0; transform:translateY(-10px);} to { opacity:1; transform:translateY(0);} }
.notification-header { padding:12px 16px; border-bottom:1px solid #e9ecef; background:linear-gradient(135deg,#f8f9fa 0%, #e9ecef 100%); display:flex; justify-content:space-between; align-items:center; }
.notification-header h3 { margin:0; color:#333; font-size:14px; font-weight:600; }
.mark-all-read { background:none; border:none; color:#3498db; cursor:pointer; font-size:12px; padding:4px 8px; border-radius:4px; transition:all .2s ease; }
.mark-all-read:hover { background:#e3f2fd; color:#1976d2; }
.clear-all-notifications { background:none; border:none; color:#e74c3c; cursor:pointer; font-size:12px; padding:4px 8px; border-radius:4px; transition:all .2s ease; margin-left:8px; }
.clear-all-notifications:hover { background:#fdf2f2; color:#c0392b; }
.notification-list { max-height:320px; overflow-y:auto; padding:0; }
.notification-list::-webkit-scrollbar { width:4px; }
.notification-list::-webkit-scrollbar-track { background:#f1f1f1; }
.notification-list::-webkit-scrollbar-thumb { background:#c1c1c1; border-radius:2px; }
.notification-item { padding:12px 16px; border-bottom:1px solid #f1f1f1; cursor:pointer; transition:background-color .2s ease; position:relative; }
.notification-item:hover { background:#f8f9fa; }
.notification-item.unread { background:#e8f4fd; border-left:3px solid #3498db; }
.notification-dot { position:absolute; top:16px; right:16px; width:8px; height:8px; background:#3498db; border-radius:50%; }
.notification-actions { position:absolute; top:8px; right:8px; display:none; gap:4px; }
.notification-item:hover .notification-actions { display:flex; }
.mark-read-btn, .delete-notification-btn { background:none; border:none; cursor:pointer; padding:4px; border-radius:3px; transition:all .2s ease; font-size:12px; }
.mark-read-btn { color:#3498db; }
.mark-read-btn:hover { background:#e3f2fd; color:#1976d2; }
.delete-notification-btn { color:#e74c3c; }
.delete-notification-btn:hover { background:#fdf2f2; color:#c0392b; }
.notification-empty { padding:40px 20px; text-align:center; color:#999; display:none; }
.notification-empty i { font-size:32px; margin-bottom:12px; color:#ddd; }
.notification-empty-title { font-size:14px; font-weight:500; margin-bottom:4px; color:#666; }
.notification-empty-message { font-size:12px; color:#999; }
.user-profile { position:relative; }
.profile-btn { background:none; border:none; border-radius:50%; overflow:hidden; width:38px; height:38px; cursor:pointer; }
.profile-btn img { width:100%; height:100%; object-fit:cover; }
.profile-dropdown { display:none; position:absolute; right:0; top:110%; background:#fff; border-radius:8px; min-width:200px; box-shadow:0 6px 18px rgba(0,0,0,0.12); overflow:hidden; z-index:2500; }
.profile-dropdown.show { display:block; }
.profile-dropdown ul { list-style:none; }
.profile-dropdown li a { display:block; padding:0.65rem 0.85rem; font-size:0.72rem; text-decoration:none; color:#1e293b; font-weight:500; }
.profile-dropdown li a:hover { background:#f1f5f9; }
.page-header { 
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); 
    color: #fff; 
    padding: 0.55rem 0.75rem; 
    margin: 0.35rem 0 0.5rem 0; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    box-shadow: 0 10px 28px rgba(0,0,0,0.18), 0 6px 16px rgba(0,0,0,0.14); 
    font-size: 0.9rem; 
}
.page-header h1 { 
    color: #fff; 
    font-size: 0.9rem; 
    display: flex; 
    align-items: center; 
    gap: 0.5rem; 
    letter-spacing: 0.5px; 
    margin: 0; 
    font-weight: 600; 
}
.page-header i { 
    font-size: 1rem; 
}
/* Contractsub-style tab system */
.content-tabs { margin:0 0 0 0; width:100%; }
.tab-navigation { display:flex; background:#fff; border-radius:0; box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom:0; border-bottom:1px solid #e9ecef; }
.tab-nav-btn { flex:1; padding:0.9rem 1.2rem; border:none; background:none; color:#6c757d; font-size:.85rem; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:.55rem; position:relative; transition:all .2s; border-radius:0; }
.tab-nav-btn:hover { color:#007bff; background:#f8f9fa; }
.tab-nav-btn.active { color:#fff; background:#007bff; }
.tab-content { background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.1); padding:1.1rem 1.25rem; display:none; }
.tab-content.active { display:block; }
.container{padding:14px;max-width:1600px;margin:0 auto;}
.panel{display:none;animation:fade .25s ease;}
.panel.active{display:block;}
.btn-add-new {
    background: none;
    border: none;
    color: #fff;
    padding: 0.4rem;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
}
.btn-add-new:hover {
    color: rgba(255,255,255,0.8);
    transform: scale(1.1);
}
.btn-add-new i {
    font-size: 1.2rem;
}
.page-actions { display:flex; gap:0.4rem; flex-wrap:wrap; }
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;margin-bottom:18px;box-shadow:0 2px 6px rgba(0,0,0,.06);} 
.card h2{margin:0 0 14px 0;font-size:1rem;letter-spacing:.5px;text-transform:uppercase;color:#334155;display:flex;align-items:center;gap:8px;}
.grid{display:grid;gap:14px;}
.grid.cols-4{grid-template-columns:repeat(auto-fill,minmax(240px,1fr));}
.grid.cols-3{grid-template-columns:repeat(auto-fill,minmax(280px,1fr));}
fieldset{border:1px solid var(--border);padding:14px 16px;border-radius:8px;min-width:0;}
fieldset legend{font-size:.7rem;letter-spacing:.6px;font-weight:600;text-transform:uppercase;color:#475569;padding:0 6px;}
label{display:flex;flex-direction:column;font-size:.65rem;font-weight:600;letter-spacing:.5px;color:#475569;gap:4px;}
input[type=text],input[type=number],input[type=date],input[type=email],select,textarea{padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:.75rem;background:#fff;resize:vertical;min-height:34px;}
textarea{min-height:70px;}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--secondary);box-shadow:0 0 0 2px rgba(52,152,219,.25);} 
.inline{display:flex;align-items:center;gap:8px;}
.badge{display:inline-block;background:#e2e8f0;color:#334155;font-size:.55rem;font-weight:600;padding:4px 8px;border-radius:14px;letter-spacing:.5px;}
.table-wrapper{overflow:auto;border:1px solid var(--border);border-radius:8px;background:#fff;}
table{width:100%;border-collapse:collapse;font-size:.7rem;}
th,td{padding:8px 10px;border-bottom:1px solid #f1f5f9;text-align:left;vertical-align:top;}
th{background:#f8fafc;font-weight:600;font-size:.6rem;letter-spacing:.5px;text-transform:uppercase;color:#475569;}
tr:last-child td{border-bottom:none;}
.actions{display:flex;gap:6px;flex-wrap:wrap;}
button{cursor:pointer;}
.btn{background:#fff;border:1px solid var(--border);padding:8px 14px;font-size:.65rem;font-weight:600;letter-spacing:.5px;border-radius:6px;display:inline-flex;align-items:center;gap:6px;color:#334155;transition:.2s;}
.btn:hover{background:#f1f5f9;}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;border:none;}
.btn-primary:hover{filter:brightness(.95);} 
.btn-danger{background:var(--danger);color:#fff;border:none;}
.btn-danger:hover{filter:brightness(.9);} 
.btn-green{background:var(--green);color:#fff;border:none;}
.btn-green:hover{filter:brightness(.92);} 
.tag-earning{background:#dcfce7;color:#166534;}
.tag-deduction{background:#fee2e2;color:#991b1b;}
.flex{display:flex;gap:10px;align-items:center;}
.justify-between{justify-content:space-between;}
.wrap{flex-wrap:wrap;}
.small{font-size:.6rem;}
hr{border:none;border-top:1px solid var(--border);margin:18px 0;}
.notice{background:#fef9c3;border:1px solid #fde68a;color:#92400e;padding:10px 12px;border-radius:6px;font-size:.65rem;margin-bottom:14px;display:flex;gap:8px;align-items:flex-start;}
.empty{padding:18px;text-align:center;color:#64748b;font-size:.65rem;}
.table-container { background:#fff; border:1px solid var(--line, #e2e8f0); border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.06); overflow:hidden; margin-top:14px; }
.data-table { width:100%; border-collapse:collapse; font-size:.72rem; min-width:900px; }
.data-table th { background:#f1f5f9; padding:6px 8px; font-size:.65rem; font-weight:600; color:#475569; border-bottom:1px solid var(--line, #e2e8f0); text-align:left; white-space:nowrap; }
.data-table td { padding:6px 8px; font-size:.7rem; color:#334155; border-bottom:1px solid var(--line, #e2e8f0); vertical-align:middle; }
.data-table tbody tr { transition:background .15s; }
.data-table tbody tr:hover { background:#f8fafc; cursor:pointer; box-shadow:none; transform:none; }
.filter-bar{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 12px 0;}
.status-badge{padding:4px 8px;border-radius:16px;font-size:.55rem;font-weight:600;letter-spacing:.5px;background:#e2e8f0;color:#334155;}
.status-posted{background:#dcfce7;color:#166534;}
.status-draft{background:#fee2e2;color:#991b1b;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:3000;display:none;align-items:center;justify-content:center;padding:24px;}
.modal{background:#fff;border-radius:10px;padding:20px 22px;width:100%;max-width:980px;max-height:92vh;overflow:auto;box-shadow:0 10px 36px -4px rgba(0,0,0,.24);}
.modal h3{margin:0 0 14px;font-size:.9rem;letter-spacing:.5px;text-transform:uppercase;}
.close-btn{background:#e2e8f0;border:none;color:#334155;}
.inline-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;}
.inline-chips span{background:#f1f5f9;padding:4px 8px;border-radius:14px;font-size:.55rem;}
.link{color:var(--secondary);cursor:pointer;text-decoration:underline;font-size:.65rem;}
footer{padding:30px 0 40px;font-size:.55rem;text-align:center;color:#94a3b8;}
@keyframes fade{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}
/* Position Details style adaptations for Add Employee Modal */
.employee-modal-wrapper{display:flex;flex-direction:column;gap:1rem;}
.employee-modal-header{background:#ffffff;color:#1e293b;padding:1rem 1.25rem;border-radius:10px;display:flex;flex-direction:column;gap:.35rem;box-shadow:0 2px 6px rgba(0,0,0,0.06);border:1px solid #e2e8f0;} 
.employee-modal-header h3 i{color:var(--secondary-color);} 
.employee-modal-header h3{margin:0;font-size:1rem;text-transform:none;display:flex;align-items:center;gap:.6rem;letter-spacing:.5px;}
.employee-form-sections{display:flex;flex-direction:column;gap:1.25rem;}
.emp-section{background:#f8f9fa;border-radius:10px;padding:1rem 1.1rem;border:1px solid #e2e8f0;position:relative;}
.emp-section{border-left:1px solid #e2e8f0;} /* remove colored vertical bar */
.emp-section h4{margin:0 0 .75rem;font-size:.7rem;letter-spacing:.7px;text-transform:uppercase;color:#334155;display:flex;align-items:center;gap:.5rem;font-weight:700;}
.emp-grid{display:grid;gap:.85rem;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));}
.emp-grid label{font-size:.6rem;text-transform:uppercase;letter-spacing:.6px;font-weight:600;}
.employee-modal-footer{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:flex-end;padding-top:.5rem;}
.employee-modal-footer .btn-primary{display:inline-flex;align-items:center;gap:.45rem;font-size:.65rem;}
.chip{background:#e2e8f0;color:#334155;font-size:.55rem;font-weight:600;padding:4px 8px;border-radius:14px;letter-spacing:.5px;}
.emp-notice{background:#eef6ff;border:1px solid #cfe2ff;color:#1e3a8a;padding:.65rem .75rem;border-radius:8px;font-size:.6rem;line-height:1.3;display:flex;gap:.55rem;align-items:flex-start;}
.emp-divider{height:1px;background:linear-gradient(90deg,rgba(0,0,0,0),#cbd5e1,rgba(0,0,0,0));margin:.5rem 0 0.75rem;}
.employee-modal-wrapper::-webkit-scrollbar{width:8px;}
.employee-modal-wrapper::-webkit-scrollbar-track{background:#f1f5f9;border-radius:10px;}
.employee-modal-wrapper::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px;}
.employee-modal-wrapper::-webkit-scrollbar-thumb:hover{background:#94a3b8;}
.emp-two-col{grid-column:1/-1;display:grid;gap:.85rem;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));}
.emp-section textarea{min-height:60px;}
.employee-modal-close{position:absolute;top:8px;right:8px;background:rgba(255,255,255,.2);color:#fff;border:none;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;backdrop-filter:blur(4px);transition:.2s;}
.employee-modal-close:hover{background:rgba(255,255,255,.35);} 
/* Internal section tabs inside modal */
.emp-tab-nav{display:flex;flex-wrap:wrap;gap:4px;margin:0 0 .6rem 0;border-bottom:1px solid #e2e8f0;padding:0 2px;}
.emp-tab-nav button{background:#f1f5f9;border:1px solid #e2e8f0;border-bottom:none;padding:6px 10px;font-size:.6rem;font-weight:600;letter-spacing:.5px;color:#475569;border-radius:6px 6px 0 0;cursor:pointer;transition:.15s;position:relative;top:1px;}
.emp-tab-nav button:hover{background:#e2e8f0;}
.emp-tab-nav button.active{background:#ffffff;color:#1e293b;box-shadow:0 -1px 3px rgba(0,0,0,0.06);}
.emp-section{display:none;animation:fade .25s ease;}
.emp-section.active{display:block;}

/* Icon-only plain button (used in Pay Element modal) */
.btn-plain-icon{background:transparent;border:1px solid transparent;padding:6px 8px;display:inline-flex;align-items:center;justify-content:center;font-size:.75rem;cursor:pointer;line-height:1;color:var(--primary-color,#1e293b);border-radius:6px;transition:.15s;}

/* ——— UI polish pack (non-breaking, no JS changes) ——— */
/* Smooth interactions for form controls */
input[type=text],input[type=number],input[type=date],input[type=email],select,textarea{
  transition: border-color .15s ease, box-shadow .15s ease, background-color .2s ease;
}
input:hover,select:hover,textarea:hover{ border-color:#cbd5e1; }
input:focus,select:focus,textarea:focus{ border-color:var(--secondary); box-shadow:0 0 0 3px rgba(52,152,219,.20); background:#fff; }

/* Button refinements */
.btn{ box-shadow:0 1px 2px rgba(0,0,0,.04); }
.btn:hover{ transform:translateY(-1px); box-shadow:0 3px 8px rgba(0,0,0,.08); }
.btn:active{ transform:translateY(0); box-shadow:0 1px 2px rgba(0,0,0,.04); }
.btn-primary{ background:linear-gradient(135deg,#2d5be3,#0ea5e9); }

/* Cards and modals */
.card{ border:1px solid #e6eef5; box-shadow:0 6px 20px rgba(0,0,0,.06); }
.modal{ border:1px solid #e6eef5; box-shadow:0 16px 48px rgba(0,0,0,.18); }

/* Tabs */
.tab-nav-btn{ border-bottom:2px solid transparent; }
.tab-nav-btn.active{ background:linear-gradient(135deg,#2d5be3,#0ea5e9); color:#fff; border-bottom-color:transparent; }
.tab-nav-btn:not(.active):hover{ border-bottom-color:#cfe1ff; }

/* Tables */
.table-wrapper thead th{ position:sticky; top:0; z-index:1; }
.data-table tbody tr:nth-child(odd){ background:#fcfdff; }
.data-table tbody tr:hover{ background:#f1f6ff; }
/* Make employee rows clearly clickable */
#employeesTable tbody tr{ transition: background .15s ease; }
#employeesTable tbody tr:hover{ background:#f8fafc; cursor:pointer; }

/* Badges and chips subtle depth */
.badge,.chip{ box-shadow:0 1px 2px rgba(0,0,0,.04); }

/* Scrollbars */
*::-webkit-scrollbar{ width:8px; height:8px; }
*::-webkit-scrollbar-track{ background:#f1f5f9; }
*::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:8px; }
*::-webkit-scrollbar-thumb:hover{ background:#94a3b8; }

/* Maintain same axis for key fields */
#peValueMode,#peAmount,#peTaxable,#peCmpTaxable{ min-height:34px; }
#peValueMode,#peAmount,#peFormula,#peTaxable,#peCmpTaxable,#pePercent,#pePercentBase{ width:100%; }
#peFormula{ line-height:1.2; height:34px; }
/* Ensure calculation row labels align perfectly */
#peModeWrapper,#peAmountWrapper,#peBuilderToggleWrapper,#peTaxableWrapper,#peCmpTaxableWrapper{ display:flex; flex-direction:column; justify-content:flex-end; }
#peModeWrapper > select,#peAmountWrapper > input,#peTaxableWrapper > select,#peCmpTaxableWrapper > select,#peBuilderToggleWrapper > button{ margin-top:2px; }
#peBuilderToggleWrapper > button{ width:100%; height:34px; min-height:34px; padding:0 12px; }
/* Reserve caption height for the Builder toggle column to match label height */
#peBuilderToggleWrapper::before{ content:''; display:block; height:1.1em; margin-bottom:2px; }

/* Dark mode support (respects user preference) */
@media (prefers-color-scheme: dark){
  body{ background:#0f172a; color:#e2e8f0; }
  .sidebar{ background:#0b1220; }
  .top-nav,.tab-navigation,.tab-content,.card,.table-wrapper,.modal{ background:#0f172a; color:#e2e8f0; border-color:#1f2a44; }
  th{ background:#111827; color:#cbd5e1; }
  td{ border-bottom-color:#1f2a44; }
  input[type=text],input[type=number],input[type=date],input[type=email],select,textarea{ background:#0b1220; color:#e2e8f0; border-color:#1f2a44; }
  input:focus,select:focus,textarea:focus{ box-shadow:0 0 0 3px rgba(14,165,233,.25); border-color:#0ea5e9; }
  .btn{ background:#111827; color:#e2e8f0; border-color:#1f2a44; }
  .btn:hover{ background:#0b1220; }
  .data-table tbody tr:hover{ background:#111827; }
}
.btn-plain-icon:hover{background:#f1f5f9;border-color:#e2e8f0;}
.btn-plain-icon:active{background:#e2e8f0;}
.btn-plain-icon i{pointer-events:none;}

</style>
</head>
<body>
<div class="app-container">
	<nav class="sidebar menu-loading" id="sidebar">
		<div class="logo"><h2>Dreamex Datalab</h2></div>
        <ul class="menu" id="roleBasedMenu">
            <li class="menu-item" data-feature="home_view"><a href="index.html"><i class="fas fa-home"></i> Home</a></li>
            <li class="menu-dropdown" data-feature="health_view">
				<a href="#"><i class="fas fa-medkit"></i> Health</a>
				<ul class="submenu">
					<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
					<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
					<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
				<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
				<ul class="submenu">
					<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
					<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
					<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
					<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
					<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
					<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
				<!-- Risk Management (separate section) -->
<li class="menu-dropdown" data-feature="risk_view" data-requires-permission="risk_view">
<a href="#"><i class="fas fa-exclamation-triangle"></i> Risk Management</a>
<ul class="submenu">
<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
<li data-feature="risk_view" data-requires-permission="risk_register_view"><a href="riskreg.html">Risk Register</a></li>
</ul>
</li></ul>
			</li>
            <li class="menu-dropdown" data-feature="investigation_view" data-requires-permission="investigation_view">
				<a href="#"><i class="fas fa-search-plus"></i> Investigation</a>
				<ul class="submenu">
					<li data-feature="investigation_dashboard_view" data-requires-permission="investigation_dashboard_view"><a href="investigation-dashboard.html">Investigation Dashboard</a></li>
					<li data-feature="investigation_list_view" data-requires-permission="investigation_list_view"><a href="investigation-list.html">Investigation List</a></li>
					<li data-feature="create_investigation_view" data-requires-permission="create_investigation_view"><a href="investigation-create.html">Create Investigation</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
				<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
				<ul class="submenu">
                    <li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                    <li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
                    <li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
                    <li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                    <li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                    <li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
                    <li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    <li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
				</ul>
			</li>
      <!-- Workspaces: Catering -->
      <li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
        <a href="#"><i class="fas fa-utensils"></i> Workspaces — Catering</a>
        <ul class="submenu">
          <li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
          <li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
          <li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
          <li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
          <li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
        </ul>
      </li>
            <li class="menu-dropdown" data-feature="environment_view">
				<a href="#"><i class="fas fa-leaf"></i> Environment</a>
				<ul class="submenu">
                    <li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
				<a href="#"><i class="fas fa-lock"></i> Security</a>
				<ul class="submenu">
                    <li data-feature="access_view" data-requires-permission="access_view"><a href="accessboard.html">Access Request</a></li>
                    <li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                    <li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    <li data-feature="security_site_map_view" data-requires-permission="security_site_map_view"><a href="sitemap.html">Security Site Map</a></li>
					<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
					<li data-feature="nfc_view" data-requires-permission="nfc_view"><a href="nfc.html">NFC Card Management</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
				<a href="#"><i class="fas fa-truck"></i> Logistics</a>
				<ul class="submenu">
                    <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
                    <li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
				<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
				<ul class="submenu">
					<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
                    <li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
				</ul>
			</li>
			<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
				<a href="#"><i class="fas fa-users"></i> HR</a>
				<ul class="submenu">
					<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
					<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
					<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
					<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
					<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
					<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
					<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
					<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                    <li data-feature="salary_management_view" data-requires-permission="salary_management_view"><a href="salary.html">Salary Management</a></li>
					<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
					<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
					<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                    <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    <li data-feature="payroll_view" data-requires-permission="payroll_view"><a href="payroll.html" class="active">Payroll</a></li>
				</ul>
			</li>
            <li class="menu-dropdown" data-feature="project_management_section">
                <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                <ul class="submenu">
                    <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html"><i class="fas fa-tachometer-alt"></i> Project Dashboard</a></li>
                    <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html"><i class="fas fa-plus-circle"></i> Create Project</a></li>
                    <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html"><i class="fas fa-list"></i> Project List</a></li>
                    <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html"><i class="fas fa-chart-bar"></i> Project Reports</a></li>
                </ul>
            </li>
            <li class="menu-dropdown" data-feature="inventory_view" data-requires-permission="inventory_view">
                <a href="#"><i class="fas fa-boxes"></i> Inventory Management</a>
                <ul class="submenu">
                    <li data-feature="inventory_dashboard_view" data-requires-permission="inventory_dashboard_view"><a href="inventory-dashboard.html"><i class="fas fa-tachometer-alt"></i> Inventory Dashboard</a></li>
                    <li data-feature="inventory_items_view" data-requires-permission="inventory_items_view"><a href="inventory-items.html"><i class="fas fa-cubes"></i> Items Management</a></li>
                    <li data-feature="inventory_warehouses_view" data-requires-permission="inventory_warehouses_view"><a href="inventory-warehouses.html"><i class="fas fa-warehouse"></i> Warehouses</a></li>
                    <li data-feature="inventory_reservations_view" data-requires-permission="inventory_reservations_view"><a href="inventory-reservations.html"><i class="fas fa-bookmark"></i> Material Reservations</a></li>
                </ul>
            </li>
            <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
            <li class="menu-dropdown" data-feature="settings_view">
				<a href="#"><i class="fas fa-cog"></i> Settings</a>
				<ul class="submenu">
                    <li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
                    <li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                    <li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                    <li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                    <li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
                    <li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                    <li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                    <li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
                    <li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
				</ul>
			</li>
		</ul>
	</nav>
    <main class="main-content" id="mainContent">
        <nav class="top-nav">
            <div class="top-nav-left">
                <button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle Menu"><i class="fas fa-bars"></i></button>
                <div class="company-branding">
                    <img id="headerCompanyLogo" alt="Company Logo" />
                    <span id="headerCompanyName"></span>
                </div>
            </div>
            <div class="top-nav-right">
                <div class="notifications">
                    <button id="notificationBtn" class="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge">0</span>
                    </button>
                    <div class="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <button class="mark-all-read">Mark all as read</button>
                        </div>
                        <div class="notification-list">
                            <!-- Notifications will be dynamically added here -->
                        </div>
                        <div class="notification-empty">
                            <i class="fas fa-inbox"></i>
                            <div class="notification-empty-title">No notifications</div>
                            <div class="notification-empty-message">You're all caught up</div>
                        </div>
                    </div>
                </div>
                <div class="user-profile" style="position:relative;">
                    <button id="userProfileBtn" class="profile-btn"><img src="" alt="User Avatar" /></button>
                    <div class="profile-dropdown"><ul></ul></div>
                </div>
            </div>
        </nav>
		<div class="page-header">
			<h1><i class="fas fa-money-check-dollar"></i> Payroll Management</h1>
            <div class="page-actions">
        <button class="btn-add-new" id="tabAddBtn" title="Add"><i class="fas fa-plus"></i></button>
  <!-- Import button removed per requirement -->
            </div>
		</div>
        <div class="content-tabs">
          <div class="tab-navigation" id="tabNav">
            <button class="tab-nav-btn active" data-tab="employees"><i class="fas fa-id-card"></i><span>Employees</span></button>
            <button class="tab-nav-btn" data-tab="pay-elements"><i class="fas fa-layer-group"></i><span>Pay Elements</span></button>
            <button class="tab-nav-btn" data-tab="pay-run"><i class="fas fa-calculator"></i><span>Pay Runs</span></button>
            <button class="tab-nav-btn" data-tab="payslip-templates"><i class="fas fa-file-invoice-dollar"></i><span>Payslip Templates</span></button>
            <button class="tab-nav-btn" data-tab="rules"><i class="fas fa-sliders"></i><span>Rules</span></button>
            <button class="tab-nav-btn" data-tab="settings"><i class="fas fa-gear"></i><span>Settings</span></button>
          </div>
      <!-- Global Add button moved to page header -->
          <!-- Tab Contents -->
          <div class="tab-content active" id="panel-employees">
    <div class="card" id="employeeFormCard" style="display:none;">
      <h2><i class="fas fa-user-plus"></i> New Employee</h2>
      <div class="notice"><i class="fas fa-circle-info"></i> Capture comprehensive employee master data. Fields marked optional can be filled later. Assign a payslip template to enable correct pay element filtering during payroll.
      </div>
      <form id="employeeForm" class="grid cols-4">
        <fieldset style="grid-column:1/-1;" class="grid cols-4">
          <legend>Personal Information</legend>
          <label>Employee ID
            <input list="employeeIdOptions" type="text" id="empId" placeholder="Select or type" autocomplete="off">
            <datalist id="employeeIdOptions"></datalist>
          </label>
          <label>First Name<input type="text" id="empFirstName" required></label>
          <label>Last Name<input type="text" id="empLastName" required></label>
          <label>Gender<input type="text" id="empGender" placeholder="e.g., Male / Female"></label>
          <label>Date of Birth<input type="date" id="empDob"></label>
          <label>Nationality<input type="text" id="empNationality"></label>
          <label>Marital Status<input type="text" id="empMarital" placeholder="e.g., Single / Married"></label>
          <label>Dependents<input type="number" id="empDependents" min="0" value="0"></label>
          <label style="grid-column:1/-1;">Address<textarea id="empAddress" placeholder="Street, City, State, Country"></textarea></label>
        </fieldset>
        <fieldset class="grid cols-4" style="grid-column:1/-1;">
          <legend>Contact</legend>
          <label>Email<input type="email" id="empEmail"></label>
            <label>Phone<input type="text" id="empPhone"></label>
            <label>City<input type="text" id="empCity"></label>
            <label>Country<input type="text" id="empCountry"></label>
        </fieldset>
        <fieldset class="grid cols-4" style="grid-column:1/-1;">
          <legend>Employment</legend>
          <label>Department<input type="text" id="empDepartment"></label>
          <label>Job Title<input type="text" id="empJobTitle"></label>
          <label>Employment Type<input type="text" id="empEmploymentType" placeholder="e.g., Full-Time / Part-Time"></label>
          <label>Work Location<input type="text" id="empWorkLocation"></label>
          <label>Hire Date<input type="date" id="empHireDate"></label>
          <label>Termination Date<input type="date" id="empTerminationDate"></label>
          <label>Status<input type="text" id="empStatus" placeholder="e.g., Active"></label>
          <label>Manager ID<input type="text" id="empManagerId" placeholder="UID / EmpID"></label>
          <label>Grade<input type="text" id="empGrade"></label>
          <label>Level<input type="text" id="empLevel"></label>
          <label>Pay Frequency<select id="empPayFrequency"><option value="Monthly">Monthly</option><option>Bi-Weekly</option><option>Weekly</option></select></label>
          <label>Basic Salary<input type="number" id="empBasicSalary" step="0.01" value="0"></label>
          <label>Payslip Template<select id="empPayslipTemplate"><option value="">-- Select Template --</option></select></label>
        </fieldset>
        <fieldset class="grid cols-4" style="grid-column:1/-1;">
          <legend>Banking & Statutory</legend>
          <label>Bank Name<input type="text" id="empBankName" placeholder="Full bank name"></label>
          <label>Account Holder Name<input type="text" id="empAccountName" placeholder="Name on account"></label>
          <label>Account Number<input type="text" id="empAccountNumber" placeholder="Local account number"></label>
          <label>Account Type<select id="empAccountType"><option value="">--</option><option>Checking</option><option>Savings</option><option>Current</option><option>Salary</option></select></label>
          <label>IBAN<input type="text" id="empIBAN" placeholder="International Bank Account Number"></label>
          <label>SWIFT/BIC Code<input type="text" id="empSwiftCode" placeholder="Bank Identifier Code"></label>
          <label>Bank Code<input type="text" id="empBankCode" placeholder="National bank code"></label>
          <label>Branch Code<input type="text" id="empBranchCode" placeholder="Branch/Sort code"></label>
          <label>Branch Name<input type="text" id="empBranchName" placeholder="Branch location"></label>
          <label>Routing Number<input type="text" id="empRoutingNumber" placeholder="ABA/ACH routing (US)"></label>
          <label>BSB Code<input type="text" id="empBSBCode" placeholder="Bank-State-Branch (AU)"></label>
          <label>IFSC Code<input type="text" id="empIFSCCode" placeholder="Indian Financial System Code"></label>
          <label>RIB Key<input type="text" id="empRibKey" placeholder="Relevé d'Identité Bancaire"></label>
          <label>Transit Number<input type="text" id="empTransitNumber" placeholder="Transit number (CA)"></label>
          <label>Institution Number<input type="text" id="empInstitutionNumber" placeholder="Institution number (CA)"></label>
          <label>Currency<input type="text" id="empBankCurrency" placeholder="e.g., USD, EUR, GBP" value="USD"></label>
          <label style="grid-column:1/-1;">Bank Address<textarea id="empBankAddress" rows="2" placeholder="Full bank branch address"></textarea></label>
          <label>Tax ID / TIN<input type="text" id="empTaxId" placeholder="Tax Identification Number"></label>
          <label>Social Security #<input type="text" id="empSSN" placeholder="Social Security Number"></label>
          <label>Pension #<input type="text" id="empPension" placeholder="Pension fund number"></label>
          <label>National ID<input type="text" id="empNationalId" placeholder="National identification"></label>
        </fieldset>
        <fieldset class="grid cols-4" style="grid-column:1/-1;">
          <legend>Emergency Contact</legend>
          <label style="grid-column:1/-1;">Notes<textarea id="empNotes" placeholder="Additional remarks / eligibility info"></textarea></label>
        </fieldset>
        <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;">
          <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Save Employee</button>
          <button type="reset" class="btn" id="resetEmpForm"><i class="fas fa-rotate"></i> Reset</button>
        </div>
      </form>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <h2><i class="fas fa-users"></i> Employees</h2>
        <button class="btn-add-new" id="btnAddEmployee" title="Add New Employee"><i class="fas fa-plus"></i></button>
      </div>
      <div class="table-wrapper">
        <table id="employeesTable">
          <thead><tr><th>ID</th><th>Name</th><th>Dept</th><th>Job Title</th><th>Status</th><th></th></tr></thead>
          <tbody id="employeesTbody"><tr><td colspan="6" class="empty">No employees yet</td></tr></tbody>
        </table>
      </div>
    </div>
    </div>
    <div class="tab-content" id="panel-pay-elements">
    <div class="card" id="payElementFormCard" style="display:none;">
      <h2><i class="fas fa-plus-circle"></i> Pay Element</h2>
      <form id="payElementForm" class="grid cols-4">
        <div style="grid-column:1/-1;display:flex;align-items:center;gap:8px;margin:4px 0 8px 0;">
          <i class="fas fa-id-badge" style="color:#64748b;"></i>
          <h3 style="margin:0;color:#334155;font-size:16px;">Identity</h3>
        </div>
        <div class="identity-row" style="grid-column:1/-1;display:flex;gap:8px;align-items:flex-end;flex-wrap:nowrap;">
          <label style="flex:1 1 0;min-width:0;">Code<input type="text" id="peCode" required placeholder="BASIC, HRA, TAX, etc"></label>
          <label style="flex:1 1 0;min-width:0;">Name<input type="text" id="peName" required></label>
          <label style="flex:1 1 0;min-width:0;">Active<select id="peActive"><option value="true">Yes</option><option value="false">No</option></select></label>
          <label style="flex:1 1 0;min-width:0;">Type<select id="peType"><option value="earning">Earning</option><option value="deduction">Deduction</option></select></label>
        </div>
        <!-- Deducted From row (visible only for deduction) -->
        <div id="peDeductRow" style="grid-column:1/-1;display:none;gap:8px;align-items:flex-end;flex-wrap:nowrap;">
          <label id="peDeductFromWrapper" style="flex:2 1 0;min-width:0;align-self:end;">Deducted From
            <div id="peDeductCheckboxes" style="display:flex;gap:12px;align-items:center;margin-top:2px;">
              <label style="display:flex;gap:6px;align-items:center;">
                <input type="checkbox" id="peDeductEmp" checked>
                <span>Employee</span>
              </label>
              <label style="display:flex;gap:6px;align-items:center;">
                <input type="checkbox" id="peDeductCmp">
                <span>Company</span>
              </label>
            </div>
            <!-- Hidden select retains internal API compatibility -->
            <select id="peDeductFrom" style="display:none;">
              <option value="employee">Employee</option>
              <option value="company">Company</option>
              <option value="both">Both (Employee + Company)</option>
            </select>
          </label>
          <label style="flex:1 1 0;min-width:0;visibility:hidden;">&nbsp;</label>
          <label style="flex:1 1 0;min-width:0;visibility:hidden;">&nbsp;</label>
          <label style="flex:1 1 0;min-width:0;visibility:hidden;">&nbsp;</label>
        </div>

        <hr style="grid-column:1/-1;margin:6px 0;" />
        <div style="grid-column:1/-1;display:flex;align-items:center;gap:8px;margin:2px 0 6px 0;">
          <i class="fas fa-calculator" style="color:#64748b;"></i>
          <h3 id="peCalcHeaderTitle" style="margin:0;color:#334155;font-size:16px;">Calculation</h3>
        </div>

        <div style="grid-column:1/-1;display:flex;gap:8px;align-items:flex-end;flex-wrap:nowrap;">
          <label id="peModeWrapper" style="flex:1 1 0;min-width:0;align-self:end;display:flex;flex-direction:column;justify-content:flex-end;">Calculation Mode
            <select id="peValueMode"><option value="amount">Fixed Amount</option><option value="percent">Percentage</option><option value="formula">Formula</option></select>
          </label>
          <label id="peAmountWrapper" style="flex:1 1 0;min-width:0;align-self:end;">Default Amount<input type="number" id="peAmount" step="0.01" value="0"></label>
          <label id="peTaxableWrapper" style="flex:1 1 0;min-width:0;align-self:end;">Taxable<select id="peTaxable"><option value="true">Yes</option><option value="false">No</option></select></label>
          <label id="peBuilderToggleWrapper" style="display:none;flex:1 1 0;min-width:0;align-self:end;">
            <button type="button" class="btn" id="peFormulaToggleBuilder"><i class="fas fa-chevron-down"></i> Show Builder</button>
          </label>
          <label id="peCalcSpacer" style="flex:1 1 0;min-width:0;visibility:hidden;">&nbsp;</label>
        </div>
        <div id="peFormulaBuilderSection" style="display:none;grid-column:1/-1;">
          <div id="peFormulaBuilder" class="formula-builder" style="display:none;margin-top:6px;border:1px solid #e2e8f0;background:linear-gradient(180deg,#fafcff, #f6f8fb);padding:10px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.03);">
            <div style="margin-bottom:8px;">
              <textarea id="peFormula" placeholder="Example: 0.2 * BASIC + MAX(0, HRA - 100)" rows="1" style="height:34px;min-height:34px;resize:none;overflow:auto;width:100%;"></textarea>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
              <button type="button" class="btn" id="peFormulaClear"><i class="fas fa-eraser"></i> Clear</button>
              <button type="button" class="btn" id="peFormulaValidate"><i class="fas fa-check"></i> Validate</button>
              <small style="color:#64748b;">Build your formula using numbers, operators, functions, and pay elements. See the palette below for quick inserts.</small>
            </div>
            <div id="peFormulaTokens" class="tokens" style="display:flex;gap:4px;flex-wrap:wrap;min-height:28px;background:#ffffff;border:1px dashed #cbd5e1;padding:6px;border-radius:8px;"></div>
            <div class="preview" style="margin-top:8px;color:#334155;">
              <small>Preview:</small> <code id="peFormulaPreview" style="background:#ffffff;border:1px solid #e2e8f0;padding:4px 6px;border-radius:6px;display:inline-block;"></code>
            </div>
          </div>
        </div>
        <div id="pePercentRow" style="grid-column:1/-1;display:flex;gap:8px;align-items:flex-end;flex-wrap:nowrap;">
          <label id="pePercentWrapper" style="display:none;flex:1.2 1 0;min-width:0;align-self:end;">Default Percent (%)<input type="number" id="pePercent" step="0.01" value="0" placeholder="e.g. 10 for 10%"></label>
          <label id="pePercentBaseWrapper" style="display:none;flex:1.2 1 0;min-width:0;align-self:end;">Percent Base
            <select id="pePercentBase">
              <option value="basic">Basic</option>
              <option value="gross">Gross</option>
              <option value="net">Net (pre this item)</option>
            </select>
          </label>
        </div>

        <!-- Company Calculation (visible only when Deducted From = Both and Type = Deduction) -->
        <div id="peCompanyCalcContainer" style="grid-column:1/-1;display:none;margin-top:10px;">
          <div style="display:flex;align-items:center;gap:8px;margin:2px 0 6px 0;">
            <i class="fas fa-building" style="color:#64748b;"></i>
            <h3 id="peCmpHeaderTitle" style="margin:0;color:#334155;font-size:14px;">Company Calculation</h3>
          </div>
          <div style="display:flex;gap:8px;align-items:flex-end;flex-wrap:nowrap;">
            <label id="peCmpModeWrapper" style="flex:1 1 0;min-width:0;align-self:end;display:flex;flex-direction:column;justify-content:flex-end;">Calculation Mode
              <select id="peCmpValueMode"><option value="amount">Fixed Amount</option><option value="percent">Percentage</option><option value="formula">Formula</option></select>
            </label>
            <label id="peCmpAmountWrapper" style="flex:1 1 0;min-width:0;align-self:end;">Default Amount<input type="number" id="peCmpAmount" step="0.01" value="0"></label>
            <label id="peCmpTaxableWrapper" style="flex:1 1 0;min-width:0;align-self:end;">Taxable<select id="peCmpTaxable"><option value="true">Yes</option><option value="false">No</option></select></label>
            <!-- Builder toggle mirrors primary section -->
            <label id="peCmpBuilderToggleWrapper" style="display:none;flex:1 1 0;min-width:0;align-self:end;">
              <button type="button" class="btn" id="peCmpFormulaToggleBuilder"><i class="fas fa-chevron-down"></i> Show Builder</button>
            </label>
            <!-- keep columns aligned with a spacer -->
            <label id="peCmpCalcSpacer" style="flex:1 1 0;min-width:0;visibility:hidden;">&nbsp;</label>
          </div>
          <div id="peCmpFormulaBuilderSection" style="display:none;grid-column:1/-1;">
            <div id="peCmpFormulaBuilder" class="formula-builder" style="display:none;margin-top:6px;border:1px solid #e2e8f0;background:linear-gradient(180deg,#fafcff, #f6f8fb);padding:10px;border-radius:10px;box-shadow:0 1px 2px rgba(0,0,0,0.03);">
              <div style="margin-bottom:8px;">
                <textarea id="peCmpFormula" placeholder="Company formula (optional)" rows="1" style="height:34px;min-height:34px;resize:none;overflow:auto;width:100%;"></textarea>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
                <button type="button" class="btn" id="peCmpFormulaClear"><i class="fas fa-eraser"></i> Clear</button>
                <button type="button" class="btn" id="peCmpFormulaValidate"><i class="fas fa-check"></i> Validate</button>
                <small style="color:#64748b;">Build employer formula using numbers, operators, functions, and pay elements.</small>
              </div>
              <div id="peCmpFormulaTokens" class="tokens" style="display:flex;gap:4px;flex-wrap:wrap;min-height:28px;background:#ffffff;border:1px dashed #cbd5e1;padding:6px;border-radius:8px;"></div>
              <div class="preview" style="margin-top:8px;color:#334155;">
                <small>Preview:</small> <code id="peCmpFormulaPreview" style="background:#ffffff;border:1px solid #e2e8f0;padding:4px 6px;border-radius:6px;display:inline-block;"></code>
              </div>
            </div>
          </div>
          <div id="peCmpPercentRow" style="display:flex;gap:8px;align-items:flex-end;flex-wrap:nowrap;">
            <label id="peCmpPercentWrapper" style="display:none;flex:1.2 1 0;min-width:0;align-self:end;">Default Percent (%)<input type="number" id="peCmpPercent" step="0.01" value="0" placeholder="e.g. 10 for 10%"></label>
            <label id="peCmpPercentBaseWrapper" style="display:none;flex:1.2 1 0;min-width:0;align-self:end;">Percent Base
              <select id="peCmpPercentBase">
                <option value="basic">Basic</option>
                <option value="gross">Gross</option>
                <option value="net">Net (pre this item)</option>
              </select>
            </label>
          </div>
        </div>


        <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn-plain-icon" type="submit" title="Save" aria-label="Save"><i class="fas fa-save"></i></button>
          <button class="btn-plain-icon" type="reset" title="Reset" aria-label="Reset"><i class="fas fa-rotate"></i></button>
        </div>
        <input type="hidden" id="peEditingId" />
      </form>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <h2><i class="fas fa-layer-group"></i> Pay Elements</h2>
        <button class="btn-add-new" id="btnAddPayElement" title="Add New Pay Element"><i class="fas fa-plus"></i></button>
      </div>
      <div class="table-wrapper">
        <table id="payElementsTable"><thead><tr><th>Code</th><th>Name</th><th>Type</th><th>Default</th><th>Taxable</th><th>Active</th><th></th></tr></thead><tbody id="payElementsTbody"><tr><td colspan="7" class="empty">No pay elements</td></tr></tbody></table>
      </div>
    </div>
    </div>
    <div class="tab-content" id="panel-pay-run">
    <div class="card" id="payRunSetupCard" style="display:none;">
      <h2><i class="fas fa-calculator"></i> Create Payroll Run</h2>
      <form id="payRunSetup" class="flex wrap" style="gap:16px;align-items:flex-end;">
        <label>Month<select id="runMonth"></select></label>
        <label>Year<select id="runYear"></select></label>
        <label>Include Employees<select id="runEmployeeFilter"><option value="active">Active Only</option><option value="all">All</option></select></label>
        <button class="btn-primary" id="btnLoadRunEmployees" type="button"><i class="fas fa-users"></i> Load Employees</button>
      </form>
      <hr />
      <div id="runEmployeesContainer" class="grid cols-3"></div>
      <div style="margin-top:18px;display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn-green" id="btnGenerateRun" disabled><i class="fas fa-gears"></i> Generate Draft Run</button>
      </div>
    </div>
    <div class="card" id="draftRunCard" style="display:none;">
      <h2><i class="fas fa-file-invoice"></i> Draft Run</h2>
      <div class="table-wrapper">
        <table id="draftRunTable"><thead><tr><th>Employee</th><th>Basic</th><th>Earnings</th><th>Deductions</th><th>Tax</th><th>Net</th><th></th></tr></thead><tbody id="draftRunTbody"></tbody></table>
      </div>
      <div style="display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;">
        <button class="btn-primary" id="btnPostRun"><i class="fas fa-paper-plane"></i> Post Run</button>
        <button class="btn" id="btnDiscardRun"><i class="fas fa-trash"></i> Discard</button>
      </div>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <h2><i class="fas fa-clock-rotate-left"></i> Payroll Runs</h2>
        <button class="btn-add-new" id="btnAddPayRun" title="Create New Payroll Run"><i class="fas fa-plus"></i></button>
      </div>
      <div class="table-wrapper">
        <table id="runsTable"><thead><tr><th>Period</th><th>Employees</th><th>Status</th><th>Created</th><th></th></tr></thead><tbody id="runsTbody"><tr><td colspan="5" class="empty">No runs yet</td></tr></tbody></table>
      </div>
    </div>
    </div>
    <div class="tab-content" id="panel-payslip-templates">
    <div class="card" id="templateFormCard" style="display:none;">
      <h2><i class="fas fa-file-invoice-dollar"></i> Payslip Template</h2>
      <form id="templateForm" class="grid cols-4">
        <label>Template Code (Category)<input type="text" id="tplCode" placeholder="GEN, ENG, SALES" required></label>
        <label>Template Name<input type="text" id="tplName" required></label>
        <label>Description<textarea id="tplDesc" placeholder="Describe purpose, applicability"></textarea></label>
        <fieldset style="grid-column:1/-1;" class="grid cols-4">
          <legend>Earnings Elements</legend>
          <div id="tplEarnings" class="inline-chips" style="grid-column:1/-1;"></div>
        </fieldset>
        <fieldset style="grid-column:1/-1;" class="grid cols-4">
          <legend>Deductions Elements</legend>
          <div id="tplDeductions" class="inline-chips" style="grid-column:1/-1;"></div>
        </fieldset>
        <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn-primary" type="submit"><i class="fas fa-save"></i> Save Template</button>
          <button class="btn" type="reset"><i class="fas fa-rotate"></i> Reset</button>
        </div>
        <input type="hidden" id="tplEditingId" />
      </form>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
        <h2><i class="fas fa-file-lines"></i> Templates</h2>
        <button class="btn-add-new" id="btnAddTemplate" title="Add New Template"><i class="fas fa-plus"></i></button>
      </div>
      <div class="table-wrapper">
  <table id="templatesTable"><thead><tr><th>Code</th><th>Name</th><th>Earnings</th><th>Deductions</th><th>Number</th><th></th></tr></thead><tbody id="templatesTbody"><tr><td colspan="6" class="empty">No templates</td></tr></tbody></table>
      </div>
    </div>
    </div>
    <div class="tab-content" id="panel-rules">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <h2><i class="fas fa-sliders"></i> Rules</h2>
          <button class="btn-add-new" id="btnAddRule" title="Add New Rule"><i class="fas fa-plus"></i></button>
        </div>
        <div class="table-wrapper">
          <table id="rulesTable"><thead><tr><th>Template</th><th>Element</th><th>Condition</th><th>Action</th><th>Active</th><th></th></tr></thead><tbody id="rulesTbody"><tr><td colspan="6" class="empty">No rules</td></tr></tbody></table>
        </div>
      </div>
    </div>
    <div class="tab-content" id="panel-settings">
      <div class="card">
        <h2><i class="fas fa-building"></i> Company Settings</h2>
        <div class="notice"><i class="fas fa-circle-info"></i> Configure company profile, payroll defaults, and bank accounts used for payroll disbursement.</div>
        <div class="grid cols-3" id="companySettingsForm">
          <fieldset>
            <legend>Company Information</legend>
            <div class="grid cols-2">
              <label>Company Name<input type="text" id="csCompanyName"></label>
              <label>Legal Name<input type="text" id="csLegalName"></label>
              <label>Registration No.<input type="text" id="csRegistration"></label>
              <label>Tax ID / TIN<input type="text" id="csTaxId"></label>
              <label style="grid-column:1/-1;">Address<textarea id="csAddress"></textarea></label>
              <label>Country<input type="text" id="csCountry"></label>
            </div>
          </fieldset>
          <fieldset>
            <legend>Payroll Defaults</legend>
            <div class="grid cols-3">
              <label>Default Currency<input type="text" id="csCurrency" placeholder="e.g., USD, EUR" /></label>
              <label>Pay Cycle<select id="csPayCycle"><option value="Monthly">Monthly</option><option value="Bi-Weekly">Bi-Weekly</option><option value="Weekly">Weekly</option></select></label>
              <label>Payday (Day of Month)<input type="number" id="csPayday" min="1" max="31" placeholder="e.g., 25" /></label>
            </div>
          </fieldset>
          <fieldset style="grid-column:1/-1;">
            <legend>Company Bank Accounts</legend>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;">
              <button type="button" class="btn" id="btnOpenBankAccountModal" title="Add Bank Account"><i class="fas fa-plus"></i> Add Bank Account</button>
            </div>
            <div class="table-container" style="margin-top:10px;">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Bank</th><th>Account Name</th><th>Number</th><th>IBAN</th><th>SWIFT</th><th>Type</th><th>Currency</th><th>Branch</th><th>Routing</th><th>Default</th><th>Usage</th><th>Actions</th>
                  </tr>
                </thead>
                <tbody id="csBankAccountsTbody">
                  <tr><td colspan="12" class="empty">No bank accounts added</td></tr>
                </tbody>
              </table>
            </div>
          </fieldset>
          <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:flex-end;">
            <button type="button" class="btn" id="btnResetSettings"><i class="fas fa-rotate"></i> Reset</button>
            <button type="button" class="btn-primary" id="btnSaveSettings"><i class="fas fa-save"></i> Save Settings</button>
          </div>
        </div>
      </div>
    </div>
        </div>
      </div>


<!-- Draft Line Modal (edit earnings/deductions) -->
<div class="modal-backdrop" id="lineModalBackdrop">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <h3><i class="fas fa-pen-to-square"></i> Adjust Pay Lines</h3>
      <button class="btn close-btn" id="closeLineModal"><i class="fas fa-xmark"></i></button>
    </div>
    <div id="lineModalBody" style="display:grid;gap:18px;"></div>
    <div style="margin-top:18px;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn-primary" id="saveLineModal"><i class="fas fa-save"></i> Save Changes</button>
    </div>
  </div>
</div>

  <!-- Generic Entity Modal (Add/Edit Employee, Pay Element, Template, Pay Run Setup) -->
  <div class="modal-backdrop" id="entityModalBackdrop" style="display:none;">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <h3 id="entityModalTitle" style="margin:0;font-size:.85rem;letter-spacing:.5px;text-transform:uppercase;"></h3>
        <button class="btn close-btn" id="closeEntityModal" type="button"><i class="fas fa-xmark"></i></button>
      </div>
      <div id="entityModalBody"></div>
    </div>
  </div>
  
  <!-- Bank Account Modal -->
  <div class="modal-backdrop" id="bankAccountModalBackdrop" style="display:none;">
    <div class="modal" style="max-width:900px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <h3 style="margin:0;"><i class="fas fa-building-columns"></i> Add Company Bank Account</h3>
        <button class="btn close-btn" id="closeBankAccountModal" type="button"><i class="fas fa-xmark"></i></button>
      </div>
      <div id="bankAccountModalBody">
        <div class="grid cols-4">
          <!-- Row 1: Bank & Holder -->
          <label>Bank Name<input type="text" id="baBankName" placeholder="e.g., Ecobank"></label>
          <label>Country<input type="text" id="baCountry" placeholder="e.g., CI"></label>
          <label>Account Name<input type="text" id="baAccountName" placeholder="Holder name"></label>
          <label>Account Type
            <select id="baAccountType">
              <option value="">-- Select --</option>
              <option value="Current">Current</option>
              <option value="Checking">Checking</option>
              <option value="Savings">Savings</option>
              <option value="Other">Other</option>
            </select>
          </label>
          <!-- Row 2: Identifiers -->
          <label>Account Number<input type="text" id="baAccountNumber" placeholder="e.g., 0123456789"></label>
          <label>IBAN<input type="text" id="baIban" placeholder="Optional if Account Number used"></label>
          <label>SWIFT / BIC<input type="text" id="baSwift" placeholder="e.g., ECOCCIAB"></label>
          <label>Currency<input type="text" id="baCurrency" placeholder="e.g., USD"></label>
          <!-- Row 3: Codes & Branch -->
          <label>Bank Code<input type="text" id="baBankCode" placeholder="e.g., Code Banque"></label>
          <label>Branch Code<input type="text" id="baBranchCode" placeholder="e.g., Code Guichet"></label>
          <label>Routing Number<input type="text" id="baRouting" placeholder="ABA / Routing"></label>
          <label>Branch / Address<input type="text" id="baBranch" placeholder="e.g., Plateau Branch"></label>
          <!-- Row 4: Flags -->
          <label>Usage
            <select id="baUsage">
              <option value="Payroll">Payroll</option>
              <option value="Taxes">Taxes / Statutory</option>
              <option value="Vendors">Vendors / Suppliers</option>
              <option value="Other">Other</option>
            </select>
          </label>
          <label style="display:flex;align-items:center;gap:8px;margin-top:8px;">
            <input type="checkbox" id="baIsDefault"> <span>Default Account</span>
          </label>
        </div>
      </div>
      <div style="margin-top:14px;display:flex;gap:10px;justify-content:flex-end;">
        <button type="button" class="btn" id="btnAddBankAccount"><i class="fas fa-plus"></i> Add Account</button>
      </div>
    </div>
  </div>

<script>
/**************** Centralized Auth & Branding (Imported from project-list.html, trimmed) *****************/
// Ensure Firebase initialized (reuse existing config below if already present)
try { if (!window.firebase || !window.firebase.apps || !window.firebase.apps.length) { firebase.initializeApp(firebaseConfig); } } catch(e) {}

class AuthManager {
    constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; this.init(); }
    getCurrentUser(){ try{return JSON.parse(localStorage.getItem('currentUser')||'null');}catch{return null;} }
    setCurrentUser(u){ localStorage.setItem('currentUser',JSON.stringify(u)); localStorage.setItem('user',JSON.stringify(u)); this.currentUser=u; }
    async init(){ if(!this.currentUser){ window.location.href='login.html'; return; } await this.loadUserCompany(); this.updateCompanyBranding(); await this.updateUIForAuthenticatedUser(); this.bindProfileDropdown(); initializeMenuAuthorization?.(); }
    async loadUserCompany(){ if(!this.currentUser) return; try { const snap=await firebase.database().ref('companies').once('value'); if(!snap.exists()) return; const companies=snap.val(); for(const [cid,comp] of Object.entries(companies)){ if(comp.status!=='active') continue; if(comp.users){ for(const [uid,u] of Object.entries(comp.users)){ if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ this.currentUser.companyId=cid; this.currentUser.companyName=comp.companyName; this.currentUser.role=u.role||u.userRole||'user'; this.currentCompany=comp; this.setCurrentUser(this.currentUser); return; } } } } } catch(e){} }
    getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
    generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
    updateCompanyBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(!this.currentCompany){ if(logoEl){ logoEl.src=this.generateCompanyInitialsSVG('DX'); logoEl.classList.add('visible'); } return; } if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logo=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logo){ logoEl.src=logo; logoEl.classList.add('visible'); } else { logoEl.src=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.classList.add('visible'); } } if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color', this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color', this.currentCompany.branding.secondaryColor); }
    }
    getUserDisplayName(){ if(!this.currentUser) return 'User'; const opts=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const o of opts){ if(o && o.trim()) return o.trim(); } if(this.currentUser.email) return this.currentUser.email.split('@')[0]; return 'User'; }
    getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
    async getUserAvatarUrl(){ if(!this.currentUser) return null; const cid=this.currentUser.companyId||'default'; const paths=[`companies/${cid}/avatars/${this.currentUser.uid}/profile.jpg`,`companies/${cid}/avatars/${this.currentUser.uid}/profile.png`,`avatars/${this.currentUser.uid}/profile.jpg`,`avatars/${this.currentUser.uid}/profile.png`]; for(const p of paths){ try{ const ref=firebase.storage().ref(p); return await ref.getDownloadURL(); }catch(e){} } return null; }
  async updateUIForAuthenticatedUser(){
    const btn = document.getElementById('userProfileBtn');
    const list = document.querySelector('.profile-dropdown ul');
    if(!btn || !list || !this.currentUser) return;
    const displayName = this.getUserDisplayName();
    const email = this.currentUser.email || '';
    let avatarUrl = null;
    try { avatarUrl = await this.getUserAvatarUrl(); } catch(e){}
    const btnImg = btn.querySelector('img');
    if(avatarUrl && btnImg){
      btnImg.src = avatarUrl; btnImg.alt = displayName + ' Avatar'; btnImg.style.display='block';
      btnImg.onerror = () => { btnImg.style.display='none'; btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`; };
    } else {
      btn.innerHTML = `<div style="width:38px;height:38px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.8rem;">${this.getUserInitials()}</div>`;
    }
    const avatarHtml = avatarUrl ? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`;
    list.innerHTML = `<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Sign out</a></li>`;
    list.querySelector('#logoutLink')?.addEventListener('click', e=>{ e.preventDefault(); this.logout(); });
  }
  bindProfileDropdown(){
    const btn = document.getElementById('userProfileBtn');
    const dd = document.querySelector('.profile-dropdown');
    if(!btn || !dd) return;
    // Remove any previous global handler (idempotent)
    if(window.__payrollProfileDropdownHandler){
      document.removeEventListener('click', window.__payrollProfileDropdownHandler);
    }
    btn.addEventListener('click', e=>{
      e.preventDefault();
      e.stopPropagation();
      dd.classList.toggle('show');
    });
    window.__payrollProfileDropdownHandler = (e)=>{
      if(e.target.closest('#userProfileBtn') || e.target.closest('.profile-dropdown')) return;
      dd.classList.remove('show');
    };
    document.addEventListener('click', window.__payrollProfileDropdownHandler);
  }
    async logout(){ try{ await firebase.auth().signOut(); }catch(e){} localStorage.removeItem('currentUser'); localStorage.removeItem('user'); window.location.href='login.html'; }
}

// Role-based menu visibility (trimmed)
// ===== Robust Feature + Role Based Authorization (adapted from project-list) =====
let isMenuUpdateInProgress = false;
function resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=>d.classList.remove('menu-visible')); }
function showSidebarAfterAuth(){ const sb=document.querySelector('.sidebar'); sb?.classList.remove('menu-loading'); }
function ensureHomeIsVisible(){ const home=document.querySelector('#roleBasedMenu li[data-feature="home_view"]'); if(home && !home.classList.contains('menu-visible')) home.classList.add('menu-visible'); }
function hideItemsRequiringPermissions(){ const items=document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]'); items.forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(dd=>{ if(!dd.querySelector('.submenu li.menu-visible')) dd.classList.remove('menu-visible'); }); ensureHomeIsVisible(); }
async function applyFeatureBasedMenuVisibility(companyId){ try{ const dbref=firebase.database(); const featuresSnap=await dbref.ref('/platformFeatures').once('value'); if(!featuresSnap.exists()){ resetMenuVisibility(); return []; } const featuresData=featuresSnap.val(); const companySnap=await dbref.ref(`/companies/${companyId}`).once('value'); const companyData=companySnap.val(); if(!companyData){ resetMenuVisibility(); return []; } const subscribedFeatureIds=companyData.selectedFeatures||[]; if(!subscribedFeatureIds.length){ resetMenuVisibility(); return []; } const authorizedPages=[]; subscribedFeatureIds.forEach(fid=>{ const f=featuresData[fid]; if(f && f.status==='active' && f.authorizedPages) authorizedPages.push(...f.authorizedPages); }); resetMenuVisibility(); const authorizedFeatures=new Set(); authorizedPages.forEach(p=>{ if(p.feature) authorizedFeatures.add(p.feature); }); const allItems=document.querySelectorAll('#roleBasedMenu li[data-feature]'); allItems.forEach(item=>{ const f=item.getAttribute('data-feature'); const isDropdown=item.classList.contains('menu-dropdown'); if(isDropdown) return; if(authorizedFeatures.has(f)) item.classList.add('menu-visible'); }); document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(dd=>{ const f=dd.getAttribute('data-feature'); const hasChild=dd.querySelector('.submenu li.menu-visible'); if(hasChild || authorizedFeatures.has(f)) dd.classList.add('menu-visible'); }); return authorizedPages; }catch(e){ console.error('Feature visibility error',e); resetMenuVisibility(); return []; } }
function filterMenuByPermissions(permissions){ const visible=document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]'); visible.forEach(item=>{ const requires=item.getAttribute('data-requires-permission'); const perm=permissions?.[requires]; const allowed=perm===true || (perm && perm.view===true); if(!allowed) item.classList.remove('menu-visible'); }); document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(dd=>{ if(!dd.querySelector('.submenu li.menu-visible')) dd.classList.remove('menu-visible'); }); ensureHomeIsVisible(); showSidebarAfterAuth(); }
async function applyRoleBasedFiltering(companyId, role, authorizedPages){ try{ const dbref=firebase.database(); const snap=await dbref.ref(`companies/${companyId}/roles/${role}/permissions`).once('value'); if(!snap.exists()){ if(role==='administrator'){ ensureHomeIsVisible(); showSidebarAfterAuth(); return; } hideItemsRequiringPermissions(); showSidebarAfterAuth(); return; } const permissions=snap.val(); filterMenuByPermissions(permissions); }catch(e){ console.error('Role filtering error',e); showSidebarAfterAuth(); } }
async function updateMenuWithFeatureAuthorization(){ if(isMenuUpdateInProgress) return; isMenuUpdateInProgress=true; try{ let currentUser = window.authManager?.currentUser || null; let companyId=currentUser?.companyId||null; let role=currentUser?.role||null; if(!companyId && firebase.auth().currentUser){ const user=firebase.auth().currentUser; const companiesSnap=await firebase.database().ref('companies').once('value'); if(companiesSnap.exists()){ const companies=companiesSnap.val(); for(const [cid,comp] of Object.entries(companies)){ if(comp.status!=='active') continue; if(comp.users && comp.users[user.uid]){ companyId=cid; role=comp.users[user.uid].role||comp.users[user.uid].userRole; break; } } } }
  if(!companyId){ resetMenuVisibility(); showSidebarAfterAuth(); return; }
  const authorizedPages=await applyFeatureBasedMenuVisibility(companyId); if(role) await applyRoleBasedFiltering(companyId, role, authorizedPages); else { ensureHomeIsVisible(); showSidebarAfterAuth(); }
} catch(e){ console.error('Menu auth error',e); resetMenuVisibility(); showSidebarAfterAuth(); } finally { isMenuUpdateInProgress=false; } }
function initializeMenuAuthorization(){ const sb=document.querySelector('.sidebar'); sb?.classList.add('menu-loading'); setTimeout(()=>updateMenuWithFeatureAuthorization(),500); }
window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

// Instantiate Auth Manager after DOM ready
document.addEventListener('DOMContentLoaded', ()=>{ window.authManager = new AuthManager(); });

// Populate Employee ID datalist with company user employeeIds (from companymanagement.html data schema)
async function populateEmployeeIdDatalist(){
  try {
    // Allow optional override of company, optional target datalist element, and optional filter
    const args = arguments || [];
    const overrideCompanyId = args[0] || null;
    const targetDatalist = args[1] || null;
    const filter = args[2] || null; // { type: 'subcontractor', id, name }
    const user = window.authManager?.currentUser;
    const effectiveCompanyId = overrideCompanyId || user?.companyId;
    if(!effectiveCompanyId) return; if(!window.firebase) return;
    const ref = firebase.database().ref(`companies/${effectiveCompanyId}/users`);
    const snap = await ref.once('value');
    if(!snap.exists()) return;
    const users = snap.val();

    const matchesFilter = (u)=>{
      if(!filter) return true;
      // Normalize employer fields
      const empType = (u.employerCompanyType || '').toString().toLowerCase();
      const empCompanyId = (u.employerCompanyId || '').toString();
  const empCompanyName = (u.employerCompanyName || '').toString();
      const wantName = (filter.name||'').toString();
      if(filter.type==='main'){
        // Include only main-company employees. If schema missing, treat as main (back-compat).
        if(empType && empType !== 'main') return false;
        if(wantId && empCompanyId) return empCompanyId === wantId;
        // If no employer fields, it's fine: record is under the selected company path already.
        return true;
      }
      if(filter.type==='subcontractor'){
        // Prefer deterministic employerCompanyType/employerCompanyId saved by companymanagement.html
        if(empType){
          if(empType !== 'subcontractor') return false;
          if(wantId && empCompanyId) return empCompanyId === wantId;
          if(wantName && empCompanyName) return empCompanyName.toLowerCase() === wantName.toLowerCase();
        }
        // Fallback to legacy ad-hoc fields if employerCompany* not present
        const sid = (u.subcontractorId || u.subId || u.subContractorId || '').toString();
        const sname = (u.subcontractorName || u.companyName || u.organization || '').toString();
        if(wantId && sid && sid === wantId) return true;
        if(wantName && sname && sname.toLowerCase() === wantName.toLowerCase()) return true;
        return true;
      }
    };
    Object.values(users).forEach(u=>{ if(u && u.employeeId && matchesFilter(u)){ ids.add(String(u.employeeId).trim()); } });
    const datalist = targetDatalist || document.getElementById('employeeIdOptions');
  if(!datalist) return;
    Array.from(ids).sort().forEach(id=>{ const opt=document.createElement('option'); opt.value=id; datalist.appendChild(opt); });
  } catch(e){ console.warn('Populate Employee IDs failed', e); }
}
// Delay population slightly to allow AuthManager to load company
let __companyUsersByEmpId = {};

// Enhance population to also cache user objects
async function cacheCompanyUsers(){
  try {
    // Optional override of companyId for caching (first arg)
    const overrideCompanyId = arguments && arguments[0] ? arguments[0] : null;
    const user = window.authManager?.currentUser; if((!user || !user.companyId) && !overrideCompanyId) return; if(!window.firebase) return;
    const effectiveCompanyId = overrideCompanyId || user.companyId;
    const ref = firebase.database().ref(`companies/${effectiveCompanyId}/users`);
    const snap = await ref.once('value');
    if(!snap.exists()) return;
    const users = snap.val();
    __companyUsersByEmpId = {};
    Object.values(users).forEach(u=>{ if(u && u.employeeId){ __companyUsersByEmpId[String(u.employeeId).toLowerCase()] = u; } });
  } catch(e){ console.warn('Cache company users failed', e); }
}
setTimeout(()=>cacheCompanyUsers(),1000);

async function autoFillEmployeeFromCompanyUser(formContext){
  console.log('🔍 Auto-fill triggered');
  
  // Use form context if provided, otherwise fall back to document query
  const idInput = formContext ? formContext.querySelector('#empId') : document.getElementById('empId');
  if(!idInput) {
    console.log('❌ No empId input found');
    return;
  }
  
  const enteredRaw = (idInput.value||'').trim();
  if(!enteredRaw) {
    console.log('❌ No employee ID entered');
    return;
  }
  
  console.log('🔍 Looking for employee ID:', enteredRaw, 'in form context:', !!formContext);
  
  try {
    // Get current user and company using the same pattern as other functions
    const currentUser = window.authManager?.currentUser;
    if(!currentUser) {
      console.log('❌ No currentUser from authManager');
      return;
    }
    
    console.log('👤 Current user:', currentUser);
    
    let companyId = currentUser.companyId;
    // If a Company is selected in the form, prefer that for lookup (decode main/sub values)
    try {
      const sel = formContext?.querySelector('#empCompanySelect');
      const selectedCid = sel?.value?.trim();
      if(selectedCid){
        if(selectedCid.startsWith('main:')){
          companyId = selectedCid.substring(5);
        } else if(selectedCid.startsWith('sub:')){
          // Subcontractor users are stored under the main company scope
          companyId = currentUser.companyId;
        } else {
          companyId = selectedCid;
        }
        console.log('🏢 Overriding company from form select:', companyId);
      }
    } catch(e){ /* ignore */ }
    
    // Fallback: if no companyId in currentUser, try to find it like updateMenuWithFeatureAuthorization does
    if(!companyId && firebase.auth().currentUser) {
      console.log('🔍 No companyId in currentUser, searching companies...');
      const user = firebase.auth().currentUser;
      const companiesSnap = await firebase.database().ref('companies').once('value');
      if(companiesSnap.exists()) {
        const companies = companiesSnap.val();
        for(const [cid, comp] of Object.entries(companies)) {
          if(comp.status !== 'active') continue;
          if(comp.users && comp.users[user.uid]) {
            companyId = cid;
            console.log('✅ Found company ID:', companyId);
            break;
          }
        }
      }
    }
    
    if(!companyId) {
      console.log('❌ No company ID found');
      return;
    }
    
    console.log('🏢 Using company ID:', companyId);
    
  // Fetch all users from this company
  const ref = firebase.database().ref(`companies/${companyId}/users`);
    console.log('🔍 Fetching from:', ref.toString());
    const snap = await ref.once('value');
    
    if(!snap.exists()) {
      console.log('❌ No users found in company');
      return;
    }
    
    const users = snap.val();
    console.log('👥 Found users data:', users);
    console.log('👥 User keys:', Object.keys(users));
    
    // Find user by employeeId - try exact match first, then case insensitive
    let foundUser = null;
    let foundUserKey = null;
    
    // First try exact match
    for(const [userKey, userData] of Object.entries(users)) {
      if(userData && userData.employeeId) {
        console.log(`🔍 Checking user ${userKey}: employeeId = "${userData.employeeId}"`);
        if(userData.employeeId.toString().trim() === enteredRaw) {
          foundUser = userData;
          foundUserKey = userKey;
          console.log('✅ Found exact match!');
          break;
        }
      }
    }
    
    // If no exact match, try case insensitive
    if(!foundUser) {
      console.log('🔍 No exact match, trying case insensitive...');
      for(const [userKey, userData] of Object.entries(users)) {
        if(userData && userData.employeeId) {
          if(userData.employeeId.toString().trim().toLowerCase() === enteredRaw.toLowerCase()) {
            foundUser = userData;
            foundUserKey = userKey;
            console.log('✅ Found case insensitive match!');
            break;
          }
        }
      }
    }
    
    if(!foundUser) {
      console.log('❌ No user found with employee ID:', enteredRaw);
      console.log('Available employee IDs:', Object.values(users).map(u => u?.employeeId).filter(Boolean));
      return;
    }
    
    console.log('✅ Found user data:', foundUser);
    
    // Helper to set field value - use form context if available
    const setVal = (id, val, overwrite=true) => {
      if(val == null || val === '') return;
      const el = formContext ? formContext.querySelector('#' + id) : document.getElementById(id);
      if(!el) {
        console.log('⚠️ Field not found:', id);
        return;
      }
      if(overwrite || !el.value) {
        el.value = val;
        console.log(`✅ Set ${id} = "${val}"`);
      }
    };

    // Resolve potential first/last name keys (support legacy schemas)
    const resolveFirstName = (u) => {
      return u.firstName || u.firstname || u.first_name || u.userFirstName || u.fname || (u.fullName ? (u.fullName.split(' ')[0]||'') : '') || '';
    };
    const resolveLastName = (u) => {
      if(u.lastName) return u.lastName;
      if(u.lastname) return u.lastname;
      if(u.last_name) return u.last_name;
      if(u.userLastName) return u.userLastName;
      if(u.lname) return u.lname;
      if(u.fullName){
        const parts = u.fullName.trim().split(/\s+/);
        if(parts.length>1) return parts.slice(-1).join(' ');
      }
      return '';
    };

    // Pre-capture resolved names for logging & assignment
    const resolvedFirst = resolveFirstName(foundUser);
    const resolvedLast = resolveLastName(foundUser);
    console.log('🧩 Resolved names -> first:', resolvedFirst, ' last:', resolvedLast);

    // Fill basic personal info
    setVal('empFirstName', resolvedFirst || foundUser.firstName || '');
    setVal('empLastName', resolvedLast || foundUser.lastName || '');
    setVal('empEmail', foundUser.email || '');
    setVal('empPhone', foundUser.phone || '');
    setVal('empAddress', foundUser.address || '');
    setVal('empCity', foundUser.city || '');
    setVal('empCountry', foundUser.country || '');
    
    // Employment details
    setVal('empDepartment', foundUser.department || '');
    setVal('empJobTitle', foundUser.jobTitle || '');
    setVal('empWorkLocation', foundUser.workLocation || '');
  // Employment type (normalize variants to match select options)
  if(foundUser.employmentType) setVal('empEmploymentType', normalizeEmploymentType(foundUser.employmentType), false);
    
    // Banking details
    if(foundUser.bankName) setVal('empBankName', foundUser.bankName);
    if(foundUser.accountName) setVal('empAccountName', foundUser.accountName);
    if(foundUser.accountNumber) setVal('empAccountNumber', foundUser.accountNumber);
    if(foundUser.accountType) setVal('empAccountType', foundUser.accountType);
    if(foundUser.iban) setVal('empIBAN', foundUser.iban);
    if(foundUser.swiftCode) setVal('empSwiftCode', foundUser.swiftCode);
    if(foundUser.bankCode) setVal('empBankCode', foundUser.bankCode);
    if(foundUser.branchCode) setVal('empBranchCode', foundUser.branchCode);
    if(foundUser.branchName) setVal('empBranchName', foundUser.branchName);
    if(foundUser.routingNumber) setVal('empRoutingNumber', foundUser.routingNumber);
    if(foundUser.bsbCode) setVal('empBSBCode', foundUser.bsbCode);
    if(foundUser.ifscCode) setVal('empIFSCCode', foundUser.ifscCode);
    if(foundUser.ribKey) setVal('empRibKey', foundUser.ribKey);
    if(foundUser.transitNumber) setVal('empTransitNumber', foundUser.transitNumber);
    if(foundUser.institutionNumber) setVal('empInstitutionNumber', foundUser.institutionNumber);
    if(foundUser.bankCurrency) setVal('empBankCurrency', foundUser.bankCurrency);
    if(foundUser.bankAddress) setVal('empBankAddress', foundUser.bankAddress);
    if(foundUser.nationalId) setVal('empNationalId', foundUser.nationalId);
    
    // Optional fields
    if(foundUser.gender) setVal('empGender', foundUser.gender);
    if(foundUser.nationality) setVal('empNationality', foundUser.nationality);
    if(foundUser.maritalStatus) setVal('empMarital', foundUser.maritalStatus);
    if(foundUser.dependents != null) setVal('empDependents', foundUser.dependents);
    
    // Set status to Active if not specified
    const statusEl = formContext ? formContext.querySelector('#empStatus') : document.getElementById('empStatus');
    if(statusEl && !statusEl.value) {
      statusEl.value = foundUser.status || 'Active';
      console.log(`✅ Set status = "${foundUser.status || 'Active'}"`);
    }
    
    console.log('✅ Auto-fill completed successfully');
    
  } catch(error) {
    console.error('❌ Auto-fill error:', error);
  }
}

// Removed global input listener - now handled in modal context

// Autofill from Contracts by Employee ID (company-scoped)
async function autoFillEmployeeFromContract(formContext){
  try {
    const idInput = formContext ? formContext.querySelector('#empId') : document.getElementById('empId');
    if(!idInput) return;
    const empId = (idInput.value||'').trim();
    if(!empId) return;

    // Resolve effective companyId (respect modal Company select for main/sub decoding)
    const currentUser = window.authManager?.currentUser || null;
    let companyId = currentUser?.companyId || null;
    try {
      const sel = formContext?.querySelector('#empCompanySelect');
      const selectedCid = sel?.value?.trim();
      if(selectedCid){
        if(selectedCid.startsWith('main:')){
          companyId = selectedCid.substring(5);
        } else if(selectedCid.startsWith('sub:')){
          // Subcontractor contracts are stored under the main company scope
          companyId = currentUser?.companyId || companyId;
        }
      }
    } catch(e) { /* ignore */ }

    if(!companyId){
      // Fallback like other flows: scan companies to find membership
      if(firebase.auth().currentUser){
        const user = firebase.auth().currentUser;
        const companiesSnap = await firebase.database().ref('companies').once('value');
        if(companiesSnap.exists()){
          const companies = companiesSnap.val();
          for(const [cid, comp] of Object.entries(companies)){
            if(comp.status !== 'active') continue;
            if(comp.users && comp.users[user.uid]){ companyId = cid; break; }
          }
        }
      }
    }
    if(!companyId) return;

    // Helper to choose best contract (prefer active, else latest by startDate, else latest createdAt)
    function chooseBestContract(list){
      if(!Array.isArray(list) || !list.length) return null;
      const isActive = c => (String(c.status||'').toLowerCase() === 'active');
      const activeOnes = list.filter(isActive);
      const parseDate = (d) => { const t = Date.parse(d); return Number.isFinite(t)? t : -Infinity; };
      const pickLatestBy = (arr, key) => arr.slice().sort((a,b)=> (parseDate(b[key]) - parseDate(a[key])) )[0] || null;
      if(activeOnes.length){
        const byStart = pickLatestBy(activeOnes, 'startDate');
        if(byStart) return byStart;
        return pickLatestBy(activeOnes, 'createdAt') || activeOnes[0];
      }
      const byStart = pickLatestBy(list, 'startDate');
      if(byStart) return byStart;
      return pickLatestBy(list, 'createdAt') || list[0];
    }

    // Aggregate emergency contacts from all relevant contracts for an employee (company scope + subcontractors + global fallback)
    async function getAllEmergencyContactsForEmployee(empId, companyId){
      if(!firebase || !firebase.database) return [];
      const contacts = [];
      const addFromContract = (c)=>{
        if(!c || typeof c !== 'object') return;
        if(Array.isArray(c.emergencyContacts)){
          c.emergencyContacts.forEach(ec=>{
            if(!ec) return;
            contacts.push({
              name: ec.name || ec.fullName || '',
              relationship: ec.relationship || '',
              phone: ec.phone || ec.contact || '',
              email: ec.email || '',
              address: ec.address || ''
            });
          });
        } else {
          const n = c.emergencyContactName || (c.emergencyContact && (c.emergencyContact.fullName || c.emergencyContact.name));
          const r = c.emergencyContactRelationship || (c.emergencyContact && c.emergencyContact.relationship);
          const p = c.emergencyContactPhone || (c.emergencyContact && (c.emergencyContact.phone || c.emergencyContact.contact));
          const a = c.emergencyContactAddress || (c.emergencyContact && c.emergencyContact.address);
          const e = c.emergencyContactEmail || (c.emergencyContact && c.emergencyContact.email);
          if(n || r || p || a || e){
            contacts.push({ name:n||'', relationship:r||'', phone:p||'', email:e||'', address:a||'' });
          }
        }
      };
      try{
        // Main company contracts
        if(companyId){
          const snap = await firebase.database().ref(`companies/${companyId}/contracts`).orderByChild('employeeId').equalTo(empId).once('value');
          if(snap.exists()){
            Object.values(snap.val()||{}).forEach(addFromContract);
          }
          // Subcontractors under main company
          try{
            const subsSnap = await firebase.database().ref(`companies/${companyId}/subcontractors`).once('value');
            if(subsSnap.exists()){
              const subs = subsSnap.val()||{};
              const subIds = Object.keys(subs);
              const results = await Promise.all(subIds.map(async sid => {
                try{
                  const sref = firebase.database().ref(`companies/${companyId}/subcontractors/${sid}/contracts`).orderByChild('employeeId').equalTo(empId);
                  const ssnap = await sref.once('value');
                  if(ssnap.exists()){
                    Object.values(ssnap.val()||{}).forEach(addFromContract);
                  }
                }catch(_){ }
                return null;
              }));
              void results; // no-op
            }
          }catch(_){ }
        }
        // Global fallback
        try{
          const gsnap = await firebase.database().ref('contracts').orderByChild('employeeId').equalTo(empId).once('value');
          if(gsnap.exists()){
            Object.values(gsnap.val()||{}).forEach(addFromContract);
          }
        }catch(_){ }
      }catch(_){ }

      // Deduplicate using robust normalization
      const toStr = (v)=> (v==null? '': String(v));
      const normSpace = (s)=> toStr(s).trim().replace(/\s+/g,' ').toLowerCase();
      const normEmail = (s)=> toStr(s).trim().toLowerCase();
      const normPhone = (s)=> toStr(s).replace(/[^0-9+]/g,'');

      const seenEmails = new Set();
      const seenPhones = new Set();
      const seenComposite = new Set();
      const out = [];
      contacts.forEach(c=>{
        const nameN = normSpace(c.name);
        const relN = normSpace(c.relationship);
        const addrN = normSpace(c.address);
        const emailN = normEmail(c.email);
        const phoneN = normPhone(c.phone);

        let used = false;
        if(emailN){
          if(seenEmails.has(emailN)) { used = true; }
          else { seenEmails.add(emailN); }
        }
        if(!used && phoneN){
          if(seenPhones.has(phoneN)) { used = true; }
          else { seenPhones.add(phoneN); }
        }
        if(!used){
          const compKey = [nameN, relN, addrN].join('|');
          if(seenComposite.has(compKey)) { used = true; }
          else { seenComposite.add(compKey); }
        }
        if(!used){
          // Push a cleaned copy
          out.push({
            name: toStr(c.name).trim(),
            relationship: toStr(c.relationship).trim(),
            phone: toStr(c.phone).trim(),
            email: toStr(c.email).trim(),
            address: toStr(c.address).trim()
          });
        }
      });
      return out;
    }

    function renderEmpEmergencyContactsList(contacts, formContext){
      const container = formContext ? formContext.querySelector('#empEmergencyContactsContainer') : document.getElementById('empEmergencyContactsContainer');
      if(!container) return;
      const escAttr = (s)=> (s==null?'':String(s).replace(/"/g,'&quot;'));
      container.innerHTML = '';
      if(!contacts || !contacts.length){
        container.innerHTML = '<div style="padding:10px; color:#777;">No contacts found</div>';
        return;
      }
      contacts.forEach(c=>{
        const card = document.createElement('div');
        card.className = 'emp-grid';
        card.style.cssText = 'margin:6px 0; border:1px solid #e0e0e0; border-radius:6px; padding:8px;';
        card.innerHTML = `
          <label>Contact Name<input type="text" value="${escAttr(c.name)}" readonly></label>
          <label>Relationship<input type="text" value="${escAttr(c.relationship)}" readonly></label>
          <label>Phone<input type="text" value="${escAttr(c.phone)}" readonly></label>
          <label>Email<input type="email" value="${escAttr(c.email)}" readonly></label>
          <label style="grid-column:1/-1;">Address<input type="text" value="${escAttr(c.address)}" readonly></label>
        `;
        container.appendChild(card);
      });
    }
    // Query contracts under company scope by employeeId (main)
    const ref = firebase.database().ref(`companies/${companyId}/contracts`).orderByChild('employeeId').equalTo(empId);
    const snap = await ref.once('value');
    let best = null;
    if(snap.exists()){
      const raw = snap.val() || {};
      const arr = Object.values(raw || {});
      best = chooseBestContract(arr);
    }
    // Also check subcontractor contracts under this company if not found yet
    if(!best){
      try{
        const subsSnap = await firebase.database().ref(`companies/${companyId}/subcontractors`).once('value');
        if(subsSnap.exists()){
          const subs = subsSnap.val()||{};
          const subIds = Object.keys(subs);
          const results = await Promise.all(subIds.map(async sid => {
            try{
              const sref = firebase.database().ref(`companies/${companyId}/subcontractors/${sid}/contracts`).orderByChild('employeeId').equalTo(empId);
              const ssnap = await sref.once('value');
              if(ssnap.exists()){
                const arr = Object.values(ssnap.val()||{});
                return chooseBestContract(arr);
              }
            }catch(e){ /* ignore */ }
            return null;
          }));
          best = results.filter(Boolean)[0] || null;
        }
      }catch(e){ /* ignore */ }
    }
    // Fallback: try global contracts if nothing found in company scopes
    if(!best){
      try {
        const gref = firebase.database().ref('contracts').orderByChild('employeeId').equalTo(empId);
        const gsnap = await gref.once('value');
        if(gsnap.exists()){
          const arr = Object.values(gsnap.val()||{});
          best = chooseBestContract(arr);
        }
      } catch(e){ /* ignore */ }
    }

    if(!best) return;

    // Helper to set value; by default don't overwrite non-empty fields unless force=true
    const setVal = (id, val, force=false) => {
      if(val == null) return;
      const el = formContext ? formContext.querySelector('#'+id) : document.getElementById(id);
      if(!el) return;
      if(force || !el.value){ el.value = String(val); }
    };

    // Map contract fields to payroll fields
    // Personal
    if(best.employeeName){
      const full = String(best.employeeName||'').trim();
      if(full){
        const parts = full.split(/\s+/);
        setVal('empFirstName', parts[0]||'', false);
        setVal('empLastName', parts.slice(1).join(' ')||'', false);
      }
    }
    setVal('empDob', best.birthDate || '', false);
    setVal('empNationality', best.nationality || '', false);
    setVal('empMarital', best.maritalStatus || '', false);
    // Dependents: unify across possible key names used in contr.html/contractsub.html and force the value
    (function(){
      const val = (function unifyDependents(c){
        const keys = [
          'dependents','dependants','numberOfDependents','noOfDependents','numDependents','nbDependents',
          'children','childrenCount','nbChildren','nbEnfants','enfants'
        ];
        for(const k of keys){ if(c && c[k] != null && c[k] !== '') return Number(c[k])||0; }
        return null;
      })(best);
      if(val != null){ setVal('empDependents', val, true); }
    })();
    setVal('empAddress', best.address || '', false);
  // Title/Gender (match contractsub options like Sir, Madam, etc.)
  setVal('empGender', best.gender || best.title || '', false);
    // Prefer an explicit country if present; else try birthCountry as a hint
    setVal('empCountry', best.country || best.birthCountry || '', false);
    // Contact if present in contract
    setVal('empEmail', best.employeeEmail || '', false);
    setVal('empPhone', best.employeePhone || '', false);

    // Employment (force to ensure contract terms take precedence)
  setVal('empEmploymentType', normalizeEmploymentType(best.employmentType || ''), true);
    setVal('empWorkLocation', best.workLocation || best.location || '', true);
    // Seniority: try multiple known keys; prefer explicit seniority date if present
    (function(){
      const sen = best.seniority || best.seniorityDate || best.seniority_date || best.employeeSeniorityDate || '';
      if(sen) setVal('empSeniorityDate', sen, true);
      // Compute and set Seniority Years once Seniority date is resolved
      try{
        const d = sen ? new Date(sen) : null;
        let years = 0;
        if(d && !isNaN(d.getTime())){
          const now = new Date();
          years = now.getFullYear() - d.getFullYear();
          const anniv = new Date(now.getFullYear(), d.getMonth(), d.getDate());
          if(now < anniv) years -= 1;
          if(!Number.isFinite(years) || years < 0) years = 0;
        }
        setVal('empSeniorityYears', years, true);
      }catch(e){ /* ignore */ }
    })();
    setVal('empHireDate', best.startDate || '', true);
    setVal('empTerminationDate', best.endDate || '', true);
    setVal('empDepartment', best.department || '', false);
    setVal('empJobTitle', best.positionTitle || '', false);
    setVal('empManagerId', best.reportingManager || best.manager || '', false);
    // Compensation
    const salary = (best.salaryAmount!=null && best.salaryAmount!=='') ? best.salaryAmount : (best.grossSalary!=null? best.grossSalary : '');
    if(salary !== '') setVal('empBasicSalary', salary, true);
    // Force currency to match contract salary currency exactly (override defaults like USD)
    let desiredCurrency = best.gradeCurrency || best.currency || '';
    if(desiredCurrency){
      setVal('empCurrency', desiredCurrency, true);
      // Keep bank currency aligned by default when auto-filling from contract
      setVal('empBankCurrency', desiredCurrency, true);
    }

    // Work Terms: ensure Working Hours/Week and Working Hours/Day mirror contract values exactly
    if (best.workingHours != null && best.workingHours !== '') {
      setVal('empWorkingHoursWeek', best.workingHours, true);
    }
    if (best.workingHoursPerDay != null && best.workingHoursPerDay !== '') {
      setVal('empWorkingHoursDay', best.workingHoursPerDay, true);
    }

  // Emergency contact (single - legacy) removed; rely on aggregated contacts display below

    // Load and render all emergency contacts from contracts
    try {
      const allContacts = await getAllEmergencyContactsForEmployee(empId, companyId);
      renderEmpEmergencyContactsList(allContacts, formContext);
    } catch(e){ console.warn('Failed to render all emergency contacts', e); }

    // Map Band (Level) and Grade from contract and salary structures
    try {
      // Level: use Band label from contract (compGrade)
      if(best.compGrade){ setVal('empLevel', best.compGrade, true); }

      // Grade: resolve which subitem (e.g., Min/Mid/Max or custom) produced the salaryAmount
      const targetSalary = (best.salaryAmount!=null && best.salaryAmount!=='') ? Number(best.salaryAmount) : null;
      if(targetSalary!=null && Number.isFinite(targetSalary)){
        // Load salary subitems settings (labels and order)
        async function loadSalarySubitemsDefs(cid){
          try{
            const snap = await firebase.database().ref(`companies/${cid}/salarySettings/subitems`).once('value');
            if(snap.exists()){
              const obj = snap.val()||{};
              return Object.values(obj).filter(Boolean).sort((a,b)=> (a.order||0)-(b.order||0));
            }
          }catch(e){ /* ignore */ }
          // Fallback defaults
          return [
            { id:'minSalary', key:'minSalary', label:'Min', enabled:true, order:1, type:'number' },
            { id:'midSalary', key:'midSalary', label:'Mid', enabled:true, order:2, type:'number' },
            { id:'maxSalary', key:'maxSalary', label:'Max', enabled:true, order:3, type:'number' }
          ];
        }

        // Find the selected band by id (preferred) or by name
        async function loadBandRecord(cid, bandSel, bandLabel){
          try{
            if(bandSel && bandSel.id){
              const bSnap = await firebase.database().ref(`companies/${cid}/salaryBands/${bandSel.id}`).once('value');
              if(bSnap.exists()) return { id: bandSel.id, ...(bSnap.val()||{}) };
            }
          }catch(e){ /* ignore */ }
          try{
            const allSnap = await firebase.database().ref(`companies/${cid}/salaryBands`).once('value');
            const all = allSnap.val()||{};
            const found = Object.entries(all).find(([id,b])=> String(b?.bandName||'').trim().toLowerCase() === String(bandLabel||'').trim().toLowerCase());
            if(found){ return { id: found[0], ...(found[1]||{}) }; }
          }catch(e){ /* ignore */ }
          return null;
        }

        const defs = await loadSalarySubitemsDefs(companyId);
        const band = await loadBandRecord(companyId, best.compGradeSelection || null, best.compGrade || '');
        if(band){
          // If we didn't have a currency on the contract, use the band's currency
          if(!desiredCurrency && band.currency){
            desiredCurrency = band.currency;
            setVal('empCurrency', desiredCurrency, true);
            setVal('empBankCurrency', desiredCurrency, true);
          }
          // Build candidate list from enabled defs present on band
          const enabledDefs = defs.filter(d=> d && d.enabled !== false);
          // Map defs to values from band (supports min/mid/max and dynamic subitems)
          const candidates = [];
          enabledDefs.forEach(d=>{
            const k = d.key;
            let v = undefined;
            if(k==='minSalary') v = band.minSalary;
            else if(k==='midSalary') v = band.midSalary;
            else if(k==='maxSalary') v = band.maxSalary;
            else if(band.subitems && Object.prototype.hasOwnProperty.call(band.subitems,k)) v = band.subitems[k];
            if(v!=null && v!==''){
              candidates.push({ key:k, label: d.label || k, value: Number(v) });
            }
          });
          // If no candidates from defs, include the classic trio if present
          if(!candidates.length){
            ['minSalary','midSalary','maxSalary'].forEach((k,i)=>{
              const v = getVal(k);
              if(v!=null && v!=='') candidates.push({ key:k, label: ({minSalary:'Min',midSalary:'Mid',maxSalary:'Max'})[k], value:Number(v), order:i+1 });
            });
          }
          // Find the matching label for the salary amount (tolerate floating errors)
          const match = candidates.find(c=> Math.abs(Number(c.value||0) - targetSalary) < 0.0001);
          if(match){ setVal('empGrade', match.label, true); }
        }
      }
    } catch(e){ console.warn('Grade/Level autofill from contract failed', e); }

    console.log('✅ Auto-filled from contract for', empId, '→ start:', best.startDate, 'status:', best.status);
  } catch(err){
    console.warn('Auto-fill from contract failed', err);
  }
}

/**************** Firebase Init *****************/
const firebaseConfig = { apiKey:"AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc", authDomain:"users-8be65.firebaseapp.com", databaseURL:"https://users-8be65-default-rtdb.firebaseio.com", projectId:"users-8be65", storageBucket:"users-8be65.firebasestorage.app", messagingSenderId:"829083030831", appId:"1:829083030831:web:36a370e62691e560bc3dda" };
try{ if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); }catch(e){ console.warn('Firebase init issue', e); }
const db = (window.firebase && firebase.database()) || null;

/**************** Utility Helpers *****************/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const uid = () => 'id_'+Date.now().toString(36)+Math.random().toString(36).slice(2,8);
const readLS = (k, def) => { try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(def)); } catch { return def; } };
const writeLS = (k, v) => { localStorage.setItem(k, JSON.stringify(v)); };
const dispatchSync = (name) => { window.dispatchEvent(new CustomEvent(name)); };
const currentUser = (()=>{ try { return JSON.parse(localStorage.getItem('currentUser')||'null'); } catch { return null; } })();
const companyId = currentUser && (currentUser.companyId || currentUser.companyID || currentUser.company || currentUser.company_id) || null;

function fmtCurrency(v, cur){
  // Formats a number as currency. If cur is provided, prefer it; else fallback to settings.currency; then USD.
  try{
    const settings = readLS('payroll.settings',{}) || {};
    const c = (cur && String(cur).trim()) || settings.currency || 'USD';
    return new Intl.NumberFormat(undefined, { style:'currency', currency:c }).format(Number(v||0));
  }catch{
    // Fallback: try with settings currency, then plain number
    try{
      const settings = readLS('payroll.settings',{}) || {};
      const c2 = settings.currency || 'USD';
      return new Intl.NumberFormat(undefined, { style:'currency', currency:c2 }).format(Number(v||0));
    }catch{
      const n = Number(v||0);
      return Number.isFinite(n) ? String(Math.round(n*100)/100) : String(v);
    }
  }
}

// Global, safe formula evaluation utility available across UI (preview, editor, runs)
// Provides a stable sandbox with a small set of helpers and blocks dangerous globals.
if (typeof window !== 'undefined' && typeof window.evalFormula !== 'function') {
  // Deterministic, safe evaluator: tokenize → shunting-yard → RPN evaluate
  window.evalFormula = function evalFormula(formula, ctx) {
    try {
      if (!formula) return 0;
      const upstreamCtx = ctx && typeof ctx === 'object' ? ctx : {};
      // Normalization (kept minimal here; display-normalization lives elsewhere)
      // Strip diacritics first to support inputs like "ANCIENNETÉ" etc.
      let src = String(formula);
      try{ src = src.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch{}
      src = src.toUpperCase();
      // Unicode math → ASCII
      src = src.replace(/[×✕]/g, '*').replace(/[÷]/g, '/');
      // Normalize spaces
      src = src.replace(/[\u00A0\u202F\u2000-\u200A]/g, ' ');
      // Friendly synonyms
      src = src
        .replace(/\bSENIORITY\s+YEAR\b/g, 'SENIORITY YEARS')
        .replace(/\bSENIORITY[-_\s]*YEARS?\b/g, 'SENIORITY_YEARS')
        .replace(/\bYEARS?\s+OF\s+SENIORITY\b/g, 'SENIORITY_YEARS')
        .replace(/\bSENIORITYYEARS?\b/g, 'SENIORITY_YEARS')
  .replace(/\bANCIENNETE(?:\s+YEARS?)?\b/g, 'SENIORITY_YEARS')
  .replace(/\bYEARS?\s+OF\s+SERVICE\b/g, 'SENIORITY_YEARS')
        .replace(/\bSENIORITY\b/g, 'SENIORITY_YEARS')
        .replace(/\bBASIC\s+SALARY\b/g, 'BASIC')
        .replace(/\bBASIC\s+PAY\b/g, 'BASIC')
        .replace(/\bBASE\s+SALARY\b/g, 'BASIC')
        .replace(/\bBASE\s+PAY\b/g, 'BASIC')
        .replace(/\bSALARY\s+BASIC\b/g, 'BASIC')
        .replace(/\bEARNINGS\s+TOTAL\b/g, 'EARNINGS_SUM')
        .replace(/\bDEDUCTIONS\s+TOTAL\b/g, 'DEDUCTIONS_SUM')
        .replace(/\bEARNINGS\s+SUM\b/g, 'EARNINGS_SUM')
        .replace(/\bDEDUCTIONS\s+SUM\b/g, 'DEDUCTIONS_SUM')
        .replace(/\bGROSS\s+PRE\b/g, 'GROSS_PRE')
        .replace(/\bNET\s+PRE\b/g, 'NET_PRE')
        .replace(/\bAND\b/g, ' AND ')
        .replace(/\bOR\b/g, ' OR ');

      // Tokenizer that understands numbers with commas/spaces
      function readNumber(i){
        let j=i; let s='';
        while(j<src.length){
          const ch = src[j];
          if(/[0-9.,'\s]/.test(ch)) { s+=ch; j++; }
          else break;
        }
        // normalize numeric literal: remove spaces/apostrophes; decide comma handling
        let t = s.replace(/[\s']/g,'');
        const hasDot = t.includes('.');
        const hasComma = t.includes(',');
        if(hasDot && hasComma){ t = t.replace(/,/g,''); }
        else if(hasComma){ t = t.replace(/,/g,'.'); }
        const num = Number(t);
        return { token:{type:'num', value: Number.isFinite(num)?num:0 }, next:j };
      }
      function isIdentStart(c){ return /[A-Z_]/.test(c); }
      function isIdentPart(c){ return /[A-Z0-9_]/.test(c); }
      function tokenize(){
        const out=[]; let i=0; let prevToken=null;
        while(i<src.length){
          const ch = src[i];
          if(ch===' ' || ch==='\t' || ch==='\r' || ch==='\n'){ i++; continue; }
          // number (also handles leading dot or comma like .5 or ,5)
          if(/[0-9]/.test(ch) || ((ch==='.'||ch===',') && /[0-9]/.test(src[i+1]||''))){
            const r = readNumber(i); out.push(r.token); i=r.next; prevToken=r.token; continue;
          }
          // identifiers / functions
          if(isIdentStart(ch)){
            let j=i+1; while(j<src.length && isIdentPart(src[j])) j++;
            const name = src.slice(i,j);
            // function if next non-space is '('
            let k=j; while(k<src.length && src[k]===' ') k++;
            if(src[k]==='('){ out.push({type:'fn', name, argc:0}); i=j; prevToken=out[out.length-1]; continue; }
            out.push({type:'id', name}); i=j; prevToken=out[out.length-1]; continue;
          }
          // multi-char operators
          const two = src.slice(i,i+2);
          if(['>=','<=','==','!='].includes(two)){ out.push({type:'op', op:two}); i+=2; prevToken=out[out.length-1]; continue; }
          // logical words handled as ops
          if(src.startsWith('AND', i) && !isIdentPart(src[i+3]||'')){ out.push({type:'op', op:'AND'}); i+=3; prevToken=out[out.length-1]; continue; }
          if(src.startsWith('OR', i) && !isIdentPart(src[i+2]||'')){ out.push({type:'op', op:'OR'}); i+=2; prevToken=out[out.length-1]; continue; }
          // single-char operators and punctuation
          if('+-*/^()<>.,'.includes(ch)){
            // unary minus detection
            if(ch==='-'){
              const isUnary = (!prevToken) || (prevToken && (prevToken.type==='op' || (prevToken.type==='punc' && prevToken.ch==='(')));
              if(isUnary){ out.push({type:'op', op:'UNARY_MINUS'}); i++; prevToken=out[out.length-1]; continue; }
            }
            if(ch==='(' || ch===')' || ch===','){ out.push({type:'punc', ch}); i++; prevToken=out[out.length-1]; continue; }
            if('<>'.includes(ch)){ out.push({type:'op', op:ch}); i++; prevToken=out[out.length-1]; continue; }
            out.push({type:'op', op:ch}); i++; prevToken=out[out.length-1]; continue;
          }
          // Unknown char → skip
          i++;
        }
        return out;
      }

      const prec = {
        'OR':1, 'AND':2,
        '==':3,'!=':3,
        '<':4,'>':4,'<=':4,'>=':4,
        '+':5,'-':5,
        '*':6,'/':6,
        '^':7,
        'UNARY_MINUS':8
      };
      const rightAssoc = new Set(['^','UNARY_MINUS']);
      function toRPN(tokens){
        const out=[]; const ops=[]; const fnArgc=[];
        for(let i=0;i<tokens.length;i++){
          const t=tokens[i];
          if(t.type==='num' || t.type==='id'){ out.push(t); }
          else if(t.type==='fn'){ ops.push(t); fnArgc.push(0); }
          else if(t.type==='punc' && t.ch==='('){ ops.push(t); }
          else if(t.type==='punc' && t.ch===','){
            while(ops.length && !(ops[ops.length-1].type==='punc' && ops[ops.length-1].ch==='(')) out.push(ops.pop());
            if(fnArgc.length) fnArgc[fnArgc.length-1]++;
          }
          else if(t.type==='punc' && t.ch===')'){
            while(ops.length && !(ops[ops.length-1].type==='punc' && ops[ops.length-1].ch==='(')) out.push(ops.pop());
            if(ops.length && ops[ops.length-1].type==='punc' && ops[ops.length-1].ch==='(') ops.pop();
            if(ops.length && ops[ops.length-1].type==='fn'){
              const fnTok = ops.pop();
              const argc = (fnArgc.pop()||0) + 1; // commas+1, unless it was empty args
              // detect empty arg list
              const prev = tokens[i-1];
              fnTok.argc = (prev && prev.type==='punc' && prev.ch==='(') ? 0 : argc;
              out.push(fnTok);
            }
          }
          else if(t.type==='op'){
            const p = prec[t.op]||0;
            while(ops.length){
              const top=ops[ops.length-1];
              if(top.type==='op'){
                const pt=prec[top.op]||0;
                if((!rightAssoc.has(t.op) && p<=pt) || (rightAssoc.has(t.op) && p<pt)) out.push(ops.pop()); else break;
              } else if(top.type==='fn'){ out.push(ops.pop()); }
              else break;
            }
            ops.push(t);
          }
        }
        while(ops.length){ const t=ops.pop(); if(t.type!=='punc') out.push(t); }
        return out;
      }
      function truthy(v){ return !!(Number(v)||0); }
      function applyOp(op, a, b){
        a=Number(a)||0; b=Number(b)||0;
        switch(op){
          case '+': return a+b;
          case '-': return a-b;
          case '*': return a*b;
          case '/': return b===0 ? 0 : a/b;
          case '^': return Math.pow(a,b);
          case '<': return a<b ? 1:0;
          case '>': return a>b ? 1:0;
          case '<=': return a<=b ? 1:0;
          case '>=': return a>=b ? 1:0;
          case '==': return a===b ? 1:0;
          case '!=': return a!==b ? 1:0;
          case 'AND': return (truthy(a) && truthy(b)) ? 1:0;
          case 'OR': return (truthy(a) || truthy(b)) ? 1:0;
          case 'UNARY_MINUS': return -a;
          default: return 0;
        }
      }
      function applyFn(t, stack){
        const name=t.name; const argc=t.argc;
        function popN(n){ const arr=[]; for(let i=0;i<n;i++){ arr.unshift(coerce(stack.pop())); } return arr; }
        switch(name){
          case 'MIN':{ const args=popN(Math.max(argc,1)); return args.reduce((m,v)=> Math.min(m, v), args[0]??0); }
          case 'MAX':{ const args=popN(Math.max(argc,1)); return args.reduce((m,v)=> Math.max(m, v), args[0]??0); }
          case 'ROUND':{ const args=popN(argc||1); const x=args[0]||0; const dp=Number(args[1]??0)||0; const k=Math.pow(10,dp); return Math.round(x*k)/k; }
          case 'FLOOR':{ const x=(popN(1)[0]||0); return Math.floor(x); }
          case 'CEIL':{ const x=(popN(1)[0]||0); return Math.ceil(x); }
          case 'ABS':{ const x=(popN(1)[0]||0); return Math.abs(x); }
          case 'CLAMP':{ const args=popN(3); return Math.min(Math.max(args[0]||0, args[1]||0), args[2]||0); }
          case 'IF':{ const args=popN(3); return truthy(args[0]) ? (args[1]||0) : (args[2]||0); }
          default: return 0;
        }
      }
      function coerce(val){
        try{
          if(val==null) return 0;
          if(typeof val==='number') return Number.isFinite(val)?val:0;
          if(typeof val==='boolean') return val?1:0;
          if(val instanceof Date){ const y=val.getFullYear(); return Number.isFinite(y)?y:0; }
          const sRaw = String(val);
          // Try money/number style first
          let s = sRaw.replace(/[\u00A0\u202F\u2000-\u200A]/g,' ');
          s = s.replace(/(\d)\s+(?=\d)/g,'$1');
          s = s.replace(/[^0-9,.-]/g,'');
          if(s){
            if(s.includes(',') && s.includes('.')) s = s.replace(/,/g,''); else s = s.replace(/,/g,'.');
            const n = Number(s);
            if(Number.isFinite(n)) return n;
          }
          // Fallback: extract a 4-digit year anywhere
          const y = sRaw.match(/(?<!\d)(?:19|20)\d{2}(?!\d)/);
          if(y) return Number(y[0])||0;
          // Fallback: first integer in string
          const m = sRaw.match(/-?\d+/);
          if(m) return Number(m[0])||0;
          return 0;
        }catch{ return 0; }
      }

      const tokens = tokenize();
      const rpn = toRPN(tokens);
      // Build resolution context with zero-fill for unknown identifiers
      const resolvedCtx = Object.assign(Object.create(null), upstreamCtx);
      // Evaluate RPN
      const stack=[];
      for(const t of rpn){
        if(t.type==='num'){ stack.push(coerce(t.value)); }
        else if(t.type==='id'){
          const key = t.name;
          const val = (Object.prototype.hasOwnProperty.call(resolvedCtx, key)? resolvedCtx[key] : 0);
          stack.push(coerce(val));
        }
        else if(t.type==='op'){
          if(t.op==='UNARY_MINUS'){ const a=coerce(stack.pop()); stack.push(applyOp('UNARY_MINUS', a, 0)); }
          else { const b=coerce(stack.pop()); const a=coerce(stack.pop()); stack.push(applyOp(t.op, a, b)); }
        }
        else if(t.type==='fn'){
          stack.push(applyFn(t, stack));
        }
      }
      const res = Number(stack.pop()||0);
      return Number.isFinite(res) ? res : 0;
    } catch (e) {
      console.warn('Formula eval failed:', formula, e);
      return 0;
    }
  };
}

// Normalize employment type values to match select options
function normalizeEmploymentType(v){
  if(!v) return '';
  const s = String(v).trim().toLowerCase();
  if(['full-time','full time','fulltime','permanent','employee'].includes(s)) return 'Full-Time';
  if(['part-time','part time','parttime'].includes(s)) return 'Part-Time';
  if(['contract','contractor','temporary','temp','fixed-term','fixed term','fixedterm'].includes(s)) return 'Contract';
  if(['intern','internship','trainee'].includes(s)) return 'Intern';
  if(['consultant','consultancy','advisor','adviser'].includes(s)) return 'Consultant';
  return v; // fallback
}

// Contract helpers for formula variables
function contractToFormulaVars(contract){
  const out = {};
  if(!contract || typeof contract !== 'object'){
    // still provide defaulted fields for discoverability
    out.CONTRACT_SALARY = 0;
    out.CONTRACT_GROSS_SALARY = 0;
    out.CONTRACT_START_DATE_EPOCH = 0;
    out.CONTRACT_END_DATE_EPOCH = 0;
    out.CONTRACT_TENURE_DAYS = 0;
    out.CONTRACT_TENURE_MONTHS = 0;
    out.CONTRACT_TENURE_YEARS = 0;
    out.CONTRACT_ACTIVE = 0;
    return out;
  }
  const toEpoch = (d)=>{ const t = Date.parse(d); return Number.isFinite(t) ? t : 0; };
  const startMs = toEpoch(contract.startDate || contract.start_date || null);
  const endMs = toEpoch(contract.endDate || contract.end_date || null);
  const nowMs = Date.now();
  const effectiveEnd = endMs && endMs > 0 ? endMs : nowMs;
  const days = startMs>0 ? Math.max(0, Math.floor((effectiveEnd - startMs) / (1000*60*60*24))) : 0;
  const months = startMs>0 ? Math.max(0, Math.floor(days / 30)) : 0;
  const years = startMs>0 ? Math.max(0, Math.floor(days / 365)) : 0;
  const active = String(contract.status||'').toLowerCase()==='active' ? 1 : 0;

  out.CONTRACT_SALARY = Number(contract.salaryAmount || 0) || 0;
  out.CONTRACT_GROSS_SALARY = Number(contract.grossSalary || 0) || 0;
  out.CONTRACT_START_DATE_EPOCH = startMs;
  out.CONTRACT_END_DATE_EPOCH = endMs;
  out.CONTRACT_TENURE_DAYS = days;
  out.CONTRACT_TENURE_MONTHS = months;
  out.CONTRACT_TENURE_YEARS = years;
  out.CONTRACT_ACTIVE = active;
  return out;
}

// Fetch best (active/latest) contract for an employee within company scope; fallback to global
async function getBestContractForEmployee(empId, effectiveCompanyId){
  if(!empId) return null;
  const chooseBest = (list)=>{
    if(!Array.isArray(list) || !list.length) return null;
    const isActive = c => (String(c?.status||'').toLowerCase() === 'active');
    const parseDate = (d) => { const t = Date.parse(d); return Number.isFinite(t)? t : -Infinity; };
    const pickLatestBy = (arr, key) => arr.slice().sort((a,b)=> (parseDate(b?.[key]) - parseDate(a?.[key])) )[0] || null;
    const active = list.filter(isActive);
    if(active.length){
      const byStart = pickLatestBy(active, 'startDate');
      if(byStart) return byStart;
      return pickLatestBy(active, 'createdAt') || active[0];
    }
    const byStart = pickLatestBy(list, 'startDate');
    if(byStart) return byStart;
    return pickLatestBy(list, 'createdAt') || list[0];
  };
  try{
    // Company-scoped contracts
    if(window.firebase && firebase.database && effectiveCompanyId){
      const ref = firebase.database().ref(`companies/${effectiveCompanyId}/contracts`).orderByChild('employeeId').equalTo(empId);
      const snap = await ref.once('value');
      if(snap.exists()){
        const arr = Object.values(snap.val()||{});
        const best = chooseBest(arr);
        if(best) return best;
      }
    }
    // Global fallback
    if(window.firebase && firebase.database){
      const gref = firebase.database().ref('contracts').orderByChild('employeeId').equalTo(empId);
      const gsnap = await gref.once('value');
      if(gsnap.exists()){
        const arr = Object.values(gsnap.val()||{});
        return chooseBest(arr);
      }
    }
  }catch(e){ console.warn('Contract lookup failed for', empId, e); }
  return null;
}

/**************** Company Settings (Payroll) *****************/
let COMPANY_SETTINGS_CACHE = {
  company: { name: '', legalName: '', registration: '', taxId: '', address: '', country: '' },
  currency: 'USD',
  payrollDefaults: { payCycle: 'Monthly', paydayDay: 25 },
  bankAccounts: []
};
let COMPANY_BANK_ACCOUNTS = [];

function getCompanySettings(){ return readLS('payroll.settings', COMPANY_SETTINGS_CACHE); }

function renderCompanySettingsForm(){
  const settings = getCompanySettings();
  // Merge into cache and in-memory accounts
  COMPANY_SETTINGS_CACHE = {
    company: Object.assign({ name:'', legalName:'', registration:'', taxId:'', address:'', country:'' }, settings.company||{}),
    currency: settings.currency || 'USD',
    payrollDefaults: Object.assign({ payCycle:'Monthly', paydayDay:25 }, settings.payrollDefaults||{}),
    bankAccounts: Array.isArray(settings.bankAccounts) ? settings.bankAccounts : []
  };
  COMPANY_BANK_ACCOUNTS = [...(COMPANY_SETTINGS_CACHE.bankAccounts||[])];

  const setVal = (id, val)=>{ const el = document.getElementById(id); if(el!=null) el.value = val ?? ''; };
  setVal('csCompanyName', COMPANY_SETTINGS_CACHE.company.name || '');
  setVal('csLegalName', COMPANY_SETTINGS_CACHE.company.legalName || '');
  setVal('csRegistration', COMPANY_SETTINGS_CACHE.company.registration || '');
  setVal('csTaxId', COMPANY_SETTINGS_CACHE.company.taxId || '');
  setVal('csAddress', COMPANY_SETTINGS_CACHE.company.address || '');
  setVal('csCountry', COMPANY_SETTINGS_CACHE.company.country || '');
  setVal('csCurrency', COMPANY_SETTINGS_CACHE.currency || 'USD');
  setVal('csPayCycle', COMPANY_SETTINGS_CACHE.payrollDefaults.payCycle || 'Monthly');
  setVal('csPayday', COMPANY_SETTINGS_CACHE.payrollDefaults.paydayDay || 25);

  renderBankAccountsTable();
}

function renderBankAccountsTable(){
  const tbody = document.getElementById('csBankAccountsTbody');
  if(!tbody) return;
  if(!COMPANY_BANK_ACCOUNTS.length){
    tbody.innerHTML = '<tr><td colspan="12" class="empty">No bank accounts added</td></tr>';
    return;
  }
  tbody.innerHTML = COMPANY_BANK_ACCOUNTS.map((acc, idx)=>{
    const b = (txt)=> (txt? String(txt) : '');
    return `<tr data-idx="${idx}">
      <td>${b(acc.bankName)}</td>
      <td>${b(acc.accountName)}</td>
      <td>${b(acc.accountNumber)}</td>
      <td>${b(acc.iban)}</td>
      <td>${b(acc.swift)}</td>
      <td>${b(acc.accountType)}</td>
      <td>${b(acc.currency) || '—'}</td>
      <td>${b(acc.branch)}</td>
      <td>${b(acc.routing)}</td>
      <td>${acc.isDefault ? '✓' : ''}</td>
      <td>${b(acc.usage)}</td>
      <td><div class="actions">
        <button type="button" class="btn-danger" data-del-ba="${idx}"><i class="fas fa-trash"></i></button>
      </div></td>
    </tr>`;
  }).join('');
  // Bind delete handlers
  Array.from(tbody.querySelectorAll('[data-del-ba]')).forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = Number(btn.getAttribute('data-del-ba'));
      if(Number.isFinite(i)){
        if(confirm('Delete this bank account?')){
          COMPANY_BANK_ACCOUNTS.splice(i,1);
          renderBankAccountsTable();
        }
      }
    });
  });
}

function collectCompanySettingsFromForm(){
  const getVal = id => (document.getElementById(id)?.value || '').trim();
  const payday = Number(getVal('csPayday') || 25);
  const payload = {
    company: {
      name: getVal('csCompanyName'),
      legalName: getVal('csLegalName'),
      registration: getVal('csRegistration'),
      taxId: getVal('csTaxId'),
      address: getVal('csAddress'),
      country: getVal('csCountry')
    },
    currency: getVal('csCurrency') || 'USD',
    payrollDefaults: {
      payCycle: getVal('csPayCycle') || 'Monthly',
      paydayDay: Number.isFinite(payday) && payday>0 ? Math.min(Math.max(1, payday), 31) : 25
    },
    bankAccounts: [...COMPANY_BANK_ACCOUNTS]
  };
  return payload;
}

function saveCompanySettingsToFirebase(payload){
  // Normalize bank accounts: ensure at most one default
  if(Array.isArray(payload?.bankAccounts)){
    const defaults = payload.bankAccounts.filter(a=> !!a.isDefault);
    if(defaults.length > 1){
      let kept = false;
      payload.bankAccounts = payload.bankAccounts.map(a=>{
        if(a.isDefault && !kept){ kept = true; return Object.assign({}, a, { isDefault:true }); }
        return Object.assign({}, a, { isDefault:false });
      });
    }
  }
  writeLS('payroll.settings', payload); // mirror locally immediately
  if(!db || !companyId){
    console.warn('⚠️ No DB or companyId; settings saved locally only.');
    alert('Settings saved locally. They will sync when online.');
    return;
  }
  db.ref(`companies/${companyId}/payroll/settings`).set(payload)
    .then(()=>{ console.log('✅ Settings saved'); alert('Settings saved.'); })
    .catch(e=>{ console.error('❌ Save settings failed', e); alert('Failed to save settings. Check console.'); });
}

function attachCompanySettingsListener(){
  if(!db || !companyId) return;
  const ref = db.ref(`companies/${companyId}/payroll/settings`);
  ref.off();
  ref.on('value', snap=>{
    const val = snap.val() || {};
    const merged = {
      company: Object.assign({ name:'', legalName:'', registration:'', taxId:'', address:'', country:'' }, val.company||{}),
      currency: val.currency || COMPANY_SETTINGS_CACHE.currency || 'USD',
      payrollDefaults: Object.assign({ payCycle:'Monthly', paydayDay:25 }, val.payrollDefaults||{}),
      bankAccounts: Array.isArray(val.bankAccounts) ? val.bankAccounts : []
    };
    COMPANY_SETTINGS_CACHE = merged;
    writeLS('payroll.settings', merged);
    renderCompanySettingsForm();
  }, err=> console.error('❌ Settings listener error', err));
}

/**************** Data Access Layers *****************/
// Employees - load from Firebase first, fallback to localStorage
function getEmployees(){ return readLS('payroll.employees', { items:[] }).items || []; }

async function loadEmployeesFromFirebase(){
  if(!db || !companyId) return;
  try {
    const snap = await db.ref(`companies/${companyId}/payroll/employees`).once('value');
    if(snap.exists()){
      const items = Object.values(snap.val());
      writeLS('payroll.employees', {items});
      renderEmployees();
    }
  } catch(e){ console.warn('Load employees failed', e); }
}

// Save entire employees array locally and optionally mirror to Firebase (bulk sync)
function saveEmployees(items){
  writeLS('payroll.employees',{items});
  if(db && companyId){
    // Bulk sync (only when needed). For creation/update we also call per-item writer.
    try{
      items.forEach(emp=> persistEmployeeToFirebase(emp));
    }catch(e){ console.error('Bulk save employees failed', e); }
  }
}

// Write a single employee record to Firebase exactly as structured (PRIMARY STORAGE)
function persistEmployeeToFirebase(emp){
  if(!db || !companyId || !emp) {
    console.warn('⚠️ Cannot persist to Firebase: missing db, companyId, or employee data');
    return; 
  }
  const key = emp.employeeId || emp.id; 
  if(!key) {
    console.warn('⚠️ Cannot persist employee: missing employeeId/id');
    return;
  }
  // Ensure we don't mutate original object; deep clone for Firebase
  const payload = JSON.parse(JSON.stringify(emp));
  console.log('🔄 Persisting employee to Firebase:', key);
  try {
    return db.ref(`companies/${companyId}/payroll/employees/${key}`).set(payload)
      .then(() => console.log('✅ Employee persisted to Firebase:', key))
      .catch(err => console.error('❌ Firebase persistence failed:', err));
  } catch(err){ 
    console.error('❌ Persist single employee failed:', err); 
  }
}

// Pay Elements (Firebase-first, real-time)
let PAY_ELEMENTS_CACHE = [];
function getPayElements(){ return PAY_ELEMENTS_CACHE; }

function attachPayElementsListener(){
  if(!db || !companyId){ return; }
  const ref = db.ref(`companies/${companyId}/payroll/payElements`);
  ref.off(); // ensure no duplicate listeners
  ref.on('value', snap => {
    const raw = snap.val() || {};
    PAY_ELEMENTS_CACHE = Object.values(raw);
    // Ensure BASIC element exists
    if(!PAY_ELEMENTS_CACHE.some(pe=>pe.code==='BASIC')){
      const basicEl={
        id: 'BASIC',
        code: 'BASIC',
        name: 'Basic Salary',
        type: 'earning',
        valueMode: 'amount',
        defaultAmount: 0,
        defaultPercent: 0,
        percentBase: null,
        percentBaseElement: null,
        taxable: true,
        active: true,
        formula: null,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      PAY_ELEMENTS_CACHE.push(basicEl);
      // Persist BASIC to Firebase
      savePayElement(basicEl);
    }
    // Ensure GROSS element exists (non-deletable), used to override system gross when formula provided
    if(!PAY_ELEMENTS_CACHE.some(pe=>pe.code==='GROSS')){
      const grossEl={
        id: 'GROSS',
        code: 'GROSS',
        name: 'Gross Salary',
        type: 'earning',
        valueMode: 'formula',
        defaultAmount: 0,
        defaultPercent: 0,
        percentBase: null,
        percentBaseElement: null,
        taxable: false,
        active: true,
        formula: '',
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      PAY_ELEMENTS_CACHE.push(grossEl);
      savePayElement(grossEl);
    }
    // Ensure OVERTIME element exists (standard, displays hours from selected month's timesheet)
    if(!PAY_ELEMENTS_CACHE.some(pe=>pe.code==='OVERTIME')){
      const overtimeEl={
        id: 'OVERTIME',
        code: 'OVERTIME',
        name: 'Overtime (hours)',
        type: 'earning',
        valueMode: 'amount',
        defaultAmount: 0,
        defaultPercent: 0,
        percentBase: null,
        percentBaseElement: null,
        taxable: false, // hours only, do not include in taxable by default
        active: true,
        formula: null,
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      PAY_ELEMENTS_CACHE.push(overtimeEl);
      savePayElement(overtimeEl);
    }
    console.log('🔄 Pay elements updated from Firebase:', PAY_ELEMENTS_CACHE.length);
    renderPayElements();
    renderTemplateElementSelectors();
    reloadRuleSelects?.();
    dispatchSync('payroll:payElements:changed');
  }, err => console.error('❌ Pay elements listener error', err));
}

function savePayElement(pe){
  if(!db || !companyId || !pe || !pe.id){ console.warn('Cannot save pay element – missing data'); return; }
  db.ref(`companies/${companyId}/payroll/payElements/${pe.id}`).set(pe)
    .then(()=> {
      console.log('✅ Pay element saved:', pe.id);
      // CRITICAL: Refresh templates immediately when any pay element changes
      // This ensures that formula/calculation changes immediately reflect in all templates
      console.log('🔄 [savePayElement] Refreshing templates after pay element change...');
      renderTemplates();
      renderPayElements();
      renderTemplateElementSelectors();
      // Dispatch event to notify listeners
      window.dispatchEvent(new Event('payroll:payElements:changed'));
    })
    .catch(e=> console.error('❌ Save pay element failed', e));
}

function deletePayElementFromFirebase(id){
  if(!db || !companyId || !id) return;
  console.log('🔄 Deleting pay element from Firebase:', id);
  db.ref(`companies/${companyId}/payroll/payElements/${id}`).remove()
    .then(()=> console.log('✅ Pay element deleted in Firebase:', id))
    .catch(err=> console.error('❌ Failed to delete pay element in Firebase:', err));
}

// Backward compatibility shim (some legacy calls expect savePayElements with array)
function savePayElements(arr){
  if(!Array.isArray(arr)) return;
  arr.forEach(pe=> savePayElement(pe));
}

// Templates (Firebase real-time)
let TEMPLATE_CACHE = [];
let RULES_CACHE = [];
function getTemplates(){ return TEMPLATE_CACHE; }
function getRules(){ return RULES_CACHE; }

function attachTemplatesListener(){
  if(!db || !companyId) return;
  const ref = db.ref(`companies/${companyId}/payroll/payslipTemplates`);
  ref.off();
  ref.on('value', snap => {
    const raw = snap.val() || {};
    TEMPLATE_CACHE = Object.values(raw);
    console.log('🔄 Templates updated from Firebase:', TEMPLATE_CACHE.length);
    renderTemplates();
    reloadTemplateSelect();
    reloadRuleSelects?.();
    dispatchSync('payroll:templates:changed');
  }, err => console.error('❌ Templates listener error', err));
}

// Rules (per template) - Firebase real-time
function attachRulesListener(){
  if(!db || !companyId) return;
  const ref = db.ref(`companies/${companyId}/payroll/templateRules`);
  ref.off();
  ref.on('value', snap=>{
    const raw = snap.val()||{};
    const arr = [];
    Object.entries(raw).forEach(([tplId, rules])=>{
      Object.values(rules||{}).forEach(r=> arr.push(r));
    });
    RULES_CACHE = arr;
    renderRules();
    reloadRuleSelects();
  }, err=> console.error('❌ Rules listener error', err));
}
attachRulesListener();

function saveRule(rule){
  if(!db || !companyId || !rule || !rule.id){ console.warn('Cannot save rule - missing data'); return; }
  const tplKey = rule.templateId;
  db.ref(`companies/${companyId}/payroll/templateRules/${tplKey}/${rule.id}`).set(rule)
    .then(()=> console.log('✅ Rule saved:', rule.id))
    .catch(e=> console.error('❌ Save rule failed', e));
}
function deleteRuleFromFirebase(rule){
  if(!db || !companyId || !rule) return;
  db.ref(`companies/${companyId}/payroll/templateRules/${rule.templateId}/${rule.id}`).remove()
    .then(()=> console.log('✅ Rule deleted:', rule.id))
    .catch(e=> console.error('❌ Delete rule failed', e));
}

function saveTemplate(tpl){
  if(!db || !companyId || !tpl || !tpl.id) { console.warn('Cannot save template - missing data'); return; }
  db.ref(`companies/${companyId}/payroll/payslipTemplates/${tpl.id}`).set(tpl)
    .then(()=> console.log('✅ Template saved:', tpl.id))
    .catch(e=> console.error('❌ Save template failed', e));
}

function deleteTemplateFromFirebase(id){
  if(!db || !companyId || !id) return;
  console.log('🔄 Deleting template from Firebase:', id);
  db.ref(`companies/${companyId}/payroll/payslipTemplates/${id}`).remove()
    .then(()=> console.log('✅ Template deleted:', id))
    .catch(e=> console.error('❌ Delete template failed', e));
}

// Backward compatibility if legacy code calls saveTemplates(items)
function saveTemplates(items){
  if(Array.isArray(items)) items.forEach(saveTemplate);
}

// Pay Runs
function getRuns(){ return readLS('payroll.runs', { items:[] }).items || []; }

async function loadRunsFromFirebase(){
  if(!db || !companyId) return;
  try {
    const snap = await db.ref(`companies/${companyId}/payroll/runs`).once('value');
    if(snap.exists()){
      const items = Object.values(snap.val());
      writeLS('payroll.runs', {items});
      renderRuns();
    }
  } catch(e){ console.warn('Load runs failed', e); }
}

function saveRuns(items){ 
  writeLS('payroll.runs',{items}); 
  if(db && companyId){ 
    items.forEach(r=>{ 
      try{ 
        db.ref(`companies/${companyId}/payroll/runs/${r.id}`).set(r); 
      }catch(e){ console.error('Save run failed', e); } 
    }); 
  } 
  dispatchSync('payroll:runs:changed'); 
}

/**************** Tab Navigation *****************/
$('#tabNav').addEventListener('click', e=>{ const btn=e.target.closest('button[data-tab]'); if(!btn) return; $$('#tabNav button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); $$('.tab-content').forEach(p=>p.classList.remove('active')); const id='panel-'+btn.dataset.tab; $('#'+id)?.classList.add('active'); });

// Global tab add button mapping
const tabAddMap = {
  'employees': ()=> $('#btnAddEmployee')?.click(),
  'pay-elements': ()=> $('#btnAddPayElement')?.click(),
  'pay-run': ()=> $('#btnAddPayRun')?.click(),
  'payslip-templates': ()=> $('#btnAddTemplate')?.click(),
  'rules': ()=> $('#btnAddRule')?.click(),
  // Settings tab uses its own Save button, so global add is a no-op
  'settings': ()=> {}
};
$('#tabAddBtn').addEventListener('click', ()=>{
   const activeTab = document.querySelector('#tabNav button.active')?.getAttribute('data-tab');
   if(activeTab && tabAddMap[activeTab]) tabAddMap[activeTab]();
});

/**************** Employees *****************/
function reloadTemplateSelect(){ const sel=$('#empPayslipTemplate'); if(!sel) return; const val=sel.value; sel.innerHTML='<option value="">-- Select Template --</option>'; getTemplates().forEach(t=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=`${t.name} (${t.code||t.category||t.id})`; sel.appendChild(opt); }); sel.value=val; }
reloadTemplateSelect();

function reloadRuleSelects(){
  // No-ops here; selections are now populated per-modal instance in buildRuleForm()
}

$('#employeeForm').addEventListener('submit', e=>{ e.preventDefault(); const employees=getEmployees(); const id = $('#empId').value.trim() || uid(); const template = $('#empPayslipTemplate').value || ''; const now=Date.now();
// Inline form has no per-employee company selector; default affiliation to main/current company
const __affType = 'main';
const __affId = (window.authManager?.currentUser?.companyId) || (typeof companyId!=='undefined'? companyId : '') || '';
const __affName = '';
const emp = {
  employeeId:id,
  id, // alias
  personal:{ firstName:$('#empFirstName').value.trim(), lastName:$('#empLastName').value.trim(), gender:$('#empGender').value, dob:$('#empDob').value, nationality:$('#empNationality').value, marital:$('#empMarital').value, dependents:Number($('#empDependents').value||0), address:$('#empAddress').value },
  contact:{ email:$('#empEmail').value.trim(), phone:$('#empPhone').value.trim(), city:$('#empCity').value.trim(), country:$('#empCountry').value.trim() },
  employment:{ department:$('#empDepartment').value.trim(), jobTitle:$('#empJobTitle').value.trim(), employmentType:$('#empEmploymentType').value, workLocation:$('#empWorkLocation').value.trim(), hireDate:$('#empHireDate').value.trim(), terminationDate:$('#empTerminationDate').value, status:$('#empStatus').value, managerId:$('#empManagerId').value.trim(), grade:$('#empGrade').value.trim(), level:$('#empLevel').value.trim(), payFrequency:$('#empPayFrequency').value, basicSalary:Number($('#empBasicSalary').value||0), currency:($('#empBankCurrency')?$('#empBankCurrency').value.trim():''), payslipTemplateId:template, companyAffiliation:{ type:__affType, id:__affId, name:__affName } },
  payslipTemplateId: template,
  banking:{ bankName:$('#empBankName').value.trim(), accountName:$('#empAccountName').value.trim(), accountNumber:$('#empAccountNumber').value.trim(), accountType:$('#empAccountType').value, iban:$('#empIBAN').value.trim(), swiftCode:$('#empSwiftCode').value.trim(), bankCode:$('#empBankCode').value.trim(), branchCode:$('#empBranchCode').value.trim(), branchName:$('#empBranchName').value.trim(), routingNumber:$('#empRoutingNumber').value.trim(), bsbCode:$('#empBSBCode').value.trim(), ifscCode:$('#empIFSCCode').value.trim(), ribKey:$('#empRibKey').value.trim(), transitNumber:$('#empTransitNumber').value.trim(), institutionNumber:$('#empInstitutionNumber').value.trim(), currency:$('#empBankCurrency').value.trim(), bankAddress:$('#empBankAddress').value.trim() },
  statutory:{ taxId:$('#empTaxId').value.trim(), ssn:$('#empSSN').value.trim(), pension:$('#empPension').value.trim(), nationalId:$('#empNationalId').value.trim() },
  emergency:{ name:'', relation:'', phone:'', email:'' },
  notes:$('#empNotes').value.trim(),
  createdAt: now,
  updatedAt: now,
  companyId: companyId || null,
  employerCompanyType: __affType,
  employerCompanyId: __affId,
  employerCompanyName: __affName
};
const existingIdx = employees.findIndex(x=>x.employeeId===id);
if(existingIdx>=0) employees[existingIdx]=emp; else employees.push(emp);
// Store directly to Firebase real-time database (primary storage)
persistEmployeeToFirebase(emp);
// Update local cache for UI responsiveness  
saveEmployees(employees);
if(db && companyId){ try{ db.ref(`companies/${companyId}/payroll/employees/${id}/payslipTemplateId`).set(template || ''); db.ref(`companies/${companyId}/payroll/employees/${id}/employment/payslipTemplateId`).set(template || ''); }catch(e){ console.warn('Template sync failed', e);} }
$('#employeeForm').reset(); $('#empId').value=''; renderEmployees(); alert('Employee saved.'); });

function renderEmployees(){
  const tbody=$('#employeesTbody');
  const employees=getEmployees();
  if(!employees || !employees.length){
    tbody.innerHTML='<tr><td colspan="8" class="empty">No employees yet</td></tr>';
    return;
  }
  const rows = employees.map(raw=>{
    // Defensive normalization in case structure changed / older records
    const emp = raw || {};
    const personal = emp.personal || {};
    const contact = emp.contact || {};
    const employment = emp.employment || {};
    const id = emp.employeeId || emp.id || '';
    const first = personal.firstName || emp.firstName || '';
    const last = personal.lastName || emp.lastName || '';
    const full = `${first} ${last}`.trim();
    const dept = employment.department || emp.department || '';
    const jobTitle = employment.jobTitle || emp.jobTitle || '';
    const status = employment.status || emp.status || 'Active';
    // Resolve assigned payslip template key as robustly as possible
    // Prefer canonical template ID, then fallbacks for legacy records
    const tmpl = (
      employment.payslipTemplateId || emp.payslipTemplateId ||
      employment.payslipCategory || employment.payslipTemplate || employment.payslipTemplateId ||
      emp.payslipCategory || emp.payslipTemplate || emp.payslipTemplateId || ''
    );
    const basic = Number(employment.basicSalary || emp.basicSalary || 0);
    return `<tr data-id="${id}" data-template="${tmpl || ''}" title="Click to preview payslip template">
      <td>${id||'-'}</td>
      <td>${full || contact.email || '-'}</td>
      <td>${dept||''}</td>
      <td>${jobTitle||''}</td>
      <td><span class="status-badge ${status==='Active'?'status-posted':'status-draft'}">${status}</span></td>
      <td><div class="actions"><button class="btn" data-edit-emp="${id}"><i class="fas fa-pen"></i></button><button class="btn-danger" data-del-emp="${id}"><i class="fas fa-trash"></i></button></div></td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rows || '<tr><td colspan="6" class="empty">No employees yet</td></tr>';

  // Re-bind edit & delete events (same logic as before)
  $$('[data-edit-emp]').forEach(btn=>btn.addEventListener('click',()=>{ 
    const id=btn.dataset.editEmp; 
    const emp=getEmployees().find(e=> (e.employeeId||e.id)===id); 
    if(!emp) return; 
    const form = buildEmployeeForm();
    openEntityModal('Edit Employee', form);
    // Use form-scoped selectors to avoid colliding with any legacy hidden form
    const q = sel => form.querySelector(sel);
    const personal = emp.personal || {}; const contact = emp.contact || {}; const employment = emp.employment || {}; const banking = emp.banking || {}; const statutory=emp.statutory||{}; const emergency=emp.emergency||{};
    // Populate immediately (form already appended)
    const setVal = (idSel, val) => { const el = q(idSel); if(el) el.value = val ?? ''; };
    setVal('#empId', emp.employeeId || emp.id || '');
    setVal('#empFirstName', personal.firstName||emp.firstName||'');
    setVal('#empLastName', personal.lastName||emp.lastName||'');
    setVal('#empGender', personal.gender||'');
    setVal('#empDob', personal.dob||'');
    setVal('#empNationality', personal.nationality||'');
    setVal('#empMarital', personal.marital||'');
    setVal('#empDependents', personal.dependents||0);
    setVal('#empAddress', personal.address||'');
    setVal('#empEmail', contact.email||'');
    setVal('#empPhone', contact.phone||'');
    setVal('#empCity', personal.city||contact.city||'');
    setVal('#empCountry', personal.country||contact.country||'');
    setVal('#empDepartment', employment.department||'');
    setVal('#empJobTitle', employment.jobTitle||'');
    setVal('#empEmploymentType', employment.employmentType||'');
    setVal('#empWorkLocation', employment.workLocation||'');
  // Seniority date was not prefilled previously
  setVal('#empSeniorityDate', employment.seniorityDate || personal.seniorityDate || '');
    // Compute and set Seniority Years based on the date
    try{
      const senStr = (employment.seniorityDate || personal.seniorityDate || '').trim();
      let years = 0;
      if(senStr){
        const d = new Date(senStr);
        if(!isNaN(d.getTime())){
          const now = new Date();
          years = now.getFullYear() - d.getFullYear();
          const anniv = new Date(now.getFullYear(), d.getMonth(), d.getDate());
          if(now < anniv) years -= 1;
          if(!Number.isFinite(years) || years < 0) years = 0;
        }
      }
      setVal('#empSeniorityYears', years);
    }catch(e){ /* ignore */ }
    setVal('#empHireDate', employment.hireDate||'');
    setVal('#empTerminationDate', employment.terminationDate||'');
    setVal('#empStatus', employment.status||'Active');
    setVal('#empManagerId', employment.managerId||'');
    setVal('#empGrade', employment.grade||'');
    setVal('#empLevel', employment.level||'');
    setVal('#empPayFrequency', employment.payFrequency||'Monthly');
  setVal('#empWorkingHoursWeek', (employment.workingHoursWeek!=null? employment.workingHoursWeek : 40));
  setVal('#empWorkingHoursDay', (employment.workingHoursDay!=null? employment.workingHoursDay : 8));
    setVal('#empBasicSalary', employment.basicSalary||0);
    setVal('#empCurrency', employment.currency||'USD');
    setVal('#empPayslipTemplate', employment.payslipTemplateId||employment.payslipCategory||employment.payslipTemplate||emp.payslipTemplateId||'');
    // Ensure Payslip Template select resolves by id OR code/category and waits for async template list
    try{
      const tplSel = form.querySelector('#empPayslipTemplate');
      const desiredRaw = (employment.payslipTemplateId||employment.payslipCategory||employment.payslipTemplate||emp.payslipTemplateId||'').toString().trim();
      // Resolve a provided key to a template id using current cache
      const resolveTplId = (key)=>{
        if(!key) return '';
        const up = key.toUpperCase();
        const list = (typeof getTemplates==='function') ? (getTemplates()||[]) : [];
        // Try exact id match first
        let found = list.find(t=> String(t.id||'')===key);
        if(found) return String(found.id);
        // Then match by category/code case-insensitively
        found = list.find(t=> String(t.category||t.code||'').trim().toUpperCase()===up);
        return found ? String(found.id) : '';
      };
      // Populate options if empty
      const populateTplOptions = ()=>{
        if(!tplSel) return;
        const list = (typeof getTemplates==='function') ? (getTemplates()||[]) : [];
        if(!tplSel.options || tplSel.options.length<=1){
          tplSel.innerHTML = '<option value="">-- Select Template --</option>' + list.map(t=>`<option value="${t.id}">${t.name} (${t.code||t.category||t.id})</option>`).join('');
        }
      };
      let attempts=0;
      const trySelect = ()=>{
        attempts++;
        populateTplOptions();
        const resolved = resolveTplId(desiredRaw);
        if(tplSel && resolved){ tplSel.value = resolved; return; }
        // If still not resolved, retry a few times to allow async templates to load
        if(attempts<15){ setTimeout(trySelect, 120); }
      };
      // Kick off resolution
      trySelect();
      // Also listen once for template updates to re-try resolution
      const onTplChanged = ()=>{ trySelect(); window.removeEventListener('payroll:templates:changed', onTplChanged); };
      window.addEventListener('payroll:templates:changed', onTplChanged);
    }catch(e){ console.warn('Template select prefill failed', e); }
    setVal('#empBankName', banking.bankName||'');
    setVal('#empAccountName', banking.accountName||'');
    setVal('#empAccountNumber', banking.accountNumber||'');
    setVal('#empAccountType', banking.accountType||'');
    setVal('#empIBAN', banking.iban||'');
    setVal('#empSwiftCode', banking.swiftCode||'');
    setVal('#empBankCode', banking.bankCode||'');
    setVal('#empBranchCode', banking.branchCode||'');
    setVal('#empBranchName', banking.branchName||'');
    setVal('#empRoutingNumber', banking.routingNumber||'');
    setVal('#empBSBCode', banking.bsbCode||'');
    setVal('#empIFSCCode', banking.ifscCode||'');
    setVal('#empRibKey', banking.ribKey||'');
    setVal('#empTransitNumber', banking.transitNumber||'');
    setVal('#empInstitutionNumber', banking.institutionNumber||'');
    setVal('#empBankCurrency', banking.currency||'USD');
    setVal('#empBankAddress', banking.bankAddress||'');
    setVal('#empTaxId', statutory.taxId||'');
    setVal('#empSSN', statutory.ssn||'');
    setVal('#empPension', statutory.pension||'');
    setVal('#empNationalId', statutory.nationalId||'');
  // Legacy single emergency contact fields removed from UI; do not set
    setVal('#empNotes', emp.notes||'');

    // Ensure Company select reflects the employee's affiliation once options load
    try{
      const companySel = form.querySelector('#empCompanySelect');
      const affiliation = (employment.companyAffiliation || {
        type: 'main',
        id: (window.authManager?.currentUser?.companyId) || ''
      });
      const desired = affiliation?.type && affiliation?.id ? `${affiliation.type==='subcontractor'?'sub':'main'}:${affiliation.id}` : '';
      let attempts = 0;
      const trySet = ()=>{
        attempts++;
        if(!companySel){ return; }
        const hasOption = desired ? Array.from(companySel.options).some(o=>o.value===desired) : false;
        if(hasOption){ companySel.value = desired; return; }
        if(attempts < 15){ setTimeout(trySet, 120); }
      };
      trySet();
    }catch(e){ console.warn('Company select prefill failed', e); }
    // Force apply contract autofill to ensure authoritative fields like Dependents match contract pages
    try { setTimeout(()=> autoFillEmployeeFromContract(form), 180); } catch(e) { /* ignore */ }
    // Make all fields read-only except Company, Employee ID, and Banking tab fields
    try { setTimeout(()=> makeEmployeeModalReadOnly(form), 240); } catch(e) { /* ignore */ }
  }));
  $$('[data-del-emp]').forEach(btn=>btn.addEventListener('click',()=>{
    if(!confirm('Are you sure you want to delete this employee? This action cannot be undone.')) return;
    const id=btn.dataset.delEmp;
    // Delete from Firebase real-time database (primary storage)
    if(db && companyId && id){
      try{
        db.ref(`companies/${companyId}/payroll/employees/${id}`).remove()
          .then(() => console.log('✅ Employee deleted from Firebase:', id))
          .catch(err => console.error('❌ Firebase delete failed:', err));
      }catch(e){ console.error('Delete operation failed:', e); }
    }
    // Update local cache
    let employees=getEmployees().filter(e=> (e.employeeId||e.id)!==id);
    saveEmployees(employees);
    renderEmployees();
    alert('Employee deleted successfully.');
  }));

  // Row click: open the employee's payslip template preview (delegated)
  if(!tbody.__rowClickWired){
    console.log('🔧 [Setup] Attaching employee row click handler to tbody:', tbody);
    tbody.addEventListener('click', (e)=>{
      console.log('🖱️ [Click] Employee table clicked:', e.target);
      const tr = e.target.closest('tr[data-id]');
      if(!tr) {
        console.log('⚠️ [Click] No tr[data-id] found');
        return;
      }
      if(e.target.closest('.actions')) {
        console.log('⚠️ [Click] Clicked on actions, ignoring');
        return;
      }
      console.log('✅ [Click] Valid employee row click detected:', tr);
      const empId = tr.getAttribute('data-id');
      const emp = getEmployees().find(x=> (x.employeeId||x.id)===empId) || {};
      // First: toggle a subrow that shows this month's approved timesheet (if any)
      try{
        // Close any other open subrows
        Array.from(tr.parentElement.querySelectorAll('tr.ts-subrow')).forEach(r=>{ if(r.previousElementSibling!==tr) r.remove(); });
        // If already open for this row, just toggle off
        if(tr.nextElementSibling && tr.nextElementSibling.classList.contains('ts-subrow')){ tr.nextElementSibling.remove(); return; }
        const employment = emp.employment || {};
        const contact = emp.contact || {};
        // Determine which month to show: use selected run period if available, else current month
        const runMonthEl = document.querySelector('#runMonth');
        const runYearEl = document.querySelector('#runYear');
        let monthKey = '';
        if(runMonthEl && runYearEl && runMonthEl.value && runYearEl.value){
          const mmSel = String(Number(runMonthEl.value)).padStart(2,'0');
          const yySel = String(runYearEl.value);
          monthKey = `${yySel}-${mmSel}`;
        } else {
          const monthNow = new Date();
          const yyyy = monthNow.getFullYear();
          const mm = String(monthNow.getMonth()+1).padStart(2,'0');
          monthKey = `${yyyy}-${mm}`; // matches profile timesheet.month format
        }

        // Helper cache on window
  window.__tsCache = window.__tsCache || {};
  const bestEmail = (contact.email || emp.personal?.email || emp.email || '').trim().toLowerCase();
  const cacheKey = `${bestEmail}|${monthKey}`;
        const renderSubrow = (ts)=>{
          // Format YYYY-MM to 'Month YYYY' (e.g., 'September 2025')
          const formatMonthLabel = (m)=>{
            try {
              if(!m || typeof m !== 'string') return '';
              const parts = m.split('-');
              const y = parseInt(parts[0], 10);
              const mm = parseInt(parts[1], 10);
              if(!y || !mm) return m;
              const d = new Date(y, mm - 1, 1);
              return d.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            } catch(e){ return m; }
          };
          // Compute weekly overtime exactly like profile (use saved overtimeHours when present)
          const getISOWeekNumber = (date)=>{
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
          };
          const daysArr = Array.isArray(ts?.days) ? ts.days : [];
          const allocatedWeekly = (ts && typeof ts.allocatedWeeklyHours === 'number' && ts.allocatedWeeklyHours > 0)
            ? ts.allocatedWeeklyHours
            : ((typeof employment.workingHoursWeek === 'number' && employment.workingHoursWeek > 0) ? employment.workingHoursWeek : 40);
          const weeksMap = {};
          daysArr.forEach(d=>{ const h=Number(d.hours||0); if(d.date){ const wk=getISOWeekNumber(new Date(d.date)); weeksMap[wk]=(weeksMap[wk]||0)+h; } });
          const weeklyRows = Object.keys(weeksMap).sort((a,b)=>Number(a)-Number(b)).map(w=>{ const h=Number(weeksMap[w]||0); const ot=Math.max(0, Number((h-allocatedWeekly).toFixed(2))); return {week:Number(w), hours:Number(h.toFixed(2)), overtime:ot}; });
          // Switch to daily allocation overtime: sum over days of max(0, hours - workingHoursDay)
          const workingHoursDay = (typeof employment.workingHoursDay === 'number' && employment.workingHoursDay > 0) ? employment.workingHoursDay : 8;
          const computedDailyOvertime = daysArr.reduce((sum, d) => {
            const h = Number(d.hours || 0);
            const ot = Math.max(0, Number((h - workingHoursDay).toFixed(2)));
            return sum + ot;
          }, 0);
          const overtimeDisplay = Number(computedDailyOvertime.toFixed(2));
          const totalHoursDisplay = (ts && typeof ts.totalHours === 'number') ? Number(ts.totalHours) : daysArr.reduce((s,d)=> s + (Number(d.hours||0)||0), 0);

          const sub = document.createElement('tr');
          sub.className = 'ts-subrow';
          sub.innerHTML = `<td colspan="6" style="background:#f9fafb; padding:10px 12px; border-top:1px dashed #e5e7eb;">
            <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
              <div>
                <div style="font-weight:600; color:#111827;">${ts ? (ts.month ? formatMonthLabel(ts.month) : formatMonthLabel(monthKey)) : formatMonthLabel(monthKey)}</div>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn" data-open-template>View Payslip Template</button>
                ${ts? `<button class="btn" data-expand-days>Show Days</button>`:''}
              </div>
            </div>
            ${ts? `<div class="ts-days" style="display:none; margin-top:10px;">
                <div style="overflow:auto;">
                  <table style="width:100%; border-collapse:collapse;">
                    <thead>
                      <tr style="background:#eef2ff; color:#374151;">
                        <th style="text-align:left; padding:6px; border:1px solid #e5e7eb;">Date</th>
                        <th style="text-align:right; padding:6px; border:1px solid #e5e7eb;">Hours</th>
                        <th style="text-align:right; padding:6px; border:1px solid #e5e7eb;">Overtime</th>
                        <th style="text-align:left; padding:6px; border:1px solid #e5e7eb;">Comment</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${(Array.isArray(ts.days)? ts.days:[]).map(d=>{
                        const h = Number(d.hours||0);
                        const date = (d.date||'').slice(0,10);
                        const ot = Math.max(0, Number((h - workingHoursDay).toFixed(2)));
                        const c = (d.comment||'');
                        return `<tr>
                          <td style=\"padding:6px; border:1px solid #e5e7eb;\">${date}</td>
                          <td style=\"padding:6px; border:1px solid #e5e7eb; text-align:right;\">${(isNaN(h)?0:h).toFixed(2)}</td>
                          <td style=\"padding:6px; border:1px solid #e5e7eb; text-align:right;\">${ot.toFixed(2)}</td>
                          <td style=\"padding:6px; border:1px solid #e5e7eb;\">${c}</td>
                        </tr>`; }).join('')}
                      <tr>
                        <td style="padding:6px; border:1px solid #e5e7eb; font-weight:600;">Total</td>
                        <td style="padding:6px; border:1px solid #e5e7eb; text-align:right; font-weight:600;">${Number(totalHoursDisplay||0).toFixed(2)}</td>
                        <td style="padding:6px; border:1px solid #e5e7eb; text-align:right; font-weight:600;">${Number(overtimeDisplay||0).toFixed(2)}</td>
                        <td style="padding:6px; border:1px solid #e5e7eb;"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
              </div>`:''}
          </td>`;
          tr.after(sub);
          const btnTpl = sub.querySelector('[data-open-template]');
          if(btnTpl){ btnTpl.addEventListener('click', ()=>{
            // Derive template key from row dataset or from employee record (multiple fallbacks)
            const tplKey = tr.getAttribute('data-template') || employment.payslipCategory || employment.payslipTemplate || employment.payslipTemplateId || emp.payslipCategory || emp.payslipTemplate || emp.payslipTemplateId || '';
            const templates = getTemplates() || [];
            let tpl = null;
            if(tplKey){
              tpl = templates.find(t=> t.id===tplKey) || templates.find(t=> String(t.category||t.code||'').toUpperCase()===String(tplKey).toUpperCase()) || null;
            }
            if(!tpl && !tplKey && templates.length===1){ tpl = templates[0]; }
            if(!tpl){ alert('No payslip template assigned to this employee.'); return; }
            openTemplatePreviewModal(tpl, emp||null);
          }); }
          const btnDays = sub.querySelector('[data-expand-days]');
          if(btnDays){ btnDays.addEventListener('click', ()=>{
            const box = sub.querySelector('.ts-days');
            if(!box) return; const visible = box.style.display!=='none';
            box.style.display = visible ? 'none' : 'block';
            btnDays.textContent = visible ? 'Show Days' : 'Hide Days';
          }); }
        };

        const cached = window.__tsCache[cacheKey];
        if(cached){ renderSubrow(cached.ts||null); return; }

        // If no email, we cannot query reliably
        if(!bestEmail){ renderSubrow(null); return; }
        // Fetch approved timesheet by submittedByEmail and month
        (async ()=>{
          try{
            const snap = await db.ref('timesheets').orderByChild('submittedByEmail').equalTo(bestEmail).once('value');
            const all = snap.exists()? Object.values(snap.val()||{}) : [];
            // filter current month approved
            const matches = all.filter(ts=> (ts.month||'')===monthKey && (ts.status||'').toLowerCase()==='approved');
            let best = null;
            if(matches.length){ best = matches.sort((a,b)=> (Number(b.updatedAt||b.createdAt||0) - Number(a.updatedAt||a.createdAt||0)) )[0]; }
            // If none for selected month, optionally fallback to latest approved of any month so user sees something helpful
            if(!best){
              const approved = all.filter(ts=> (ts.status||'').toLowerCase()==='approved');
              if(approved.length){ best = approved.sort((a,b)=> (Number(b.updatedAt||b.createdAt||0) - Number(a.updatedAt||a.createdAt||0)) )[0]; }
            }
            window.__tsCache[cacheKey] = { ts: best, at: Date.now() };
            renderSubrow(best||null);
          }catch(err){ console.warn('Timesheet fetch failed', err); renderSubrow(null); }
        })();
      }catch(err){ console.error('Render subrow failed', err); }

      // Do not auto-open payslip preview on row click anymore; users can open from the subrow button above
      return;
      // Legacy behavior below replaced by inline button inside the subrow
    }, { once: false });
    // Mark as wired to avoid duplicate delegation
    tbody.__rowClickWired = true;
    console.log('✅ [Setup] Employee row click handler attached successfully');
  } else {
    console.log('ℹ️ [Setup] Employee row click handler already wired');
  }
}
renderEmployees();

$('#resetEmpForm').addEventListener('click', ()=>{ $('#empId').value=''; $('#employeeFormCard').style.display='none'; });

// Toggle Employee Form
$('#btnAddEmployee').addEventListener('click', ()=>{ 
  openEntityModal('', buildEmployeeForm());
});

/**************** Pay Elements *****************/
function renderPayElements(){
  const tbody=$('#payElementsTbody');
  const arr=getPayElements();
  if(!arr.length){ tbody.innerHTML='<tr><td colspan="7" class="empty">No pay elements</td></tr>'; return; }
  // Order: BASIC first, then GROSS, then the rest by code
  const items = arr.slice().sort((a,b)=>{
    const rank = (code)=> code==='BASIC'?0 : (code==='GROSS'?1:2);
    const ra = rank((a.code||'').toUpperCase());
    const rb = rank((b.code||'').toUpperCase());
    if(ra!==rb) return ra-rb;
    return (a.code||'').localeCompare(b.code||'');
  });
  tbody.innerHTML = items.map(pe=>{
    let displayDefault='';
    if(pe.valueMode==='percent'){
      const baseTxt = pe.percentBase==='custom' ? (pe.percentBaseElement || 'element') : (pe.percentBase||'');
      displayDefault = (pe.defaultPercent||0).toFixed(2)+'%' + (baseTxt?` of ${baseTxt}`:'');
    } else if(pe.valueMode==='formula'){
      const fmtFormula = (f)=>{
        try{
          let s = String(f||'');
          if(typeof normalizeFormulaForDisplay==='function') s = normalizeFormulaForDisplay(s);
          // Escape HTML
          s = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
          return s || '—';
        }catch{ return '—'; }
      };
      displayDefault = `<code style="font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:.72rem;">${fmtFormula(pe.formula)}</code>`;
    } else {
      displayDefault = Number(pe.defaultAmount||0).toFixed(2);
    }
    const nonDeletable = (pe.code==='BASIC' || pe.code==='GROSS');
    const delBtn = nonDeletable ? '' : `<button class=\"btn-danger\" data-del-pe=\"${pe.id}\"><i class=\"fas fa-trash\"></i></button>`;
    return `<tr data-id=\"${pe.id}\"><td>${pe.code}</td><td>${pe.name}</td><td><span class=\"badge ${pe.type==='earning'?'tag-earning':'tag-deduction'}\">${pe.type}</span></td><td>${displayDefault}</td><td>${pe.taxable?'Yes':'No'}</td><td>${pe.active?'Yes':'No'}</td><td><div class=\"actions\"><button class=\"btn\" data-edit-pe=\"${pe.id}\"><i class=\"fas fa-pen\"></i></button>${delBtn}</div></td></tr>`;
  }).join('');
$$('[data-edit-pe]').forEach(btn=>btn.addEventListener('click',()=>{ 
  const id=btn.dataset.editPe; 
  const pe=getPayElements().find(p=>p.id===id); 
  if(!pe) return; 
  
  // Open modal with form
  const form = buildPayElementForm();
  openEntityModal('Edit Pay Element', form);
  
  // Populate all fields after modal is open
  setTimeout(() => {
    form.querySelector('#peEditingId').value=pe.id; 
    form.querySelector('#peCode').value=pe.code; 
    form.querySelector('#peName').value=pe.name; 
    const typeSel = form.querySelector('#peType');
    if(typeSel){ typeSel.value = pe.type; typeSel.dispatchEvent(new Event('change')); }
    const deductSel = form.querySelector('#peDeductFrom');
    if(deductSel){ deductSel.value = pe.deductFrom || 'employee'; }
    // Sync new checkbox UI with stored value
    const empCb = form.querySelector('#peDeductEmp');
    const cmpCb = form.querySelector('#peDeductCmp');
    const whoVal = pe.deductFrom || 'employee';
    if(empCb && cmpCb){
      empCb.checked = (whoVal==='employee' || whoVal==='both');
      cmpCb.checked = (whoVal==='company' || whoVal==='both');
    }
    form.querySelector('#peValueMode').value=pe.valueMode|| (pe.defaultPercent? 'percent':'amount');
    const modeSel=form.querySelector('#peValueMode');
    const evt=new Event('change'); modeSel.dispatchEvent(evt);
    if(pe.valueMode==='percent'){
      form.querySelector('#pePercent').value=pe.defaultPercent||0;
      const baseSel = form.querySelector('#pePercentBase');
      if(pe.percentBase==='custom' && pe.percentBaseElement){ baseSel.value = `__pe__:${pe.percentBaseElement}`; }
      else { baseSel.value = pe.percentBase||'basic'; }
    } else if(pe.valueMode==='formula'){
      const f = form.querySelector('#peFormula');
      if(f){ f.value = pe.formula || ''; }
    } else {
      form.querySelector('#peAmount').value=pe.defaultAmount||0; 
    }
    // Prefill company calculation if Deducted From is Both
    if((pe.deductFrom||'employee')==='both'){
      const cmpModeSel = form.querySelector('#peCmpValueMode');
      const cmpPercent = form.querySelector('#peCmpPercent');
      const cmpPercentBase = form.querySelector('#peCmpPercentBase');
      const cmpAmount = form.querySelector('#peCmpAmount');
      const cmpFormula = form.querySelector('#peCmpFormula');
      const cmpTaxable = form.querySelector('#peCmpTaxable');
      const ec = pe.employeeConfig || {};
      const cc = pe.companyConfig || {};
      // Show the company block
      const whoSel = form.querySelector('#peDeductFrom'); if(whoSel){ whoSel.value='both'; whoSel.dispatchEvent(new Event('change')); }
      // Employee side already set from top-level; now set company
      if(cmpModeSel){ cmpModeSel.value = cc.valueMode || 'amount'; cmpModeSel.dispatchEvent(new Event('change')); }
      if(cmpModeSel?.value==='percent'){
        if(cmpPercent) cmpPercent.value = cc.defaultPercent || 0;
        if(cmpPercentBase){
          if(cc.percentBase==='custom' && cc.percentBaseElement){ cmpPercentBase.value = `__pe__:${cc.percentBaseElement}`; }
          else { cmpPercentBase.value = cc.percentBase || 'basic'; }
        }
      } else if(cmpModeSel?.value==='formula'){
        if(cmpFormula) cmpFormula.value = cc.formula || '';
      } else {
        if(cmpAmount) cmpAmount.value = cc.defaultAmount || 0;
      }
      if(cmpTaxable){ cmpTaxable.value = ((cc.taxable!==undefined? cc.taxable : pe.taxable) ? 'true' : 'false'); }
    }
  form.querySelector('#peTaxable').value=pe.taxable? 'true':'false'; 
  form.querySelector('#peActive').value=pe.active? 'true':'false'; 

    // BASIC element customization: hide value mode selector & enforce amount mode
    const peCodeInput = form.querySelector('#peCode');
    const modeLabel = modeSel.closest('label');
    function applyBasicModeCheck(){
      const isBasic = peCodeInput.value.trim().toUpperCase()==='BASIC';
      if(isBasic){
        if(modeLabel) modeLabel.style.display='none';
        modeSel.value='amount';
        modeSel.dispatchEvent(new Event('change'));
        // Hide any percent-related wrappers explicitly
  ['#pePercentWrapper','#pePercentBaseWrapper'].forEach(sel=>{ const el=form.querySelector(sel); if(el) el.style.display='none'; });
        const formulaWrap=form.querySelector('#peFormulaWrapper'); if(formulaWrap) formulaWrap.style.display='none';
        // Hide type and amount fields for BASIC (read-only enforced)
        const typeLabel = form.querySelector('#peType')?.closest('label');
        const amountLabel = form.querySelector('#peAmountWrapper');
        if(typeLabel) typeLabel.style.display='none';
        if(amountLabel) amountLabel.style.display='none';
      } else {
        if(modeLabel) modeLabel.style.display='';
        const typeLabel = form.querySelector('#peType')?.closest('label');
        const amountLabel = form.querySelector('#peAmountWrapper');
        if(typeLabel) typeLabel.style.display='';
        if(amountLabel) amountLabel.style.display='';
      }
    }
    applyBasicModeCheck();
    peCodeInput.addEventListener('input', applyBasicModeCheck);
  }, 50);
}));
$$('[data-del-pe]').forEach(btn=>btn.addEventListener('click',()=>{ 
  const id=btn.dataset.delPe; 
  const pe=getPayElements().find(p=>p.id===id);
  if(pe && (pe.code==='BASIC' || pe.code==='GROSS')){ alert(`${pe.code} pay element cannot be deleted.`); return; }
  if(!confirm('Delete pay element?')) return; 
  deletePayElementFromFirebase(id); // listener will refresh table
})); }
renderPayElements();

$('#payElementForm').addEventListener('submit', e=>{ 
  e.preventDefault(); 
  const editing=$('#peEditingId').value; 
  const now = Date.now();
  const modeVal = $('#peValueMode')?.value || 'amount';
  // Map percent base from unified dropdown
  const baseVal = $('#pePercentBase')?.value || 'basic';
  const baseMapped = { percentBase: 'basic', percentBaseElement: null };
  if(baseVal?.startsWith('__pe__:')){ baseMapped.percentBase='custom'; baseMapped.percentBaseElement=baseVal.substring(7); }
  else if(['basic','gross','net'].includes(baseVal)){ baseMapped.percentBase = baseVal; }

  const payload={ 
    id: editing || uid(), 
    code:$('#peCode').value.trim().toUpperCase(), 
    name:$('#peName').value.trim(), 
    type:$('#peType').value, 
    deductFrom: ($('#peType').value==='deduction') ? ($('#peDeductFrom')?.value || 'employee') : null,
    defaultAmount: modeVal==='amount' ? Number($('#peAmount').value||0) : 0, 
    defaultPercent: modeVal==='percent' ? Number($('#pePercent')?.value||0) : 0,
    valueMode: modeVal,
    percentBase: modeVal==='percent' ? baseMapped.percentBase : null,
    percentBaseElement: modeVal==='percent' ? baseMapped.percentBaseElement : null,
    formula: modeVal==='formula' ? String($('#peFormula')?.value||'').trim() : null,
    taxable:$('#peTaxable').value==='true', 
  active:$('#peActive').value==='true', 
    createdAt: editing ? (getPayElements().find(p=>p.id===editing)?.createdAt || now) : now, 
    updatedAt: now 
  }; 
  savePayElement(payload); // Firebase listener will refresh UI
  e.target.reset(); 
  $('#peEditingId').value=''; 
  $('#payElementFormCard').style.display='none'; 
  alert('Pay element saved.'); 
});

// Toggle Pay Element Form
$('#btnAddPayElement').addEventListener('click', ()=>{ 
  openEntityModal('Add Pay Element', buildPayElementForm());
});
// Note: Pay element formulas are evaluated during draft run generation only and reflected in the line editor totals.

/**************** Payslip Templates *****************/
function renderTemplateElementSelectors(){ const earnDiv=$('#tplEarnings'); const dedDiv=$('#tplDeductions'); if(!earnDiv||!dedDiv) return; const elements=getPayElements().filter(p=>p.active); earnDiv.innerHTML=''; dedDiv.innerHTML=''; elements.filter(p=>p.type==='earning').forEach(e=>{ const id='earn_'+e.id; const wrap=document.createElement('label'); wrap.style.fontSize='.55rem'; wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='4px'; wrap.innerHTML=`<input type="checkbox" id="${id}" data-pe="${e.id}" data-kind="earning" /> <span>${e.code}</span>`; earnDiv.appendChild(wrap); }); elements.filter(p=>p.type==='deduction').forEach(e=>{ const id='ded_'+e.id; const wrap=document.createElement('label'); wrap.style.fontSize='.55rem'; wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='4px'; wrap.innerHTML=`<input type="checkbox" id="${id}" data-pe="${e.id}" data-kind="deduction" /> <span>${e.code}</span>`; dedDiv.appendChild(wrap); }); }
renderTemplateElementSelectors();

// Scoped population for modal template form (add/edit)
function populateTemplateElementSelectors(targetForm, selectedEarn = [], selectedDed = []){
  if(!targetForm) return; 
  const earnDiv = targetForm.querySelector('#tplEarnings');
  const dedDiv = targetForm.querySelector('#tplDeductions');
  if(!earnDiv || !dedDiv) return;
  const elements = getPayElements().filter(p=>p.active);
  earnDiv.innerHTML='';
  dedDiv.innerHTML='';
  const norm = (s)=> String(s||'').trim().toUpperCase();
  const isSelected = (pe, arr)=> Array.isArray(arr) && arr.some(x=> String(x)===String(pe.id) || norm(x)===norm(pe.code));
  elements.filter(p=>p.type==='earning').forEach(e=>{
    const id='earn_'+e.id;
    const wrap=document.createElement('label');
    wrap.style.fontSize='.55rem';
    wrap.style.display='flex';
    wrap.style.alignItems='center';
    wrap.style.gap='4px';
    const checked = isSelected(e, selectedEarn) ? 'checked' : '';
    wrap.innerHTML=`<input type="checkbox" id="${id}" data-pe="${e.id}" data-kind="earning" ${checked}/> <span>${e.code}</span>`;
    earnDiv.appendChild(wrap);
  });
  elements.filter(p=>p.type==='deduction').forEach(e=>{
    const id='ded_'+e.id;
    const wrap=document.createElement('label');
    wrap.style.fontSize='.55rem';
    wrap.style.display='flex';
    wrap.style.alignItems='center';
    wrap.style.gap='4px';
    const checked = isSelected(e, selectedDed) ? 'checked' : '';
    wrap.innerHTML=`<input type="checkbox" id="${id}" data-pe="${e.id}" data-kind="deduction" ${checked}/> <span>${e.code}</span>`;
    dedDiv.appendChild(wrap);
  });
}

function renderTemplates(){ const tbody=$('#templatesTbody'); const templates=getTemplates(); if(!templates.length){ tbody.innerHTML='<tr><td colspan="6" class="empty">No templates</td></tr>'; return; } const employees=getEmployees(); const usageIndex = employees.reduce((acc,e)=>{ const tid = e.payslipTemplateId || e.employment?.payslipTemplateId || e.employment?.payslipCategory || e.employment?.payslipTemplate || ''; if(tid){ acc[tid]=(acc[tid]||0)+1; } return acc; },{}); tbody.innerHTML=templates.map(t=>{ const usage=usageIndex[t.id] || usageIndex[t.category||t.code||t.id] || 0; return `<tr data-id="${t.id}"><td>${t.category||t.code||t.id}</td><td>${t.name}</td><td>${(t.earnings||[]).length}</td><td>${(t.deductions||[]).length}</td><td>${usage}</td><td><div class="actions"><button class="btn" data-edit-tpl="${t.id}"><i class="fas fa-pen"></i></button><button class="btn-danger" data-del-tpl="${t.id}"><i class="fas fa-trash"></i></button></div></td></tr>`; }).join('');
  // Attach row click (excluding action buttons)
  tbody.querySelectorAll('tr[data-id]').forEach(tr=>{
    tr.addEventListener('click', (e)=>{
      if(e.target.closest('.actions')) return; // ignore clicks on action buttons
      const id = tr.getAttribute('data-id');
      const tpl = getTemplates().find(t=>t.id===id);
      if(!tpl) return;
      openTemplatePreviewModal(tpl);
    });
  });
$$('[data-edit-tpl]').forEach(btn=>btn.addEventListener('click',()=>{ 
  const id=btn.dataset.editTpl; 
  const tpl=getTemplates().find(t=>t.id===id); 
  if(!tpl) return; 
  
  // Open modal with form
  const form = buildTemplateForm();
  openEntityModal('Edit Payslip Template', form);
  
  // Populate all fields after modal is open
  setTimeout(() => {
    form.querySelector('#tplEditingId').value=tpl.id; 
    form.querySelector('#tplCode').value=tpl.category||tpl.code||''; 
    form.querySelector('#tplName').value=tpl.name||''; 
    form.querySelector('#tplDesc').value=tpl.description||''; 
    // Populate element selectors with pre-selected values
    populateTemplateElementSelectors(form, tpl.earnings||[], tpl.deductions||[]);
  }, 50);
}));
$$('[data-del-tpl]').forEach(btn=>btn.addEventListener('click',()=>{ 
  if(!confirm('Delete payslip template?')) return; 
  const id=btn.dataset.delTpl; 
  deleteTemplateFromFirebase(id); // listener handles UI update
})); }
renderTemplates();

/** Rules UI **/
function renderRules(){ const tbody=$('#rulesTbody'); if(!tbody){ return; } const rules=getRules(); if(!rules.length){ tbody.innerHTML='<tr><td colspan="6" class="empty">No rules</td></tr>'; return; } const tplIndex = new Map(getTemplates().map(t=>[(t.category||t.code||t.id), t]));
  tbody.innerHTML = rules.map(r=>{ const t=tplIndex.get(r.templateId); const cond = r.condition==='between' ? `${r.value1} and ${r.value2}` : `${r.condition} ${r.value1}`; const active=r.active? 'Yes':'No'; return `<tr data-id="${r.id}" data-tpl="${r.templateId}"><td>${t? (t.name+` (${t.category||t.code||t.id})`):r.templateId}</td><td>${r.elementCode}</td><td>${cond}</td><td><code>${(r.formula||'').replace(/</g,'&lt;')}</code></td><td>${active}</td><td><div class="actions"><button class="btn" data-edit-rule="${r.id}" data-tpl="${r.templateId}"><i class="fas fa-pen"></i></button><button class="btn-danger" data-del-rule="${r.id}" data-tpl="${r.templateId}"><i class="fas fa-trash"></i></button></div></td></tr>`; }).join('');
  $$('[data-del-rule]')?.forEach(btn=> btn.addEventListener('click',()=>{ const id=btn.dataset.delRule; const tpl=btn.dataset.tpl; const rule = getRules().find(x=>x.id===id && x.templateId===tpl); if(!rule) return; if(!confirm('Delete rule?')) return; deleteRuleFromFirebase(rule); }));
  $$('[data-edit-rule]')?.forEach(btn=> btn.addEventListener('click',()=>{ const id=btn.dataset.editRule; const tpl=btn.dataset.tpl; const rule = getRules().find(x=>x.id===id && x.templateId===tpl); if(!rule) return; const form = buildRuleForm(rule); openEntityModal('Edit Rule', form); }));
}

function buildRuleForm(existing){
  const form=document.createElement('form');
  form.className='grid cols-4';
  form.innerHTML=`
    <label>Template<select id="ruleTemplateSel"><option value="">-- Select Template --</option></select></label>
    <label>Target Element<select id="ruleElementSel"><option value="">-- Select Pay Element --</option></select></label>
    <label>Condition<select id="ruleCondSel">
      <option value=">">is greater than</option>
      <option value=">=">is greater or equal</option>
      <option value="<">is less than</option>
      <option value="<=">is less or equal</option>
      <option value="==">equals</option>
      <option value="between">is between</option>
    </select></label>
    <label id="ruleVal1WrapSel">Value 1<input type="number" step="0.01" id="ruleVal1Sel"></label>
    <label id="ruleVal2WrapSel" style="display:none;">Value 2<input type="number" step="0.01" id="ruleVal2Sel"></label>
    <label style="grid-column:1/-1;">Action Formula
      <textarea id="ruleFormulaSel" placeholder="Formula to apply when condition matches" rows="2"></textarea>
  <small style="color:#64748b;display:block;margin-top:6px;">Uses the same formula syntax as Pay Elements. Variables include BASIC, GROSS_PRE, NET_PRE, SENIORITY_YEARS, and any element codes. Result replaces the target element amount.</small>
    </label>
    <label>Active<select id="ruleActiveSel"><option value="true">Yes</option><option value="false">No</option></select></label>
    <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn-primary" type="submit"><i class="fas fa-save"></i> Save Rule</button>
      <button class="btn" type="button" id="ruleCancelBtnSel"><i class="fas fa-xmark"></i> Cancel</button>
    </div>
  `;
  // Populate selects
  const tplSel = form.querySelector('#ruleTemplateSel');
  getTemplates().forEach(t=>{ const opt=document.createElement('option'); opt.value=t.category||t.code||t.id; opt.textContent=`${t.name} (${t.category||t.code||t.id})`; tplSel.appendChild(opt); });
  const elSel = form.querySelector('#ruleElementSel');
  getPayElements().forEach(pe=>{ const opt=document.createElement('option'); opt.value=pe.code; opt.textContent=`${pe.code} - ${pe.name}`; elSel.appendChild(opt); });
  // Bind change for between
  form.querySelector('#ruleCondSel').addEventListener('change', ()=>{
    const v=form.querySelector('#ruleCondSel').value; form.querySelector('#ruleVal2WrapSel').style.display = (v==='between')? 'block':'none';
  });
  // Pre-fill if editing
  if(existing){
    form.dataset.editingId = existing.id;
    tplSel.value = existing.templateId||'';
    elSel.value = existing.elementCode||'';
    form.querySelector('#ruleCondSel').value = existing.condition||'>';
    form.querySelector('#ruleVal1Sel').value = existing.value1 ?? 0;
    if(existing.condition==='between'){
      form.querySelector('#ruleVal2WrapSel').style.display='block';
      form.querySelector('#ruleVal2Sel').value = existing.value2 ?? 0;
    }
    form.querySelector('#ruleActiveSel').value = existing.active? 'true':'false';
    form.querySelector('#ruleFormulaSel').value = existing.formula||'';
  }
  // Submit handler (scoped)
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const id = form.dataset.editingId || uid();
    const tpl = tplSel.value; const element = elSel.value; const cond=form.querySelector('#ruleCondSel').value;
    const v1 = Number(form.querySelector('#ruleVal1Sel').value||0);
    const v2 = Number(form.querySelector('#ruleVal2Sel').value||0);
    const active = form.querySelector('#ruleActiveSel').value==='true';
    const formula = String((form.querySelector('#ruleFormulaSel').value||'')).trim();
    if(!tpl||!element){ alert('Please select Template and Element'); return; }
    const payload = { id, templateId:tpl, elementCode:element, condition:cond, value1:v1, value2: cond==='between'? v2 : null, active, formula, createdAt:Date.now(), updatedAt:Date.now() };
    saveRule(payload);
    entityModalBackdrop.style.display='none';
    alert('Rule saved.');
  });
  // Cancel
  form.querySelector('#ruleCancelBtnSel').addEventListener('click', ()=>{ entityModalBackdrop.style.display='none'; });
  return form;
}

// Add button opens modal
$('#btnAddRule')?.addEventListener('click', ()=>{
  const form = buildRuleForm();
  openEntityModal('Add Rule', form);
});

$('#templateForm').addEventListener('submit', e=>{ 
  e.preventDefault(); 
  const earnings=[...$('#tplEarnings').querySelectorAll('input:checked')].map(cb=>cb.dataset.pe); 
  const deductions=[...$('#tplDeductions').querySelectorAll('input:checked')].map(cb=>cb.dataset.pe); 
  const editing=$('#tplEditingId').value; 
  const now=Date.now();
  const existing = editing ? getTemplates().find(t=>t.id===editing) : null;
  const payload={ 
    id: editing || uid(), 
    category:$('#tplCode').value.trim().toUpperCase(), 
    code:$('#tplCode').value.trim().toUpperCase(), 
    name:$('#tplName').value.trim(), 
    description:$('#tplDesc').value.trim()||'', 
    earnings, 
    deductions, 
    createdAt: existing ? existing.createdAt : now, 
    updatedAt: now 
  }; 
  saveTemplate(payload); // listener will refresh table & select
  $('#templateForm').reset(); 
  $('#tplEditingId').value=''; 
  $('#templateFormCard').style.display='none'; 
  alert('Template saved.'); 
});

// Toggle Template Form
$('#btnAddTemplate').addEventListener('click', ()=>{ 
  const form = buildTemplateForm();
  openEntityModal('Add Payslip Template', form);
  // Delay population slightly to ensure modal DOM is attached
  setTimeout(()=> populateTemplateElementSelectors(form), 30);
});

/**************** Payroll Run Generation *****************/
function populateRunSelectors(){ const monthSel=$('#runMonth'); const yearSel=$('#runYear'); const now=new Date(); if(monthSel.options.length===0){ for(let m=1;m<=12;m++){ const opt=document.createElement('option'); opt.value=m; opt.textContent=m.toString().padStart(2,'0'); if(m===now.getMonth()+1) opt.selected=true; monthSel.appendChild(opt);} } if(yearSel.options.length===0){ for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++){ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; if(y===now.getFullYear()) opt.selected=true; yearSel.appendChild(opt);} } }
populateRunSelectors();

// Toggle Pay Run Setup Form
$('#btnAddPayRun').addEventListener('click', ()=>{ 
    const formCard = $('#payRunSetupCard'); 
    if(formCard.style.display==='none' || !formCard.style.display) { 
        formCard.style.display='block'; 
        formCard.scrollIntoView({behavior:'smooth', block:'start'}); 
    } else { 
        formCard.style.display='none'; 
    } 
});

let draftRun = null; // {period, employees:[]}

$('#btnLoadRunEmployees').addEventListener('click',()=>{ const employees=getEmployees(); const filter=$('#runEmployeeFilter').value; const wrap=$('#runEmployeesContainer'); wrap.innerHTML=''; const applicable=employees.filter(e=> filter==='all' || e.employment.status==='Active'); if(!applicable.length){ wrap.innerHTML='<div class="empty" style="grid-column:1/-1;">No employees matched selection.</div>'; $('#btnGenerateRun').disabled=true; return; } applicable.forEach(emp=>{ const full=`${emp.personal.firstName||''} ${emp.personal.lastName||''}`.trim()||emp.contact.email||emp.employeeId; const div=document.createElement('div'); div.style.border='1px solid var(--border)'; div.style.borderRadius='8px'; div.style.background='#fff'; div.style.padding='12px 14px'; div.style.display='flex'; div.style.flexDirection='column'; div.style.gap='6px'; const cur=(emp.employment&&emp.employment.currency)||null; div.innerHTML=`<label style='display:flex;align-items:center;gap:8px;font-size:.65rem;'><input type='checkbox' data-run-emp='${emp.employeeId}' checked> <strong>${full}</strong> <span class='badge'>${emp.employment.payslipCategory||'No Template'}</span></label><div style='font-size:.55rem;color:#64748b;'>${emp.employment.jobTitle||''}</div><div style='font-size:.55rem;color:#475569;'>Basic: ${fmtCurrency(emp.employment.basicSalary||0, cur)}</div>`; wrap.appendChild(div); }); $('#btnGenerateRun').disabled=false; });

$('#btnGenerateRun').addEventListener('click', async ()=>{ const selected=Array.from(document.querySelectorAll('[data-run-emp]:checked')).map(cb=>cb.getAttribute('data-run-emp')); if(!selected.length){ alert('Select at least one employee'); return; } const month=Number($('#runMonth').value); const year=Number($('#runYear').value); const existingRuns=getRuns(); const periodKey=`${month}/${year}`; // Build run employees
 const employeesData = getEmployees().filter(e=> selected.includes(e.employeeId));
 // Build a robust template index keyed by id and code/category (uppercased)
 const templatesIndex = (()=>{
   const m = new Map();
   (getTemplates()||[]).forEach(t=>{
     if(!t) return;
     if(t.id) m.set(String(t.id), t);
     const code = String(t.category||t.code||'').trim().toUpperCase();
     if(code) m.set(code, t);
   });
   return m;
 })();
 // Build pay element indexes by id and by code for robust resolution
 const allPE = getPayElements();
 const peById = new Map(allPE.map(p=>[p.id, p]));
 const peByCode = new Map(allPE.map(p=>[(String(p.code||'').toUpperCase()), p]));
 const normKey = (s)=> String(s||'').trim().toUpperCase();
 const getPE = (key)=> peById.get(key) || peByCode.get(normKey(key)) || null;

 // Helpers: safe formula evaluation (delegate to global engine)
 function sanitizeFormula(formula){
   try { return (typeof normalizeFormulaForDisplay==='function') ? normalizeFormulaForDisplay(formula) : String(formula||''); }
   catch { return String(formula||''); }
 }
 function evalFormula(formula, ctx){
   try { return (typeof window.evalFormula==='function') ? Number(window.evalFormula(formula, ctx)||0) : 0; }
   catch(e){ console.warn('Formula eval failed:', formula, e); return 0; }
 }

 // Local robust money parser for run generation (handles "20,000", "1 200,50", etc.)
 function parseMoneyRun(v){
   if(v==null) return 0;
   if(typeof v==='number') return Number.isFinite(v)?v:0;
   let s = String(v);
   // Normalize NBSP/thin spaces to regular, then strip spaces between digits
   s = s.replace(/[\u00A0\u202F\u2000-\u200A]/g,' ');
   s = s.replace(/(\d)\s+(?=\d)/g,'$1');
   // Keep only digits, signs, dots, commas
   s = s.replace(/[^0-9,.-]/g,'');
   // If both comma and dot present, treat commas as thousands separators
   if(s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');
   else s = s.replace(/,/g,'.');
   s = s.replace(/\s+/g,'');
   const n = Number(s);
   return Number.isFinite(n)? n : 0;
 }

 // Prefetch contracts → formula vars per employee (best effort)
 const currentCompanyId = (window.authManager?.currentUser?.companyId) || (window.currentUser?.companyId) || null;
 const contractVarsByEmployee = {};
 try{
   await Promise.all(employeesData.map(async (emp)=>{
     const best = await getBestContractForEmployee(emp.employeeId, currentCompanyId);
     contractVarsByEmployee[emp.employeeId] = contractToFormulaVars(best);
   }));
 }catch(e){ console.warn('Contract prefetch for run failed', e); }

  const runEmployees = await Promise.all(employeesData.map(async (emp)=>{
   // Resolve template by multiple possible fields
   const empTplKeyRaw = emp?.employment?.payslipTemplateId || emp?.payslipTemplateId || emp?.employment?.payslipCategory || emp?.employment?.payslipTemplate || emp?.payslipCategory || emp?.payslipTemplate || '';
   const empTplKey = String(empTplKeyRaw||'').trim();
   let tpl = null;
   if(empTplKey) {
     tpl = templatesIndex.get(empTplKey) || templatesIndex.get(normKey(empTplKey)) || null;
   }
  const full=`${emp.personal.firstName||''} ${emp.personal.lastName||''}`.trim()||emp.contact.email||emp.employeeId;
  const basic=parseMoneyRun(emp.employment.basicSalary||0);
   let earnings=[], deductions=[];
   if(tpl){
     // Start with defaults (amount), we will override with percent/formula below
  earnings = (tpl.earnings||[]).map(item=>{ const key = normKey(item); const pe = getPE(item) || getPE(key); const rid = pe? pe.id : item; const code = pe? pe.code : key; const name = pe? pe.name : key; return { id: rid, code, name, amount: pe?Number(pe.defaultAmount||0):0 }; });
  deductions = (tpl.deductions||[]).map(item=>{ const key = normKey(item); const pe = getPE(item) || getPE(key); const rid = pe? pe.id : item; const code = pe? pe.code : key; const name = pe? pe.name : key; return { id: rid, code, name, amount: pe?Number(pe.defaultAmount||0):0 }; });
   }
  // Inject OVERTIME hours for the selected month (from approved timesheet), without affecting monetary totals
  // Also expose a context variable OVERTIME usable in formulas even if the element isn't present in the template
  let overtimeHoursForMonth = 0;
  try{
     const employment = emp?.employment || {};
     const workingHoursDay = (typeof employment.workingHoursDay === 'number' && employment.workingHoursDay > 0) ? employment.workingHoursDay : 8;
     const monthKey = (()=>{ const mm = String(month).padStart(2,'0'); return `${year}-${mm}`; })();
     const emailCandidates = [
       emp?.contact?.email,
       emp?.personal?.email,
       emp?.email,
       emp?.login?.email,
       emp?.work?.email,
     ].filter(Boolean).map(e=> String(e).trim().toLowerCase());
     let otHours = 0;
     if(monthKey && emailCandidates.length){
  const ts = await fetchApprovedTimesheetForEmailMonth(emailCandidates, monthKey, { force: true });
       if(ts){
         const daysArr = Array.isArray(ts?.days) ? ts.days : [];
         otHours = daysArr.reduce((sum, d)=>{ const h=Number(d?.hours||0); const ot=Math.max(0, Number((h - workingHoursDay).toFixed(2))); return sum + ot; }, 0);
         otHours = Number(otHours.toFixed(2));
       }
     }
     const idxOT = earnings.findIndex(x=> String(x.code||'').toUpperCase()==='OVERTIME');
     overtimeHoursForMonth = Number(otHours||0);
     if(idxOT>=0){
       const line = earnings[idxOT];
       const peMeta = getPE(line.id) || getPE(line.code);
       const vm = String(peMeta?.valueMode||'').toLowerCase();
       // Only override when OVERTIME is configured as hours (amount mode)
       if(vm!=='formula' && vm!=='percent'){
         earnings[idxOT] = { ...line, amount: overtimeHoursForMonth };
       }
     }
   }catch(e){ console.warn('Failed to inject OVERTIME hours into draft run for', emp?.employeeId, e); }
   // Build a context iteratively to support dependencies
  function rebuildContext(){
    const ctx = { BASIC: basic };
    // Merge employee/contract variables into formula context
    try{
      const cvars = contractVarsByEmployee[emp.employeeId] || {};
      ctx.EMP_DEPENDENTS = Number(emp?.personal?.dependents || 0) || 0;
      // Seniority in full completed years: prefer reading from employee data's seniorityYears if present
      try {
        let years = 0;
        // First check if the employee object has seniorityYears stored directly
        if (emp?.employment?.seniorityYears != null && emp.employment.seniorityYears !== '') {
          years = Number(emp.employment.seniorityYears) || 0;
        } else {
          // Fallback: compute from seniorityDate using flexible parsing
          const senStr = emp?.employment?.seniorityDate || emp?.employment?.seniority || emp?.personal?.seniorityDate || '';
          years = calcYearsFromDateStr(senStr);
        }
        ctx.SENIORITY_YEARS = Number(years||0);
  // Seniority years exposed only as SENIORITY_YEARS (aliases removed by request)
      } catch(e){ ctx.SENIORITY_YEARS = 0; }
      Object.assign(ctx, cvars);
  }catch(e){ /* noop */ }
  // Always expose OVERTIME variable in formulas for the selected month, even if element line is not in template
  try { ctx.OVERTIME = Number(overtimeHoursForMonth||0); } catch { ctx.OVERTIME = 0; }
     // Pre-sums
  const earnSum = earnings.reduce((s,e)=>{
       const codeU = String(e.code||'').toUpperCase();
       const isBasicOrGross = (codeU==='BASIC' || codeU==='GROSS');
       let exclude = isBasicOrGross;
       if(!exclude && codeU==='OVERTIME'){
         const peMeta = getPE(e.id) || getPE(e.code);
         const vm = String(peMeta?.valueMode||'').toLowerCase();
         // Exclude only when OVERTIME is configured as hours (amount mode). If formula/percent, treat as monetary.
         exclude = (vm!=='formula' && vm!=='percent');
       }
       return s + (exclude ? 0 : (Number(e.amount)||0));
     },0);
     // Only employee-borne deductions reduce NET_PRE
     const dedSum = deductions.reduce((s,d)=>{
       const pe = getPE(d.id);
       const who = (pe?.deductFrom)||'employee';
       const appliesToEmployee = (who==='employee' || who==='both');
       return s + (appliesToEmployee ? (Number(d.amount)||0) : 0);
     },0);
     ctx.EARNINGS_SUM = earnSum; ctx.DEDUCTIONS_SUM = dedSum;
     // Default gross
     ctx.GROSS_PRE = basic + earnSum;
     // Override with custom Gross formula if defined as a special element (code GROSS)
     try {
       const grossEl = getPayElements().find(pe=> pe.code==='GROSS' && pe.valueMode==='formula' && pe.formula && pe.active!==false);
       if(grossEl){
         // Provide current context (BASIC, element amounts, EARNINGS_SUM, DEDUCTIONS_SUM) to formula
         const val = evalFormula(grossEl.formula, Object.assign({}, ctx));
         if(Number.isFinite(val)) ctx.GROSS_PRE = Number(val);
       }
     } catch(e){ console.warn('Custom GROSS formula failed', e); }
     ctx.NET_PRE = ctx.GROSS_PRE - dedSum;
  // Each element by code available
     const safeKey = (s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g, '_');
  earnings.forEach(e=>{ ctx[String(e.code||'').toUpperCase()] = Number(e.amount)||0; ctx[safeKey(e.code)] = Number(e.amount)||0; });
  deductions.forEach(d=>{ ctx[String(d.code||'').toUpperCase()] = Number(d.amount)||0; ctx[safeKey(d.code)] = Number(d.amount)||0; });
  // Re-assert OVERTIME hours after mapping element codes so it isn't overridden by a line amount
  try { ctx.OVERTIME = Number(overtimeHoursForMonth||0); } catch { /* noop */ }
     // Helpful aliases
     ctx.SALAIRE_BASE = ctx.BASIC; ctx.SALAIRE = ctx.BASIC; ctx.BASE = ctx.BASIC;
     ctx.EARNINGS_TOTAL = ctx.EARNINGS_SUM; ctx.DEDUCTIONS_TOTAL = ctx.DEDUCTIONS_SUM;
     ctx.GROSS = ctx.GROSS_PRE; ctx.NET = ctx.NET_PRE;
     return ctx;
   }
   // Apply percentage and formula modes, iterate few times to settle dependencies
   const ITER=3;
   for(let t=0;t<ITER;t++){
     const ctx = rebuildContext();
     // Earnings
     earnings = earnings.map(line=>{
       const pe = getPE(line.id);
       if(!pe) return line;
       if(pe.valueMode==='percent'){
         let base=0;
         if(pe.percentBase==='basic') base = basic;
         else if(pe.percentBase==='gross') base = ctx.GROSS_PRE;
         else if(pe.percentBase==='net') base = ctx.NET_PRE;
         else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k = pe.percentBaseElement; const nk = normKey(k); const sk = (s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); base = Number(ctx[k]||ctx[nk]||ctx[sk(k)]||ctx[sk(nk)]||0); }
         const amt = (Number(pe.defaultPercent||0)/100) * base;
         return { ...line, amount: Math.round(amt*100)/100 };
       } else if(pe.valueMode==='formula' && pe.formula){
         const amt = evalFormula(pe.formula, ctx);
         return { ...line, amount: Math.round(Number(amt||0)*100)/100 };
       }
       return line;
     });
     // Deductions
     deductions = deductions.map(line=>{
       const pe = getPE(line.id);
       if(!pe) return line;
       if(pe.valueMode==='percent'){
         let base=0;
         if(pe.percentBase==='basic') base = basic;
         else if(pe.percentBase==='gross') base = ctx.GROSS_PRE;
         else if(pe.percentBase==='net') base = ctx.NET_PRE;
         else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k = pe.percentBaseElement; const nk = normKey(k); const sk = (s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); base = Number(ctx[k]||ctx[nk]||ctx[sk(k)]||ctx[sk(nk)]||0); }
         const amt = (Number(pe.defaultPercent||0)/100) * base;
         return { ...line, amount: Math.round(amt*100)/100 };
       } else if(pe.valueMode==='formula' && pe.formula){
         const amt = evalFormula(pe.formula, ctx);
         return { ...line, amount: Math.round(Number(amt||0)*100)/100 };
       }
       return line;
     });
   }
  const earningsTotal=earnings.reduce((s,e)=>{
     const codeU = String(e.code||'').toUpperCase();
     const isBasicOrGross = (codeU==='BASIC' || codeU==='GROSS');
     let exclude = isBasicOrGross;
     if(!exclude && codeU==='OVERTIME'){
       const peMeta = getPE(e.id) || getPE(e.code);
       const vm = String(peMeta?.valueMode||'').toLowerCase();
       exclude = (vm!=='formula' && vm!=='percent');
     }
     return s + (exclude ? 0 : Number(e.amount||0));
  },0);
   // Split deductions between employee and employer per element setting
   const deductionsTotal=deductions.reduce((s,d)=>{
     const pe = getPE(d.id);
     const who = (pe?.deductFrom)||'employee';
     const appliesToEmployee = (who==='employee' || who==='both');
     return s + (appliesToEmployee ? (Number(d.amount)||0) : 0);
   },0);
   const employerDeductionsTotal=deductions.reduce((s,d)=>{
     const pe = getPE(d.id);
     const who = (pe?.deductFrom)||'employee';
     const appliesToEmployer = (who==='company' || who==='both');
     return s + (appliesToEmployer ? (Number(d.amount)||0) : 0);
   },0);
   // simple tax: 10% of taxable earnings + basic
   const taxableEarnings = earnings.reduce((s,e)=>{ const pe=getPE(e.id); const taxable = pe? pe.taxable : true; return taxable? (s+Number(e.amount||0)) : s; },0) + basic;
   const tax = Math.round((taxableEarnings * 0.1)*100)/100;
  const gross = basic + earningsTotal;
   const net = gross - deductionsTotal - tax;
   const currency = (emp && emp.employment && emp.employment.currency) || null;
   return { employeeId:emp.employeeId, employee:full, basic, earnings, deductions, earningsTotal, deductionsTotal, employerDeductionsTotal, tax, gross, net, currency, payslipCategory:emp.employment.payslipCategory||null };
 }))
 draftRun = { id: uid(), period:{month,year}, periodKey, createdAt:Date.now(), posted:false, employees: runEmployees, companyId:companyId||null };
 renderDraftRun(); window.scrollTo({top:0,behavior:'smooth'}); });

function renderDraftRun(){ const card=$('#draftRunCard'); if(!draftRun){ card.style.display='none'; return; } card.style.display='block'; const tbody=$('#draftRunTbody'); tbody.innerHTML=draftRun.employees.map((e,i)=>`<tr><td>${e.employee}</td><td>${fmtCurrency(e.basic, e.currency)}</td><td>${fmtCurrency(e.earningsTotal||e.earnings.reduce((s,x)=>s+x.amount,0), e.currency)}</td><td>${fmtCurrency(e.deductionsTotal||e.deductions.reduce((s,x)=>s+x.amount,0), e.currency)}</td><td>${fmtCurrency(e.tax, e.currency)}</td><td>${fmtCurrency(e.net, e.currency)}</td><td><div class='actions'><button class='btn' data-edit-line='${i}' title='Edit Lines'><i class="fas fa-list"></i></button><button class='btn-danger' data-remove-line='${i}' title='Remove Employee'><i class="fas fa-xmark"></i></button></div></td></tr>`).join('');
 // Wire events
 $$('[data-edit-line]').forEach(btn=>btn.addEventListener('click',()=>openLineModal(Number(btn.dataset.editLine)))); $$('[data-remove-line]').forEach(btn=>btn.addEventListener('click',()=>{ const idx=Number(btn.dataset.removeLine); draftRun.employees.splice(idx,1); if(!draftRun.employees.length){ draftRun=null; } renderDraftRun(); })); }

$('#btnPostRun').addEventListener('click',()=>{ if(!draftRun){ alert('No draft run'); return; } draftRun.posted=true; const runs=getRuns(); runs.push(draftRun); saveRuns(runs); draftRun=null; renderDraftRun(); renderRuns(); $('#payRunSetupCard').style.display='none'; alert('Payroll run posted. Profile payslips will update.'); });
$('#btnDiscardRun').addEventListener('click',()=>{ if(confirm('Discard current draft run?')){ draftRun=null; renderDraftRun(); $('#payRunSetupCard').style.display='none'; }});

function renderRuns(){ const tbody=$('#runsTbody'); const runs=getRuns().sort((a,b)=> b.createdAt-a.createdAt); if(!runs.length){ tbody.innerHTML='<tr><td colspan="5" class="empty">No runs yet</td></tr>'; return; } tbody.innerHTML=runs.map(r=>`<tr data-id='${r.id}'><td>${r.period.month}/${r.period.year}</td><td>${r.employees.length}</td><td><span class='status-badge ${r.posted?'status-posted':'status-draft'}'>${r.posted?'POSTED':'DRAFT'}</span></td><td>${new Date(r.createdAt).toLocaleDateString()}</td><td><div class='actions'><button class='btn' data-view-run='${r.id}' title='View'><i class="fas fa-eye"></i></button><button class='btn-danger' data-del-run='${r.id}' title='Delete'><i class="fas fa-trash"></i></button></div></td></tr>`).join('');
$$('[data-del-run]').forEach(btn=>btn.addEventListener('click',()=>{ if(!confirm('Delete run?')) return; const id=btn.dataset.delRun; let runs=getRuns().filter(r=>r.id!==id); saveRuns(runs); renderRuns(); }));
$$('[data-view-run]').forEach(btn=>btn.addEventListener('click',()=>{ const id=btn.dataset.viewRun; const run=getRuns().find(r=>r.id===id); if(!run) return; alert(`Run ${run.period.month}/${run.period.year}\nEmployees: ${run.employees.length}\nStatus: ${run.posted?'Posted':'Draft'}`); })); }
renderRuns();

/**************** Line Modal *****************/
let editingLineIndex=null; function openLineModal(idx){ if(!draftRun) return; editingLineIndex=idx; const emp=draftRun.employees[idx]; if(!emp) return; const body=$('#lineModalBody'); body.innerHTML=''; const earnSection=document.createElement('div'); earnSection.innerHTML='<h4 style="margin:0 0 6px;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;color:#166534;">Earnings</h4>'; emp.earnings.forEach((l,i)=>{ const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr 120px'; row.style.gap='8px'; row.style.alignItems='center'; row.innerHTML=`<span style='font-size:.65rem;'>${l.name||l.code}</span><input type='number' step='0.01' data-earn-line='${i}' value='${l.amount}' />`; earnSection.appendChild(row); }); const dedSection=document.createElement('div'); dedSection.style.marginTop='12px'; dedSection.innerHTML='<h4 style="margin:0 0 6px;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;color:#991b1b;">Deductions</h4>'; emp.deductions.forEach((l,i)=>{ const row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr 120px'; row.style.gap='8px'; row.style.alignItems='center'; row.innerHTML=`<span style='font-size:.65rem;'>${l.name||l.code}</span><input type='number' step='0.01' data-ded-line='${i}' value='${l.amount}' />`; dedSection.appendChild(row); }); const taxRow=document.createElement('div'); taxRow.style.marginTop='12px'; taxRow.innerHTML=`<label style='font-size:.55rem;font-weight:600;display:flex;flex-direction:column;gap:4px;'>Tax <input type='number' step='0.01' id='editLineTax' value='${emp.tax}' /></label>`; body.appendChild(earnSection); body.appendChild(dedSection); body.appendChild(taxRow); $('#lineModalBackdrop').style.display='flex'; }
$('#closeLineModal').addEventListener('click',()=>$('#lineModalBackdrop').style.display='none');
$('#saveLineModal').addEventListener('click',()=>{ if(editingLineIndex==null||!draftRun) return; const emp=draftRun.employees[editingLineIndex]; if(!emp) return; body=$('#lineModalBody'); body.querySelectorAll('[data-earn-line]').forEach(inp=>{ const i=Number(inp.dataset.earnLine); emp.earnings[i].amount=Number(inp.value||0); }); body.querySelectorAll('[data-ded-line]').forEach(inp=>{ const i=Number(inp.dataset.dedLine); emp.deductions[i].amount=Number(inp.value||0); }); emp.earningsTotal=emp.earnings.reduce((s,e)=>s+Number(e.amount||0),0); 
  // Recompute deduction splits using id-or-code resolution
  const allPE2 = getPayElements();
  const peById2 = new Map(allPE2.map(p=>[p.id,p]));
  const peByCode2 = new Map(allPE2.map(p=>[(String(p.code||'').toUpperCase()), p]));
  const getPE2 = (key)=> peById2.get(key) || peByCode2.get(String(key||'').toUpperCase()) || null;
  emp.deductionsTotal=emp.deductions.reduce((s,e)=>{ const pe=getPE2(e.id); const who=(pe?.deductFrom)||'employee'; const appliesToEmployee=(who==='employee'||who==='both'); return s + (appliesToEmployee?Number(e.amount||0):0); },0); 
  emp.employerDeductionsTotal=emp.deductions.reduce((s,e)=>{ const pe=getPE2(e.id); const who=(pe?.deductFrom)||'employee'; const appliesToEmployer=(who==='company'||who==='both'); return s + (appliesToEmployer?Number(e.amount||0):0); },0); 
  emp.tax=Number($('#editLineTax').value||0); emp.gross=emp.basic+emp.earningsTotal; emp.net=emp.gross - emp.deductionsTotal - emp.tax; $('#lineModalBackdrop').style.display='none'; renderDraftRun(); });

/**************** Import / Export *****************/
// Export button removed per requirement
// Import functionality removed along with button per requirement.

/**************** Modal Builders & Generic Entity Modal *****************/
const entityModalBackdrop = $('#entityModalBackdrop');
const entityModalBody = $('#entityModalBody');
const entityModalTitle = $('#entityModalTitle');
$('#closeEntityModal').addEventListener('click', ()=> entityModalBackdrop.style.display='none');

function openEntityModal(title, contentNode){
  entityModalTitle.textContent = title;
  entityModalBody.innerHTML='';
  if(contentNode) entityModalBody.appendChild(contentNode);
  entityModalBackdrop.style.display='flex';
  const firstInput = entityModalBody.querySelector('input,select,textarea');
  if(firstInput) setTimeout(()=> firstInput.focus(), 50);
}

// Payslip Template Preview Modal (PDF-friendly)
async function openTemplatePreviewModal(template, selectedEmployee) {
  // Helper: derive selected run month key (YYYY-MM) from Run Month/Year controls; fallback to current month
  function getSelectedMonthKeyForRun(){
    try{
      const runMonthEl = document.querySelector('#runMonth');
      const runYearEl = document.querySelector('#runYear');
      if(runMonthEl && runYearEl && runMonthEl.value && runYearEl.value){
        const mmSel = String(Number(runMonthEl.value)).padStart(2,'0');
        const yySel = String(runYearEl.value);
        return `${yySel}-${mmSel}`;
      }
      const now = new Date();
      const yyyy = now.getFullYear(); const mm = String(now.getMonth()+1).padStart(2,'0');
      return `${yyyy}-${mm}`;
    }catch{ return ''; }
  }
  // Helper: compute daily overtime hours from a timesheet and working hours/day
  function computeDailyOvertimeFromTimesheet(ts, workingHoursDay){
    try{
      const daysArr = Array.isArray(ts?.days) ? ts.days : [];
      const whd = (typeof workingHoursDay === 'number' && workingHoursDay > 0) ? workingHoursDay : 8;
      const total = daysArr.reduce((sum, d)=>{
        const h = Number(d?.hours||0);
        const ot = Math.max(0, Number((h - whd).toFixed(2)));
        return sum + ot;
      }, 0);
      return Number(total.toFixed(2));
    }catch{ return 0; }
  }
  // Helper: fetch approved timesheet for one or more emails and a specific month key (robust matching)
  async function fetchApprovedTimesheetForEmailMonth(emailOrEmails, monthKey, opts){
    try{
      if(!db || !emailOrEmails || !monthKey) return null;
      const emails = Array.isArray(emailOrEmails) ? emailOrEmails : [emailOrEmails];
      const candidates = [];
      window.__tsCache = window.__tsCache || {};
      for(const raw of emails){
        const em = String(raw||'').trim().toLowerCase();
        if(!em) continue;
        const cacheKey = `${em}|${monthKey}|strict`;
        const cached = window.__tsCache[cacheKey];
        if(cached && !opts?.force){ if(cached.ts) candidates.push(cached.ts); continue; }
        const snap = await db.ref('timesheets').orderByChild('submittedByEmail').equalTo(em).once('value');
        const all = snap.exists()? Object.values(snap.val()||{}) : [];
        const matches = all.filter(ts=> (ts.month||'')===monthKey && String(ts.status||'').toLowerCase()==='approved');
        let best = null;
        if(matches.length){ best = matches.sort((a,b)=> (Number(b.updatedAt||b.createdAt||0) - Number(a.updatedAt||a.createdAt||0)) )[0]; }
        window.__tsCache[cacheKey] = { ts: best, at: Date.now() };
        if(best) candidates.push(best);
        // Fallback: if no timesheet for the month, use the most recent approved across all months
        if(!best && all.length){
          const approvedAll = all.filter(ts=> String(ts.status||'').toLowerCase()==='approved');
          if(approvedAll.length){
            const latest = approvedAll.sort((a,b)=> (Number(b.updatedAt||b.createdAt||0) - Number(a.updatedAt||a.createdAt||0)) )[0];
            if(latest) candidates.push(latest);
          }
        }
      }
      if(candidates.length){
        // pick most recently updated among candidates
        return candidates.sort((a,b)=> (Number(b.updatedAt||b.createdAt||0) - Number(a.updatedAt||a.createdAt||0)) )[0];
      }
      return null;
    }catch{ return null; }
  }
  // Always open a skeleton modal so rendering errors never block UI
  const skeleton = document.createElement('div');
  skeleton.innerHTML = '<div style="padding:12px;font-size:.85rem;color:#556;">Loading payslip preview…</div>';
  try { openEntityModal('Payslip Template Preview', skeleton); } catch(e) { /* ignore */ }

  try {
    // Robust money/number parser for default amounts/percents (handles 20 000, 20,000.00, 20 ,00, etc.)
    const parseAmt = (v)=>{
      if(v==null) return 0;
      if(typeof v==='number') return Number.isFinite(v)?v:0;
      let s=String(v);
      s=s.replace(/[\u00A0\u202F\u2000-\u200A]/g,' '); // various spaces
      s=s.replace(/(\d)\s+(?=\d)/g,'$1'); // remove spaces inside digits
      s=s.replace(/[^0-9,.-]/g,'');
      if(s.includes(',') && s.includes('.')) s=s.replace(/,/g,''); else s=s.replace(/,/g,'.');
      s=s.replace(/\s+/g,'');
      const n=Number(s);
      return Number.isFinite(n)?n:0;
    };
    // Local seniority helpers to ensure preview can compute SENIORITY_YEARS even if global helper isn't loaded
    const parseDateFlexibleLocal = (s)=>{
      if(!s) return null;
      if(s instanceof Date) return isNaN(s.getTime()) ? null : s;
      const str = String(s).trim();
      const iso = new Date(str);
      if(!isNaN(iso.getTime())) return iso;
      const m = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
      if(m){
        const dd = parseInt(m[1],10);
        const mm = parseInt(m[2],10);
        let yyyy = parseInt(m[3],10);
        if(yyyy<100) yyyy += 2000;
        const d = new Date(yyyy, mm-1, dd);
        return isNaN(d.getTime()) ? null : d;
      }
      return null;
    };
    const yearsFromDateStr = (s)=>{
      try{
        const d = parseDateFlexibleLocal(s);
        if(!d) return 0;
        const now = new Date();
        let years = now.getFullYear() - d.getFullYear();
        const anniv = new Date(now.getFullYear(), d.getMonth(), d.getDate());
        if(now < anniv) years -= 1;
        if(!Number.isFinite(years) || years < 0) years = 0;
        return years;
      }catch{ return 0; }
    };
    // Branding
    const comp = window.AppAuth?.currentCompany;
    const companyName = comp?.companyName || window.AppAuth?.currentUser?.companyName || document.getElementById('headerCompanyName')?.textContent || 'Company Name';
    const logo = comp?.logo || comp?.logoUrl || document.getElementById('headerCompanyLogo')?.src || '';

    // Elements and template lines
    const allElements = Array.isArray(getPayElements?.()) ? getPayElements() : [];
    // Index pay elements by both id and code (uppercased, trimmed) for robust lookup
    const normKey = (s)=> String(s||'').trim().toUpperCase();
    const peIndex = new Map();
    allElements.forEach(p=>{
      if(!p) return;
      if(p.id) peIndex.set(String(p.id), p);
      if(p.code) peIndex.set(normKey(p.code), p);
    });
    const deAccent = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    let earnings = (Array.isArray(template?.earnings) ? template.earnings : []).map(key => {
      const k = normKey(key);
      const pe = peIndex.get(String(key)) || peIndex.get(k);
      return pe || { id:String(key), code:k, name:String(k), defaultAmount:0 };
    });
    let deductions = (Array.isArray(template?.deductions) ? template.deductions : []).map(key => {
      const k = normKey(key);
      const pe = peIndex.get(String(key)) || peIndex.get(k);
      return pe || { id:String(key), code:k, name:String(k), defaultAmount:0 };
    });

    // Employee context
    let empName = '';
    let empBasic = 0;
    let empCurrency = '';
    let contractVars = {};
    if (selectedEmployee) {
      try {
        const personal = selectedEmployee.personal || {};
        const contact = selectedEmployee.contact || {};
        const employment = selectedEmployee.employment || {};
        empName = (`${personal.firstName||''} ${personal.lastName||''}`.trim()) || contact.email || selectedEmployee.employeeId || selectedEmployee.id || '';
        // Robust parse of basic salary (supports 20,000.00 / 20 000,00 / USD 20,000, etc.)
        const _parseMoney = (v)=>{ if(v==null) return 0; if(typeof v==='number') return Number.isFinite(v)?v:0; let s=String(v); s=s.replace(/[\u00A0\u202F\u2000-\u200A]/g,' '); s=s.replace(/(\d)\s+(?=\d)/g,'$1'); s=s.replace(/[^0-9,.-]/g,''); if(s.includes(',')&&s.includes('.')) s=s.replace(/,/g,''); else s=s.replace(/,/g,'.'); s=s.replace(/\s+/g,''); const n=Number(s); return Number.isFinite(n)?n:0; };
        const basicCandidates = [
          employment.basicSalary,
          employment.salaryBase,
          employment.baseSalary,
          employment.salary,
          employment.basic,
          employment.salaireBase,
          employment.salaire
        ];
        for(const v of basicCandidates){ const n=_parseMoney(v||0); if(Number.isFinite(n) && n>0){ empBasic=n; break; } }
        empCurrency = String(employment.currency||'').toUpperCase();
        // Merge contract variables if available to align with tester
        try{
          const empId = selectedEmployee.employeeId || selectedEmployee.id || '';
          const currentCompanyId = (window.authManager?.currentUser?.companyId) || (window.currentUser?.companyId) || (window.AppAuth?.currentUser?.companyId) || null;
          if(typeof getBestContractForEmployee === 'function' && typeof contractToFormulaVars === 'function'){
            const best = await getBestContractForEmployee(empId, currentCompanyId);
            if(best){ contractVars = contractToFormulaVars(best) || {}; }
          }
        }catch(e){ contractVars = {}; }
      } catch {}
    }

    // Ensure BASIC present
    if (selectedEmployee) {
      try {
        const i = earnings.findIndex(e => String(e.code||'').toUpperCase() === 'BASIC');
        if (i >= 0) earnings[i] = { ...earnings[i], defaultAmount: Number(empBasic||0) };
        else earnings = [{ id:'__BASIC__', code:'BASIC', name:'Basic Salary', defaultAmount:Number(empBasic||0) }, ...earnings];
      } catch {}
    }

  // Compute amounts (for both employee-selected and template-only previews)
  let computed = { earnings: [], deductions: [], earningsTotal: 0, deductionsTotal: 0, employerDeductionsTotal: 0, gross: 0, net: 0 };
  if (selectedEmployee) {
  let eLines = earnings.map(pe => ({ id: pe.id, code: pe.code, name: pe.name, amount: parseAmt(pe.defaultAmount||0) }));
  let dLines = deductions.map(pe => ({ id: pe.id, code: pe.code, name: pe.name, amount: parseAmt(pe.defaultAmount||0) }));
      let overtimeHoursForPreview = 0;

      // Inject OVERTIME hours for the selected month (do not include in monetary totals)
      try{
        const employment = selectedEmployee?.employment || {};
        const workingHoursDay = (typeof employment.workingHoursDay === 'number' && employment.workingHoursDay > 0) ? employment.workingHoursDay : 8;
        const monthKey = getSelectedMonthKeyForRun();
        const emailCandidates = [
          selectedEmployee?.contact?.email,
          selectedEmployee?.personal?.email,
          selectedEmployee?.email,
          selectedEmployee?.login?.email,
          selectedEmployee?.work?.email,
        ].filter(Boolean).map(e=> String(e).trim().toLowerCase());
        let otHours = 0;
        if(monthKey && emailCandidates.length){
          const ts = await fetchApprovedTimesheetForEmailMonth(emailCandidates, monthKey, { force: true });
          if(ts){ otHours = computeDailyOvertimeFromTimesheet(ts, workingHoursDay); }
        }
        const idxOT = eLines.findIndex(x=> String(x.code||'').toUpperCase()==='OVERTIME');
        overtimeHoursForPreview = Number(otHours||0);
        if(idxOT>=0){
          const line = eLines[idxOT];
          const peMeta = peIndex.get(String(line.id)) || peIndex.get(normKey(line.id)) || peIndex.get(normKey(line.code));
          const vm = String(peMeta?.valueMode||'').toLowerCase();
          // Only override when OVERTIME is configured as hours (amount mode)
          if(vm!=='formula' && vm!=='percent'){
            eLines[idxOT] = { ...line, amount: overtimeHoursForPreview };
          }
        }
      }catch(e){ console.warn('Failed to inject OVERTIME hours into preview', e); }

      // Extend context with amounts for pay elements not listed in the template, so formulas like PINLO/CNSS resolve
      function extendCtxWithOtherElements(ctx){
        try{
          const inTemplate = new Set();
          eLines.forEach(e=>{ if(e.id) inTemplate.add(String(e.id)); if(e.code) inTemplate.add(normKey(e.code)); });
          dLines.forEach(d=>{ if(d.id) inTemplate.add(String(d.id)); if(d.code) inTemplate.add(normKey(d.code)); });
          const currentTemplateCodes = new Set(Array.from(inTemplate));
          const getBaseFromCtx = (pe)=>{
            if(pe.percentBase==='basic') return Number(empBasic||0);
            if(pe.percentBase==='gross') return ctx.GROSS_PRE;
            if(pe.percentBase==='net') return ctx.NET_PRE;
            if(pe.percentBase==='custom' && pe.percentBaseElement){
              const k=pe.percentBaseElement; const nk=normKey(k); const kd=deAccent(k); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_');
              return Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0);
            }
            return 0;
          };
          allElements.forEach(pe=>{
            if(!pe || pe.active===false) return;
            const keyId = pe.id ? String(pe.id) : null;
            const keyCode = pe.code ? normKey(pe.code) : null;
            if((keyId && currentTemplateCodes.has(keyId)) || (keyCode && currentTemplateCodes.has(keyCode))) return; // already in template ctx
            let amt = Number(pe.defaultAmount||0);
            const vm = String(pe.valueMode||'').toLowerCase();
            if(keyCode==='BASIC'){ amt = Number(empBasic||0); }
            else if(keyCode==='GROSS'){ amt = Number(ctx.GROSS_PRE||0); }
            else if(vm==='percent'){
              const base = getBaseFromCtx(pe);
              amt = (Number(pe.defaultPercent||0)/100) * base;
            } else if(vm==='formula' && pe.formula){
              try{ amt = Number(window.evalFormula ? window.evalFormula(pe.formula, ctx) : 0) || 0; }catch{ amt=0; }
            }
            // Map into ctx by code/name/id (safe keys and de-accent variants)
            const safeKey = (s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g, '_');
            const addAllKeys = (label, val) => {
              const base = String(label||'').trim(); if(!base) return;
              const U = base.toUpperCase(); const DE = deAccent(U);
              ctx[U] = Number(val)||0; ctx[DE] = Number(val)||0; ctx[safeKey(U)] = Number(val)||0; ctx[safeKey(DE)] = Number(val)||0;
            };
            const addIdKeys = (id, val) => {
              if(!id) return; const raw = String(id); const U = raw.toUpperCase();
              ctx[raw] = Number(val)||0; ctx[U] = Number(val)||0; ctx[safeKey(raw)] = Number(val)||0; ctx[safeKey(U)] = Number(val)||0;
            };
            addAllKeys(pe.code, amt);
            addAllKeys(pe.name, amt);
            addIdKeys(pe.id, amt);
          });
        }catch(e){ console.warn('extendCtxWithOtherElements failed', e); }
      }

      const rebuildCtx = () => {
        const ctx = { BASIC: Number(empBasic||0) };
    const earnSum = eLines.reduce((s,e)=>{
      const codeU = String(e.code||'').toUpperCase();
      const isBasicOrGross = (codeU==='BASIC' || codeU==='GROSS');
      let exclude = isBasicOrGross;
      if(!exclude && codeU==='OVERTIME'){
        const pe = peIndex.get(String(e.id)) || peIndex.get(normKey(e.id)) || peIndex.get(normKey(e.code));
        const vm = String(pe?.valueMode||'').toLowerCase();
        exclude = (vm!=='formula' && vm!=='percent');
      }
      return s + (exclude?0:(Number(e.amount)||0));
    }, 0);
    const dedSum = dLines.reduce((s,d)=>{ const pe = peIndex.get(String(d.id)) || peIndex.get(normKey(d.id)); const who=(pe?.deductFrom)||'employee'; const applies=(who==='employee'||'both'===who); return s + (applies? (Number(d.amount)||0):0); },0);
        ctx.EARNINGS_SUM = earnSum; ctx.DEDUCTIONS_SUM = dedSum;
    ctx.GROSS_PRE = Number(empBasic||0) + earnSum;
        // Always expose OVERTIME variable in formulas for the selected month, even if element line is not in template
        try { ctx.OVERTIME = Number(overtimeHoursForPreview||0); } catch { ctx.OVERTIME = 0; }
        // Expose element codes in multiple safe forms (raw and underscored)
        const safeKey = (s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g, '_');
        const addAllKeys = (label, val) => {
          const base = String(label||'').trim(); if(!base) return;
          const U = base.toUpperCase(); const DE = deAccent(U);
          ctx[U] = Number(val)||0; ctx[DE] = Number(val)||0; ctx[safeKey(U)] = Number(val)||0; ctx[safeKey(DE)] = Number(val)||0;
        };
        const addIdKeys = (id, val) => {
          if(!id) return; const raw = String(id); const U = raw.toUpperCase();
          ctx[raw] = Number(val)||0; ctx[U] = Number(val)||0; ctx[safeKey(raw)] = Number(val)||0; ctx[safeKey(U)] = Number(val)||0;
        };
        eLines.forEach(e=> {
          const pe = peIndex.get(String(e.id)) || peIndex.get(normKey(e.id)) || peIndex.get(normKey(e.code));
          addAllKeys(e.code, e.amount);
          addAllKeys(pe?.name || e.name, e.amount);
          addIdKeys(pe?.id || e.id, e.amount);
        });
        dLines.forEach(d=> {
          const pe = peIndex.get(String(d.id)) || peIndex.get(normKey(d.id)) || peIndex.get(normKey(d.code));
          addAllKeys(d.code, d.amount);
          addAllKeys(pe?.name || d.name, d.amount);
          addIdKeys(pe?.id || d.id, d.amount);
        });
        // Re-assert OVERTIME hours after mapping element codes so it isn't overridden by an OVERTIME line amount
        try { ctx.OVERTIME = Number(overtimeHoursForPreview||0); } catch { /* noop */ }
        // Enrich ctx with other active elements not present in the template, so referenced tokens resolve
        extendCtxWithOtherElements(ctx);
        // Seniority years: align with tester; prefer explicit numeric fields, then form, then dates
        try{
          const getNum = (v)=>{ const n = Number(v); return Number.isFinite(n) ? n : undefined; };
          let years = undefined;
          // 1) Explicit numeric fields on employee
          years = getNum(selectedEmployee?.employment?.seniorityYears)
               ?? getNum(selectedEmployee?.employment?.yearsOfService)
               ?? getNum(selectedEmployee?.employment?.years)
               ?? getNum(selectedEmployee?.personal?.seniorityYears)
               ?? getNum(selectedEmployee?.seniorityYears);
          // 2) Open form value if available
          if (years === undefined) {
            const formField = document.querySelector('#empSeniorityYears');
            if (formField && formField.value !== '') years = getNum(formField.value);
          }
          // 3) Fallback: compute from best available date
          if (years === undefined) {
            const candidates = [
              selectedEmployee?.employment?.seniorityDate,
              selectedEmployee?.employment?.startDate,
              selectedEmployee?.employment?.hireDate,
              selectedEmployee?.personal?.seniorityDate,
              selectedEmployee?.personal?.hireDate,
              selectedEmployee?.employment?.seniority,
            ].filter(Boolean);
            for (const s of candidates){
              const y = (typeof window.calcYearsFromDateStr==='function') ? Number(window.calcYearsFromDateStr(s)||0) : Number(yearsFromDateStr(s)||0);
              if(Number.isFinite(y) && y>=0){ years = y; break; }
            }
          }
          ctx.SENIORITY_YEARS = Number(years ?? 0) || 0;
        }catch{ ctx.SENIORITY_YEARS=0; }
        // Dependents available to formulas
        try{ ctx.EMP_DEPENDENTS = Number(selectedEmployee?.personal?.dependents || 0) || 0; }catch{ ctx.EMP_DEPENDENTS = 0; }
  // Seniority years exposed only as SENIORITY_YEARS (aliases removed by request)
        ctx.SALAIRE_BASE = ctx.BASIC; ctx.SALAIRE = ctx.BASIC; ctx.BASE = ctx.BASIC;
        ctx.EARNINGS_TOTAL = ctx.EARNINGS_SUM; ctx.DEDUCTIONS_TOTAL = ctx.DEDUCTIONS_SUM;
        // Merge contract vars (tenure, contract salary, etc.)
        try{ if(contractVars && typeof contractVars==='object') Object.assign(ctx, contractVars); }catch{}
        ctx.GROSS = ctx.GROSS_PRE; ctx.NET = ctx.NET_PRE;
    // Enrich with other elements not in template, then override GROSS if there is a formula
    try { if(typeof extendCtxWithOtherElements==='function') extendCtxWithOtherElements(ctx); } catch{}
    try { const grossEl = allElements.find(pe=> pe.code==='GROSS' && pe.valueMode==='formula' && pe.formula && pe.active!==false); if(grossEl && typeof window.evalFormula==='function'){ const val = Number(window.evalFormula(grossEl.formula, { ...ctx })||0); if(Number.isFinite(val)) ctx.GROSS_PRE = Number(val); } } catch {}
    ctx.NET_PRE = ctx.GROSS_PRE - dedSum;
        return ctx;
      };

      const maxPasses = 8; let changed=true; let pass=0;
      while(changed && pass < maxPasses){
        pass++;
        console.log(`[Preview] Starting pass ${pass} for selected employee`);
        const prevEA = eLines.map(x=>Number(x.amount)||0);
        const prevDA = dLines.map(x=>Number(x.amount)||0);
        const ctx = rebuildCtx();
        console.log(`[Preview] Pass ${pass} context:`, ctx);
        eLines = eLines.map(line => {
          const pe = peIndex.get(String(line.id)) || peIndex.get(normKey(line.id)); if(!pe) return line;
          const U = String(line.code||'').toUpperCase(); if(U==='BASIC') return line; if(U==='GROSS') return { ...line, amount: Math.round(rebuildCtx().GROSS_PRE*100)/100 };
          const vm = String(pe.valueMode||'').toLowerCase();
          if(vm==='percent'){
            let base=0; if(pe.percentBase==='basic') base = Number(empBasic||0); else if(pe.percentBase==='gross') base = ctx.GROSS_PRE; else if(pe.percentBase==='net') base = ctx.NET_PRE; else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k=pe.percentBaseElement; const nk=normKey(k); const kd=deAccent(k); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); base = Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0); }
            return { ...line, amount: Math.round(((parseAmt(pe.defaultPercent||0)/100)*base)*100)/100 };
          } else if(vm==='formula' && pe.formula) {
            let amt=0; 
            try{ 
              if(typeof window.evalFormula==='function') {
                console.log(`[Preview-E] Pass ${pass} - Evaluating ${line.code}: ${pe.formula}`, ctx);
                amt = Number(window.evalFormula(pe.formula, ctx)||0); 
                console.log(`[Preview-E] Pass ${pass} - Result for ${line.code}: ${amt}`);
              }
            } catch(e) { 
              console.warn(`[Preview-E] Formula failed for ${line.code}:`, pe.formula, e);
              amt=0; 
            }
            return { ...line, amount: Math.round(Number(amt||0)*100)/100 };
          }
          return line;
        });
        dLines = dLines.map(line => {
          const pe = peIndex.get(String(line.id)) || peIndex.get(normKey(line.id)); if(!pe) return line;
          const vm = String(pe.valueMode||'').toLowerCase();
          if(vm==='percent'){
            let base=0; if(pe.percentBase==='basic') base = Number(empBasic||0); else if(pe.percentBase==='gross') base = ctx.GROSS_PRE; else if(pe.percentBase==='net') base = ctx.NET_PRE; else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k=pe.percentBaseElement; const nk=normKey(k); const kd=deAccent(k); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); base = Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0); }
            return { ...line, amount: Math.round(((parseAmt(pe.defaultPercent||0)/100)*base)*100)/100 };
          } else if(vm==='formula' && pe.formula) {
            let amt=0; 
            try{ 
              if(typeof window.evalFormula==='function') {
                console.log(`[Preview-D] Pass ${pass} - Evaluating ${line.code}: ${pe.formula}`, ctx);
                amt = Number(window.evalFormula(pe.formula, ctx)||0); 
                console.log(`[Preview-D] Pass ${pass} - Result for ${line.code}: ${amt}`);
              }
            } catch(e) { 
              console.warn(`[Preview-D] Formula failed for ${line.code}:`, pe.formula, e);
              amt=0; 
            }
            return { ...line, amount: Math.round(Number(amt||0)*100)/100 };
          }
          return line;
        });
        const newEA = eLines.map(x=>Number(x.amount)||0);
        const newDA = dLines.map(x=>Number(x.amount)||0);
        const same = (a,b)=> a.length===b.length && a.every((v,i)=> Math.abs(v - b[i]) < 1e-9);
        changed = !(same(prevEA,newEA) && same(prevDA,newDA));
  }

  const earnTotal = eLines.reduce((s,e)=>{
    const codeU = String(e.code||'').toUpperCase();
    const isBasicOrGross = (codeU==='BASIC' || codeU==='GROSS');
    let exclude = isBasicOrGross;
    if(!exclude && codeU==='OVERTIME'){
      const pe = peIndex.get(String(e.id)) || peIndex.get(normKey(e.id)) || peIndex.get(normKey(e.code));
      const vm = String(pe?.valueMode||'').toLowerCase();
      exclude = (vm!=='formula' && vm!=='percent');
    }
    return s + (exclude?0:(Number(e.amount)||0));
  },0);
    const dedTotal  = dLines.reduce((s,d)=>{ const pe = peIndex.get(String(d.id)) || peIndex.get(normKey(d.id)); const who=(pe?.deductFrom)||'employee'; const applies=(who==='employee'||who==='both'); return s + (applies? (Number(d.amount)||0):0); },0);
    const employerDedTotal  = dLines.reduce((s,d)=>{ const pe = peIndex.get(String(d.id)) || peIndex.get(normKey(d.id)); const who=(pe?.deductFrom)||'employee'; const applies=(who==='company'||who==='both'); return s + (applies? (Number(d.amount)||0):0); },0);
      const ctxFinal = { BASIC:Number(empBasic||0), EARNINGS_SUM:earnTotal, DEDUCTIONS_SUM:dedTotal, GROSS_PRE:Number(empBasic||0)+earnTotal };
  try { const grossEl = allElements.find(pe=> pe.code==='GROSS' && pe.valueMode==='formula' && pe.formula && pe.active!==false); if(grossEl && typeof window.evalFormula==='function'){ const val = Number(window.evalFormula(grossEl.formula, { ...ctxFinal })||0); if(Number.isFinite(val)) ctxFinal.GROSS_PRE = Number(val); } } catch {}
      computed = { earnings:eLines, deductions:dLines, earningsTotal:earnTotal, deductionsTotal:dedTotal, employerDeductionsTotal:employerDedTotal, gross:ctxFinal.GROSS_PRE, net:ctxFinal.GROSS_PRE - dedTotal };
    } else {
      // No specific employee selected: evaluate formulas against default amounts and template context
  let eLines = earnings.map(pe => ({ id: pe.id, code: pe.code, name: pe.name, amount: parseAmt(pe.defaultAmount||0), defaultAmount: parseAmt(pe.defaultAmount||0) }));
  let dLines = deductions.map(pe => ({ id: pe.id, code: pe.code, name: pe.name, amount: parseAmt(pe.defaultAmount||0), defaultAmount: parseAmt(pe.defaultAmount||0) }));

      const defaultBasic = (()=>{
        try{ const b = earnings.find(e => String(e.code||'').toUpperCase()==='BASIC'); return Number(b?.defaultAmount||0); }catch{return 0}
      })();

      // For template-only preview, also expose other elements (computed from defaults) into ctx so references resolve
      function extendCtxWithOtherElements(ctx){
        try{
          const inTemplate = new Set();
          eLines.forEach(e=>{ if(e.id) inTemplate.add(String(e.id)); if(e.code) inTemplate.add(normKey(e.code)); });
          dLines.forEach(d=>{ if(d.id) inTemplate.add(String(d.id)); if(d.code) inTemplate.add(normKey(d.code)); });
          const getBaseFromCtx = (pe)=>{
            if(pe.percentBase==='basic') return Number(defaultBasic||0);
            if(pe.percentBase==='gross') return ctx.GROSS_PRE;
            if(pe.percentBase==='net') return ctx.NET_PRE;
            if(pe.percentBase==='custom' && pe.percentBaseElement){
              const k=pe.percentBaseElement; const nk=normKey(k); const kd=deAccent(k); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_');
              return Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0);
            }
            return 0;
          };
          const safeKey = (s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g, '_');
          const addAllKeys = (label, val) => {
            const base = String(label||'').trim(); if(!base) return;
            const U = base.toUpperCase(); const DE = deAccent(U);
            ctx[U] = Number(val)||0; ctx[DE] = Number(val)||0; ctx[safeKey(U)] = Number(val)||0; ctx[safeKey(DE)] = Number(val)||0;
          };
          const addIdKeys = (id, val) => {
            if(!id) return; const raw = String(id); const U = raw.toUpperCase();
            ctx[raw] = Number(val)||0; ctx[U] = Number(val)||0; ctx[safeKey(raw)] = Number(val)||0; ctx[safeKey(U)] = Number(val)||0;
          };
          allElements.forEach(pe=>{
            if(!pe || pe.active===false) return;
            if((pe.id && inTemplate.has(String(pe.id))) || (pe.code && inTemplate.has(normKey(pe.code)))) return;
            let amt = Number(pe.defaultAmount||0);
            const vm = String(pe.valueMode||'').toLowerCase();
            const keyCode = pe.code ? normKey(pe.code) : null;
            if(keyCode==='BASIC'){ amt = Number(defaultBasic||0); }
            else if(keyCode==='GROSS'){ amt = Number(ctx.GROSS_PRE||0); }
            else if(vm==='percent'){
              const base = getBaseFromCtx(pe);
              amt = (Number(pe.defaultPercent||0)/100) * base;
            } else if(vm==='formula' && pe.formula){
              try{ amt = Number(window.evalFormula ? window.evalFormula(pe.formula, ctx) : 0) || 0; }catch{ amt=0; }
            }
            addAllKeys(pe.code, amt);
            addAllKeys(pe.name, amt);
            addIdKeys(pe.id, amt);
          });
        }catch(e){ console.warn('extendCtxWithOtherElements (template-only) failed', e); }
      }

      const rebuildCtx = () => {
        const ctx = { BASIC: Number(defaultBasic||0) };
    const earnSum = eLines.reduce((s,e)=>{
      const codeU = String(e.code||'').toUpperCase();
      const isBasicOrGross = (codeU==='BASIC' || codeU==='GROSS');
      let exclude = isBasicOrGross;
      if(!exclude && codeU==='OVERTIME'){
        const pe = peIndex.get(String(e.id)) || peIndex.get(normKey(e.id)) || peIndex.get(normKey(e.code));
        const vm = String(pe?.valueMode||'').toLowerCase();
        exclude = (vm!=='formula' && vm!=='percent');
      }
      return s + (exclude?0:(Number(e.amount)||0));
    }, 0);
        const dedSum = dLines.reduce((s,d)=>{ const pe = peIndex.get(String(d.id)) || peIndex.get(normKey(d.id)); const who=(pe?.deductFrom)||'employee'; const applies=(who==='employee'||'both'===who); return s + (applies? (Number(d.amount)||0):0); },0);
        ctx.EARNINGS_SUM = earnSum; ctx.DEDUCTIONS_SUM = dedSum;
  ctx.GROSS_PRE = Number(defaultBasic||0) + earnSum;
        const safeKey = (s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g, '_');
        const addAllKeys = (label, val) => {
          const base = String(label||'').trim(); if(!base) return;
          const U = base.toUpperCase(); const DE = deAccent(U);
          ctx[U] = Number(val)||0; ctx[DE] = Number(val)||0; ctx[safeKey(U)] = Number(val)||0; ctx[safeKey(DE)] = Number(val)||0;
        };
        const addIdKeys = (id, val) => {
          if(!id) return; const raw = String(id); const U = raw.toUpperCase();
          ctx[raw] = Number(val)||0; ctx[U] = Number(val)||0; ctx[safeKey(raw)] = Number(val)||0; ctx[safeKey(U)] = Number(val)||0;
        };
        eLines.forEach(e=> {
          const pe = peIndex.get(String(e.id)) || peIndex.get(normKey(e.id)) || peIndex.get(normKey(e.code));
          addAllKeys(e.code, e.amount);
          addAllKeys(pe?.name || e.name, e.amount);
          addIdKeys(pe?.id || e.id, e.amount);
        });
        dLines.forEach(d=> {
          const pe = peIndex.get(String(d.id)) || peIndex.get(normKey(d.id)) || peIndex.get(normKey(d.code));
          addAllKeys(d.code, d.amount);
          addAllKeys(pe?.name || d.name, d.amount);
          addIdKeys(pe?.id || d.id, d.amount);
        });
        // Enrich ctx with other active elements not present in the template (computed from defaults)
        extendCtxWithOtherElements(ctx);
        // Defaults for context-only values when no employee
        ctx.SENIORITY_YEARS = 0;
        ctx.EMP_DEPENDENTS = 0;
        ctx.SALAIRE_BASE = ctx.BASIC; ctx.SALAIRE = ctx.BASIC; ctx.BASE = ctx.BASIC;
        ctx.EARNINGS_TOTAL = ctx.EARNINGS_SUM; ctx.DEDUCTIONS_TOTAL = ctx.DEDUCTIONS_SUM;
        // Now that ctx has all elements, override GROSS if a formula is defined, then compute NET
        try { const grossEl = allElements.find(pe=> pe.code==='GROSS' && pe.valueMode==='formula' && pe.formula && pe.active!==false); if(grossEl && typeof window.evalFormula==='function'){ const val = Number(window.evalFormula(grossEl.formula, { ...ctx })||0); if(Number.isFinite(val)) ctx.GROSS_PRE = Number(val); } } catch {}
        ctx.NET_PRE = ctx.GROSS_PRE - dedSum;
        ctx.GROSS = ctx.GROSS_PRE; ctx.NET = ctx.NET_PRE;
        return ctx;
      };

      const maxPasses = 8; let changed=true; let pass=0;
      while(changed && pass < maxPasses){
        pass++;
        const prevEA = eLines.map(x=>Number(x.amount)||0);
        const prevDA = dLines.map(x=>Number(x.amount)||0);
        const ctx = rebuildCtx();
        eLines = eLines.map(line => {
          const pe = peIndex.get(String(line.id)) || peIndex.get(normKey(line.id)); if(!pe) return line;
          const U = String(line.code||'').toUpperCase(); if(U==='BASIC') return line; if(U==='GROSS') return { ...line, amount: Math.round(rebuildCtx().GROSS_PRE*100)/100 };
          const vm = String(pe.valueMode||'').toLowerCase();
          if(vm==='percent'){
            let base=0; if(pe.percentBase==='basic') base = Number(defaultBasic||0); else if(pe.percentBase==='gross') base = ctx.GROSS_PRE; else if(pe.percentBase==='net') base = ctx.NET_PRE; else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k=pe.percentBaseElement; const nk=normKey(k); const kd=deAccent(k); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); base = Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0); }
            return { ...line, amount: Math.round(((parseAmt(pe.defaultPercent||0)/100)*base)*100)/100 };
          } else if(vm==='formula' && pe.formula) {
            let amt=0; try{ if(typeof window.evalFormula==='function') amt = Number(window.evalFormula(pe.formula, ctx)||0); } catch { amt=0; }
            return { ...line, amount: Math.round(Number(amt||0)*100)/100 };
          }
          return line;
        });
        dLines = dLines.map(line => {
          const pe = peIndex.get(String(line.id)) || peIndex.get(normKey(line.id)); if(!pe) return line;
          const vm = String(pe.valueMode||'').toLowerCase();
          if(vm==='percent'){
            let base=0; if(pe.percentBase==='basic') base = Number(defaultBasic||0); else if(pe.percentBase==='gross') base = ctx.GROSS_PRE; else if(pe.percentBase==='net') base = ctx.NET_PRE; else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k=pe.percentBaseElement; const nk=normKey(k); const kd=deAccent(k); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); base = Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0); }
            return { ...line, amount: Math.round(((parseAmt(pe.defaultPercent||0)/100)*base)*100)/100 };
          } else if(vm==='formula' && pe.formula) {
            let amt=0; try{ if(typeof window.evalFormula==='function') amt = Number(window.evalFormula(pe.formula, ctx)||0); } catch { amt=0; }
            return { ...line, amount: Math.round(Number(amt||0)*100)/100 };
          }
          return line;
        });
        const newEA = eLines.map(x=>Number(x.amount)||0);
        const newDA = dLines.map(x=>Number(x.amount)||0);
        const same = (a,b)=> a.length===b.length && a.every((v,i)=> Math.abs(v - b[i]) < 1e-9);
        changed = !(same(prevEA,newEA) && same(prevDA,newDA));
  }

  const earnTotal = eLines.reduce((s,e)=>{
    const codeU = String(e.code||'').toUpperCase();
    const isBasicOrGross = (codeU==='BASIC' || codeU==='GROSS');
    let exclude = isBasicOrGross;
    if(!exclude && codeU==='OVERTIME'){
      const pe = peIndex.get(String(e.id)) || peIndex.get(normKey(e.id)) || peIndex.get(normKey(e.code));
      const vm = String(pe?.valueMode||'').toLowerCase();
      exclude = (vm!=='formula' && vm!=='percent');
    }
    return s + (exclude?0:(Number(e.amount)||0));
  },0);
      const dedTotal  = dLines.reduce((s,d)=>{ const pe = peIndex.get(String(d.id)) || peIndex.get(normKey(d.id)); const who=(pe?.deductFrom)||'employee'; const applies=(who==='employee'||who==='both'); return s + (applies? (Number(d.amount)||0):0); },0);
      const employerDedTotal  = dLines.reduce((s,d)=>{ const pe = peIndex.get(String(d.id)) || peIndex.get(normKey(d.id)); const who=(pe?.deductFrom)||'employee'; const applies=(who==='company'||who==='both'); return s + (applies? (Number(d.amount)||0):0); },0);
      const ctxFinal = { BASIC:Number(defaultBasic||0), EARNINGS_SUM:earnTotal, DEDUCTIONS_SUM:dedTotal, GROSS_PRE:Number(defaultBasic||0)+earnTotal };
      try { const grossEl = allElements.find(pe=> pe.code==='GROSS' && pe.valueMode==='formula' && pe.formula && pe.active!==false); if(grossEl && typeof window.evalFormula==='function'){ const val = Number(window.evalFormula(grossEl.formula, { ...ctxFinal })||0); if(Number.isFinite(val)) ctxFinal.GROSS_PRE = Number(val); } } catch {}
      computed = { earnings:eLines, deductions:dLines, earningsTotal:earnTotal, deductionsTotal:dedTotal, employerDeductionsTotal:employerDedTotal, gross:ctxFinal.GROSS_PRE, net:ctxFinal.GROSS_PRE - dedTotal };
    }

    const fmtWithCurrency = (val, ccy) => { try { const currency = (ccy && typeof ccy==='string' && ccy.trim()) ? ccy.trim().toUpperCase() : (readLS('payroll.settings',{}).currency || 'USD'); return new Intl.NumberFormat(undefined, { style:'currency', currency }).format(Number(val||0)); } catch { return Number(val||0).toFixed(2); } };

    const wrapper = document.createElement('div');
    wrapper.className = 'payslip-preview-container';
    wrapper.innerHTML = `
      <style>
        @page { size: A4 portrait; margin: 0; }
        .payslip-preview-container{width:100%;display:flex;justify-content:center;}
        .payslip-sheet{background:#fff;width:100%;max-width:100%;min-height:100vh;padding:4mm;box-sizing:border-box;border:1px solid #dfe5eb;border-radius:6px;box-shadow:0 4px 14px rgba(0,0,0,0.10);margin:0 auto;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;position:relative;}
        .payslip-header{display:flex;justify-content:space-between;gap:20px;border-bottom:2px solid var(--primary-color,#2d5be3);padding-bottom:16px;margin-bottom:20px;}
        .payslip-logo{width:70px;height:70px;object-fit:contain;border:none;border-radius:8px;background:transparent;}
        .payslip-company h1{margin:0;font-size:1.35rem;line-height:1.1;font-weight:600;letter-spacing:.5px;}
        .payslip-company small{display:block;font-size:.6rem;color:#66707a;margin-top:4px;font-weight:500;}
        .payslip-meta{font-size:.6rem;color:#4b5661;text-align:right;line-height:1.3;}
        .payslip-section-title{font-size:.65rem;text-transform:uppercase;letter-spacing:.09em;font-weight:700;color:#4e5b68;margin:26px 0 6px;}
        table.payslip-table{width:100%;border-collapse:collapse;font-size:.68rem;}
        table.payslip-table th{background:#f1f4f8;text-align:left;padding:6px 8px;border:1px solid #dde3ea;font-size:.58rem;letter-spacing:.05em;font-weight:600;}
        table.payslip-table td{padding:6px 8px;border:1px solid #eef2f5;vertical-align:top;}
        .amount-cell{text-align:right;font-variant-numeric:tabular-nums;}
        .pill{display:inline-block;padding:2px 7px;border-radius:12px;font-size:.55rem;font-weight:600;letter-spacing:.5px;}
        .pill-earn{background:#e1f8ec;color:#106b38;border:1px solid #b2eccd;}
        .pill-ded{background:#fdeff0;color:#9d1d2f;border:1px solid #f3c8cf;}
        @media print { body * { visibility:hidden !important; } .printable, .printable * { visibility:visible !important; } .printable { position:static !important; margin:0 !important; box-shadow:none !important; border:none !important; width:100% !important; } .payslip-preview-container { position:static !important; padding:0 !important; margin:0 !important; width:100% !important; } .payslip-sheet { width:100% !important; max-width:100% !important; margin:0 !important; padding:1mm !important; border:none !important; box-shadow:none !important; min-height:100vh !important; } }
      </style>
      <div class='payslip-sheet printable'>
        <button type='button' class='print-btn' onclick='window.print()'><i class="fas fa-print"></i> Print / PDF</button>
        <div class='payslip-header'>
          <div style='display:flex;gap:14px;align-items:center;'>
            ${logo?`<img class='payslip-logo' src='${logo}' alt='${companyName} logo'/>`:`<div class='payslip-logo' style="display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:600;color:#555;">${(companyName||'CN').split(/\s+/).map(w=>w[0]).slice(0,3).join('').toUpperCase()}</div>`}
            <div class='payslip-company'>
              <h1>${companyName}</h1>
              <small>Code: ${template?.category||template?.code||template?.id||'-'}</small>
            </div>
          </div>
          <div class='payslip-meta'>
            <div><strong>Template:</strong> ${template?.name||'-'}</div>
            <div><strong>Earnings:</strong> ${earnings.length}</div>
            <div><strong>Deductions:</strong> ${deductions.length}</div>
            <div><strong>Updated:</strong> ${ template?.updatedAt ? new Date(template.updatedAt).toLocaleString() : '-' }</div>
            ${ selectedEmployee ? `<div style='margin-top:6px;'></div><div><strong>Employee:</strong> ${empName||'-'}</div><div><strong>Basic Salary:</strong> ${fmtWithCurrency(empBasic||0, empCurrency)}${empCurrency?` <span style=\"color:#64748b;\">(${empCurrency})</span>`:''}</div>${Number.isFinite(computed.gross)?`<div><strong>Gross Salary:</strong> ${fmtWithCurrency(computed.gross||0, empCurrency)}</div>`:''}` : '' }
          </div>
        </div>
        <div class='payslip-section-title'>Earnings</div>
        <table class='payslip-table'>
          <thead><tr><th style='width:18%'>Code</th><th>Description</th><th style='width:30%'>Formula</th><th style='width:18%;text-align:right;'>${selectedEmployee?'Amount':'Default Amount'}</th></tr></thead>
          <tbody>
            ${ (()=>{
                const list = computed.earnings;
                if(!list.length) return `<tr><td colspan='4' style='text-align:center;color:#7a858f;font-size:.58rem;'>No earnings elements</td></tr>`;
                const normKey = (s)=> String(s||'').trim().toUpperCase();
                const escapeHtml = (s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const showFormula = (row)=>{
                  const keyId = String(row.id||'');
                  const keyCode = normKey(row.code||row.id||'');
                  const pe = peIndex.get(keyId) || peIndex.get(keyCode);
                  if(!pe) return '';
                  if(pe.valueMode==='formula' && pe.formula){
                    let f = String(pe.formula||'');
                    try{ f = (typeof normalizeFormulaForDisplay==='function')? normalizeFormulaForDisplay(f) : f; }catch{}
                    return `<code>${escapeHtml(f)}</code>`;
                  }
                  if(pe.valueMode==='percent'){
                    const baseTxt = pe.percentBase==='custom' ? (pe.percentBaseElement || 'element') : (pe.percentBase||'');
                    return `<code>${Number(pe.defaultPercent||0).toFixed(2)}%${baseTxt?` of ${escapeHtml(baseTxt)}`:''}</code>`;
                  }
                  return '';
                };
                return list.map(e=>{
                  const codeU = String(e.code||'').toUpperCase();
                  const peRow = peIndex.get(String(e.id)) || peIndex.get(normKey(e.id)) || peIndex.get(normKey(e.code));
                  const vmRow = String(peRow?.valueMode||'').toLowerCase();
                  const isOvertimeHours = (codeU==='OVERTIME' && vmRow!=='formula' && vmRow!=='percent');
                  const amtCell = isOvertimeHours ? `${Number(e.amount||0).toFixed(2)} h` : fmtWithCurrency(e.amount||0, selectedEmployee ? empCurrency : undefined);
                  return `<tr>
                  <td><span class='pill pill-earn'>${e.code}</span></td>
                  <td>${e.name||''}</td>
                  <td>${showFormula(e)}</td>
                  <td class='amount-cell'>${amtCell}</td>
                </tr>`; }).join('');
            })() }
          </tbody>
        </table>
        <div class='payslip-section-title' style='margin-top:22px;'>Deductions</div>
        <table class='payslip-table'>
          <thead><tr><th style='width:18%'>Code</th><th>Description</th><th style='width:30%'>Formula</th><th style='width:18%;text-align:right;'>${selectedEmployee?'Amount':'Default Amount'}</th></tr></thead>
          <tbody>
            ${ (()=>{
                const list = computed.deductions;
                if(!list.length) return `<tr><td colspan='4' style='text-align:center;color:#7a858f;font-size:.58rem;'>No deduction elements</td></tr>`;
                const normKey = (s)=> String(s||'').trim().toUpperCase();
                const escapeHtml = (s)=> String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const showFormula = (row)=>{
                  const keyId = String(row.id||'');
                  const keyCode = normKey(row.code||row.id||'');
                  const pe = peIndex.get(keyId) || peIndex.get(keyCode);
                  if(!pe) return '';
                  if(pe.valueMode==='formula' && pe.formula){
                    let f = String(pe.formula||'');
                    try{ f = (typeof normalizeFormulaForDisplay==='function')? normalizeFormulaForDisplay(f) : f; }catch{}
                    return `<code>${escapeHtml(f)}</code>`;
                  }
                  if(pe.valueMode==='percent'){
                    const baseTxt = pe.percentBase==='custom' ? (pe.percentBaseElement || 'element') : (pe.percentBase||'');
                    return `<code>${Number(pe.defaultPercent||0).toFixed(2)}%${baseTxt?` of ${escapeHtml(baseTxt)}`:''}</code>`;
                  }
                  return '';
                };
                return list.map(d=>`<tr>
                  <td><span class='pill pill-ded'>${d.code}</span></td>
                  <td>${d.name||''}</td>
                  <td>${showFormula(d)}</td>
                  <td class='amount-cell'>${ fmtWithCurrency(d.amount||0, selectedEmployee ? empCurrency : undefined) }</td>
                </tr>`).join('');
            })() }
          </tbody>
        </table>
      </div>`;

    if (skeleton && skeleton.parentNode) { skeleton.innerHTML=''; skeleton.appendChild(wrapper); }
    else { openEntityModal('Payslip Template Preview', wrapper); }
  } catch (err) {
    console.error('Failed to render payslip preview:', err);
    const errorBox = document.createElement('div');
    errorBox.style.padding = '14px';
    errorBox.innerHTML = `
      <div style="font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;">
        <h3 style="margin:0 0 8px; color:#b42318; font-size:1rem;">Could not render full payslip preview</h3>
        <p style="margin:0 0 10px; color:#555; font-size:.9rem;">A formula or field in this template caused an error. Showing a minimal view instead.</p>
        <pre style="white-space:pre-wrap; background:#fff5f5; border:1px solid #ffdcdc; padding:8px; border-radius:6px; color:#8a1c1c; font-size:.8rem;">${String(err && err.message || err)}</pre>
        <div style="margin-top:12px; font-size:.85rem; color:#334155;">
          <div><strong>Template:</strong> ${template?.name||'-'} (${template?.code||template?.category||template?.id||'-'})</div>
        </div>
      </div>`;
    if (skeleton && skeleton.parentNode) { skeleton.innerHTML=''; skeleton.appendChild(errorBox); }
    else { openEntityModal('Payslip Preview (Limited)', errorBox); }
  }
}

function buildEmployeeForm(){
  // Build a fully structured modal content replicating position details aesthetic
  const form=document.createElement('form');
  form.id='employeeModalForm';
  form.className='employee-modal-wrapper';
  form.innerHTML=`
    <div class="employee-modal-header">
      <button type="button" class="employee-modal-close" title="Close" aria-label="Close">&times;</button>
  <h3 aria-label="Employee Form"><i class="fas fa-user-plus"></i></h3>
      <!-- Meta chips removed per requirement -->
    </div>
  <!-- Informational notice removed per requirement -->
    <div class="emp-tab-nav" role="tablist">
      <button type="button" class="emp-tab-btn active" data-target="personal" role="tab" aria-selected="true">Personal</button>
      <button type="button" class="emp-tab-btn" data-target="contact" role="tab" aria-selected="false">Contact</button>
      <button type="button" class="emp-tab-btn" data-target="employment" role="tab" aria-selected="false">Employment</button>
      <button type="button" class="emp-tab-btn" data-target="banking" role="tab" aria-selected="false">Banking</button>
      <button type="button" class="emp-tab-btn" data-target="emergency" role="tab" aria-selected="false">Emergency</button>
    </div>
    <div class="employee-form-sections">
      <section class="emp-section" data-section="personal">
        <h4><i class="fas fa-user"></i> Personal Information</h4>
        <div class="emp-grid">
          <label>Company<select id="empCompanySelect"><option value="">-- Select Company --</option></select></label>
          <label>Employee ID<input list="employeeIdOptionsModal" type="text" id="empId" placeholder="Select or type" autocomplete="off"></label>
          <label>First Name*<input type="text" id="empFirstName" required></label>
          <label>Last Name*<input type="text" id="empLastName" required></label>
          <label>Gender<input type="text" id="empGender" placeholder="e.g., Male / Female"></label>
          <label>Date of Birth<input type="date" id="empDob"></label>
          <label>Nationality<input type="text" id="empNationality"></label>
          <label>Marital Status<input type="text" id="empMarital" placeholder="e.g., Single / Married"></label>
          <label>Dependents<input type="number" id="empDependents" min="0" value="0"></label>
          <label style="grid-column:1/-1;">Address<textarea id="empAddress" placeholder="Street, City, State, Country"></textarea></label>
        </div>
      </section>
      <section class="emp-section" data-section="contact">
        <h4><i class="fas fa-address-book"></i> Contact</h4>
        <div class="emp-grid">
          <label>Email<input type="email" id="empEmail"></label>
          <label>Phone<input type="text" id="empPhone"></label>
          <label>City<input type="text" id="empCity"></label>
          <label>Country<input type="text" id="empCountry"></label>
        </div>
      </section>
      <section class="emp-section" data-section="employment">
        <h4><i class="fas fa-briefcase"></i> Employment</h4>
        <div class="emp-grid">
          <label>Department<input type="text" id="empDepartment"></label>
          <label>Job Title<input type="text" id="empJobTitle"></label>
          <label>Employment Type<input type="text" id="empEmploymentType" placeholder="e.g., Full-Time / Part-Time"></label>
          <label>Work Location<input type="text" id="empWorkLocation"></label>
          <label>Seniority<input type="date" id="empSeniorityDate"></label>
          <label>Seniority Years<input type="number" id="empSeniorityYears" value="0" min="0" readonly></label>
          <label>Hire Date<input type="date" id="empHireDate"></label>
          <label>Termination Date<input type="date" id="empTerminationDate"></label>
          <label>Status<input type="text" id="empStatus" placeholder="e.g., Active"></label>
          <label>Manager ID<input type="text" id="empManagerId" placeholder="UID / EmpID"></label>
          <label>Grade<input type="text" id="empGrade"></label>
          <label>Level<input type="text" id="empLevel"></label>
          <label>Pay Frequency<select id="empPayFrequency"><option value="Monthly">Monthly</option><option>Bi-Weekly</option><option>Weekly</option></select></label>
          <label>Working Hours/Week<input type="number" id="empWorkingHoursWeek" min="1" max="80" value="40"></label>
          <label>Working Hours/Day<input type="number" id="empWorkingHoursDay" min="1" max="24" value="8"></label>
          <label>Basic Salary<input type="number" id="empBasicSalary" step="0.01" value="0"></label>
          <label>Payslip Template<select id="empPayslipTemplate"><option value="">-- Select Template --</option></select></label>
        </div>
      </section>
      <section class="emp-section" data-section="banking">
        <h4><i class="fas fa-building-columns"></i> Banking & Statutory</h4>
        <div class="emp-grid">
          <label>Bank Name<input type="text" id="empBankName" placeholder="Full bank name"></label>
          <label>Account Holder Name<input type="text" id="empAccountName" placeholder="Name on account"></label>
          <label>Account Number<input type="text" id="empAccountNumber" placeholder="Local account number"></label>
          <label>Account Type<select id="empAccountType"><option value="">--</option><option>Checking</option><option>Savings</option><option>Current</option><option>Salary</option></select></label>
          <label>IBAN<input type="text" id="empIBAN" placeholder="International Bank Account Number"></label>
          <label>SWIFT/BIC Code<input type="text" id="empSwiftCode" placeholder="Bank Identifier Code"></label>
          <label>Bank Code<input type="text" id="empBankCode" placeholder="National bank code"></label>
          <label>Branch Code<input type="text" id="empBranchCode" placeholder="Branch/Sort code"></label>
          <label>Branch Name<input type="text" id="empBranchName" placeholder="Branch location"></label>
          <label>Routing Number<input type="text" id="empRoutingNumber" placeholder="ABA/ACH routing (US)"></label>
          <label>BSB Code<input type="text" id="empBSBCode" placeholder="Bank-State-Branch (AU)"></label>
          <label>IFSC Code<input type="text" id="empIFSCCode" placeholder="Indian Financial System Code"></label>
          <label>RIB Key<input type="text" id="empRibKey" placeholder="Relevé d'Identité Bancaire"></label>
          <label>Transit Number<input type="text" id="empTransitNumber" placeholder="Transit number (CA)"></label>
          <label>Institution Number<input type="text" id="empInstitutionNumber" placeholder="Institution number (CA)"></label>
          <label>Currency<input type="text" id="empBankCurrency" placeholder="e.g., USD, EUR, GBP" value="USD"></label>
          <label style="grid-column:1/-1;">Bank Address<textarea id="empBankAddress" rows="2" placeholder="Full bank branch address"></textarea></label>
          <label>Tax ID / TIN<input type="text" id="empTaxId" placeholder="Tax Identification Number"></label>
          <label>Social Security #<input type="text" id="empSSN" placeholder="Social Security Number"></label>
          <label>Pension #<input type="text" id="empPension" placeholder="Pension fund number"></label>
          <label>National ID<input type="text" id="empNationalId" placeholder="National identification"></label>
        </div>
      </section>
      <section class="emp-section" data-section="emergency">
        <h4><i class="fas fa-triangle-exclamation"></i> Emergency Contact</h4>
        <div class="emp-grid">
          <label style="grid-column:1/-1;">Notes<textarea id="empNotes" placeholder="Additional remarks / eligibility info"></textarea></label>
        </div>
        <div id="empEmergencyContactsContainer" style="margin-top:8px;">
          <div style="padding:6px 0; color:#777;">No contacts found</div>
        </div>
      </section>
    </div>
    <div class="employee-modal-footer">
      <button type="reset" class="btn" id="empModalReset"><i class="fas fa-rotate"></i> Reset</button>
      <button type="submit" class="btn-primary"><i class="fas fa-save"></i> Save Employee</button>
    </div>
  <datalist id="employeeIdOptionsModal"></datalist>
  `;

  // Close behavior
  form.querySelector('.employee-modal-close')?.addEventListener('click',()=> entityModalBackdrop.style.display='none');
  form.querySelector('#empModalReset')?.addEventListener('click',()=>{
    form.reset();
    $('#empDependents').value = '0';
    const sy = form.querySelector('#empSeniorityYears'); if(sy) sy.value = '0';
  });

  // Internal tab switching logic
  const sectionMap = {};
  form.querySelectorAll('.emp-section').forEach(sec=>{ sectionMap[sec.dataset.section]=sec; });
  // Activate first section
  const activateSection = (name)=>{
    Object.values(sectionMap).forEach(s=>s.classList.remove('active'));
    form.querySelectorAll('.emp-tab-btn').forEach(b=>{ b.classList.toggle('active', b.dataset.target===name); b.setAttribute('aria-selected', b.dataset.target===name? 'true':'false'); });
    const target = sectionMap[name]; if(target){ target.classList.add('active'); }
  };
  form.querySelectorAll('.emp-tab-btn').forEach(btn=> btn.addEventListener('click',()=> activateSection(btn.dataset.target)));
  // Ensure Personal tab is visible by default when the modal opens
  activateSection('personal');

  // Seniority years auto-compute from Seniority date
  const senDateEl = form.querySelector('#empSeniorityDate');
  const senYearsEl = form.querySelector('#empSeniorityYears');
  function parseDateFlexible(s){
    if(!s) return null;
    if(s instanceof Date) return isNaN(s.getTime()) ? null : s;
    const str = String(s).trim();
    // ISO or timestamp
    const iso = new Date(str);
    if(!isNaN(iso.getTime())) return iso;
    // Try DD/MM/YYYY or D/M/YYYY
    const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if(m){
      const dd = parseInt(m[1],10);
      const mm = parseInt(m[2],10);
      let yyyy = parseInt(m[3],10);
      if(yyyy<100) yyyy += 2000; // naive pivot
      const d = new Date(yyyy, mm-1, dd);
      return isNaN(d.getTime()) ? null : d;
    }
    return null;
  }
  function calcYearsFromDateStr(s){
    try{
      const d = parseDateFlexible(s);
      if(!d) return 0;
      const now = new Date();
      let years = now.getFullYear() - d.getFullYear();
      const anniv = new Date(now.getFullYear(), d.getMonth(), d.getDate());
      if(now < anniv) years -= 1;
      if(!Number.isFinite(years) || years < 0) years = 0;
      return years;
    }catch{ return 0; }
  }
  function updateSeniorityYears(){ if(senYearsEl && senDateEl){ senYearsEl.value = String(calcYearsFromDateStr(senDateEl.value)); } }
  if(senDateEl){ senDateEl.addEventListener('change', updateSeniorityYears); senDateEl.addEventListener('input', updateSeniorityYears); setTimeout(updateSeniorityYears, 0); }

  // Submission replicating original #employeeForm submit handler
  form.addEventListener('submit', e=>{
    e.preventDefault();
    const employees=getEmployees();
    // Use form-scoped selectors to get values from modal form
    const getValue = (selector) => {
      const el = form.querySelector(selector);
      return el ? el.value.trim() : '';
    };
    const getNumberValue = (selector) => {
      const el = form.querySelector(selector);
      return Number(el ? el.value : 0) || 0;
    };
    
    // Determine employing entity from the Company select (main:<cid> or sub:<sid>)
    let employerCompanyType = 'main';
    let employerCompanyId = (window.authManager?.currentUser?.companyId) || '';
    let employerCompanyName = '';
    const companySelectEl = form.querySelector('#empCompanySelect');
    if(companySelectEl && companySelectEl.value){
      const selVal = companySelectEl.value;
      const selectedOption = companySelectEl.options[companySelectEl.selectedIndex];
      if(selVal.startsWith('main:')){
        employerCompanyType = 'main';
        employerCompanyId = selVal.substring(5);
        // Strip the trailing (Main) label if present
        const optText = (selectedOption?.textContent || '').trim();
        employerCompanyName = optText.replace(/\s*\(Main\)\s*$/i,'');
      } else if(selVal.startsWith('sub:')){
        employerCompanyType = 'subcontractor';
        employerCompanyId = selVal.substring(4);
        employerCompanyName = selectedOption?.getAttribute('data-sub-name') || (selectedOption?.textContent || '');
      }
    }

    const id = getValue('#empId') || uid();
    const template = getValue('#empPayslipTemplate');
    const emp = {
      id,
      employeeId: getValue('#empId') || id,
      personal:{
        firstName: getValue('#empFirstName'),
        lastName: getValue('#empLastName'),
        gender: getValue('#empGender'),
        dob: getValue('#empDob'),
        nationality: getValue('#empNationality'),
        marital: getValue('#empMarital'),
        dependents: getNumberValue('#empDependents'),
        address: getValue('#empAddress'),
        city: getValue('#empCity'),
        country: getValue('#empCountry')
      },
      contact:{ 
        email: getValue('#empEmail'), 
        phone: getValue('#empPhone') 
      },
      employment:{
        department: getValue('#empDepartment'), 
        jobTitle: getValue('#empJobTitle'), 
        employmentType: getValue('#empEmploymentType'),
        workLocation: getValue('#empWorkLocation'), 
        seniorityDate: getValue('#empSeniorityDate'),
        seniorityYears: getNumberValue('#empSeniorityYears'),
        hireDate: getValue('#empHireDate'), 
        terminationDate: getValue('#empTerminationDate'),
        status: getValue('#empStatus'), 
        managerId: getValue('#empManagerId'), 
        grade: getValue('#empGrade'), 
        level: getValue('#empLevel'),
        payFrequency: getValue('#empPayFrequency'), 
        workingHoursWeek: getNumberValue('#empWorkingHoursWeek') || 40,
        workingHoursDay: getNumberValue('#empWorkingHoursDay') || 8,
  basicSalary: getNumberValue('#empBasicSalary'), 
  currency: getValue('#empBankCurrency'), 
        // Canonical template ID selection
        payslipTemplateId: template,
        // Legacy mirrors for backward compatibility across UI
        payslipTemplate: template, 
        payslipCategory: template,
        // Persist the employing entity on the employee record for reporting/scoping
        companyAffiliation: {
          type: employerCompanyType,
          id: employerCompanyId,
          name: employerCompanyName
        }
      },
      banking:{ 
        bankName: getValue('#empBankName'), 
        accountName: getValue('#empAccountName'), 
        accountNumber: getValue('#empAccountNumber'), 
        accountType: getValue('#empAccountType'),
        iban: getValue('#empIBAN'),
        swiftCode: getValue('#empSwiftCode'),
        bankCode: getValue('#empBankCode'), 
        branchCode: getValue('#empBranchCode'), 
        branchName: getValue('#empBranchName'),
        routingNumber: getValue('#empRoutingNumber'),
        bsbCode: getValue('#empBSBCode'),
        ifscCode: getValue('#empIFSCCode'),
        ribKey: getValue('#empRibKey'),
        transitNumber: getValue('#empTransitNumber'),
        institutionNumber: getValue('#empInstitutionNumber'),
        currency: getValue('#empBankCurrency'),
        bankAddress: getValue('#empBankAddress')
      },
      statutory:{ 
        taxId: getValue('#empTaxId'), 
        ssn: getValue('#empSSN'), 
        pension: getValue('#empPension'),
        nationalId: getValue('#empNationalId')
      },
      // Legacy single emergency contact fields removed; keep placeholder structure
      emergency:{ name:'', relation:'', phone:'', email:'' },
      notes: getValue('#empNotes'),
      createdAt:Date.now(), updatedAt:Date.now(),
      // Store current context companyId for clarity; persistence remains scoped to current context
      companyId: (window.authManager?.currentUser?.companyId || null),
      // Convenience top-level fields mirroring companymanagement.html schema for joins/filters
      employerCompanyType,
      employerCompanyId,
      employerCompanyName
    };
    const existingIndex = employees.findIndex(x=>x.id===id || x.employeeId===emp.employeeId);
    if(existingIndex>=0){ employees[existingIndex]=emp; } else { employees.push(emp); }
    // Store directly to Firebase real-time database (primary storage)
    persistEmployeeToFirebase(emp);
    // Update local cache for UI responsiveness
    saveEmployees(employees);
    entityModalBackdrop.style.display='none';
    renderEmployees();
    alert('Employee saved.');
  });

  // Re-populate payslip template options (mirrors reloadTemplateSelect usage)
  const tplSel = form.querySelector('#empPayslipTemplate');
  if(tplSel){
    const templates = getTemplates();
    tplSel.innerHTML = '<option value="">-- Select Template --</option>' + templates.map(t=>`<option value="${t.id}">${t.name}</option>`).join('');
  }

  // Populate Company select and hook Employee ID filtering
  const companySel = form.querySelector('#empCompanySelect');
  async function populateCompaniesSelect(){
    if(!companySel) return;
    try{
      if(!window.firebase || !firebase.database) { return; }
      const currentUser = window.authManager?.currentUser || null;
      const currentCompanyId = currentUser?.companyId || null;
      // Load main company and subcontractors under the current company
      companySel.innerHTML = '<option value="">-- Select Company --</option>';
      if(currentCompanyId){
        const compSnap = await firebase.database().ref(`companies/${currentCompanyId}`).once('value');
        const comp = compSnap.val() || {};
  const mainName = comp.companyName || comp.name || 'Main Company';
        const mainOpt = document.createElement('option');
        mainOpt.value = `main:${currentCompanyId}`;
  // Display only the company name (no '(Main)' suffix)
  mainOpt.textContent = `${mainName}`;
        companySel.appendChild(mainOpt);

        const subsSnap = await firebase.database().ref(`companies/${currentCompanyId}/subcontractors`).once('value');
        if(subsSnap.exists()){
          const subs = subsSnap.val() || {};
          Object.entries(subs).forEach(([sid, s])=>{
            const opt = document.createElement('option');
            const sName = s?.name || s?.companyName || sid;
            opt.value = `sub:${sid}`;
            opt.textContent = sName;
            opt.setAttribute('data-sub-name', sName);
            companySel.appendChild(opt);
          });
        }
        companySel.value = `main:${currentCompanyId}`;
      }
      // Populate the Employee ID datalist for the initial selection (main company)
      const datalist = form.querySelector('#employeeIdOptionsModal');
      if(typeof populateEmployeeIdDatalist === 'function'){
        const effectiveCompanyId = currentCompanyId || null;
        const mainFilter = effectiveCompanyId ? { type: 'main', id: effectiveCompanyId } : null;
        setTimeout(()=> populateEmployeeIdDatalist(effectiveCompanyId, datalist, mainFilter), 50);
      }
      // Warm the cache for auto-fill for the main company
      if(typeof cacheCompanyUsers === 'function') setTimeout(()=> cacheCompanyUsers(currentCompanyId || null), 80);
    }catch(e){ console.warn('Populate companies select failed', e); }
  }
  populateCompaniesSelect();

  // When company changes, refresh the datalist options and cache
  companySel?.addEventListener('change', ()=>{
    const selVal = companySel.value || '';
    const datalist = form.querySelector('#employeeIdOptionsModal');
    // Decode selection: main:<cid> or sub:<sid>
    let effectiveCompanyId = null;
    let filter = null;
    if(selVal.startsWith('main:')){
      effectiveCompanyId = selVal.substring(5);
      filter = { type: 'main', id: effectiveCompanyId };
    } else if(selVal.startsWith('sub:')){
      // For subcontractors, users still live under the main company; use current main company id
      effectiveCompanyId = (window.authManager?.currentUser?.companyId) || null;
      const selectedOption = companySel.options[companySel.selectedIndex];
      const subName = selectedOption?.getAttribute('data-sub-name') || selectedOption?.textContent || '';
      filter = { type: 'subcontractor', id: selVal.substring(4), name: subName };
    }
  if(typeof populateEmployeeIdDatalist === 'function') populateEmployeeIdDatalist(effectiveCompanyId, datalist, filter);
    if(typeof cacheCompanyUsers === 'function') cacheCompanyUsers(effectiveCompanyId);
    // Clear current Employee ID value to avoid cross-company mismatches
    const empIdInputLocal = form.querySelector('#empId');
    if(empIdInputLocal){ empIdInputLocal.value=''; }
  });

  // Ensure employeeIdOptions datalist is populated (function already exists) - fallback if companies couldn't load
  if(typeof populateEmployeeIdDatalist === 'function') setTimeout(()=>{
    const currentCompanyId = window.authManager?.currentUser?.companyId || null;
    const mainFilter = currentCompanyId ? { type: 'main', id: currentCompanyId } : null;
    populateEmployeeIdDatalist(currentCompanyId, form.querySelector('#employeeIdOptionsModal'), mainFilter);
  }, 100);
  
  // Hook auto-fill on both change and input events for better datalist support
  const empIdInput = form.querySelector('#empId');
  if(empIdInput) {
    empIdInput.addEventListener('change', ()=> {
      console.log('🔄 Employee ID changed:', empIdInput.value);
      setTimeout(() => autoFillEmployeeFromCompanyUser(form), 80);
      setTimeout(() => autoFillEmployeeFromContract(form), 160);
    });
    empIdInput.addEventListener('input', ()=> {
      // Only trigger on meaningful input (not every keystroke)
      const val = empIdInput.value.trim();
      if(val && val.length >= 2) {
        setTimeout(() => autoFillEmployeeFromCompanyUser(form), 120);
        setTimeout(() => autoFillEmployeeFromContract(form), 220);
      }
    });
  }

  return form;
}

// Set read-only mode for Edit Employee modal: everything is locked except Company select, Employee ID, and fields under the Banking & Statutory tab
function makeEmployeeModalReadOnly(form){
  if(!form) return;
  try{
    // Fields allowed to be edited in the modal
    const whitelistIds = new Set([
      'empCompanySelect',      // Company selector
      'empId',                 // Employee ID
      'empPayFrequency',       // Pay Frequency (now editable)
      'empPayslipTemplate'     // Payslip Template (now editable)
    ]);
    const isInBanking = (el)=> !!el.closest('.emp-section[data-section="banking"]');
    const controls = form.querySelectorAll('input, select, textarea');
    controls.forEach(el=>{
      const id = el.id || '';
      // Force banking currency to be read-only even inside the Banking tab
      if(id === 'empBankCurrency'){
        const tag = (el.tagName||'').toLowerCase();
        if(tag==='select') el.disabled = true; else el.readOnly = true;
        return;
      }
      // Allow edits for company selector and employee ID everywhere
      if(id && whitelistIds.has(id)) return;
      // Allow edits for anything inside the Banking & Statutory tab
      if(isInBanking(el)) return;
      const tag = (el.tagName||'').toLowerCase();
      if(tag==='select') el.disabled = true;
      else el.readOnly = true;
    });
  }catch(e){ console.warn('Failed to apply read-only mode on employee modal', e); }
}

function buildPayElementForm(){
  const wrapper=document.createElement('form');
  wrapper.id='payElementModalForm';
  wrapper.className='grid cols-4';
  wrapper.innerHTML = $('#payElementForm')?.innerHTML || '';
  // Value mode toggle logic
  const typeSel = wrapper.querySelector('#peType');
  const deductRow = wrapper.querySelector('#peDeductRow');
  const deductSel = wrapper.querySelector('#peDeductFrom');
  const deductEmpCb = wrapper.querySelector('#peDeductEmp');
  const deductCmpCb = wrapper.querySelector('#peDeductCmp');
  const modeSel = wrapper.querySelector('#peValueMode');
  const amountWrap = wrapper.querySelector('#peAmountWrapper');
  const percentWrap = wrapper.querySelector('#pePercentWrapper');
  const percentBaseWrap = wrapper.querySelector('#pePercentBaseWrapper');
  const percentRow = wrapper.querySelector('#pePercentRow');
  const builderToggleWrap = wrapper.querySelector('#peBuilderToggleWrapper');
  const calcSpacer = wrapper.querySelector('#peCalcSpacer');
  const formulaBuilderSection = wrapper.querySelector('#peFormulaBuilderSection');
  const formulaInput = wrapper.querySelector('#peFormula');
  const formulaBuilder = wrapper.querySelector('#peFormulaBuilder');
  const formulaToggleBtn = wrapper.querySelector('#peFormulaToggleBuilder');
  const percentBaseSel = wrapper.querySelector('#pePercentBase');
  // Company calculation elements
  const cmpBlock = wrapper.querySelector('#peCompanyCalcContainer');
  const cmpModeSel = wrapper.querySelector('#peCmpValueMode');
  const cmpAmountInput = wrapper.querySelector('#peCmpAmount');
  const cmpPercentRow = wrapper.querySelector('#peCmpPercentRow');
  const cmpPercentWrapper = wrapper.querySelector('#peCmpPercentWrapper');
  const cmpPercentBaseWrapper = wrapper.querySelector('#peCmpPercentBaseWrapper');
  const cmpPercentBaseSel = wrapper.querySelector('#peCmpPercentBase');
  const cmpFormulaSection = wrapper.querySelector('#peCmpFormulaBuilderSection');
  const cmpFormulaBuilder = wrapper.querySelector('#peCmpFormulaBuilder');
  const cmpFormulaInput = wrapper.querySelector('#peCmpFormula');
  const cmpFormulaClear = wrapper.querySelector('#peCmpFormulaClear');
  const cmpFormulaValidate = wrapper.querySelector('#peCmpFormulaValidate');
  const cmpBuilderToggleWrap = wrapper.querySelector('#peCmpBuilderToggleWrapper');
  const cmpFormulaToggleBtn = wrapper.querySelector('#peCmpFormulaToggleBuilder');
  const cmpTokens = wrapper.querySelector('#peCmpFormulaTokens');
  const cmpPreview = wrapper.querySelector('#peCmpFormulaPreview');
  const cmpTaxableSel = wrapper.querySelector('#peCmpTaxable');
  const modeHelp = wrapper.querySelector('#peModeHelp');

  // Show/hide Deducted From based on Type
  function syncType(){
    const t = typeSel?.value || 'earning';
    if(deductRow){ deductRow.style.display = (t === 'deduction') ? 'flex' : 'none'; }
    // Update company calculation visibility when type changes
    if(typeof syncDeductFrom==='function') syncDeductFrom();
    // Ensure default selection for deduction
    if(t==='deduction'){
      if(deductEmpCb && deductCmpCb && deductSel){
        // If neither checked, default to Employee
        if(!deductEmpCb.checked && !deductCmpCb.checked){ deductEmpCb.checked = true; }
        // Reflect to hidden select
        const newVal = (deductEmpCb.checked && deductCmpCb.checked) ? 'both' : (deductEmpCb.checked ? 'employee' : 'company');
        deductSel.value = newVal;
      }
    }
  }
  if(typeSel){ typeSel.addEventListener('change', syncType); setTimeout(syncType, 0); }

  // Company calc block shows only when Deducted From is Both and Type is Deduction
  function syncDeductFrom(){
    const t = typeSel?.value || 'earning';
    const who = deductSel?.value || 'employee';
    if(cmpBlock){ cmpBlock.style.display = (t==='deduction' && who==='both') ? '' : 'none'; }
    // Rename headers when Both is selected
    const mainHeader = wrapper.querySelector('#peCalcHeaderTitle');
    const cmpHeader = wrapper.querySelector('#peCmpHeaderTitle');
    if(t==='deduction'){
      if(who==='both'){
        if(mainHeader) mainHeader.textContent = 'Employee';
        if(cmpHeader) cmpHeader.textContent = 'Company';
      } else if(who==='employee'){
        if(mainHeader) mainHeader.textContent = 'Employee';
        if(cmpHeader) cmpHeader.textContent = 'Company';
      } else if(who==='company'){
        if(mainHeader) mainHeader.textContent = 'Company';
        if(cmpHeader) cmpHeader.textContent = 'Company';
      }
    } else {
      if(mainHeader) mainHeader.textContent = 'Calculation';
      if(cmpHeader) cmpHeader.textContent = 'Company Calculation';
    }
    // Keep checkboxes in sync with hidden select
    if(deductEmpCb && deductCmpCb){
      deductEmpCb.checked = (who==='employee' || who==='both');
      deductCmpCb.checked = (who==='company' || who==='both');
    }
  }
  if(deductSel){ deductSel.addEventListener('change', syncDeductFrom); }
  // When user toggles checkboxes, update hidden select and re-sync
  function onDeductCheckboxChange(){
    if(!deductSel) return;
    const eChecked = !!deductEmpCb?.checked;
    const cChecked = !!deductCmpCb?.checked;
    // Enforce at least one selected
    if(!eChecked && !cChecked){
      // Default back to Employee
      if(deductEmpCb) deductEmpCb.checked = true;
    }
    const val = (deductEmpCb?.checked && deductCmpCb?.checked) ? 'both' : ((deductEmpCb?.checked) ? 'employee' : 'company');
    deductSel.value = val;
    deductSel.dispatchEvent(new Event('change'));
  }
  if(deductEmpCb) deductEmpCb.addEventListener('change', onDeductCheckboxChange);
  if(deductCmpCb) deductCmpCb.addEventListener('change', onDeductCheckboxChange);

  // Populate Percent Base with all pay elements as selectable bases (flat list)
  const existing = getPayElements();
  if(percentBaseSel){
    existing.forEach(pe=>{
      const opt=document.createElement('option');
      opt.value = `__pe__:${pe.code}`;
      opt.textContent = `${pe.code} - ${pe.name}`;
      percentBaseSel.appendChild(opt);
    });
  }
  if(cmpPercentBaseSel){
    existing.forEach(pe=>{
      const opt=document.createElement('option');
      opt.value = `__pe__:${pe.code}`;
      opt.textContent = `${pe.code} - ${pe.name}`;
      cmpPercentBaseSel.appendChild(opt);
    });
  }

  function syncValueMode(){
    const m = modeSel.value;
    if(modeHelp){
      if(m==='amount') modeHelp.textContent = 'Use a fixed amount for this pay element. Choose Percentage to base it on Basic, Gross, Net, or another element. Choose Formula for advanced expressions.';
      else if(m==='percent') modeHelp.textContent = 'Calculated as percent × selected base. You can choose Basic, Gross, Net (pre this item), or another pay element as base.';
      else if(m==='formula') modeHelp.textContent = '';
    }
    if(m==='amount') { 
      if(amountWrap) amountWrap.style.display='block'; 
      if(percentRow) percentRow.style.display='none';
      if(percentWrap) percentWrap.style.display='none'; 
      if(percentBaseWrap) percentBaseWrap.style.display='none';
      if(formulaBuilderSection) formulaBuilderSection.style.display='none';
      if(builderToggleWrap) builderToggleWrap.style.display='none';
      if(calcSpacer) calcSpacer.style.visibility='visible';
    } else if(m==='percent'){ 
      if(amountWrap) amountWrap.style.display='none';
      if(percentRow) percentRow.style.display='flex';
      if(percentWrap) percentWrap.style.display='block'; 
      if(percentBaseWrap) percentBaseWrap.style.display='block';
      if(formulaBuilderSection) formulaBuilderSection.style.display='none';
      if(builderToggleWrap) builderToggleWrap.style.display='none';
      if(calcSpacer) calcSpacer.style.visibility='visible';
    } else if(m==='formula'){
      if(amountWrap) amountWrap.style.display='none';
      if(percentRow) percentRow.style.display='none';
      if(percentWrap) percentWrap.style.display='none';
      if(percentBaseWrap) percentBaseWrap.style.display='none';
      if(formulaBuilderSection) formulaBuilderSection.style.display='block';
      if(builderToggleWrap) builderToggleWrap.style.display='block';
      if(calcSpacer) calcSpacer.style.visibility='hidden';
    }
     // After amounts are computed, apply template rules if any
     const allRules = getRules().filter(r=> r.active && r.templateId===(emp.employment.payslipCategory||''));
     if(allRules.length){
       const ctx = rebuildContext();
       function matches(rule){
         const val = Number(ctx[rule.elementCode]||0);
         if(rule.condition==='between'){ return val>=Number(rule.value1||0) && val<=Number(rule.value2||0); }
         if(rule.condition==='>') return val>Number(rule.value1||0);
         if(rule.condition==='>=') return val>=Number(rule.value1||0);
         if(rule.condition==="<") return val<Number(rule.value1||0);
         if(rule.condition==='<=') return val<=Number(rule.value1||0);
         if(rule.condition==='==') return val===Number(rule.value1||0);
         return false;
       }
       allRules.forEach(rule=>{
         if(!rule.formula) return;
         if(!matches(rule)) return;
         const newAmt = Math.round(Number((typeof window.evalFormula==='function'? window.evalFormula(rule.formula, ctx):0)||0)*100)/100;
         const eIdx = earnings.findIndex(x=>x.code===rule.elementCode);
         if(eIdx>=0){ earnings[eIdx].amount = newAmt; ctx[rule.elementCode]=newAmt; }
         const dIdx = deductions.findIndex(x=>x.code===rule.elementCode);
         if(dIdx>=0){ deductions[dIdx].amount = newAmt; ctx[rule.elementCode]=newAmt; }
       });
     }
  }
  if(modeSel) { modeSel.addEventListener('change', syncValueMode); syncValueMode(); }

  // Company calc mode toggle + simple formula helpers
  function syncCmpValueMode(){
    if(!cmpModeSel) return;
    const m = cmpModeSel.value;
    const cmpAmountWrap = cmpAmountInput?.closest('label');
    if(m==='amount'){
      if(cmpAmountWrap) cmpAmountWrap.style.display='';
      if(cmpPercentRow) cmpPercentRow.style.display='flex';
      if(cmpPercentWrapper) cmpPercentWrapper.style.display='none';
      if(cmpPercentBaseWrapper) cmpPercentBaseWrapper.style.display='none';
      if(cmpFormulaSection) cmpFormulaSection.style.display='none';
      if(cmpBuilderToggleWrap) cmpBuilderToggleWrap.style.display='none';
      const cmpCalcSpacer = wrapper.querySelector('#peCmpCalcSpacer'); if(cmpCalcSpacer) cmpCalcSpacer.style.visibility='visible';
    } else if(m==='percent'){
      if(cmpAmountWrap) cmpAmountWrap.style.display='none';
      if(cmpPercentRow) cmpPercentRow.style.display='flex';
      if(cmpPercentWrapper) cmpPercentWrapper.style.display='';
      if(cmpPercentBaseWrapper) cmpPercentBaseWrapper.style.display='';
      if(cmpFormulaSection) cmpFormulaSection.style.display='none';
      if(cmpBuilderToggleWrap) cmpBuilderToggleWrap.style.display='none';
      const cmpCalcSpacer = wrapper.querySelector('#peCmpCalcSpacer'); if(cmpCalcSpacer) cmpCalcSpacer.style.visibility='visible';
    } else if(m==='formula'){
      if(cmpAmountWrap) cmpAmountWrap.style.display='none';
      if(cmpPercentRow) cmpPercentRow.style.display='none';
      if(cmpPercentWrapper) cmpPercentWrapper.style.display='none';
      if(cmpPercentBaseWrapper) cmpPercentBaseWrapper.style.display='none';
      if(cmpFormulaSection) cmpFormulaSection.style.display='';
      if(cmpBuilderToggleWrap) cmpBuilderToggleWrap.style.display='block';
      const cmpCalcSpacer = wrapper.querySelector('#peCmpCalcSpacer'); if(cmpCalcSpacer) cmpCalcSpacer.style.visibility='hidden';
    }
  }
  if(cmpModeSel) { cmpModeSel.addEventListener('change', syncCmpValueMode); syncCmpValueMode(); }
  if(cmpFormulaClear){ cmpFormulaClear.addEventListener('click', ()=>{ if(cmpFormulaInput) cmpFormulaInput.value=''; }); }
  if(cmpFormulaValidate){ cmpFormulaValidate.addEventListener('click', ()=>{
    const exampleCtx = { BASIC:0, GROSS_PRE:0, EARNINGS_SUM:0, DEDUCTIONS_SUM:0, SENIORITY_YEARS:0 };
    try {
      if(typeof sanitizeFormula==='function') sanitizeFormula(cmpFormulaInput?.value||'');
  if(typeof window.evalFormula==='function') window.evalFormula(cmpFormulaInput?.value||'', exampleCtx);
      alert('Company formula looks valid.');
    } catch(e){ alert('Company formula validation failed: '+(e?.message||e)); }
  }); }

  // Toggle builder to reduce vertical space
  if(formulaToggleBtn && formulaBuilder){
    formulaToggleBtn.addEventListener('click', ()=>{
      const isHidden = (formulaBuilder.style.display==='none' || getComputedStyle(formulaBuilder).display==='none');
      formulaBuilder.style.display = isHidden ? 'block' : 'none';
      const icon = formulaToggleBtn.querySelector('i');
      if(icon){ icon.className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down'; }
      formulaToggleBtn.lastChild.nodeValue = isHidden ? ' Hide Builder' : ' Show Builder';
    });
  }

  // Toggle company builder to reduce vertical space
  if(cmpFormulaToggleBtn && cmpFormulaBuilder){
    cmpFormulaToggleBtn.addEventListener('click', ()=>{
      const isHidden = (cmpFormulaBuilder.style.display==='none' || getComputedStyle(cmpFormulaBuilder).display==='none');
      cmpFormulaBuilder.style.display = isHidden ? 'block' : 'none';
      const icon = cmpFormulaToggleBtn.querySelector('i');
      if(icon){ icon.className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down'; }
      cmpFormulaToggleBtn.lastChild.nodeValue = isHidden ? ' Hide Builder' : ' Show Builder';
    });
  }

  // BASIC enforcement on new creation too
  const codeInput = wrapper.querySelector('#peCode');
  const modeLabel = modeSel?.closest('label');
  function enforceBasic(){
    if(!codeInput) return;
    const isBasic = codeInput.value.trim().toUpperCase()==='BASIC';
    const isGross = codeInput.value.trim().toUpperCase()==='GROSS';
    if(isBasic){
      if(modeLabel) modeLabel.style.display='none';
      if(modeSel){ modeSel.value='amount'; modeSel.dispatchEvent(new Event('change')); }
      ['#pePercentWrapper','#pePercentBaseWrapper'].forEach(sel=>{ const el=wrapper.querySelector(sel); if(el) el.style.display='none'; });
      if(formulaBuilderSection) formulaBuilderSection.style.display='none';
    } else {
      if(modeLabel) modeLabel.style.display='';
      if(isGross){
        // For GROSS, force formula mode UI and show a hint that this overrides GROSS_PRE
        if(modeSel){ modeSel.value='formula'; modeSel.dispatchEvent(new Event('change')); }
        if(amountWrap) amountWrap.style.display='none';
        ['#pePercentWrapper','#pePercentBaseWrapper'].forEach(sel=>{ const el=wrapper.querySelector(sel); if(el) el.style.display='none'; });
        if(formulaBuilderSection){
          formulaBuilderSection.style.display='block';
          // Add helper hint under preview once
          const existed = wrapper.querySelector('#grossOverrideHint');
          if(!existed){
            const hint = document.createElement('small');
            hint.id='grossOverrideHint';
            hint.style.color='#6366f1';
            hint.style.display='block';
            hint.style.marginTop='6px';
            hint.textContent = 'This formula will override system Gross (GROSS_PRE) used by percent bases and net calculation.';
            formulaBuilderSection.appendChild(hint);
          }
        }
      }
    }
  }
  if(codeInput){ codeInput.addEventListener('input', enforceBasic); enforceBasic(); }

  // Formula Builder wiring
  const fbAdd = wrapper.querySelector('#peFormulaAdd');
  const fbExamples = wrapper.querySelector('#peFormulaExamples');
  const fbClear = wrapper.querySelector('#peFormulaClear');
  const fbValidate = wrapper.querySelector('#peFormulaValidate');
  const fbTokens = wrapper.querySelector('#peFormulaTokens');
  const fbPreview = wrapper.querySelector('#peFormulaPreview');
  // Company builder mirrors
  const cmpFbTokens = cmpTokens;
  const cmpFbPreview = cmpPreview;
  
  // Inline palette of available variables and pay elements to click and insert
  (function initFormulaPalette(){
    const formulaBuilderEl = wrapper.querySelector('#peFormulaBuilderSection');
    if(!formulaBuilderEl) return;
    let palette = wrapper.querySelector('#peFormulaElementPalette');
    if(!palette){
      palette = document.createElement('div');
      palette.id = 'peFormulaElementPalette';
      palette.style.marginTop = '8px';
  const title = document.createElement('small');
  title.textContent = 'Click to insert pay elements:';
      title.style.display = 'block';
      title.style.color = '#64748b';
      title.style.fontSize = '.78rem';
      const chips = document.createElement('div');
      chips.id = 'peFormulaElementChips';
      chips.style.cssText = 'display:flex;gap:4px;flex-wrap:wrap;max-height:100px;overflow:auto;margin-top:4px;';
      palette.appendChild(title);
      palette.appendChild(chips);
      // Add to the end of the formula builder section
      formulaBuilderEl.appendChild(palette);
    }

    function renderPalette(){
      const chips = wrapper.querySelector('#peFormulaElementChips');
      if(!chips) return;
      chips.innerHTML = '';
      const currentCode = (wrapper.querySelector('#peCode')?.value||'').trim().toUpperCase();
      // Variables removed from palette per requirements; only pay element codes will be listed below
      // Pay element codes, excluding the element being edited and excluding special GROSS to avoid cycles
      try{
        const codes = Array.from(new Set((getPayElements?.()||[]).map(pe=> String(pe.code||'').toUpperCase()).filter(Boolean)));
        codes
          .filter(code=> code !== currentCode && code !== 'GROSS')
          .forEach(code=>{
            const btn = document.createElement('button');
            btn.type='button';
            btn.textContent = code;
            btn.style.cssText = 'background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:1px 6px;border-radius:999px;cursor:pointer;font-size:.65rem;';
            btn.addEventListener('click', ()=> addTokenChip(code, code));
            chips.appendChild(btn);
          });
        // One high-value variable requested: SENIORITY_YEARS
        const divider = document.createElement('div');
        divider.style.cssText = 'flex-basis:100%;height:0;margin:2px 0;';
        chips.appendChild(divider);
        const varLabel = document.createElement('small');
        varLabel.textContent = 'Variables:';
        varLabel.style.cssText = 'color:#64748b;font-size:.7rem;margin-right:4px;align-self:center;';
        chips.appendChild(varLabel);
  const vbtn1 = document.createElement('button');
  vbtn1.type='button';
  vbtn1.textContent = 'SENIORITY_YEARS';
  vbtn1.title = 'Employee seniority in years';
  vbtn1.style.cssText = 'background:#ecfeff;border:1px solid #a5f3fc;color:#155e75;padding:1px 6px;border-radius:999px;cursor:pointer;font-size:.65rem;';
  vbtn1.addEventListener('click', ()=> addTokenChip('SENIORITY_YEARS', 'SENIORITY_YEARS'));
  chips.appendChild(vbtn1);
  const vbtn2 = document.createElement('button');
  vbtn2.type='button';
  vbtn2.textContent = 'OVERTIME';
  vbtn2.title = 'Employee overtime hours for the selected month';
  vbtn2.style.cssText = 'background:#ecfeff;border:1px solid #a5f3fc;color:#155e75;padding:1px 6px;border-radius:999px;cursor:pointer;font-size:.65rem;';
  vbtn2.addEventListener('click', ()=> addTokenChip('OVERTIME', 'OVERTIME'));
  chips.appendChild(vbtn2);
      }catch(e){ /* noop */ }
    }

    // Initial and reactive render
    renderPalette();
    // Re-render shortly after open to catch programmatic code prefill in edit mode
    setTimeout(renderPalette, 80);
    const codeInputLocal = wrapper.querySelector('#peCode');
    if(codeInputLocal){ codeInputLocal.addEventListener('input', renderPalette); }
  })();

  function getAllElementCodes(){
    try { return getPayElements().map(pe=>pe.code); } catch(e){ return []; }
  }
  function renderTokens(){
    const parts = [];
    fbTokens.querySelectorAll('[data-token]')?.forEach(el=>{ parts.push(el.getAttribute('data-token')||''); });
    const formula = parts.join(' ').replace(/\s+([,()])/g,'$1');
    if(formulaInput) formulaInput.value = formula.trim();
    if(fbPreview) fbPreview.textContent = formulaInput?.value || '';
  }
  function cmpRenderTokens(){
    const parts = [];
    cmpFbTokens?.querySelectorAll('[data-token]')?.forEach(el=>{ parts.push(el.getAttribute('data-token')||''); });
    const formula = parts.join(' ').replace(/\s+([,()])/g,'$1');
    if(cmpFormulaInput) cmpFormulaInput.value = formula.trim();
    if(cmpFbPreview) cmpFbPreview.textContent = cmpFormulaInput?.value || '';
  }
  function addTokenChip(token, label){
    const chip = document.createElement('span');
    chip.className = 'chip';
  chip.setAttribute('data-token', token);
  chip.style.cssText = 'background:#eef2ff;border:1px solid #c7d2fe;color:#1e293b;padding:1px 6px;border-radius:999px;display:inline-flex;align-items:center;gap:4px;box-shadow:0 1px 1px rgba(0,0,0,0.03);font-size:.6rem;';
  chip.innerHTML = `<span>${label||token}</span><button type="button" title="Remove" style="border:none;background:#e2e8f0;color:#334155;cursor:pointer;width:14px;height:14px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;line-height:14px;font-size:.6rem;">&times;</button>`;
    chip.querySelector('button')?.addEventListener('click',()=>{ chip.remove(); renderTokens(); });
    fbTokens.appendChild(chip);
    renderTokens();
  }
  function cmpAddTokenChip(token, label){
    if(!cmpFbTokens) return;
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.setAttribute('data-token', token);
    chip.style.cssText = 'background:#eef2ff;border:1px solid #c7d2fe;color:#1e293b;padding:1px 6px;border-radius:999px;display:inline-flex;align-items:center;gap:4px;box-shadow:0 1px 1px rgba(0,0,0,0.03);font-size:.6rem;';
    chip.innerHTML = `<span>${label||token}</span><button type="button" title="Remove" style="border:none;background:#e2e8f0;color:#334155;cursor:pointer;width:14px;height:14px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;line-height:14px;font-size:.6rem;">&times;</button>`;
    chip.querySelector('button')?.addEventListener('click',()=>{ chip.remove(); cmpRenderTokens(); });
    cmpFbTokens.appendChild(chip);
    cmpRenderTokens();
  }
  // Simple operator toolbars for quick insert
  (function injectOperatorBars(){
    try{
      const bar = document.createElement('div');
      bar.id = 'peFormulaOps';
      bar.style.cssText = 'display:flex;gap:6px;flex-wrap:wrap;margin:6px 0;';
      bar.innerHTML = `
        <small style="color:#64748b;">Operators:</small>
        <button type="button" class="btn" data-op="+" title="Add">+</button>
        <button type="button" class="btn" data-op="-" title="Subtract">-</button>
        <button type="button" class="btn" data-op="*" title="Multiply">×</button>
        <button type="button" class="btn" data-op="/" title="Divide">÷</button>
        <button type="button" class="btn" data-op="^" title="Power">^</button>
        <button type="button" class="btn" data-op="(" title="Left parenthesis">(</button>
        <button type="button" class="btn" data-op=")" title="Right parenthesis">)</button>
        <button type="button" class="btn" data-op="," title="Comma">,</button>`;
      const fb = wrapper.querySelector('#peFormulaBuilder');
      if(fb){ fb.appendChild(bar); }
      bar.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button[data-op]');
        if(!btn) return;
        const op = btn.getAttribute('data-op');
        addTokenChip(op, btn.textContent.trim() || op);
      });
    }catch(e){ /*noop*/ }
    try{
      const bar = document.createElement('div');
      bar.id = 'peCmpFormulaOps';
      bar.style.cssText = 'display:flex;gap:6px;flex-wrap:wrap;margin:6px 0;';
      bar.innerHTML = `
        <small style="color:#64748b;">Operators:</small>
        <button type="button" class="btn" data-op="+" title="Add">+</button>
        <button type="button" class="btn" data-op="-" title="Subtract">-</button>
        <button type="button" class="btn" data-op="*" title="Multiply">×</button>
        <button type="button" class="btn" data-op="/" title="Divide">÷</button>
        <button type="button" class="btn" data-op="^" title="Power">^</button>
        <button type="button" class="btn" data-op="(" title="Left parenthesis">(</button>
        <button type="button" class="btn" data-op=")" title="Right parenthesis">)</button>
        <button type="button" class="btn" data-op="," title="Comma">,</button>`;
      const fb = wrapper.querySelector('#peCmpFormulaBuilder');
      if(fb){ fb.appendChild(bar); }
      bar.addEventListener('click', (ev)=>{
        const btn = ev.target.closest('button[data-op]');
        if(!btn) return;
        const op = btn.getAttribute('data-op');
        cmpAddTokenChip(op, btn.textContent.trim() || op);
      });
    }catch(e){ /*noop*/ }
  })();
  function openAddTokenMenu(){
    const menu = document.createElement('div');
    menu.style.cssText = 'position:absolute;background:#fff;border:1px solid #e2e8f0;box-shadow:0 6px 20px rgba(0,0,0,0.08);padding:10px;border-radius:8px;z-index:1000;min-width:260px;';
    menu.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <button type="button" class="btn" data-kind="element">Element</button>
        <button type="button" class="btn" data-kind="number">Number</button>
        <button type="button" class="btn" data-kind="operator">Operator</button>
        <button type="button" class="btn" data-kind="function">Function</button>
        <button type="button" class="btn" data-kind="paren">( )</button>
        <button type="button" class="btn" data-kind="comma">,</button>
      </div>
      <div id="fbInputArea" style="margin-top:8px;"></div>
    `;
    document.body.appendChild(menu);
    const rect = fbAdd.getBoundingClientRect();
    menu.style.left = `${rect.left + window.scrollX}px`;
    menu.style.top = `${rect.bottom + window.scrollY + 6}px`;

    function close(){ menu.remove(); document.removeEventListener('click', onDoc); }
    function onDoc(ev){ if(!menu.contains(ev.target) && ev.target!==fbAdd) close(); }
    setTimeout(()=>document.addEventListener('click', onDoc), 0);

    const inputArea = menu.querySelector('#fbInputArea');
    menu.querySelectorAll('[data-kind]')?.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const kind = btn.getAttribute('data-kind');
        inputArea.innerHTML = '';
        if(kind==='element'){
          const sel = document.createElement('select'); sel.style.width='100%';
          const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='Select element code';
          sel.appendChild(placeholder);
          getAllElementCodes().forEach(code=>{ const o=document.createElement('option'); o.value=code; o.textContent=code; sel.appendChild(o); });
          const addBtn = document.createElement('button'); addBtn.type='button'; addBtn.className='btn'; addBtn.textContent='Add'; addBtn.style.marginTop='6px';
          addBtn.addEventListener('click',()=>{ if(sel.value){ addTokenChip(sel.value, sel.value); close(); }});
          inputArea.appendChild(sel); inputArea.appendChild(addBtn);
        } else if(kind==='number'){
          const inp = document.createElement('input'); inp.type='number'; inp.step='0.01'; inp.placeholder='e.g. 100'; inp.style.width='100%';
          const addBtn = document.createElement('button'); addBtn.type='button'; addBtn.className='btn'; addBtn.textContent='Add'; addBtn.style.marginTop='6px';
          addBtn.addEventListener('click',()=>{ if(inp.value!=='' ){ addTokenChip(inp.value, inp.value); close(); }});
          inputArea.appendChild(inp); inputArea.appendChild(addBtn);
        } else if(kind==='operator'){
          const ops=['+','-','*','/','^'];
          const sel = document.createElement('select'); sel.style.width='100%';
          ops.forEach(op=>{ const o=document.createElement('option'); o.value=op; o.textContent=op; sel.appendChild(o); });
          const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='btn'; addBtn.textContent='Add'; addBtn.style.marginTop='6px';
          addBtn.addEventListener('click',()=>{ addTokenChip(sel.value, sel.value); close(); });
          inputArea.appendChild(sel); inputArea.appendChild(addBtn);
        } else if(kind==='function'){
          const fns=['MIN','MAX','ROUND','FLOOR','CEIL','ABS','CLAMP','IF'];
          const sel = document.createElement('select'); sel.style.width='100%';
          fns.forEach(fn=>{ const o=document.createElement('option'); o.value=fn; o.textContent=fn; sel.appendChild(o); });
          const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='btn'; addBtn.textContent='Add'; addBtn.style.marginTop='6px';
          addBtn.addEventListener('click',()=>{ addTokenChip(`${sel.value}(`, `${sel.value}(`); close(); });
          inputArea.appendChild(sel); inputArea.appendChild(addBtn);
        } else if(kind==='paren'){
          const sel = document.createElement('select'); sel.style.width='100%';
          ['(',')'].forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o); });
          const addBtn=document.createElement('button'); addBtn.type='button'; addBtn.className='btn'; addBtn.textContent='Add'; addBtn.style.marginTop='6px';
          addBtn.addEventListener('click',()=>{ addTokenChip(sel.value, sel.value); close(); });
          inputArea.appendChild(sel); inputArea.appendChild(addBtn);
        } else if(kind==='comma'){
          addTokenChip(',', ','); close();
        }
      });
    });
  }
  if(fbAdd){ fbAdd.addEventListener('click', openAddTokenMenu); }
  if(fbExamples){
    fbExamples.addEventListener('click', ()=>{
      const menu = document.createElement('div');
      menu.style.cssText = 'position:absolute;background:#fff;border:1px solid #e2e8f0;box-shadow:0 6px 20px rgba(0,0,0,0.08);padding:10px;border-radius:8px;z-index:1000;min-width:280px;';
      menu.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:6px;">
          <button type="button" class="btn" data-ex="ex1">BASIC + EARNINGS_SUM</button>
          <button type="button" class="btn" data-ex="ex2">0.2 * BASIC</button>
          <button type="button" class="btn" data-ex="ex3">MIN(500, 0.1 * GROSS_PRE)</button>
          <button type="button" class="btn" data-ex="ex4">IF(EARNINGS_SUM > 1000, 100, 0)</button>
          <button type="button" class="btn" data-ex="ex5">IF(CONTRACT_ACTIVE, BASIC, 0)</button>
          <button type="button" class="btn" data-ex="ex6">IF(CONTRACT_TENURE_MONTHS > 12, 100, 0)</button>
        </div>`;
      document.body.appendChild(menu);
      const rect = fbExamples.getBoundingClientRect();
      menu.style.left = `${rect.left + window.scrollX}px`;
      menu.style.top = `${rect.bottom + window.scrollY + 6}px`;
      function close(){ menu.remove(); document.removeEventListener('click', onDoc); }
      function onDoc(ev){ if(!menu.contains(ev.target) && ev.target!==fbExamples) close(); }
      setTimeout(()=>document.addEventListener('click', onDoc), 0);
      menu.querySelectorAll('[data-ex]')?.forEach(btn=>{
        btn.addEventListener('click',()=>{
          const key = btn.getAttribute('data-ex');
          const examples = { ex1:'BASIC + EARNINGS_SUM', ex2:'0.2 * BASIC', ex3:'MIN(500, 0.1 * GROSS_PRE)', ex4:'IF(EARNINGS_SUM > 1000, 100, 0)', ex5:'IF(CONTRACT_ACTIVE, BASIC, 0)', ex6:'IF(CONTRACT_TENURE_MONTHS > 12, 100, 0)' };
          const formula = examples[key] || '';
          if(formulaInput){ formulaInput.value = formula; }
          // rebuild chips to reflect example
          if(fbTokens){ fbTokens.innerHTML=''; }
          (formula.split(/\s+/).filter(Boolean)).forEach(t=> addTokenChip(t, t));
          close();
        });
      });
    });
  }
  if(fbClear){ fbClear.addEventListener('click', ()=>{ fbTokens.innerHTML=''; renderTokens(); }); }
  if(cmpFormulaClear){ cmpFormulaClear.addEventListener('click', ()=>{ if(cmpFbTokens){ cmpFbTokens.innerHTML=''; cmpRenderTokens(); } }); }
  if(fbValidate){ fbValidate.addEventListener('click', ()=>{
    const exampleCtx = { BASIC:0, GROSS_PRE:0, EARNINGS_SUM:0, DEDUCTIONS_SUM:0, SENIORITY_YEARS:0 };
    try {
      // Reuse sanitizer/evaluator if available
      if(typeof sanitizeFormula==='function') sanitizeFormula(formulaInput?.value||'');
  if(typeof window.evalFormula==='function') window.evalFormula(formulaInput?.value||'', exampleCtx);
      alert('Formula looks valid.');
    } catch(e){ alert('Formula validation failed: '+ (e?.message||e)); }
  }); }
  if(formulaInput){ formulaInput.addEventListener('input', ()=>{
    // Rebuild chips from textarea if user edits directly (simple split)
    fbTokens.innerHTML='';
    const raw = (formulaInput.value||'').trim();
    const tokens = raw.split(/\s+/).filter(Boolean);
    tokens.forEach(t=> addTokenChip(t, t));
  }); }
  if(cmpFormulaInput){ cmpFormulaInput.addEventListener('input', ()=>{
    if(!cmpFbTokens) return;
    cmpFbTokens.innerHTML='';
    const raw = (cmpFormulaInput.value||'').trim();
    const tokens = raw.split(/\s+/).filter(Boolean);
    tokens.forEach(t=> cmpAddTokenChip(t, t));
  }); }

  // Inline palette for company builder
  (function initCompanyFormulaPalette(){
    const formulaBuilderEl = wrapper.querySelector('#peCmpFormulaBuilderSection');
    if(!formulaBuilderEl) return;
    let palette = wrapper.querySelector('#peCmpFormulaElementPalette');
    if(!palette){
      palette = document.createElement('div');
      palette.id = 'peCmpFormulaElementPalette';
      palette.style.marginTop = '8px';
  const title = document.createElement('small');
  title.textContent = 'Click to insert pay elements:';
      title.style.display = 'block';
      title.style.color = '#64748b';
      title.style.fontSize = '.78rem';
      const chips = document.createElement('div');
      chips.id = 'peCmpFormulaElementChips';
      chips.style.cssText = 'display:flex;gap:4px;flex-wrap:wrap;max-height:100px;overflow:auto;margin-top:4px;';
      palette.appendChild(title);
      palette.appendChild(chips);
      formulaBuilderEl.appendChild(palette);
    }

    function renderPalette(){
      const chips = wrapper.querySelector('#peCmpFormulaElementChips');
      if(!chips) return;
      chips.innerHTML = '';
      const currentCode = (wrapper.querySelector('#peCode')?.value||'').trim().toUpperCase();
      // Variables removed from palette per requirements; only pay element codes will be listed below
      try{
        const codes = Array.from(new Set((getPayElements?.()||[]).map(pe=> String(pe.code||'').toUpperCase()).filter(Boolean)));
        codes
          .filter(code=> code !== currentCode && code !== 'GROSS')
          .forEach(code=>{
            const btn = document.createElement('button');
            btn.type='button';
            btn.textContent = code;
            btn.style.cssText = 'background:#eef2ff;border:1px solid #c7d2fe;color:#3730a3;padding:1px 6px;border-radius:999px;cursor:pointer;font-size:.65rem;';
            btn.addEventListener('click', ()=> cmpAddTokenChip(code, code));
            chips.appendChild(btn);
          });
        // Add SENIORITY_YEARS variable for company builder as well (optional use)
        const divider = document.createElement('div');
        divider.style.cssText = 'flex-basis:100%;height:0;margin:2px 0;';
        chips.appendChild(divider);
        const varLabel = document.createElement('small');
        varLabel.textContent = 'Variables:';
        varLabel.style.cssText = 'color:#64748b;font-size:.7rem;margin-right:4px;align-self:center;';
        chips.appendChild(varLabel);
  const vbtn1 = document.createElement('button');
  vbtn1.type='button';
  vbtn1.textContent = 'SENIORITY_YEARS';
  vbtn1.title = 'Employee seniority in years';
  vbtn1.style.cssText = 'background:#ecfeff;border:1px solid #a5f3fc;color:#155e75;padding:1px 6px;border-radius:999px;cursor:pointer;font-size:.65rem;';
  vbtn1.addEventListener('click', ()=> cmpAddTokenChip('SENIORITY_YEARS', 'SENIORITY_YEARS'));
  chips.appendChild(vbtn1);
  const vbtn2 = document.createElement('button');
  vbtn2.type='button';
  vbtn2.textContent = 'OVERTIME';
  vbtn2.title = 'Employee overtime hours for the selected month';
  vbtn2.style.cssText = 'background:#ecfeff;border:1px solid #a5f3fc;color:#155e75;padding:1px 6px;border-radius:999px;cursor:pointer;font-size:.65rem;';
  vbtn2.addEventListener('click', ()=> cmpAddTokenChip('OVERTIME', 'OVERTIME'));
  chips.appendChild(vbtn2);
      }catch(e){ /* noop */ }
    }

    renderPalette();
    setTimeout(renderPalette, 80);
    const codeInputLocal = wrapper.querySelector('#peCode');
    if(codeInputLocal){ codeInputLocal.addEventListener('input', renderPalette); }
  })();

  // Inject Formula Tester UI (Employee-based)
  try{
    const testSection = document.createElement('div');
    testSection.id = 'peFormulaTestSection';
    testSection.style.gridColumn = '1 / -1';
    testSection.style.marginTop = '10px';
    testSection.innerHTML = `
      <div style="border-top:1px dashed #e2e8f0; padding-top:10px;">
        <h4 style="margin:0 0 8px; font-size:.85rem; color:#334155; display:flex; align-items:center; gap:8px;"><i class="fas fa-flask"></i> Test with employee</h4>
        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
          <label style="min-width:260px;">Employee<select id="peTestEmployeeSelect"><option value="">-- Select Employee --</option></select></label>
          <div id="peTestContext" style="display:flex; gap:12px; align-items:baseline; color:#64748b; font-size:.8rem;"></div>
          <div style="margin-left:auto;">
            <div style="color:#64748b; font-size:.8rem;">Computed amount</div>
            <div id="peTestResult" style="font-weight:700; font-size:1rem; color:#0f172a; text-align:right;">—</div>
          </div>
        </div>
        <div id="peTestDetails" style="margin-top:8px; display:grid; grid-template-columns: 1fr; gap:6px;">
          <div id="peTestStatusRow" style="display:flex; gap:8px; align-items:center;">
            <small id="peTestStatus" style="padding:2px 8px; border-radius:999px; background:#f1f5f9; color:#0f172a;">Status: —</small>
            <small id="peTestSanitized" style="color:#64748b;">Sanitized: —</small>
          </div>
          <div id="peTestEquation" style="font-size:.82rem; color:#334155; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:6px 8px;">Equation: —</div>
          <div id="peTestVarsWrap" style="border:1px dashed #e2e8f0; border-radius:8px; padding:6px; overflow:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:.76rem;">
              <thead><tr><th style="text-align:left; padding:4px 6px; border-bottom:1px solid #e2e8f0; width:30%;">Token</th><th style="text-align:right; padding:4px 6px; border-bottom:1px solid #e2e8f0;">Value</th></tr></thead>
              <tbody id="peTestVars"><tr><td colspan="2" style="text-align:center; color:#94a3b8; padding:6px;">No variables</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>`;
    // Place after the formula builder section to keep context
    const anchor = wrapper.querySelector('#peFormulaBuilderSection') || wrapper;
    anchor.insertAdjacentElement('afterend', testSection);
  }catch(e){ console.warn('Failed to add formula tester section', e); }

  function normKey(s){ return String(s||'').trim().toUpperCase(); }
  function safeKey(s){ return String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); }
  function deAccent(s){ try{ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch{ return String(s||''); } }
  const evalSafe = (f, ctx)=>{
    try{ if(typeof window.evalFormula==='function') return Number(window.evalFormula(f, ctx)||0); }catch{}
    return 0;
  };
  function normalizeFormulaForDisplay(formula){
    if(!formula) return '';
    let f = String(formula);
    try{ f = f.normalize('NFD').replace(/[\u0300-\u036f]/g,''); }catch{}
    f = f.toUpperCase();
    f = f.replace(/[×✕]/g, '*').replace(/[÷]/g, '/');
    // Show numbers as evaluated: normalize spaces and commas inside numeric literals
    f = f.replace(/[\u00A0\u202F\u2000-\u200A]/g,' ');
    f = f.replace(/(\d)\s+(?=\d)/g,'$1');
    f = f.replace(/(\d),(?=\d{3}\b)/g,'$1');
    f = f.replace(/(\d),(?=\d)/g,'$1.');
    f = f
      .replace(/\bSENIORITY\s+YEAR\b/g, 'SENIORITY YEARS')
      .replace(/\bSENIORITY[-_\s]*YEARS?\b/g, 'SENIORITY_YEARS')
      .replace(/\bYEARS?\s+OF\s+SENIORITY\b/g, 'SENIORITY_YEARS')
      .replace(/\bSENIORITYYEARS?\b/g, 'SENIORITY_YEARS')
      .replace(/\bANCIENNETE(?:\s+YEARS?)?\b/g, 'SENIORITY_YEARS')
      .replace(/\bYEARS?\s+OF\s+SERVICE\b/g, 'SENIORITY_YEARS')
      .replace(/\bSENIORITY\b/g, 'SENIORITY_YEARS')
      .replace(/\bBASIC\s+SALARY\b/g, 'BASIC')
      .replace(/\bBASIC\s+PAY\b/g, 'BASIC')
      .replace(/\bBASE\s+SALARY\b/g, 'BASIC')
      .replace(/\bBASE\s+PAY\b/g, 'BASIC')
      .replace(/\bSALARY\s+BASIC\b/g, 'BASIC')
      .replace(/\bEARNINGS\s+SUM\b/g, 'EARNINGS_SUM')
      .replace(/\bDEDUCTIONS\s+SUM\b/g, 'DEDUCTIONS_SUM')
      .replace(/\bEARNINGS\s+TOTAL\b/g, 'EARNINGS_SUM')
      .replace(/\bDEDUCTIONS\s+TOTAL\b/g, 'DEDUCTIONS_SUM')
      .replace(/\bGROSS\s+PRE\b/g, 'GROSS_PRE')
      .replace(/\bNET\s+PRE\b/g, 'NET_PRE')
      .replace(/\bOVERTIME\s+HOURS?\b/g, 'OVERTIME');
    f = f.replace(/[^A-Z0-9_+\-*/^()%.,<>!=\s]/g,'');
    return f.replace(/\s+/g,' ').trim();
  }
  // Local date helpers for tester to compute seniority robustly
  function parseDateFlexibleLocal(s){
    if(!s) return null;
    if(s instanceof Date) return isNaN(s.getTime()) ? null : s;
    const str = String(s).trim();
    const iso = new Date(str);
    if(!isNaN(iso.getTime())) return iso;
    const m = str.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);
    if(m){
      const dd = parseInt(m[1],10);
      const mm = parseInt(m[2],10);
      let yyyy = parseInt(m[3],10);
      if(yyyy<100) yyyy += 2000;
      const d = new Date(yyyy, mm-1, dd);
      return isNaN(d.getTime()) ? null : d;
    }
    return null;
  }
  function yearsFromDateStrLocal(s){
    try{
      const d = parseDateFlexibleLocal(s);
      if(!d) return 0;
      const now = new Date();
      let years = now.getFullYear() - d.getFullYear();
      const anniv = new Date(now.getFullYear(), d.getMonth(), d.getDate());
      if(now < anniv) years -= 1;
      if(!Number.isFinite(years) || years < 0) years = 0;
      return years;
    }catch{ return 0; }
  }
  function computeSeniorityYears(emp){
    try{
      if(emp?.employment?.seniorityYears != null && emp.employment.seniorityYears !== ''){
        return Number(emp.employment.seniorityYears)||0;
      }
      const candidates = [
        emp?.employment?.seniorityDate,
        emp?.employment?.startDate,
        emp?.employment?.hireDate,
        emp?.personal?.seniorityDate,
        emp?.personal?.hireDate,
        emp?.employment?.seniority,
      ].filter(Boolean);
      for(const s of candidates){
        const y = (typeof window.calcYearsFromDateStr==='function') ? Number(window.calcYearsFromDateStr(s)||0) : Number(yearsFromDateStrLocal(s)||0);
        if(Number.isFinite(y) && y>=0) return y;
      }
      return 0;
    }catch{return 0;}
  }
  function parseMoney(v){
    if(v==null) return 0;
    if(typeof v==='number') return Number.isFinite(v)?v:0;
    let s = String(v);
    // Normalize NBSP/thin spaces and remove spaces between digits
    s = s.replace(/[\u00A0\u202F\u2000-\u200A]/g,' ');
    s = s.replace(/(\d)\s+(?=\d)/g,'$1');
    // Keep only digits, signs, dots, commas
    s = s.replace(/[^0-9,.-]/g, '');
    // If both comma and dot present, treat commas as thousands separators
    if(s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');
    else s = s.replace(/,/g,'.');
    s = s.replace(/\s+/g,'');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }
  function buildCtx(emp){
    const BASIC = parseMoney(emp?.employment?.basicSalary||0);
    const ctx = { BASIC };
    ctx.GROSS_PRE = BASIC; // baseline without other template items
    ctx.NET_PRE = BASIC;   // baseline without other deductions
  ctx.EARNINGS_SUM = 0;  ctx.DEDUCTIONS_SUM = 0;
    ctx.SENIORITY_YEARS = computeSeniorityYears(emp);
    // helpful aliases
    ctx.SALAIRE_BASE = ctx.BASIC; ctx.SALAIRE = ctx.BASIC; ctx.BASE = ctx.BASIC;
    // expose element codes known to 0 by default to avoid ReferenceError in formula; evaluator already zero-fills unknowns
    try{ (getPayElements?.()||[]).forEach(pe=>{ const U=normKey(pe.code); ctx[U]=ctx[U]||0; ctx[safeKey(U)]=ctx[safeKey(U)]||0; }); }catch{}
    return ctx;
  }
  // Compute all other pay elements for the selected employee to allow formulas to reference them (e.g., PINLO, CNSS)
  function computeElementsForEmployee(emp, excludeCode){
    try{
      const all = (getPayElements?.()||[]).filter(pe=> pe && pe.active!==false);
      const idxByKey = new Map();
      all.forEach(pe=>{ if(pe.id) idxByKey.set(String(pe.id), pe); if(pe.code) idxByKey.set(normKey(pe.code), pe); });
      const basic = parseMoney(emp?.employment?.basicSalary||emp?.employment?.salaryBase||emp?.employment?.baseSalary||emp?.employment?.salary||emp?.employment?.basic||emp?.employment?.salaireBase||emp?.employment?.salaire||0);
      // start lines with defaults
  let eLines = all.filter(pe=> String(pe.type||'earning').toLowerCase()==='earning').map(pe=> ({ id: pe.id, code: pe.code, name: pe.name, amount: pe.code && normKey(pe.code)==='BASIC' ? Number(basic||0) : parseMoney(pe.defaultAmount||0) }));
  let dLines = all.filter(pe=> String(pe.type||'deduction').toLowerCase()==='deduction').map(pe=> ({ id: pe.id, code: pe.code, name: pe.name, amount: parseMoney(pe.defaultAmount||0) }));
      const rebuildCtx = ()=>{
        const ctx = { BASIC: Number(basic||0) };
        const earnSum = eLines.reduce((s,e)=> s + ((normKey(e.code)==='BASIC'||normKey(e.code)==='GROSS')?0:(Number(e.amount)||0)), 0);
        const dedSum = dLines.reduce((s,d)=>{ const pe = idxByKey.get(String(d.id)) || idxByKey.get(normKey(d.id)) || idxByKey.get(normKey(d.code)); const who=(pe?.deductFrom)||'employee'; const applies=(who==='employee'||who==='both'); return s + (applies? (Number(d.amount)||0):0); }, 0);
        ctx.EARNINGS_SUM = earnSum; ctx.DEDUCTIONS_SUM = dedSum;
        ctx.GROSS_PRE = Number(basic||0) + earnSum;
        try{ const grossEl = all.find(pe=> pe.code==='GROSS' && pe.valueMode==='formula' && pe.formula); if(grossEl && typeof window.evalFormula==='function'){ const val = Number(window.evalFormula(grossEl.formula, { ...ctx })||0); if(Number.isFinite(val)) ctx.GROSS_PRE = Number(val); } }catch{}
        ctx.NET_PRE = ctx.GROSS_PRE - dedSum;
        // map elements into ctx by code, name, and id variants
        const addAll = (label, val)=>{ const base=String(label||'').trim(); if(!base) return; const U = normKey(base); const DE = normKey(deAccent(base)); ctx[U]=Number(val)||0; ctx[DE]=Number(val)||0; ctx[safeKey(U)]=Number(val)||0; ctx[safeKey(DE)]=Number(val)||0; };
        const addId = (id, val)=>{ if(!id) return; const raw=String(id); const U = normKey(raw); ctx[raw]=Number(val)||0; ctx[U]=Number(val)||0; ctx[safeKey(raw)]=Number(val)||0; ctx[safeKey(U)]=Number(val)||0; };
        eLines.forEach(el=>{ const pe = idxByKey.get(String(el.id)) || idxByKey.get(normKey(el.id)) || idxByKey.get(normKey(el.code)); addAll(el.code, el.amount); addAll(pe?.name||el.name, el.amount); addId(pe?.id||el.id, el.amount); });
        dLines.forEach(dl=>{ const pe = idxByKey.get(String(dl.id)) || idxByKey.get(normKey(dl.id)) || idxByKey.get(normKey(dl.code)); addAll(dl.code, dl.amount); addAll(pe?.name||dl.name, dl.amount); addId(pe?.id||dl.id, dl.amount); });
        return ctx;
      };
      const maxPasses=8; let changed=true; let pass=0;
      while(changed && pass<maxPasses){
        pass++;
        const prevEA = eLines.map(x=>Number(x.amount)||0);
        const prevDA = dLines.map(x=>Number(x.amount)||0);
        const ctx = rebuildCtx();
        eLines = eLines.map(line=>{
          const U = normKey(line.code||'');
          if(U==='BASIC') return line;
          if(U==='GROSS') return { ...line, amount: Math.round((rebuildCtx().GROSS_PRE||0)*100)/100 };
          if(excludeCode && U===normKey(excludeCode)) return line; // avoid self-reference loops
          const pe = idxByKey.get(String(line.id)) || idxByKey.get(normKey(line.id)) || idxByKey.get(normKey(line.code)); if(!pe) return line;
          const vm = String(pe.valueMode||'').toLowerCase();
          if(vm==='percent'){
            let base=0; if(pe.percentBase==='basic') base = Number(basic||0); else if(pe.percentBase==='gross') base = ctx.GROSS_PRE; else if(pe.percentBase==='net') base = ctx.NET_PRE; else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k=pe.percentBaseElement; const nk=normKey(k); const kd=normKey(deAccent(k)); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); base = Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0); }
            return { ...line, amount: Math.round(((parseMoney(pe.defaultPercent||0)/100)*base)*100)/100 };
          } else if(vm==='formula' && pe.formula){
            let amt=0; try{ amt = Number(window.evalFormula ? window.evalFormula(pe.formula, ctx) : 0) || 0; }catch{ amt=0; }
            return { ...line, amount: Math.round(amt*100)/100 };
          }
          return line;
        });
        dLines = dLines.map(line=>{
          const U = normKey(line.code||'');
          if(excludeCode && U===normKey(excludeCode)) return line;
          const pe = idxByKey.get(String(line.id)) || idxByKey.get(normKey(line.id)) || idxByKey.get(normKey(line.code)); if(!pe) return line;
          const vm = String(pe.valueMode||'').toLowerCase();
          if(vm==='percent'){
            let base=0; if(pe.percentBase==='basic') base = Number(basic||0); else if(pe.percentBase==='gross') base = ctx.GROSS_PRE; else if(pe.percentBase==='net') base = ctx.NET_PRE; else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k=pe.percentBaseElement; const nk=normKey(k); const kd=normKey(deAccent(k)); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); base = Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0); }
            return { ...line, amount: Math.round(((parseMoney(pe.defaultPercent||0)/100)*base)*100)/100 };
          } else if(vm==='formula' && pe.formula){
            let amt=0; try{ amt = Number(window.evalFormula ? window.evalFormula(pe.formula, ctx) : 0) || 0; }catch{ amt=0; }
            return { ...line, amount: Math.round(amt*100)/100 };
          }
          return line;
        });
        const newEA = eLines.map(x=>Number(x.amount)||0);
        const newDA = dLines.map(x=>Number(x.amount)||0);
        const same = (a,b)=> a.length===b.length && a.every((v,i)=> Math.abs(v - b[i]) < 1e-9);
        changed = !(same(prevEA,newEA) && same(prevDA,newDA));
      }
      const finalCtx = rebuildCtx();
      return { eLines, dLines, ctx: finalCtx };
    }catch(e){ console.warn('computeElementsForEmployee failed', e); return { eLines:[], dLines:[], ctx:{ BASIC:0, EARNINGS_SUM:0, DEDUCTIONS_SUM:0, GROSS_PRE:0, NET_PRE:0 } }; }
  }
  // Compute the selected employee's payslip template amounts and expose them as context
  function computeTemplateContextForEmployee(emp){
    try{
      const templates = (getTemplates?.()||[]);
      const allPE = (getPayElements?.()||[]).filter(pe=> pe && pe.active!==false);
      const idxTpl = new Map();
      const norm = (s)=> String(s||'').trim().toUpperCase();
      templates.forEach(t=>{ if(!t) return; if(t.id) idxTpl.set(String(t.id), t); const code = norm(t.category||t.code); if(code) idxTpl.set(code, t); });
      const idxPE = new Map();
      allPE.forEach(pe=>{ if(pe.id) idxPE.set(String(pe.id), pe); if(pe.code) idxPE.set(norm(pe.code), pe); });
      const empTplKeyRaw = emp?.employment?.payslipTemplateId || emp?.payslipTemplateId || emp?.employment?.payslipCategory || emp?.employment?.payslipTemplate || emp?.payslipCategory || emp?.payslipTemplate || '';
      const tpl = idxTpl.get(String(empTplKeyRaw)) || idxTpl.get(norm(empTplKeyRaw)) || null;
      const basic = parseMoney(emp?.employment?.basicSalary||emp?.employment?.salaryBase||emp?.employment?.baseSalary||emp?.employment?.salary||emp?.employment?.basic||emp?.employment?.salaireBase||emp?.employment?.salaire||0);
      let eLines = []; let dLines = [];
      if(tpl){
        const mapItem = (item)=>{
          const key = norm(item);
          const pe = idxPE.get(String(item)) || idxPE.get(key) || null;
          const rid = pe? pe.id : item; const code = pe? pe.code : key; const name = pe? pe.name : key;
          const amt = pe && norm(pe.code)==='BASIC' ? Number(basic||0) : parseMoney(pe?.defaultAmount||0);
          return { id: rid, code, name, amount: amt };
        };
        eLines = (tpl.earnings||[]).map(mapItem);
        dLines = (tpl.deductions||[]).map(mapItem);
      }
      const inTemplate = new Set();
      eLines.forEach(e=>{ if(e.id) inTemplate.add(String(e.id)); if(e.code) inTemplate.add(norm(e.code)); });
      dLines.forEach(d=>{ if(d.id) inTemplate.add(String(d.id)); if(d.code) inTemplate.add(norm(d.code)); });
      const addAll = (ctx,label,val)=>{ const base=String(label||'').trim(); if(!base) return; const U=norm(base); const DE=norm(deAccent(base)); ctx[U]=Number(val)||0; ctx[DE]=Number(val)||0; ctx[safeKey(U)]=Number(val)||0; ctx[safeKey(DE)]=Number(val)||0; };
      const addId = (ctx,id,val)=>{ if(!id) return; const raw=String(id); const U=norm(raw); ctx[raw]=Number(val)||0; ctx[U]=Number(val)||0; ctx[safeKey(raw)]=Number(val)||0; ctx[safeKey(U)]=Number(val)||0; };
      const getBase = (ctx, pe)=>{
        if(pe.percentBase==='basic') return Number(basic||0);
        if(pe.percentBase==='gross') return Number(ctx.GROSS_PRE||0);
        if(pe.percentBase==='net') return Number(ctx.NET_PRE||0);
        if(pe.percentBase==='custom' && pe.percentBaseElement){ const k=pe.percentBaseElement; const nk=norm(k); const kd=norm(deAccent(k)); const sk=(s)=> String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); return Number(ctx[k]||ctx[nk]||ctx[kd]||ctx[sk(k)]||ctx[sk(nk)]||ctx[sk(kd)]||0); }
        return 0;
      };
      const rebuildCtx = ()=>{
        const ctx = { BASIC: Number(basic||0) };
        const earnSum = eLines.reduce((s,e)=> s + ((norm(e.code)==='BASIC'||norm(e.code)==='GROSS')?0:(Number(e.amount)||0)), 0);
        const dedSum = dLines.reduce((s,d)=>{ const pe = idxPE.get(String(d.id)) || idxPE.get(norm(d.id)) || idxPE.get(norm(d.code)); const who=(pe?.deductFrom)||'employee'; const applies=(who==='employee'||who==='both'); return s + (applies? (Number(d.amount)||0):0); }, 0);
        ctx.EARNINGS_SUM = earnSum; ctx.DEDUCTIONS_SUM = dedSum; ctx.GROSS_PRE = Number(basic||0) + earnSum; ctx.NET_PRE = ctx.GROSS_PRE - dedSum;
        eLines.forEach(e=>{ const pe = idxPE.get(String(e.id)) || idxPE.get(norm(e.id)) || idxPE.get(norm(e.code)); addAll(ctx, e.code, e.amount); addAll(ctx, pe?.name||e.name, e.amount); addId(ctx, pe?.id||e.id, e.amount); });
        dLines.forEach(d=>{ const pe = idxPE.get(String(d.id)) || idxPE.get(norm(d.id)) || idxPE.get(norm(d.code)); addAll(ctx, d.code, d.amount); addAll(ctx, pe?.name||d.name, d.amount); addId(ctx, pe?.id||d.id, d.amount); });
        // Enrich with other active elements not in template
        allPE.forEach(pe=>{
          if(!pe) return; const keyId=pe.id?String(pe.id):null; const keyCode=pe.code?norm(pe.code):null;
          if((keyId && inTemplate.has(keyId)) || (keyCode && inTemplate.has(keyCode))) return;
          let amt = parseMoney(pe.defaultAmount||0);
          const vm = String(pe.valueMode||'').toLowerCase();
          if(keyCode==='BASIC'){ amt = Number(basic||0); }
          else if(keyCode==='GROSS'){ amt = Number(ctx.GROSS_PRE||0); }
          else if(vm==='percent'){
            const base=getBase(ctx, pe); amt = (parseMoney(pe.defaultPercent||0)/100) * base;
          } else if(vm==='formula' && pe.formula){
            try{ amt = Number(window.evalFormula ? window.evalFormula(pe.formula, ctx) : 0) || 0; }catch{ amt=0; }
          }
          addAll(ctx, pe.code, amt); addAll(ctx, pe.name, amt); addId(ctx, pe.id, amt);
        });
        // Optionally override GROSS from special formula element
        try{ const grossEl = allPE.find(pe=> pe.code==='GROSS' && pe.valueMode==='formula' && pe.formula && pe.active!==false); if(grossEl && typeof window.evalFormula==='function'){ const val = Number(window.evalFormula(grossEl.formula, { ...ctx })||0); if(Number.isFinite(val)) ctx.GROSS_PRE = Number(val); } }catch{}
        ctx.NET_PRE = ctx.GROSS_PRE - dedSum;
        // Seniority and dependents for completeness
        ctx.SENIORITY_YEARS = computeSeniorityYears(emp);
        ctx.EMP_DEPENDENTS = Number(emp?.personal?.dependents||0)||0;
        ctx.SALAIRE_BASE = ctx.BASIC; ctx.SALAIRE = ctx.BASIC; ctx.BASE = ctx.BASIC;
        return ctx;
      };
      const maxPasses=8; let changed=true; let pass=0; while(changed && pass<maxPasses){ pass++; const prevEA=eLines.map(x=>Number(x.amount)||0); const prevDA=dLines.map(x=>Number(x.amount)||0); const ctx=rebuildCtx();
        eLines = eLines.map(line=>{ const pe = idxPE.get(String(line.id)) || idxPE.get(norm(line.id)) || idxPE.get(norm(line.code)); if(!pe) return line; const U=norm(line.code||''); if(U==='BASIC') return line; if(U==='GROSS' && pe.valueMode==='formula' && pe.formula){ let amt=0; try{ amt = Number(window.evalFormula ? window.evalFormula(pe.formula, ctx) : 0) || 0; }catch{ amt=0; } return { ...line, amount: Math.round(amt*100)/100 }; } const vm=String(pe.valueMode||'').toLowerCase(); if(vm==='percent'){ const base=getBase(ctx, pe); return { ...line, amount: Math.round(((parseMoney(pe.defaultPercent||0)/100)*base)*100)/100 }; } else if(vm==='formula' && pe.formula){ let amt=0; try{ amt = Number(window.evalFormula ? window.evalFormula(pe.formula, ctx) : 0) || 0; }catch{ amt=0; } return { ...line, amount: Math.round(amt*100)/100 }; } return line; });
        dLines = dLines.map(line=>{ const pe = idxPE.get(String(line.id)) || idxPE.get(norm(line.id)) || idxPE.get(norm(line.code)); if(!pe) return line; const vm=String(pe.valueMode||'').toLowerCase(); if(vm==='percent'){ const base=getBase(rebuildCtx(), pe); return { ...line, amount: Math.round(((parseMoney(pe.defaultPercent||0)/100)*base)*100)/100 }; } else if(vm==='formula' && pe.formula){ let amt=0; try{ amt = Number(window.evalFormula ? window.evalFormula(pe.formula, rebuildCtx()) : 0) || 0; }catch{ amt=0; } return { ...line, amount: Math.round(amt*100)/100 }; } return line; });
        const newEA=eLines.map(x=>Number(x.amount)||0); const newDA=dLines.map(x=>Number(x.amount)||0); const same=(a,b)=> a.length===b.length && a.every((v,i)=> Math.abs(v-b[i])<1e-9); changed = !(same(prevEA,newEA) && same(prevDA,newDA)); }
      const finalCtx = rebuildCtx();
      return { eLines, dLines, ctx: finalCtx };
    }catch(e){ console.warn('computeTemplateContextForEmployee failed', e); return { eLines:[], dLines:[], ctx:{} }; }
  }
  function computePreview(){
    const sel = wrapper.querySelector('#peTestEmployeeSelect');
    const out = wrapper.querySelector('#peTestResult');
    const ctxDiv = wrapper.querySelector('#peTestContext');
    const statusEl = wrapper.querySelector('#peTestStatus');
    const sanitizedEl = wrapper.querySelector('#peTestSanitized');
    const equationEl = wrapper.querySelector('#peTestEquation');
    const varsTbody = wrapper.querySelector('#peTestVars');
    if(!sel || !out) return;
    const empId = sel.value||'';
    if(!empId){ if(out) out.textContent='—'; if(ctxDiv) ctxDiv.innerHTML=''; return; }
    const emp = (getEmployees?.()||[]).find(e=> (e.employeeId||e.id)===empId);
    if(!emp){ if(out) out.textContent='—'; if(ctxDiv) ctxDiv.innerHTML='<small>Employee not found</small>'; return; }
    const currency = (emp && emp.employment && emp.employment.currency) || null;
    const mode = wrapper.querySelector('#peValueMode')?.value || 'amount';
  const percent = parseMoney(wrapper.querySelector('#pePercent')?.value||0);
    const baseSelVal = wrapper.querySelector('#pePercentBase')?.value || 'basic';
    const formula = String(wrapper.querySelector('#peFormula')?.value||'').trim();
  const amountVal = parseMoney(wrapper.querySelector('#peAmount')?.value||0);
    // Build base ctx and enrich with computed other pay elements for this employee
    let ctx = buildCtx(emp);
    try{
      const currentCode = (wrapper.querySelector('#peCode')?.value||'').trim().toUpperCase();
      const computed = computeElementsForEmployee(emp, currentCode);
      // Merge computed context over base ctx so formulas can see other elements amounts
      ctx = Object.assign({}, ctx, computed.ctx);
      // Overlay amounts from the selected employee's payslip template so that references use the Amount column values
      const tplComputed = computeTemplateContextForEmployee(emp);
      ctx = Object.assign({}, ctx, tplComputed.ctx);
    }catch(e){ console.warn('Preview enrichment failed:', e); }
    let result = 0;
    let sanitized = '';
    let usedTokens = [];
    let valid = true, errMsg = '';
    
    // Debug: log what's being computed
    console.log('📊 computePreview:', { mode, formula, amountVal, percent, baseSelVal });
    
    if(mode==='amount'){
      result = amountVal;
      sanitized = String(amountVal);
      usedTokens = ['BASIC','SENIORITY_YEARS'];
    } else if(mode==='percent'){
      let base = 0;
      let baseLabel = 'BASIC';
      if(baseSelVal==='basic') base = ctx.BASIC;
      else if(baseSelVal==='gross'){ base = ctx.GROSS_PRE; baseLabel='GROSS_PRE'; }
      else if(baseSelVal==='net'){ base = ctx.NET_PRE; baseLabel='NET_PRE'; }
      else if(baseSelVal.startsWith && baseSelVal.startsWith('__pe__:')){
        const code = baseSelVal.substring(7);
        const nk = normKey(code);
        base = Number(ctx[code]||ctx[nk]||ctx[safeKey(code)]||0);
        baseLabel = nk || code;
      }
      result = (percent/100) * base;
      sanitized = `${percent}/100 * ${baseLabel}`;
      usedTokens = ['BASIC','SENIORITY_YEARS'];
    } else if(mode==='formula' && formula){
      sanitized = normalizeFormulaForDisplay(formula);
      try{ 
        result = Number(window.evalFormula ? window.evalFormula(formula, ctx) : evalSafe(formula, ctx)); 
        console.log('✅ Formula evaluated:', formula, '→ result:', result, 'ctx:', ctx);
      }
      catch(e){ 
        valid=false; 
        errMsg=String(e?.message||e); 
        result=0;
        console.warn('❌ Formula eval error:', formula, e);
      }
      // Derive tokens list
      const tokenRe = /[A-Z_][A-Z0-9_]*/g;
      const FN = new Set(['MIN','MAX','ROUND','FLOOR','CEIL','ABS','CLAMP','IF']);
      const RESERVED = new Set(['TRUE','FALSE','NULL','UNDEFINED','NAN','INFINITY']);
      usedTokens = Array.from(new Set((sanitized.match(tokenRe)||[]))).filter(t=> !FN.has(t) && !RESERVED.has(t));
    }
  if(out) out.textContent = (typeof fmtCurrency==='function') ? fmtCurrency(result||0, currency) : String(Math.round((result||0)*100)/100);
  // Only show context if there are usedTokens or in simple modes (percent/amount)
  if(ctxDiv){
    if(mode==='formula' && usedTokens.length > 0){
      // For formulas: show only relevant tokens, formatted appropriately
      const ctxDisplay = usedTokens.slice(0, 3).map(tok=>{
        const val = ctx[tok];
        const fmt = (typeof val==='number') ? ((typeof fmtCurrency==='function' && (tok==='BASIC' || tok.endsWith('_SUM') || tok.endsWith('_PRE'))) ? fmtCurrency(val, currency) : String(val)) : String(val);
        return `<strong>${tok}</strong>: ${fmt}`;
      }).join(' | ');
      ctxDiv.innerHTML = ctxDisplay || '';
    } else {
      // For percent/amount: show BASIC and SENIORITY_YEARS as context
      ctxDiv.innerHTML = `<span><strong>BASIC</strong>: ${typeof fmtCurrency==='function'?fmtCurrency(ctx.BASIC, currency):ctx.BASIC}</span><span> | </span><span><strong>SENIORITY_YEARS</strong>: ${ctx.SENIORITY_YEARS}</span>`;
    }
  }
    if(sanitizedEl){ sanitizedEl.textContent = `Sanitized: ${sanitized || '—'}`; }
    if(statusEl){
      const ok = (mode!=='formula') || (!!sanitized && valid);
      statusEl.textContent = `Status: ${ok ? 'Valid' : 'Invalid'}` + (errMsg? ` (${errMsg})` : '');
      statusEl.style.background = ok ? '#ecfdf5' : '#fef2f2';
      statusEl.style.color = ok ? '#065f46' : '#991b1b';
    }
    // Render Equation line with value substitution
    if(equationEl){
      let numericExpr = sanitized;
      if(sanitized){
        try{
          const tokenRe = /[A-Z_][A-Z0-9_]*/g;
          const FN = new Set(['MIN','MAX','ROUND','FLOOR','CEIL','ABS','CLAMP','IF']);
          const RESERVED = new Set(['TRUE','FALSE','NULL','UNDEFINED','NAN','INFINITY']);
          numericExpr = sanitized.replace(tokenRe, (tok)=>{
            if(FN.has(tok) || RESERVED.has(tok)) return tok;
            const v = ctx[tok];
            if(v === undefined) return tok;
            return (typeof v === 'number') ? String(v) : String(v);
          });
        }catch{}
      }
  const resultText = (typeof fmtCurrency==='function') ? fmtCurrency(result||0, currency) : String(Math.round((result||0)*100)/100);
      const eq = sanitized ? `${sanitized} = ${numericExpr} = ${resultText}` : `${resultText}`;
      equationEl.textContent = `Equation: ${eq}`;
    }

    if(varsTbody){
      if(mode==='formula' && usedTokens.length){
        // Show all tokens used in formula with their values from context
        varsTbody.innerHTML = usedTokens.map(tok=>{
          const val = ctx[tok];
          const v = (typeof val==='number') ? ((typeof fmtCurrency==='function' && (tok==='BASIC' || tok.endsWith('_SUM') || tok.endsWith('_PRE'))) ? fmtCurrency(val, currency) : String(val)) : String(val);
          return `<tr><td style="padding:4px 6px;">${tok}</td><td style=\"padding:4px 6px; text-align:right;\">${v ?? 0}</td></tr>`;
        }).join('');
      } else if(mode==='percent'){
        // For percent mode: show base, percent, and result components
        const base = (baseSelVal==='basic') ? ctx.BASIC : (baseSelVal==='gross') ? ctx.GROSS_PRE : (baseSelVal==='net') ? ctx.NET_PRE : 0;
        const baseLabel = (baseSelVal==='basic') ? 'BASIC' : (baseSelVal==='gross') ? 'GROSS_PRE' : (baseSelVal==='net') ? 'NET_PRE' : 'BASE';
        varsTbody.innerHTML = [
          ['BASIC', ctx.BASIC],
          ['SENIORITY_YEARS', ctx.SENIORITY_YEARS],
          [baseLabel, base],
          ['PERCENT', percent]
        ].map(([tok, val])=>{
          const v = (typeof val==='number') ? ((typeof fmtCurrency==='function' && (tok==='BASIC' || tok.endsWith('_SUM') || tok.endsWith('_PRE'))) ? fmtCurrency(val, currency) : String(val)) : String(val);
          return `<tr><td style="padding:4px 6px;">${tok}</td><td style=\"padding:4px 6px; text-align:right;\">${v ?? 0}</td></tr>`;
        }).join('');
      } else {
        // For amount mode: show BASIC and SENIORITY_YEARS
        varsTbody.innerHTML = ['BASIC','SENIORITY_YEARS'].map(tok=>{
          const val = ctx[tok];
          const v = (typeof val==='number') ? ((tok==='BASIC' && typeof fmtCurrency==='function') ? fmtCurrency(val, currency) : String(val)) : String(val);
          return `<tr><td style="padding:4px 6px;">${tok}</td><td style=\"padding:4px 6px; text-align:right;\">${v ?? 0}</td></tr>`;
        }).join('');
      }
    }
  }
  function wireTester(){
    try{
      const sel = wrapper.querySelector('#peTestEmployeeSelect');
      if(sel && !sel.__populated){
        const emps = (getEmployees?.()||[]);
        sel.innerHTML = ['<option value="">-- Select Employee --</option>'].concat(emps.map(e=>{
          const full = (`${e.personal?.firstName||''} ${e.personal?.lastName||''}`.trim()) || e.contact?.email || e.employeeId || e.id;
          const id = e.employeeId || e.id;
          return `<option value="${id}">${full}</option>`;
        })).join('');
        sel.__populated = true;
      }
      ['#peValueMode','#peAmount','#pePercent','#pePercentBase','#peFormula','#peCode','#peType'].forEach(id=>{
        const el = wrapper.querySelector(id);
        if(el){ 
          el.addEventListener('input', ()=>{ console.log(id, '→ input event'); computePreview(); }); 
          el.addEventListener('change', ()=>{ console.log(id, '→ change event'); computePreview(); }); 
        }
      });
      if(sel){ sel.addEventListener('change', ()=>{ console.log('#peTestEmployeeSelect → change'); computePreview(); }); }
    }catch(e){ console.warn('Wire tester failed', e); }
  }
  setTimeout(()=>{ wireTester(); computePreview(); }, 60);

  
  // Add submission handler
  wrapper.addEventListener('submit', e=>{
    e.preventDefault();
    const arr=getPayElements();
    const editing=wrapper.querySelector('#peEditingId').value;
    const mode = wrapper.querySelector('#peValueMode')?.value || 'amount';
    // Map percent base selection to storage shape (custom vs fixed)
    const baseSelVal = percentBaseSel?.value || 'basic';
    const mapped = { percentBase: 'basic', percentBaseElement: null };
    if(baseSelVal.startsWith('__pe__:')){ mapped.percentBase='custom'; mapped.percentBaseElement=baseSelVal.substring(7); }
    else if(['basic','gross','net'].includes(baseSelVal)){ mapped.percentBase = baseSelVal; }

  // Company mapped percent base
  const cmpMode = cmpModeSel?.value || 'amount';
  const cmpBaseSelVal = cmpPercentBaseSel?.value || 'basic';
  const cmpMapped = { percentBase: 'basic', percentBaseElement: null };
  if(cmpBaseSelVal.startsWith && cmpBaseSelVal.startsWith('__pe__:')){ cmpMapped.percentBase='custom'; cmpMapped.percentBaseElement=cmpBaseSelVal.substring(7); }
  else if(['basic','gross','net'].includes(cmpBaseSelVal)){ cmpMapped.percentBase = cmpBaseSelVal; }

    const payload={
      id: editing || uid(),
      code:wrapper.querySelector('#peCode').value.trim().toUpperCase(),
      name:wrapper.querySelector('#peName').value.trim(),
      type:wrapper.querySelector('#peType').value,
      deductFrom: (wrapper.querySelector('#peType').value==='deduction') ? (wrapper.querySelector('#peDeductFrom')?.value || 'employee') : null,
      defaultAmount: mode==='amount' ? Number(wrapper.querySelector('#peAmount').value||0) : 0,
      defaultPercent: mode==='percent' ? Number(wrapper.querySelector('#pePercent').value||0) : 0,
      valueMode: mode,
      percentBase: mode==='percent' ? mapped.percentBase : null,
      percentBaseElement: mode==='percent' ? mapped.percentBaseElement : null,
      formula: mode==='formula' ? String(formulaInput?.value||'').trim() : null,
      taxable:wrapper.querySelector('#peTaxable').value==='true',
      active:wrapper.querySelector('#peActive').value==='true',
      createdAt:Date.now(),
      updatedAt:Date.now()
    };
    // When deducting from both, persist separate employee/company configs
    if(payload.deductFrom==='both'){
      payload.employeeConfig = {
        valueMode: mode,
        defaultAmount: mode==='amount' ? Number(wrapper.querySelector('#peAmount').value||0) : 0,
        defaultPercent: mode==='percent' ? Number(wrapper.querySelector('#pePercent').value||0) : 0,
        percentBase: mode==='percent' ? mapped.percentBase : null,
        percentBaseElement: mode==='percent' ? mapped.percentBaseElement : null,
        formula: mode==='formula' ? String(formulaInput?.value||'').trim() : null
      };
      payload.companyConfig = {
        valueMode: cmpMode || 'amount',
        defaultAmount: (cmpMode==='amount') ? Number(cmpAmountInput?.value||0) : 0,
        defaultPercent: (cmpMode==='percent') ? Number(wrapper.querySelector('#peCmpPercent')?.value||0) : 0,
        percentBase: (cmpMode==='percent') ? cmpMapped.percentBase : null,
        percentBaseElement: (cmpMode==='percent') ? cmpMapped.percentBaseElement : null,
        formula: (cmpMode==='formula') ? String(cmpFormulaInput?.value||'').trim() : null,
        taxable: (cmpTaxableSel?.value === 'true')
      };
      // For backward compatibility, keep top-level fields mirroring employeeConfig
      payload.valueMode = payload.employeeConfig.valueMode;
      payload.defaultAmount = payload.employeeConfig.defaultAmount;
      payload.defaultPercent = payload.employeeConfig.defaultPercent;
      payload.percentBase = payload.employeeConfig.percentBase;
      payload.percentBaseElement = payload.employeeConfig.percentBaseElement;
      payload.formula = payload.employeeConfig.formula;
    }
    const idx=arr.findIndex(p=>p.id===payload.id);
    if(idx>=0) arr[idx]=payload;
    else arr.push(payload);
    savePayElements(arr);
    entityModalBackdrop.style.display='none';
    renderPayElements();
    renderTemplates();
    reloadTemplateSelect();
    alert('Pay element saved.');
  });
  
  return wrapper;
}

function buildTemplateForm(){
  const wrapper=document.createElement('form');
  wrapper.id='templateModalForm';
  wrapper.className='grid cols-4';
  wrapper.innerHTML = $('#templateForm')?.innerHTML || '';
  
  // Inject Employee Preview Section (selector + table)
  try {
    const previewSection = document.createElement('div');
    previewSection.id = 'tplEmpPreviewSection';
    previewSection.style.gridColumn = '1 / -1';
    previewSection.style.marginTop = '10px';
    previewSection.innerHTML = `
      <div style="border-top:1px dashed #e2e8f0; padding-top:10px;">
        <h4 style="margin:0 0 8px; font-size:.85rem; color:#334155; display:flex; align-items:center; gap:8px;"><i class="fas fa-user-check"></i> Employee pay elements preview</h4>
        <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
          <label style="min-width:260px;">Employee<select id="tplEmpPreviewSelect"><option value="">-- Select Employee --</option></select></label>
          <small style="color:#64748b;">Pick an employee to preview computed amounts for the currently selected template elements.</small>
        </div>
        <div id="tplEmpPreviewWrap" style="margin-top:10px; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden;">
          <table id="tplEmpPreviewTable" style="width:100%; border-collapse:collapse; font-size:.78rem;">
            <thead style="background:#f8fafc;">
              <tr>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0; width:12%;">Type</th>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0; width:14%;">Code</th>
                <th style="text-align:left; padding:6px 8px; border-bottom:1px solid #e2e8f0;">Description</th>
                <th style="text-align:right; padding:6px 8px; border-bottom:1px solid #e2e8f0; width:18%;">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" style="text-align:center; color:#7a858f; padding:10px;">Select an employee to preview amounts.</td></tr>
            </tbody>
          </table>
        </div>
      </div>`;
    wrapper.appendChild(previewSection);
  } catch(e){ console.warn('Failed to add template employee preview section', e); }

  function normKey(s){ return String(s||'').trim().toUpperCase(); }
  function safeKey(s){ return String(s||'').toUpperCase().replace(/[^A-Z0-9_]/g,'_'); }
  // Local evaluator uses global evalFormula if available
  const evalSafe = (f, ctx)=> {
    try { if(typeof window.evalFormula === 'function') return Number(window.evalFormula(f, ctx)||0); } catch {}
    // Fallback to simple zero if global not present
    return 0;
  };
  function computeSeniorityYears(emp){
    try{
      if(emp?.employment?.seniorityYears != null && emp.employment.seniorityYears !== ''){
        return Number(emp.employment.seniorityYears)||0;
      }
      const s = emp?.employment?.seniorityDate || emp?.employment?.seniority || emp?.personal?.seniorityDate || '';
      if(!s) return 0;
      if(typeof window.calcYearsFromDateStr === 'function') return Number(window.calcYearsFromDateStr(s)||0);
      const d = new Date(s);
      if(isNaN(d.getTime())) return 0;
      const now = new Date();
      let years = now.getFullYear() - d.getFullYear();
      const anniv = new Date(now.getFullYear(), d.getMonth(), d.getDate());
      if(now < anniv) years -= 1;
      return Number.isFinite(years) && years>0 ? years : 0;
    }catch{return 0;}
  }
  function computeFor(emp, earnIds, dedIds){
    // Build element indexes
    const all = getPayElements()||[];
    const byId = new Map(all.map(p=>[p.id, p]));
    const byCode = new Map(all.map(p=>[normKey(p.code), p]));
    const getPE = (k)=> byId.get(k) || byCode.get(normKey(k)) || null;
    // Build initial lines
    let eLines = (earnIds||[]).map(key=>{ const pe=getPE(key); const rid=pe?pe.id:key; return { id: rid, code: pe?pe.code:normKey(key), name: pe?pe.name:normKey(key), amount: pe?Number(pe.defaultAmount||0):0, __type:'earning' }; });
    let dLines = (dedIds||[]).map(key=>{ const pe=getPE(key); const rid=pe?pe.id:key; return { id: rid, code: pe?pe.code:normKey(key), name: pe?pe.name:normKey(key), amount: pe?Number(pe.defaultAmount||0):0, __type:'deduction' }; });
  const parseMoney = (v)=>{ if(v==null) return 0; if(typeof v==='number') return Number.isFinite(v)?v:0; let s=String(v); s=s.replace(/[\u00A0\u202F\u2000-\u200A]/g,' '); s=s.replace(/(\d)\s+(?=\d)/g,'$1'); s=s.replace(/[^0-9,.-]/g,''); if(s.includes(',')&&s.includes('.')) s=s.replace(/,/g,''); else s=s.replace(/,/g,'.'); s=s.replace(/\s+/g,''); const n=Number(s); return Number.isFinite(n)?n:0; };
  const basic = parseMoney(emp?.employment?.basicSalary||0);
    // Iterate to resolve dependencies
    const ITER = 3;
    const rebuild = ()=>{
  const ctx = { BASIC: basic };
      // Pre-sums excluding BASIC and GROSS special codes
      const earnSum = eLines.reduce((s,e)=> s + ((normKey(e.code)==='BASIC'||normKey(e.code)==='GROSS')?0:(Number(e.amount)||0)), 0);
      // Only employee-borne deductions reduce NET_PRE
      const dedSum = dLines.reduce((s,d)=>{ const pe=getPE(d.id); const who=(pe?.deductFrom)||'employee'; const applies=(who==='employee'||who==='both'); return s + (applies? (Number(d.amount)||0):0); }, 0);
      ctx.EARNINGS_SUM = earnSum; ctx.DEDUCTIONS_SUM = dedSum;
      ctx.GROSS_PRE = basic + earnSum;
      // Optional GROSS override element (force global evaluator)
      try{
        const grossEl = all.find(p=> p.code==='GROSS' && p.valueMode==='formula' && p.formula && p.active!==false);
        if(grossEl && typeof window.evalFormula==='function'){
          const v = Number(window.evalFormula(grossEl.formula, { ...ctx })||0);
          if(Number.isFinite(v)) ctx.GROSS_PRE = Number(v);
        }
      }catch(e){ console.warn('GROSS formula eval failed in preview', e); }
      ctx.NET_PRE = ctx.GROSS_PRE - dedSum;
      // Element code exposures
      eLines.forEach(e=>{ const U=normKey(e.code); ctx[U]=Number(e.amount)||0; ctx[safeKey(U)]=Number(e.amount)||0; });
      dLines.forEach(d=>{ const U=normKey(d.code); ctx[U]=Number(d.amount)||0; ctx[safeKey(U)]=Number(d.amount)||0; });
  // Seniority and dependents
  ctx.SENIORITY_YEARS = computeSeniorityYears(emp);
  try{ ctx.EMP_DEPENDENTS = Number(emp?.personal?.dependents || 0) || 0; }catch{ ctx.EMP_DEPENDENTS = 0; }
      // Helpful aliases
      ctx.SALAIRE_BASE = ctx.BASIC; ctx.SALAIRE = ctx.BASIC; ctx.BASE = ctx.BASIC;
      ctx.EARNINGS_TOTAL = ctx.EARNINGS_SUM; ctx.DEDUCTIONS_TOTAL = ctx.DEDUCTIONS_SUM;
      ctx.GROSS = ctx.GROSS_PRE; ctx.NET = ctx.NET_PRE;
      return ctx;
    };
    for(let i=0;i<ITER;i++){
      const ctx = rebuild();
      const mapLine = (line)=>{
  const pe = getPE(line.id); if(!pe) return line;
        if(pe.valueMode==='percent'){
          let base=0;
          if(pe.percentBase==='basic') base = basic;
          else if(pe.percentBase==='gross') base = ctx.GROSS_PRE;
          else if(pe.percentBase==='net') base = ctx.NET_PRE;
          else if(pe.percentBase==='custom' && pe.percentBaseElement){ const k=pe.percentBaseElement; const nk=normKey(k); base = Number(ctx[k]||ctx[nk]||ctx[safeKey(k)]||ctx[safeKey(nk)]||0); }
          const amt = (Number(pe.defaultPercent||0)/100) * base;
          return { ...line, amount: Math.round(amt*100)/100 };
        } else if(pe.valueMode==='formula' && pe.formula){
          let amt = 0;
          try{
            if(typeof window.evalFormula==='function'){
              amt = Number(window.evalFormula(pe.formula, ctx)||0);
            }
          }catch(e){ console.warn('Formula eval failed for', pe.code, pe.formula, e); amt=0; }
          // Debug trace: show how this line evaluated
          try{ console.log('[Template Employee Preview] Eval', pe.code, 'formula:', pe.formula, 'amount:', amt, 'ctx keys:', Object.keys(ctx)); }catch{}
          return { ...line, amount: Math.round(Number(amt||0)*100)/100 };
        }
        return line;
      };
      eLines = eLines.map(mapLine);
      dLines = dLines.map(mapLine);
    }
    return { eLines, dLines };
  }

  function renderEmpPreview(){
    try{
      const sel = wrapper.querySelector('#tplEmpPreviewSelect');
      const tbody = wrapper.querySelector('#tplEmpPreviewTable tbody');
      if(!sel || !tbody) return;
      const empId = sel.value || '';
      if(!empId){ tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#7a858f; padding:10px;">Select an employee to preview amounts.</td></tr>'; return; }
      const emp = (getEmployees()||[]).find(e=> (e.employeeId||e.id)===empId);
      if(!emp){ tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#7a858f; padding:10px;">Employee not found.</td></tr>'; return; }
      const earnIds = [...wrapper.querySelectorAll('#tplEarnings input:checked')].map(cb=>cb.dataset.pe);
      const dedIds = [...wrapper.querySelectorAll('#tplDeductions input:checked')].map(cb=>cb.dataset.pe);
      if(!earnIds.length && !dedIds.length){ tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#7a858f; padding:10px;">No template elements selected.</td></tr>'; return; }
      const { eLines, dLines } = computeFor(emp, earnIds, dedIds);
      const rows = [];
      eLines.forEach(l=> rows.push({ ...l, __type:'Earning' }));
      dLines.forEach(l=> rows.push({ ...l, __type:'Deduction' }));
      if(!rows.length){ tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#7a858f; padding:10px;">Nothing to show.</td></tr>'; return; }
      const __cur = (emp && emp.employment && emp.employment.currency) || null;
      tbody.innerHTML = rows.map(r=>`<tr>
        <td style="padding:6px 8px; color:${r.__type==='Earning'?'#166534':'#991b1b'}; font-weight:600;">${r.__type}</td>
        <td style="padding:6px 8px;"><span class="pill ${r.__type==='Earning'?'pill-earn':'pill-ded'}">${r.code}</span></td>
        <td style="padding:6px 8px;">${r.name||''}</td>
        <td style="padding:6px 8px; text-align:right;" class="amount-cell">${fmtCurrency(r.amount||0, __cur)}</td>
      </tr>`).join('');
    }catch(e){ console.warn('Preview render failed', e); }
  }

  function wireEmpPreview(){
    try{
      const sel = wrapper.querySelector('#tplEmpPreviewSelect');
      const earnDiv = wrapper.querySelector('#tplEarnings');
      const dedDiv = wrapper.querySelector('#tplDeductions');
      if(!sel || !earnDiv || !dedDiv){ setTimeout(wireEmpPreview, 80); return; }
      // Populate employees once
      if(!sel.__populated){
        const emps = (getEmployees()||[]);
        const options = ['<option value="">-- Select Employee --</option>'].concat(emps.map(e=>{
          const full = (`${e.personal?.firstName||''} ${e.personal?.lastName||''}`.trim()) || e.contact?.email || e.employeeId || e.id;
          const id = e.employeeId || e.id;
          return `<option value="${id}">${full}</option>`;
        }));
        sel.innerHTML = options.join('');
        sel.__populated = true;
      }
      // Listen to changes
      sel.addEventListener('change', renderEmpPreview);
      earnDiv.addEventListener('change', (ev)=>{ if(ev.target && ev.target.matches('input[type="checkbox"]')) renderEmpPreview(); });
      dedDiv.addEventListener('change', (ev)=>{ if(ev.target && ev.target.matches('input[type="checkbox"]')) renderEmpPreview(); });
      // Trigger initial render after wiring
      renderEmpPreview();
    }catch(e){ console.warn('Wire preview failed', e); }
  }
  // Wire after a short delay to ensure element selectors are present/populated
  setTimeout(wireEmpPreview, 100);
  // Re-render whenever the modal is shown (dynamic feedback as user checks/unchecks elements)
  const observer = new MutationObserver(()=>{ if(wrapper.style.display !== 'none') renderEmpPreview(); });
  observer.observe(wrapper, { attributes: true, attributeFilter: ['style'] });
  
  // Add submission handler
  wrapper.addEventListener('submit', e=>{
    e.preventDefault();
    const earnings=[...wrapper.querySelector('#tplEarnings').querySelectorAll('input:checked')].map(cb=>cb.dataset.pe);
    const deductions=[...wrapper.querySelector('#tplDeductions').querySelectorAll('input:checked')].map(cb=>cb.dataset.pe);
    const editing=wrapper.querySelector('#tplEditingId').value;
    const existing = editing ? getTemplates().find(t=>t.id===editing) : null;
    const now=Date.now();
    const payload={
      id: editing || uid(),
      category:wrapper.querySelector('#tplCode').value.trim().toUpperCase(),
      code:wrapper.querySelector('#tplCode').value.trim().toUpperCase(),
      name:wrapper.querySelector('#tplName').value.trim(),
      description:wrapper.querySelector('#tplDesc').value.trim()||'',
      earnings,
      deductions,
      createdAt: existing? existing.createdAt : now,
      updatedAt: now
    };
    console.log('💾 Saving template:', payload.id, 'with code:', payload.code, 'earnings:', earnings.length, 'deductions:', deductions.length);
    saveTemplate(payload);
    entityModalBackdrop.style.display='none';
    alert('Template saved.');
  });
  
  return wrapper;
}


/**************** Reactivity to External Changes *****************/
window.addEventListener('payroll:templates:changed',()=>{ renderTemplates(); reloadTemplateSelect(); });
window.addEventListener('payroll:payElements:changed',()=>{ renderPayElements(); renderTemplateElementSelectors(); });
window.addEventListener('payroll:runs:changed',()=>{ renderRuns(); });

/**************** Sidebar Toggle *****************/
$('#sidebarToggle').addEventListener('click', ()=> {
    const sidebar = $('#sidebar');
    const mainContent = $('#mainContent');
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('sidebar-collapsed');
});

/**************** Profile Dropdown *****************/
const userProfileBtn = $('#userProfileBtn');
const profileDropdown = userProfileBtn?.nextElementSibling;
if(userProfileBtn && profileDropdown) {
    userProfileBtn.addEventListener('click', (e)=> {
        e.stopPropagation();
        profileDropdown.classList.toggle('show');
    });
    document.addEventListener('click', ()=> profileDropdown.classList.remove('show'));
    profileDropdown.addEventListener('click', (e)=> e.stopPropagation());
}

/**************** Notification Dropdown *****************/
const notificationBtn = $('#notificationBtn');
const notificationDropdown = document.querySelector('.notification-dropdown');
if(notificationBtn && notificationDropdown) {
    notificationBtn.addEventListener('click', (e)=> {
        e.stopPropagation();
        notificationDropdown.classList.toggle('show');
    });
    document.addEventListener('click', ()=> notificationDropdown.classList.remove('show'));
    notificationDropdown.addEventListener('click', (e)=> e.stopPropagation());
}

/**************** Load User Profile *****************/
function loadUserProfile() {
    if(!currentUser) {
        window.location.href='login.html';
        return;
    }
    const userRef = firebase.database().ref('users/'+currentUser.uid);
    userRef.once('value').then(snap=>{
        const data = snap.val();
        if(!data) return;
        const displayName = data.displayName || currentUser.email?.split('@')[0] || 'User';
        const photoURL = data.photoURL || '';
        const profileBtn = $('#userProfileBtn img');
        if(profileBtn) {
            if(photoURL) {
                profileBtn.src = photoURL;
            } else {
                profileBtn.src = 'data:image/svg+xml;base64,'+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><circle cx="20" cy="20" r="20" fill="#3b82f6"/><text x="20" y="26" text-anchor="middle" fill="white" font-size="16" font-family="sans-serif" font-weight="600">'+displayName.charAt(0).toUpperCase()+'</text></svg>');
            }
        }
        const profileDropdown = document.querySelector('.profile-dropdown ul');
        if(profileDropdown) {
            profileDropdown.innerHTML = `
                <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
                <li><a href="account.html"><i class="fas fa-cog"></i> Account Settings</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            `;
            const logoutBtn = document.querySelector('#logoutBtn');
            if(logoutBtn) {
                logoutBtn.addEventListener('click', (e)=>{
                    e.preventDefault();
                    firebase.auth().signOut().then(()=>{
                        window.location.href='login.html';
                    });
                });
            }
        }
    });
}
loadUserProfile();

/**************** Load Company Branding *****************/
function loadCompanyBranding() {
    if(!companyId) return;
    const compRef = firebase.database().ref('companies/'+companyId);
    compRef.once('value').then(snap=>{
        const comp = snap.val();
        if(!comp) return;
        const headerCompanyName = $('#headerCompanyName');
        const headerCompanyLogo = $('#headerCompanyLogo');
        if(headerCompanyName) headerCompanyName.textContent = comp.name || '';
        if(headerCompanyLogo && comp.logo) {
            headerCompanyLogo.src = comp.logo;
            headerCompanyLogo.style.display = 'block';
        } else if(headerCompanyLogo) {
            headerCompanyLogo.style.display = 'none';
        }
        if(comp.primaryColor) {
            document.documentElement.style.setProperty('--primary-color', comp.primaryColor);
        }
        if(comp.secondaryColor) {
            document.documentElement.style.setProperty('--secondary-color', comp.secondaryColor);
        }
    });
}
loadCompanyBranding();

/**************** Menu Permissions (Simplified) *****************/
const sidebar = $('#sidebar');
if(sidebar) {
    setTimeout(()=> sidebar.classList.remove('menu-loading'), 500);
}

/**************** Initialize Firebase Data *****************/
async function initializePayrollData() {
  console.log('🔄 Loading payroll data from Firebase...');
  
  // Wait a bit for auth to initialize
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  if(!db || !companyId) {
    console.warn('⚠️ No database or company ID - using local data only');
    return;
  }
  
  try {
    // Load all payroll data from Firebase
    await Promise.all([
      loadEmployeesFromFirebase(),
      loadRunsFromFirebase()
    ]);
    // Attach real-time listeners
    attachPayElementsListener();
    attachTemplatesListener();
  attachRulesListener();
    attachCompanySettingsListener();
    
    console.log('✅ Payroll data loaded from Firebase');
  } catch(error) {
    console.error('❌ Error loading payroll data:', error);
  }
}

// Initialize data on page load
setTimeout(initializePayrollData, 1000);

// Wire Settings UI events after DOM is ready (elements are present now)
setTimeout(()=>{
  // Initial render from local cache
  try { renderCompanySettingsForm(); } catch(e) {}
  // Modal open/close handlers for Bank Account
  const openBaBtn = document.getElementById('btnOpenBankAccountModal');
  const baBackdrop = document.getElementById('bankAccountModalBackdrop');
  const closeBaBtn = document.getElementById('closeBankAccountModal');
  function openBankAccountModal(){ if(baBackdrop) baBackdrop.style.display='block'; }
  function closeBankAccountModal(){ if(baBackdrop) baBackdrop.style.display='none'; }
  if(openBaBtn){ openBaBtn.addEventListener('click', openBankAccountModal); }
  if(closeBaBtn){ closeBaBtn.addEventListener('click', closeBankAccountModal); }
  if(baBackdrop){ baBackdrop.addEventListener('click', (e)=>{ if(e.target===baBackdrop) closeBankAccountModal(); }); }
  const addBtn = document.getElementById('btnAddBankAccount');
  if(addBtn){
    addBtn.addEventListener('click', ()=>{
      const val = id => (document.getElementById(id)?.value || '').trim();
      const acc = {
        id: uid(),
        bankName: val('baBankName'),
        accountName: val('baAccountName'),
        accountNumber: val('baAccountNumber'),
        iban: val('baIban'),
        swift: val('baSwift'),
        accountType: val('baAccountType'),
        currency: val('baCurrency'),
        branch: val('baBranch'),
        routing: val('baRouting'),
        bankCode: val('baBankCode'),
        branchCode: val('baBranchCode'),
        country: val('baCountry'),
        usage: val('baUsage') || 'Payroll',
        isDefault: !!document.getElementById('baIsDefault')?.checked
      };
      if(!acc.bankName || (!acc.accountNumber && !acc.iban)){
        alert('Please provide Bank Name and at least one of Account Number or IBAN');
        return;
      }
      // If setting as default, unset others
      if(acc.isDefault){ COMPANY_BANK_ACCOUNTS.forEach(a=> a.isDefault = false); }
      COMPANY_BANK_ACCOUNTS.push(acc);
      // Clear inline fields
      ['baBankName','baAccountName','baAccountNumber','baIban','baSwift','baAccountType','baCurrency','baBranch','baRouting','baBankCode','baBranchCode','baCountry','baUsage','baIsDefault'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.tagName==='SELECT'){ el.selectedIndex = 0; } else if(el.type==='checkbox'){ el.checked = false; } else { el.value=''; } });
      renderBankAccountsTable();
      // Close modal after adding
      try { closeBankAccountModal(); } catch(e) {}
    });
  }
  const saveBtn = document.getElementById('btnSaveSettings');
  if(saveBtn){ saveBtn.addEventListener('click', ()=>{ const payload = collectCompanySettingsFromForm(); saveCompanySettingsToFirebase(payload); }); }
  const resetBtn = document.getElementById('btnResetSettings');
  if(resetBtn){ resetBtn.addEventListener('click', ()=>{ renderCompanySettingsForm(); }); }
}, 1200);

</script>
    </main>
</div>
</body>
</html>