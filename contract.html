<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#2c3e50">
    <meta name="description" content="Employee Contract Management - Dreamex Datalab HSE Management System">
    <meta name="keywords" content="contract management, employee contracts, HSE, Dreamex Datalab">
    <title>Employee Contracts - Dreamex Datalab HSE</title>
    
    <!-- Firebase v8 CDN for compatibility (Head Section) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        // Firebase Configuration for Compat SDK
        const firebaseConfig = {
            apiKey: "AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc",
            authDomain: "users-8be65.firebaseapp.com",
            databaseURL: "https://users-8be65-default-rtdb.firebaseio.com",
            projectId: "users-8be65",
            storageBucket: "users-8be65.firebasestorage.app",
            messagingSenderId: "829083030831",
            appId: "1:829083030831:web:36a370e62691e560bc3dda"
        };

        // Initialize Firebase if not already initialized
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        // Initialize Firebase services
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        console.log('🔥 Firebase services initialized in head:', {
            auth: !!auth,
            database: !!database,
            storage: !!storage
        });
    </script>
    
    <!-- External CSS Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Local CSS Dependencies -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/modal.css">
    <link rel="stylesheet" href="css/modal-styles.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    
    <style>
        /* Essential Layout Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #333333;
            background: #f8f9fa;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 1rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar .logo {
            padding: 1rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1rem;
        }

        .sidebar .logo h2 {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .sidebar .menu {
            list-style: none;
        }

        .sidebar .menu li {
            margin-bottom: 0.5rem;
        }

        .sidebar .menu a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 0.8rem 1rem;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .sidebar .menu a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar .menu a i {
            margin-right: 0.8rem;
            width: 16px;
            text-align: center;
        }

        .sidebar .submenu {
            list-style: none;
            padding-left: 1rem;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sidebar .menu-dropdown:hover .submenu,
        .sidebar .menu-dropdown.open .submenu {
            max-height: 500px;
        }

        .sidebar .submenu a {
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            min-height: 100vh;
            background: #f8f9fa;
        }

        /* Top Navigation */
        .top-nav {
            background: white;
            padding: 0.8rem 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 999;
        }

        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .sidebar-toggle-btn:hover {
            background: #f0f0f0;
        }

        .top-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notifications {
            position: relative;
        }

        .notification-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            position: relative;
        }

        .notification-btn:hover {
            background: #f0f0f0;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #e74c3c;
            color: white;
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 50px;
        }

        .profile-btn:hover {
            background: #f0f0f0;
        }

        .profile-btn img,
        .avatar-initials {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .profile-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 180px;
            z-index: 1000;
            display: none;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 0.5rem 0;
        }

        .profile-dropdown li {
            padding: 0;
        }

        .profile-dropdown a {
            display: block;
            padding: 0.8rem 1rem;
            color: #333;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .profile-dropdown a:hover {
            background: #f8f9fa;
        }

        .profile-dropdown a i {
            margin-right: 0.8rem;
            width: 16px;
            text-align: center;
        }

        /* Header Company Branding */
        .header-company-logo {
            max-height: 32px;
            width: auto;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .company-name-header {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        /* Notification dropdown */
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 300px;
            z-index: 1000;
            display: none;
        }

        .notification-dropdown.show {
            display: block;
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1rem;
            color: #333;
        }

        .mark-all-read {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .notification-list {
            max-height: 300px;
            overflow-y: auto;
        }

        /* Content Area */
        .content {
            padding: 1.5rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }

        /* CSS Variables for gradient colors */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --text-color: #333;
            --bg-color: #f5f6fa;
        }

        /* Contract specific styles */
        .contract-container {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        /* Override the default content padding for full width */
        .content {
            padding: 0 !important;
            margin: 0 !important;
            background: none !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        /* Add back some minimal padding only to the inner content */
        .page-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.25rem;
            box-shadow: 0 18px 54px rgba(0,0,0,0.22), 0 10px 28px rgba(0,0,0,0.16), 0 5px 14px rgba(0,0,0,0.12);
            margin-bottom: 2rem;
            margin: 0 2rem 2rem 2rem;
            transition: box-shadow 0.3s ease;
        }

        .page-header:hover {
            box-shadow: 0 22px 66px rgba(0,0,0,0.28), 0 14px 36px rgba(0,0,0,0.20), 0 7px 18px rgba(0,0,0,0.15);
        }

        .page-title {
            font-size: 2rem;
            color: white;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .page-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
        }

        .header-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            margin-bottom: 0.5rem;
        }

        .header-left {
            flex: 1;
        }

        .header-right {
            flex-shrink: 0;
        }

        /* Professional stats cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin: 0 2rem 1.5rem 2rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .stat-card .stat-number {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.25rem;
            line-height: 1;
            background: none;
            padding: 0;
            border-radius: 0;
        }

        .stat-card div:last-child {
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
            line-height: 1.2;
        }

        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin: 0;
            padding: 0;
            border: none;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .stat-number {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0;
            font-size: 0.9rem;
            font-weight: 600;
        }        /* Tab Layout Styles */
        .content-tabs {
            margin: 0 2rem;
            width: calc(100% - 4rem);
        }

        .tab-navigation {
            display: flex;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 0;
            border-bottom: 1px solid #e9ecef;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        .tab-nav-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: none;
            color: #6c757d;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            position: relative;
            transition: all 0.2s;
            border-radius: 0;
        }

        .tab-nav-btn:hover {
            color: var(--primary-color);
            background: #f8f9fa;
        }

        .tab-nav-btn.active {
            color: #ffffff;
            background: var(--primary-color);
        }

        .tab-content {
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            display: none;
        }

        .tab-content.active {
            display: block;
        }        /* Contract Table Styles */
        .contracts-table-container {
            background: none;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            margin-top: 1rem;
        }

        .tab-controls {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }        .table-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .contracts-table {
            width: 100%;
            border-collapse: collapse;
        }

        .contracts-table th,
        .contracts-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .contracts-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .contracts-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .contracts-table tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.75rem;
        }

        .employee-info {
            display: flex;
            align-items: center;
        }

        .employee-details {
            flex: 1;
        }

        .employee-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .employee-id {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-declined {
            background: #f5c6cb;
            color: #721c24;
        }        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .completed {
            background: #d4edda;
            color: #155724;
        }

        .status-terminated {
            background: #f8d7da;
            color: #721c24;
        }

        .contract-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
            background: #e9ecef;
            color: #495057;
        }

        .contract-permanent {
            background: #d1ecf1;
            color: #0c5460;
        }

        .contract-fixed {
            background: #ffeaa7;
            color: #b8860b;
        }

        .contract-part-time {
            background: #ddd6fe;
            color: #6b46c1;
        }

        .contract-internship {
            background: #fed7e2;
            color: #b83280;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-action {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-view {
            background: #007bff;
            color: white;
        }

        .btn-view:hover {
            background: #0056b3;
        }

        .btn-edit {
            background: #28a745;
            color: white;
        }

        .btn-edit:hover {
            background: #1e7e34;
        }        .btn-download {
            background: #6c757d;
            color: white;
        }

        .btn-download:hover {
            background: #545b62;
        }        .btn-mail {
            background: #fd7e14;
            color: white;
        }

        .btn-mail:hover {
            background: #e66100;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-approve:hover {
            background: #1e7e34;
        }

        .btn-decline {
            background: #dc3545;
            color: white;
        }

        .btn-decline:hover {
            background: #c82333;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        /* Tab Controls */
        .tab-controls {
            margin-bottom: 1.5rem;
        }

        .search-export-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }

        /* Contract Modal Styles */
        .contract-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        .contract-modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .contract-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem 1rem 2rem;
            border-bottom: 1px solid #dee2e6;
            flex-shrink: 0;
            background: white;
        }

        .contract-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 2rem;
            min-height: 0; /* Important for flex scrolling */
        }

        .contract-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-modal:hover {
            color: #dc3545;
            background: #f8f9fa;
        }

        .contract-info-section {
            margin-bottom: 2rem;
        }

        .contract-info-section h4 {
            color: #2c3e50;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .contract-info-item {
            display: flex;
            margin-bottom: 0.75rem;
            align-items: flex-start;
        }

        .contract-info-label {
            font-weight: 600;
            color: #495057;
            min-width: 150px;
            flex-shrink: 0;
        }        .contract-info-value {
            color: #2c3e50;
            flex: 1;
        }

        /* Modal Footer Styling - Matching staff.html exactly */
        .modal-footer {
            padding: 1rem 2rem 1.5rem 2rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 0.85rem;
            align-items: center;
            flex-wrap: wrap;
            justify-content: flex-end;
            background: rgba(255, 255, 255, 0.95);
            flex-shrink: 0;
            z-index: 2;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
        }

        .modal-footer .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            min-width: 2.5rem;
            min-height: 2.5rem;
            justify-content: center;
        }

        /* Icon-only buttons get square styling */
        .modal-footer .btn:not(:has(span)):not(:has(div)) {
            padding: 0.4rem;
            border-radius: 6px;
            width: 2.25rem;
            height: 2.25rem;
        }

        .modal-footer .btn i {
            font-size: 0.875rem;
        }

        .modal-footer .btn-secondary {
            background-color: transparent;
            color: #6b7280;
            border: none;
            box-shadow: none;
        }

        .modal-footer .btn-secondary:hover {
            background-color: #f9fafb;
            color: #374151;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .modal-footer .btn-primary {
            background-color: transparent;
            color: #3b82f6;
            border: none;
            box-shadow: none;
        }

        .modal-footer .btn-primary:hover {
            background-color: #dbeafe;
            color: #2563eb;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .modal-footer .btn-warning {
            background-color: transparent;
            color: #f59e0b;
            border: none;
            box-shadow: none;
        }

        .modal-footer .btn-warning:hover {
            background-color: #fef3c7;
            color: #d97706;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .modal-footer .btn-success {
            background-color: transparent;
            color: #10b981;
            border: none;
            box-shadow: none;
        }

        .modal-footer .btn-success:hover {
            background-color: #d1fae5;
            color: #059669;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .modal-footer .btn-danger {
            background-color: transparent;
            color: #ef4444;
            border: none;
            box-shadow: none;
        }

        .modal-footer .btn-danger:hover {
            background-color: #fee2e2;
            color: #dc2626;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .modal-footer .btn-info {
            background-color: transparent;
            color: #3b82f6;
            border: none;
            box-shadow: none;
        }

        .modal-footer .btn-info:hover {
            background-color: #dbeafe;
            color: #2563eb;
            border: none;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Button permission styles */
        .modal-footer .btn.permission-hidden {
            display: none !important;
        }

        .modal-footer .btn.permission-visible {
            display: inline-flex !important;
        }

        /* Permission-based button visibility classes */
        .modal-footer.view-only .btn:not([onclick*="closeContractModal"]):not([onclick*="downloadContract"]):not([onclick*="emailContract"]) {
            display: none !important;
        }

        /* Approved contracts - hide all action buttons */
        .modal-footer.approved .btn:not([onclick*="closeContractModal"]):not([onclick*="downloadContract"]):not([onclick*="emailContract"]) {
            display: none !important;
        }

        .modal-footer.approved {
            background-color: #f8f9fa;
            border-top: 2px solid #28a745;
        }

        .modal-footer.approver-mode .btn[onclick*="editContract"],
        .modal-footer.approver-mode .btn[onclick*="deleteContract"] {
            display: none !important;
        }

        .modal-footer.creator-mode .btn[onclick*="approveContract"],
        .modal-footer.creator-mode .btn[onclick*="declineContract"] {
            display: none !important;
        }

        /* Loading state for permissions */
        .modal-footer.permissions-loading .btn {
            opacity: 0.5;
            pointer-events: none;
        }

        .modal-footer.permissions-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid #007bff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Approval Flow Styles - Updated to match staff.html */
        .approval-flow-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .approval-flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .approval-flow-title {
            color: #007bff;
            font-weight: 700;
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .approval-flow-status {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .approval-flow-status.enabled {
            background: #d4edda;
            color: #155724;
        }

        .approval-flow-status.disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .approval-stages {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .approval-stage {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            position: relative;
        }

        .approval-stage:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 25px;
            width: 2px;
            height: 0.5rem;
            background: #dee2e6;
        }

        .stage-number {
            width: 35px;
            height: 35px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .stage-number.completed {
            background: #28a745;
        }

        .stage-number.pending {
            background: #ffc107;
            color: #000;
        }

        .stage-number.rejected {
            background: #dc3545;
        }

        .stage-number.waiting {
            background: #6c757d;
            color: white;
        }

        .stage-number.current {
            background: #ffc107;
            color: #000;
            animation: pulse 2s infinite;
        }

        .stage-number.disabled {
            background: #e9ecef;
            color: #adb5bd;
        }

        .stage-info {
            flex: 1;
        }

        .stage-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .approver-info {
            margin-bottom: 0.25rem;
        }

        .approver-name {
            color: #007bff;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .stage-timestamp {
            color: #6c757d;
            font-size: 0.75rem;
        }

        .stage-comments {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #495057;
        }

        .no-approval-flow {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .no-approval-flow i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #dee2e6;
        }

        .approval-flow-loading {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
        }

        .approval-flow-error {
            text-align: center;
            padding: 1rem;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 4px;
        }

        /* Sequential Approval Flow Styles */
        .approval-stage.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .approval-stage.current {
            background: linear-gradient(135deg, #fff3cd, #fef7e0);
            border: 2px solid #ffc107;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .approval-stage.waiting {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .sequential-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #1976d2;
        }

        .sequential-info i {
            margin-right: 0.5rem;
            color: #2196f3;
        }

        .stage-status-text {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-style: italic;
        }

        .stage-status-text.completed {
            color: #28a745;
        }

        .stage-status-text.current {
            color: #ffc107;
        }

        .stage-status-text.waiting {
            color: #6c757d;
        }

        .stage-status-text.disabled {
            color: #adb5bd;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Legacy approval flow list styles for backward compatibility */
        .approval-flow-list {
            margin-top: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .approval-flow-item {
            border-bottom: 1px solid #e9ecef;
            background: #ffffff;
            transition: background-color 0.2s;
        }

        .approval-flow-item:last-child {
            border-bottom: none;
        }

        .approval-flow-item:hover {
            background-color: #f8f9fa;
        }

        .approval-flow-step {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            gap: 1rem;
        }

        .approval-flow-icon {
            flex-shrink: 0;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .approval-flow-details {
            flex: 1;
            min-width: 0;
        }

        .approval-flow-approver {
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .approval-flow-title {
            color: #6c757d;
            font-weight: normal;
            margin-left: 0.5rem;
        }

        .approval-flow-status {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .approval-flow-comments {
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .approval-flow-comments i {
            margin-right: 0.5rem;
        }

        /* Loading and Error States */
        .loading-container {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-container {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #dee2e6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header {
                padding: 1.5rem;
            }

            .stats-bar {
                flex-direction: column;
                gap: 0.75rem;
            }

            .contracts-table {
                font-size: 0.9rem;
            }

            .contracts-table th,
            .contracts-table td {
                padding: 0.75rem 0.5rem;
            }

            .tab-nav-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                flex-direction: column;
                gap: 0.25rem;
            }

            .tab-nav-btn i {
                font-size: 1.2rem;
            }

            .search-export-row {
                flex-direction: column;
            }

            .search-wrapper {
                max-width: 100%;
            }

            /* Modal Responsive Styles */
            .contract-modal {
                padding: 0.5rem;
                align-items: flex-start;
                padding-top: 2rem;
            }
            
            .contract-modal-content {
                width: 100%;
                max-width: none;
                max-height: calc(100vh - 2rem);
                margin: 0;
            }
            
            .contract-modal-header {
                padding: 1rem;
            }
            
            .contract-modal-body {
                padding: 1rem;
            }
            
            .modal-footer {
                padding: 1rem;
                gap: 0.5rem;
            }
            
            .modal-footer .btn {
                min-width: 2rem;
                padding: 0.4rem;
            }
        }

        @media (max-width: 480px) {
            .tab-navigation {
                flex-direction: column;
            }

            .tab-nav-btn {
                flex-direction: row;
                justify-content: flex-start;
                padding: 1rem;
                border-radius: 0;
            }

            .tab-nav-btn.active {
                border-bottom: none;
                border-left: 3px solid #007bff;
            }

            /* Mobile Modal Styles */
            .contract-modal {
                padding: 0.25rem;
                padding-top: 1rem;
            }
            
            .contract-modal-content {
                max-height: calc(100vh - 1rem);
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .modal-footer .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* User Profile Avatar and Dropdown Styles */
        .user-profile {
            position: relative;
        }

        .profile-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .profile-btn:hover {
            transform: scale(1.05);
        }

        .profile-btn img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none; /* Hidden by default, shown when image loads */
        }

        .profile-btn img.loaded {
            display: block;
        }

        .profile-btn .avatar-initials {
            display: block; /* Shown by default */
        }

        .profile-btn img.loaded + .avatar-initials {
            display: none; /* Hide initials when image is loaded */
        }

        .avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            user-select: none;
            transition: all 0.2s ease;
            /* Dynamic background color will be set via JavaScript */
            background-color: #3498db; /* Fallback color */
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }

        .profile-dropdown.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .profile-dropdown ul {
            list-style: none;
            padding: 8px 0;
            margin: 0;
        }

        .profile-dropdown li {
            padding: 0;
        }

        .profile-dropdown li a {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s ease;
            font-size: 0.9rem;
        }

        .profile-dropdown li a:hover {
            background-color: #f8f9fa;
        }

        .profile-dropdown li a i {
            margin-right: 12px;
            width: 16px;
            color: #666;
            font-size: 0.9rem;
        }        .profile-dropdown li:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }        /* Responsive Design */        @media (max-width: 768px) {
            .page-header {
                margin: 0.5rem;
                padding: 1.5rem;
            }

            .stats-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .contracts-table {
                font-size: 0.85rem;
            }

            .contracts-table th,
            .contracts-table td {
                padding: 0.75rem 0.5rem;
            }

            .tab-nav-btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .tab-nav-btn i {
                display: none;
            }

            .search-export-row {
                flex-direction: column;
                gap: 1rem;
            }

            .search-wrapper {
                max-width: none;
            }

            .form-row {
                flex-direction: column;
                gap: 1rem;
            }

            .benefits-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 1rem;
                max-height: 95vh;
            }

            .modal-overlay {
                padding: 1rem;
            }

            .field-config-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .tab-navigation {
                flex-wrap: wrap;
            }

            .tab-nav-btn {
                flex: 1;
                min-width: 100px;
            }

            .tab-nav-btn.active {
                order: -1;
                flex: 100%;
            }
        }

        .main-container {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Menu Visibility Styles - updated for simplified menu structure */
        .sidebar:not(.menu-loading) [data-feature]:not(.menu-visible) {
            display: none !important;
        }

        /* Hide menu items by default during loading - only show when explicitly marked as visible */
        .menu-loading [data-feature] {
            display: none !important;
        }

        /* Show visible menu items even during loading */
        .menu-loading [data-feature].menu-visible {
            display: block !important;
        }

        /* Authentication-based content visibility */
        .auth-required {
            display: block; /* Always show - no restrictions */
        }

        .auth-required.authenticated {
            display: block;
        }

        /* Page loading styles - no restrictions */
        .page-unrestricted {
            filter: none;
            pointer-events: auto;
            opacity: 1;
            transition: all 0.3s ease;
        }

        /* Enhanced dropdown menu styles */
        .menu-dropdown > a {
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            list-style: none;
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .menu-dropdown.open .submenu,
        .menu-dropdown:hover .submenu {
            max-height: 500px;
            opacity: 1;
        }

        .submenu li a {
            padding: 0.75rem 1rem;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            border-radius: 6px;
            margin-bottom: 0.25rem;
            transition: all 0.2s ease;
        }

        .submenu li a:hover {
            background-color: var(--secondary-color);
            color: white;
        }

        /* Header Company Branding Styles */
        .top-nav-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background-color: #f8f9fa;
        }

        .header-company-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e9ecef;
            display: none;
        }

        .header-company-logo.visible {
            display: block;
        }

        .header-logo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 2px dashed #ced4da;
            display: none;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        .company-name-header {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: inline-block;
        }

        /* Mobile responsive adjustments for header branding */
        @media (max-width: 768px) {
            .top-nav-left {
                gap: 0.5rem;
            }
            
            .company-name-header {
                font-size: 1rem;
            }
            
            .header-company-logo, .header-logo-placeholder {
                width: 32px;
                height: 32px;
            }
        }

        /* Emergency CSS Fallback - Critical Styles for Standalone Loading */
        .app-container {
            display: flex !important;
            min-height: 100vh !important;
        }

        .sidebar {
            width: 250px !important;
            background-color: #2c3e50 !important;
            color: white !important;
            position: fixed !important;
            height: 100vh !important;
            overflow-y: auto !important;
            z-index: 1000 !important;
            padding: 1rem !important;
        }

        .main-content {
            margin-left: 250px !important;
            flex: 1 !important;
            padding: 2rem !important;
            background-color: #f8f9fa !important;
        }

        /* Menu System Emergency Styles */
        .menu li {
            display: none;
        }

        .menu li.menu-visible {
            display: block !important;
        }

        .menu-loading .menu li {
            display: block !important;
            opacity: 0.3;
        }

        /* Ensure basic menu styling works */
        .sidebar .menu {
            list-style: none !important;
            margin-top: 1rem !important;
        }

        .sidebar .menu a {
            color: white !important;
            text-decoration: none !important;
            display: flex !important;
            align-items: center !important;
            padding: 0.75rem 1rem !important;
            border-radius: 5px !important;
            transition: background-color 0.3s !important;
        }

        .sidebar .menu a:hover {
            background-color: #3498db !important;
        }

        /* Ensure page is visible */
        body {
            font-family: 'Inter', Arial, sans-serif !important;
            margin: 0 !important;
            padding: 0 !important;
            background-color: #ffffff !important;
        }
    </style>

    <!-- GitHub Pages Fix Script -->
    <script src="github-pages-fix.js"></script>
</head>
<body>
    <!-- Contract Modal -->
    <div id="contractModal" class="contract-modal">
        <div class="contract-modal-content">
            <div class="contract-modal-header">
                <h3 class="contract-modal-title">Contract Details</h3>
                <button class="close-modal" onclick="closeContractModal()">&times;</button>
            </div>
            <div class="contract-modal-body">                <div class="contract-info-section">
                    <h4>Employee Information</h4>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Full Name:</span>
                        <span class="contract-info-value" id="modalEmployeeName">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Employee ID:</span>
                        <span class="contract-info-value" id="modalEmployeeId">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Employee Department:</span>
                        <span class="contract-info-value" id="modalEmployeeDepartment">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Employee Position:</span>
                        <span class="contract-info-value" id="modalEmployeePosition">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Email:</span>
                        <span class="contract-info-value" id="modalEmployeeEmail">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Offer ID:</span>
                        <span class="contract-info-value" id="modalOfferId">-</span>
                    </div>
                </div>

                <div class="contract-info-section">
                    <h4>Contract Information</h4>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Contract ID:</span>
                        <span class="contract-info-value" id="modalContractId">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Contract Type:</span>
                        <span class="contract-info-value" id="modalContractType">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Department:</span>
                        <span class="contract-info-value" id="modalDepartment">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Position Title:</span>
                        <span class="contract-info-value" id="modalPosition">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Start Date:</span>
                        <span class="contract-info-value" id="modalStartDate">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">End Date:</span>
                        <span class="contract-info-value" id="modalEndDate">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Status:</span>
                        <span class="contract-info-value" id="modalStatus">-</span>
                    </div>
                </div>

                <div class="contract-info-section">
                    <h4>Salary & Compensation</h4>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Salary Amount:</span>
                        <span class="contract-info-value" id="modalSalaryAmount">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Salary Type:</span>
                        <span class="contract-info-value" id="modalSalaryType">-</span>
                    </div>
                </div>

                <div class="contract-info-section">
                    <h4>Work Terms</h4>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Working Hours (per week):</span>
                        <span class="contract-info-value" id="modalWorkingHours">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Probation Period (months):</span>
                        <span class="contract-info-value" id="modalProbationPeriod">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Notice Period (days):</span>
                        <span class="contract-info-value" id="modalNoticePeriod">-</span>
                    </div>
                </div>

                <div class="contract-info-section">
                    <h4>Benefits & Leave</h4>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Benefits:</span>
                        <span class="contract-info-value" id="modalBenefits">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Annual Leave (days):</span>
                        <span class="contract-info-value" id="modalAnnualLeave">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Sick Leave (days):</span>
                        <span class="contract-info-value" id="modalSickLeave">-</span>
                    </div>
                </div>

                <div class="contract-info-section">
                    <h4>Additional Information</h4>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Additional Terms:</span>
                        <span class="contract-info-value" id="modalAdditionalTerms">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Template:</span>
                        <span class="contract-info-value" id="modalTemplate">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Form Version:</span>
                        <span class="contract-info-value" id="modalFormVersion">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Version:</span>
                        <span class="contract-info-value" id="modalVersion">-</span>
                    </div>
                </div>

                <div class="contract-info-section" id="customFieldsSection" style="display: none;">
                    <h4>Custom Fields</h4>
                    <div id="modalCustomFields">
                        <!-- Custom fields will be populated here -->
                    </div>
                </div>

                <div class="contract-info-section">
                    <h4>Audit Trail</h4>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Created At:</span>
                        <span class="contract-info-value" id="modalCreatedAt">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Created By:</span>
                        <span class="contract-info-value" id="modalCreatedBy">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Last Modified:</span>
                        <span class="contract-info-value" id="modalLastModified">-</span>
                    </div>
                    <div class="contract-info-item">
                        <span class="contract-info-label">Data Collection Timestamp:</span>
                        <span class="contract-info-value" id="modalDataCollectionTimestamp">-</span>
                    </div>                </div>

                <div class="contract-info-section">
                    <h4>Approval Flow</h4>
                    <div id="modalApprovalFlow">
                        <div class="contract-info-item">
                            <span class="contract-info-label">Approval Status:</span>
                            <span class="contract-info-value" id="modalApprovalStatus">-</span>
                        </div>
                        <div class="contract-info-item">
                            <span class="contract-info-label">Current Approver:</span>
                            <span class="contract-info-value" id="modalCurrentApprover">-</span>
                        </div>
                        <div class="approval-flow-list" id="modalApprovalFlowList">
                            <!-- Approval flow steps will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Modal Footer with Action Buttons - Matching staff.html style -->
            <div class="modal-footer">
                <!-- Permissions Info -->
                <div class="permissions-info" style="display: none; flex: 1; font-size: 0.8rem; color: #6c757d; font-style: italic;">
                    <i class="fas fa-info-circle"></i>
                    <span id="permissionsText">Loading permissions...</span>
                </div>
                
                <!-- Close button -->
                <button type="button" class="btn btn-secondary" onclick="closeContractModal()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
                
                <!-- Edit button -->
                <button type="button" class="btn btn-primary" onclick="editContract(currentViewedContract?.contractId || currentViewedContract?.id)" title="Edit Contract">
                    <i class="fas fa-edit"></i>
                </button>
                
                <!-- Download button -->
                <button type="button" class="btn btn-info" onclick="downloadContract(currentViewedContract?.contractId || currentViewedContract?.id)" title="Download PDF">
                    <i class="fas fa-download"></i>
                </button>
                
                <!-- Email button -->
                <button type="button" class="btn btn-secondary" onclick="emailContract(currentViewedContract?.contractId || currentViewedContract?.id)" title="Email Contract">
                    <i class="fas fa-envelope"></i>
                </button>
                
                <!-- Approve button -->
                <button type="button" class="btn btn-success" onclick="approveContract(currentViewedContract?.contractId || currentViewedContract?.id)" title="Approve Contract">
                    <i class="fas fa-check"></i>
                </button>
                
                <!-- Decline button -->
                <button type="button" class="btn btn-warning" onclick="declineContract(currentViewedContract?.contractId || currentViewedContract?.id)" title="Decline Contract">
                    <i class="fas fa-times"></i>
                </button>
                
                <!-- Delete button -->
                <button type="button" class="btn btn-danger" onclick="deleteContract(currentViewedContract?.contractId || currentViewedContract?.id)" title="Delete Contract">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>    <!-- Edit Contract Modal -->
    <div id="editContractModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Contract</h3>
                <button class="modal-close" onclick="closeEditContractModal()">&times;</button>
            </div>
            <div class="modal-body">                <form id="editContractForm">
                    <input type="hidden" id="editContractId">
                    <input type="hidden" id="editFirebaseId">
                    
                    <div class="form-section">
                        <h4>Employee Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Employee Name</label>
                                <input type="text" class="form-control" id="editEmployeeName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Employee ID</label>
                                <input type="text" class="form-control" id="editEmployeeId" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Employee Department</label>
                                <input type="text" class="form-control" id="editEmployeeDepartment">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Employee Position</label>
                                <input type="text" class="form-control" id="editEmployeePosition">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmployeeEmail">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Offer ID</label>
                                <input type="text" class="form-control" id="editOfferId">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Contract Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Contract Type</label>
                                <select class="form-control" id="editContractType" required>
                                    <option value="">Select Type</option>
                                    <option value="permanent">Permanent</option>
                                    <option value="fixed">Fixed Term</option>
                                    <option value="part-time">Part Time</option>
                                    <option value="internship">Internship</option>
                                    <option value="contract">Contract</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Status</label>
                                <select class="form-control" id="editStatus" required>
                                    <option value="">Select Status</option>
                                    <option value="active">Active</option>
                                    <option value="pending">Pending</option>
                                    <option value="expired">Expired</option>
                                    <option value="terminated">Terminated</option>
                                    <option value="draft">Draft</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Department</label>
                                <select class="form-control" id="editDepartment" required>
                                    <option value="">Select Department</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="HR">HR</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Finance">Finance</option>
                                    <option value="IT">IT</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Fuel Management">Fuel Management</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Position Title</label>
                                <input type="text" class="form-control" id="editPosition" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Start Date</label>
                                <input type="date" class="form-control" id="editStartDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">End Date</label>
                                <input type="date" class="form-control" id="editEndDate" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Salary & Compensation</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Salary Amount</label>
                                <input type="number" class="form-control" id="editSalaryAmount" placeholder="50000" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">Salary Type</label>
                                <select class="form-control" id="editSalaryType" required>
                                    <option value="">Select Type</option>
                                    <option value="annual">Annual</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="hourly">Hourly</option>
                                    <option value="daily">Daily</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Work Terms</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">Working Hours (per week)</label>
                                <input type="number" class="form-control" id="editWorkingHours" placeholder="40" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Probation Period (months)</label>
                                <input type="number" class="form-control" id="editProbationPeriod" placeholder="3">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Notice Period (days)</label>
                                <input type="number" class="form-control" id="editNoticePeriod" placeholder="30">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Benefits & Leave</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Annual Leave (days)</label>
                                <input type="number" class="form-control" id="editAnnualLeave" placeholder="20">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sick Leave (days)</label>
                                <input type="number" class="form-control" id="editSickLeave" placeholder="10">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Benefits</label>
                            <div class="benefits-grid">
                                <div class="form-check">
                                    <input type="checkbox" id="benefitHealth" value="Health Insurance">
                                    <label class="form-check-label" for="benefitHealth">Health Insurance</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="benefitDental" value="Dental Insurance">
                                    <label class="form-check-label" for="benefitDental">Dental Insurance</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="benefitVision" value="Vision Insurance">
                                    <label class="form-check-label" for="benefitVision">Vision Insurance</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="benefit401k" value="401k">
                                    <label class="form-check-label" for="benefit401k">401k</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="benefitLife" value="Life Insurance">
                                    <label class="form-check-label" for="benefitLife">Life Insurance</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="benefitDisability" value="Disability Insurance">
                                    <label class="form-check-label" for="benefitDisability">Disability Insurance</label>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="form-label">Custom Benefits (comma-separated)</label>
                                <input type="text" class="form-control" id="editCustomBenefits" placeholder="e.g., Company Car, Gym Membership">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Additional Information</h4>
                        <div class="form-group">
                            <label class="form-label">Additional Terms</label>
                            <textarea class="form-control" id="editAdditionalTerms" rows="3" placeholder="Additional contract terms and conditions"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditContractModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveContractChanges()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Sidebar Menu -->
        <nav class="sidebar menu-loading">
            <div class="logo">
                <h2>Dreamex Datalab</h2>
            </div>
            <ul class="menu" id="roleBasedMenu">
                <li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                </li>
                <li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
                    <a href="#"><i class="fas fa-medkit"></i> Health</a>
                    <ul class="submenu">
                        <li data-feature="health_assessment_view" data-requires-permission="health_assessment_view">
                            <a href="health-assessment.html">Assessment</a>
                        </li>
                        <li data-feature="health_consultation_view" data-requires-permission="health_consultation_view">
                            <a href="health-consultation.html">Consultation</a>
                        </li>
                        <li data-feature="medical_folder_view" data-requires-permission="medical_folder_view">
                            <a href="medical-folder.html">Medical Folder</a>
                        </li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
                    <a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
                    <ul class="submenu">
                        <li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
                        <li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
                        <li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
                        <li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
                        <li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
                        <li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
                        <li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="fuel_management">
                    <a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
                    <ul class="submenu">
                        <li data-feature="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
                        <li data-feature="fuel_storage"><a href="fuel-storage-status.html">Fuel Storage Status</a></li>
                        <li data-feature="tank_transfer"><a href="tank-transfer.html">Tank-to-Tank Transfer</a></li>
                        <li data-feature="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
                        <li data-feature="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
                        <li data-feature="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
                        <li data-feature="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="environment_view">
                    <a href="#"><i class="fas fa-leaf"></i> Environment</a>
                    <ul class="submenu">
                        <li data-feature="water_view"><a href="waterboard.html">Water Quality</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="security_view">
                    <a href="#"><i class="fas fa-lock"></i> Security</a>
                    <ul class="submenu">
                        <li data-feature="access_view"><a href="accessboard.html">Access Request</a></li>
                        <li data-feature="access_daily_view"><a href="accessdaily.html">Daily Access Control</a></li>
                        <li data-feature="removal_view"><a href="removalboard.html">Property Removal</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
                    <a href="#"><i class="fas fa-truck"></i> Logistics</a>
                    <ul class="submenu">
                        <li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleetboard.html">Fleet Management</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
                    <a href="#"><i class="fas fa-users"></i> HR</a>
                    <ul class="submenu">
                        <li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
                        <li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
                        <li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
                        <li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
                        <li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
                        <li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
                        <li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
                        <li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
                        <li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
                        <li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
                        <li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
                        <li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
                    </ul>
                </li>
                <li class="menu-dropdown" data-feature="project_management_view" data-requires-permission="project_management_view">
                    <a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
                    <ul class="submenu">
                        <li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
                        <li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
                        <li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
                        <li data-feature="task_management_view" data-requires-permission="task_management_view"><a href="tasks.html">Task Management</a></li>
                        <li data-feature="milestone_tracking_view" data-requires-permission="milestone_tracking_view"><a href="milestones.html">Milestone Tracking</a></li>
                        <li data-feature="resource_allocation_view" data-requires-permission="resource_allocation_view"><a href="resources.html">Resource Allocation</a></li>
                        <li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
                        <li data-feature="gantt_chart_view" data-requires-permission="gantt_chart_view"><a href="gantt-chart.html">Gantt Chart</a></li>
                    </ul>
                </li>
                <li data-feature="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
                <li class="menu-dropdown" data-feature="settings_view">
                    <a href="#"><i class="fas fa-cog"></i> Settings</a>
                    <ul class="submenu">
                        <li data-feature="account_settings_view"><a href="account.html">Account Settings</a></li>
                        <li data-feature="company_management_view"><a href="companymanagement.html">Company Management</a></li>
                        <li data-feature="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
                        <li data-feature="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
                        <li data-feature="preferences_view"><a href="preferences.html">Preferences</a></li>
                        <li data-feature="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
                        <li data-feature="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
                        <li data-feature="user_management_view"><a href="users.html">User & Role Management</a></li>
                        <li data-feature="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
                    </ul>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation -->
            <header class="top-nav">
                <div class="top-nav-left">
                    <button id="sidebarToggle" class="sidebar-toggle-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                    <img id="headerCompanyLogo" class="header-company-logo" alt="Company Logo">
                    <span id="headerCompanyName" class="company-name-header"></span>
                </div>
                <div class="top-nav-right">
                    <div class="notifications">
                        <button id="notificationBtn" class="notification-btn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">0</span>
                        </button>
                        <div class="notification-dropdown">
                            <div class="notification-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notification-list">
                                <!-- Notifications will be dynamically added here -->
                            </div>
                        </div>
                    </div>                    <div class="user-profile">
                        <button id="userProfileBtn" class="profile-btn">
                            <img src="" alt="User Avatar" style="display: none;">
                            <div class="avatar-initials" id="userAvatarInitials">U</div>
                        </button>
                        <div class="profile-dropdown" id="profileDropdown">
                            <ul>
                                <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="content">
                <div class="contract-container">
                    <!-- Page Header -->
                    <div class="page-header">
                        <div class="header-top-row">
                            <div class="header-left">
                                <h1 class="page-title">
                                    <i class="fas fa-file-contract"></i>
                                    Employee Contracts
                                </h1>
                                <p class="page-subtitle">Create, manage and track employee contracts and agreements</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <div class="stat-number" id="totalContracts">0</div>
                            <div>Total Contracts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeContracts">0</div>
                            <div>Active Contracts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pendingRenewal">0</div>
                            <div>Pending Renewal</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="expiringSoon">0</div>
                            <div>Expiring Soon</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completedContracts">0</div>
                            <div>Completed</div>
                        </div>
                    </div>

                    <!-- Content Tabs Layout -->
                    <div class="content-tabs">                        <!-- Tab Navigation -->
                        <div class="tab-navigation">
                            <button class="tab-nav-btn active" id="activeContractsTabBtn" onclick="switchToTab('active')">
                                <i class="fas fa-file-signature"></i>
                                Active Contracts
                            </button>
                            <button class="tab-nav-btn" id="archiveTabBtn" onclick="switchToTab('archive')">
                                <i class="fas fa-archive"></i>
                                Archive
                            </button>
                            <button class="tab-nav-btn" id="completeTabBtn" onclick="switchToTab('complete')">
                                <i class="fas fa-check-circle"></i>
                                Complete
                            </button>
                        </div>

                        <!-- Active Contracts Tab Content -->
                        <div class="tab-content active" id="activeContractsTabContent">
                            <!-- Contracts Controls -->
                            <div class="tab-controls">                                <div class="search-export-row">
                                    <div class="search-wrapper">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="searchInput" placeholder="Search by employee name, ID, or department...">
                                    </div>
                                    <div style="display: flex; gap: 1rem;">
                                        <a href="contractsub.html" class="btn btn-success">
                                            <i class="fas fa-plus"></i>
                                            Create New Contract
                                        </a>
                                        <button class="btn btn-primary" id="exportBtn">
                                            <i class="fas fa-download"></i>
                                            Export Contracts
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Contracts Table Container -->
                            <div class="contracts-table-container">
                                <div class="table-header">
                                    <h2 class="table-title">Active Employee Contracts</h2>
                                </div>

                                <!-- Loading State -->
                                <div class="loading-container" id="loadingState">
                                    <div class="loading-spinner"></div>
                                    <h3>Loading contracts...</h3>
                                    <p>Fetching employee contract data</p>
                                </div>

                                <!-- Contracts Table -->
                                <table class="contracts-table" id="contractsTable" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Contract ID</th>
                                            <th>Department</th>
                                            <th>Position</th>
                                            <th>Contract Type</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Status</th>
                                            <!-- <th>Actions</th> -->
                                        </tr>
                                    </thead>
                                    <tbody id="contractsTableBody">
                                        <!-- Contracts will be populated here -->
                                    </tbody>
                                </table>                                <!-- Empty State -->
                                <div class="empty-state" id="emptyState" style="display: none;">
                                    <i class="fas fa-file-contract"></i>
                                    <h3>No Active Contracts</h3>
                                    <p>No active contracts found. Create a new contract to get started.</p>
                                    <a href="contractsub.html" class="btn btn-primary">
                                        <i class="fas fa-plus"></i>
                                        Create New Contract
                                    </a>
                                </div>
                            </div>
                        </div><!-- Archive Tab Content -->
                        <div class="tab-content" id="archiveTabContent">
                            <div style="text-align: center; padding: 3rem;">
                                <i class="fas fa-archive" style="font-size: 4rem; color: #dee2e6; margin-bottom: 1rem;"></i>
                                <h3>Contract Archive</h3>
                                <p>View and manage archived and terminated contracts</p>
                                <button class="btn btn-primary">
                                    <i class="fas fa-eye"></i>
                                    View Archive
                                </button>
                            </div>
                        </div>

                        <!-- Complete Tab Content -->
                        <div class="tab-content" id="completeTabContent">
                            <!-- Completed Contracts Controls -->
                            <div class="tab-controls">
                                <div class="search-export-row">
                                    <div class="search-wrapper">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="search-input" id="completeSearchInput" placeholder="Search completed contracts...">
                                    </div>
                                    <button class="btn btn-primary" id="exportCompleteBtn">
                                        <i class="fas fa-download"></i>
                                        Export Completed
                                    </button>
                                </div>
                            </div>

                            <!-- Completed Contracts Table Container -->
                            <div class="contracts-table-container">
                                <div class="table-header">
                                    <h2 class="table-title">Completed Contracts</h2>
                                </div>

                                <!-- Loading State for Complete -->
                                <div class="loading-container" id="completeLoadingState">
                                    <div class="loading-spinner"></div>
                                    <h3>Loading completed contracts...</h3>
                                    <p>Fetching completed contract data</p>
                                </div>

                                <!-- Completed Contracts Table -->
                                <table class="contracts-table" id="completeContractsTable" style="display: none;">
                                    <thead>
                                        <tr>
                                            <th>Employee</th>
                                            <th>Contract ID</th>
                                            <th>Department</th>
                                            <th>Position</th>
                                            <th>Contract Type</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Completion Date</th>
                                            <th>Status</th>
                                            <!-- <th>Actions</th> -->
                                        </tr>
                                    </thead>
                                    <tbody id="completeContractsTableBody">
                                        <!-- Completed contracts will be populated here -->
                                    </tbody>
                                </table>

                                <!-- Empty State for Complete -->
                                <div class="empty-state" id="completeEmptyState" style="display: none;">
                                    <i class="fas fa-check-circle"></i>
                                    <h3>No Completed Contracts</h3>
                                    <p>No completed contracts found.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>        </main>
    </div>    
    
    <!-- GitHub Pages Fix Script -->
    <script src="github-pages-fix.js"></script>
    
    <!-- Include common scripts -->
    <script type="module" src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/common-components.js"></script>
    <script src="js/approval-flow.js"></script>
    <script src="js/approval-handler.js"></script>
    <script src="js/approval-manager.js"></script>
    <script src="js/company-permissions.js"></script>
    <script src="js/access-permissions.js"></script>
    <script src="js/company-data-service-v8.js"></script>
    <script src="validate-fields.js"></script>
    
    <script type="module">
        // Import and initialize company data service
        try {
            const { default: CompanyDataService } = await import('./js/company-data-service.js');
            
            // Initialize company data service and make it globally available
            const companyDataService = new CompanyDataService();
            window.companyDataService = companyDataService;
            
            // Initialize company context
            await companyDataService.initializeUserContext();
            console.log('Company data service initialized successfully');
        } catch (error) {
            console.warn('Could not load company data service:', error);
            // Create a fallback service
            window.companyDataService = {
                getCurrentCompanyId: () => null,
                initializeUserContext: () => Promise.resolve()
            };
        }
    </script>
    
    <script>
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar && mainContent) {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
                
                // Store sidebar state in localStorage
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            }
        }

        function restoreSidebarState() {
            const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (isCollapsed && sidebar && mainContent) {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
            }
        }        let contracts = [];
        let templates = [];
        let currentUser = null;
        let currentViewedContract = null; // Store currently viewed contract for editing        // User Profile Management Functions
        function getUserDisplayName(user) {
            if (!user) return 'User';
            
            const cleanName = (name) => {
                if (!name || typeof name !== 'string') return '';
                return name.trim().replace(/\s+/g, ' ');
            };
            
            const potentialNames = [
                user.displayName,
                user.name,
                user.username
            ];
            
            for (const name of potentialNames) {
                const cleaned = cleanName(name);
                if (cleaned) return cleaned;
            }
            
            if (user.email) {
                const emailUsername = user.email.split('@')[0];
                const cleaned = cleanName(emailUsername);
                if (cleaned) return cleaned;
            }
            
            return 'User';
        }

        // Get user initials for avatar display
        function getUserInitials(user) {
            const displayName = getUserDisplayName(user);
            
            if (!displayName || displayName === 'User') return 'U';
            
            const words = displayName.split(' ').filter(word => word.length > 0);
            if (words.length === 1) {
                return words[0].substring(0, 2).toUpperCase();
            } else {
                return words.slice(0, 2).map(word => word.charAt(0)).join('').toUpperCase();
            }
        }

        // Generate initials avatar
        function generateInitialsAvatar(name, imgElement) {
            if (!imgElement || !name) return;
            
            const initials = getUserInitials({ displayName: name });
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
            const backgroundColor = colors[name.length % colors.length];
            
            const svg = `
                <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${backgroundColor}"/>
                    <text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text>
                </svg>
            `;
            
            imgElement.src = 'data:image/svg+xml;base64,' + btoa(svg);
            imgElement.alt = name + ' Avatar';
        }

        // Debug function to test profile photo loading
        window.testProfilePhotoLoading = async function() {
            console.log('=== Testing Profile Photo Loading ===');
            
            // Check Firebase services
            console.log('Firebase app initialized:', !!firebase.apps.length);
            console.log('Auth service:', !!auth);
            console.log('Database service:', !!database);
            console.log('Storage service:', !!storage);
            
            // Check current user
            const currentUser = auth.currentUser;
            console.log('Current user:', currentUser ? currentUser.email : 'Not signed in');
            
            if (currentUser) {
                console.log('User UID:', currentUser.uid);
                
                // Test company data service
                if (window.companyDataService) {
                    const companyId = window.companyDataService.getCurrentCompanyId();
                    console.log('Company ID:', companyId);
                    
                    // Test avatar URL loading
                    try {
                        const avatarUrl = await getUserAvatarUrl(currentUser);
                        console.log('Avatar URL result:', avatarUrl);
                    } catch (error) {
                        console.error('Avatar URL loading error:', error);
                    }
                } else {
                    console.log('CompanyDataService not available');
                }
            }
            
            console.log('=== Test Complete ===');
        };

        // Get user avatar URL with company scope
        async function getUserAvatarUrl(user) {
            if (!user) {
                console.log('getUserAvatarUrl: No user provided');
                return null;
            }
            
            console.log('getUserAvatarUrl: Loading avatar for user:', user.uid);
            
            try {
                let avatarPath;
                
                // Try to get company ID for scoped avatar path
                if (window.companyDataService && typeof window.companyDataService.getCurrentCompanyId === 'function') {
                    const companyId = window.companyDataService.getCurrentCompanyId();
                    if (companyId) {
                        // Company-scoped avatar path
                        avatarPath = `companies/${companyId}/avatars/${user.uid}/profile.jpg`;
                        console.log('Using company-scoped avatar path:', avatarPath);
                    } else {
                        // Fallback to global avatar path
                        avatarPath = `avatars/${user.uid}/profile.jpg`;
                        console.log('No company ID found, using global avatar path:', avatarPath);
                    }
                } else {
                    // Default global avatar path
                    avatarPath = `avatars/${user.uid}/profile.jpg`;
                    console.log('No companyDataService, using default avatar path:', avatarPath);
                }
                
                // Use the global storage instance
                if (!storage) {
                    console.error('Firebase Storage not initialized');
                    return null;
                }
                
                const avatarRef = storage.ref(avatarPath);
                const downloadURL = await avatarRef.getDownloadURL();
                console.log('Successfully loaded avatar from:', avatarPath, 'URL:', downloadURL);
                return downloadURL;
            } catch (error) {
                console.log('No custom avatar found at path, will use initials. Error:', error.message);
                return null;
            }
        }

        // Update UI for authenticated user
        async function updateUIForAuthenticatedUser(user) {
            const profileBtn = document.querySelector('.profile-btn');
            const profileDropdown = document.querySelector('.profile-dropdown ul');
            
            if (profileBtn && profileDropdown && user) {
                // Use centralized display methods
                const initials = getUserInitials(user);
                const displayName = getUserDisplayName(user);
                const email = user.email || '';
                
                // Get elements
                const profileImg = profileBtn.querySelector('img');
                const avatarInitials = profileBtn.querySelector('.avatar-initials');
                
                console.log('Updating user profile for:', displayName);
                
                // Initialize with initials first (immediate display)
                if (avatarInitials) {
                    avatarInitials.textContent = initials;
                    // Set dynamic color based on user name
                    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                    const backgroundColor = colors[displayName.length % colors.length];
                    avatarInitials.style.backgroundColor = backgroundColor;
                    avatarInitials.style.display = 'flex';
                }
                if (profileImg) {
                    profileImg.style.display = 'none';
                    profileImg.classList.remove('loaded');
                }
                
                // Try to load user's profile photo (async)
                try {
                    const avatarUrl = await getUserAvatarUrl(user);
                    
                    if (avatarUrl && profileImg) {
                        console.log('Loading user profile photo:', avatarUrl);
                        
                        // Preload image to ensure it loads properly
                        const img = new Image();
                        img.onload = function() {
                            // Image loaded successfully, show it
                            profileImg.src = avatarUrl;
                            profileImg.alt = displayName + ' Profile Photo';
                            profileImg.style.display = 'block';
                            profileImg.classList.add('loaded');
                            
                            // Hide initials when photo is loaded
                            if (avatarInitials) {
                                avatarInitials.style.display = 'none';
                            }
                            console.log('User profile photo loaded successfully');
                        };
                        img.onerror = function() {
                            console.log('Failed to load user profile photo, keeping initials');
                            // Keep initials visible if image fails to load
                        };
                        img.src = avatarUrl;
                    } else {
                        console.log('No profile photo found, using initials for:', displayName);
                        // Keep initials visible - already set above
                    }
                } catch (error) {
                    console.log('Error loading profile photo, using initials:', error);
                    // Keep initials visible - already set above
                }
                
                // Create avatar for dropdown (either real avatar or initials)
                let dropdownAvatarHtml;
                try {
                    const avatarUrl = await getUserAvatarUrl(user);
                    if (avatarUrl) {
                        dropdownAvatarHtml = `<img src="${avatarUrl}" alt="${displayName} Profile Photo" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                        const backgroundColor = colors[displayName.length % colors.length];
                        dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: ${backgroundColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                    }
                } catch (error) {
                    const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
                    const backgroundColor = colors[displayName.length % colors.length];
                    dropdownAvatarHtml = `<div style="width: 32px; height: 32px; border-radius: 50%; background: ${backgroundColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">${initials}</div>`;
                }
                
                // Update profile dropdown with user info
                const userInfoHtml = `
                    <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            ${dropdownAvatarHtml}
                            <div>
                                <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                    ${displayName}
                                </div>
                                <div style="color: #666; font-size: 12px;">
                                    ${email}
                                </div>
                            </div>
                        </div>
                    </li>
                    <li><a href="account.html"><i class="fas fa-user"></i> Account Settings</a></li>
                    <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                `;
                
                profileDropdown.innerHTML = userInfoHtml;
                
                // Re-attach logout event listener
                const logoutBtn = profileDropdown.querySelector('#logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        logout();
                    });
                }
            }
        }

        // Initialize profile dropdown functionality
        function initializeProfileDropdown() {
            const userProfileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');
            
            if (userProfileBtn && profileDropdown) {
                userProfileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });
                
                document.addEventListener('click', (e) => {
                    if (!userProfileBtn.contains(e.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
            }
        }

        // Logout functionality
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch((error) => {
                console.error('Logout error:', error);
            });
        }

        // Initialize sidebar and header functionality
        function initializeSidebarAndHeader() {
            console.log('Initializing sidebar and header...');
            
            // Restore sidebar state
            restoreSidebarState();
            
            // Set up sidebar toggle button
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
                console.log('Sidebar toggle button initialized');
            } else {
                console.warn('Sidebar toggle button not found');
            }
            
            // Set up profile dropdown
            const profileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.getElementById('profileDropdown');
            
            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                        profileDropdown.classList.remove('show');
                    }
                });
                
                console.log('Profile dropdown initialized');
            } else {
                console.warn('Profile dropdown elements not found');
            }
            
            // Set up menu dropdowns
            const menuDropdowns = document.querySelectorAll('.menu-dropdown');
            menuDropdowns.forEach(dropdown => {
                const link = dropdown.querySelector('a');
                if (link) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        dropdown.classList.toggle('open');
                    });
                }
            });
            
            // Remove menu loading state - will be handled by the feature authorization system
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                console.log('Sidebar found, menu system will be handled by feature authorization');
            }
            
            console.log('Sidebar and header initialization complete');
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Contract page initializing...');
            
            // Initialize sidebar and header components
            initializeSidebarAndHeader();
            
            // Don't show any menu items immediately - rely on feature-role visibility function
            // Menu will be loaded by the feature-based authorization system
            
            // Skip page restrictions - allow unrestricted access
            // initializePageRestrictions();
            
            // Initialize authentication (but don't restrict access)
            initializeAuth();
            
            // Initialize other components immediately
            initializeContractPage();
            
            // Load templates immediately (not user-specific)
            loadTemplates();
            
            // Note: loadContracts() will be called after authentication state is determined
            
            updateMenuWithFeatureAuthorization();
            
            // Initialize user profile dropdown
            initializeProfileDropdown();
            
            // Make test functions globally available
            window.testFirebaseContractFetch = testFirebaseContractFetch;
            window.loadContracts = loadContracts;
            window.contracts = contracts;
            window.debugContracts = function() {
                console.log('=== CONTRACT DEBUG INFO ===');
                console.log('Current contracts array length:', contracts.length);
                console.log('Current contracts array:', contracts);
                console.log('Loading state element:', document.getElementById('loadingState'));
                console.log('Contracts table element:', document.getElementById('contractsTable'));
                console.log('Empty state element:', document.getElementById('emptyState'));
                console.log('Table body element:', document.getElementById('contractsTableBody'));
                
                // Check DOM element visibility
                const loadingState = document.getElementById('loadingState');
                const contractsTable = document.getElementById('contractsTable');
                const emptyState = document.getElementById('emptyState');
                const tableBody = document.getElementById('contractsTableBody');
                
                console.log('DOM element visibility:');
                console.log('  Loading state display:', loadingState ? loadingState.style.display : 'not found');
                console.log('  Contracts table display:', contractsTable ? contractsTable.style.display : 'not found');
                console.log('  Empty state display:', emptyState ? emptyState.style.display : 'not found');
                console.log('  Table body innerHTML length:', tableBody ? tableBody.innerHTML.length : 'not found');
                
                // Manual contract filtering test
                console.log('Manual filtering test:');
                const activeContracts = contracts.filter(contract => contract.status !== 'completed');
                console.log('  Active contracts (filtered):', activeContracts.length);
                console.log('  Active contracts data:', activeContracts);
                
                // Force display test
                console.log('Force display test...');
                if (activeContracts.length > 0) {
                    displayContracts(activeContracts);
                    console.log('  Force display executed');
                } else {
                    console.log('  No active contracts to force display');
                }
                
                console.log('=== END DEBUG INFO ===');
                return contracts;
            };
            window.testSpecificCompanyPath = function() {
                console.log('=== TESTING DYNAMIC COMPANY PATH ===');
                
                const user = auth.currentUser;
                if (!user) {
                    console.log('❌ No authenticated user - cannot determine company path');
                    return;
                }
                
                console.log('🔍 Getting company ID for user:', user.uid);
                
                // Get user's company association dynamically
                database.ref(`users/${user.uid}`).once('value')
                    .then((userSnapshot) => {
                        const userData = userSnapshot.val();
                        
                        if (userData && userData.companyId) {
                            const companyId = userData.companyId;
                            const path = `companies/${companyId}/contracts`;
                            console.log('✅ Testing dynamic company path:', path);
                            console.log('🏢 Company ID:', companyId);
                            
                            return database.ref(path).once('value');
                        } else {
                            console.log('⚠️ User has no company association, testing global path');
                            return database.ref('contracts').once('value');
                        }
                    })
                    .then((snapshot) => {
                        const data = snapshot.val();
                        console.log('✅ Data received:', data);
                        console.log('📊 Number of contracts:', data ? Object.keys(data).length : 0);
                        if (data) {
                            console.log('📋 Contract keys:', Object.keys(data));
                            Object.entries(data).forEach(([key, contract], index) => {
                                console.log(`Contract ${index + 1} (${key}):`, {
                                    employeeName: contract.employeeName,
                                    status: contract.status,
                                    contractId: contract.contractId,
                                    department: contract.department,
                                    positionTitle: contract.positionTitle
                                });
                            });
                            
                            // Test direct processing
                            console.log('🧪 Testing direct contract processing...');
                            processContractsData(data, 'test-manual');
                        } else {
                            console.log('⚠️ No contracts found');
                        }
                    })
                    .catch((error) => {
                        console.error('❌ Error:', error);
                    });
                    
                console.log('=== END TEST ===');
            };
              console.log('Contract page loaded. Available test functions:');
            console.log('- testFirebaseContractFetch() - Test direct Firebase contract fetching');
            console.log('- loadContracts() - Reload contracts from Firebase');
            console.log('- testApprovalFlowDisplay() - Test approval flow display in modal');
            console.log('- debugContracts() - Debug current contracts state');
            console.log('- testSpecificCompanyPath() - Test loading from dynamic company path');
            console.log('- testApprovalStatusChange() - Test contract approval status behavior and display');
            console.log('- testApprovalStatusSync() - Test approval status synchronization between modal and table');
            console.log('- testApprovedContractButtons() - Test button visibility for approved contracts');
            console.log('- contracts - View current contracts array');
            console.log('- debugTableVisibility() - Check table CSS visibility');
            console.log('- forceShowAllContracts() - Force display all contracts bypassing filters');
            
            // Additional debug function for table visibility
            window.debugTableVisibility = function() {
                console.log('=== TABLE VISIBILITY DEBUG ===');
                const elements = {
                    loadingState: document.getElementById('loadingState'),
                    contractsTable: document.getElementById('contractsTable'),
                    emptyState: document.getElementById('emptyState'),
                    tableBody: document.getElementById('contractsTableBody')
                };
                
                Object.entries(elements).forEach(([name, element]) => {
                    if (element) {
                        const computedStyle = window.getComputedStyle(element);
                        console.log(`${name}:`, {
                            display: element.style.display || 'default',
                            computedDisplay: computedStyle.display,
                            visibility: computedStyle.visibility,
                            opacity: computedStyle.opacity,
                            height: computedStyle.height,
                            innerHTML: name === 'tableBody' ? `${element.innerHTML.length} chars` : 'N/A'
                        });
                    } else {
                        console.log(`${name}: NOT FOUND`);
                    }
                });
                
                // Check search input value
                const searchInput = document.getElementById('searchInput');
                console.log('Search input value:', searchInput ? `"${searchInput.value}"` : 'NOT FOUND');
                
                console.log('=== END VISIBILITY DEBUG ===');
            };
            
            // Force show all contracts function for debugging
            window.forceShowAllContracts = function() {
                console.log('=== FORCE SHOW ALL CONTRACTS ===');
                console.log('📊 Total contracts:', contracts.length);
                
                if (contracts.length === 0) {
                    console.log('❌ No contracts in global array - try running testSpecificCompanyPath() first');
                    return;
                }
                
                console.log('🎯 Forcing display of ALL contracts (bypassing status filter)');
                
                // Show all contracts regardless of status
                displayContracts(contracts);
                
                console.log('✅ Force display completed');
                console.log('=== END FORCE SHOW ===');
            };
            
            // Test approval status changes
            window.testApprovalStatusChange = function() {
                console.log('=== TESTING APPROVAL STATUS BEHAVIOR ===');
                
                if (contracts.length === 0) {
                    console.log('❌ No contracts loaded - run loadContracts() first');
                    return;
                }
                
                console.log('📊 Current contract statuses:');
                contracts.forEach((contract, index) => {
                    console.log(`  Contract ${index + 1} (${contract.contractId || contract.id}):`, {
                        status: contract.status,
                        approvalStatus: contract.approvalStatus,
                        willShowInActiveTab: contract.status !== 'completed'
                    });
                });
                
                console.log('\n🔍 Status filtering behavior:');
                const activeContracts = contracts.filter(contract => contract.status !== 'completed');
                const completedContracts = contracts.filter(contract => contract.status === 'completed');
                const approvedContracts = contracts.filter(contract => contract.status === 'completed' && contract.approvalStatus === 'approved');
                
                console.log(`  Total contracts: ${contracts.length}`);
                console.log(`  Active tab will show: ${activeContracts.length} contracts`);
                console.log(`  - Active status: ${contracts.filter(c => c.status === 'active').length}`);
                console.log(`  - Approved status: ${approvedContracts.length}`);
                console.log(`  - Pending status: ${contracts.filter(c => c.status === 'pending').length}`);
                console.log(`  Completed tab will show: ${completedContracts.length} contracts`);
                
                console.log('\n✅ Summary: Approved contracts (status="completed" + approvalStatus="approved") will appear in Completed tab, while active contracts remain in Active tab');
                console.log('=== END APPROVAL STATUS TEST ===');
                
                return {
                    total: contracts.length,
                    activeTab: activeContracts.length,
                    completedTab: completedContracts.length,
                    approved: approvedContracts.length
                };
            };
            
            // Test approval status synchronization
            window.testApprovalStatusSync = function() {
                console.log('=== TESTING APPROVAL STATUS SYNCHRONIZATION ===');
                
                if (contracts.length === 0) {
                    console.log('❌ No contracts loaded - run loadContracts() first');
                    return;
                }
                
                console.log('🔍 Testing Firebase path resolution...');
                const sampleContract = contracts[0];
                if (sampleContract) {
                    getContractUpdatePath(sampleContract).then(path => {
                        console.log('✅ Sample contract Firebase path:', path);
                        console.log('🔍 Contract details:', {
                            contractId: sampleContract.contractId || sampleContract.id,
                            firebaseId: sampleContract.firebaseId,
                            currentStatus: sampleContract.status,
                            approvalStatus: sampleContract.approvalStatus
                        });
                        
                        console.log('🎯 Path Analysis:');
                        if (path.includes('companies/')) {
                            console.log('  ✅ Using company-scoped path (CORRECT)');
                            console.log('  ✅ This matches the loadContracts() reading path');
                        } else {
                            console.log('  ⚠️ Using global path');
                            console.log('  ⚠️ This may not match the loadContracts() reading path');
                        }
                        
                        console.log('🔧 Fix Status: All Firebase update operations now use dynamic path resolution');
                        console.log('📋 Expected Behavior: When contract is approved, it will be moved to completed status and appear in Complete tab');
                    }).catch(error => {
                        console.error('❌ Error getting contract path:', error);
                    });
                } else {
                    console.log('❌ No contracts available for testing');
                }
                
                console.log('=== END SYNC TEST ===');
            };
            
            // Test approved contract button visibility
            window.testApprovedContractButtons = function() {
                console.log('=== TESTING APPROVED CONTRACT BUTTON VISIBILITY ===');
                
                if (contracts.length === 0) {
                    console.log('❌ No contracts loaded - run loadContracts() first');
                    return;
                }
                
                console.log('🔍 Checking button visibility for approved contracts...');
                const approvedContracts = contracts.filter(contract => 
                    (contract.status === 'completed' && contract.approvalStatus === 'approved') || 
                    contract.status === 'approved'
                );
                
                console.log(`📊 Found ${approvedContracts.length} approved contracts:`, approvedContracts);
                
                if (approvedContracts.length > 0) {
                    console.log('✅ Expected Behavior: These contracts should show only Close/Download/Email buttons when opened in modal');
                    console.log('✅ Action buttons (Approve/Decline/Edit/Delete) should be hidden');
                    console.log('💡 Test by opening one of these contracts in the modal');
                } else {
                    console.log('⚠️ No approved contracts found to test');
                    console.log('💡 Approve a contract first, then run this test');
                }
                
                console.log('=== END BUTTON VISIBILITY TEST ===');
                
                return {
                    totalContracts: contracts.length,
                    approvedContracts: approvedContracts.length,
                    approvedContractIds: approvedContracts.map(c => c.contractId || c.id)
                };
            };        });

        // Initialize page restrictions (before authentication)
        function initializePageRestrictions() {
            console.log('Initializing page restrictions...');
            
            // Add restricted class to main content
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.classList.add('page-restricted');
            }
            
            // Disable interactive elements initially
            const interactiveElements = document.querySelectorAll('button:not(.profile-btn), input, select, textarea');
            interactiveElements.forEach(element => {
                element.disabled = true;
            });
            
            console.log('Page restrictions applied');
        }

        // Initialize contract page
        function initializeContractPage() {
            console.log('Initializing Contract Management page...');
            
            // Add event listeners
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('exportBtn').addEventListener('click', exportContracts);
            
            // Add sidebar toggle event listener
            const sidebarToggle = document.querySelector('#sidebarToggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', toggleSidebar);
            }
            
            // Restore sidebar state
            restoreSidebarState();
            
            // Add event listeners for complete tab
            document.getElementById('completeSearchInput').addEventListener('input', handleCompleteSearch);
            document.getElementById('exportCompleteBtn').addEventListener('click', exportCompleteContracts);
            
            // Initialize tabs
            initializeTabs();
        }

        // Initialize authentication
        function initializeAuth() {
            auth.onAuthStateChanged(async function(user) {
                if (user) {
                    currentUser = user;
                    console.log('User authenticated:', user.email, 'UID:', user.uid);
                    updateUserProfile(user);
                    // Load company branding for authenticated users
                    await loadCompanyBranding();
                    // Update menu visibility based on user permissions
                    await updateMenuWithFeatureAuthorization();
                } else {
                    console.log('No user authenticated - continuing with guest access');
                    currentUser = null;
                    // Show guest profile with initials
                    const profileBtn = document.querySelector('.profile-btn');
                    if (profileBtn) {
                        const profileImg = profileBtn.querySelector('img');
                        const avatarInitials = profileBtn.querySelector('.avatar-initials');
                        
                        // Hide image, show initials for guest
                        if (profileImg) {
                            profileImg.style.display = 'none';
                            profileImg.classList.remove('loaded');
                        }
                        if (avatarInitials) {
                            avatarInitials.textContent = 'GU';
                            avatarInitials.style.backgroundColor = '#6c757d'; // Gray for guest
                            avatarInitials.style.display = 'flex';
                        }
                        
                        // Update profile dropdown for guest
                        const profileDropdown = document.querySelector('.profile-dropdown ul');
                        if (profileDropdown) {
                            const guestInfoHtml = `
                                <li style="border-bottom: 1px solid #eee; padding: 12px 16px; background: #f8f9fa;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="width: 32px; height: 32px; border-radius: 50%; background: #6c757d; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px;">GU</div>
                                        <div>
                                            <div style="font-weight: 600; color: #333; font-size: 14px; margin-bottom: 2px;">
                                                Guest User
                                            </div>
                                            <div style="color: #666; font-size: 12px;">
                                                Not signed in
                                            </div>
                                        </div>
                                    </div>
                                </li>
                                <li><a href="login.html"><i class="fas fa-sign-in-alt"></i> Sign In</a></li>
                            `;
                            profileDropdown.innerHTML = guestInfoHtml;
                        }
                    }
                    // Reset branding for guest users
                    resetHeaderBranding();
                    // Update menu visibility for guest users
                    await updateMenuWithFeatureAuthorization();
                }
                
                // Enable page access and load contracts for both authenticated and guest users
                enablePageAccess();
            });
        }

        // Enable full page access for authenticated users
        function enablePageAccess() {
            console.log('Enabling page access for user:', currentUser ? currentUser.email : 'guest');
            
            // Remove page restrictions
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.classList.remove('page-restricted');
                mainContent.classList.add('page-unrestricted');
            }
            
            // Remove any disabled states or restrictions
            const disabledElements = document.querySelectorAll('[disabled]');
            disabledElements.forEach(element => {
                element.removeAttribute('disabled');
            });
            
            // Show any hidden content for authenticated users
            const restrictedElements = document.querySelectorAll('.auth-required');
            restrictedElements.forEach(element => {
                element.style.display = 'block';
                element.classList.add('authenticated');
            });
            
            // Enable all interactive elements
            const interactiveElements = document.querySelectorAll('button, input, select, textarea');
            interactiveElements.forEach(element => {
                element.disabled = false;
            });
            
            // Load contract data regardless of authentication status
            console.log('Loading contract data...');
            loadContracts();
            loadTemplates();
            
            // Update user profile if authenticated
            if (currentUser) {
                updateUserProfile(currentUser);
            } else {
                // Show guest profile or hide profile section
                const userAvatarInitials = document.getElementById('userAvatarInitials');
                if (userAvatarInitials) {
                    userAvatarInitials.textContent = 'G'; // G for Guest
                }
            }
            
            console.log('Page access enabled');
        }

        // Update user profile in UI
        async function updateUserProfile(user) {
            await updateUIForAuthenticatedUser(user);
        }

        // Reset header branding elements
        function resetHeaderBranding() {
            console.log('🔄 resetHeaderBranding() - clearing all branding elements');
            
            const headerCompanyLogo = document.getElementById('headerCompanyLogo');
            const headerCompanyName = document.getElementById('headerCompanyName');
            
            // Hide all elements first
            if (headerCompanyLogo) {
                headerCompanyLogo.style.display = 'none';
                headerCompanyLogo.classList.remove('visible');
                headerCompanyLogo.src = '';
            }
            
            if (headerCompanyName) {
                headerCompanyName.textContent = '';
            }
        }

        // Update header branding with company information
        function updateHeaderBranding(companyData) {
            if (!companyData) {
                resetHeaderBranding();
                return;
            }

            console.log('🏢 Updating company branding for:', companyData.companyName);

            // First reset all header branding elements to ensure clean state
            resetHeaderBranding();

            // Update page title if needed
            const title = document.title;
            if (title.includes('Dreamex Datalab HSE')) {
                document.title = title.replace('Dreamex Datalab HSE', `${companyData.companyName} HSE`);
            }

            // Update header branding elements
            const headerLogo = document.getElementById('headerCompanyLogo');
            const headerName = document.getElementById('headerCompanyName');

            console.log('🎯 Header elements found:');
            console.log('- headerLogo:', headerLogo ? '✅' : '❌');
            console.log('- headerName:', headerName ? '✅' : '❌');

            // Update company name first
            if (headerName && companyData.companyName) {
                headerName.textContent = companyData.companyName;
                console.log('✅ Company name updated in header:', companyData.companyName);
            }

            // Check if company has a logo (try both 'logo' and 'logoUrl' properties)
            const logoUrl = companyData.logo || companyData.logoUrl;
            if (logoUrl && logoUrl.trim() !== '') {
                console.log('🖼️ Company has logo URL:', logoUrl);
                // Show the logo
                if (headerLogo) {
                    headerLogo.src = logoUrl;
                    headerLogo.style.display = 'block';
                    headerLogo.classList.add('visible');
                    console.log('✅ Company logo displayed');
                }
            } else {
                console.log('🏢 No logo URL available');
                // Hide logo if no URL
                if (headerLogo) {
                    headerLogo.style.display = 'none';
                    headerLogo.classList.remove('visible');
                    console.log('✅ Company logo hidden (no URL)');
                }
            }
        }

        // Load company data and update branding
        async function loadCompanyBranding() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    console.log('No authenticated user, skipping company branding');
                    return;
                }

                console.log('🔍 Loading company data for user:', user.uid);
                
                // Get user's company association
                const userRef = database.ref(`users/${user.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();
                
                if (userData && userData.companyId) {
                    console.log('👤 User belongs to company:', userData.companyId);
                    
                    // Get company data
                    const companyRef = database.ref(`companies/${userData.companyId}`);
                    const companySnapshot = await companyRef.once('value');
                    const companyData = companySnapshot.val();
                    
                    if (companyData) {
                        console.log('🏢 Company data loaded:', companyData.companyName);
                        updateHeaderBranding(companyData);
                    } else {
                        console.log('❌ No company data found');
                        resetHeaderBranding();
                    }
                } else {
                    console.log('👤 User has no company association');
                    resetHeaderBranding();
                }
            } catch (error) {
                console.error('❌ Error loading company branding:', error);
                resetHeaderBranding();
            }
        }

        // Load contracts from database        // Load contracts from Firebase with real-time updates
        async function loadContracts() {
            try {
                showLoadingState(true);
                console.log('Loading contracts from Firebase...');
                
                // Get current user's company ID dynamically
                const user = auth.currentUser;
                if (user) {
                    console.log('🔍 Getting company ID for user:', user.uid);
                    
                    // Get user's company association
                    const userRef = database.ref(`users/${user.uid}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.companyId) {
                        console.log('✅ User belongs to company:', userData.companyId);
                        loadCompanyContracts(userData.companyId);
                    } else {
                        console.log('⚠️ User has no company association, loading global contracts');
                        loadGlobalContracts();
                    }
                } else {
                    console.log('⚠️ No authenticated user, loading global contracts');
                    loadGlobalContracts();
                }
                
            } catch (error) {
                console.error('Error setting up contracts listener:', error);
                // Show empty state on error
                contracts = [];
                displayActiveContracts();
                updateStats();
                showLoadingState(false);
            }
        }
        
        // Load contracts from company-scoped path
        function loadCompanyContracts(companyId) {
            console.log('🏢 Loading contracts for company:', companyId);
            console.log('🔗 Firebase path:', `companies/${companyId}/contracts`);
            
            // Set up real-time listener for company-scoped contracts
            database.ref(`companies/${companyId}/contracts`).on('value', (snapshot) => {
                const contractsData = snapshot.val() || {};
                console.log('✅ Company contracts data received:', contractsData);
                console.log('📊 Number of contracts found:', Object.keys(contractsData).length);
                
                processContractsData(contractsData, 'company-scoped');
                
            }, (error) => {
                console.error('❌ Error loading company contracts:', error);
                console.error('❌ Failed path:', `companies/${companyId}/contracts`);
                // Show empty state on error instead of fallback
                contracts = [];
                displayActiveContracts();
                updateStats();
                showLoadingState(false);
            });
        }
        
        // Load contracts from global path (fallback)
        function loadGlobalContracts() {
            console.log('🌐 Loading global contracts (fallback)');
            
            // Set up real-time listener for global contracts
            database.ref('contracts').on('value', (snapshot) => {
                const contractsData = snapshot.val() || {};
                console.log('⚠️ Global contracts data received:', contractsData);
                
                processContractsData(contractsData, 'global');
                
            }, (error) => {
                console.error('❌ Error loading global contracts:', error);
                // Show empty state on error
                contracts = [];
                displayActiveContracts();
                updateStats();
                showLoadingState(false);
            });
        }
        
        // Process contracts data (common function for both company and global)
        function processContractsData(contractsData, source) {
            console.log(`📊 Processing ${source} contracts data:`, Object.keys(contractsData).length, 'contracts found');
            console.log('🔍 Raw contractsData:', contractsData);
            
            // Convert Firebase object to array with complete custom fields data
            let firebaseContracts = Object.entries(contractsData).map(([firebaseId, contract]) => {
                console.log(`Processing contract ${firebaseId}:`, contract);
                
                // Log custom fields data for debugging
                console.log(`Custom fields for ${firebaseId}:`, {
                    customFields: contract.customFields,
                    customFieldsData: contract.customFieldsData,
                    customSections: contract.customSections,
                    customSectionsData: contract.customSectionsData
                });
                
                return {
                    firebaseId: firebaseId,
                    id: contract.contractId || firebaseId,
                    contractId: contract.contractId || firebaseId,
                    employeeName: contract.employeeName || contract.employee?.name || 'Unknown',
                    employeeId: contract.employeeId || contract.employee?.id || 'Unknown',
                    employeeEmail: contract.employeeEmail || contract.employee?.email || 'No email',
                    employee: contract.employee || {},
                    department: contract.department || contract.employee?.department || 'Unknown',
                    position: contract.positionTitle || contract.employee?.position || 'Unknown',
                    positionTitle: contract.positionTitle || contract.employee?.position || 'Unknown',
                    contractType: contract.contractType || 'permanent',
                    startDate: contract.startDate || 'Unknown',
                    endDate: contract.endDate || 'Permanent',
                    status: contract.status || 'active',
                    salaryAmount: contract.salaryAmount || 0,
                    salaryType: contract.salaryType || 'annual',
                    salary: contract.salaryAmount ? `$${contract.salaryAmount.toLocaleString()}` : '$0',
                    workingHours: contract.workingHours || 40,
                    probationPeriod: contract.probationPeriod || 0,
                    noticePeriod: contract.noticePeriod || 30,
                    benefits: contract.benefits || [],
                    annualLeave: contract.annualLeave || 20,
                    sickLeave: contract.sickLeave || 10,
                    additionalBenefits: contract.additionalBenefits || '',
                    specialTerms: contract.specialTerms || '',
                    template: contract.template || {},
                    formVersion: contract.formVersion || '1.0',
                    version: contract.version || 1,
                    createdAt: contract.createdAt,
                    createdBy: contract.createdBy,
                    lastModified: contract.lastModified,
                    dataCollectionTimestamp: contract.dataCollectionTimestamp,
                    companyId: contract.companyId, // Include company ID for reference
                    
                    // Include ALL possible custom field variations from Firebase
                    customFields: contract.customFields || {},
                    customFieldsData: contract.customFieldsData || {},
                    customSections: contract.customSections || {},
                    customSectionsData: contract.customSectionsData || {},
                    
                    // Keep the original raw contract data for fallback
                    _rawContract: contract,
                    _dataSource: source // Track data source for debugging
                };
            });
            
            // If no contracts in Firebase, show empty state
            if (firebaseContracts.length === 0) {
                console.log(`❌ No contracts found in ${source} collection`);
                contracts = [];
            } else {
                console.log(`✅ Setting ${firebaseContracts.length} contracts in global contracts array`);
                contracts = firebaseContracts;
            }
            
            console.log(`✅ Loaded ${contracts.length} contracts from ${source} collection`);
            console.log('🔍 Final contracts array:', contracts);
            displayActiveContracts();
            updateStats();
            showLoadingState(false);
        }        // Test Firebase contract fetching
        function testFirebaseContractFetch() {
            console.log('=== TESTING FIREBASE CONTRACT FETCH ===');
            
            fetch('https://users-8be65-default-rtdb.firebaseio.com/contracts.json')
                .then(response => response.json())
                .then(data => {
                    console.log('Raw Firebase data:', data);
                    
                    // Check each contract for custom fields
                    Object.entries(data || {}).forEach(([contractId, contract]) => {
                        console.log(`\n--- Contract ${contractId} ---`);
                        console.log('customFields:', contract.customFields);
                        console.log('customFieldsData:', contract.customFieldsData);
                        console.log('customSections:', contract.customSections);
                        console.log('customSectionsData:', contract.customSectionsData);
                        
                        // Count custom field properties
                        const customFieldCount = Object.keys(contract.customFields || {}).length;
                        const customFieldDataCount = Object.keys(contract.customFieldsData || {}).length;
                        const customSectionCount = Object.keys(contract.customSections || {}).length;
                        const customSectionDataCount = Object.keys(contract.customSectionsData || {}).length;
                        
                        console.log(`Custom field counts: Fields=${customFieldCount}, FieldsData=${customFieldDataCount}, Sections=${customSectionCount}, SectionsData=${customSectionDataCount}`);
                    });
                })
                .catch(error => {
                    console.error('Error fetching Firebase data:', error);
                });
        }

        // Test function to show approval flow demo
        function testApprovalFlowDisplay() {
            console.log('Testing approval flow display...');
            
            // Mock contract data with approval information
            const mockContract = {
                id: 'test-contract-001',
                contractId: 'CT-2024-001',
                employeeName: 'John Doe',
                status: 'pending',
                approvalStatus: 'In Progress',
                currentApprover: 'HR Manager',
                approvalHistory: {
                    1: {
                        status: 'approved',
                        approver: 'Direct Manager',
                        comments: 'Approved by direct supervisor',
                        timestamp: new Date().toISOString()
                    },
                    2: {
                        status: 'pending',
                        approver: 'HR Manager',
                        comments: null,
                        timestamp: null
                    }
                }
            };
            
            // Show the modal with mock data
            showContractModal(mockContract);
        }        // Make test function available globally
        window.testApprovalFlowDisplay = testApprovalFlowDisplay;

        // Display only active contracts (filter out completed ones)
        function displayActiveContracts() {
            console.log('🔍 displayActiveContracts() called');
            console.log('📊 Total contracts available:', contracts.length);
            console.log('📋 Contracts data:', contracts);
            
            // Debug each contract's status in detail
            if (contracts.length > 0) {
                console.log('📋 Individual contract analysis:');
                contracts.forEach((contract, index) => {
                    const status = contract.status;
                    const willBeFiltered = status === 'completed';
                    console.log(`  Contract ${index + 1}:`, {
                        id: contract.contractId || contract.id,
                        employeeName: contract.employeeName,
                        status: status,
                        statusType: typeof status,
                        willBeFiltered: willBeFiltered,
                        rawContract: contract
                    });
                });
            } else {
                console.log('❌ No contracts in global contracts array!');
            }
            
            const activeContracts = contracts.filter(contract => 
                contract.status !== 'completed'
            );
            console.log(`✅ Active contracts after filtering: ${activeContracts.length} out of ${contracts.length} total`);
            console.log('🎯 Active contracts to display:', activeContracts);
            
            // Additional debugging for active contracts
            if (activeContracts.length > 0) {
                console.log('✅ Active contracts details:');
                activeContracts.forEach((contract, index) => {
                    console.log(`  ${index + 1}. ${contract.employeeName || 'No Name'} - Status: ${contract.status} - ID: ${contract.contractId || contract.id}`);
                });
            } else {
                console.log('❌ No active contracts found after filtering!');
                console.log('🔍 This could mean:');
                console.log('  1. All contracts have status="completed"');
                console.log('  2. Contracts array is empty');
                console.log('  3. Contract status values are unexpected');
            }
            
            displayContracts(activeContracts);
        }

        // Display contracts in table
        function displayContracts(contractsToShow) {
            console.log('🔍 displayContracts() called with:', contractsToShow?.length || 0, 'contracts');
            console.log('📋 Contracts to show:', contractsToShow);
            
            const tableBody = document.getElementById('contractsTableBody');
            const contractsTable = document.getElementById('contractsTable');
            const emptyState = document.getElementById('emptyState');
            
            console.log('🎯 DOM elements found:', {
                tableBody: !!tableBody,
                contractsTable: !!contractsTable,
                emptyState: !!emptyState
            });
            
            if (!tableBody) {
                console.error('❌ Table body element not found! Cannot display contracts.');
                return;
            }
            
            if (!contractsToShow || contractsToShow.length === 0) {
                console.log('⚠️ No contracts to show - displaying empty state');
                if (contractsTable) contractsTable.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            console.log('✅ Showing contracts table and hiding empty state');
            if (contractsTable) contractsTable.style.display = 'table';
            if (emptyState) emptyState.style.display = 'none';
            
            try {
                tableBody.innerHTML = contractsToShow.map(contract => `
                    <tr onclick="viewContract('${contract.contractId || contract.id}')" style="cursor: pointer;">
                        <td>
                            <div class="employee-info">
                                <div class="employee-avatar">
                                    ${(contract.employee?.name || contract.employeeName || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div class="employee-details">
                                    <div class="employee-name">${contract.employee?.name || contract.employeeName || 'Unknown'}</div>
                                    <div class="employee-id">${contract.employee?.email || contract.employeeEmail || 'No email'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${contract.contractId || contract.id || 'Unknown'}</td>
                        <td>${contract.department || 'Unknown'}</td>
                        <td>${contract.positionTitle || contract.position || 'Unknown'}</td>
                        <td>
                            <span class="contract-type-badge contract-${contract.contractType || 'permanent'}">
                                ${(contract.contractType || 'permanent').charAt(0).toUpperCase() + (contract.contractType || 'permanent').slice(1)}
                            </span>
                        </td>
                        <td>${formatDate(contract.startDate)}</td>
                        <td>${formatDate(contract.endDate)}</td>
                        <td>
                            <span class="status-badge status-${contract.status || 'active'}">
                                ${(contract.status || 'active').charAt(0).toUpperCase() + (contract.status || 'active').slice(1)}
                            </span>
                        </td>
                    </tr>
                `).join('');
                
                console.log('✅ Table HTML generated successfully with', contractsToShow.length, 'rows');
                console.log('📝 Table body innerHTML length:', tableBody.innerHTML.length);
            } catch (error) {
                console.error('❌ Error generating table HTML:', error);
                console.error('❌ Problem contracts:', contractsToShow);
            }
        }

        // Update statistics
        function updateStats() {
            const totalContracts = contracts.length;
            const activeContracts = contracts.filter(c => c.status === 'active').length;
            const approvedContracts = contracts.filter(c => c.status === 'completed' && c.approvalStatus === 'approved').length;
            const pendingRenewal = contracts.filter(c => c.status === 'pending').length;
            const expiringSoon = contracts.filter(c => isExpiringSoon(c.endDate)).length;
            const completedContracts = contracts.filter(c => c.status === 'completed').length;
            
            console.log('📊 STATS UPDATE DEBUG:');
            console.log('  Total contracts:', totalContracts);
            console.log('  Active contracts:', activeContracts);
            console.log('  Approved contracts:', approvedContracts);
            console.log('  Pending renewal:', pendingRenewal);
            console.log('  Expiring soon:', expiringSoon);
            console.log('  Completed contracts:', completedContracts);
            
            // Debug contract statuses
            console.log('📋 Contract status breakdown:');
            const statusCounts = {};
            contracts.forEach(contract => {
                const status = contract.status || 'undefined';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });
            console.log('  Status counts:', statusCounts);
            
            document.getElementById('totalContracts').textContent = totalContracts;
            document.getElementById('activeContracts').textContent = activeContracts;
            document.getElementById('pendingRenewal').textContent = pendingRenewal;
            document.getElementById('expiringSoon').textContent = expiringSoon;
            document.getElementById('completedContracts').textContent = completedContracts;
        }

        // Check if contract is expiring soon (within 30 days)
        function isExpiringSoon(endDate) {
            const today = new Date();
            const contractEndDate = new Date(endDate);
            const timeDiff = contractEndDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            return daysDiff <= 30 && daysDiff > 0;
        }        // Handle search functionality
        function handleSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            console.log('🔍 Search term:', searchTerm);
            
            const filteredContracts = contracts.filter(contract => {
                // First check if it's not completed
                if (contract.status === 'completed') return false;
                
                // If no search term, show all non-completed contracts
                if (!searchTerm.trim()) return true;
                
                // Safe search across multiple fields
                const employeeName = (contract.employeeName || '').toLowerCase();
                const employeeId = (contract.employeeId || '').toLowerCase();
                const department = (contract.department || '').toLowerCase();
                const positionTitle = (contract.positionTitle || contract.position || '').toLowerCase();
                const contractId = (contract.contractId || contract.id || '').toLowerCase();
                
                return employeeName.includes(searchTerm) ||
                       employeeId.includes(searchTerm) ||
                       department.includes(searchTerm) ||
                       positionTitle.includes(searchTerm) ||
                       contractId.includes(searchTerm);
            });
            
            console.log('🎯 Filtered contracts:', filteredContracts.length, 'out of', contracts.length);
            displayContracts(filteredContracts);
        }        // Export contracts
        function exportContracts() {
            const activeContracts = contracts.filter(contract => contract.status !== 'completed');
            console.log('Exporting active contracts...', activeContracts.length);
            alert(`Export active contracts functionality will be implemented.\n\nContracts to export: ${activeContracts.length}\n\nThis will export all visible active contracts (excluding completed contracts) to CSV/Excel format.`);
        }// Load completed contracts from Firebase
        function loadCompleteContracts() {
            try {
                showCompleteLoadingState(true);
                console.log('Loading completed contracts from Firebase...');
                
                // Check if user is authenticated and has company context
                const user = auth.currentUser;
                if (user) {
                    console.log('🔍 User authenticated, checking for company context for completed contracts...');
                    
                    // Get user's company ID first
                    database.ref(`users/${user.uid}`).once('value')
                        .then((userSnapshot) => {
                            const userData = userSnapshot.val();
                            
                            if (userData && userData.companyId) {
                                console.log('✅ Loading company-scoped completed contracts for company:', userData.companyId);
                                // Load completed contracts from company-scoped path
                                loadCompanyCompleteContracts(userData.companyId);
                            } else {
                                console.log('⚠️ No company context found, loading global completed contracts');
                                // Fallback to global completed contracts
                                loadGlobalCompleteContracts();
                            }
                        })
                        .catch((error) => {
                            console.error('❌ Error getting user company data for completed contracts:', error);
                            // Fallback to global completed contracts on error
                            loadGlobalCompleteContracts();
                        });
                } else {
                    console.log('⚠️ No user authenticated, loading global completed contracts');
                    // Load global completed contracts for unauthenticated users
                    loadGlobalCompleteContracts();
                }
                
            } catch (error) {
                console.error('Error setting up completed contracts listener:', error);
                displayCompleteContracts([]);
                showCompleteLoadingState(false);
            }
        }
        
        // Load completed contracts from company-scoped path
        function loadCompanyCompleteContracts(companyId) {
            console.log('🏢 Loading completed contracts for company:', companyId);
            
            // Set up real-time listener for company-scoped completed contracts
            database.ref(`companies/${companyId}/contracts`).orderByChild('status').equalTo('completed').on('value', (snapshot) => {
                const contractsData = snapshot.val() || {};
                console.log('✅ Company completed contracts data received:', contractsData);
                
                processCompleteContractsData(contractsData, 'company-scoped');
                
            }, (error) => {
                console.error('❌ Error loading company completed contracts:', error);
                // Fallback to global completed contracts on error
                loadGlobalCompleteContracts();
            });
        }
        
        // Load completed contracts from global path (fallback)
        function loadGlobalCompleteContracts() {
            console.log('🌐 Loading global completed contracts (fallback)');
            
            // Set up real-time listener for global completed contracts
            database.ref('contracts').orderByChild('status').equalTo('completed').on('value', (snapshot) => {
                const contractsData = snapshot.val() || {};
                console.log('⚠️ Global completed contracts data received:', contractsData);
                
                processCompleteContractsData(contractsData, 'global');
                
            }, (error) => {
                console.error('❌ Error loading global completed contracts:', error);
                displayCompleteContracts([]);
                showCompleteLoadingState(false);
            });
        }
        
        // Process completed contracts data (common function for both company and global)
        function processCompleteContractsData(contractsData, source) {
            console.log(`📊 Processing ${source} completed contracts data:`, Object.keys(contractsData).length, 'contracts found');
            
            // Convert Firebase object to array
            let completeContracts = Object.entries(contractsData).map(([firebaseId, contract]) => {
                return {
                    firebaseId: firebaseId,
                    id: contract.contractId || firebaseId,
                    contractId: contract.contractId || firebaseId,
                    employeeName: contract.employeeName || contract.employee?.name || 'Unknown',
                    employeeId: contract.employeeId || contract.employee?.id || 'Unknown',
                    employeeEmail: contract.employeeEmail || contract.employee?.email || 'No email',
                    employee: contract.employee || {},
                    department: contract.department || contract.employee?.department || 'Unknown',
                    position: contract.positionTitle || contract.employee?.position || 'Unknown',
                    contractType: contract.contractType || 'permanent',
                    startDate: contract.startDate || 'Unknown',
                    endDate: contract.endDate || 'Permanent',
                    completionDate: contract.completionDate || contract.approvedAt || contract.lastModified || 'Unknown',
                    status: contract.status || 'completed',
                    salaryAmount: contract.salaryAmount || 0,
                    createdAt: contract.createdAt,
                    lastModified: contract.lastModified,
                    approvedBy: contract.approvedBy || 'Unknown',
                    approvedAt: contract.approvedAt || 'Unknown',
                    companyId: contract.companyId, // Include company ID for reference
                    _dataSource: source // Track data source for debugging
                };
            });
            
            console.log(`✅ Loaded ${completeContracts.length} completed contracts from ${source} collection`);
            displayCompleteContracts(completeContracts);
            showCompleteLoadingState(false);
        }        // Export completed contracts
        function exportCompleteContracts() {
            console.log('Exporting completed contracts...');
            
            // Get visible completed contracts
            const visibleRows = document.querySelectorAll('#completeContractsTable tbody tr:not([style*="display: none"])');
            
            if (visibleRows.length === 0) {
                alert('No completed contracts to export');
                return;
            }
            
            // For now, show a summary of what would be exported
            alert(`Export completed contracts functionality will be implemented.\n\nContracts to export: ${visibleRows.length}\n\nThis will export all visible completed contracts to CSV/Excel format.`);
        }// Search completed contracts
        function handleCompleteSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            console.log('Searching completed contracts for:', searchTerm);
            
            // Get all completed contracts from the displayed table
            const allRows = document.querySelectorAll('#completeContractsTable tbody tr');
            
            allRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show/hide empty state based on visible rows
            const visibleRows = document.querySelectorAll('#completeContractsTable tbody tr[style=""]');
            const table = document.getElementById('completeContractsTable');
            const emptyState = document.getElementById('completeEmptyState');
            
            if (visibleRows.length === 0 && searchTerm.trim() !== '') {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.innerHTML = `
                    <i class="fas fa-search"></i>
                    <h3>No matches found</h3>
                    <p>No completed contracts match your search criteria.</p>
                `;
            } else if (visibleRows.length > 0) {
                table.style.display = 'table';
                emptyState.style.display = 'none';
            }
        }

        // Show/hide loading state for complete contracts
        function showCompleteLoadingState(show) {
            const loadingState = document.getElementById('completeLoadingState');
            const contractsTable = document.getElementById('completeContractsTable');
            
            if (loadingState && contractsTable) {
                if (show) {
                    loadingState.style.display = 'block';
                    contractsTable.style.display = 'none';
                } else {
                    loadingState.style.display = 'none';
                }
            }
        }        // Display completed contracts
        function displayCompleteContracts(completeContracts) {
            const tableBody = document.getElementById('completeContractsTableBody');
            const table = document.getElementById('completeContractsTable');
            const emptyState = document.getElementById('completeEmptyState');
            
            if (!tableBody) {
                console.warn('Complete contracts table body not found');
                return;
            }
            
            // Clear existing content
            tableBody.innerHTML = '';
            
            if (!completeContracts || completeContracts.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            table.style.display = 'table';
            emptyState.style.display = 'none';
            
            completeContracts.forEach(contract => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => viewCompleteContract(contract.firebaseId);
                row.innerHTML = `
                    <td>
                        <div class="employee-info">
                            <div class="employee-avatar">
                                ${(contract.employeeName || 'U').charAt(0)}
                            </div>
                            <div class="employee-details">
                                <div class="employee-name">${contract.employeeName}</div>
                                <div class="employee-id">${contract.employeeEmail || 'No email'}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="contract-id">${contract.contractId}</span></td>
                    <td><span class="department-tag">${contract.department}</span></td>
                    <td>${contract.position}</td>
                    <td>
                        <span class="contract-type-badge contract-${contract.contractType.toLowerCase()}">
                            ${contract.contractType.charAt(0).toUpperCase() + contract.contractType.slice(1)}
                        </span>
                    </td>
                    <td>${formatDate(contract.startDate)}</td>
                    <td>${formatDate(contract.endDate)}</td>
                    <td>${formatDate(contract.completionDate)}</td>
                    <td>
                        <span class="status-badge status-${contract.approvalStatus === 'approved' ? 'approved' : 'completed'}">
                            <i class="fas fa-${contract.approvalStatus === 'approved' ? 'check-double' : 'check-circle'}"></i>
                            ${contract.approvalStatus === 'approved' ? 'Approved' : 'Completed'}
                        </span>
                    </td>
                    <!-- <td>
                        <div class="action-buttons" onclick="event.stopPropagation();">
                            <button class="btn-action btn-view" onclick="viewCompleteContract('${contract.firebaseId}')" title="View Contract">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-download" onclick="downloadCompleteContract('${contract.firebaseId}')" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td> -->
                `;
                tableBody.appendChild(row);
            });
              console.log(`Displayed ${completeContracts.length} completed contracts`);
        }

        // View completed contract details
        function viewCompleteContract(firebaseId) {
            console.log('Viewing completed contract:', firebaseId);
            // Find the contract and show in modal
            database.ref(`contracts/${firebaseId}`).once('value')
                .then((snapshot) => {
                    const contractData = snapshot.val();
                    if (contractData) {
                        // Convert and show in modal
                        const contract = {
                            ...contractData,
                            firebaseId: firebaseId,
                            id: contractData.contractId || firebaseId
                        };
                        showContractModal(contract);
                    } else {
                        showError('Contract not found');
                    }
                })
                .catch((error) => {
                    console.error('Error fetching contract:', error);
                    showError('Failed to load contract details');
                });
        }

        // Download completed contract
        function downloadCompleteContract(firebaseId) {
            console.log('Downloading completed contract:', firebaseId);
            alert('Download completed contract functionality will be implemented');
        }

        // View contract details
        function viewContract(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (contract) {
                showContractModal(contract);
            }
        }        // Show contract modal
        function showContractModal(contract) {
            // Store the contract for editing purposes
            currentViewedContract = contract;
            
            // Show permissions loading state
            const modalFooter = document.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.classList.add('permissions-loading');
            }
            
            // Populate employee information
            document.getElementById('modalEmployeeName').textContent = contract.employee?.name || contract.employeeName || 'N/A';
            document.getElementById('modalEmployeeId').textContent = contract.employee?.id || contract.employeeId || 'N/A';
            document.getElementById('modalEmployeeDepartment').textContent = contract.employee?.department || 'N/A';
            document.getElementById('modalEmployeePosition').textContent = contract.employee?.position || 'N/A';
            document.getElementById('modalEmployeeEmail').textContent = contract.employee?.email || 'N/A';
            document.getElementById('modalOfferId').textContent = contract.employee?.offerId || 'N/A';
            
            // Populate contract information
            document.getElementById('modalContractId').textContent = contract.contractId || contract.id || 'N/A';
            document.getElementById('modalContractType').textContent = contract.contractType || 'N/A';
            document.getElementById('modalDepartment').textContent = contract.department || 'N/A';
            document.getElementById('modalPosition').textContent = contract.positionTitle || contract.position || 'N/A';
            document.getElementById('modalStartDate').textContent = formatDate(contract.startDate) || 'N/A';
            document.getElementById('modalEndDate').textContent = formatDate(contract.endDate) || 'N/A';
            document.getElementById('modalStatus').textContent = contract.status || 'N/A';
            
            // Populate salary information
            document.getElementById('modalSalaryAmount').textContent = contract.salaryAmount ? `$${contract.salaryAmount.toLocaleString()}` : 'N/A';
            document.getElementById('modalSalaryType').textContent = contract.salaryType || 'N/A';
            
            // Populate work terms
            document.getElementById('modalWorkingHours').textContent = contract.workingHours ? `${contract.workingHours} hours/week` : 'N/A';
            document.getElementById('modalProbationPeriod').textContent = contract.probationPeriod ? `${contract.probationPeriod} months` : 'N/A';
            document.getElementById('modalNoticePeriod').textContent = contract.noticePeriod ? `${contract.noticePeriod} days` : 'N/A';
            
            // Populate benefits and leave
            if (Array.isArray(contract.benefits)) {
                document.getElementById('modalBenefits').textContent = contract.benefits.join(', ') || 'N/A';
            } else {
                document.getElementById('modalBenefits').textContent = contract.benefits || 'N/A';
            }
            document.getElementById('modalAnnualLeave').textContent = contract.annualLeave ? `${contract.annualLeave} days` : 'N/A';
            document.getElementById('modalSickLeave').textContent = contract.sickLeave ? `${contract.sickLeave} days` : 'N/A';
            
            // Populate additional information
            document.getElementById('modalAdditionalTerms').textContent = contract.additionalTerms || 'N/A';
            document.getElementById('modalTemplate').textContent = contract.template ? `${contract.template.name} (${contract.template.type})` : 'N/A';
            document.getElementById('modalFormVersion').textContent = contract.formVersion || 'N/A';
            document.getElementById('modalVersion').textContent = contract.version || 'N/A';
            
            // Populate audit trail
            document.getElementById('modalCreatedAt').textContent = contract.createdAt ? formatDateTime(contract.createdAt) : 'N/A';
            document.getElementById('modalCreatedBy').textContent = getCreatedByText(contract.createdBy) || 'N/A';
            document.getElementById('modalLastModified').textContent = contract.lastModified ? formatDateTime(contract.lastModified) : 'N/A';
            document.getElementById('modalDataCollectionTimestamp').textContent = contract.dataCollectionTimestamp ? formatDateTime(contract.dataCollectionTimestamp) : 'N/A';
              // Handle custom fields
            populateCustomFields(contract);
              // Populate approval flow (async) and set button permissions
            populateApprovalFlow(contract).then(() => {
                // Update button visibility based on user permissions after approval flow is loaded
                updateModalButtonPermissions(contract);
            }).catch(error => {
                console.error('Error populating approval flow:', error);
                // Still update button permissions even if approval flow fails
                updateModalButtonPermissions(contract);
            });
            
            // Show modal
            document.getElementById('contractModal').style.display = 'flex';
            
            // Set up real-time listener for this contract to keep modal updated
            if (contract.firebaseId) {
                setupContractRealTimeListener(contract.firebaseId);
            }
        }

        // Update modal button permissions based on user role and approval flow
        async function updateModalButtonPermissions(contract) {
            try {
                console.log('Updating modal button permissions for contract:', contract.id || contract.contractId);
                
                // Reset all button permissions first
                resetButtonPermissions();
                
                // Check if contract is approved - if so, hide all action buttons
                if ((contract.status === 'completed' && contract.approvalStatus === 'approved') || 
                    contract.status === 'approved') {
                    console.log('Contract is approved - hiding all action buttons');
                    hideAllActionButtons();
                    updatePermissionsInfo('approved');
                    removePermissionsLoadingState();
                    return;
                }
                
                // Get current user
                const user = auth.currentUser;
                if (!user) {
                    console.log('No authenticated user, showing view-only buttons');
                    showViewOnlyButtons();
                    removePermissionsLoadingState();
                    return;
                }

                // Get user data from Firebase
                const userRef = database.ref(`users/${user.uid}`);
                const userSnapshot = await userRef.once('value');
                const userData = userSnapshot.val();
                
                if (!userData) {
                    console.log('No user data found, showing view-only buttons');
                    showViewOnlyButtons();
                    removePermissionsLoadingState();
                    return;
                }

                console.log('Current user data:', userData);

                // Check if user is an approver in the contract's approval flow
                const isApprover = await checkIfUserIsApprover(contract, user, userData);
                
                // Check if user has admin permissions or created the contract
                const isAdmin = await checkUserAdminPermissions(userData);
                const isCreator = checkIfUserIsCreator(contract, user, userData);

                console.log('Permission checks:', {
                    isApprover,
                    isAdmin,
                    isCreator,
                    userId: user.uid,
                    userEmail: user.email,
                    userRole: userData.role
                });

                // Determine button visibility based on user permissions
                let buttonMode = 'view-only';
                
                if (isAdmin) {
                    buttonMode = 'admin';
                    console.log('User has admin permissions - showing all buttons');
                } else if (isCreator && isApprover) {
                    buttonMode = 'creator-approver';
                    console.log('User is both creator and approver - showing all buttons');
                } else if (isCreator) {
                    buttonMode = 'creator';
                    console.log('User is creator - hiding approval buttons');
                    hideApprovalButtons();
                } else if (isApprover) {
                    buttonMode = 'approver';
                    console.log('User is approver - hiding edit and delete buttons');
                    hideEditButton();
                    hideDeleteButton();
                } else {
                    buttonMode = 'view-only';
                    console.log('User has no special permissions - showing view-only buttons');
                    showViewOnlyButtons();
                }

                // Store the button mode for debugging
                window.currentButtonMode = buttonMode;

                // Update permissions info text
                updatePermissionsInfo(buttonMode, { isApprover, isAdmin, isCreator });

                // Remove loading state
                removePermissionsLoadingState();

            } catch (error) {
                console.error('Error updating modal button permissions:', error);
                // On error, show view-only buttons for security
                showViewOnlyButtons();
                updatePermissionsInfo('error');
                removePermissionsLoadingState();
            }
        }

        // Update permissions info text
        function updatePermissionsInfo(buttonMode, permissions = {}) {
            const permissionsInfo = document.querySelector('.permissions-info');
            const permissionsText = document.getElementById('permissionsText');
            
            if (!permissionsInfo || !permissionsText) return;

            let infoText = '';
            let showInfo = false;

            switch (buttonMode) {
                case 'approved':
                    infoText = 'This contract has been fully approved - no further actions available';
                    showInfo = true;
                    break;
                case 'admin':
                    infoText = 'You have full admin access to this contract';
                    showInfo = true;
                    break;
                case 'creator-approver':
                    infoText = 'You are both the creator and approver of this contract';
                    showInfo = true;
                    break;
                case 'creator':
                    infoText = 'You created this contract (approval buttons hidden - you are not an approver)';
                    showInfo = true;
                    break;
                case 'approver':
                    infoText = 'You can approve/decline this contract (edit/delete buttons hidden - you are not the creator)';
                    showInfo = true;
                    break;
                case 'view-only':
                    infoText = 'You have view-only access to this contract';
                    showInfo = true;
                    break;
                case 'error':
                    infoText = 'Error loading permissions - showing view-only mode';
                    showInfo = true;
                    break;
                default:
                    showInfo = false;
            }

            permissionsText.textContent = infoText;
            permissionsInfo.style.display = showInfo ? 'flex' : 'none';
        }

        // Remove permissions loading state
        function removePermissionsLoadingState() {
            const modalFooter = document.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.classList.remove('permissions-loading');
            }
        }

        // Check if current user is an approver for the contract
        async function checkIfUserIsApprover(contract, user, userData) {
            try {
                // Get approval flow configuration
                const config = await fetchContractApprovalFlowConfig();
                
                if (!config || !config.selectedRoles) {
                    console.log('No approval flow configuration found');
                    return false;
                }

                const userRole = userData.role;
                const userEmail = user.email;
                const userName = userData.name || userData.displayName || userEmail;
                const userId = user.uid;

                console.log('Checking approver status for:', {
                    userRole,
                    userEmail,
                    userName,
                    userId
                });

                // Use the new function to get all approval levels user can access
                const userRoles = userRole ? [userRole] : [];
                const userInfo = {
                    email: userEmail,
                    uid: userId,
                    role: userRole,
                    name: userName
                };
                
                const userApprovalLevels = await getAllUserContractApprovalLevels(config, userRoles, userInfo);
                
                if (userApprovalLevels && userApprovalLevels.length > 0) {
                    console.log(`User has approval access to levels: ${userApprovalLevels.join(', ')}`);
                    return true;
                }

                // Also check if user is specifically mentioned in the contract's approval history
                if (contract.approvalHistory && Array.isArray(contract.approvalHistory)) {
                    for (const history of contract.approvalHistory) {
                        if (history.approverUserId === userId || 
                            (history.approverEmail && history.approverEmail.toLowerCase() === userEmail.toLowerCase()) ||
                            (history.approverName && userName && history.approverName.toLowerCase() === userName.toLowerCase())) {
                            console.log('User found in contract approval history');
                            return true;
                        }
                    }
                }

                // Check if user is assigned as current approver
                if (contract.currentApprover) {
                    const currentApprover = contract.currentApprover.toLowerCase();
                    if (currentApprover === userEmail.toLowerCase() ||
                        currentApprover === userRole.toLowerCase() ||
                        (userName && currentApprover === userName.toLowerCase())) {
                        console.log('User is the current approver');
                        return true;
                    }
                }

                // Check for any assigned approver fields
                if (contract.assignedApprover) {
                    const assignedApprover = contract.assignedApprover.toLowerCase();
                    if (assignedApprover === userEmail.toLowerCase() ||
                        assignedApprover === userRole.toLowerCase() ||
                        (userName && assignedApprover === userName.toLowerCase())) {
                        console.log('User is the assigned approver');
                        return true;
                    }
                }

                console.log('User is not an approver for this contract');
                return false;

            } catch (error) {
                console.error('Error checking if user is approver:', error);
                return false;
            }
        }

        // Check if user has admin permissions
        async function checkUserAdminPermissions(userData) {
            try {
                if (!userData.companyId || !userData.role) {
                    return false;
                }

                // Get role permissions
                const permissionsRef = database.ref(`companies/${userData.companyId}/roles/${userData.role}/permissions`);
                const permissionsSnapshot = await permissionsRef.once('value');
                const permissions = permissionsSnapshot.val();

                if (!permissions) {
                    return false;
                }

                // Check for admin-level contract permissions
                return permissions.contracts && (
                    permissions.contracts.admin === true ||
                    permissions.contracts.manage === true ||
                    permissions.contracts.full_access === true
                );

            } catch (error) {
                console.error('Error checking admin permissions:', error);
                return false;
            }
        }

        // Check if user is the creator of the contract
        function checkIfUserIsCreator(contract, user, userData) {
            try {
                const userEmail = user.email;
                const userName = userData.name || userData.displayName || userEmail;
                const userId = user.uid;

                // Check various creator fields
                if (contract.createdBy) {
                    if (typeof contract.createdBy === 'string') {
                        return contract.createdBy === userEmail || 
                               contract.createdBy === userName ||
                               contract.createdBy === userId;
                    } else if (typeof contract.createdBy === 'object') {
                        return contract.createdBy.email === userEmail ||
                               contract.createdBy.name === userName ||
                               contract.createdBy.uid === userId ||
                               contract.createdBy.id === userId;
                    }
                }

                return false;

            } catch (error) {
                console.error('Error checking if user is creator:', error);
                return false;
            }
        }

        // Button visibility helper functions
        function hideActionButtons() {
            const modalFooter = document.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.className = 'modal-footer view-only';
            }
        }

        function showActionButtons() {
            const modalFooter = document.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.className = 'modal-footer';
            }
        }

        function hideApprovalButtons() {
            const approveBtn = document.querySelector('.modal-footer .btn[onclick*="approveContract"]');
            const declineBtn = document.querySelector('.modal-footer .btn[onclick*="declineContract"]');
            
            if (approveBtn) approveBtn.classList.add('permission-hidden');
            if (declineBtn) declineBtn.classList.add('permission-hidden');
        }

        function hideDeleteButton() {
            const deleteBtn = document.querySelector('.modal-footer .btn[onclick*="deleteContract"]');
            if (deleteBtn) deleteBtn.classList.add('permission-hidden');
        }

        function hideEditButton() {
            const editBtn = document.querySelector('.modal-footer .btn[onclick*="editContract"]');
            if (editBtn) editBtn.classList.add('permission-hidden');
        }

        function showViewOnlyButtons() {
            const modalFooter = document.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.className = 'modal-footer view-only';
            }
        }

        function hideAllActionButtons() {
            const approveBtn = document.querySelector('.modal-footer .btn[onclick*="approveContract"]');
            const declineBtn = document.querySelector('.modal-footer .btn[onclick*="declineContract"]');
            const editBtn = document.querySelector('.modal-footer .btn[onclick*="editContract"]');
            const deleteBtn = document.querySelector('.modal-footer .btn[onclick*="deleteContract"]');
            
            if (approveBtn) approveBtn.classList.add('permission-hidden');
            if (declineBtn) declineBtn.classList.add('permission-hidden');
            if (editBtn) editBtn.classList.add('permission-hidden');
            if (deleteBtn) deleteBtn.classList.add('permission-hidden');
            
            // Also apply view-only style
            const modalFooter = document.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.className = 'modal-footer view-only approved';
            }
        }

        function resetButtonPermissions() {
            // Reset all button permissions
            const modalFooter = document.querySelector('.modal-footer');
            const allButtons = document.querySelectorAll('.modal-footer .btn');
            const permissionsInfo = document.querySelector('.permissions-info');
            
            if (modalFooter) {
                modalFooter.className = 'modal-footer';
            }
            
            allButtons.forEach(button => {
                button.classList.remove('permission-hidden', 'permission-visible');
            });

            // Hide permissions info
            if (permissionsInfo) {
                permissionsInfo.style.display = 'none';
            }
        }

        // Debug function to test button permissions - can be called from browser console
        window.debugButtonPermissions = async function(contractId) {
            try {
                const contract = contracts.find(c => c.id === contractId || c.contractId === contractId);
                if (!contract) {
                    console.error('Contract not found with ID:', contractId);
                    return;
                }

                console.log('=== DEBUGGING BUTTON PERMISSIONS ===');
                console.log('Contract:', contract);
                
                const user = auth.currentUser;
                console.log('Current user:', user);
                
                if (user) {
                    const userRef = database.ref(`users/${user.uid}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();
                    console.log('User data:', userData);
                    
                    const isApprover = await checkIfUserIsApprover(contract, user, userData);
                    const isAdmin = await checkUserAdminPermissions(userData);
                    const isCreator = checkIfUserIsCreator(contract, user, userData);
                    
                    console.log('Permission results:', {
                        isApprover,
                        isAdmin,
                        isCreator
                    });
                    
                    console.log('Current button mode:', window.currentButtonMode);
                }
                
                console.log('=== END DEBUG ===');
            } catch (error) {
                console.error('Error in debug function:', error);
            }
        };

        // Test function to manually check permissions for current user
        window.testCurrentUserPermissions = async function() {
            if (!currentViewedContract) {
                console.error('No contract is currently being viewed');
                return;
            }
            
            await window.debugButtonPermissions(currentViewedContract.id || currentViewedContract.contractId);
        };

        // Helper function to get created by text
        function getCreatedByText(createdBy) {
            if (typeof createdBy === 'object' && createdBy !== null) {
                return createdBy.name || createdBy.email || 'Unknown';
            }
            return createdBy || 'Unknown';
        }

        // Helper function to format date and time
        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        // Helper function to populate custom fields
        function populateCustomFields(contract) {
            const customFieldsSection = document.getElementById('customFieldsSection');
            const customFieldsContainer = document.getElementById('modalCustomFields');
            
            let hasCustomFields = false;
            customFieldsContainer.innerHTML = '';
            
            console.log('Populating custom fields for contract:', contract);
            console.log('Contract template:', contract.template);
            
            // Check for custom fields data
            if (contract.customFieldsData && Object.keys(contract.customFieldsData).length > 0) {
                hasCustomFields = true;
                console.log('Found customFieldsData:', contract.customFieldsData);
                
                // Try to get template to map field IDs to labels
                let fieldLabels = {};
                if (contract.template && contract.template.id) {
                    const template = templates.find(t => t.id === contract.template.id);
                    if (template && template.customFields) {
                        template.customFields.forEach(field => {
                            if (field.id && field.label) {
                                fieldLabels[field.id] = field.label;
                                // Also map by labelId if available
                                if (field.labelId) {
                                    fieldLabels[field.labelId] = field.label;
                                }
                            }
                        });
                    }
                }
                
                Object.entries(contract.customFieldsData).forEach(([key, value]) => {
                    const fieldDiv = document.createElement('div');
                    fieldDiv.className = 'contract-info-item';
                    
                    // Use field label if available, otherwise format the key
                    let displayLabel = fieldLabels[key] || key;
                    if (!fieldLabels[key]) {
                        // If no label found, try to create a readable label from the key
                        displayLabel = key.replace(/^(template_custom_|custom_)/, '')
                                        .replace(/_/g, ' ')
                                        .replace(/\b\w/g, l => l.toUpperCase());
                    }
                    
                    fieldDiv.innerHTML = `
                        <span class="contract-info-label">${displayLabel}:</span>
                        <span class="contract-info-value">${value || 'N/A'}</span>
                    `;
                    customFieldsContainer.appendChild(fieldDiv);
                    
                    console.log(`Added custom field: ${displayLabel} = ${value}`);
                });
            }
            
            // Check for custom sections data
            if (contract.customSectionsData && Object.keys(contract.customSectionsData).length > 0) {
                hasCustomFields = true;
                console.log('Found customSectionsData:', contract.customSectionsData);
                
                Object.entries(contract.customSectionsData).forEach(([sectionKey, sectionData]) => {
                    // Add section header
                    const sectionHeaderDiv = document.createElement('div');
                    sectionHeaderDiv.className = 'contract-info-item';
                    sectionHeaderDiv.style.cssText = 'font-weight: bold; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;';
                    sectionHeaderDiv.innerHTML = `
                        <span class="contract-info-label" style="color: #2c3e50;">Section: ${sectionData.title || sectionKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                        <span class="contract-info-value"></span>
                    `;
                    customFieldsContainer.appendChild(sectionHeaderDiv);
                    
                    if (typeof sectionData === 'object' && sectionData.fields) {
                        // Handle structured section data with fields
                        Object.entries(sectionData.fields).forEach(([fieldKey, fieldData]) => {
                            const fieldDiv = document.createElement('div');
                            fieldDiv.className = 'contract-info-item';
                            
                            let fieldValue = fieldData;
                            let fieldLabel = fieldKey;
                            
                            // If fieldData is an object with value and label
                            if (typeof fieldData === 'object' && fieldData.value !== undefined) {
                                fieldValue = fieldData.value;
                                fieldLabel = fieldData.label || fieldKey;
                            }
                            
                            fieldDiv.innerHTML = `
                                <span class="contract-info-label" style="padding-left: 1rem;">${fieldLabel.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span>
                                <span class="contract-info-value">${fieldValue || 'N/A'}</span>
                            `;
                            customFieldsContainer.appendChild(fieldDiv);
                            
                            console.log(`Added section field: ${fieldLabel} = ${fieldValue}`);
                        });
                    } else if (typeof sectionData === 'object') {
                        // Handle direct field mapping
                        Object.entries(sectionData).forEach(([fieldKey, fieldValue]) => {
                            // Skip metadata fields
                            if (['title', 'description', 'type'].includes(fieldKey)) {
                                return;
                            }
                            
                            const fieldDiv = document.createElement('div');
                            fieldDiv.className = 'contract-info-item';
                            fieldDiv.innerHTML = `
                                <span class="contract-info-label" style="padding-left: 1rem;">${fieldKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span>
                                <span class="contract-info-value">${fieldValue || 'N/A'}</span>
                            `;
                            customFieldsContainer.appendChild(fieldDiv);
                            
                            console.log(`Added section field: ${fieldKey} = ${fieldValue}`);
                        });
                    }
                });
            }
            // Show/hide custom fields section
            customFieldsSection.style.display = hasCustomFields ? 'block' : 'none';
            
            console.log('Custom fields population completed. Has custom fields:', hasCustomFields);
        }

        // Close contract modal
        function closeContractModal() {
            document.getElementById('contractModal').style.display = 'none';
            currentViewedContract = null;
            
            // Reset button permissions when closing modal
            resetButtonPermissions();
            removePermissionsLoadingState();
            
            // Clean up real-time listener when modal is closed
            cleanupContractRealTimeListener();
        }
        
        // Edit contract - redirect to contractform.html with contract data
        function editContract(contractId) {
            console.log('=== EDITING CONTRACT ===');
            console.log('Contract ID to edit:', contractId);
            
            // Determine which contract to edit
            let contract;
            if (contractId) {
                // Called from contract list with specific ID
                contract = contracts.find(c => c.id === contractId || c.contractId === contractId);
                console.log('Found contract from list:', contract);
            } else {
                // Called from contract details modal
                contract = currentViewedContract;
                console.log('Using current viewed contract:', contract);
            }
            
            if (!contract) {
                showError('Contract not found');
                return;
            }
            
            // Log custom fields data being passed
            console.log('=== CONTRACT CUSTOM FIELDS DATA ===');
            console.log('customFields:', contract.customFields);
            console.log('customFieldsData:', contract.customFieldsData);
            console.log('customSections:', contract.customSections);
            console.log('customSectionsData:', contract.customSectionsData);
            console.log('Raw contract object:', contract._rawContract);
            
            // Store contract data in localStorage for contractform.html to access
            const contractEditData = {
                mode: 'edit',
                contract: contract,
                timestamp: Date.now()
            };
            
            console.log('Storing contract edit data:', contractEditData);
            localStorage.setItem('contractEditData', JSON.stringify(contractEditData));
            
            // Close any open modals
            closeContractModal();
            
            // Redirect to contract form page
            window.location.href = 'contractform.html?mode=edit';
        }

        // Helper function to populate benefits checkboxes
        function populateBenefitsCheckboxes(benefits) {
            // Clear all checkboxes first
            const checkboxes = ['benefitHealth', 'benefitDental', 'benefitVision', 'benefit401k', 'benefitLife', 'benefitDisability'];
            checkboxes.forEach(id => {
                document.getElementById(id).checked = false;
            });
            
            // Clear custom benefits
            document.getElementById('editCustomBenefits').value = '';
            
            if (Array.isArray(benefits)) {
                const standardBenefits = [];
                const customBenefits = [];
                
                benefits.forEach(benefit => {
                    const cleanBenefit = benefit.trim();
                    switch (cleanBenefit.toLowerCase()) {
                        case 'health insurance':
                        case 'health':
                            document.getElementById('benefitHealth').checked = true;
                            break;
                        case 'dental insurance':
                        case 'dental':
                            document.getElementById('benefitDental').checked = true;
                            break;
                        case 'vision insurance':
                        case 'vision':
                            document.getElementById('benefitVision').checked = true;
                            break;
                        case '401k':
                            document.getElementById('benefit401k').checked = true;
                            break;
                        case 'life insurance':
                        case 'life':
                            document.getElementById('benefitLife').checked = true;
                            break;
                        case 'disability insurance':
                        case 'disability':
                            document.getElementById('benefitDisability').checked = true;
                            break;
                        default:
                            // Handle custom benefits that start with "Custom:"
                            if (cleanBenefit.startsWith('Custom:')) {
                                customBenefits.push(cleanBenefit.substring(7).trim());
                            } else {
                                customBenefits.push(cleanBenefit);
                            }
                    }
                });
                
                if (customBenefits.length > 0) {
                    document.getElementById('editCustomBenefits').value = customBenefits.join(', ');
                }
            } else if (typeof benefits === 'string' && benefits) {
                // Handle string format benefits
                const benefitsList = benefits.split(',').map(b => b.trim());
                populateBenefitsCheckboxes(benefitsList);
            }
        }

        // Close edit contract modal
        function closeEditContractModal() {
            document.getElementById('editContractModal').classList.remove('show');
            document.getElementById('editContractForm').reset();
        }        // Save contract changes
        function saveContractChanges() {
            const contractId = document.getElementById('editContractId').value;
            const firebaseId = document.getElementById('editFirebaseId').value;
            
            // Collect benefits
            const benefits = [];
            const benefitCheckboxes = [
                { id: 'benefitHealth', value: 'Health Insurance' },
                { id: 'benefitDental', value: 'Dental Insurance' },
                { id: 'benefitVision', value: 'Vision Insurance' },
                { id: 'benefit401k', value: '401k' },
                { id: 'benefitLife', value: 'Life Insurance' },
                { id: 'benefitDisability', value: 'Disability Insurance' }
            ];
            
            benefitCheckboxes.forEach(benefit => {
                if (document.getElementById(benefit.id).checked) {
                    benefits.push(benefit.value);
                }
            });
            
            // Add custom benefits
            const customBenefits = document.getElementById('editCustomBenefits').value;
            if (customBenefits) {
                customBenefits.split(',').forEach(benefit => {
                    const trimmedBenefit = benefit.trim();
                    if (trimmedBenefit) {
                        benefits.push(`Custom: ${trimmedBenefit}`);
                    }
                });
            }
            
            const updatedContract = {
                contractId: contractId,
                firebaseId: firebaseId,
                
                // Employee information
                employee: {
                    name: document.getElementById('editEmployeeName').value,
                    id: document.getElementById('editEmployeeId').value,
                    department: document.getElementById('editEmployeeDepartment').value,
                    position: document.getElementById('editEmployeePosition').value,
                    email: document.getElementById('editEmployeeEmail').value,
                    offerId: document.getElementById('editOfferId').value
                },
                
                // Contract details
                contractType: document.getElementById('editContractType').value,
                status: document.getElementById('editStatus').value,
                department: document.getElementById('editDepartment').value,
                positionTitle: document.getElementById('editPosition').value,
                startDate: document.getElementById('editStartDate').value,
                endDate: document.getElementById('editEndDate').value,
                
                // Salary information
                salaryAmount: parseInt(document.getElementById('editSalaryAmount').value) || 0,
                salaryType: document.getElementById('editSalaryType').value,
                
                // Work terms
                workingHours: parseInt(document.getElementById('editWorkingHours').value) || 40,
                probationPeriod: parseInt(document.getElementById('editProbationPeriod').value) || 0,
                noticePeriod: parseInt(document.getElementById('editNoticePeriod').value) || 30,
                
                // Benefits and leave
                benefits: benefits,
                annualLeave: parseInt(document.getElementById('editAnnualLeave').value) || 20,
                sickLeave: parseInt(document.getElementById('editSickLeave').value) || 10,
                
                // Additional information
                additionalTerms: document.getElementById('editAdditionalTerms').value,
                
                // Metadata
                lastModified: new Date().toISOString(),
                version: 1
            };

            // Validate required fields
            if (!updatedContract.employee.name || !updatedContract.employee.id || 
                !updatedContract.department || !updatedContract.positionTitle || 
                !updatedContract.contractType || !updatedContract.status ||
                !updatedContract.startDate || !updatedContract.endDate ||
                !updatedContract.salaryAmount || !updatedContract.workingHours) {
                showError('Please fill in all required fields');
                return;
            }

            try {
                // Update in local array (find by contractId or firebaseId)
                const contractIndex = contracts.findIndex(c => 
                    c.contractId === contractId || 
                    c.id === contractId || 
                    c.firebaseId === firebaseId
                );
                
                if (contractIndex !== -1) {
                    // Merge with existing contract data to preserve other fields
                    contracts[contractIndex] = { ...contracts[contractIndex], ...updatedContract };
                    
                    // Update in Firebase (if using Firebase)
                    if (currentUser && firebaseId) {
                        const contractRef = database.ref(`contracts/${firebaseId}`);
                        contractRef.update(updatedContract)
                            .then(() => {
                                console.log('Contract updated successfully in Firebase');
                            })
                            .catch((error) => {
                                console.error('Error updating contract in Firebase:', error);
                            });
                    }

                    // Update UI
                    displayContracts(contracts);
                    updateStats();
                    closeEditContractModal();
                    
                    // Show success message
                    showSuccess('Contract updated successfully!');
                } else {
                    showError('Contract not found');
                }
            } catch (error) {
                console.error('Error updating contract:', error);
                showError('Failed to update contract. Please try again.');
            }
        }

        // Download contract
        function downloadContract(contractId) {
            console.log('Downloading contract:', contractId);
            // Implementation for downloading contract PDF
            alert('Download functionality will be implemented');
        }

        // Email contract
        function emailContract(contractId) {
            console.log('Emailing contract:', contractId);
            
            const contract = contracts.find(c => c.contractId === contractId || c.id === contractId);
            if (!contract) {
                showError('Contract not found');
                return;
            }
            
            // Show email modal or implement email functionality
            const employeeName = contract.employee?.name || contract.employeeName || 'Unknown';
            const employeeEmail = contract.employee?.email || '';
            
            if (!employeeEmail) {
                alert(`Email functionality will be implemented.\n\nContract: ${contractId}\nEmployee: ${employeeName}\n\nNote: Employee email address is required for this feature.`);
            } else {
                alert(`Email functionality will be implemented.\n\nContract: ${contractId}\nEmployee: ${employeeName}\nEmail: ${employeeEmail}\n\nThis will send the contract via email.`);
            }        }        // Approve contract
        async function approveContract(contractId) {
            console.log('Approving contract:', contractId);
            console.log('Available contracts:', contracts);
            
            const contract = contracts.find(c => c.contractId === contractId || c.id === contractId);
            if (!contract) {
                console.error('Contract not found. Available contract IDs:', contracts.map(c => ({ id: c.id, contractId: c.contractId })));
                showError('Contract not found');
                return;
            }
            
            console.log('Found contract to approve:', contract);
            
            // Validate that we have a Firebase ID
            if (!contract.firebaseId) {
                console.error('Contract is missing firebaseId:', contract);
                showError('Contract data is incomplete. Missing Firebase ID.');
                return;
            }

            // Get current user
            const user = auth.currentUser;
            if (!user) {
                showError('You must be logged in to approve contracts');
                return;
            }

            // Get user data from Firebase
            const userRef = database.ref(`users/${user.uid}`);
            const userSnapshot = await userRef.once('value');
            const userData = userSnapshot.val();
            
            if (!userData) {
                showError('User data not found');
                return;
            }

            try {
                // Get contract approval flow configuration
                const approvalConfig = await fetchContractApprovalFlowConfig();
                if (!approvalConfig || !approvalConfig.enabled) {
                    console.log('No approval flow configured, proceeding with direct approval');
                    await directApproveContract(contract, user, userData);
                    return;
                }

                // Check if approval flow is sequential
                const isSequential = await isContractApprovalFlowSequential();
                
                // Initialize approval history if it doesn't exist
                if (!contract.approvalHistory || !Array.isArray(contract.approvalHistory)) {
                    contract.approvalHistory = [];
                }

                // Find all approval levels the user can access
                const userRoles = userData.role ? [userData.role] : [];
                const userInfo = {
                    email: user.email,
                    uid: user.uid,
                    role: userData.role,
                    name: userData.name || userData.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim()
                };
                
                const userApprovalLevels = await getAllUserContractApprovalLevels(approvalConfig, userRoles, userInfo);
                if (!userApprovalLevels || userApprovalLevels.length === 0) {
                    showError('You are not authorized to approve this contract at any level');
                    return;
                }

                console.log('User can approve levels:', userApprovalLevels);

                // Show confirmation dialog
                const employeeName = contract.employee?.name || contract.employeeName || 'Unknown';
                const levelText = userApprovalLevels.length > 1 ? 
                    `Approval Levels: ${userApprovalLevels.join(', ')}` : 
                    `Approval Level: ${userApprovalLevels[0]}`;
                
                const confirmApprove = confirm(`Are you sure you want to approve the contract for ${employeeName}?\n\nContract ID: ${contractId}\n${levelText}`);
                
                if (confirmApprove) {
                    if (isSequential) {
                        // Sequential approval - approve current stage and potentially next stages
                        await processSequentialContractApproval(contract, user, userData, userApprovalLevels, approvalConfig);
                    } else {
                        // Parallel approval - approve all user's levels at once
                        await processParallelContractApproval(contract, user, userData, userApprovalLevels, approvalConfig);
                    }
                }

            } catch (error) {
                console.error('Error in approve contract process:', error);
                showError(`Failed to approve contract: ${error.message}`);
            }
        }

        // Helper function to get the correct Firebase path for contract updates
        async function getContractUpdatePath(contract) {
            try {
                const user = auth.currentUser;
                if (user) {
                    // Get user's company association
                    const userRef = database.ref(`users/${user.uid}`);
                    const userSnapshot = await userRef.once('value');
                    const userData = userSnapshot.val();
                    
                    if (userData && userData.companyId) {
                        // Use company-scoped path
                        console.log('🔗 Using company-scoped path for contract update:', `companies/${userData.companyId}/contracts/${contract.firebaseId}`);
                        return `companies/${userData.companyId}/contracts/${contract.firebaseId}`;
                    }
                }
                
                // Fallback to global path
                console.log('🔗 Using global path for contract update:', `contracts/${contract.firebaseId}`);
                return `contracts/${contract.firebaseId}`;
            } catch (error) {
                console.error('Error determining contract update path:', error);
                return `contracts/${contract.firebaseId}`; // Fallback to global path
            }
        }

        // Direct approval function (when no approval flow is configured)
        async function directApproveContract(contract, user, userData) {
            const employeeName = contract.employee?.name || contract.employeeName || 'Unknown';
            const confirmApprove = confirm(`Are you sure you want to approve the contract for ${employeeName}?\n\nContract ID: ${contract.contractId || contract.id}\nThis action will mark the contract as completed and move it to the Complete tab.`);
            
            if (confirmApprove) {
                // Check Firebase connection
                if (!database) {
                    console.error('❌ Firebase database not initialized');
                    showError('Database connection error. Please refresh the page and try again.');
                    return;
                }
                
                try {
                    const approvalTimestamp = new Date().toISOString();
                    const approvedBy = user.email;
                    
                    console.log('Direct approval process started:', {
                        contractId: contract.contractId || contract.id,
                        firebaseId: contract.firebaseId,
                        approvedBy,
                        timestamp: approvalTimestamp
                    });

                    // Create approval record for direct approval using helper function
                    const approvalRecord = createApprovalRecord(
                        'direct',
                        user,
                        userData,
                        approvalTimestamp,
                        'Direct approval - no approval flow configured',
                        'approved'
                    );

                    // Update contract with approval history
                    if (!contract.approvalHistory) {
                        contract.approvalHistory = [];
                    }
                    contract.approvalHistory.push(approvalRecord);

                    // Prepare contract updates for Firebase (sanitize approval history)
                    const contractUpdates = {
                        approvalHistory: sanitizeApprovalHistoryForFirebase(contract.approvalHistory),
                        lastModified: approvalTimestamp,
                        lastApprovedBy: user.uid,
                        lastApprovedAt: approvalTimestamp,
                        status: 'completed', // Move to completed tab when approved
                        approvalStatus: 'approved'
                    };

                    console.log('🔄 Updating contract with direct approval:', contractUpdates);

                    // Get the correct Firebase path for this contract
                    const contractPath = await getContractUpdatePath(contract);
                    
                    // Update in Firebase first to ensure data persistence
                    await database.ref(contractPath).update(contractUpdates);
                    console.log('✅ Direct approval saved to Firebase at path:', contractPath);

                    // Update local contract object
                    Object.assign(contract, contractUpdates);

                    // Update modal if currently open
                    if (currentViewedContract && (currentViewedContract.id === contract.id || currentViewedContract.contractId === contract.contractId)) {
                        currentViewedContract = { ...contract, ...contractUpdates };
                        await populateApprovalFlow(currentViewedContract);
                        await updateModalButtonPermissions(currentViewedContract);
                    }

                    // Refresh the display to show approved status
                    loadContracts();
                    
                    showSuccess(`Contract approved successfully! Status updated to 'Completed' and moved to Complete tab.`);
                    
                } catch (error) {
                    console.error('❌ Error in direct approval:', error);
                    showError(`Failed to approve contract: ${error.message || 'Unknown error'}. Please try again.`);
                }
            }
        }

        // Get all approval levels a user can access (for sequential approval)
        async function getAllUserContractApprovalLevels(approvalConfig, userRoles, userInfo) {
            console.log('🔍 Checking all user approval levels:', {
                approvalConfig,
                userRoles,
                userInfo
            });

            if (!approvalConfig?.selectedRoles) {
                console.log('❌ No approval roles configured');
                return [];
            }

            const userRole = userInfo.role || (userRoles.length > 0 ? userRoles[0] : '');
            const userEmail = userInfo.email;
            const userName = userInfo.name || userInfo.displayName || userEmail;
            const userId = userInfo.uid;

            console.log('📋 Available approval levels:', Object.keys(approvalConfig.selectedRoles));
            console.log('👤 User details:', { userRole, userEmail, userName, userId });

            const userLevels = [];

            // Check each approval level
            const levelKeys = Object.keys(approvalConfig.selectedRoles);
            for (const levelKey of levelKeys) {
                const roles = approvalConfig.selectedRoles[levelKey];
                console.log(`🔍 Checking level "${levelKey}":`, roles);
                
                if (Array.isArray(roles)) {
                    for (const role of roles) {
                        let hasAccess = false;

                        // Check by role name/text (case insensitive)
                        if (role.text && typeof role.text === 'string' && userRole &&
                            role.text.toLowerCase().trim() === userRole.toLowerCase().trim()) {
                            console.log(`✅ User matches role "${role.text}" for level "${levelKey}"`);
                            hasAccess = true;
                        }
                        
                        if (role.name && typeof role.name === 'string' && userRole &&
                            role.name.toLowerCase().trim() === userRole.toLowerCase().trim()) {
                            console.log(`✅ User matches role "${role.name}" for level "${levelKey}"`);
                            hasAccess = true;
                        }
                        
                        // Check by email (case insensitive)
                        if (role.text && typeof role.text === 'string' && 
                            role.text.toLowerCase().trim() === userEmail.toLowerCase().trim()) {
                            console.log(`✅ User matches email "${role.text}" for level "${levelKey}"`);
                            hasAccess = true;
                        }
                        
                        if (role.name && typeof role.name === 'string' && 
                            role.name.toLowerCase().trim() === userEmail.toLowerCase().trim()) {
                            console.log(`✅ User matches email "${role.name}" for level "${levelKey}"`);
                            hasAccess = true;
                        }
                        
                        // Check by name (case insensitive)
                        if (role.text && typeof role.text === 'string' && userName &&
                            role.text.toLowerCase().trim() === userName.toLowerCase().trim()) {
                            console.log(`✅ User matches name "${role.text}" for level "${levelKey}"`);
                            hasAccess = true;
                        }
                        
                        if (role.name && typeof role.name === 'string' && userName &&
                            role.name.toLowerCase().trim() === userName.toLowerCase().trim()) {
                            console.log(`✅ User matches name "${role.name}" for level "${levelKey}"`);
                            hasAccess = true;
                        }

                        // Check if role has user ID
                        if (role.id && role.id === userId) {
                            console.log(`✅ User matches ID "${role.id}" for level "${levelKey}"`);
                            hasAccess = true;
                        }

                        if (hasAccess && !userLevels.includes(levelKey)) {
                            userLevels.push(levelKey);
                            break; // Found access to this level, no need to check other roles
                        }
                    }
                } else {
                    console.log(`❌ Invalid roles structure for level "${levelKey}":`, roles);
                }
            }

            console.log('✅ User has access to approval levels:', userLevels);
            return userLevels;
        }

        // Get current user's contract approval level (single level - for backward compatibility)
        async function getCurrentUserContractApprovalLevel(approvalConfig, userRoles, userInfo) {
            const allLevels = await getAllUserContractApprovalLevels(approvalConfig, userRoles, userInfo);
            return allLevels.length > 0 ? allLevels[0] : null;
        }

        // Process sequential contract approval (user can approve multiple stages)
        async function processSequentialContractApproval(contract, user, userData, userApprovalLevels, approvalConfig) {
            try {
                const approvalTimestamp = new Date().toISOString();
                const approverName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.name || user.email;
                
                console.log('🔄 Processing sequential contract approval:', {
                    contractId: contract.contractId || contract.id,
                    userLevels: userApprovalLevels,
                    approver: approverName
                });

                // Initialize approval history if it doesn't exist
                if (!contract.approvalHistory) {
                    contract.approvalHistory = [];
                }

                // Get all approval levels in order
                const allApprovalLevels = Object.keys(approvalConfig.selectedRoles || {});
                const sortedLevels = allApprovalLevels.sort(); // Ensure consistent ordering
                
                console.log('All approval levels (sorted):', sortedLevels);

                // Find which levels user can approve sequentially
                const alreadyApprovedLevels = contract.approvalHistory
                    .filter(h => h.status === 'approved')
                    .map(h => h.level);

                console.log('Already approved levels:', alreadyApprovedLevels);

                // Find the next levels that need approval and user can approve
                const levelsToApprove = [];
                
                for (const level of sortedLevels) {
                    if (alreadyApprovedLevels.includes(level)) {
                        continue; // Already approved
                    }
                    
                    if (userApprovalLevels.includes(level)) {
                        levelsToApprove.push(level);
                        
                        // In sequential approval, if user can approve this level, 
                        // check if they can also approve the next consecutive levels
                        continue;
                    }
                    
                    // If we reach a level user cannot approve, stop
                    break;
                }

                console.log('Levels to approve in this session:', levelsToApprove);

                if (levelsToApprove.length === 0) {
                    showError('No approval levels available for processing');
                    return;
                }

                // Process each level approval
                let approvalRecords = [];
                for (const level of levelsToApprove) {
                    const approvalRecord = createApprovalRecord(
                        level,
                        user,
                        userData,
                        approvalTimestamp,
                        `Sequential approval - Stage ${sortedLevels.indexOf(level) + 1}`,
                        'approved'
                    );

                    // Update or add approval record in contract's history
                    const existingRecordIndex = contract.approvalHistory.findIndex(h => h.level === level);
                    if (existingRecordIndex >= 0) {
                        contract.approvalHistory[existingRecordIndex] = approvalRecord;
                    } else {
                        contract.approvalHistory.push(approvalRecord);
                    }
                    
                    approvalRecords.push(approvalRecord);
                }

                // Check if contract is fully approved
                const newApprovedLevels = contract.approvalHistory
                    .filter(h => h.status === 'approved')
                    .map(h => h.level);

                const isFullyApproved = sortedLevels.every(level => newApprovedLevels.includes(level));

                console.log('Sequential approval status:', {
                    levelsApproved: levelsToApprove,
                    totalApprovedLevels: newApprovedLevels,
                    isFullyApproved
                });

                // Prepare contract updates for Firebase
                const contractUpdates = {
                    approvalHistory: sanitizeApprovalHistoryForFirebase(contract.approvalHistory),
                    lastModified: approvalTimestamp,
                    lastApprovedBy: user.uid,
                    lastApprovedAt: approvalTimestamp
                };

                if (isFullyApproved) {
                    // All levels approved - mark as completed and move to completed tab
                    contractUpdates.status = 'completed'; // Move to completed tab when fully approved
                    contractUpdates.approvalStatus = 'approved';
                    contractUpdates.finallyApprovedAt = approvalTimestamp;
                    contractUpdates.finallyApprovedBy = user.uid;
                    
                    showSuccess(`Contract fully approved! All ${sortedLevels.length} approval stages completed. Contract moved to Complete tab.`);
                    
                    // Get the correct Firebase path for this contract
                    const contractPath = await getContractUpdatePath(contract);
                    
                    // Update Firebase directly without duplicate call
                    await database.ref(contractPath).update(contractUpdates);
                    console.log('✅ Contract fully approved and status updated to completed in Firebase at path:', contractPath);
                } else {
                    // Partial approval - keep as active status but show partial approval
                    contractUpdates.status = 'active'; // Keep as active until fully approved
                    contractUpdates.approvalStatus = 'pending';
                    contractUpdates.currentApprovalStage = newApprovedLevels.length + 1;
                    
                    const remainingLevels = sortedLevels.filter(level => !newApprovedLevels.includes(level));
                    
                    showSuccess(`Approved ${levelsToApprove.length} stage(s): ${levelsToApprove.join(', ')}. Remaining stages: ${remainingLevels.join(', ')}`);
                    
                    // Get the correct Firebase path for this contract
                    const contractPath = await getContractUpdatePath(contract);
                    
                    // Update Firebase
                    await database.ref(contractPath).update(contractUpdates);
                    console.log('✅ Partial approval saved to Firebase at path:', contractPath);
                }

                // Refresh UI
                Object.assign(contract, contractUpdates);
                loadContracts();
                
                // Update modal if open
                if (currentViewedContract && (currentViewedContract.id === contract.id || currentViewedContract.contractId === contract.contractId)) {
                    currentViewedContract = { ...contract, ...contractUpdates };
                    await populateApprovalFlow(currentViewedContract);
                    await updateModalButtonPermissions(currentViewedContract);
                }

                console.log('✅ Sequential approval processing completed');

            } catch (error) {
                console.error('❌ Error in sequential approval:', error);
                throw error;
            }
        }

        // Process parallel contract approval (user approves all their levels at once)
        async function processParallelContractApproval(contract, user, userData, userApprovalLevels, approvalConfig) {
            try {
                const approvalTimestamp = new Date().toISOString();
                const approverName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.name || user.email;
                
                console.log('🔄 Processing parallel contract approval:', {
                    contractId: contract.contractId || contract.id,
                    userLevels: userApprovalLevels,
                    approver: approverName
                });

                // Initialize approval history if it doesn't exist
                if (!contract.approvalHistory) {
                    contract.approvalHistory = [];
                }

                // Process all user's approval levels
                for (const level of userApprovalLevels) {
                    const approvalRecord = createApprovalRecord(
                        level,
                        user,
                        userData,
                        approvalTimestamp,
                        `Parallel approval`,
                        'approved'
                    );

                    // Update or add approval record in contract's history
                    const existingRecordIndex = contract.approvalHistory.findIndex(h => h.level === level);
                    if (existingRecordIndex >= 0) {
                        contract.approvalHistory[existingRecordIndex] = approvalRecord;
                    } else {
                        contract.approvalHistory.push(approvalRecord);
                    }
                }

                // Check if contract is fully approved
                const allApprovalLevels = Object.keys(approvalConfig.selectedRoles || {});
                const approvedLevels = contract.approvalHistory
                    .filter(h => h.status === 'approved')
                    .map(h => h.level);

                const isFullyApproved = allApprovalLevels.every(level => approvedLevels.includes(level));

                console.log('Parallel approval status:', {
                    levelsApproved: userApprovalLevels,
                    totalApprovedLevels: approvedLevels,
                    isFullyApproved
                });

                // Prepare contract updates for Firebase
                const contractUpdates = {
                    approvalHistory: sanitizeApprovalHistoryForFirebase(contract.approvalHistory),
                    lastModified: approvalTimestamp,
                    lastApprovedBy: user.uid,
                    lastApprovedAt: approvalTimestamp
                };

                if (isFullyApproved) {
                    // All levels approved - mark as completed and move to completed tab
                    contractUpdates.status = 'completed'; // Move to completed tab when fully approved
                    contractUpdates.approvalStatus = 'approved';
                    contractUpdates.finallyApprovedAt = approvalTimestamp;
                    contractUpdates.finallyApprovedBy = user.uid;
                    
                    showSuccess(`Contract fully approved! All approval levels completed. Contract moved to Complete tab.`);
                    
                    // Get the correct Firebase path for this contract
                    const contractPath = await getContractUpdatePath(contract);
                    
                    // Update Firebase directly without duplicate call
                    await database.ref(contractPath).update(contractUpdates);
                    console.log('✅ Contract fully approved and status updated to completed in Firebase at path:', contractPath);
                } else {
                    // Partial approval - keep as active status but show partial approval
                    contractUpdates.status = 'active'; // Keep as active until fully approved
                    contractUpdates.approvalStatus = 'partial';
                    const remainingLevels = allApprovalLevels.filter(level => !approvedLevels.includes(level));
                    
                    showSuccess(`Approved levels: ${userApprovalLevels.join(', ')}. Waiting for approval from: ${remainingLevels.join(', ')}`);
                    
                    // Get the correct Firebase path for this contract
                    const contractPath = await getContractUpdatePath(contract);
                    
                    // Update Firebase
                    await database.ref(contractPath).update(contractUpdates);
                    console.log('✅ Partial approval saved to Firebase at path:', contractPath);
                }

                // Refresh UI
                Object.assign(contract, contractUpdates);
                loadContracts();
                
                // Update modal if open
                if (currentViewedContract && (currentViewedContract.id === contract.id || currentViewedContract.contractId === contract.contractId)) {
                    currentViewedContract = { ...contract, ...contractUpdates };
                    await populateApprovalFlow(currentViewedContract);
                    await updateModalButtonPermissions(currentViewedContract);
                }

                console.log('✅ Parallel approval processing completed');

            } catch (error) {
                console.error('❌ Error in parallel approval:', error);
                throw error;
            }
        }

        // Process contract approval with approval flow (LEGACY - kept for backward compatibility)
        async function processContractApproval(contract, user, userData, currentUserLevel, approvalConfig, isSequential) {
            try {
                const approvalTimestamp = new Date().toISOString();
                const approverName = `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.name || user.email;
                
                console.log('Processing contract approval:', {
                    contractId: contract.contractId || contract.id,
                    level: currentUserLevel,
                    approver: approverName,
                    isSequential
                });

                // Create approval record using helper function
                const approvalRecord = createApprovalRecord(
                    currentUserLevel,
                    user,
                    userData,
                    approvalTimestamp,
                    '', // comments - can be enhanced later
                    'approved'
                );

                // Initialize approval history if it doesn't exist
                if (!contract.approvalHistory) {
                    contract.approvalHistory = [];
                }

                // Update or add approval record in contract's history
                const existingRecordIndex = contract.approvalHistory.findIndex(h => h.level === currentUserLevel);
                if (existingRecordIndex >= 0) {
                    contract.approvalHistory[existingRecordIndex] = approvalRecord;
                } else {
                    contract.approvalHistory.push(approvalRecord);
                }

                // Determine if contract is fully approved
                const allApprovalLevels = Object.keys(approvalConfig.selectedRoles || {});
                const approvedLevels = contract.approvalHistory
                    .filter(h => h.status === 'approved')
                    .map(h => h.level);

                console.log('Approval status check:', {
                    allLevels: allApprovalLevels,
                    approvedLevels: approvedLevels,
                    isFullyApproved: allApprovalLevels.every(level => approvedLevels.includes(level))
                });

                // Update contract data with current approval status (sanitize approval history for Firebase)
                const contractUpdates = {
                    approvalHistory: sanitizeApprovalHistoryForFirebase(contract.approvalHistory),
                    lastModified: approvalTimestamp,
                    lastApprovedBy: user.uid,
                    lastApprovedAt: approvalTimestamp
                };

                if (isSequential) {
                    // Sequential approval logic
                    const currentStageNumber = allApprovalLevels.indexOf(currentUserLevel) + 1;
                    const isLastStage = currentStageNumber === allApprovalLevels.length;

                    if (isLastStage) {
                        // Final approval in sequential flow - mark as completed and move to completed tab
                        contractUpdates.status = 'completed'; // Move to completed tab when fully approved
                        contractUpdates.approvalStatus = 'approved';
                        contractUpdates.finallyApprovedAt = approvalTimestamp;
                        contractUpdates.finallyApprovedBy = user.uid;
                        
                        showSuccess(`Contract fully approved! All ${allApprovalLevels.length} approval stages completed. Contract moved to Complete tab.`);
                        
                        // Get the correct Firebase path for this contract
                        const contractPath = await getContractUpdatePath(contract);
                        
                        // Update Firebase directly instead of moving to completed
                        await database.ref(contractPath).update(contractUpdates);
                        console.log('✅ Contract fully approved and status updated to completed in Firebase at path:', contractPath);
                    } else {
                        // Intermediate approval - keep as active until fully approved
                        contractUpdates.status = 'active'; // Keep as active until fully approved
                        contractUpdates.approvalStatus = 'pending';
                        contractUpdates.currentApprovalStage = currentStageNumber + 1;
                        
                        showSuccess(`Stage ${currentStageNumber} approved successfully. Moving to stage ${currentStageNumber + 1}.`);
                    }
                } else {
                    // Parallel approval logic
                    const allLevelsApproved = allApprovalLevels.every(level => approvedLevels.includes(level));
                    
                    if (allLevelsApproved) {
                        // All levels approved in parallel flow - mark as completed and move to completed tab
                        contractUpdates.status = 'completed'; // Move to completed tab when fully approved
                        contractUpdates.approvalStatus = 'approved';
                        contractUpdates.finallyApprovedAt = approvalTimestamp;
                        contractUpdates.finallyApprovedBy = user.uid;
                        
                        showSuccess(`Contract fully approved! All approval levels completed. Contract moved to Complete tab.`);
                        
                        // Get the correct Firebase path for this contract
                        const contractPath = await getContractUpdatePath(contract);
                        
                        // Update Firebase directly instead of moving to completed
                        await database.ref(contractPath).update(contractUpdates);
                        console.log('✅ Contract fully approved and status updated to completed in Firebase at path:', contractPath);
                    } else {
                        // Partial approval in parallel flow - keep as active until fully approved
                        contractUpdates.status = 'active'; // Keep as active until fully approved
                        contractUpdates.approvalStatus = 'partial';
                        const remainingLevels = allApprovalLevels.filter(level => !approvedLevels.includes(level));
                        
                        showSuccess(`Your approval level completed. Waiting for approval from: ${remainingLevels.join(', ')}`);
                    }
                }

                // Update contract in Firebase with immediate real-time updates
                console.log('🔄 Updating contract in Firebase:', contractUpdates);
                
                try {
                    // Get the correct Firebase path for this contract
                    const contractPath = await getContractUpdatePath(contract);
                    
                    // Update in Firebase Realtime Database
                    await database.ref(contractPath).update(contractUpdates);
                    console.log('✅ Contract updated successfully in Firebase at path:', contractPath);
                    
                    // Update local contract object immediately
                    Object.assign(contract, contractUpdates);
                    
                    // Force refresh the contracts list to show updated data
                    loadContracts();
                    
                    // Update the modal immediately if it's currently open for this contract
                    if (currentViewedContract && (currentViewedContract.id === contract.id || currentViewedContract.contractId === contract.contractId)) {
                        console.log('🔄 Updating modal for currently viewed contract');
                        
                        // Update the current viewed contract with new data
                        currentViewedContract = { ...contract, ...contractUpdates };
                        
                        // Re-populate the approval flow to show real-time updates
                        await populateApprovalFlow(currentViewedContract);
                        
                        // Update modal button permissions based on new approval status
                        await updateModalButtonPermissions(currentViewedContract);
                        
                        // Update approval status display in modal
                        const approvalStatusEl = document.getElementById('modalApprovalStatus');
                        if (approvalStatusEl) {
                            approvalStatusEl.textContent = contractUpdates.approvalStatus || 'Pending';
                        }
                        
                        console.log('✅ Modal updated with real-time approval data');
                    }
                    
                    // Set up real-time listener for this contract to keep modal updated
                    setupContractRealTimeListener(contract.firebaseId);
                    
                } catch (firebaseError) {
                    console.error('❌ Error updating contract in Firebase:', firebaseError);
                    throw new Error(`Failed to save approval to database: ${firebaseError.message}`);
                }

            } catch (error) {
                console.error('Error processing contract approval:', error);
                throw error;
            }
        }

        // Helper function to ensure approval history is properly structured for Firebase
        function sanitizeApprovalHistoryForFirebase(approvalHistory) {
            if (!Array.isArray(approvalHistory)) {
                return [];
            }
            
            return approvalHistory.map(record => ({
                level: record.level || 'unknown',
                stage: record.stage || 1,
                approvedBy: record.approvedBy || '',
                approverName: record.approverName || '',
                approverEmail: record.approverEmail || '',
                approvedAt: record.approvedAt || new Date().toISOString(),
                status: record.status || 'approved',
                comments: record.comments || ''
            }));
        }

        // Helper function to create a complete approval record
        function createApprovalRecord(level, user, userData, timestamp, comments = '', status = 'approved') {
            return {
                level: level,
                stage: 1, // Can be enhanced later for multi-stage approvals
                approvedBy: user.uid,
                approverName: `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || userData.name || user.email,
                approverEmail: user.email,
                approvedAt: timestamp,
                status: status,
                comments: comments,
                // Additional metadata for debugging and tracking
                timestamp: Date.now(),
                userAgent: navigator.userAgent || 'unknown'
            };
        }

        // Set up real-time listener for contract updates
        function setupContractRealTimeListener(firebaseId) {
            if (!firebaseId) {
                console.warn('⚠️ No firebaseId provided for real-time listener');
                return;
            }
            
            console.log('🔄 Setting up real-time listener for contract:', firebaseId);
            
            // Remove any existing listener for this contract
            if (window.currentContractListener) {
                window.currentContractListener.off();
            }
            
            // Set up new listener
            const contractRef = database.ref(`contracts/${firebaseId}`);
            window.currentContractListener = contractRef;
            
            contractRef.on('value', (snapshot) => {
                const updatedContract = snapshot.val();
                if (updatedContract && currentViewedContract && currentViewedContract.firebaseId === firebaseId) {
                    console.log('🔄 Real-time update received for contract:', firebaseId);
                    
                    // Update the current viewed contract
                    currentViewedContract = { ...currentViewedContract, ...updatedContract };
                    
                    // Update the modal display
                    populateApprovalFlow(currentViewedContract).catch(error => {
                        console.error('Error updating approval flow from real-time data:', error);
                    });
                    
                    // Update modal button permissions
                    updateModalButtonPermissions(currentViewedContract).catch(error => {
                        console.error('Error updating button permissions from real-time data:', error);
                    });
                    
                    // Update approval status display
                    const approvalStatusEl = document.getElementById('modalApprovalStatus');
                    if (approvalStatusEl && updatedContract.approvalStatus) {
                        approvalStatusEl.textContent = updatedContract.approvalStatus;
                    }
                    
                    // Update main status display in modal
                    const statusEl = document.getElementById('modalStatus');
                    if (statusEl && updatedContract.status) {
                        statusEl.textContent = updatedContract.status;
                    }
                    
                    console.log('✅ Modal updated from real-time Firebase data');
                }
            }, (error) => {
                console.error('❌ Real-time listener error:', error);
            });
        }

        // Clean up real-time listener when modal is closed
        function cleanupContractRealTimeListener() {
            if (window.currentContractListener) {
                console.log('🔄 Cleaning up real-time listener');
                window.currentContractListener.off();
                window.currentContractListener = null;
            }
        }

        // Move contract to completed status
        async function moveContractToCompleted(contract, user, userData, approvalTimestamp) {
            try {
                const contractUpdates = {
                    status: 'completed',
                    approvalStatus: 'approved',
                    finallyApprovedAt: approvalTimestamp,
                    finallyApprovedBy: user.uid,
                    lastModified: approvalTimestamp,
                    // Ensure approval history is preserved
                    approvalHistory: contract.approvalHistory || []
                };

                console.log('🔄 Moving contract to completed status:', contractUpdates);

                // Get the correct Firebase path for this contract
                const contractPath = await getContractUpdatePath(contract);
                
                // Update in Firebase Realtime Database
                await database.ref(contractPath).update(contractUpdates);
                console.log('✅ Contract moved to completed status in Firebase at path:', contractPath);
                
                // Update local contract object
                Object.assign(contract, contractUpdates);
                
                showSuccess(`Contract approved successfully and moved to completed status!`);
                
                // Refresh the display to show updated status
                loadContracts();
                
                // Update the modal if it's currently open
                if (currentViewedContract && (currentViewedContract.id === contract.id || currentViewedContract.contractId === contract.contractId)) {
                    currentViewedContract = { ...contract, ...contractUpdates };
                    
                    // Update approval flow display
                    await populateApprovalFlow(currentViewedContract);
                    
                    // Update button permissions
                    await updateModalButtonPermissions(currentViewedContract);
                }
                
                // Clean up real-time listener since contract is completed
                setTimeout(() => {
                    cleanupContractRealTimeListener();
                    
                    // Close modal after a short delay to show completion
                    const modal = document.getElementById('contractModal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                }, 1500);

            } catch (error) {
                console.error('Error moving contract to completed:', error);
                throw new Error(`Failed to complete contract: ${error.message}`);
            }
        }

        // Test function to verify approval system functionality
        async function testApprovalSystem() {
            console.group('🧪 Testing Contract Approval System');
            
            // Test current user information
            console.log('👤 Current user info:', {
                user: currentUser,
                userData: userData,
                userRole: userData?.role,
                userEmail: currentUser?.email
            });
            
            // Test approval flow configuration
            console.log('⚙️ Testing approval flow configuration...');
            try {
                const config = await fetchContractApprovalFlowConfig();
                console.log('Approval flow config:', config);
                
                if (config && config.selectedRoles) {
                    console.log('Available approval levels:');
                    Object.entries(config.selectedRoles).forEach(([level, roles]) => {
                        console.log(`  Level "${level}":`, roles);
                    });
                } else {
                    console.log('❌ No approval flow configured');
                }
            } catch (error) {
                console.error('❌ Error fetching approval config:', error);
            }
            
            // Test user approval level
            if (currentUser && userData) {
                console.log('🔍 Testing user approval level...');
                try {
                    const config = await fetchContractApprovalFlowConfig();
                    if (config) {
                        const userRoles = userData.role ? [userData.role] : [];
                        const userInfo = {
                            email: currentUser.email,
                            uid: currentUser.uid,
                            role: userData.role,
                            name: userData.name || userData.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim()
                        };
                        const level = await getCurrentUserContractApprovalLevel(config, userRoles, userInfo);
                        console.log('User approval level result:', level);
                    }
                } catch (error) {
                    console.error('❌ Error testing user approval level:', error);
                }
            }
            
            // Test permission checking for a specific contract
            console.log('📋 Testing contract permission checks...');
            const testContract = contracts.length > 0 ? contracts[0] : null;
            if (testContract) {
                console.log('Testing with contract:', testContract);
                try {
                    const isApprover = await checkIfUserIsApprover(testContract, currentUser, userData);
                    console.log('Is user approver for test contract:', isApprover);
                    
                    // Test button permissions
                    debugButtonPermissions(testContract.contractId || testContract.id);
                } catch (error) {
                    console.error('❌ Error testing contract permissions:', error);
                }
            } else {
                console.log('❌ No contracts available for testing');
            }
            
            console.log('✅ Approval system test completed. Check console for details.');
            console.groupEnd();
        }

        // Add test button to help debug approval system
        function addTestButton() {
            if (document.getElementById('testApprovalBtn')) return; // Already exists
            
            const testBtn = document.createElement('button');
            testBtn.id = 'testApprovalBtn';
            testBtn.innerHTML = '🧪 Test Approval System';
            testBtn.className = 'btn btn-secondary';
            testBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 9999; font-size: 12px; padding: 5px 10px;';
            testBtn.onclick = testApprovalSystem;
            document.body.appendChild(testBtn);
        }

        // Decline contract
        function declineContract(contractId) {
            console.log('Declining contract:', contractId);
            
            const contract = contracts.find(c => c.contractId === contractId || c.id === contractId);
            if (!contract) {
                showError('Contract not found');
                return;
            }
            
            // Show confirmation dialog with reason
            const employeeName = contract.employee?.name || contract.employeeName || 'Unknown';
            const reason = prompt(`Please provide a reason for declining the contract for ${employeeName}:\n\nContract ID: ${contractId}`, '');
            
            if (reason !== null && reason.trim() !== '') {
                try {
                    // Update contract status in Firebase
                    const updates = {
                        status: 'declined',
                        declinedAt: new Date().toISOString(),
                        declinedBy: currentUser ? currentUser.email : 'Unknown',
                        declineReason: reason.trim(),
                        lastModified: new Date().toISOString()
                    };
                    
                    // Get the correct Firebase path for this contract and update
                    getContractUpdatePath(contract).then(contractPath => {
                        // Update in Firebase
                        database.ref(contractPath).update(updates)
                            .then(() => {
                                console.log('✅ Contract declined and saved to Firebase at path:', contractPath);
                                showSuccess(`Contract for ${employeeName} has been declined.`);
                                loadContracts(); // Refresh the contracts list
                            })
                            .catch((error) => {
                                console.error('Error declining contract:', error);
                                showError('Failed to decline contract. Please try again.');
                            });
                    }).catch((error) => {
                        console.error('Error getting contract path for decline:', error);
                        showError('Failed to decline contract. Please try again.');
                    });
                } catch (error) {
                    console.error('Error declining contract:', error);
                    showError('Failed to decline contract. Please try again.');
                }
            } else if (reason !== null) {
                alert('A reason is required to decline a contract.');
            }
        }

        // Renew contract
        function renewContract() {
            console.log('Renewing contract...');
            // Implementation for renewing contract
            alert('Renew functionality will be implemented');
        }// Delete contract
        function deleteContract(contractId) {
            const contract = contracts.find(c => c.id === contractId);
            if (!contract) {
                showError('Contract not found');
                return;
            }

            const confirmMessage = `Are you sure you want to delete the contract for ${contract.employeeName} (${contract.employeeId})?\n\nThis action cannot be undone.`;
            
            if (confirm(confirmMessage)) {
                try {
                    // Remove from local array
                    const contractIndex = contracts.findIndex(c => c.id === contractId);
                    if (contractIndex !== -1) {
                        contracts.splice(contractIndex, 1);
                        
                        // Remove from Firebase (if using Firebase)
                        if (currentUser) {
                            const contractRef = database.ref(`contracts/${currentUser.uid}/${contractId}`);
                            contractRef.remove()
                                .then(() => {
                                    console.log('Contract deleted successfully from Firebase');
                                })
                                .catch((error) => {
                                    console.error('Error deleting contract from Firebase:', error);
                                });
                        }

                        // Update UI
                        displayContracts(contracts);
                        updateStats();
                        
                        // Close any open modals
                        closeContractModal();
                          // Show success message
                        showSuccess('Contract deleted successfully!');
                    } else {
                        showError('Contract not found');
                    }
                } catch (error) {
                    console.error('Error deleting contract:', error);
                    showError('Failed to delete contract. Please try again.');
                }
            }
        }

        // Tab switching functionality
       
        function switchToTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
              // Show selected tab content and activate button
            switch (tabName) {                case 'active':
                    document.getElementById('activeContractsTabContent').classList.add('active');
                    document.getElementById('activeContractsTabBtn').classList.add('active');
                    // Refresh active contracts when tab is selected
                    displayActiveContracts();
                    break;
                case 'archive':
                    document.getElementById('archiveTabContent').classList.add('active');
                    document.getElementById('archiveTabBtn').classList.add('active');
                    break;case 'complete':
                    document.getElementById('completeTabContent').classList.add('active');
                    document.getElementById('completeTabBtn').classList.add('active');
                    // Load completed contracts when tab is selected
                    loadCompleteContracts();
                    break;
            }
        }        // Initialize tabs
        function initializeTabs() {
            // Add click event listeners to tab buttons
            document.getElementById('activeContractsTabBtn').addEventListener('click', () => switchToTab('active'));
            document.getElementById('archiveTabBtn').addEventListener('click', () => switchToTab('archive'));
            document.getElementById('completeTabBtn').addEventListener('click', () => switchToTab('complete'));
            
            // Set default tab to active contracts on page load
            console.log('🏷️ Setting default tab to active contracts');
            switchToTab('active');
        }

        // Show/hide loading state
        function showLoadingState(show) {
            const loadingState = document.getElementById('loadingState');
            const contractsTable = document.getElementById('contractsTable');
            
            if (show) {
                loadingState.style.display = 'block';
                contractsTable.style.display = 'none';
            } else {
                loadingState.style.display = 'none';
            }
        }        // Show error message
        function showError(message) {
            console.error(message);
            // You can implement a toast notification or error modal here
            alert('Error: ' + message);
        }

        // Show success message
        function showSuccess(message) {
            console.log('Success:', message);
            // You can implement a toast notification here
            alert('Success: ' + message);
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString; // Return original string if invalid date
                }
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short', 
                    day: 'numeric'
                });
            } catch (error) {
                console.warn('Error formatting date:', dateString, error);
                return dateString || 'N/A';
            }
        }        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const contractModal = document.getElementById('contractModal');
            const editModal = document.getElementById('editContractModal');
            
            if (event.target === contractModal) {
                closeContractModal();
            }
            if (event.target === editModal) {
                closeEditContractModal();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeContractModal();
                closeEditContractModal();
            }
        });

        // User profile dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            const profileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = document.querySelector('.profile-dropdown');

            if (profileBtn && profileDropdown) {
                profileBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    profileDropdown.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function() {
                    profileDropdown.classList.remove('show');
                });

                // Prevent dropdown from closing when clicking inside it
                profileDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // Add test button for debugging approval system
            setTimeout(addTestButton, 1000); // Add after page is fully loaded
        });

        // ===============================
        // CUSTOM SECTION BUILDER FUNCTIONS
        // ===============================

        let customSectionCounter = 0;

        // Add a new custom section
        function addCustomSection() {
            customSectionCounter++;
            const sectionId = `custom_section_${customSectionCounter}`;
            
            const customSectionsContainer = document.getElementById('customSectionsContainer');
            const sectionItem = document.createElement('div');
            sectionItem.className = 'custom-section-item';
            sectionItem.id = sectionId;
            
            sectionItem.innerHTML = `
                <div class="custom-section-header">
                    <div class="custom-section-title">
                        <i class="fas fa-layer-group"></i>
                        Custom Section #${customSectionCounter}
                    </div>
                    <button type="button" class="custom-section-remove" onclick="removeCustomSection('${sectionId}')">
                        <i class="fas fa-trash"></i>
                        Remove Section
                    </button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label required">Section Title</label>
                        <input type="text" class="form-control" id="${sectionId}_title" 
                               placeholder="e.g., Employee Benefits, Work Schedule" 
                               onchange="updateSectionTitle('${sectionId}')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Section Description</label>
                        <input type="text" class="form-control" id="${sectionId}_description" 
                               placeholder="Brief description of this section">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Section Instructions</label>
                    <textarea class="form-control" id="${sectionId}_instructions" rows="2" 
                              placeholder="Instructions or help text for this section"></textarea>
                </div>
                
                <div class="section-fields-container">
                    <div class="section-fields-header">
                        <div class="section-fields-title">Section Fields</div>
                        <button type="button" class="add-field-to-section-btn" onclick="addFieldToSection('${sectionId}')">
                            <i class="fas fa-plus"></i>
                            Add Field
                        </button>
                    </div>
                    <div id="${sectionId}_fields" class="section-fields-list">
                        <div class="section-empty-state">
                            No fields added yet. Click "Add Field" to add fields to this section.
                        </div>
                    </div>
                </div>
            `;
            
            customSectionsContainer.appendChild(sectionItem);
        }

        // Remove a custom section
        function removeCustomSection(sectionId) {
            const sectionElement = document.getElementById(sectionId);
            const sectionTitle = document.getElementById(`${sectionId}_title`).value || 'this section';
            
            if (confirm(`Are you sure you want to remove "${sectionTitle}" and all its fields?`)) {
                sectionElement.remove();
            }
        }

        // Update section title in header
        function updateSectionTitle(sectionId) {
            const titleInput = document.getElementById(`${sectionId}_title`);
            const titleDisplay = document.querySelector(`#${sectionId} .custom-section-title`);
            
            if (titleInput.value.trim()) {
                titleDisplay.innerHTML = `
                    <i class="fas fa-layer-group"></i>
                    ${titleInput.value.trim()}
                `;
            } else {
                titleDisplay.innerHTML = `
                    <i class="fas fa-layer-group"></i>
                    Custom Section #${sectionId.split('_').pop()}
                `;
            }
        }

        // Add field to specific section
        function addFieldToSection(sectionId) {
            const sectionFieldsContainer = document.getElementById(`${sectionId}_fields`);
            const fieldCounter = sectionFieldsContainer.children.length;
            const fieldId = `${sectionId}_field_${fieldCounter}`;
            
            // Remove empty state if exists
            const emptyState = sectionFieldsContainer.querySelector('.section-empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            const fieldItem = document.createElement('div');
            fieldItem.className = 'section-field-item';
            fieldItem.id = fieldId;
            
            fieldItem.innerHTML = `
                <div class="section-field-header">
                    <div class="section-field-title">
                        <i class="fas fa-grip-vertical"></i>
                        Field #${fieldCounter + 1}
                        <span class="section-type-indicator" id="${fieldId}_type_indicator">Text</span>
                    </div>
                    <button type="button" class="section-field-remove" onclick="removeSectionField('${fieldId}', '${sectionId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div>
                        <label style="display: block; font-size: 0.8rem; margin-bottom: 0.25rem; font-weight: 500;">Field Label</label>
                        <input type="text" class="form-control" id="${fieldId}_label" 
                               placeholder="Field name" style="padding: 0.5rem; font-size: 0.85rem;"
                               onchange="updateSectionFieldTitle('${fieldId}')">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; margin-bottom: 0.25rem; font-weight: 500;">Field Type</label>
                        <select class="form-control" id="${fieldId}_type" style="padding: 0.5rem; font-size: 0.85rem;"
                                onchange="handleSectionFieldTypeChange('${fieldId}')">
                            <option value="text">Text Input</option>
                            <option value="textarea">Text Area</option>
                            <option value="number">Number</option>
                            <option value="email">Email</option>
                            <option value="phone">Phone</option>
                            <option value="date">Date</option>
                            <option value="select">Dropdown Select</option>
                            <option value="radio">Radio Buttons</option>
                            <option value="checkbox">Checkbox</option>
                            <option value="file">File Upload</option>
                        </select>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.75rem;">
                    <div>
                        <label style="display: block; font-size: 0.8rem; margin-bottom: 0.25rem; font-weight: 500;">Description</label>
                        <input type="text" class="form-control" id="${fieldId}_description" 
                               placeholder="Help text (optional)" style="padding: 0.5rem; font-size: 0.85rem;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; margin-bottom: 0.25rem; font-weight: 500;">Required</label>
                        <div style="display: flex; align-items: center; height: 38px;">
                            <input type="checkbox" id="${fieldId}_required" style="margin: 0;">
                        </div>
                    </div>
                </div>
                
                <!-- Options for select/radio fields -->
                <div class="field-options-container" id="${fieldId}_options_container" style="margin-top: 0.75rem; display: none;">
                    <label style="display: block; font-size: 0.8rem; margin-bottom: 0.5rem; font-weight: 500;">Options</label>
                    <div id="${fieldId}_options_list">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" class="form-control" placeholder="Option 1" style="padding: 0.4rem; font-size: 0.8rem;">
                            <button type="button" style="background: #dc3545; color: white; border: none; border-radius: 3px; padding: 0.4rem; font-size: 0.7rem;" onclick="removeSectionFieldOption(this)">×</button>
                        </div>
                    </div>
                    <button type="button" style="background: #28a745; color: white; border: none; border-radius: 3px; padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="addSectionFieldOption('${fieldId}')">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>
                
                <!-- Field Preview -->
                <div class="custom-field-preview">
                    <h5><i class="fas fa-eye"></i> Field Preview</h5>
                    <div id="${fieldId}_preview">
                        <!-- Preview will be generated here -->
                    </div>
                </div>
            `;
            
            customFieldsContainer.appendChild(fieldItem);
            updateFieldPreview(fieldId);
        }

        // Remove a custom field
        function removeCustomField(fieldId) {
            if (confirm('Are you sure you want to remove this custom field?')) {
                document.getElementById(fieldId).remove();
            }
        }

        // Handle field type change
        function handleFieldTypeChange(fieldId) {
            const fieldType = document.getElementById(`${fieldId}_type`).value;
            const optionsContainer = document.getElementById(`${fieldId}_options_container`);
            const typeIndicator = document.getElementById(`${fieldId}_type_indicator`);
            
            // Update type indicator
            const typeNames = {
                'text': 'Text',
                'textarea': 'Text Area',
                'number': 'Number',
                'email': 'Email',
                'phone': 'Phone',
                'date': 'Date',
                'select': 'Dropdown',
                'radio': 'Radio',
                'checkbox': 'Checkbox',
                'file': 'File'
            };
            typeIndicator.textContent = typeNames[fieldType] || fieldType;
            
            // Show/hide options container
            if (fieldType === 'select' || fieldType === 'radio') {
                optionsContainer.classList.add('show');
            } else {
                optionsContainer.classList.remove('show');
            }
            
            updateFieldPreview(fieldId);
        }

        // Add field option
        function addFieldOption(fieldId) {
            const optionsList = document.getElementById(`${fieldId}_options_list`);
            const optionCount = optionsList.children.length + 1;
            
            const optionItem = document.createElement('div');
            optionItem.className = 'field-option-item';
            optionItem.innerHTML = `
                <input type="text" class="form-control" placeholder="Option ${optionCount}" onchange="updateFieldPreview('${fieldId}')">
                <button type="button" class="field-option-remove" onclick="removeFieldOption(this)">×</button>
            `;
            
            optionsList.appendChild(optionItem);
            updateFieldPreview(fieldId);
        }

        // Remove field option
        function removeFieldOption(button) {
            if (button.parentElement.parentElement.children.length > 1) {
                button.parentElement.remove();
            } else {
                alert('You must have at least one option.');
            }
        }

        // Update field preview
        function updateFieldPreview(fieldId) {
            const label = document.getElementById(`${fieldId}_label`).value || 'Field Label';
            const type = document.getElementById(`${fieldId}_type`).value;
            const description = document.getElementById(`${fieldId}_description`).value;
            const defaultValue = document.getElementById(`${fieldId}_default`).value;
            const previewContainer = document.getElementById(`${fieldId}_preview`);
            
            let previewHTML = `
                <div class="preview-field">
                    <label>${label}</label>
            `;
            
            switch (type) {
                case 'text':
                case 'email':
                case 'phone':
                    previewHTML += `<input type="${type}" placeholder="${defaultValue || 'Enter ' + label.toLowerCase()}" disabled>`;
                    break;
                case 'number':
                    previewHTML += `<input type="number" placeholder="${defaultValue || '0'}" disabled>`;
                    break;
                case 'date':
                    previewHTML += `<input type="date" disabled>`;
                    break;
                case 'textarea':
                    previewHTML += `<textarea rows="3" placeholder="${defaultValue || 'Enter ' + label.toLowerCase()}" disabled></textarea>`;
                    break;
                case 'select':
                    const selectOptions = Array.from(document.querySelectorAll(`#${fieldId}_options_list input`))
                        .map(input => input.value || input.placeholder)
                        .filter(value => value);
                    previewHTML += `<select disabled><option>Choose ${label.toLowerCase()}</option>`;
                    selectOptions.forEach(option => {
                        previewHTML += `<option>${option}</option>`;
                    });
                    previewHTML += `</select>`;
                    break;
                case 'radio':
                    const radioOptions = Array.from(document.querySelectorAll(`#${fieldId}_options_list input`))
                        .map(input => input.value || input.placeholder)
                        .filter(value => value);
                    radioOptions.forEach((option, index) => {
                        previewHTML += `
                            <div style="margin-bottom: 0.5rem;">
                                <input type="radio" name="${fieldId}_preview_radio" id="${fieldId}_radio_${index}" disabled>
                                <label for="${fieldId}_radio_${index}" style="margin-left: 0.5rem;">${option}</label>
                            </div>
                        `;
                    });
                    break;
                case 'checkbox':
                    previewHTML += `
                        <div>
                            <input type="checkbox" id="${fieldId}_checkbox_preview" disabled>
                            <label for="${fieldId}_checkbox_preview" style="margin-left: 0.5rem;">${label}</label>
                        </div>
                    `;
                    break;
                case 'file':
                    previewHTML += `<input type="file" disabled>`;
                    break;
            }
            
            if (description) {
                previewHTML += `<small style="color: #6c757d; display: block; margin-top: 0.25rem;">${description}</small>`;
            }
            
            previewHTML += `</div>`;
            previewContainer.innerHTML = previewHTML;        }
        
        // Collect custom fields data
        function collectCustomFieldsData() {
            console.log('Collecting custom fields data...');
            const customFields = [];
            
            try {
                const customFieldItems = document.querySelectorAll('.custom-field-item');
                console.log('Found custom field items:', customFieldItems.length);
                
                customFieldItems.forEach((item, index) => {
                    try {
                        const fieldId = item.id;
                        console.log('Processing custom field:', fieldId);
                        
                        const labelEl = document.getElementById(`${fieldId}_label`);
                        const typeEl = document.getElementById(`${fieldId}_type`); 
                        const descriptionEl = document.getElementById(`${fieldId}_description`);
                        const defaultEl = document.getElementById(`${fieldId}_default`);
                        const validationEl = document.getElementById(`${fieldId}_validation`);
                        
                        if (!labelEl || !typeEl) {
                            console.warn('Missing required elements for field:', fieldId);
                            return;
                        }
                        
                        const label = labelEl.value || '';
                        const type = typeEl.value || 'text';
                        const description = descriptionEl ? descriptionEl.value || '' : '';
                        const defaultValue = defaultEl ? defaultEl.value || '' : '';
                        const validation = validationEl ? validationEl.value || '' : '';
                        
                        let options = [];
                        if (type === 'select' || type === 'radio') {
                            const optionInputs = document.querySelectorAll(`#${fieldId}_options_list input`);
                            options = Array.from(optionInputs)
                                .map(input => input.value)
                                .filter(value => value.trim() !== '');
                        }
                        
                        if (label.trim() !== '') {
                            customFields.push({
                                id: fieldId,
                                label: label.trim(),
                                type: type,
                                description: description.trim(),
                                defaultValue: defaultValue.trim(),
                                validation: validation,                                options: options,
                                order: customFields.length,
                                // Add a unique identifier based on label to prevent duplicates
                                labelId: label.trim().toLowerCase().replace(/[^a-z0-9]/g, '_')
                            });
                        }
                    } catch (fieldError) {
                        console.error('Error processing custom field:', fieldError);
                    }
                });
                console.log('Collected custom fields:', customFields);
                return customFields;
                
            } catch (error) {
                console.error('Error collecting custom fields data:', error);
                return [];
            }
        }

        // Load custom fields in edit mode
        function loadCustomFields(customFields) {
            if (!customFields || customFields.length === 0) return;
            
            const customFieldsContainer = document.getElementById('customFieldsContainer');
            customFieldsContainer.innerHTML = '';
            customFieldCounter = 0;
            
            customFields.forEach(field => {
                addCustomField();
                const fieldId = `custom_field_${customFieldCounter}`;
                
                // Populate field data
                document.getElementById(`${fieldId}_label`).value = field.label || '';
                document.getElementById(`${fieldId}_type`).value = field.type || 'text';
                document.getElementById(`${fieldId}_description`).value = field.description || '';
                document.getElementById(`${fieldId}_default`).value = field.defaultValue || '';
                document.getElementById(`${fieldId}_validation`).value = field.validation || '';
                
                // Handle field type change to show/hide options
                handleFieldTypeChange(fieldId);
                
                // Load options for select/radio fields
                if (field.options && field.options.length > 0) {
                    const optionsList = document.getElementById(`${fieldId}_options_list`);
                    optionsList.innerHTML = '';
                    
                    field.options.forEach((option, index) => {
                        if (index === 0) {
                            addFieldOption(fieldId);
                        } else {
                            addFieldOption(fieldId);
                        }
                        const optionInputs = optionsList.querySelectorAll('input');
                        if (optionInputs[index]) {
                            optionInputs[index].value = option;
                        }
                    });
                }
                
                // Update preview
                updateFieldPreview(fieldId);
            });
        }

        // ===============================
        // APPROVAL FLOW FUNCTIONS
        // ===============================

        // Fetch company-specific approval flow configuration from Firebase - matches staff.html
        async function fetchContractApprovalFlowConfig() {
            try {
                // Get current company context
                const user = auth.currentUser;
                if (!user) {
                    console.warn('No user authenticated for fetching approval flow config');
                    return null;
                }

                // Try to get user's company ID
                const userSnapshot = await database.ref(`users/${user.uid}`).once('value');
                const userData = userSnapshot.val();
                
                if (!userData || !userData.companyId) {
                    console.warn('No company context available for fetching approval flow config');
                    // Try global fallback
                    const globalRef = database.ref('approvalFlows/contract_approval');
                    const globalSnapshot = await globalRef.once('value');
                    return globalSnapshot.val();
                }

                // Use company-specific path: companies/{companyId}/approvalFlows/contract_approval
                const approvalFlowRef = database.ref(`companies/${userData.companyId}/approvalFlows/contract_approval`);
                const snapshot = await approvalFlowRef.once('value');
                const config = snapshot.val();
                
                console.log('Contract approval flow config loaded:', config);
                
                if (config && config.enabled) {
                    // Validate the expected structure from approval-settings.html
                    if (config.selectedRoles && typeof config.selectedRoles === 'object') {
                        console.log('✅ Valid company-specific contract approval flow config found');
                        return config;
                    }
                }
                
                // Fallback to global config if company-specific not found or invalid
                console.log('Falling back to global contract approval flow config');
                const globalRef = database.ref('approvalFlows/contract_approval');
                const globalSnapshot = await globalRef.once('value');
                return globalSnapshot.val();
                
            } catch (error) {
                console.error('Error fetching contract approval flow config:', error);
                return null;
            }
        }

        // Check if contract approval flow is sequential - matches staff.html pattern
        async function isContractApprovalFlowSequential() {
            try {
                const config = await fetchContractApprovalFlowConfig();
                if (!config || !config.enabled) {
                    return false;
                }
                
                // Check if flowType is sequential (default behavior if not specified)
                return config.approvalOrder === 'sequential' || 
                       config.approvalSequence === 'sequential' || 
                       !config.approvalOrder; // Default to sequential
            } catch (error) {
                console.error('Error checking if contract approval flow is sequential:', error);
                return false; // Default to non-sequential if error
            }
        }

        // Generate comprehensive approval flow HTML for contracts - matches staff.html generateApprovalFlowHTML
        async function generateContractApprovalFlowHTML(contract) {
            try {
                const config = await fetchContractApprovalFlowConfig();
                
                if (!config) {
                    return `
                        <div class="no-approval-flow">
                            <i class="fas fa-info-circle"></i>
                            <h4>No Approval Flow Configured</h4>
                            <p>Contract approval flow is not configured. Please set it up in the Approval Flow Settings.</p>
                        </div>
                    `;
                }
                
                console.log('Generating contract approval flow HTML with config:', config);
                
                // Check if the contract has been declined - this ends the approval process
                if (contract.approvalStatus === 'declined' || contract.overallStatus === 'declined') {
                    console.log('Contract has been declined, showing decline information');
                    
                    // Find the decline record
                    let declineRecord = null;
                    if (contract.approvalHistory && Array.isArray(contract.approvalHistory)) {
                        declineRecord = contract.approvalHistory.find(h => h.status === 'rejected' || h.status === 'declined');
                    }
                    
                    return `
                        <div class="approval-flow-section">
                            <div class="approval-flow-header">
                                <h4 class="approval-flow-title" style="color: #dc3545;">
                                    <i class="fas fa-times-circle"></i>
                                    Contract Declined
                                </h4>
                                <span class="approval-flow-status" style="background: #f8d7da; color: #721c24;">
                                    Declined
                                </span>
                            </div>
                            <div style="padding: 1rem; background: #f8d7da; color: #721c24; border-radius: 6px; text-align: center;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                <p style="margin: 0; font-weight: 600;">This contract has been declined and will not proceed further in the approval process.</p>
                                ${declineRecord ? `
                                    <div style="margin-top: 1rem; font-size: 0.9rem;">
                                        <strong>Declined by:</strong> ${declineRecord.approverName || declineRecord.rejectedBy || 'Unknown'}<br>
                                        <strong>Date:</strong> ${declineRecord.rejectedAt ? new Date(declineRecord.rejectedAt).toLocaleString() : 'Unknown'}
                                        ${declineRecord.comments ? `<br><strong>Reason:</strong> ${declineRecord.comments}` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Continue with normal approval flow if not declined
                const isSequential = await isContractApprovalFlowSequential();
                
                let approvalHTML = `
                    <div class="approval-flow-section">
                        <div class="approval-flow-header">
                            <h4 class="approval-flow-title">
                                <i class="fas fa-route"></i>
                                Approval Flow ${isSequential ? '(Sequential)' : '(Parallel)'}
                            </h4>
                            <span class="approval-flow-status ${config.enabled ? 'enabled' : 'disabled'}">
                                ${config.enabled ? 'Enabled' : 'Disabled'}
                            </span>
                        </div>
                `;
                
                // Add sequential info if needed
                if (isSequential) {
                    approvalHTML += `
                        <div class="sequential-info">
                            <i class="fas fa-info-circle"></i>
                            Sequential approval: Each level must approve before the next level can act.
                        </div>
                    `;
                }
                
                approvalHTML += `<div class="approval-stages">`;
                
                // Check if we have selectedRoles and it's an object
                if (config.selectedRoles && typeof config.selectedRoles === 'object') {
                    const levelKeys = Object.keys(config.selectedRoles);
                    
                    for (let i = 0; i < levelKeys.length; i++) {
                        const levelKey = levelKeys[i];
                        const levelNumber = i + 1;
                        const roles = config.selectedRoles[levelKey];
                        
                        // Determine stage status and approver info
                        let stageStatus = 'waiting';
                        let approverName = 'Not assigned';
                        let timestamp = '';
                        let comments = '';
                        
                        // Check approval history
                        if (contract.approvalHistory && Array.isArray(contract.approvalHistory)) {
                            const historyRecord = contract.approvalHistory.find(h => h.level === levelKey);
                            if (historyRecord) {
                                if (historyRecord.status === 'approved') {
                                    stageStatus = 'completed';
                                    approverName = historyRecord.approverName || historyRecord.approvedBy || 'Unknown';
                                    timestamp = historyRecord.approvedAt || historyRecord.timestamp;
                                    comments = historyRecord.comments || '';
                                } else if (historyRecord.status === 'rejected' || historyRecord.status === 'declined') {
                                    stageStatus = 'rejected';
                                    approverName = historyRecord.approverName || historyRecord.rejectedBy || 'Unknown';
                                    timestamp = historyRecord.rejectedAt || historyRecord.timestamp;
                                    comments = historyRecord.comments || '';
                                }
                            }
                        }
                        
                        // If no history record, get approver from configuration
                        if (approverName === 'Not assigned' && roles && roles.length > 0) {
                            approverName = roles[0].text || roles[0].name || 'Configured Approver';
                        }
                        
                        // Format timestamp
                        let formattedTimestamp = '';
                        if (timestamp) {
                            try {
                                const date = new Date(timestamp);
                                formattedTimestamp = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                            } catch (e) {
                                formattedTimestamp = timestamp;
                            }
                        }
                        
                        // Apply stage classes
                        let stageClasses = 'approval-stage';
                        let numberClasses = 'stage-number';
                        
                        if (stageStatus === 'completed') {
                            numberClasses += ' completed';
                        } else if (stageStatus === 'rejected') {
                            numberClasses += ' rejected';
                        } else if (stageStatus === 'pending') {
                            stageClasses += ' current';
                            numberClasses += ' current';
                        } else {
                            numberClasses += ' waiting';
                        }
                        
                        approvalHTML += `
                            <div class="${stageClasses}">
                                <div class="${numberClasses}">
                                    ${stageStatus === 'completed' ? '<i class="fas fa-check"></i>' : 
                                      stageStatus === 'rejected' ? '<i class="fas fa-times"></i>' : 
                                      levelNumber}
                                </div>
                                <div class="stage-info">
                                    <div class="stage-title">Level ${levelNumber}</div>
                                    <div class="approver-info">
                                        <span class="approver-name">${approverName}</span>
                                    </div>
                                    ${formattedTimestamp ? `<div class="stage-timestamp">${formattedTimestamp}</div>` : ''}
                                    ${comments ? `
                                        <div class="stage-comments">
                                            <i class="fas fa-comment"></i>
                                            ${comments}
                                        </div>
                                    ` : ''}
                                    <div class="stage-status-text ${stageStatus}">
                                        ${stageStatus === 'completed' ? 'Approved' : 
                                          stageStatus === 'rejected' ? 'Rejected' : 
                                          stageStatus === 'pending' ? 'Awaiting approval' : 'Waiting'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    approvalHTML += `
                        <div class="no-approval-flow">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Invalid approval flow configuration. Please check the settings.</p>
                        </div>
                    `;
                }
                
                approvalHTML += `
                        </div>
                    </div>
                `;
                
                console.log('Generated contract approval flow HTML successfully');
                return approvalHTML;
                
            } catch (error) {
                console.error('Error generating contract approval flow HTML:', error);
                return `
                    <div class="approval-flow-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading approval flow: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Populate approval flow section in contract modal - Updated to match staff.html - Updated to match staff.html
        async function populateApprovalFlow(contract) {
            const approvalFlowContainer = document.getElementById('modalApprovalFlow');
            const approvalStatusEl = document.getElementById('modalApprovalStatus');
            const currentApproverEl = document.getElementById('modalCurrentApprover');
            const approvalFlowListEl = document.getElementById('modalApprovalFlowList');

            // Show loading state
            approvalFlowListEl.innerHTML = `
                <div class="approval-flow-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading approval flow...
                </div>
            `;

            try {
                console.log('Populating approval flow for contract:', contract.id || contract.contractId);
                
                // Set initial values
                approvalStatusEl.textContent = contract.approvalStatus || 'Pending';
                currentApproverEl.textContent = contract.currentApprover || 'Not assigned';
                
                // Use the new comprehensive approval flow HTML generator (matches staff.html approach)
                const approvalFlowHTML = await generateContractApprovalFlowHTML(contract);
                approvalFlowListEl.innerHTML = approvalFlowHTML;
                
            } catch (error) {
                console.error('Error populating approval flow:', error);
                approvalFlowListEl.innerHTML = `
                    <div class="approval-flow-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading approval flow: ${error.message}</p>
                    </div>
                `;
            }
        }

        // ===============================
        // TEMPLATE MANAGEMENT FUNCTIONS
        // ===============================

        // ===============================
        // MENU VISIBILITY MANAGEMENT
        // ============================================
        // FEATURE-BASED MENU AUTHORIZATION SYSTEM
        // ============================================
        // Enhanced menu visibility system based on roles.html template
        
        // Reset all menu items to hidden
        function resetMenuVisibility() {
            document.querySelectorAll('[data-feature]').forEach(item => {
                item.classList.remove('menu-visible');
            });
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('menu-visible');
            });
        }

        // Emergency fallback - show basic menu items
        function showBasicMenu() {
            console.log('🔧 Emergency fallback: Showing basic menu items');
            resetMenuVisibility();
            const homeItem = document.querySelector('[data-feature="home_view"]');
            if (homeItem) {
                homeItem.classList.add('menu-visible');
            }
        }

        // Feature-based authorization system that takes priority over role permissions
        async function updateMenuWithFeatureAuthorization() {
            console.log('🎯 Starting feature-based menu authorization for contract.html...');
            
            try {
                let currentUser = null;
                let companyId = null;
                
                // Get user and company info using authManager first
                if (window.authManager && window.authManager.currentUser) {
                    currentUser = window.authManager.currentUser;
                    companyId = currentUser.companyId;
                    console.log('👤 Using AuthManager - User:', currentUser.email, 'Company ID:', companyId);
                } else if (firebase.auth().currentUser) {
                    currentUser = firebase.auth().currentUser;
                    console.log('👤 Using Firebase auth - will search for company');
                } else {
                    console.log('❌ No authenticated user found');
                    resetMenuVisibility();
                    return;
                }
                
                // If no company ID from authManager, search companies collection
                if (!companyId && currentUser) {
                    console.log('🔍 Searching for user company...');
                    const database = firebase.database();
                    const companiesRef = database.ref('companies');
                    const companiesSnapshot = await companiesRef.once('value');
                    
                    if (companiesSnapshot.exists()) {
                        const companies = companiesSnapshot.val();
                        
                        for (const [cId, company] of Object.entries(companies)) {
                            if (company.status !== 'active') continue;
                            
                            if (company.users && company.users[currentUser.uid]) {
                                companyId = cId;
                                console.log(`✅ Found user in company: ${companyId} (${company.name})`);
                                break;
                            }
                        }
                    }
                }
                
                if (!companyId) {
                    console.error('❌ No company ID found, cannot determine authorized features');
                    resetMenuVisibility();
                    return;
                }
                
                // Apply feature-based authorization
                await applyFeatureBasedMenuVisibility(companyId);
                
            } catch (error) {
                console.error('❌ Error in feature-based menu authorization:', error);
                resetMenuVisibility();
            }
        }

        // Apply feature-based menu visibility
        async function applyFeatureBasedMenuVisibility(companyId) {
            try {
                console.log('🔧 Applying feature-based menu visibility for company:', companyId);
                
                // Get platform features
                const database = firebase.database();
                const featuresSnapshot = await database.ref('/platformFeatures').once('value');
                
                if (!featuresSnapshot.exists()) {
                    console.log('⚠️ No platform features found');
                    resetMenuVisibility();
                    return;
                }
                
                const featuresData = featuresSnapshot.val();
                
                // Get company's selected features
                const companySnapshot = await database.ref(`/companies/${companyId}`).once('value');
                const companyData = companySnapshot.val();
                
                if (!companyData) {
                    console.error('❌ Company data not found');
                    resetMenuVisibility();
                    return;
                }
                
                const subscribedFeatureIds = companyData.selectedFeatures || [];
                console.log('🏢 Company subscribed features:', subscribedFeatureIds);
                
                if (subscribedFeatureIds.length === 0) {
                    console.log('⚠️ Company has no subscribed features');
                    resetMenuVisibility();
                    return;
                }
                
                // Collect authorized pages from subscribed features
                const authorizedPages = [];
                subscribedFeatureIds.forEach(featureId => {
                    const feature = featuresData[featureId];
                    if (feature && feature.status === 'active' && feature.authorizedPages) {
                        console.log(`📦 Adding pages from feature "${feature.name}":`, feature.authorizedPages);
                        authorizedPages.push(...feature.authorizedPages);
                    } else {
                        console.log(`⚠️ Feature ${featureId} not found or inactive`);
                    }
                });
                
                console.log('🔐 All authorized pages:', authorizedPages);
                
                // Reset all menu items first
                resetMenuVisibility();
                
                // Create set of authorized features
                const authorizedFeatures = new Set();
                authorizedPages.forEach(pageInfo => {
                    if (pageInfo.feature) {
                        authorizedFeatures.add(pageInfo.feature);
                    }
                });
                
                console.log('🎯 Authorized features for contract.html:', Array.from(authorizedFeatures));
                
                // Apply menu visibility
                const allMenuItems = document.querySelectorAll('#roleBasedMenu li[data-feature]');
                let visibleCount = 0;
                
                allMenuItems.forEach(menuItem => {
                    const featureAttribute = menuItem.getAttribute('data-feature');
                    const isAuthorized = authorizedFeatures.has(featureAttribute);
                    const isDropdownContainer = menuItem.classList.contains('menu-dropdown');
                    
                    if (isDropdownContainer) {
                        return; // Handle dropdowns separately after all items are processed
                    }
                    
                    if (isAuthorized) {
                        menuItem.classList.add('menu-visible');
                        visibleCount++;
                        console.log(`✅ Feature authorized - showing menu item: ${featureAttribute}`);
                    } else {
                        menuItem.classList.remove('menu-visible');
                        console.log(`❌ Feature not authorized - hiding menu item: ${featureAttribute}`);
                    }
                });
                
                // Handle dropdown menus - show if they have visible children
                const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
                dropdownMenus.forEach(dropdown => {
                    const dropdownFeature = dropdown.getAttribute('data-feature');
                    const submenuItems = dropdown.querySelectorAll('.submenu li[data-feature]');
                    let hasVisibleChildren = false;
                    
                    submenuItems.forEach(submenuItem => {
                        if (submenuItem.classList.contains('menu-visible')) {
                            hasVisibleChildren = true;
                        }
                    });
                    
                    if (hasVisibleChildren || authorizedFeatures.has(dropdownFeature)) {
                        dropdown.classList.add('menu-visible');
                        console.log(`✅ Showing dropdown menu: ${dropdownFeature} (has visible children or directly authorized)`);
                    } else {
                        dropdown.classList.remove('menu-visible');
                        console.log(`❌ Hiding dropdown menu: ${dropdownFeature} (no visible children and not authorized)`);
                    }
                });
                
                console.log(`🎯 Feature-based menu authorization completed for contract.html - ${visibleCount} items visible`);
                
            } catch (error) {
                console.error('❌ Error applying feature-based menu visibility:', error);
                resetMenuVisibility();
            }
        }

        // Make updateMenuWithFeatureAuthorization available globally
        window.updateMenuWithFeatureAuthorization = updateMenuWithFeatureAuthorization;

// Enhanced initialization - use feature-based authorization by default
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Contract page loaded - initializing...');
    
    // Check if Firebase is loaded
    if (typeof firebase === 'undefined') {
        console.error('❌ Firebase not loaded! This will cause menu issues.');
        return;
    }
    
    // Check if essential elements exist
    const sidebar = document.querySelector('.sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if (!sidebar) {
        console.error('❌ Sidebar not found! Page structure issue.');
    }
    
    if (!mainContent) {
        console.error('❌ Main content not found! Page structure issue.');
    }
    
    console.log('✅ Page structure validated');
    
    // Wait for auth manager to be ready
    setTimeout(async () => {
        try {
            console.log('🔄 Initializing menu authorization...');
            await updateMenuWithFeatureAuthorization();
            console.log('✅ Menu authorization completed');
        } catch (error) {
            console.error('❌ Error initializing feature-based menu:', error);
            console.log('🔧 Falling back to basic menu');
            showBasicMenu();
        }
    }, 1500);
});    </script>

<script>
// Error handling for missing resources
window.addEventListener('error', function(e) {
  console.error('Resource loading error:', e.target.src || e.target.href);
  
  // Handle missing CSS files
  if (e.target.tagName === 'LINK' && e.target.rel === 'stylesheet') {
    console.warn('CSS file not found:', e.target.href);
  }
  
  // Handle missing JS files
  if (e.target.tagName === 'SCRIPT') {
    console.warn('JavaScript file not found:', e.target.src);
  }
});

// Check if critical files are loaded
document.addEventListener('DOMContentLoaded', function() {
  // Check if main CSS is loaded
  const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
  let mainCssLoaded = false;
  
  stylesheets.forEach(function(link) {
    if (link.href.includes('css/styles.css')) {
      mainCssLoaded = true;
    }
  });
  
  if (!mainCssLoaded) {
    console.warn('Main CSS file (css/styles.css) may not be loaded properly');
  }
});

    </script>
</body>
</html>

