<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gate Pass Requests Board - Dreamex Datalab HSE</title>
	<!-- Firebase v8 CDN (match other pages) -->
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<meta name="robots" content="noindex, nofollow">
	<style>
		/* === Core Variables / Layout (derived from recruitboard + staff) === */
		:root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --orange:#e67e22; --red:#e74c3c; --purple:#9b59b6; --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem; --font-scale:1; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333; --text-secondary:#666; --border-color:#e0e0e0; --spacing-unit:.9rem; --padding-sm:.45rem; --padding-md:.75rem; --padding-lg:1.2rem; --transition-speed:.2s; }
		*{margin:0;padding:0;box-sizing:border-box;} body{font-family:var(--font-family);font-size:var(--base-font-size);line-height:1.4;color:var(--text-primary);background:#f8f9fa;}
		.app-container{display:flex;min-height:100vh;}
		.sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;height:100vh;overflow-y:auto;transition:transform .3s ease;}
		.sidebar.collapsed{transform:translateX(-100%);} .logo h2{text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.05rem;}
		.menu{list-style:none;margin-top:1.5rem;} .menu li{margin-bottom:.45rem;} .menu a{color:#fff;text-decoration:none;display:flex;align-items:center;padding:.65rem .9rem;border-radius:6px;font-size:.78rem;gap:.55rem;letter-spacing:.25px;transition:background .25s;} .menu a:hover,.menu a.active{background:var(--secondary-color);} .menu-dropdown .submenu{display:none;list-style:none;margin-left:1.2rem;margin-top:.35rem;} .menu-dropdown:hover .submenu{display:block;}
		/* Feature-based visibility */
		[data-feature]:not(.menu-visible){display:none !important;} .menu-dropdown:not(.menu-visible){display:none !important;} 
		
		/* Hide ALL menu items by default during loading */
		.sidebar.menu-loading .menu-item, .sidebar.menu-loading .menu-dropdown, .sidebar.menu-loading li[data-feature], .sidebar.menu-loading [data-feature] {display:none !important;} .menu-loading [data-feature]{display:none !important;} .menu-loading .menu-dropdown{display:none !important;}
		.main-content{flex:1;margin-left:var(--sidebar-width);padding:.45rem;width:calc(100% - var(--sidebar-width));box-sizing:border-box;display:flex;flex-direction:column;transition:margin-left .3s ease,width .3s ease;}
		.main-content.sidebar-collapsed{margin-left:0;width:100%;}
		/* Top Nav (copied style approach from staff.html) */
		.top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:.35rem;position:fixed;top:.25rem;right:.5rem;left:calc(var(--sidebar-width) + .5rem);height:50px;min-height:50px;z-index:100;transition:left .3s ease;}
		.top-nav-left{display:flex;align-items:center;gap:1rem;font-size:.8rem;font-weight:600;color:var(--text-secondary);} .sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;padding:.45rem;color:#666;border-radius:6px;display:flex;align-items:center;justify-content:center;} .sidebar-toggle-btn:hover{background:rgba(0,0,0,.06);}
		#headerCompanyLogo{width:44px;height:44px;object-fit:cover;display:none;background:transparent;border:none;box-shadow:none;} #headerCompanyLogo.visible{display:block;} #headerCompanyName{font-size:.8rem;font-weight:600;letter-spacing:.5px;color:var(--primary-color);max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
		.top-nav-right{display:flex;align-items:center;gap:1.2rem;margin-left:auto;}
		.notifications{position:relative;display:flex;align-items:center;} .notification-btn{background:none;border:none;cursor:pointer;position:relative;font-size:1.2rem;padding:.5rem;display:flex;align-items:center;justify-content:center;} .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--accent-color);color:#fff;border-radius:50%;padding:.2rem .5rem;font-size:.7rem;}
		.notification-dropdown{display:none;position:absolute;right:0;top:100%;width:320px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:1000;border:1px solid #e9ecef;max-height:400px;overflow:hidden;}
		.notification-dropdown.show{display:block;animation:slideDown 0.2s ease-out;} @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}} .notification-header{padding:12px 16px;border-bottom:1px solid #e9ecef;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);display:flex;justify-content:space-between;align-items:center;} .notification-header h3{margin:0;color:#333;font-size:14px;font-weight:600;} .mark-all-read{background:none;border:none;color:#3498db;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px;transition:all 0.2s ease;} .mark-all-read:hover{background:#e3f2fd;color:#1976d2;} .clear-all-notifications{background:none;border:none;color:#e74c3c;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px;transition:all 0.2s ease;margin-left:8px;} .clear-all-notifications:hover{background:#fdf2f2;color:#c0392b;} .notification-actions{position:absolute;top:8px;right:8px;display:none;gap:4px;} .notification-item:hover .notification-actions{display:flex;} .mark-read-btn,.delete-notification-btn{background:none;border:none;cursor:pointer;padding:4px;border-radius:3px;transition:all 0.2s ease;font-size:12px;} .mark-read-btn{color:#3498db;} .mark-read-btn:hover{background:#e3f2fd;color:#1976d2;} .delete-notification-btn{color:#e74c3c;} .delete-notification-btn:hover{background:#fdf2f2;color:#c0392b;} .notification-item.read .mark-read-btn{color:#95a5a6;cursor:default;} .notification-item.read .mark-read-btn:hover{background:none;color:#95a5a6;} .notification-list{max-height:320px;overflow-y:auto;padding:0;} .notification-list::-webkit-scrollbar{width:4px;} .notification-list::-webkit-scrollbar-track{background:#f1f1f1;} .notification-list::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:2px;} .notification-item{padding:12px 16px;border-bottom:1px solid #f1f1f1;cursor:pointer;transition:background-color 0.2s ease;position:relative;} .notification-item:hover{background:#f8f9fa;} .notification-item.unread{background:#e8f4fd;border-left:3px solid #3498db;} .notification-item.unread::before{content:'';position:absolute;top:16px;right:16px;width:8px;height:8px;background:#3498db;border-radius:50%;} .notification-dot{position:absolute;top:16px;right:16px;width:8px;height:8px;background:#3498db;border-radius:50%;} .notification-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;margin-right:12px;flex-shrink:0;} .notification-icon.info{background:#e3f2fd;color:#1976d2;} .notification-icon.success{background:#e8f5e8;color:#2e7d2e;} .notification-icon.warning{background:#fff3e0;color:#f57c00;} .notification-icon.error{background:#ffebee;color:#d32f2f;} .notification-content{flex:1;min-width:0;} .notification-title{font-weight:600;font-size:13px;color:#333;margin-bottom:2px;line-height:1.3;} .notification-message{font-size:12px;color:#666;line-height:1.4;word-wrap:break-word;} .notification-time{font-size:11px;color:#999;margin-top:4px;} .notification-empty{padding:40px 20px;text-align:center;color:#999;} .notification-empty i{font-size:32px;margin-bottom:12px;color:#ddd;} .notification-empty-title{font-size:14px;font-weight:500;margin-bottom:4px;color:#666;} .notification-empty-message{font-size:12px;color:#999;}
		.profile-btn{background:none;border:none;cursor:pointer;padding:.25rem;display:flex;align-items:center;position:relative;} 
		.profile-btn img{width:40px;height:40px;border-radius:50%;object-fit:cover;}
		.avatar-initials{width:40px;height:40px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px;font-family:Arial,sans-serif;}
		.profile-dropdown{display:none;position:absolute;top:100%;right:0;background:#fff;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,.12);min-width:200px;z-index:1000;} .profile-dropdown.show{display:block;} .profile-dropdown ul{list-style:none;margin:0;padding:0;} .profile-dropdown ul li a{display:flex;align-items:center;padding:12px 16px;color:#333;text-decoration:none;font-size:.78rem;gap:.6rem;transition:background .2s;} .profile-dropdown ul li a:hover{background:#f5f7fa;}
		.avatar-initials{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1rem;}
		/* Page Header (board title) */
		.page-header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;padding:.55rem .75rem;margin:.35rem 0 .5rem 0;display:flex;align-items:center;justify-content:space-between;box-shadow:0 10px 28px rgba(0,0,0,.18),0 6px 16px rgba(0,0,0,.14);font-size:.9rem;}
		.page-header i{font-size:1rem;}
		/* Add New Button */
		.btn-add-new{background:none;border:none;color:#fff;padding:.4rem;font-size:1.2rem;font-weight:600;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;text-decoration:none;}
		.btn-add-new:hover{color:rgba(255,255,255,0.8);transform:scale(1.1);}
		.btn-add-new i{font-size:1.2rem;}

		/* Tabs (modeled after pay-elements.html) */
		.content-tabs{margin-top:0;width:100%;}
		.tab-navigation{display:flex;background:#f8f9fa;box-shadow:0 2px 10px rgba(0,0,0,0.1);margin-bottom:0;border-bottom:1px solid #e9ecef;overflow:hidden;border-radius:8px;}
		.tab-nav-btn{flex:1;padding:.9rem 1.2rem;border:none;background:transparent;color:#6c757d;font-size:.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:.5rem;position:relative;transition:all .2s ease;}
		.tab-nav-btn:hover{background:rgba(255,255,255,0.7);color:#495057;transform:translateY(-1px);}
		.tab-nav-btn.active{background:#fff;color:#2c3e50;font-weight:700;box-shadow:0 -2px 8px rgba(0,0,0,0.06);transform:translateY(-2px);z-index:1;}
		.tab-nav-btn.active::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));}
		.tab-panel{display:none;padding:1rem 0;background:#fff;border-radius:8px;}
		.tab-panel.active{display:block;}

		/* Preview page (reuse payslip style visually) */
		.payslip-preview{max-width:210mm;margin:0 auto;background:#fff;box-shadow:none;padding:12mm;font-family:Arial, sans-serif;color:#000;line-height:1.45;min-height:160mm;border:1px solid #eaecef;border-radius:6px;font-size:11px;}
		.payslip-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid #e5e7eb;}
		/* Make the main heading in preview more compact */
		.payslip-header h1{font-size:16px;margin:0}
		.company-info{display:flex;align-items:center;gap:12px;}
		.company-logo img{width:52px;height:52px;object-fit:contain;border-radius:8px;}
		.company-details h1{font-size:18px;color:#2c3e50;margin:0;}
		.company-details p{margin:4px 0;font-size:12px;color:#666;}
		.payslip-title{font-size:16px;font-weight:700;color:#2c3e50;text-align:right;}
		.preview-grid{display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0 16px;}
		.preview-card{background:#fff;border:none;border-radius:6px;padding:10px;}
		.preview-card h4{margin:0 0 8px;font-size:11px;color:#2c3e50;border-bottom:1px solid #f0f2f5;padding-bottom:6px;}
		.detail-row{display:flex;justify-content:space-between;margin:4px 0;font-size:11px;gap:8px}
		.detail-label{color:#495057;font-weight:600}
		.detail-value{color:#111827;word-break:break-word}
		.preview-table{width:100%;border-collapse:collapse;margin:6px 0 10px;font-size:11px}
		/* Use the sidebar (primary) color for preview table headers */
		.preview-table th{background:var(--primary-color);color:#fff;padding:8px;text-align:left;border-bottom:1px solid #e5e7eb}
		.preview-table td{padding:8px;border-bottom:1px solid #e5e7eb}
		.preview-section-title{padding:6px 0;font-weight:700;color:#2c3e50;font-size:11px}
		.preview-purpose{background:#fff;border:none;border-radius:6px;padding:10px;min-height:60px;font-size:11px}
		.print-controls{display:flex;gap:.5rem;justify-content:center;align-items:center;background:#f8f9fa;border:1px solid #e5e7eb;border-radius:8px;padding:.75rem;margin-bottom:.75rem}

		/* Simple approval list for compact preview */
		.approval-flow-simple{background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:10px}
		.approval-flow-simple .approval-list{list-style:none;margin:0;padding:0}
		.approval-flow-simple .approval-list li{padding:6px 0;border-bottom:1px solid #f0f2f5;font-size:12px;color:#333}
		.approval-flow-simple .approval-list li:last-child{border-bottom:none}
		.approval-flow-simple .status{font-weight:600}
		.approval-flow-simple .status.approved{color:#1e8449}
		.approval-flow-simple .status.rejected{color:#c0392b}
		.approval-flow-simple .status.pending{color:#6c757d}

		@media print{ 
			/* Only print the preview */
			body *{visibility:hidden !important}
			#accessPreview, #accessPreview *{visibility:visible !important}
			.sidebar, .top-nav, .tab-navigation, .print-controls{display:none !important}
			#accessPreview{position:absolute;top:0;left:0;right:0;margin:0 auto;box-shadow:none !important}
			@page{size:A4 portrait;margin:12mm}
		}
		/* Filters Bar */
		.filters-bar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:flex-end;margin-bottom:.5rem;background:#fff;padding:.6rem .65rem;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.08);} .filters-bar .form-group{display:flex;flex-direction:column;gap:.25rem;} .filters-bar label{font-size:.6rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#555;} .filters-bar input,.filters-bar select{padding:.4rem .55rem;font-size:.7rem;border:1px solid #d0d7de;border-radius:6px;min-width:160px;background:#fff;} .filters-bar input:focus,.filters-bar select:focus{outline:2px solid var(--secondary-color);outline-offset:0;border-color:var(--secondary-color);}
		/* Table */
		.board-card{background:#fff;border-radius:10px;padding:.65rem .75rem;box-shadow:0 1px 3px rgba(0,0,0,.08);display:flex;flex-direction:column;flex:1;min-height:0;}
		.table-wrapper{overflow:auto;flex:1;}
		table{width:100%;border-collapse:collapse;font-size:.7rem;} 
		thead th{position:sticky;top:0;background:#f5f6f9;z-index:2;font-weight:600;text-align:left;padding:.45rem .55rem;border-bottom:1px solid #e3e6eb;font-size:.65rem;letter-spacing:.4px;text-transform:uppercase;color:#555;} 
		tbody td{padding:.45rem .55rem;border-bottom:1px solid #f0f1f3;vertical-align:middle;line-height:1.25;} 
		tbody tr:hover{background:#f9fbfe;} 
		tbody tr:last-child td{border-bottom:none;}
		/* Hide specific columns we still want hidden: Area, Property Removal, To be Returned, Actions */
		thead th:nth-child(5), tbody td:nth-child(5), /* Area */
		thead th:nth-child(9), tbody td:nth-child(9), /* Property Removal */
		thead th:nth-child(10), tbody td:nth-child(10), /* To be Returned */
		thead th:nth-child(11), tbody td:nth-child(11) /* Actions */
		{ display: none; }
		.badge{display:inline-block;padding:.22rem .5rem;border-radius:14px;font-size:.55rem;font-weight:600;letter-spacing:.4px;position:relative;top:-1px;} .badge-status-submitted{background:#e6f0fe;color:#1d4ed8;} .badge-status-updated{background:#f3e8ff;color:#6d28d9;} .badge-status-approved{background:#e6f9ef;color:#1e8449;} .badge-status-rejected{background:#ffe7e6;color:#c0392b;}
		.actions{display:flex;gap:.3rem;} .btn{padding:.35rem .55rem;border:none;border-radius:5px;font-size:.6rem;font-weight:500;display:inline-flex;align-items:center;gap:.35rem;cursor:pointer;line-height:1;transition:background .2s,box-shadow .2s;} .btn-view{background:#ecf5ff;color:#1b6fbf;} .btn-view:hover{background:#d9ecff;} .btn-edit{background:#e9f7ef;color:#1e824c;} .btn-edit:hover{background:#d5f2e0;}
		.empty-state{padding:2rem 1rem;text-align:center;color:#666;font-size:.75rem;}
		/* Row click */
		tbody tr.clickable-row{cursor:pointer;}
		tbody tr.clickable-row:active{background:#eef5ff;}
		/* Modal Styles */
		.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:flex-start;justify-content:center;padding:3rem 1rem;z-index:2000;overflow-y:auto;}
		.modal-backdrop.hidden{display:none;}
		.modal-panel{background:#fff;width:min(1100px,100%);border-radius:12px;box-shadow:0 10px 40px -5px rgba(0,0,0,.25);display:flex;flex-direction:column;max-height:calc(100vh - 6rem);}
		.modal-header{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1.1rem;border-bottom:1px solid #e5e7eb;gap:.75rem;}
		.modal-title{font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:.5rem;color:#1f2937;}
		.modal-close{background:none;border:none;font-size:1.1rem;cursor:pointer;color:#666;padding:.35rem;border-radius:6px;}
		.modal-close:hover{background:#f1f5f9;color:#111;}
		.modal-body{padding:1rem 1.1rem .9rem;overflow-y:auto;font-size:.68rem;line-height:1.35;}
		.detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.65rem;margin-bottom:1rem;}
		.detail-item{background:#f8fafc;border:1px solid #edf2f7;padding:.55rem .6rem;border-radius:8px;display:flex;flex-direction:column;gap:.25rem;}
		.detail-item h5{margin:0;font-size:.55rem;font-weight:600;letter-spacing:.5px;color:#555;text-transform:uppercase;}
		.detail-item span{font-size:.65rem;font-weight:500;color:#222;word-break:break-word;}
		.section-title{margin:.75rem 0 .4rem;font-size:.62rem;font-weight:700;letter-spacing:.5px;color:#374151;text-transform:uppercase;}
		.inline-badge{display:inline-block;background:#eef2ff;color:#1d4ed8;font-size:.55rem;font-weight:600;padding:.18rem .45rem;border-radius:14px;margin:0 .25rem .25rem 0;}
		.list-table{width:100%;border-collapse:collapse;margin-bottom:.75rem;font-size:.62rem;}
		.list-table th{background:#f1f5f9;text-align:left;padding:.4rem .45rem;font-weight:600;font-size:.55rem;border-bottom:1px solid #e2e8f0;letter-spacing:.4px;}
		.list-table td{padding:.4rem .45rem;border-bottom:1px solid #f1f5f9;vertical-align:top;}
		.no-data{opacity:.6;font-style:italic;}
		.modal-footer{padding:.75rem 1.1rem;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:.5rem;}
		.btn-small{padding:.4rem .7rem;font-size:.6rem;border:none;border-radius:6px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:.4rem;}
		.btn-outline{background:#fff;border:1px solid #d1d5db;color:#374151;}
		.btn-outline:hover{background:#f3f4f6;}
		.btn-primary{background:#2563eb;color:#fff;}
		.btn-primary:hover{background:#1d4ed8;}
		/* Status pills */
		.status-pill{display:inline-flex;align-items:center;gap:.3rem;padding:.28rem .55rem;border-radius:20px;font-size:.55rem;font-weight:600;letter-spacing:.4px;background:#f0f2f5;color:#444;cursor:pointer;user-select:none;border:1px solid transparent;}
		.status-pill.active{background:#1d4ed8;color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.12);} .status-pill[data-status="updated"].active{background:#6d28d9;} .status-pill[data-status="approved"].active{background:#1e8449;} .status-pill[data-status="rejected"].active{background:#c0392b;}
		.status-pill[data-status="updated"]{background:#f3e8ff;color:#6d28d9;} .status-pill[data-status="approved"]{background:#e6f9ef;color:#1e8449;} .status-pill[data-status="rejected"]{background:#ffe7e6;color:#c0392b;} .status-pill[data-status="submitted"]{background:#e6f0fe;color:#1d4ed8;}
		.btn-export{background:#e6f5ff;color:#1d6fd8;} .btn-export:hover{background:#d4ecff;}
		.btn-clear{background:#f0f2f5;color:#333;} .btn-clear:hover{background:#e4e6e8;}
		/* Responsive */
		@media (max-width:900px){ .sidebar{position:fixed;z-index:1500;} .main-content{margin-left:0;width:100%;} .top-nav{left:.5rem;} .sidebar.collapsed{transform:translateX(-100%);} }

		/* Approval Flow Styles */
		.approval-flow-section {
			background: #f8f9fa;
			border-radius: 8px;
			padding: 1.5rem;
			margin-bottom: 1.5rem;
		}

		.approval-flow-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}

		.approval-flow-title {
			color: #007bff;
			font-weight: 700;
			margin: 0;
			font-size: 1rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.approval-flow-status {
			font-size: 0.8rem;
			padding: 0.25rem 0.75rem;
			border-radius: 12px;
			font-weight: 600;
			text-transform: uppercase;
		}

		.approval-flow-status.enabled {
			background: #d4edda;
			color: #155724;
		}

		.approval-flow-status.disabled {
			background: #f8d7da;
			color: #721c24;
		}

		.approval-flow-status.pending {
			background: #fff3cd;
			color: #856404;
		}

		.approval-flow-status.approved {
			background: #d4edda;
			color: #155724;
		}

		.approval-flow-status.rejected {
			background: #f8d7da;
			color: #721c24;
		}

		.approval-stages {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}

		.approval-stage {
			display: flex;
			align-items: center;
			gap: 1rem;
			padding: 1rem;
			background: white;
			border-radius: 8px;
			border: 1px solid #e9ecef;
			position: relative;
		}

		.approval-stage:not(:last-child)::after {
			content: '';
			position: absolute;
			bottom: -0.5rem;
			left: 25px;
			width: 2px;
			height: 0.5rem;
			background: #dee2e6;
		}

		.stage-number {
			width: 35px;
			height: 35px;
			background: #007bff;
			color: white;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 600;
			font-size: 0.9rem;
			flex-shrink: 0;
		}

		.stage-number.completed {
			background: #28a745;
		}

		.stage-number.pending {
			background: #ffc107;
			color: #000;
		}

		.stage-number.rejected {
			background: #dc3545;
		}

		.stage-info {
			flex: 1;
		}

		.stage-title {
			font-weight: 600;
			color: #495057;
			margin-bottom: 0.25rem;
			font-size: 0.9rem;
		}

		.approver-title {
			font-size: 0.8rem;
			color: #6c757d;
			font-style: italic;
			margin-bottom: 0.25rem;
		}

		.approver-info {
			margin-bottom: 0.25rem;
		}

		.approver-name {
			color: #007bff;
			font-weight: 500;
			font-size: 0.85rem;
		}

		.stage-timestamp {
			color: #6c757d;
			font-size: 0.75rem;
		}

		.stage-comments {
			margin-top: 0.5rem;
			padding: 0.5rem;
			background: #f8f9fa;
			border-radius: 4px;
			font-size: 0.8rem;
			color: #495057;
		}

		/* Sequential Approval - Locked State */
		.approval-stage.locked {
			opacity: 0.6;
		}

		.approval-stage.locked .stage-number {
			background: #e9ecef;
			color: #6c757d;
			border-color: #dee2e6;
		}

		.approval-stage.locked .stage-status-text {
			color: #6c757d;
			font-style: italic;
		}

		.stage-number.locked {
			background: #e9ecef !important;
			color: #6c757d !important;
			border-color: #dee2e6 !important;
		}

		.stage-status-text.locked {
			color: #6c757d !important;
			font-weight: normal !important;
		}

		/* Approval History Display Styles */
		.actual-approver-info {
			margin-top: 0.5rem !important;
			padding: 0.5rem !important;
			background: #f8f9fa !important;
			border-radius: 4px !important;
			border-left: 3px solid #28a745 !important;
			font-size: 0.85rem !important;
		}

		.actual-approver-info.rejected {
			border-left-color: #dc3545 !important;
		}

		.actual-approver-info > div:first-child {
			font-weight: 600;
			color: #28a745;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.actual-approver-info.rejected > div:first-child {
			color: #dc3545;
		}

		.actual-approver-info .fas {
			font-size: 0.8rem;
		}

		.actual-approver-info div[style*="color: #666"] {
			font-size: 0.8rem !important;
			color: #666 !important;
			margin-top: 0.25rem !important;
		}

		.actual-approver-info div[style*="color: #999"] {
			font-size: 0.75rem !important;
			color: #999 !important;
			margin-top: 0.25rem !important;
		}

		.actual-approver-info div[style*="margin-top: 0.5rem"] {
			margin-top: 0.5rem !important;
			padding: 0.5rem !important;
			background: #d4edda !important;
			border-radius: 3px !important;
			font-size: 0.8rem !important;
		}

		.actual-approver-info.rejected div[style*="margin-top: 0.5rem"] {
			background: #f8d7da !important;
		}

		.stage-comments {
			margin-top: 0.5rem;
			padding: 0.5rem;
			background: #f8f9fa;
			border-radius: 4px;
			font-size: 0.8rem;
			color: #495057;
		}

		.stage-comments strong {
			color: #333;
		}

		.no-approval-flow {
			text-align: center;
			padding: 2rem;
			color: #6c757d;
		}

		.no-approval-flow i {
			font-size: 2rem;
			margin-bottom: 0.5rem;
			color: #dee2e6;
		}

		.approval-flow-loading {
			text-align: center;
			padding: 1rem;
			color: #6c757d;
		}

		.approval-flow-error {
			text-align: center;
			padding: 1rem;
			color: #dc3545;
			background: #f8d7da;
			border-radius: 4px;
		}

		/* Modal Footer Action Buttons */
		   .modal-footer {
			   padding: 1rem 1.5rem;
			   border-top: 1px solid rgba(0, 0, 0, 0.08);
			   display: flex;
			   gap: 0.85rem;
			   align-items: center;
			   flex-wrap: wrap;
			   justify-content: flex-end;
			   background: rgba(255, 255, 255, 0.95);
			   position: sticky;
			   bottom: 0;
			   z-index: 2;
			   box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
		   }

		   .modal-footer .btn {
			   padding: 0.4rem;
			   border-radius: 6px;
			   width: 2.25rem;
			   height: 2.25rem;
			   font-size: 0.875rem;
			   font-weight: 500;
			   display: inline-flex;
			   align-items: center;
			   justify-content: center;
			   gap: 0.375rem;
			   transition: all 0.2s ease;
			   border: none;
			   cursor: pointer;
			   min-width: 2.5rem;
			   min-height: 2.5rem;
			   background: transparent;
			   color: inherit;
			   box-shadow: none;
		   }

		   .modal-footer .btn i {
			   font-size: 0.875rem;
		   }

		   .modal-footer .btn-secondary,
		   .modal-footer .btn-warning,
		   .modal-footer .btn-success,
		   .modal-footer .btn-danger,
		   .modal-footer .btn-info,
		   .modal-footer .btn-primary {
			   background: transparent !important;
			   color: inherit;
			   border: none;
			   box-shadow: none;
		   }

		   .modal-footer .btn-secondary:hover,
		   .modal-footer .btn-warning:hover,
		   .modal-footer .btn-success:hover,
		   .modal-footer .btn-danger:hover,
		   .modal-footer .btn-info:hover,
		   .modal-footer .btn-primary:hover {
			   background: #f3f4f6 !important;
			   color: #2563eb;
			   border: none;
			   transform: translateY(-1px);
			   box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
		   }
	</style>
</head>
<body>
	<div class="app-container">
		<!-- Sidebar: align exactly with access.html menu structure -->
		<nav class="sidebar menu-loading" id="sideNav">
			<div class="logo">
				<h2>Dreamex Datalab</h2>
			</div>
			<ul class="menu" id="roleBasedMenu">
				<li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
					<a href="index.html"><i class="fas fa-home"></i> Home</a>
				</li>
				<li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
					<a href="#"><i class="fas fa-medkit"></i> Health</a>
					<ul class="submenu">
						<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
						<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
						<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
					<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
					<ul class="submenu">
						<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
						<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
						<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
						<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
						<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
						<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
						<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
					<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
					<ul class="submenu">
						<li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
						<li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
						<li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
						<li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
						<li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
						<li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldistrib.html">Fuel Distribution</a></li>
						<li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
						<li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
					<a href="#"><i class="fas fa-leaf"></i> Environment</a>
					<ul class="submenu">
						<li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
					<a href="#"><i class="fas fa-lock"></i> Security</a>
					<ul class="submenu">
						<li data-feature="access_view" data-requires-permission="access_view"><a href="access.html">Gate Pass</a></li>
						<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Gate Pass Control</a></li>
						<li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
					<a href="#"><i class="fas fa-truck"></i> Logistics</a>
					<ul class="submenu">
						<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
						<li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
					<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
					<ul class="submenu">
						<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
						<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
					<a href="#"><i class="fas fa-users"></i> HR</a>
					<ul class="submenu">
						<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
						<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
						<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
						<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
						<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
						<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
						<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
						<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
						<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
						<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
						<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
						<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
						<li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="project_management_section">
					<a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
					<ul class="submenu">
						<li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
						<li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
						<li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
						<li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
					</ul>
				</li>
				<li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
				<li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
					<a href="#"><i class="fas fa-cog"></i> Settings</a>
					<ul class="submenu">
						<li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
						<li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
						<li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
						<li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
						<li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
						<li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
						<li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
						<li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
						<li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
					</ul>
				</li>
			</ul>
		</nav>
		<!-- Main Content -->
		<main class="main-content">
			<header class="top-nav">
				<div class="top-nav-left">
					<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
					<img id="headerCompanyLogo" alt="Company Logo">
					<span id="headerCompanyName"></span>
				</div>
				<div class="top-nav-right">
					<div class="notifications">
						<button id="notificationBtn" class="notification-btn" aria-label="Notifications"><i class="fas fa-bell"></i><span class="notification-badge" style="display:none;">0</span></button>
						<div class="notification-dropdown">
							<div class="notification-header">
								<h3><i class="fas fa-bell" style="margin-right: 6px; color: #3498db;"></i>Notifications</h3>
								<div>
									<button class="mark-all-read">Mark all as read</button>
									<button class="clear-all-notifications">Clear all</button>
								</div>
							</div>
							<div class="notification-list" id="notificationList">
								<!-- Empty state -->
								<div class="notification-empty" id="notificationEmpty">
									<i class="fas fa-bell-slash"></i>
									<div class="notification-empty-title">No notifications</div>
									<div class="notification-empty-message">You're all caught up!</div>
								</div>
							</div>
						</div>
					</div>
					<div class="user-profile">
						<button id="userProfileBtn" class="profile-btn" aria-label="Profile">
							<img id="userAvatarImg" src="" alt="User Avatar" style="display: none;">
							<div id="userInitials" class="avatar-initials">U</div>
						</button>
						<div class="profile-dropdown"><ul></ul></div>
					</div>
				</div>
			</header>
			<div style="padding-top:3.4rem;"></div>
			<div class="page-header">
				<div style="display: flex; align-items: center; gap: 0.6rem;">
					<i class="fas fa-lock"></i>
					<span>Gate Pass Requests Board</span>
				</div>
				<button type="button" class="btn-add-new" onclick="window.location.href='access.html'" title="Add New Gate Pass Request">
					<i class="fas fa-plus"></i>
				</button>
			</div>
			<!-- Tabs and content -->
			<div class="content-tabs">
				<div class="tab-navigation">
					<button class="tab-nav-btn active" data-tab="boardTab"><i class="fas fa-table"></i> Board</button>
					<button class="tab-nav-btn" data-tab="previewTab"><i class="fas fa-file-invoice"></i> Preview</button>
				</div>
				<div class="tab-panel active" id="boardTab">
				<!-- Filters -->
				<section class="filters-bar" id="filtersBar">
				   <div class="form-group">
					   <input type="text" id="searchInput" placeholder="Ref, requester, area..." autocomplete="off">
				   </div>
				   <div class="form-group">
					   <select id="statusFilter">
						   <option value="">All</option>
						   <option value="submitted">Submitted</option>
						   <option value="updated">Updated</option>
						   <option value="pending_approval">Pending</option>
						   <option value="approved">Approved</option>
						   <option value="rejected">Rejected</option>
					   </select>
				   </div>
				   <div class="form-group" id="showAllGroup" style="display:none; align-self:center;">
				   	   <label style="font-size:.6rem; visibility:hidden;">Show All</label>
				   	   <label style="font-size:.7rem; font-weight:600; color:#333;">
				   	   	<input type="checkbox" id="showAllToggle"> Show all
				   	   </label>
				   </div>
				   <!-- Removed Clear and CSV export buttons -->
				</section>
			   <!-- Removed status pills -->
			<!-- Table -->
			<section class="board-card">
				<div id="boardSummary" style="font-size:.6rem;font-weight:600;color:#555;display:flex;flex-wrap:wrap;gap:1rem;padding:.15rem .1rem .5rem .1rem;"></div>
				<div class="table-wrapper">
						<table aria-label="Gate Pass Requests Table">
						<thead>
							<tr>
								<th>Ref #</th>
								<th>Requester</th>
								<th>Department</th>
								<th>Company</th>
								<th>Area</th>
								<th>Start</th>
								<th>End</th>
								<th>Status</th>
									<th>Property Removal</th>
									<th>To be Returned</th>
								<th>Actions</th>
							</tr>
						</thead>
							<tbody id="accessTableBody">
								<tr><td colspan="7" class="empty-state">Loading gate pass requests...</td></tr>
						</tbody>
					</table>
				</div>
			</section>
				</div>
				<div class="tab-panel" id="previewTab">
					<div class="print-controls">
						<button class="btn-small btn-primary" id="btnPrintPreview" title="Print"><i class="fas fa-print"></i></button>
						<button class="btn-small btn-outline" id="btnPdfPreview" title="Save as PDF"><i class="fas fa-file-pdf"></i></button>
						<button class="btn-small btn-outline" id="btnRefreshPreview" title="Refresh"><i class="fas fa-sync"></i></button>
					</div>
					<div class="payslip-preview" id="accessPreview">
						<!-- Preview content rendered here -->
					</div>
				</div>
			</div>
		</main>
	</div>

		<!-- Access Details Modal -->
		<div id="accessDetailsModal" class="modal-backdrop hidden" aria-hidden="true" role="dialog" aria-modal="true">
			<div class="modal-panel" role="document">
				<div class="modal-header">
					<div class="modal-title"><i class="fas fa-id-badge"></i><span id="modalTitle">Gate Pass Request</span></div>
					<button class="modal-close" type="button" aria-label="Close" id="modalCloseBtn"><i class="fas fa-times"></i></button>
				</div>
				<div class="modal-body" id="modalBody">
					<!-- dynamic content -->
				</div>
				<div class="modal-footer">
					<button type="button" class="btn-small btn-outline" id="modalCloseFooter">Close</button>
					<button type="button" class="btn-small btn-primary" id="modalEditBtn" style="display:none;"><i class="fas fa-edit"></i> Edit</button>
				</div>
			</div>
		</div>

	<!-- Utility: Sidebar persistence -->
	<script>
		function toggleSidebar(){
			const sb=document.querySelector('.sidebar');
			const mc=document.querySelector('.main-content');
			const top=document.querySelector('.top-nav');
			if(!sb||!mc)return;
			const collapsed=sb.classList.toggle('collapsed');
			mc.classList.toggle('sidebar-collapsed',collapsed);
			if(top){ top.style.left= collapsed? '.5rem': 'calc(var(--sidebar-width) + .5rem)'; }
			localStorage.setItem('sidebarCollapsed',collapsed);
		}
		function restoreSidebarState(){
			const collapsed=localStorage.getItem('sidebarCollapsed')==='true';
			const sb=document.querySelector('.sidebar');
			const mc=document.querySelector('.main-content');
			const top=document.querySelector('.top-nav');
			if(collapsed && sb && mc){ sb.classList.add('collapsed'); mc.classList.add('sidebar-collapsed'); if(top){top.style.left='.5rem';} }
		}
		document.addEventListener('DOMContentLoaded',()=>{
			restoreSidebarState();
			document.getElementById('sidebarToggle')?.addEventListener('click',toggleSidebar);
		});
	</script>
	<!-- Core Logic -->
	<script>
	/**************** Firebase Initialization ****************/ (function(){ const firebaseConfig={ apiKey:"AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc", authDomain:"users-8be65.firebaseapp.com", databaseURL:"https://users-8be65-default-rtdb.firebaseio.com", projectId:"users-8be65", storageBucket:"users-8be65.firebasestorage.app", messagingSenderId:"829083030831", appId:"1:829083030831:web:36a370e62691e560bc3dda" }; if(!window.firebase?.apps?.length){ firebase.initializeApp(firebaseConfig); console.log('✅ Firebase initialized (accessboard)'); } window.db=firebase.database(); window.auth=firebase.auth(); window.storage=firebase.storage(); })();

	/**************** Notification Manager (Firebase-backed) ****************/
    class NotificationManager{
      constructor(){
        this.db = firebase.database();
        this.notifications = [];
        this.settings = this.loadSettings();
        this.userId = null;
        this.fbRef = null;
        this.initialize();
      }
      initialize(){
        if(document.readyState==='loading'){
          document.addEventListener('DOMContentLoaded',()=>this.setup());
        } else { this.setup(); }
      }
      setup(){
        this.bindUI();
        this.tryAttachFirebase();
        this.startBadgeTimer();
        document.addEventListener('storage',e=>{ if(e.key==='currentUser'){ this.tryAttachFirebase(true); }});
      }
      bindUI(){
        const btn=document.getElementById('notificationBtn'); if(btn){btn.onclick=()=>{document.querySelector('.notification-dropdown')?.classList.toggle('show');};}
        const mark=document.querySelector('.mark-all-read'); if(mark){mark.onclick=()=>this.markAllAsRead();}
        document.addEventListener('click',e=>{ if(!e.target.closest('.notifications')) document.querySelector('.notification-dropdown')?.classList.remove('show'); });
      }
      loadSettings(){ const d={emailNotifications:true,notifySubmitter:true,notifyApprovers:true,notifyOnComplete:true,systemUpdates:true,securityAlerts:true,notificationDisplay:'30',showReadNotifications:true}; try{return JSON.parse(localStorage.getItem('notificationSettings'))||d;}catch{return d;} }
      tryAttachFirebase(force=false){
        const uid = window.authManager?.currentUser?.uid || firebase.auth().currentUser?.uid;
        if(!uid){ this.renderNotifications(); this.updateNotificationBadge(); return; }
        if(this.userId===uid && !force){ return; }
        this.userId = uid;
        if(this.fbRef){ this.fbRef.off(); }
        this.fbRef = this.db.ref(`notifications/${uid}`);
        this.fbRef.on('value', snap=>{
          const list=[]; if(snap.exists()){
            snap.forEach(cs=>{ const v=cs.val(); if(v){ list.push(v); }});
          }
          // Sort by timestamp desc
          list.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
          this.notifications = list;
          this.renderNotifications();
          this.updateNotificationBadge();
        });
      } markAllAsRead(){ if(!this.userId){ return; } const updates={}; this.notifications.forEach(n=>{ if(!n.read){ updates[`notifications/${this.userId}/${n.id}/read`]=true; }}); if(Object.keys(updates).length){ this.db.ref().update(updates).catch(()=>{}); } }
      updateNotificationBadge(){ const badge=document.querySelector('.notification-badge'); if(!badge) return; const unread=this.notifications.filter(n=>!n.read).length; if(unread<=0){ badge.style.display='none'; badge.textContent=''; } else { badge.style.display='inline-block'; badge.textContent = unread>99? '99+': String(unread); } }
      renderNotifications(){ const list=document.querySelector('.notification-list'); if(!list) return; list.innerHTML=''; const days=parseInt(this.settings.notificationDisplay); const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-days);
        const filtered=this.notifications.filter(n=>{ const ts=n.timestamp? new Date(n.timestamp): null; const inRange = ts? (ts>cutoff): true; return inRange && (this.settings.showReadNotifications || !n.read); });
        if(filtered.length===0){ list.innerHTML='<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>'; return; }
        filtered.slice(0,50).forEach(n=>{
          const el=document.createElement('div'); el.className='notification-item '+(n.read?'read':'unread'); const date=n.timestamp? new Date(n.timestamp): new Date(); const timeAgo=this.getTimeAgo(date);
          const title = n.title || (n.type || 'Notification');
          el.innerHTML=`
            <div class="notification-icon ${this.getNotificationIconClass(n.type)}">
              <i class="fas ${this.getNotificationIcon(n.type)}"></i>
            </div>
            <div class="notification-content">
              <div class="notification-title">${this.escapeHtml(title)}</div>
              <div class="notification-message">${this.escapeHtml(n.message||'')}</div>
              <div class="notification-time">${timeAgo}</div>
            </div>
            <div class="notification-actions">
              ${!n.read ? '<button class="mark-read-btn" title="Mark as read"><i class="fas fa-check"></i></button>' : ''}
              <button class="delete-notification-btn" title="Delete"><i class="fas fa-trash"></i></button>
            </div>`;
          const markReadBtn = el.querySelector('.mark-read-btn');
          const deleteBtn = el.querySelector('.delete-notification-btn');
          if(markReadBtn){ markReadBtn.onclick=(e)=>{ e.stopPropagation(); this.setRead(n.id,true); }; }
          if(deleteBtn){ deleteBtn.onclick=(e)=>{ e.stopPropagation(); this.deleteNotification(n.id); }; }
          el.onclick=()=>{ if(!n.read){ this.setRead(n.id,true);} if(n.link) location.href=n.link; };
          list.appendChild(el);
        });
      }
        
        getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'm ago';
            if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'h ago';
            if (diffInSeconds < 604800) return Math.floor(diffInSeconds / 86400) + 'd ago';
            return date.toLocaleDateString();
		}
        
		getNotificationIconClass(type) {
            switch ((type || '').toLowerCase()) {
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'error': return 'error';
                case 'info': return 'info';
                default: return 'info';
            }
		}

		getNotificationIcon(type) {
            switch ((type || '').toLowerCase()) {
                case 'success': return 'fa-check-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'error': return 'fa-exclamation-circle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-bell';
            }
		}
		escapeHtml(str){ if(str===undefined||str===null) return ''; return String(str).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
		startBadgeTimer(){ setInterval(()=>this.updateNotificationBadge(),30000); }
		setRead(id,val){ if(!this.userId||!id) return; this.db.ref(`notifications/${this.userId}/${id}/read`).set(!!val).catch(()=>{}); }
		deleteNotification(id){ if(!this.userId||!id) return; this.db.ref(`notifications/${this.userId}/${id}`).remove().catch(()=>{}); }
		async createNotification(recipientUserId,data){ try{ const id=data?.id||Date.now().toString(); const payload={ id, title:data?.title||'Notification', message:data?.message||'', type:data?.type||'info', read:false, timestamp:Date.now(), createdAt:new Date().toISOString(), createdBy: window.authManager?.currentUser?.uid || firebase.auth().currentUser?.uid || 'system', createdByName: window.authManager?.getUserDisplayName?.() || 'System', companyId: window.authManager?.currentUser?.companyId || null, relatedData: data?.relatedData||null, link: data?.link||'' }; await this.db.ref(`notifications/${recipientUserId}/${id}`).set(payload); return true; }catch(e){ console.error('createNotification failed',e); return false; } }
	  }
	  window.notificationManager=new NotificationManager();

	/**************** AuthManager (adapted from access.html) ****************/ class AuthManager{ constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; console.log('🔐 AuthManager(init) accessboard'); this.initializeAuth(); }
		getCurrentUser(){ try{return JSON.parse(localStorage.getItem('currentUser')||'null');}catch{return null;} }
		setCurrentUser(u){ localStorage.setItem('currentUser',JSON.stringify(u)); localStorage.setItem('user',JSON.stringify(u)); this.currentUser=u; }
		async logout(){ try{ await firebase.auth().signOut(); }catch(e){ console.warn('Logout error',e);} ['currentUser','user'].forEach(k=>{localStorage.removeItem(k);sessionStorage.removeItem(k);}); location.href='index.html'; }
		initializeAuth(){ 
			if(!this.currentUser){ 
				console.warn('No user -> redirect login'); 
				location.href='login.html'; 
				return; 
			} 
			console.log('✅ User:',this.currentUser.email); 
			
			// Test Firebase Storage
			this.testFirebaseStorage();
			
			// Initialize approval configuration
			this.initializeApprovalConfiguration();
			
			this.loadUserRole(this.currentUser); 
			this.loadUserCompany(); 
			this.updateUIForAuthenticatedUser(); 
			this.updateMenuVisibility(); 
			this.bindProfileDropdown(); 
		}
		bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn && dd){ btn.addEventListener('click',e=>{e.stopPropagation(); dd.classList.toggle('show');}); document.addEventListener('click',e=>{ if(!btn.contains(e.target)) dd.classList.remove('show');}); const logoutLink=dd.querySelector('a[href="#"]:has(.fa-sign-out-alt)')||dd.querySelector('.fa-sign-out-alt')?.closest('a'); if(logoutLink){ logoutLink.addEventListener('click',e=>{e.preventDefault(); this.logout();}); } } }
		resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=>d.classList.remove('menu-visible')); }
		async updateMenuVisibility(){ 
			console.log('🎯 Starting feature-based menu authorization for accessboard.html...');
			const sidebar=document.querySelector('.sidebar'); 
			if(!this.currentUser){ 
				this.resetMenuVisibility(); 
				sidebar?.classList.remove('menu-loading');
				return; 
			} 
			const companyId=this.currentUser.companyId; 
			const userRole=this.currentUser.role; 
			console.log('👤 User:', this.currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
			if(!companyId){ 
				this.resetMenuVisibility(); 
				sidebar?.classList.remove('menu-loading');
				return; 
			} 
			// STEP 1: Apply company feature-based authorization
			console.log('🏢 STEP 1: Applying company feature authorization...');
			const authorizedPages = await this.applyFeatureBasedMenuVisibility(companyId);
			
			// STEP 2: Filter by user role permissions within authorized features
			if (userRole && authorizedPages && authorizedPages.length > 0) {
				console.log('👤 STEP 2: Applying role-based filtering within authorized features...');
				await this.applyRoleBasedFiltering(companyId, userRole, authorizedPages);
			} else {
				console.log('⚠️ STEP 2: Skipping role-based filtering (no role found or no authorized pages)');
				sidebar?.classList.remove('menu-loading');
			}
		}
		async applyFeatureBasedMenuVisibility(companyId){ 
			try{ 
				console.log('🔧 Applying feature-based menu visibility for company:', companyId);
				const database=firebase.database(); 
				const featuresSnapshot=await database.ref('/platformFeatures').once('value'); 
				if(!featuresSnapshot.exists()){ 
					console.log('⚠️ No platform features found');
					this.resetMenuVisibility(); 
					return [];
				} 
				const featuresData=featuresSnapshot.val(); 
				const companySnapshot=await database.ref(`/companies/${companyId}`).once('value'); 
				const companyData=companySnapshot.val(); 
				if(!companyData){ 
					console.error('❌ Company data not found');
					this.resetMenuVisibility(); 
					return [];
				} 
				const subscribed=companyData.selectedFeatures||[]; 
				console.log('🏢 Company subscribed features:', subscribed);
				if (subscribed.length === 0) {
					console.log('⚠️ Company has no subscribed features');
					this.resetMenuVisibility();
					return [];
				}
				const authorizedPages=[]; 
				subscribed.forEach(fid=>{
					const f=featuresData[fid]; 
					if(f && f.status==='active' && f.authorizedPages) {
						console.log(`📦 Adding pages from feature "${f.name}":`, f.authorizedPages);
						authorizedPages.push(...f.authorizedPages);
					} else {
						console.log(`⚠️ Feature ${fid} not found or inactive`);
					}
				}); 
				console.log('🔐 All authorized pages from company features:', authorizedPages);
				const authorizedFeatures=new Set(); 
				authorizedPages.forEach(p=>{ 
					if(p.feature) authorizedFeatures.add(p.feature); 
				}); 
				console.log('🎯 Authorized features for accessboard.html:', Array.from(authorizedFeatures));
				this.resetMenuVisibility(); 
				let visibleCount = 0;
				document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(item=>{ 
					const feature=item.getAttribute('data-feature'); 
					const isDropdownContainer = item.classList.contains('menu-dropdown');
					
					if (isDropdownContainer) {
						return; // Handle dropdowns separately after all items are processed
					}
					
					if(authorizedFeatures.has(feature)){ 
						item.classList.add('menu-visible'); 
						visibleCount++;
						console.log(`✅ Feature authorized - showing menu item: ${feature}`);
					} else {
						console.log(`❌ Feature not authorized - hiding menu item: ${feature}`);
					}
				}); 
				// Handle dropdown menus - show if they have visible children
				document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{ 
					const feature=drop.getAttribute('data-feature'); 
					const hasVisible=[...drop.querySelectorAll('.submenu li[data-feature]')].some(li=>li.classList.contains('menu-visible')); 
					if(hasVisible || authorizedFeatures.has(feature)) {
						drop.classList.add('menu-visible'); 
						console.log(`✅ Showing dropdown menu: ${feature} (has visible children or directly authorized)`);
					} else {
						console.log(`❌ Hiding dropdown menu: ${feature} (no visible children and not authorized)`);
					}
				}); 
				console.log(`🎯 Company feature authorization completed - ${visibleCount} items initially visible`);
				// Return authorized pages for role-based filtering
				return authorizedPages;
			}catch(e){ 
				console.error('❌ Error applying feature-based menu visibility:', e); 
				this.resetMenuVisibility(); 
				return [];
			} 
		}
		
		// Apply role-based filtering within company authorized features
		async applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
			try {
				console.log('👤 Applying role-based filtering for role:', userRole);
				
				// Get user role permissions from company
				const database = firebase.database();
				const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
				const permissionsSnapshot = await permissionsRef.once('value');
				
				if (!permissionsSnapshot.exists()) {
					console.log(`⚠️ No permissions found for role ${userRole} in company ${companyId}`);
					
					// CRITICAL: If user is administrator but no permissions found, provide full access as fallback
					if (userRole === 'administrator') {
						console.log('🔑 ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
						this.showSidebarAfterAuth();
						return;
					}
					
					// For other roles without permissions, hide all items with permission requirements
					console.log('❌ No valid permissions found - filtering out items requiring permissions');
					this.hideItemsRequiringPermissions();
					this.showSidebarAfterAuth();
					return;
				}
				
				const permissions = permissionsSnapshot.val();
				console.log('✅ Loaded role permissions:', permissions);
				
				// Apply permission-based filtering
				this.filterMenuByPermissions(permissions);
				
			} catch (error) {
				console.error('❌ Error applying role-based filtering:', error);
				// Don't hide everything on error - keep company features visible
				this.showSidebarAfterAuth();
			}
		}

		// Filter currently visible menu items by role permissions
		filterMenuByPermissions(permissions) {
			console.log('🔍 Filtering visible menu items by role permissions...');
			
			if (!permissions) {
				console.log('⚠️ No permissions object provided');
				this.hideItemsRequiringPermissions();
				this.showSidebarAfterAuth();
				return;
			}
			
			// Only check items that are already visible from company features
			const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			console.log(`🎯 Found ${visibleMenuItems.length} visible menu items requiring permissions to check`);
			
			let hiddenCount = 0;
			
			visibleMenuItems.forEach(item => {
				const requiresPermission = item.getAttribute('data-requires-permission');
				const feature = item.getAttribute('data-feature');
				
				if (requiresPermission) {
					const hasPermission = permissions[requiresPermission];
					const hasViewPermission = hasPermission === true || 
											 (hasPermission && hasPermission.view === true);
					
					if (!hasViewPermission) {
						item.classList.remove('menu-visible');
						hiddenCount++;
						console.log(`❌ Hiding menu item (no permission): ${feature} (requires: ${requiresPermission})`);
					} else {
						console.log(`✅ Keeping menu item visible: ${feature} (has permission: ${requiresPermission})`);
					}
				}
			});
			
			// Re-check dropdown menus after permission filtering
			const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
			dropdownMenus.forEach(dropdown => {
				const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
				const dropdownFeature = dropdown.getAttribute('data-feature');
				
				if (submenuItems.length === 0) {
					dropdown.classList.remove('menu-visible');
					console.log(`❌ Hiding dropdown (no visible children): ${dropdownFeature}`);
				} else {
					console.log(`✅ Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
				}
			});
			
			console.log(`🎯 Role-based filtering completed - ${hiddenCount} items hidden due to lack of permissions`);
			
			// Show sidebar after all filtering is complete
			this.showSidebarAfterAuth();
		}

		// Hide menu items that require permissions (for users without role permissions)
		hideItemsRequiringPermissions() {
			console.log('🔒 Hiding all menu items that require permissions...');
			
			const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			let hiddenCount = 0;
			
			itemsRequiringPermissions.forEach(item => {
				const feature = item.getAttribute('data-feature');
				const requiresPermission = item.getAttribute('data-requires-permission');
				
				item.classList.remove('menu-visible');
				hiddenCount++;
				console.log(`❌ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
			});
			
			console.log(`🔒 Hidden ${hiddenCount} items requiring permissions`);
		}

		// Show sidebar and remove loading state after authentication and filtering
		showSidebarAfterAuth() {
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
				console.log('✅ Sidebar loading state removed - menu authorization complete');
			}
		}

		// Emergency fallback menu (basic items only)
		showBasicMenu() {
			console.log('🚨 Showing basic emergency menu - authorization system failed');
			this.resetMenuVisibility();
			
			// Show only essential menu items
			const essentialItems = [
				'[data-feature="home_view"]',
				'[data-feature="communication_view"]',
				'[data-feature="settings_view"]',
				'[data-feature="account_settings_view"]'
			];
			
			essentialItems.forEach(selector => {
				const item = document.querySelector(`#roleBasedMenu li${selector}`);
				if (item) {
					item.classList.add('menu-visible');
					// Also show parent dropdown if needed
					const parentDropdown = item.closest('.menu-dropdown');
					if (parentDropdown) {
						parentDropdown.classList.add('menu-visible');
					}
				}
			});
			
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
			}
			
			console.log('🚨 Basic emergency menu displayed');
		}
		
		async loadUserRole(user){ if(user.role||!user.uid) return; try{ const snap=await firebase.database().ref(`users/${user.uid}`).once('value'); if(snap.exists()){ user.role=snap.val().role||'user'; this.setCurrentUser(user);} }catch(e){ console.warn('Role load error',e);} }
		async loadUserCompany(){ 
			if(!this.currentUser) return; 
			try{ 
				const snap=await firebase.database().ref('companies').once('value'); 
				if(!snap.exists()) { 
					this.resetMenuVisibility(); 
					return;
				} 
				const companies=snap.val(); 
				for(const [cid,comp] of Object.entries(companies)){ 
					if(comp.status!=='active') continue; 
					if(comp.users){ 
						for(const [uid,u] of Object.entries(comp.users)){ 
							if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ 
								this.currentUser.companyId=cid; 
								this.currentUser.companyName=comp.companyName; 
								this.currentUser.role=u.role || u.userRole || 'user'; // Set user role from company user record
								this.currentCompany=comp; 
								this.setCurrentUser(this.currentUser); 
								console.log('✅ Found user in company:', cid, 'with role:', this.currentUser.role);
								this.updateCompanyBranding(); 
								await this.updateMenuVisibility(); 
								return; 
							}
						}
					} 
				} 
				this.resetMenuVisibility(); 
			}catch(e){ 
				console.error('Company load error',e); 
				this.resetMenuVisibility(); 
			} 
		}
		updateCompanyBranding(){ if(!this.currentCompany){ this.showFallbackBranding(); return;} const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.classList.add('visible'); } else { const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.src=svg; logoEl.classList.add('visible'); }} if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color',this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color',this.currentCompany.branding.secondaryColor); }}
		showFallbackBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); if(logoEl){ const svg=this.generateCompanyInitialsSVG('DX'); logoEl.src=svg; logoEl.classList.add('visible'); }} getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
		generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
		getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=> typeof v==='string'? v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){const cleaned=n(c); if(cleaned) return cleaned;} if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
		// Debug method to test Firebase Storage
		async testFirebaseStorage() {
			console.log('🧪 Testing Firebase Storage...');
			
			// Check if Firebase Storage is initialized
			try {
				const storage = firebase.storage();
				console.log('✅ Firebase Storage initialized:', storage);
				
				// Check bucket name
				const bucket = storage.app.options.storageBucket;
				console.log('🪣 Storage bucket:', bucket);
				
				// Test reference creation
				const testRef = storage.ref('test');
				console.log('✅ Can create storage reference:', testRef);
				
				// Get company ID for testing
				const companyId = this.currentUser?.companyId || 'default';
				console.log('🏢 Testing with company ID:', companyId);
				
				// Test listing files in company-scoped avatars directory
				try {
					const companyAvatarsRef = storage.ref(`companies/${companyId}/avatars`);
					const list = await companyAvatarsRef.listAll();
					console.log(`📁 Items in companies/${companyId}/avatars folder:`, list.items.length);
					list.items.forEach(item => {
						console.log('  📄', item.fullPath);
					});
				} catch(listError) {
					console.log(`📁 No company avatars folder or permission issue:`, listError.message);
				}
				
				// Also test global avatars directory as fallback
				try {
					const globalAvatarsRef = storage.ref('avatars');
					const globalList = await globalAvatarsRef.listAll();
					console.log('📁 Items in global avatars folder:', globalList.items.length);
					globalList.items.forEach(item => {
						console.log('  📄', item.fullPath);
					});
				} catch(listError) {
					console.log('📁 No global avatars folder or permission issue:', listError.message);
				}
				
			} catch(error) {
				console.error('❌ Firebase Storage error:', error);
			}
		}

		// Initialize default approval configuration for access requests
		async initializeApprovalConfiguration() {
			if (!this.currentUser?.companyId) return;
			
			try {
				const approvalFlowRef = firebase.database().ref(`companies/${this.currentUser.companyId}/approvalFlows/access`);
				const snapshot = await approvalFlowRef.once('value');
				
				if (!snapshot.exists()) {
					console.log('🔧 Creating default approval configuration for access requests...');
					
					// Define default approval roles - can be customized per company
					const defaultRoles = [
						{ key: "supervisor", text: "Supervisor", function: "function_supervisor" },
						{ key: "manager", text: "Manager", function: "function_manager" },
						{ key: "admin", text: "Administrator", function: "function_admin" },
						{ key: "hr", text: "HR Manager", function: "function_hr" }
					];
					
					const defaultApprovalConfig = {
						enabled: true,
						approvalOrder: "sequential",
						selectedRoles: {
							level1: [{
								value: defaultRoles[0].function,
								text: defaultRoles[0].text,
								updatedAt: Date.now()
							}],
							level2: [{
								value: defaultRoles[1].function,
								text: defaultRoles[1].text,
								updatedAt: Date.now()
							}]
						},
						levels: [
							{
								level: 1,
								approverType: "function",
								value: defaultRoles[0].function
							},
							{
								level: 2,
								approverType: "function",
								value: defaultRoles[1].function
							}
						],
						availableRoles: defaultRoles, // Store available roles for customization
						companyId: this.currentUser.companyId,
						companyName: this.currentUser.companyName,
						lastModifiedAt: new Date().toISOString()
					};
					
					await approvalFlowRef.set(defaultApprovalConfig);
					console.log('✅ Default approval configuration created for access requests');
				} else {
					console.log('✅ Approval configuration already exists for access requests');
				}
			} catch (error) {
				console.error('❌ Error initializing approval configuration:', error);
			}
		}

		getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
		async getUserAvatarUrl(){ 
			if(!this.currentUser) {
				console.log('getUserAvatarUrl: No current user');
				return null; 
			}
			
			// Get company ID for scoped path
			const companyId = this.currentUser.companyId || 'default';
			console.log('🏢 Using company ID for avatar path:', companyId);
			
			try{ 
				// Try company-scoped paths first, then fallback to global paths
				const possiblePaths = [
					// Company-scoped paths (preferred)
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,
					// Global fallback paths
					`avatars/${this.currentUser.uid}/profile.jpg`,
					`avatars/${this.currentUser.uid}/profile.png`,
					`avatars/${this.currentUser.uid}/avatar.jpg`,
					`avatars/${this.currentUser.uid}/avatar.png`,
					`profiles/${this.currentUser.uid}/profile.jpg`,
					`profiles/${this.currentUser.uid}/profile.png`
				];
				
				for(const path of possiblePaths) {
					try {
						const ref = firebase.storage().ref(path);
						const url = await ref.getDownloadURL();
						console.log(`✅ Found profile picture at: ${path}`);
						return url;
					} catch(err) {
						console.log(`❌ No profile picture at: ${path}`);
						continue;
					}
				}
				
				console.log('No profile picture found in any path');
				return null;
			} catch(error) { 
				console.error('Error getting user avatar:', error);
				return null; 
			}
		}
		generateInitialsAvatar(name,img){ const initials=this.getUserInitials(); const colors=['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6','#1abc9c']; const bg=colors[name.length%colors.length]; const svg=`<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="${bg}"/><text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text></svg>`; img.src='data:image/svg+xml;base64,'+btoa(svg); img.alt=name+' Avatar'; }
		async updateUIForAuthenticatedUser(){ 
			console.log('🔄 updateUIForAuthenticatedUser called');
			const btn=document.getElementById('userProfileBtn'); 
			const list=document.querySelector('.profile-dropdown ul'); 
			const userAvatarImg=document.getElementById('userAvatarImg');
			const userInitials=document.getElementById('userInitials');
			
			if(!btn||!list||!this.currentUser) {
				console.log('❌ Missing elements:', {btn: !!btn, list: !!list, user: !!this.currentUser});
				return; 
			}
			
			const displayName=this.getUserDisplayName(); 
			const email=this.currentUser.email||''; 
			console.log('👤 User info:', {displayName, email, uid: this.currentUser.uid});
			
			// Set user initials first as fallback
			if(userInitials) {
				userInitials.textContent = this.getUserInitials();
			}
			
			// Try to get avatar URL with detailed logging
			let avatarUrl = null;
			try {
				avatarUrl = await this.getUserAvatarUrl();
				console.log('🖼️ Avatar URL result:', avatarUrl);
			} catch(error) {
				console.error('❌ Error getting avatar URL:', error);
			}
			
			// Update header avatar display
			if(avatarUrl && userAvatarImg) { 
				console.log('✅ Setting avatar image:', avatarUrl);
				userAvatarImg.src = avatarUrl; 
				userAvatarImg.alt = displayName + ' Avatar';
				userAvatarImg.style.display = 'block';
				if(userInitials) userInitials.style.display = 'none';
				
				// Handle image load error
				userAvatarImg.onerror = () => {
					console.log('❌ Avatar image failed to load, showing initials');
					userAvatarImg.style.display = 'none';
					if(userInitials) userInitials.style.display = 'flex';
				};
			} else { 
				console.log('🔤 No avatar URL, showing initials');
				if(userAvatarImg) userAvatarImg.style.display = 'none';
				if(userInitials) userInitials.style.display = 'flex';
			}
			
			// Update dropdown content
			const avatarHtml= avatarUrl? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`; 
			list.innerHTML=`<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`; 
			list.querySelector('#logoutLink')?.addEventListener('click',e=>{e.preventDefault(); this.logout();}); 
		}
	}
	window.authManager=new AuthManager();

	/**************** AccessBoard Manager ****************/ class AccessBoardManager{ constructor(){ this.allRequests=[]; // master source
		   this.companyUsersCache = null; // { [uid]: userObj }
		   this.companyUsersCompanyId = null;
		   this.companyUsersLoadedAt = 0;
		   this.accessRequests=this.allRequests; // legacy alias for older code segments
			   this.userFilteredRequests = []; // Only requests created by or assigned as approver to current user
		this.filtered=[]; this.statusPillFilter=''; this.dom={ tbody:document.getElementById('accessTableBody'), search:document.getElementById('searchInput'), status:document.getElementById('statusFilter'), pills:document.getElementById('statusPills'), summary:document.getElementById('boardSummary'), clearBtn:document.getElementById('clearFiltersBtn'), exportBtn:document.getElementById('exportCsvBtn') }; this.modal={ root:document.getElementById('accessDetailsModal'), body:document.getElementById('modalBody'), title:document.getElementById('modalTitle'), close:document.getElementById('modalCloseBtn'), closeFooter:document.getElementById('modalCloseFooter'), edit:document.getElementById('modalEditBtn') }; this.attachEvents(); this.renderStatusPills(); this.attachModalHandlers(); this.initPreviewControls(); this.waitForCompanyThenLoad(); }
		attachEvents(){ const debounce=(fn,d=250)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),d);};}; const apply=()=>this.applyFilters(); ['search','status'].forEach(k=>{ if(this.dom[k]) this.dom[k].addEventListener('input',debounce(apply,180)); }); const showAll=document.getElementById('showAllToggle'); if(showAll){ showAll.addEventListener('change',apply);} this.dom.clearBtn?.addEventListener('click',()=>this.clearFilters()); this.dom.exportBtn?.addEventListener('click',()=>this.exportCsv());
			// Tabs
			document.querySelectorAll('.tab-nav-btn').forEach(btn=>{
				btn.addEventListener('click',()=> this.switchTab(btn.dataset.tab));
			});
		}
		renderStatusPills(){ if(!this.dom.pills) return; this.dom.pills.innerHTML = ""; }
		clearFilters(){ if(this.dom.search) this.dom.search.value=''; if(this.dom.status) this.dom.status.value=''; this.statusPillFilter=''; this.dom.pills?.querySelectorAll('.status-pill').forEach(p=>p.classList.remove('active')); this.applyFilters(); }
		waitForCompanyThenLoad(){ const int=setInterval(()=>{ const companyId=window.authManager?.currentUser?.companyId; if(companyId){ clearInterval(int); this.load(companyId); } },400); setTimeout(()=>clearInterval(int),15000); }
	       async load(companyId){
		       console.log('📡 Listening for access requests for company',companyId);
		       firebase.database().ref(`companies/${companyId}/access`).on('value',async snap=>{
			       const data=snap.val()||{};
			       this.allRequests=Object.entries(data).map(([id,v])=>({...v,id})).sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0));
			       this.accessRequests=this.allRequests; // keep alias in sync
			       // Preload company users for identity lookups (employeeId, names)
			       try { await this.ensureCompanyUsersLoaded(); } catch(e) { console.warn('Company users prefetch failed', e); }
			       // Determine if user is an approver (by role or config)
			       const currentUser = window.authManager?.currentUser;
			       let isApprover = false;
			       if (currentUser) {
				       const userId = currentUser.uid;
				       const userRole = (currentUser.role || '').toLowerCase();
				       const userEmail = (currentUser.email || '').toLowerCase();
				       // Check if user has an approver role (customize as needed)
				       const approverRoles = ['approver','admin','administrator','superadmin','company_admin','companyadmin','manager','supervisor','hr_manager','security','hse'];
				       if (approverRoles.some(r => userRole.includes(r))) {
					       isApprover = true;
				       } else {
					       // Additional check: if role permissions include access board viewing, treat as approver
					       try {
						       const permsRef = firebase.database().ref(`companies/${companyId}/roles/${currentUser.role}/permissions`);
						       const permsSnap = await permsRef.once('value');
						       const perms = permsSnap.val() || {};
						       const viewKeys = ['access_view','accessboard_view','access_board_view','access_list_view','access_requests_view','security_view'];
						       const hasAccessView = viewKeys.some(k => perms[k] === true || (perms[k] && perms[k].view === true));
						       if (hasAccessView) {
							       isApprover = true;
						       }
					       } catch (e) { /* ignore permission lookup errors */ }
					       // Check if user is listed as an approver in any selectedRoles config
					       isApprover = this.allRequests.some(r => {
						       if (r.selectedRoles && typeof r.selectedRoles === 'object') {
							       for (const levelKey of Object.keys(r.selectedRoles)) {
								       const levelArr = r.selectedRoles[levelKey];
								       if (Array.isArray(levelArr)) {
									       for (const approver of levelArr) {
										       const aVal = (approver && (approver.value || approver.uid || approver.id || approver.userId)) || '';
										       const aEmail = (approver && (approver.email || approver.userEmail)) ? String(approver.email || approver.userEmail).toLowerCase() : '';
										       if (aVal === userId || (aEmail && aEmail === userEmail)) return true;
									       }
								       }
							       }
						       }
						       return false;
					       });
				       }
				       // URL override to show all (e.g., accessboard.html?all=1)
				       try { const qp = new URLSearchParams(location.search); if (qp.get('all')==='1' || qp.get('showAll')==='1') { isApprover = true; } } catch(_e) {}
				       if (isApprover) {
					       // Approver sees all requests
					       this.userFilteredRequests = this.allRequests;
					       // Expose Show All toggle for authorized users
					       const showAllGroup = document.getElementById('showAllGroup');
					       if (showAllGroup) showAllGroup.style.display = 'flex';
				       } else {
					       // Regular user: only requests created by or assigned as approver to current user
					       let createdByUser = this.allRequests.filter(r => {
						       const email = userEmail;
						       return (
							       r.userId === userId ||
							       r.createdBy === userId ||
							       r.createdByUid === userId ||
							       r.createdById === userId ||
							       r.ownerId === userId ||
							       r.owner === userId ||
							       r.requesterUserId === userId ||
							       r.requesterUid === userId ||
							       r.employeeUserId === userId ||
							       // Legacy/email-based creator fields
							       (typeof r.createdBy === 'string' && r.createdBy.toLowerCase() === email) ||
							       (typeof r.createdByEmail === 'string' && r.createdByEmail.toLowerCase() === email) ||
							       (typeof r.requesterEmail === 'string' && r.requesterEmail.toLowerCase() === email) ||
							       (typeof r.requester === 'string' && r.requester.toLowerCase() === email)
						       );
					       });
					       let assignedToUser = this.allRequests.filter(r => {
						       if (Array.isArray(r.approvalHistory)) {
							       if (r.approvalHistory.some(h => h && (h.approverId === userId || h.approvedBy === userId || (h.approverEmail && String(h.approverEmail).toLowerCase() === userEmail)))) return true;
						       }
						       if (r.selectedRoles && typeof r.selectedRoles === 'object') {
							       for (const levelKey of Object.keys(r.selectedRoles)) {
								       const levelArr = r.selectedRoles[levelKey];
								       if (Array.isArray(levelArr)) {
									       for (const approver of levelArr) {
										       const aVal = (approver && (approver.value || approver.uid || approver.id || approver.userId)) || '';
										       const aEmail = (approver && (approver.email || approver.userEmail)) ? String(approver.email || approver.userEmail).toLowerCase() : '';
										       if (aVal === userId || (aEmail && aEmail === userEmail)) return true;
									       }
								       }
							       }
						       }
						       return false;
					       });
					       const userReqMap = {};
					       [...createdByUser, ...assignedToUser].forEach(r => { userReqMap[r.id] = r; });
					       this.userFilteredRequests = Object.values(userReqMap);
					       console.log('📊 Access filter counts:', {
						       all: this.allRequests.length,
						       createdBy: createdByUser.length,
						       assignedTo: assignedToUser.length,
						       final: this.userFilteredRequests.length
					       });
				       }
			       } else {
				       this.userFilteredRequests = [];
			       }
			       // Resolve requester names (replace emails with full names where possible)
			       try{
				       await this.resolveRequesterNames();
			       } catch(e){ console.warn('Requester name resolution failed',e); }
			       this.applyFilters();
		       });
	       }

		// Try to replace requester email/identifiers with full display names when available
		async resolveRequesterNames(){
			if(!Array.isArray(this.allRequests) || this.allRequests.length===0) return;
			// Cache of users when we need to search by email
			if(!this._usersCacheAll) this._usersCacheAll=null;
			const promises=this.allRequests.map(async rec=>{
				try{
					// If requesterName already looks like a proper name (no @), still compute employee code then skip name resolution
					if(rec.requesterName && typeof rec.requesterName==='string' && rec.requesterName.indexOf('@')===-1){
						try { const emp = await this.getRequesterEmployeeId(rec); if(emp) rec._displayEmployeeId = emp; } catch(_e){}
						return;
					}
					// Prefer explicit userId fields
					const uid = rec.userId || rec.requesterUserId || rec.requesterUid || rec.employeeUserId || rec.requesterEmployeeId;
					if(uid){
						const snap = await firebase.database().ref(`users/${uid}`).once('value');
						if(snap.exists()){
							const u = snap.val();
							rec.requesterName = u.displayName || u.name || u.username || u.email || rec.requesterName;
							// Also compute display employee ID for this record
							try { const emp = await this.getRequesterEmployeeId(rec); if(emp) rec._displayEmployeeId = emp; } catch(_e){}
							return;
						}
					}
					// If requesterName is an email, try to lookup user by email from users list
					const maybeEmail = (rec.requesterName && rec.requesterName.includes('@')) ? rec.requesterName : (rec.requesterEmail || rec.requester);
					if(maybeEmail && typeof maybeEmail==='string' && maybeEmail.includes('@')){
						if(this._usersCacheAll===null){
							const usnap = await firebase.database().ref('users').once('value');
							this._usersCacheAll = usnap.exists() ? usnap.val() : {};
						}
						for(const [k,u] of Object.entries(this._usersCacheAll||{})){
							if(u && u.email && u.email.toLowerCase()===maybeEmail.toLowerCase()){
								rec.requesterName = u.displayName || u.name || u.username || u.email;
								try { const emp = await this.getRequesterEmployeeId(rec); if(emp) rec._displayEmployeeId = emp; } catch(_e){}
								return;
							}
						}
						// fallback: infer from email local-part
						const inferred = maybeEmail.split('@')[0].replace(/[._]/g,' ').split(' ').map(w=> w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
						rec.requesterName = inferred || rec.requesterName;
						try { const emp = await this.getRequesterEmployeeId(rec); if(emp) rec._displayEmployeeId = emp; } catch(_e){}
						return;
					}
				}catch(e){
					console.warn('Error resolving requester name for', rec.id, e);
				}
			});
			await Promise.all(promises);
		}

		// ===== Company users directory helpers =====
		async ensureCompanyUsersLoaded(){
			try{
				const companyId = window.authManager?.currentUser?.companyId;
				const now = Date.now();
				if(!companyId) return {};
				if(this.companyUsersCache && this.companyUsersCompanyId===companyId && (now - this.companyUsersLoadedAt) < 5*60*1000){
					return this.companyUsersCache;
				}
				const usersSnapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
				this.companyUsersCache = usersSnapshot.val() || {};
				this.companyUsersCompanyId = companyId;
				this.companyUsersLoadedAt = now;
				return this.companyUsersCache;
			}catch(e){ console.warn('ensureCompanyUsersLoaded failed', e); return this.companyUsersCache||{}; }
		}
		// Return a nice employee code/id for the requester, based on company users directory
		async getRequesterEmployeeId(rec){
			try{
				if(rec && rec._displayEmployeeId) return rec._displayEmployeeId;
				const companyUsers = await this.ensureCompanyUsersLoaded();
				const uid = rec?.userId || rec?.requesterUserId || rec?.requesterUid || rec?.employeeUserId || rec?.requesterEmployeeId;
				let code = '';
				if(uid && companyUsers && companyUsers[uid]){
					const u = companyUsers[uid] || {};
					code = u.employeeId || u.employeeCode || u.empCode || u.code || '';
				}
				// fallback by email match if no uid hit
				if(!code){
					const email = (rec?.requesterEmail || rec?.requester || '').toLowerCase();
					if(email && companyUsers){
						for(const k in companyUsers){
							const u = companyUsers[k];
							const uEmail = String(u?.email||'').toLowerCase();
							if(uEmail && uEmail===email){ code = u.employeeId || u.employeeCode || u.empCode || u.code || ''; if(code) break; }
						}
					}
				}
				// Final fallback to any existing field in the record that looks like a non-UID code
				code = code || rec?.employeeCode || rec?.empCode || rec?.employee_id || '';
				// if still empty, use stored employeeId (may be UID), or requesterEmployeeId
				code = code || rec?.employeeId || rec?.requesterEmployeeId || '';
				rec._displayEmployeeId = code;
				return code;
			}catch(e){ return rec?.employeeId || rec?.requesterEmployeeId || ''; }
		}
	       applyFilters(){
		       // Use all requests when Show All is enabled (for authorized users); otherwise userFilteredRequests
		       const showAll = document.getElementById('showAllToggle')?.checked === true;
		       const baseList = showAll ? (this.allRequests || []) : (Array.isArray(this.userFilteredRequests) && this.userFilteredRequests.length > 0 ? this.userFilteredRequests : []);
		       const q=(this.dom.search?.value||'').toLowerCase();
		       const s=(this.dom.status?.value||'');
		       const pill=this.statusPillFilter;
			   this.filtered=baseList.filter(r=>{
				   const toBeRet = (r.toBeReturned===true||String(r.toBeReturned).toLowerCase()==='yes')?'yes':((r.toBeReturned===false||String(r.toBeReturned).toLowerCase()==='no')?'no':'');
				   const text=[r.referenceNumber,r.requesterName,r.departmentName,r.companyName,r.area,r.propertyRemoval,toBeRet].join(' ').toLowerCase();
			       const matchQ= !q || text.includes(q);
			       const statusVal=(r.status||'').toLowerCase();
			       const matchS= !s || statusVal===s;
			       const matchPill= !pill || statusVal===pill;
			       return matchQ && matchS && matchPill;
		       });
		       this.render();
		       this.renderSummary();
	       }
		fmtDate(dt){ if(!dt) return ''; const d=new Date(dt); if(isNaN(d)) return dt; return d.toLocaleDateString()+" "+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
		statusBadge(val){ const v=(val||'').toLowerCase(); if(v==='submitted') return `<span class="badge badge-status-submitted">SUBMITTED</span>`; if(v==='updated') return `<span class="badge badge-status-updated">UPDATED</span>`; if(v==='approved') return `<span class="badge badge-status-approved">APPROVED</span>`; if(v==='rejected') return `<span class="badge badge-status-rejected">REJECTED</span>`; if(v==='pending_approval'||v==='pending') return `<span class="badge badge-status-updated">PENDING</span>`; return ''; }
		canEdit(record){ const cu=window.authManager?.currentUser; if(!cu) return false; if(cu.role && ['admin','superadmin','company_admin','hr_manager'].some(r=> (cu.role||'').toLowerCase().includes(r))) return true; return record.userId===cu.uid; }
		exportCsv(){ if(this.filtered.length===0){ window.notificationManager?.addNotification({type:'Export',message:'No rows to export.'}); return; } const headers=['Ref','Requester','Department','Company','Area','Start','End','Status','Property Removal','To be Returned','Visitors','Equipment']; const lines=[headers.join(',')]; this.filtered.forEach(r=>{ const toBeRet = (r.toBeReturned===true||String(r.toBeReturned).toLowerCase()==='yes')?'Yes':((r.toBeReturned===false||String(r.toBeReturned).toLowerCase()==='no')?'No':''); let pStartTs=null,pEndTs=null; if(Array.isArray(r.visitors)&&r.visitors.length){ for(const p of r.visitors){ const s=new Date(p.startDateTime||p.startDate||p.start); const e=new Date(p.endDateTime||p.endDate||p.end); if(!isNaN(s)) pStartTs=(pStartTs===null||s<pStartTs)?s:pStartTs; if(!isNaN(e)) pEndTs=(pEndTs===null||e>pEndTs)?e:pEndTs; } } const startDisp = pStartTs? this.fmtDate(pStartTs) : this.fmtDate(r.startDateTime||r.startDate||r.start); const endDisp = pEndTs? this.fmtDate(pEndTs) : this.fmtDate(r.endDateTime||r.endDate||r.end); const row=[r.referenceNumber||r.id,r.requesterName||'',r.departmentName||'',r.companyName||'',r.area||'',startDisp,endDisp,(r.status||'').toUpperCase(),r.propertyRemoval||'',toBeRet,(r.visitors||[]).length,(r.equipment||[]).length]; lines.push(row.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')); }); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='gate_pass_requests.csv'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },500); }
			   renderSummary(){ if(!this.dom.summary) return; this.dom.summary.innerHTML = ""; }
		render(){ const tb=this.dom.tbody; if(!tb) return; tb.innerHTML=''; if(this.filtered.length===0){ tb.innerHTML='<tr><td colspan="7" class="empty-state">No gate pass requests found.</td></tr>'; return; } const rows=this.filtered.map(r=>{ const editAllowed=this.canEdit(r); const toBeRet = (r.toBeReturned===true||String(r.toBeReturned).toLowerCase()==='yes')?'Yes':((r.toBeReturned===false||String(r.toBeReturned).toLowerCase()==='no')?'No':'');
			// Derive People-level start and end if available
			let pStartTs = null, pEndTs = null;
			if(Array.isArray(r.visitors) && r.visitors.length){
				for(const p of r.visitors){
					const s = new Date(p.startDateTime || p.startDate || p.start);
					const e = new Date(p.endDateTime || p.endDate || p.end);
					if(!isNaN(s)) pStartTs = (pStartTs===null || s < pStartTs)? s : pStartTs;
					if(!isNaN(e)) pEndTs = (pEndTs===null || e > pEndTs)? e : pEndTs;
				}
			}
			const startDisp = pStartTs? this.fmtDate(pStartTs) : this.fmtDate(r.startDateTime || r.startDate || r.start);
			const endDisp = pEndTs? this.fmtDate(pEndTs) : this.fmtDate(r.endDateTime || r.endDate || r.end);
			return `<tr data-id="${r.id}" class="clickable-row"><td><a href="#" class="ref-link" data-id="${r.id}" onclick="event.stopPropagation();" style="text-decoration:none;color:#1d6fd8;font-weight:600;">${r.referenceNumber||r.id}</a></td><td>${r.requesterName||''}</td><td>${r.departmentName||''}</td><td>${r.companyName||''}</td><td>${r.area||''}</td><td>${startDisp||''}</td><td>${endDisp||''}</td><td>${this.statusBadge(r.status)}</td><td>${this.escape?.(r.propertyRemoval||'')|| (r.propertyRemoval||'')}</td><td>${toBeRet}</td><td class="actions"><button class="btn btn-view" title="View" onclick="event.stopPropagation(); location.href='access.html?id=${r.id}'"><i class="fas fa-eye"></i></button>${ editAllowed? `<button class="btn btn-edit" title="Edit" onclick="event.stopPropagation(); location.href='access.html?id=${r.id}'"><i class="fas fa-edit"></i></button>`:''}</td></tr>`; }).join(''); tb.innerHTML=rows; this.bindRowClicks();
			// Bind reference link to preview
			tb.querySelectorAll('.ref-link').forEach(a=>{
				a.addEventListener('click',(e)=>{ e.preventDefault(); const id=a.getAttribute('data-id'); this.showPreviewFor(id); });
			});
		}

		attachModalHandlers(){ if(!this.modal.root) return; if(this._modalHandlersAttached) return; const m=this.modal; const hide=()=>{ m.root.classList.add('hidden'); m.root.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }; m.close?.addEventListener('click',hide); m.closeFooter?.addEventListener('click',hide); m.root.addEventListener('click',e=>{ if(e.target===m.root) hide(); }); document.addEventListener('keydown',e=>{ if(e.key==='Escape' && !m.root.classList.contains('hidden')) hide(); }); this._modalHandlersAttached=true; }
		bindRowClicks(){ 
			if(!this.modal.root) return; 
			this.dom.tbody?.querySelectorAll('tr[data-id]').forEach(tr=>{
				tr.addEventListener('click', async ()=>{
					const id=tr.getAttribute('data-id');
					await this.openModal(id);
				});
			});
		}
		
		async openModal(id){
			const rec=this.allRequests.find(r=>r.id===id);
			if(!rec) return;
			// Resolve employee ID for display
			try { await this.ensureCompanyUsersLoaded(); await this.getRequesterEmployeeId(rec); } catch(_e) {}
			
			const m=this.modal;
			
			if(m.title) m.title.textContent=`Gate Pass Request ${rec.referenceNumber||rec.id}`;
			if(m.body) m.body.innerHTML=this.buildModalContent(rec);
			
			if(m.edit){
				const can=this.canEdit(rec);
				m.edit.style.display= can? 'inline-flex':'none';
				m.edit.onclick=()=>{
					location.href=`access.html?id=${rec.id}`;
				};
			}
			
			// Show loading state for buttons first
			const modalFooter = m.root?.querySelector('.modal-footer');
			if (modalFooter) {
				modalFooter.innerHTML = `
					<button type="button" class="btn btn-secondary" disabled>
						<i class="fas fa-spinner fa-spin"></i> Loading...
					</button>
				`;
			}
			
			// Show modal first
			m.root.classList.remove('hidden');
			m.root.removeAttribute('aria-hidden');
			document.body.style.overflow='hidden';
			
			// Then load buttons asynchronously
			await this.updateModalActionButtons(rec);
		}

		// ===== Preview Tab Logic =====
		switchTab(tabId){
			document.querySelectorAll('.tab-nav-btn').forEach(b=> b.classList.toggle('active', b.dataset.tab===tabId));
			document.querySelectorAll('.tab-panel').forEach(p=> p.classList.toggle('active', p.id===tabId));
			if(tabId==='previewTab'){
				setTimeout(()=>{ const p=document.getElementById('accessPreview'); if(p) p.scrollTop=0; },0);
			}
		}
		async showPreviewFor(id){
			const rec = this.allRequests.find(r=> r.id===id);
			if(!rec){ console.warn('Record not found for preview', id); return; }
			window.__lastPreviewId = id;
			try { await this.ensureCompanyUsersLoaded(); await this.getRequesterEmployeeId(rec); } catch(_e) {}
			this.renderAccessPreview(rec);
			this.switchTab('previewTab');
		}
		renderAccessPreview(rec){
			const wrap = document.getElementById('accessPreview'); if(!wrap) return;
			const esc = (v)=> this.escape(v);
			const safe = (v)=> (v===undefined||v===null||v==='')? '-' : esc(String(v));
			const yesno = (v)=> v===true? 'Yes' : v===false? 'No' : '-';
			const people = Array.isArray(rec.visitors)? rec.visitors: [];
			const equipments = Array.isArray(rec.equipment)? rec.equipment: [];
			const genAtt = Array.isArray(rec.generalAttachments)? rec.generalAttachments : (Array.isArray(rec.attachments)? rec.attachments: []);
			const logoEl = document.getElementById('headerCompanyLogo');
			const companyLogoUrl = (logoEl && logoEl.src) ? logoEl.src : '';
			const createdAt = this.fmtDate(rec.createdAt) || '';
				// (Schedule section removed from preview)
			wrap.innerHTML = `
				<div class="payslip-header">
					<div class="company-info">
						<div class="company-logo">${companyLogoUrl? `<img src="${companyLogoUrl}" alt="Company Logo">`:''}</div>
						<div class="company-details">
							<h1>Gate Pass</h1>
							<p>Reference: ${safe(rec.referenceNumber||rec.id)}</p>
						</div>
					</div>
					<div class="payslip-title">
						<div>${safe(rec.companyName||'')}</div>
						<div style="font-size:12px;color:#666;">${createdAt}</div>
					</div>
				</div>

				<div class="preview-grid">
					<div class="preview-card">
						<h4>Requester</h4>
						<div class="detail-row"><span class="detail-label">Name</span><span class="detail-value">${safe(rec.requesterName)}</span></div>
							<div class="detail-row"><span class="detail-label">Employee ID</span><span class="detail-value">${safe(rec._displayEmployeeId || '')}</span></div>
						<div class="detail-row"><span class="detail-label">Department</span><span class="detail-value">${safe(rec.departmentName)}</span></div>
						<div class="detail-row"><span class="detail-label">Company</span><span class="detail-value">${safe(rec.companyName)}</span></div>
							<div class="detail-row"><span class="detail-label">Contact Phone</span><span class="detail-value">${safe(rec.contactPhone)}</span></div>
					</div>
					<!-- Schedule card removed per request -->
					<div class="preview-card">
						<h4>Property</h4>
						<div class="detail-row"><span class="detail-label">Property Removal</span><span class="detail-value">${safe(rec.propertyRemoval)}</span></div>
						<div class="detail-row"><span class="detail-label">To be Returned</span><span class="detail-value">${yesno(rec.toBeReturned)}</span></div>
					</div>
				</div>

				<div class="preview-section-title">Purpose</div>
				<div class="preview-purpose">${safe(rec.purpose || rec.reason)}</div>

				<div class="preview-section-title" style="margin-top:10px;">People</div>
					<table class="preview-table">
						<thead><tr><th>#</th><th>Name</th><th>Job Title</th><th>ID/Passport</th><th>Company</th><th>Area</th><th>Dates</th></tr></thead>
					<tbody>
							${people.length? people.map((p,i)=>{
							const pStart = this.fmtDate(p.startDateTime || p.startDate || p.start) || '-';
							const pEnd = this.fmtDate(p.endDateTime || p.endDate || p.end) || '-';
							const pRange = (pStart==='-' && pEnd==='-')? '-' : `${pStart} — ${pEnd}`;
								return `<tr><td>${i+1}</td><td>${safe(p.name||p.fullName||'')}</td><td>${safe(p.jobTitle||'')}</td><td>${safe(p.idNumber||p.passport||p.nationalId||p.identification||'')}</td><td>${safe(p.company||rec.companyName||'')}</td><td>${safe(p.area||'')}</td><td>${pRange}</td></tr>`;
							}).join('') : `<tr><td colspan="7" style="text-align:center;color:#6b7280;">No people listed</td></tr>`}
						</tbody>
					</table>

				<div class="preview-section-title" style="margin-top:10px;">Equipment</div>
				<table class="preview-table">
					<thead><tr><th>#</th><th>Description</th><th>Serial/Tag</th><th>Qty</th></tr></thead>
					<tbody>
						${equipments.length? equipments.map((eq,i)=>`<tr><td>${i+1}</td><td>${safe(eq.description||eq.name||'')}</td><td>${safe(eq.serial||eq.tag||'')}</td><td>${safe(eq.quantity||eq.qty||1)}</td></tr>`).join('') : `<tr><td colspan="4" style="text-align:center;color:#6b7280;">No equipment</td></tr>`}
					</tbody>
				</table>

				<!-- General Attachments section removed per request -->

				<div class="preview-section-title" style="margin-top:10px;">Approval Flow</div>
				<div id="previewApprovalFlowContent" class="preview-card"><i class="fas fa-spinner fa-spin"></i> Loading approval flow...</div>
			`;
			// Load approval flow into preview
			this.loadApprovalFlowForPreview(rec);
		}
		async loadApprovalFlowForPreview(rec){
			try{
				const companyId = window.authManager?.currentUser?.companyId;
				if(!companyId){ document.getElementById('previewApprovalFlowContent').innerHTML = '<span style="color:#6b7280;">No company context</span>'; return; }
				const ref = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
				const snap = await ref.once('value');
				const cfg = snap.val();
				if(!cfg || !cfg.enabled){ document.getElementById('previewApprovalFlowContent').innerHTML = '<span style="color:#6b7280;">Approval flow not configured</span>'; return; }
				const html = await this.generateApprovalFlowHTML(rec, cfg, { compact: true });
				document.getElementById('previewApprovalFlowContent').innerHTML = html;
			}catch(e){ console.error('Preview approval flow error', e); const el=document.getElementById('previewApprovalFlowContent'); if(el) el.innerHTML = '<span style="color:#dc2626;">Failed to load approval flow</span>'; }
		}
		initPreviewControls(){
			const btnPrint=document.getElementById('btnPrintPreview'); if(btnPrint){ btnPrint.addEventListener('click',()=> window.print()); }
			const btnPdf=document.getElementById('btnPdfPreview'); if(btnPdf){ btnPdf.addEventListener('click',()=> this.exportPreviewAsPdf()); }
			const btnRefresh=document.getElementById('btnRefreshPreview'); if(btnRefresh){ btnRefresh.addEventListener('click',()=>{ if(window.__lastPreviewId){ const rec=this.allRequests.find(r=>r.id===window.__lastPreviewId); if(rec) this.renderAccessPreview(rec);} }); }
		}

		// Dynamically load a script if not present
		_loadScriptOnce(src){ return new Promise((resolve,reject)=>{ if(document.querySelector(`script[src="${src}"]`)){ resolve(); return; } const s=document.createElement('script'); s.src=src; s.onload=()=>resolve(); s.onerror=()=>reject(new Error('Failed to load '+src)); document.head.appendChild(s); }); }

		async exportPreviewAsPdf(){
			const container = document.getElementById('accessPreview');
			if(!container){ alert('Nothing to export'); return; }
			try{
				// Ensure libs
				if(!window.jspdf){ await this._loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'); }
				if(!window.html2canvas){ await this._loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'); }

				// Inline images to avoid CORS/taint issues (e.g., company logo)
				const imgs = Array.from(container.querySelectorAll('img'));
				const revert = [];
				const toDataUrl = async (url)=>{
					const res = await fetch(url, {mode:'cors', credentials:'omit'});
					const blob = await res.blob();
					return await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(blob); });
				};
				const waitImage = (img)=> new Promise(res=>{ if(img.complete) return res(); img.onload=()=>res(); img.onerror=()=>res(); setTimeout(()=>res(), 800); });
				for(const img of imgs){
					try{
						const src = img.getAttribute('src')||'';
						if(!src || src.startsWith('data:')) continue;
						// Only process external or cross-origin images
						const isExternal = /^https?:\/\//i.test(src) && !src.startsWith(location.origin);
						if(isExternal){
							const original = src;
							const dataUrl = await toDataUrl(src);
							img.setAttribute('src', dataUrl);
							await waitImage(img);
							revert.push(()=> img.setAttribute('src', original));
						}
					}catch(e){ /* skip image on failure */ }
				}

				// Render container to canvas
				const canvas = await window.html2canvas(container, { scale: 2, backgroundColor: '#ffffff', useCORS: true, allowTaint: true, logging: false, windowWidth: container.scrollWidth, windowHeight: container.scrollHeight });
				const imgData = canvas.toDataURL('image/png');
				const pdf = new window.jspdf.jsPDF({ unit: 'pt', format: 'a4' });
				const pageWidth = pdf.internal.pageSize.getWidth();
				const pageHeight = pdf.internal.pageSize.getHeight();
				const margin = 24; // small margins
				const imgWidth = pageWidth - margin*2;
				const imgHeight = canvas.height * (imgWidth / canvas.width);

				let heightLeft = imgHeight;
				let position = margin;
				pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
				heightLeft -= (pageHeight - margin*2);
				while(heightLeft > 0){
					pdf.addPage();
					position = margin - (imgHeight - heightLeft);
					pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
					heightLeft -= (pageHeight - margin*2);
				}

				const rec = window.__lastPreviewId ? this.allRequests.find(r=>r.id===window.__lastPreviewId) : null;
				const filename = `gate_pass_preview_${(rec && (rec.referenceNumber||rec.id)) || new Date().toISOString().slice(0,10)}.pdf`;
				pdf.save(filename);
				// Revert any inlined images to original src
				revert.forEach(fn=>{ try{ fn(); }catch(_e){} });
			} catch(err){
				console.error('Export preview PDF failed', err);
				alert('Failed to export preview as PDF: ' + (err.message||err));
			}
		}
	buildModalContent(rec){ const esc=s=>this.escape(s); const visitors=Array.isArray(rec.visitors)? rec.visitors:[]; const equipment=Array.isArray(rec.equipment)? rec.equipment:[]; const attList=arr=>{ if(!arr||arr.length===0) return '<span style="opacity:.6;">None</span>'; const iconFor=(nameOrUrl)=>{ const n=String(nameOrUrl||''); const m=n.match(/\.([a-zA-Z0-9]+)(?:\?|#|$)/); const ext=(m&&m[1]||'').toLowerCase(); let cls='fa-file', color='#6b7280'; if(['png','jpg','jpeg','gif','bmp','webp','svg'].includes(ext)){ cls='fa-file-image'; color='#3b82f6'; } else if(['pdf'].includes(ext)){ cls='fa-file-pdf'; color='#ef4444'; } else if(['doc','docx'].includes(ext)){ cls='fa-file-word'; color='#2563eb'; } else if(['xls','xlsx','csv'].includes(ext)){ cls='fa-file-excel'; color='#16a34a'; } else if(['ppt','pptx'].includes(ext)){ cls='fa-file-powerpoint'; color='#f97316'; } else if(['zip','rar','7z','tar','gz','bz2'].includes(ext)){ cls='fa-file-archive'; color='#a16207'; } else if(['txt','md','log','rtf'].includes(ext)){ cls='fa-file-alt'; color='#6b7280'; } return { cls, color }; }; return `<div class="attachments">${arr.map(a=>{ const nm = a.name||'file'; const sz = (typeof a.size==='number'?a.size:parseInt(a.size)||0); const hint = `${esc(nm)}${ sz? ` (${this.humanSize(sz)})`:''}`; const {cls,color}=iconFor(a.name||a.url||''); return `<a class=\"attachment-chip\" href=\"${a.url||'#'}\" target=\"_blank\" rel=\"noopener\" title=\"${hint}\" style=\"display:inline-block;margin-right:6px;\"><i class=\"fas ${cls}\" style=\"color:${color};font-size:16px;\"></i></a>`; }).join('')}</div>`; }; const visitorRows= visitors.map((v,i)=>{ const vatts= Array.isArray(v.attachments)? v.attachments : (v.attachment? [v.attachment]: []); const s = this.fmtDate(v.startDateTime||v.startDate||v.start) || '-'; const e = this.fmtDate(v.endDateTime||v.endDate||v.end) || '-'; const rng = (s==='-'&&e==='-')? '-' : `${s} — ${e}`; return `<tr><td>${i+1}</td><td>${esc(v.name||'')}</td><td>${esc(v.identification||v.idNumber||v.visitorId||v.id||'')}</td><td>${esc(v.company||'')}</td><td>${esc(v.area||'')}</td><td>${esc(rng)}</td><td>${vatts.length? attList(vatts):'<span style=\"opacity:.5;\">-</span>'}</td></tr>`; }).join(''); const equipRows= equipment.map((e,i)=>{ return `<tr><td>${i+1}</td><td>${esc(e.name||e.item||'')}</td><td>${esc(e.description||'')}</td></tr>`; }).join(''); const toBeRetDisp = (rec.toBeReturned===true||String(rec.toBeReturned).toLowerCase()==='yes')?'Yes':((rec.toBeReturned===false||String(rec.toBeReturned).toLowerCase()==='no')?'No':''); return `
<div class="detail-grid">
	<div class="detail-item"><div class="label">Reference</div><div class="value mono">${esc(rec.referenceNumber||rec.id)}</div></div>
	<div class="detail-item"><div class="label">Requester</div><div class="value">${esc(rec.requesterName||'')}</div></div>
	<div class="detail-item"><div class="label">Employee ID</div><div class="value">${esc(rec._displayEmployeeId||'')}</div></div>
	<div class="detail-item"><div class="label">Department</div><div class="value">${esc(rec.departmentName||'')}</div></div>
	<div class="detail-item"><div class="label">Company</div><div class="value">${esc(rec.companyName||'')}</div></div>
	<div class="detail-item"><div class="label">Contact Phone</div><div class="value">${esc(rec.contactPhone||'')}</div></div>
	<div class="detail-item"><div class="label">Property Removal</div><div class="value">${esc(rec.propertyRemoval||'')}</div></div>
	<div class="detail-item"><div class="label">To be Returned</div><div class="value">${toBeRetDisp}</div></div>
	<div class="detail-item"><div class="label">Status</div><div class="value">${this.statusBadge(rec.status)}</div></div>
	<div class="detail-item"><div class="label">Created</div><div class="value">${esc(this.fmtDate(rec.createdAt))}</div></div>
	<div class="detail-item"><div class="label">Updated</div><div class="value">${esc(this.fmtDate(rec.updatedAt))}</div></div>
</div>
${this.buildApprovalFlowSection(rec)}
<h3 style="margin-top:1.5rem;">People</h3>
<div class="table-wrapper" style="max-height:180px;">
<table style="width:100%;border-collapse:collapse;font-size:12px;">
	<thead><tr><th>#</th><th>Name</th><th>ID</th><th>Company</th><th>Area</th><th>Dates</th><th>Files</th></tr></thead>
	<tbody>${visitorRows||'<tr><td colspan="7" style="text-align:center;opacity:.6;">None</td></tr>'}</tbody>
</table>
</div>
<h3 style="margin-top:1.5rem;">Equipment</h3>
<div class="table-wrapper" style="max-height:180px;">
<table style="width:100%;border-collapse:collapse;font-size:12px;">
	<thead><tr><th>#</th><th>Name</th><th>Description</th></tr></thead>
	<tbody>${equipRows||'<tr><td colspan="3" style="text-align:center;opacity:.6;">None</td></tr>'}</tbody>
</table>
</div>
<h3 style="margin-top:1.5rem;">Purpose</h3>
<div style="background:#f7f9fc;border:1px solid var(--border-color);padding:.75rem;border-radius:6px;max-height:160px;overflow:auto;font-size:12px;">${esc(rec.purpose|| rec.reason || '')||'<span style="opacity:.6;">None</span>'}</div>
`; }
		buildApprovalFlowSection(rec){
			console.log('🔄 Building approval flow section for:', rec.id);
			
			// Always load approval flow configuration asynchronously
			// Use setTimeout to ensure DOM is ready
			setTimeout(() => {
				this.loadApprovalFlowAsync(rec);
			}, 100);
			
			return `
<h3 style="margin-top:1.5rem;"><i class="fas fa-route"></i> Approval Flow</h3>
<div id="approvalFlowContent" class="approval-flow-loading">
	<i class="fas fa-spinner fa-spin"></i> Loading approval configuration...
</div>`;
		}
		
		async loadApprovalFlowAsync(rec) {
			console.log('🔄 Loading approval flow for request:', rec.id);
			
			try {
				const companyId = window.authManager?.currentUser?.companyId;
				console.log('🏢 Company ID:', companyId);
				
				if (!companyId) {
					console.error('❌ No company context available');
					this.updateApprovalFlowContent(`
						<div class="no-approval-flow">
							<i class="fas fa-exclamation-triangle"></i>
							<h4>No Company Context</h4>
							<p>Unable to load approval flow - no company context available.</p>
						</div>`);
					return;
				}
				
				// Fetch approval flow configuration from Firebase
				console.log('📡 Fetching approval flow config from:', `companies/${companyId}/approvalFlows/access`);
				const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
				const snapshot = await approvalFlowRef.once('value');
				const config = snapshot.val();
				
				console.log('📋 Approval flow config:', config);
				
				if (!config) {
					console.log('📋 No approval flow configuration found');
					this.updateApprovalFlowContent(`
						<div class="no-approval-flow">
							<i class="fas fa-info-circle"></i>
							<h4>No Approval Flow Configured</h4>
							<p>Access request approval flow is not configured for this company.</p>
						</div>`);
					return;
				}
				
				if (!config.enabled) {
					console.log('📋 Approval flow is disabled');
					this.updateApprovalFlowContent(`
						<div class="no-approval-flow">
							<i class="fas fa-info-circle"></i>
							<h4>Approval Flow Disabled</h4>
							<p>Access request approval flow is currently disabled.</p>
						</div>`);
					return;
				}
				
				// Generate approval flow HTML with actual configuration
				console.log('🎨 Generating approval flow HTML');
				const approvalHTML = await this.generateApprovalFlowHTML(rec, config, { hideActual: true });
				this.updateApprovalFlowContent(approvalHTML);
				console.log('✅ Approval flow loaded successfully');
				
			} catch (error) {
				console.error('❌ Error loading approval flow:', error);
				this.updateApprovalFlowContent(`
					<div class="approval-flow-error">
						<i class="fas fa-exclamation-triangle"></i>
						<h4>Failed to Load Approval Flow</h4>
						<p>Error: ${error.message || 'Unknown error occurred'}</p>
					</div>`);
			}
		}
		
		updateApprovalFlowContent(html) {
			console.log('🔄 Updating approval flow content');
			const container = document.getElementById('approvalFlowContent');
			if (container) {
				container.innerHTML = html;
				container.className = ''; // Remove loading class
				console.log('✅ Approval flow content updated');
			} else {
				console.error('❌ Could not find approvalFlowContent container');
			}
		}
		
		async generateApprovalFlowHTML(rec, config, options = {}) {
			console.log('🎨 Generating approval flow HTML for:', rec.id);
			console.log('📋 Config:', config);
			
			try {
				const status = rec.status || rec.approvalStatus;
				const approvalHistory = rec.approvalHistory || [];
				const companyId = window.authManager?.currentUser?.companyId;
				
				// Determine overall approval status
				let flowStatus = 'pending';
				let flowStatusText = 'Pending';
				let flowStatusClass = 'pending';
				
				if (status === 'approved') {
					flowStatus = 'approved';
					flowStatusText = 'Approved';
					flowStatusClass = 'approved';
				} else if (status === 'rejected') {
					flowStatus = 'rejected';
					flowStatusText = 'Rejected';
					flowStatusClass = 'rejected';
				}
				
				// Fetch company users to resolve approver names
				let companyUsers = {};
				try {
					if (companyId) {
						console.log('👥 Fetching company users from:', `companies/${companyId}/users`);
						const usersSnapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
						companyUsers = usersSnapshot.val() || {};
						console.log('🏢 Fetched company users for approval flow:', Object.keys(companyUsers).length);
					}
				} catch (error) {
					console.error('Error fetching company users:', error);
				}

				// Helpers to resolve approver display (prefer full name + job title over raw email)
				const findUserByEmail = (email) => {
					if (!email) return null;
					const target = String(email).toLowerCase();
					for (const uid in companyUsers) {
						const u = companyUsers[uid];
						if (u && String(u.email || '').toLowerCase() === target) {
							return { uid, ...u };
						}
					}
					return null;
				};
				const resolveApproverFromHistory = (h) => {
					let user = null;
					if (h && (h.approverId || h.approvedBy)) {
						user = companyUsers[h.approverId || h.approvedBy] || null;
					}
					if (!user && h && h.approverEmail) {
						user = findUserByEmail(h.approverEmail);
					}
					const name = (user?.name || user?.displayName || h?.approverName || '').trim() || 'Approver';
					const title = (user?.jobTitle || user?.role || '').trim();
					return { user, name, title, display: title ? `${name} — ${title}` : name };
				};
				
				// Build approval stages from configuration
				let stagesHTML = '';
				const isSequential = config.approvalOrder === 'sequential';
				
				if (config.selectedRoles && typeof config.selectedRoles === 'object') {
					const levelKeys = Object.keys(config.selectedRoles).sort();
					console.log('📊 Processing approval levels:', levelKeys);
					
					for (let i = 0; i < levelKeys.length; i++) {
						const levelKey = levelKeys[i];
						const levelNumber = i + 1;
						const levelConfig = config.selectedRoles[levelKey];
						
						console.log(`📋 Processing level ${levelNumber}:`, levelConfig);
						
						// Find approval record for this level
						const approvalRecord = approvalHistory.find(h => 
							h.level === levelKey || 
							h.level === levelNumber || 
							h.approvalLevel === levelNumber
						);
						
						// For sequential approval, check if this level is available
						let isLevelAvailable = true;
						let isLevelLocked = false;
						
						if (isSequential) {
							// Check if all previous levels are approved
							for (let j = 0; j < i; j++) {
								const prevLevelKey = levelKeys[j];
								const prevLevelNumber = j + 1;
								const prevApprovalRecord = approvalHistory.find(h => 
									h.level === prevLevelKey || 
									h.level === prevLevelNumber || 
									h.approvalLevel === prevLevelNumber
								);
								
								if (!prevApprovalRecord || prevApprovalRecord.status !== 'approved') {
									isLevelAvailable = false;
									isLevelLocked = true;
									break;
								}
							}
						}
						
						// Determine stage status
						let stageClass = 'pending';
						let statusText = 'Pending';
						let numberClass = 'pending';
						let iconHTML = levelNumber;
						let approverName = 'Unknown Approver';
						let approverTitle = '';
						let timestamp = '';
						let comments = '';
						
						// Handle locked state for sequential approval
						if (isSequential && isLevelLocked && !approvalRecord) {
							stageClass = 'locked';
							statusText = 'Locked - Waiting for Previous Level';
							numberClass = 'locked';
							iconHTML = '<i class="fas fa-lock"></i>';
						}
						
						// Get approver information from company users
						if (Array.isArray(levelConfig) && levelConfig.length > 0) {
							const approverConfig = levelConfig[0];
							const approverId = approverConfig.value || approverConfig.uid;
							
							console.log(`👤 Resolving approver ${approverId} for level ${levelNumber}`);
							
							if (approverId && companyUsers[approverId]) {
								const approverData = companyUsers[approverId];
								approverName = approverData.name || approverData.displayName || approverConfig.text || 'Unknown Approver';
								approverTitle = approverData.jobTitle || approverData.role || '';
								console.log(`✅ Resolved approver: ${approverName} (${approverTitle})`);
							} else {
								// Fallback to config text if user not found
								approverName = approverConfig.text || approverConfig.value || 'Unknown Approver';
								console.log(`⚠️ Using fallback name: ${approverName}`);
							}
						}
						
						if (approvalRecord) {
							if (approvalRecord.status === 'approved') {
								stageClass = 'completed';
								statusText = 'Approved';
								numberClass = 'completed';
								iconHTML = '<i class="fas fa-check"></i>';
								// Prefer resolved directory info over raw email/name
								{ const r = resolveApproverFromHistory(approvalRecord); approverName = r.name || approverName; approverTitle = r.title || approverTitle; }
								timestamp = approvalRecord.approvedAt || approvalRecord.timestamp;
								comments = approvalRecord.comments;
							} else if (approvalRecord.status === 'rejected') {
								stageClass = 'rejected';
								statusText = 'Rejected';
								numberClass = 'rejected';
								iconHTML = '<i class="fas fa-times"></i>';
								{ const r = resolveApproverFromHistory(approvalRecord); approverName = r.name || approverName; approverTitle = r.title || approverTitle; }
								timestamp = approvalRecord.rejectedAt || approvalRecord.timestamp;
								comments = approvalRecord.reason || approvalRecord.comments;
							}
						}
						
						stagesHTML += `
							<div class="approval-stage ${stageClass}">
								<div class="stage-number ${numberClass}">${iconHTML}</div>
								<div class="stage-info">
									<div class="stage-title">Level ${levelNumber} - ${this.escape(approverName)}${approverTitle ? ` — ${this.escape(approverTitle)}` : ''}</div>
									<div class="approver-info">
										${(!options.hideActual && approverTitle) ? `<div class="approver-title">${this.escape(approverTitle)}</div>` : ''}
										<div class="stage-status-text ${stageClass}">${statusText}</div>
									</div>
									${timestamp ? `<div class="stage-timestamp"><i class="fas fa-clock"></i> ${this.fmtDate(timestamp)}</div>` : ''}
									${comments ? `<div class="stage-comments"><strong>Comments:</strong> ${this.escape(comments)}</div>` : ''}
									${!options.compact && !options.hideActual && approvalRecord && (approvalRecord.status === 'approved' || approvalRecord.status === 'rejected') ? 
										`<div class="actual-approver-info" style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; border-left: 3px solid ${approvalRecord.status === 'approved' ? '#28a745' : '#dc3545'};">
											<div style="font-weight: 600; color: ${approvalRecord.status === 'approved' ? '#28a745' : '#dc3545'};">
												<i class="fas fa-${approvalRecord.status === 'approved' ? 'check' : 'times'}"></i> 
												${approvalRecord.status === 'approved' ? 'Approved' : 'Rejected'} by: ${(() => { const r = resolveApproverFromHistory(approvalRecord); return this.escape(r.display); })()}
											</div>
											<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
												<i class="fas fa-clock"></i> ${this.fmtDate(approvalRecord.approvedAt || approvalRecord.rejectedAt || approvalRecord.timestamp)}
											</div>
											${approvalRecord.approverId || approvalRecord.approvedBy ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">ID: ${this.escape(approvalRecord.approverId || approvalRecord.approvedBy)}</div>` : ''}
											${approvalRecord.comments || approvalRecord.reason ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: ${approvalRecord.status === 'approved' ? '#d4edda' : '#f8d7da'}; border-radius: 3px;"><strong>Comments:</strong> ${this.escape(approvalRecord.comments || approvalRecord.reason)}</div>` : ''}
										</div>` : ''}
								</div>
							</div>`;
					}
				} else {
					console.log('⚠️ No selectedRoles found in config');
				}
			
				if (!stagesHTML) {
					stagesHTML = `
						<div class="approval-stage">
							<div class="stage-number pending">1</div>
							<div class="stage-info">
								<div class="stage-title">Review Stage</div>
								<div class="stage-status-text pending">Pending Review</div>
							</div>
						</div>`;
				}
				
				console.log('🎨 Generated approval flow HTML successfully');
				
				if(options.compact){
					// Minimal list representation without header title text
					const listItems = (rec.approvalHistory||[]).map((h,i)=>{
						const st = (h.status||'pending').toLowerCase();
						const r = resolveApproverFromHistory(h);
						const who = this.escape(r.display);
						const when = this.fmtDate(h.approvedAt || h.rejectedAt || h.timestamp) || '';
						return `<li><span class="status ${st}">${st.charAt(0).toUpperCase()+st.slice(1)}</span> by ${who}${when? ` — ${when}`:''}</li>`;
					}).join('') || '<li><span class="status pending">Pending</span></li>';
					return `<div class="approval-flow-simple"><ul class="approval-list">${listItems}</ul></div>`;
				}

				return `
					<div class="approval-flow-section">
						<div class="approval-flow-header">
							<h4 class="approval-flow-title">
								<i class="fas fa-clipboard-check"></i>
								<!-- Title removed in compact mode -->
							</h4>
							<span class="approval-flow-status ${flowStatusClass}">${flowStatusText}</span>
						</div>
						<div class="approval-stages">
							${stagesHTML}
						</div>
					</div>`;
			} catch (error) {
				console.error('❌ Error in generateApprovalFlowHTML:', error);
				return `
					<div class="approval-flow-error">
						<i class="fas fa-exclamation-triangle"></i>
						<h4>Error Generating Approval Flow</h4>
						<p>Error: ${error.message || 'Unknown error occurred'}</p>
					</div>`;
			}
		}
		async updateModalActionButtons(rec) {
			const modalFooter = this.modal.root?.querySelector('.modal-footer');
			if (!modalFooter) return;
			
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) return;
			
			const status = rec.status || 'submitted';
			const isApproved = status === 'approved';
			const isRejected = status === 'rejected';
			const isSubmitted = status === 'submitted';
			const isUpdated = status === 'updated';
			const isPendingApproval = status === 'pending_approval';
			const hasAnyApproval = Array.isArray(rec.approvalHistory) && rec.approvalHistory.some(h => h && (h.status === 'approved' || h.status === 'rejected'));
			
			// Check permissions
			const canEdit = this.canEdit(rec);
			const canApprove = await this.canApproveAsync(rec); // Use async approval check
			const canDelete = this.canDelete(rec);
			const canExport = true; // Basic export permission for all
			
			// Debug information
			console.log('Modal Action Buttons Debug:', {
				recordId: rec.id,
				recordStatus: status,
				currentUserRole: currentUser?.role,
				canEdit,
				canApprove,
				canDelete,
				isSubmitted,
				isUpdated,
				isPendingApproval,
				isApproved,
				isRejected
			});
			
			let buttons = `
				<button type="button" class="btn btn-secondary" id="modalCloseFooter" title="Close">
					<i class="fas fa-times"></i>
				</button>
			`;
			
			// Edit button - hide once any approval action has occurred
			if (canEdit && !isApproved && !isRejected && !hasAnyApproval) {
				buttons += `
					<button type="button" class="btn btn-primary" onclick="window.accessBoardManager.editAccessRequest('${rec.id}')" title="Edit Request">
						<i class="fas fa-edit"></i>
					</button>
				`;
			}
			
			// Delete button - hide once any approval action has occurred
			if (canDelete && !isApproved && !hasAnyApproval) {
				buttons += `
					<button type="button" class="btn btn-danger" onclick="window.accessBoardManager.deleteAccessRequest('${rec.id}')" title="Delete Request">
						<i class="fas fa-trash"></i>
					</button>
				`;
			}
			
			// Approve button - show if user can approve and request is pending
			if (canApprove && (isSubmitted || isUpdated || isPendingApproval)) {
				console.log('✅ Adding Approve button for record:', rec.id);
				   buttons += `
					   <button type="button" class="btn btn-success" onclick="window.accessBoardManager.approveAccessRequest('${rec.id}')" title="Approve Request">
						   <i class="fas fa-check"></i>
					   </button>
				   `;
			} else {
				console.log('❌ NOT adding Approve button:', { canApprove, isSubmitted, isUpdated, status });
			}
			
			// Decline button - show if user can approve and request is pending
			if (canApprove && (isSubmitted || isUpdated || isPendingApproval)) {
				console.log('✅ Adding Decline button for record:', rec.id);
				   buttons += `
					   <button type="button" class="btn btn-warning" onclick="window.accessBoardManager.declineAccessRequest('${rec.id}')" title="Decline Request">
						   <i class="fas fa-times"></i>
					   </button>
				   `;
			} else {
				console.log('❌ NOT adding Decline button:', { canApprove, isSubmitted, isUpdated, status });
			}
			
			// Export button - always show
			if (canExport) {
				buttons += `
					<button type="button" class="btn btn-info" onclick="event.stopPropagation(); console.log('PDF Button clicked for:', '${rec.id}'); window.accessBoardManager?.exportAccessRequest('${rec.id}');" title="Export as PDF">
						<i class="fas fa-file-pdf"></i>
					</button>
				`;
			}
			
			modalFooter.innerHTML = buttons;
			
			// Re-attach close handler
			const closeBtn = modalFooter.querySelector('#modalCloseFooter');
			if (closeBtn) {
				closeBtn.addEventListener('click', () => {
					this.modal.root.classList.add('hidden');
					this.modal.root.setAttribute('aria-hidden', 'true');
					document.body.style.overflow = '';
				});
			}
		}
		canApprove(rec) {
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) return false;
			
			// For now, return false as we'll load the configuration asynchronously
			// This will be replaced by async approval check
			return false;
		}
		
		// New async method to check approval permissions based on configuration
		async canApproveAsync(rec) {
			console.log('🔍 canApproveAsync called for record:', rec.id);
			
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) {
				console.log('❌ No current user found');
				return false;
			}
			
			console.log('👤 Current user:', currentUser.email, 'Company:', currentUser.companyId);
			
			try {
				// Get approval flow configuration for access requests
				const approvalFlowRef = firebase.database().ref(`companies/${currentUser.companyId}/approvalFlows/access`);
				const snapshot = await approvalFlowRef.once('value');
				const approvalConfig = snapshot.val();
				
				console.log('🔍 Checking approval permissions for user:', currentUser.uid);
				console.log('📋 Approval config:', approvalConfig);
				
				if (!approvalConfig || !approvalConfig.enabled) {
					console.log('❌ No approval configuration found or disabled');
					return false;
				}
				
				const isSequential = approvalConfig.approvalOrder === 'sequential';
				const levels = approvalConfig.levels || [];
				
				// Sort levels by level number to ensure proper order
				const sortedLevels = levels.sort((a, b) => (a.level || 0) - (b.level || 0));
				
				console.log(`📊 Approval flow type: ${isSequential ? 'Sequential' : 'Parallel'}`);
				console.log('📋 Sorted approval levels:', sortedLevels.map(l => `Level ${l.level}: ${l.approverType}=${l.value}`));
				
				// Get current approval history from the request
				const approvalHistory = rec.approvalHistory || [];
				console.log('📝 Current approval history:', approvalHistory);
				
				for (const level of sortedLevels) {
					const canApproveAtLevel = await this.checkApprovalPermissionForLevel(level, currentUser, rec);
					console.log(`🔍 Can approve at level ${level.level}:`, canApproveAtLevel);
					
					if (canApproveAtLevel) {
						console.log(`🔍 User has permission for level ${level.level}`);
						
						if (isSequential) {
							// For sequential approval, check if this is the next level to approve
							const canApproveSequentially = await this.canApproveAtLevelSequentially(level, sortedLevels, approvalHistory, rec);
							if (canApproveSequentially) {
								console.log(`✅ User can approve at level ${level.level} (sequential approval)`);
								return true;
							} else {
								console.log(`⏳ Level ${level.level} is locked - waiting for previous levels to complete`);
							}
						} else {
							// For parallel approval, user can approve if they have permission and level hasn't been approved yet
							const hasAlreadyApproved = this.hasLevelBeenApproved(level.level, approvalHistory);
							if (!hasAlreadyApproved) {
								console.log(`✅ User can approve at level ${level.level} (parallel approval)`);
								return true;
							} else {
								console.log(`✅ Level ${level.level} already approved (parallel approval)`);
							}
						}
					}
				}
				
				console.log('❌ User cannot approve at any level or all levels completed');
				return false;
				
			} catch (error) {
				console.error('Error checking approval permissions:', error);
				return false;
			}
		}
		
		// Check if user can approve at a level in sequential approval flow
		async canApproveAtLevelSequentially(targetLevel, sortedLevels, approvalHistory, rec) {
			const targetLevelNum = targetLevel.level || 0;
			
			// Check if all previous levels have been approved
			for (const level of sortedLevels) {
				const levelNum = level.level || 0;
				
				if (levelNum >= targetLevelNum) {
					// We've reached or passed the target level
					break;
				}
				
				// Check if this previous level has been approved
				const hasBeenApproved = this.hasLevelBeenApproved(levelNum, approvalHistory);
				if (!hasBeenApproved) {
					console.log(`⏳ Cannot approve level ${targetLevelNum} - level ${levelNum} not yet approved`);
					return false;
				}
			}
			
			// Check if target level has already been approved
			const targetAlreadyApproved = this.hasLevelBeenApproved(targetLevelNum, approvalHistory);
			if (targetAlreadyApproved) {
				console.log(`✅ Level ${targetLevelNum} already approved`);
				return false;
			}
			
			console.log(`✅ All previous levels approved - can approve level ${targetLevelNum}`);
			return true;
		}
		
		// Check if a specific level has been approved in the approval history
		hasLevelBeenApproved(levelNum, approvalHistory) {
			return approvalHistory.some(entry => 
				(entry.level === levelNum || entry.approvalLevel === levelNum) && 
				entry.status === 'approved'
			);
		}
		
		// Check if user can approve at a specific level
		async checkApprovalPermissionForLevel(level, currentUser, rec) {
			const approverType = level.approverType;
			const approverValue = level.value;
			const userRole = (currentUser.role || '').toLowerCase();
			
			console.log(`🔍 Checking approval permission - Type: ${approverType}, Value: ${approverValue}, User Role: ${userRole}`);
			
			switch (approverType) {
				case 'function':
					// Check if user has the required function/role
					const requiredFunction = approverValue.replace('function_', '');
					const hasFunction = userRole.includes(requiredFunction) || 
						   ['admin', 'superadmin', 'company_admin'].some(r => userRole.includes(r));
					
					console.log(`📋 Function check - Required: ${requiredFunction}, Has permission: ${hasFunction}`);
					return hasFunction;
				
				case 'name':
					// Check if user is specifically named as approver
					const userId = approverValue.replace('user_', '');
					const isNamedApprover = currentUser.uid === userId || currentUser.email === userId;
					
					console.log(`👤 Name check - Required: ${userId}, User ID: ${currentUser.uid}, Is named: ${isNamedApprover}`);
					return isNamedApprover;
				
				case 'level':
					// Check if user is at the required level (L+1, L+2, etc.)
					// This would require organizational hierarchy data
					// For now, fall back to admin roles
					const adminRoles = ['admin', 'superadmin', 'company_admin', 'manager', 'supervisor'];
					const hasLevelPermission = adminRoles.some(r => userRole.includes(r));
					
					console.log(`📊 Level check - Required: ${approverValue}, Has permission: ${hasLevelPermission}`);
					return hasLevelPermission;
				
				default:
					console.log(`❓ Unknown approver type: ${approverType}`);
					return false;
			}
		}
		canDelete(rec) {
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) return false;
			
			// Check if user is the submitter or has admin permissions
			if (rec.userId === currentUser.uid) return true;
			
			const role = (currentUser.role || '').toLowerCase();
			if (['admin', 'superadmin', 'company_admin'].some(r => role.includes(r))) {
				return true;
			}
			
			return false;
		}
		editAccessRequest(id) {
			location.href = `access.html?id=${id}`;
		}
		deleteAccessRequest(id) {
			if (!confirm('Are you sure you want to delete this access request? This action cannot be undone.')) {
				return;
			}
			
			const currentUser = window.authManager?.currentUser;
			if (!currentUser?.companyId) {
				alert('No company context available');
				return;
			}
			
			// Delete from Firebase
			firebase.database().ref(`companies/${currentUser.companyId}/access/${id}`).remove()
				.then(async () => {
					await window.notificationManager?.createNotification(currentUser.uid, {
						title: 'Access Request Deleted',
						message: 'Access request deleted successfully',
						type: 'info'
					});
					
					// Close modal and refresh data
					this.modal.root.classList.add('hidden');
					this.modal.root.setAttribute('aria-hidden', 'true');
					document.body.style.overflow = '';
				})
				.catch(error => {
					console.error('Error deleting access request:', error);
					alert('Failed to delete access request');
				});
		}
		async approveAccessRequest(id) {
				console.log('🎯 approveAccessRequest invoked (button click) with ID:', id, 'this.accessRequests length:', (this.accessRequests||[]).length, 'allRequests length:', (this.allRequests||[]).length);
			
			const reason = prompt('Enter approval comments (optional):') || '';
			console.log('📝 Approval reason:', reason);
			
			// Get the current access request to check approval flow (fallback to allRequests)
			const rec = (this.accessRequests||[]).find(req => req.id === id) || (this.allRequests||[]).find(r=>r.id===id);
			if (!rec) {
				console.error('Access request not found for approval');
				alert('Access request not found');
				return;
			}
			
			console.log('📋 Found access request:', rec);
			
			try {
				// Add approval to history
				const currentUser = firebase.auth().currentUser;
				if (!currentUser) {
					console.error('No current user found');
					alert('No user session found. Please log in again.');
					return;
				}
				
				console.log('👤 Current user:', currentUser.email);

					// Determine current approval level correctly (pass id, not object)
					let currentLevel = 1;
					try {
						currentLevel = await this.getCurrentApprovalLevel(id);
						console.log('📊 Computed current approval level:', currentLevel);
					} catch(levelErr) {
						console.warn('⚠️ Could not compute current approval level, defaulting to 1:', levelErr.message);
					}
				
				const approvalEntry = {
					approverId: currentUser.uid,
					approverName: currentUser.displayName || currentUser.email,
					status: 'approved',
					timestamp: new Date().toISOString(),
					comments: reason,
						level: currentLevel,
						approvalLevel: currentLevel
				};
				
				console.log('📝 Created approval entry:', approvalEntry);
				
				// Update approval history
				const updatedHistory = [...(rec.approvalHistory || []), approvalEntry];
				console.log('📊 Updated history:', updatedHistory);
				
					// Check if all approval levels are complete (provide companyId & history in updateData shape)
					const companyId = window.authManager?.currentUser?.companyId;
					const isComplete = await this.checkIfApprovalComplete(rec, { approvalHistory: updatedHistory }, companyId);
					const finalStatus = isComplete ? 'approved' : 'pending_approval';
				
				console.log(`🎯 Approval Status: ${finalStatus}, Complete: ${isComplete}`);
				
				// Update the request with new approval and status
				this.updateAccessRequestStatus(id, finalStatus, reason, updatedHistory);
				// Emit notifications (requester and approver)
				try{
				  const requesterUid = rec.userId;
				  const refNum = rec.referenceNumber || rec.id;
				  if(requesterUid){
				    await window.notificationManager?.createNotification(requesterUid, {
				      title: finalStatus==='approved'? 'Access Request Approved' : 'Approval Progress',
				      message: finalStatus==='approved'? `Your access request ${refNum} was fully approved.` : `Your access request ${refNum} advanced in approval.`,
				      type: finalStatus==='approved'? 'success':'info',
				      relatedData: { requestId: rec.id, status: finalStatus },
				      link: `access.html?id=${rec.id}`
				    });
				  }
				  const approverUid = firebase.auth().currentUser?.uid;
				  if(approverUid){
				    await window.notificationManager?.createNotification(approverUid, {
				      title: 'Approval Recorded',
				      message: `You approved access request ${refNum}.`,
				      type: 'success',
				      relatedData: { requestId: rec.id, status: finalStatus },
				      link: `access.html?id=${rec.id}`
				    });
				  }
				}catch(_e){}
				
			} catch (error) {
				console.error('Error processing approval:', error);
				alert('Failed to process approval: ' + error.message);
			}
		}
		async declineAccessRequest(id) {
			console.log('❌ declineAccessRequest called with ID:', id);
			
			const reason = prompt('Enter decline reason:');
			if (!reason || reason.trim() === '') {
				alert('Decline reason is required');
				return;
			}
			
			console.log('📝 Decline reason:', reason);
			
			try {
				// Build rejection history so UI updates instantly
				const rec = (this.accessRequests||this.allRequests||[]).find(r => r.id === id);
				let currentLevel = 1;
				try { currentLevel = await this.getCurrentApprovalLevel(id); } catch(e) { console.warn('⚠️ getCurrentApprovalLevel failed for rejection, defaulting to 1'); }
				const curUser = firebase.auth().currentUser;
				const rejectionEntry = {
					approverId: curUser?.uid,
					approverName: curUser?.displayName || curUser?.email,
					status: 'rejected',
					timestamp: new Date().toISOString(),
					reason: reason,
					comments: reason,
					level: currentLevel,
					approvalLevel: currentLevel
				};
				const updatedHistory = [...(rec?.approvalHistory || []), rejectionEntry];
				this.updateAccessRequestStatus(id, 'rejected', reason, updatedHistory);

				// Emit notifications for decline
				try{
				  const requesterUid = rec?.userId;
				  const refNum = rec?.referenceNumber || id;
				  if(requesterUid){
				    await window.notificationManager?.createNotification(requesterUid, {
				      title: 'Access Request Declined',
				      message: `Your access request ${refNum} was declined. Reason: ${reason}`,
				      type: 'warning',
				      relatedData: { requestId: id, status: 'rejected' },
				      link: `access.html?id=${id}`
				    });
				  }
				  const approverUid = firebase.auth().currentUser?.uid;
				  if(approverUid){
				    await window.notificationManager?.createNotification(approverUid, {
				      title: 'Decline Recorded',
				      message: `You declined access request ${refNum}.`,
				      type: 'info',
				      relatedData: { requestId: id, status: 'rejected' },
				      link: `access.html?id=${id}`
				    });
				  }
				}catch(_e){}
			} catch (error) {
				console.error('Error processing decline:', error);
				alert('Failed to process decline: ' + error.message);
			}
		}
		updateAccessRequestStatus(id, status, reason, providedHistory = null) {
			console.log('🔄 updateAccessRequestStatus called:', { id, status, reason, hasProvidedHistory: !!providedHistory });
			
			const currentUser = window.authManager?.currentUser;
			if (!currentUser?.companyId) {
				console.error('No company context available');
				alert('No company context available');
				return;
			}
			
			console.log('🏢 Company ID:', currentUser.companyId);
			console.log('👤 Current user:', currentUser.email);
			
			const timestamp = new Date().toISOString();
			const updateData = {
				status: status,
				[status === 'approved' ? 'approvedAt' : 'rejectedAt']: timestamp,
				[status === 'approved' ? 'approvedBy' : 'rejectedBy']: currentUser.uid,
				[status === 'approved' ? 'approvalComments' : 'rejectionReason']: reason
			};
			
			console.log('📊 Update data prepared:', updateData);
			
			// Use provided history if available (from approveAccessRequest), otherwise create new entry
			if (providedHistory) {
				console.log('📝 Using provided history');
				updateData.approvalHistory = providedHistory;
				
				// Set final status directly for approved requests
				if (status === 'approved') {
					updateData.finalApprovedAt = timestamp;
					updateData.finalApprovedBy = currentUser.uid;
					console.log('🎉 All approval levels completed - request fully approved');
				}
				
				// Update in Firebase
				const firebasePath = `companies/${currentUser.companyId}/access/${id}`;
				console.log('🔥 Firebase update path:', firebasePath);
				
				const accessRef = firebase.database().ref(firebasePath);
				accessRef.update(updateData).then(() => {
					console.log('✅ Firebase update successful');
					window.notificationManager?.addNotification({
						type: status === 'approved' ? 'Approve' : 'Decline',
						message: `Access request ${status === 'approved' ? 'approved' : 'declined'} successfully`
					});
					// Update local record to reflect new state immediately
					const localRec = (this.accessRequests||this.allRequests||[]).find(r => r.id === id);
					if (localRec) {
						localRec.status = updateData.status;
						localRec.approvalHistory = updateData.approvalHistory;
						this.loadApprovalFlowAsync(localRec);
						this.updateModalActionButtons(localRec);
					}
					this.loadAccessRequests();
				}).catch(error => {
					console.error(`Error ${status === 'approved' ? 'approving' : 'declining'} access request:`, error);
					alert(`Failed to ${status === 'approved' ? 'approve' : 'decline'} access request: ${error.message}`);
				});
			} else {
				// Legacy path for rejection and simple approvals
				this.getCurrentApprovalLevel(id).then(approvalLevel => {
					// Add to approval history with level information
					const historyEntry = {
						status: status,
						timestamp: timestamp,
						approverName: currentUser.name || currentUser.email,
						approverId: currentUser.uid,
						comments: reason,
						level: approvalLevel,
						approvalLevel: approvalLevel
					};
					
					console.log(`📝 Recording ${status} at level ${approvalLevel}:`, historyEntry);
					
					// Update in Firebase
					const accessRef = firebase.database().ref(`companies/${currentUser.companyId}/access/${id}`);
					accessRef.once('value').then(snapshot => {
						const currentData = snapshot.val() || {};
						const approvalHistory = currentData.approvalHistory || [];
						approvalHistory.push(historyEntry);
						
						updateData.approvalHistory = approvalHistory;
						
						// Check if this completes the approval process
						return this.checkIfApprovalComplete(currentData, updateData, currentUser.companyId).then(isComplete => {
							if (isComplete && status === 'approved') {
								updateData.status = 'approved';
								updateData.finalApprovedAt = timestamp;
								updateData.finalApprovedBy = currentUser.uid;
								console.log('🎉 All approval levels completed - request fully approved');
							} else if (status === 'approved') {
								updateData.status = 'pending_approval';
								console.log('⏳ Partial approval completed - waiting for remaining levels');
							}
							
							return accessRef.update(updateData);
						});
					}).then(() => {
						window.notificationManager?.addNotification({
							type: status === 'approved' ? 'Approve' : 'Decline',
							message: `Access request ${status === 'approved' ? 'approved' : 'declined'} successfully`
						});
						const localRec = (this.accessRequests||this.allRequests||[]).find(r => r.id === id);
						if (localRec) {
							localRec.status = updateData.status;
							localRec.approvalHistory = updateData.approvalHistory;
							this.loadApprovalFlowAsync(localRec);
							this.updateModalActionButtons(localRec);
						}
					}).catch(error => {
						console.error(`Error ${status === 'approved' ? 'approving' : 'declining'} access request:`, error);
						alert(`Failed to ${status === 'approved' ? 'approve' : 'decline'} access request`);
					});
				}).catch(error => {
					console.error('Error determining approval level:', error);
					alert('Failed to determine approval level');
				});
			}
		}
		
		// Get the approval level that the current user should approve at
		async getCurrentApprovalLevel(requestId) {
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) throw new Error('No current user');
			
			// Get the request data
			const rec = this.allRequests.find(r => r.id === requestId);
			if (!rec) throw new Error('Request not found');
			
			// Get approval flow configuration
			const approvalFlowRef = firebase.database().ref(`companies/${currentUser.companyId}/approvalFlows/access`);
			const snapshot = await approvalFlowRef.once('value');
			const approvalConfig = snapshot.val();
			
			if (!approvalConfig || !approvalConfig.enabled) {
				throw new Error('No approval configuration found');
			}
			
			const levels = approvalConfig.levels || [];
			const sortedLevels = levels.sort((a, b) => (a.level || 0) - (b.level || 0));
			
			// Find which level the current user can approve at
			for (const level of sortedLevels) {
				const canApproveAtLevel = await this.checkApprovalPermissionForLevel(level, currentUser, rec);
				if (canApproveAtLevel) {
					// For sequential approval, make sure this is the correct level
					if (approvalConfig.approvalOrder === 'sequential') {
						const canApproveSequentially = await this.canApproveAtLevelSequentially(level, sortedLevels, rec.approvalHistory || [], rec);
						if (canApproveSequentially) {
							return level.level || 1;
						}
					} else {
						// For parallel approval, return the level if not already approved
						const hasBeenApproved = this.hasLevelBeenApproved(level.level, rec.approvalHistory || []);
						if (!hasBeenApproved) {
							return level.level || 1;
						}
					}
				}
			}
			
			throw new Error('User cannot approve at any level');
		}
		
		// Check if all required approval levels have been completed
		async checkIfApprovalComplete(currentData, updateData, companyId) {
			try {
				// Get approval flow configuration
				const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
				const snapshot = await approvalFlowRef.once('value');
				const approvalConfig = snapshot.val();
				
				if (!approvalConfig || !approvalConfig.enabled) {
					return true; // If no config, consider complete
				}
				
				const levels = approvalConfig.levels || [];
				const approvalHistory = updateData.approvalHistory || [];
				
				// Check if all levels have been approved
				for (const level of levels) {
					const hasBeenApproved = this.hasLevelBeenApproved(level.level, approvalHistory);
					if (!hasBeenApproved) {
						console.log(`⏳ Level ${level.level} not yet approved`);
						return false;
					}
				}
				
				console.log('✅ All approval levels completed');
				return true;
				
			} catch (error) {
				console.error('Error checking approval completion:', error);
				return true; // Default to complete on error
			}
		}
		
		exportAccessRequest(id) {
			console.log('🔥 PDF Export clicked for ID:', id);
			const rec = this.allRequests.find(r => r.id === id);
			if (!rec) {
				console.error('❌ Record not found for PDF export:', id);
				alert('Record not found');
				return;
			}
			console.log('📋 Record found for PDF:', rec);
			
			// Capture context for helper methods
			const self = this;
			
			// Load jsPDF dynamically if not present
			const generatePdf = async () => {
				try {
					// Ensure company users are loaded and requester employee code is resolved
					try { await this.ensureCompanyUsersLoaded(); await this.getRequesterEmployeeId(rec); } catch(_e) {}
					console.log('📄 Starting PDF generation...');
					const doc = new window.jspdf.jsPDF({ unit: 'pt', format: 'a4' });
					const lineHeight = 14;
					let y = 40;
					const left = 40;
					const maxWidth = 515;
					const pageBottom = 780;

					// Try to embed company logo (from header branding)
					const getHeaderLogoSrc = () => { const el = document.getElementById('headerCompanyLogo'); return (el && el.src) ? el.src : ''; };
					const fetchAsDataURL = async (src) => { if(!src) return null; if(src.startsWith('data:')) return src; const res = await fetch(src, {mode:'cors', credentials:'omit'}); if(!res.ok) return null; const blob = await res.blob(); return await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(blob); }); };
					const rasterizeSvgIfNeeded = async (dataUrl) => { if(!dataUrl || !dataUrl.startsWith('data:image/svg')) return dataUrl; return await new Promise(resolve=>{ const img=new Image(); img.onload=()=>{ try{ const size=52; const c=document.createElement('canvas'); c.width=size; c.height=size; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,size,size); resolve(c.toDataURL('image/png')); }catch(e){ resolve(dataUrl); } }; img.onerror=()=>resolve(dataUrl); img.src=dataUrl; }); };
					try{
						let logoSrc = getHeaderLogoSrc();
						if(logoSrc){
							let dataUrl = await fetchAsDataURL(logoSrc);
							dataUrl = await rasterizeSvgIfNeeded(dataUrl);
							if(dataUrl){
								const typeHeader = dataUrl.substring(5, dataUrl.indexOf(';')) || 'image/png';
								const imgType = /png/i.test(typeHeader)? 'PNG' : 'JPEG';
								doc.addImage(dataUrl, imgType, left, y-10, 48, 48);
							}
						}
					}catch(e){ console.warn('Logo embed skipped:', e); }
					
					// Helper to format dates safely
					const formatDate = (dateStr) => {
						if (!dateStr) return '';
						try {
							return self.fmtDate ? self.fmtDate(dateStr) : new Date(dateStr).toLocaleDateString();
						} catch (e) {
							return String(dateStr);
						}
					};
					
					// Helper to format file sizes safely
					const formatSize = (bytes) => {
						if (!bytes) return '';
						try {
							return self.humanSize ? self.humanSize(bytes) : `${bytes} bytes`;
						} catch (e) {
							return String(bytes);
						}
					};
					
					// Add a line of text with safe option normalization and coordinate guards
					const addLine = (text, opts) => {
						// Normalize options: support being called with undefined/null or wrong types
						const o = (opts && typeof opts === 'object') ? opts : {};
						const isBold = !!o.bold;
						const gap = Number.isFinite(o.gap) ? Number(o.gap) : 0;
						// Ensure y is always a finite number
						if (!Number.isFinite(y)) { y = 40; }
						doc.setFont('helvetica', isBold ? 'bold' : 'normal');
						const lines = doc.splitTextToSize(String(text ?? ''), maxWidth);
						lines.forEach(l => {
							if (y > pageBottom) { doc.addPage(); y = 40; }
							// Guard coordinates before drawing
							const yy = Number.isFinite(y) ? y : 40;
							doc.text(String(l), left, yy);
							y = yy + lineHeight;
						});
						// Advance by gap if valid
						if (gap) {
							y += gap;
						}
					};
					const addSection = (title) => {
						if (y > pageBottom) { doc.addPage(); y = 40; }
						if (!Number.isFinite(y)) { y = 40; }
						doc.setFontSize(11);
						doc.setFont('helvetica','bold');
						doc.text(String(title ?? ''), left, y);
						y += lineHeight;
						doc.setFontSize(10);
						doc.setDrawColor(200);
						doc.line(left, y-8, left+515, y-8);
						y += 2;
					};
					
					// Header
					doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.text('Gate Pass Request Report', left + 58, y + 10); y+= lineHeight*1.5; doc.setFontSize(10);
					addLine(`Generated: ${new Date().toLocaleString()}`); y += 4;
					doc.setDrawColor(60); doc.line(left, y, left+515, y); y += lineHeight;
					
					// Core details
					addSection('Basic Details');
					addLine(`Reference: ${rec.referenceNumber || rec.id}`, {bold:true});
					addLine(`Requester: ${rec.requesterName || ''}`);
					addLine(`Employee ID: ${rec._displayEmployeeId || rec.employeeId || rec.requesterEmployeeId || ''}`);
					addLine(`Department: ${rec.departmentName || ''}`);
					addLine(`Company: ${rec.companyName || ''}`);
					addLine(`Contact Phone: ${rec.contactPhone || ''}`);
					addLine(`Status: ${(rec.status || '').toUpperCase()}`);
					addLine(`Created: ${formatDate(rec.createdAt)}`);
					addLine(`Updated: ${formatDate(rec.updatedAt)}`);
					addLine(`Area: ${rec.area || ''}`);
					addLine(`Start: ${formatDate(rec.startDateTime)}`);
					addLine(`End: ${formatDate(rec.endDateTime)}`);
					
					// New fields
					const toBeRetDisp = (rec.toBeReturned===true||String(rec.toBeReturned).toLowerCase()==='yes')?'Yes':((rec.toBeReturned===false||String(rec.toBeReturned).toLowerCase()==='no')?'No':'');
					addLine(`Property Removal: ${rec.propertyRemoval || ''}`);
					addLine(`To be Returned: ${toBeRetDisp}`);
					
					// Purpose
					addSection('Purpose');
					addLine((rec.purpose || rec.reason || 'None'), {gap: lineHeight/2});
					
					// People
					if (Array.isArray(rec.visitors) && rec.visitors.length){
						addSection('People');
						rec.visitors.forEach((v,i)=>{
							const area = v.area || '';
							const vStart = formatDate(v.startDateTime || v.startDate || v.start);
							const vEnd = formatDate(v.endDateTime || v.endDate || v.end);
							addLine(`${i+1}. ${v.name||''}` , {bold:true});
							addLine(`   ID: ${v.identification||v.idNumber||v.visitorId||v.id||''}`);
							addLine(`   Company: ${v.company||''}`);
							addLine(`   Area: ${area}`);
							addLine(`   Start: ${vStart}`);
							addLine(`   End: ${vEnd}`);
							// attachments per person
							const vatts = Array.isArray(v.attachments)? v.attachments : (v.attachment? [v.attachment]: []);
							if (vatts.length){
								addLine('   Files:', {bold:true});
								vatts.forEach(a=> addLine(`      - ${a.name || 'file'}${a.size? ` (${formatSize(typeof a.size==='number'?a.size:parseInt(a.size)||0)})`:''}`));
							}
							y += 2;
						});
					}
					
					// Equipment
					if (Array.isArray(rec.equipment) && rec.equipment.length){
						addSection('Equipment');
						rec.equipment.forEach((e,i)=> addLine(`${i+1}. ${e.name||e.item||''}${e.description? ' - '+e.description: ''}`));
					}
					
					// General Attachments
					if (Array.isArray(rec.generalAttachments) && rec.generalAttachments.length){
						addSection('General Attachments');
						rec.generalAttachments.forEach((a,i)=> addLine(`${i+1}. ${a.name || 'file'}${a.size? ` (${formatSize(typeof a.size==='number'?a.size:parseInt(a.size)||0)})`:''}`));
					}
					
					// Approval History
					if (Array.isArray(rec.approvalHistory) && rec.approvalHistory.length){
						addSection('Approval History');
						rec.approvalHistory.forEach((h,i)=>{
							addLine(`${i+1}. Level ${h.level||h.approvalLevel||'?'} - ${(h.status||'').toUpperCase()} by ${h.approverName||'Unknown'} @ ${formatDate(h.timestamp||h.approvedAt||h.rejectedAt)}${h.comments? ' | '+h.comments:''}`);
						});
					}
					
					// Footer
					if (y > pageBottom) { doc.addPage(); y=40; }
					const yFooter = Number.isFinite(y) ? y + 10 : 50;
					doc.setFontSize(8);
					doc.text('End of Report', left, yFooter);
					
					const filename = `gate_pass_${rec.referenceNumber || rec.id}.pdf`;
					console.log('💾 Saving PDF as:', filename);
					doc.save(filename);
					console.log('✅ PDF generated successfully');
				} catch (error) {
					console.error('❌ Error generating PDF:', error);
					alert('Error generating PDF: ' + error.message);
				}
			};
			
			if (!window.jspdf) {
				console.log('📦 Loading jsPDF library...');
				const script = document.createElement('script');
				script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
				script.onload = () => { 
					console.log('✅ jsPDF loaded successfully');
					generatePdf(); 
				};
				script.onerror = () => { 
					console.error('❌ Failed to load jsPDF library');
					alert('Failed to load PDF library'); 
				};
				document.head.appendChild(script);
			} else {
				console.log('✅ jsPDF already loaded');
				generatePdf();
			}
		}
		escape(str){ if(str===undefined||str===null) return ''; return String(str).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','"':'&quot;','\'':'&#39;'}[c]||c)); }
		humanSize(bytes){ if(typeof bytes!=='number') return ''; if(bytes<1024) return bytes+' B'; if(bytes<1024*1024) return (bytes/1024).toFixed(1)+' KB'; return (bytes/1024/1024).toFixed(2)+' MB'; }
	}
	document.addEventListener('DOMContentLoaded',()=>{ window.accessBoardManager=new AccessBoardManager(); });
	</script>
</body>
</html>
