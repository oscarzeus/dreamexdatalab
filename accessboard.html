 <!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Gate Pass Requests Board - Dreamex Datalab HSE</title>
	<!-- Firebase v8 CDN (match other pages) -->
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<meta name="robots" content="noindex, nofollow">
	<style>
		/* === Core Variables / Layout (derived from recruitboard + staff) === */
		:root { --primary-color:#2c3e50; --secondary-color:#3498db; --accent-color:#3498db; --text-color:#333; --bg-color:#f5f6fa; --sidebar-width:250px; --blue:#3498db; --green:#2ecc71; --orange:#e67e22; --red:#e74c3c; --purple:#9b59b6; --font-family:'Inter',system-ui,-apple-system,sans-serif; --base-font-size:.9rem; --font-scale:1; --bg-primary:#ffffff; --bg-secondary:#f8f9fa; --text-primary:#333; --text-secondary:#666; --border-color:#e0e0e0; --spacing-unit:.9rem; --padding-sm:.45rem; --padding-md:.75rem; --padding-lg:1.2rem; --transition-speed:.2s; }
		*{margin:0;padding:0;box-sizing:border-box;} body{font-family:var(--font-family);font-size:var(--base-font-size);line-height:1.4;color:var(--text-primary);background:#f8f9fa;}
		.app-container{display:flex;min-height:100vh;}
		.sidebar{width:var(--sidebar-width);background:var(--primary-color);color:#fff;padding:1rem;position:fixed;height:100vh;overflow-y:auto;transition:transform .3s ease;}
		.sidebar.collapsed{transform:translateX(-100%);} .logo h2{text-align:center;padding:1rem 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:1.05rem;}
		.menu{list-style:none;margin-top:1.5rem;} .menu li{margin-bottom:.45rem;} .menu a{color:#fff;text-decoration:none;display:flex;align-items:center;padding:.65rem .9rem;border-radius:6px;font-size:.78rem;gap:.55rem;letter-spacing:.25px;transition:background .25s;} .menu a:hover,.menu a.active{background:var(--secondary-color);} .menu-dropdown .submenu{display:none;list-style:none;margin-left:1.2rem;margin-top:.35rem;} .menu-dropdown:hover .submenu{display:block;}
		/* Feature-based visibility */
		[data-feature]:not(.menu-visible){display:none !important;} .menu-dropdown:not(.menu-visible){display:none !important;} 
		
		/* Hide ALL menu items by default during loading */
		.sidebar.menu-loading .menu-item, .sidebar.menu-loading .menu-dropdown, .sidebar.menu-loading li[data-feature], .sidebar.menu-loading [data-feature] {display:none !important;} .menu-loading [data-feature]{display:none !important;} .menu-loading .menu-dropdown{display:none !important;}
		.main-content{flex:1;margin-left:var(--sidebar-width);padding:.45rem;width:calc(100% - var(--sidebar-width));box-sizing:border-box;display:flex;flex-direction:column;transition:margin-left .3s ease,width .3s ease;}
		.main-content.sidebar-collapsed{margin-left:0;width:100%;}
		/* Top Nav (copied style approach from staff.html) */
		.top-nav{display:flex;justify-content:space-between;align-items:center;padding:.5rem .75rem;background:#fff;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:.35rem;position:fixed;top:.25rem;right:.5rem;left:calc(var(--sidebar-width) + .5rem);height:50px;min-height:50px;z-index:100;transition:left .3s ease;}
		.top-nav-left{display:flex;align-items:center;gap:1rem;font-size:.8rem;font-weight:600;color:var(--text-secondary);} .sidebar-toggle-btn{background:none;border:none;cursor:pointer;font-size:1.15rem;padding:.45rem;color:#666;border-radius:6px;display:flex;align-items:center;justify-content:center;} .sidebar-toggle-btn:hover{background:rgba(0,0,0,.06);}
		#headerCompanyLogo{width:44px;height:44px;object-fit:cover;display:none;background:transparent;border:none;box-shadow:none;} #headerCompanyLogo.visible{display:block;} #headerCompanyName{font-size:.8rem;font-weight:600;letter-spacing:.5px;color:var(--primary-color);max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
		.top-nav-right{display:flex;align-items:center;gap:1.2rem;margin-left:auto;}
		.notifications{position:relative;display:flex;align-items:center;} .notification-btn{background:none;border:none;cursor:pointer;position:relative;font-size:1.2rem;padding:.5rem;display:flex;align-items:center;justify-content:center;} .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--accent-color);color:#fff;border-radius:50%;padding:.2rem .5rem;font-size:.7rem;}
		.notification-dropdown{display:none;position:absolute;right:0;top:100%;width:320px;background:#fff;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.15);z-index:1000;border:1px solid #e9ecef;max-height:400px;overflow:hidden;}
		.notification-dropdown.show{display:block;animation:slideDown 0.2s ease-out;} @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}} .notification-header{padding:12px 16px;border-bottom:1px solid #e9ecef;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);display:flex;justify-content:space-between;align-items:center;} .notification-header h3{margin:0;color:#333;font-size:14px;font-weight:600;} .mark-all-read{background:none;border:none;color:#3498db;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px;transition:all 0.2s ease;} .mark-all-read:hover{background:#e3f2fd;color:#1976d2;} .clear-all-notifications{background:none;border:none;color:#e74c3c;cursor:pointer;font-size:12px;padding:4px 8px;border-radius:4px;transition:all 0.2s ease;margin-left:8px;} .clear-all-notifications:hover{background:#fdf2f2;color:#c0392b;} .notification-actions{position:absolute;top:8px;right:8px;display:none;gap:4px;} .notification-item:hover .notification-actions{display:flex;} .mark-read-btn,.delete-notification-btn{background:none;border:none;cursor:pointer;padding:4px;border-radius:3px;transition:all 0.2s ease;font-size:12px;} .mark-read-btn{color:#3498db;} .mark-read-btn:hover{background:#e3f2fd;color:#1976d2;} .delete-notification-btn{color:#e74c3c;} .delete-notification-btn:hover{background:#fdf2f2;color:#c0392b;} .notification-item.read .mark-read-btn{color:#95a5a6;cursor:default;} .notification-item.read .mark-read-btn:hover{background:none;color:#95a5a6;} .notification-list{max-height:320px;overflow-y:auto;padding:0;} .notification-list::-webkit-scrollbar{width:4px;} .notification-list::-webkit-scrollbar-track{background:#f1f1f1;} .notification-list::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:2px;} .notification-item{padding:12px 16px;border-bottom:1px solid #f1f1f1;cursor:pointer;transition:background-color 0.2s ease;position:relative;} .notification-item:hover{background:#f8f9fa;} .notification-item.unread{background:#e8f4fd;border-left:3px solid #3498db;} .notification-item.unread::before{content:'';position:absolute;top:16px;right:16px;width:8px;height:8px;background:#3498db;border-radius:50%;} .notification-dot{position:absolute;top:16px;right:16px;width:8px;height:8px;background:#3498db;border-radius:50%;} .notification-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;margin-right:12px;flex-shrink:0;} .notification-icon.info{background:#e3f2fd;color:#1976d2;} .notification-icon.success{background:#e8f5e8;color:#2e7d2e;} .notification-icon.warning{background:#fff3e0;color:#f57c00;} .notification-icon.error{background:#ffebee;color:#d32f2f;} .notification-content{flex:1;min-width:0;} .notification-title{font-weight:600;font-size:13px;color:#333;margin-bottom:2px;line-height:1.3;} .notification-message{font-size:12px;color:#666;line-height:1.4;word-wrap:break-word;} .notification-time{font-size:11px;color:#999;margin-top:4px;} .notification-empty{padding:40px 20px;text-align:center;color:#999;} .notification-empty i{font-size:32px;margin-bottom:12px;color:#ddd;} .notification-empty-title{font-size:14px;font-weight:500;margin-bottom:4px;color:#666;} .notification-empty-message{font-size:12px;color:#999;}
		.profile-btn{background:none;border:none;cursor:pointer;padding:.25rem;display:flex;align-items:center;position:relative;} 
		.profile-btn img{width:40px;height:40px;border-radius:50%;object-fit:cover;}
		.avatar-initials{width:40px;height:40px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:14px;font-family:Arial,sans-serif;}
		.profile-dropdown{display:none;position:absolute;top:100%;right:0;background:#fff;border-radius:6px;box-shadow:0 4px 18px rgba(0,0,0,.12);min-width:200px;z-index:1000;} .profile-dropdown.show{display:block;} .profile-dropdown ul{list-style:none;margin:0;padding:0;} .profile-dropdown ul li a{display:flex;align-items:center;padding:12px 16px;color:#333;text-decoration:none;font-size:.78rem;gap:.6rem;transition:background .2s;} .profile-dropdown ul li a:hover{background:#f5f7fa;}
		.avatar-initials{width:40px;height:40px;border-radius:50%;background:var(--secondary-color);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:1rem;}
		/* Page Header (board title) */
		.page-header{background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;padding:.55rem .75rem;margin:.35rem 0 .5rem 0;display:flex;align-items:center;justify-content:space-between;box-shadow:0 10px 28px rgba(0,0,0,.18),0 6px 16px rgba(0,0,0,.14);font-size:.9rem;}
		.page-header i{font-size:1rem;}
		/* Add New Button */
		.btn-add-new{background:none;border:none;color:#fff;padding:.4rem;font-size:1.2rem;font-weight:600;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;text-decoration:none;}
		.btn-add-new:hover{color:rgba(255,255,255,0.8);transform:scale(1.1);}
		.btn-add-new i{font-size:1.2rem;}

		/* Tab Navigation (matching incidentboard.html design) */
		.tab-nav{display:flex;gap:0;border-bottom:2px solid #e5e7eb;margin-bottom:1rem}
		.tab-btn{padding:.6rem 1.2rem;font-size:.85rem;font-weight:500;color:#6b7280;background:transparent;border:none;cursor:pointer;position:relative;transition:color .2s;display:inline-flex;align-items:center;gap:6px}
		.tab-btn:hover{color:#111827}
		.tab-btn.active{color:var(--primary-color);font-weight:600}
		.tab-btn.active::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:2px;background:var(--primary-color)}
		.tab-content{display:none}
		.tab-content.active{display:block}

		/* Simple approval list for compact forms */
		.approval-flow-simple{background:#fff;border:1px solid #e5e7eb;border-radius:6px;padding:10px}
		.approval-flow-simple .approval-list{list-style:none;margin:0;padding:0}
		.approval-flow-simple .approval-list li{padding:6px 0;border-bottom:1px solid #f0f2f5;font-size:12px;color:#333}
		.approval-flow-simple .approval-list li:last-child{border-bottom:none}
		.approval-flow-simple .status{font-weight:600}
		.approval-flow-simple .status.approved{color:#1e8449}
		.approval-flow-simple .status.rejected{color:#c0392b}
		.approval-flow-simple .status.pending{color:#6c757d}

		@media print{ 
			@page { size: A4; margin: 5mm 8mm; }
			
			/* Hide everything by default - use display:none to prevent blank pages */
			html, body { margin:0 !important; padding:0 !important; background:#fff !important; height:auto !important; overflow:visible !important; }
			body * { visibility:hidden !important; display:none !important; }

			/* Show only the modal A4 content when printing */
			#accessDetailsModal,
			.modal-backdrop,
			.modal-panel,
			.modal-body,
			.a4-sheet,
			.printable { display:block !important; visibility:visible !important; }
			
			#accessDetailsModal *,
			.modal-body *,
			.a4-sheet *,
			.printable * { visibility:visible !important; display:revert !important; }
			
			/* Position and size the print area */
			#accessDetailsModal { 
				position:absolute !important; 
				left:0 !important; 
				top:0 !important; 
				width:100% !important; 
				height:auto !important;
				padding:0 !important; 
				background:transparent !important; 
				display:block !important;
				overflow:visible !important;
			}
			
			/* Override modal hidden state for printing */
			.modal-backdrop.hidden { display:block !important; visibility:visible !important; }
			
			.modal-backdrop{position:static !important; background:none !important; padding:0 !important; display:block !important; overflow:visible !important; height:auto !important;}
			.modal-panel{position:static !important; box-shadow:none !important; background:#fff !important; max-width:100% !important; width:100% !important; min-height:auto !important; height:auto !important; max-height:none !important; overflow:visible !important; border-radius:0 !important;}
			.modal-header, .modal-footer, .modal-title{display:none !important; visibility:hidden !important; height:0 !important; overflow:hidden !important;}
			.modal-body { overflow:visible !important; padding:0 !important; height:auto !important; max-height:none !important; }
			
			/* A4 sheet - compact fit for single page */
			.a4-sheet{
				position:static !important; 
				width:100% !important; 
				min-height:auto !important;
				height:auto !important;
				margin:0 !important; 
				padding:0 !important;
				box-shadow:none !important; 
				border:none !important;
				border-radius:0 !important;
				overflow:visible !important;
				page-break-after:avoid !important;
				page-break-inside:avoid !important;
				font-size:0.6rem !important;
			}
			
			/* Compact header */
			.a4-header { 
				display:flex !important; 
				justify-content:flex-start !important; 
				align-items:center !important;
				gap:12px !important;
				margin-bottom:6px !important;
				padding-bottom:6px !important;
				border-bottom:2px solid var(--primary-color, #2c3e50) !important;
			}
			
			.a4-logo { 
				width:50px !important; 
				height:50px !important;
				object-fit:contain !important;
				border:none !important;
				border-radius:4px !important;
				-webkit-print-color-adjust:exact !important;
				print-color-adjust:exact !important;
			}
			
			.a4-company h1 {
				font-size:0.85rem !important;
				margin:0 !important;
			}
			
			.a4-company .doc-title {
				display:none !important;
			}
			
			/* Hide divider in print - use border instead */
			.divider, .a4-divider {
				display:none !important;
			}
			
			/* Hide document meta row with reference number */
			.docmeta-row {
				display:none !important;
			}
			
			/* Compact table styling */
			.a4-info-table { 
				width:100% !important; 
				border-collapse:collapse !important;
				page-break-inside:avoid !important;
				font-size:0.55rem !important;
				display:table !important;
				margin-bottom:6px !important;
			}
			.a4-info-table thead, .a4-info-table tbody, .a4-info-table tr { display:revert !important; }
			.a4-info-table th { 
				background:var(--primary-color, #2c3e50) !important; 
				color:#fff !important; 
				font-weight:600 !important;
				font-size:0.5rem !important;
				padding:4px 5px !important;
				border:1px solid var(--primary-color, #2c3e50) !important;
				text-align:left !important;
				display:table-cell !important;
				-webkit-print-color-adjust:exact !important; 
				print-color-adjust:exact !important; 
			}
			.a4-info-table td {
				background:#fff !important;
				color:#111827 !important;
				padding:3px 5px !important;
				border:1px solid #e5e7eb !important;
				vertical-align:top !important;
				display:table-cell !important;
				font-size:0.55rem !important;
				line-height:1.3 !important;
				-webkit-print-color-adjust:exact !important;
				print-color-adjust:exact !important;
			}
			/* Zebra striping for body rows to match Leave Details */
			.a4-info-table tbody tr:nth-child(odd) td {
				background:#f9fafb !important;
				-webkit-print-color-adjust:exact !important;
				print-color-adjust:exact !important;
			}
			.a4-info-table tbody tr:nth-child(even) td {
				background:#ffffff !important;
			}
			.a4-info-table tr { 
				page-break-inside:avoid !important; 
				display:table-row !important;
			}
			
			/* Compact section title */
			.a4-section-title { 
				background: linear-gradient(135deg, var(--primary-color, #2c3e50), #34495e) !important; 
				color: #fff !important; 
				border: none !important;
				border-radius: 3px !important;
				padding: 4px 8px !important;
				margin: 6px 0 4px !important;
				font-size: 0.6rem !important;
				font-weight: 600 !important;
				page-break-after:avoid !important;
				display: flex !important;
				align-items: center !important;
				gap: 6px !important;
				-webkit-print-color-adjust: exact !important;
				print-color-adjust: exact !important;
			}
			.a4-section-title i {
				color: #fff !important;
				font-size: 0.6rem !important;
				width:18px !important;
				height:18px !important;
				background:rgba(255,255,255,0.2) !important;
				border-radius:50% !important;
				display:flex !important;
				align-items:center !important;
				justify-content:center !important;
				-webkit-print-color-adjust: exact !important;
				print-color-adjust: exact !important;
			}
			
			/* Compact section styling */
			.a4-section { 
				page-break-inside:avoid !important; 
				break-inside:avoid !important;
				margin: 2px 0 !important;
			}
			
			/* Purpose box compact */
			.a4-section > div[style*="background:#f9fafb"] {
				padding:6px 8px !important;
				min-height:30px !important;
				font-size:0.55rem !important;
			}
			
			/* Status chip print styling - compact */
			.status-chip {
				font-size:0.5rem !important;
				padding:2px 6px !important;
				border-radius:3px !important;
				-webkit-print-color-adjust:exact !important;
				print-color-adjust:exact !important;
			}
			.status-chip.approved { background:#dcfce7 !important; color:#166534 !important; }
			.status-chip.declined, .status-chip.rejected { background:#fee2e2 !important; color:#991b1b !important; }
			.status-chip.pending { background:#fef3c7 !important; color:#92400e !important; }
			.status-chip.submitted { background:#dbeafe !important; color:#1d4ed8 !important; }
			
			/* Approval flow section compact */
			#approvalFlowContent {
				font-size:0.55rem !important;
				padding:4px !important;
			}
			
			#approvalFlowContent table {
				font-size:0.5rem !important;
			}
			
			#approvalFlowContent th {
				padding:3px 4px !important;
				font-size:0.48rem !important;
			}
			
			#approvalFlowContent td {
				padding:3px 4px !important;
				font-size:0.5rem !important;
			}
			
			/* Compact signature */
			.sig-img {
				max-width:80px !important;
				max-height:35px !important;
				object-fit:contain !important;
			}
			
			.sig-stack {
				gap:2px !important;
			}
			
			.approver-fullname {
				font-size:0.5rem !important;
			}
			
			.approver-job {
				font-size:0.45rem !important;
			}

			/* Hide non-essential UI during print */
			.sidebar, .top-nav, .tab-nav, .print-controls, .modal-close, .btn{display:none !important; visibility:hidden !important;}
			
			/* Hide header images that appear outside the A4 sheet (broken images) */
			#headerCompanyLogo, #userAvatarImg, .company-logo img, .profile-btn img {
				display:none !important;
				visibility:hidden !important;
			}
			
			/* Hide images with empty or invalid src to prevent broken image icons */
			img[src=""], img:not([src]) {
				display:none !important;
				visibility:hidden !important;
			}
			
			/* Keep only the A4 logo visible */
			.a4-logo {
				display:block !important;
				visibility:visible !important;
			}
			
			/* Hide signature images that have no valid URL (broken) */
			.sig-img[src=""], .sig-img:not([src]) {
				display:none !important;
			}
			
			/* Ensure fonts and colors print correctly */
			html, body {
				-webkit-print-color-adjust: exact;
				print-color-adjust: exact;
			}
		}
		/* Filters Bar */
		.filters-bar{display:flex;flex-wrap:wrap;gap:.5rem;align-items:flex-end;margin-bottom:.5rem;background:#fff;padding:.6rem .65rem;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.08);} .filters-bar .form-group{display:flex;flex-direction:column;gap:.25rem;} .filters-bar label{font-size:.6rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:#555;} .filters-bar input,.filters-bar select{padding:.4rem .55rem;font-size:.7rem;border:1px solid #d0d7de;border-radius:6px;min-width:160px;background:#fff;} .filters-bar input:focus,.filters-bar select:focus{outline:2px solid var(--secondary-color);outline-offset:0;border-color:var(--secondary-color);}
		/* Table */
		.board-card{background:#fff;border-radius:10px;padding:.65rem .75rem;box-shadow:0 1px 3px rgba(0,0,0,.08);display:flex;flex-direction:column;flex:1;min-height:0;}
		.table-wrapper{overflow:auto;flex:1;}
		table{width:100%;border-collapse:collapse;font-size:.7rem;} 
		thead th{position:sticky;top:0;background:#f5f6f9;z-index:2;font-weight:600;text-align:left;padding:.45rem .55rem;border-bottom:1px solid #e3e6eb;font-size:.65rem;letter-spacing:.4px;text-transform:uppercase;color:#555;} 
		tbody td{padding:.45rem .55rem;border-bottom:1px solid #f0f1f3;vertical-align:middle;line-height:1.25;} 
		tbody tr:hover{background:#f9fbfe;} 
		tbody tr:last-child td{border-bottom:none;}
		/* Hide specific columns we still want hidden: Approver, Property Removal, To be Returned, Actions (shifted +1 for checkbox column) */
		.board-card table thead th:nth-child(4), .board-card table tbody td:nth-child(4), /* Approver */
		.board-card table thead th:nth-child(11), .board-card table tbody td:nth-child(11), /* Property Removal */
		.board-card table thead th:nth-child(12), .board-card table tbody td:nth-child(12), /* To be Returned */
		.board-card table thead th:nth-child(13), .board-card table tbody td:nth-child(13) /* Actions */
		{ display: none; }
		.badge{display:inline-block;padding:.22rem .5rem;border-radius:14px;font-size:.55rem;font-weight:600;letter-spacing:.4px;position:relative;top:-1px;} .badge-status-submitted{background:#e6f0fe;color:#1d4ed8;} .badge-status-updated{background:#f3e8ff;color:#6d28d9;} .badge-status-approved{background:#e6f9ef;color:#1e8449;} .badge-status-rejected{background:#ffe7e6;color:#c0392b;}
		.actions{display:flex;gap:.3rem;} .btn{padding:.35rem .55rem;border:none;border-radius:5px;font-size:.6rem;font-weight:500;display:inline-flex;align-items:center;gap:.35rem;cursor:pointer;line-height:1;transition:background .2s,box-shadow .2s;} .btn-view{background:#ecf5ff;color:#1b6fbf;} .btn-view:hover{background:#d9ecff;} .btn-edit{background:#e9f7ef;color:#1e824c;} .btn-edit:hover{background:#d5f2e0;}
		.empty-state{padding:2rem 1rem;text-align:center;color:#666;font-size:.75rem;}
		/* Row click */
		tbody tr.clickable-row{cursor:pointer;}
		tbody tr.clickable-row:active{background:#eef5ff;}
		/* Batch selection */
		.batch-checkbox{width:16px;height:16px;cursor:pointer;accent-color:var(--primary-color);}
		.batch-action-bar{display:none;align-items:center;gap:12px;padding:10px 16px;background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;margin-bottom:12px;}
		.batch-action-bar.visible{display:flex;}
		.batch-action-bar .selected-count{font-size:.75rem;font-weight:600;color:#92400e;}
		.batch-action-bar .batch-btn{padding:6px 12px;border:none;border-radius:6px;font-size:.7rem;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:all .2s;}
		.batch-action-bar .batch-btn-delete{background:#ef4444;color:#fff;}
		.batch-action-bar .batch-btn-delete:hover{background:#dc2626;}
		.batch-action-bar .batch-btn-cancel{background:#e5e7eb;color:#374151;}
		.batch-action-bar .batch-btn-cancel:hover{background:#d1d5db;}
		tbody tr.selected{background:#fef9c3 !important;}
		/* Column Filter Styles */
		.column-filter-header{position:relative;cursor:pointer;}
		.column-filter-header:hover{background:#f3f4f6;}
		.column-filter-header.filter-active{color:var(--primary-color);font-weight:700;}
		.column-filter-dropdown{position:absolute;top:100%;left:0;min-width:150px;max-height:250px;overflow-y:auto;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:100;display:none;padding:6px 0;}
		.column-filter-dropdown.show{display:block;}
		.column-filter-dropdown .filter-option{padding:6px 12px;font-size:.7rem;cursor:pointer;display:flex;align-items:center;gap:6px;}
		.column-filter-dropdown .filter-option:hover{background:#f3f4f6;}
		.column-filter-dropdown .filter-option.selected{background:#e0e7ff;color:#3730a3;}
		.column-filter-dropdown .filter-search{padding:6px 10px;margin:0 6px 6px;border:1px solid #d1d5db;border-radius:4px;font-size:.7rem;width:calc(100% - 12px);box-sizing:border-box;}
		.column-filter-dropdown .filter-clear{padding:6px 12px;font-size:.65rem;color:#6b7280;cursor:pointer;border-top:1px solid #e5e7eb;margin-top:4px;}
		.column-filter-dropdown .filter-clear:hover{background:#f3f4f6;color:#111827;}
		/* Modal Styles - A4 format (matching leave details modal) */
		.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:flex-start;justify-content:center;padding:20px;z-index:2000;overflow-y:auto;}
		.modal-backdrop.hidden{display:none;}
		.modal-panel{background:#f5f6fa;width:100%;max-width:240mm;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.18);display:flex;flex-direction:column;max-height:90vh;}
		.modal-header{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:12px 12px 0 0;}
		.modal-title{font-weight:600;display:flex;align-items:center;gap:6px;font-size:0.9rem;color:#1f2937;}
		.modal-close{background:none;border:none;font-size:1rem;cursor:pointer;color:#64748b;padding:.35rem;border-radius:6px;}
		.modal-close:hover{background:#f1f5f9;color:#111;}
		.modal-body{padding:18px 20px;overflow-y:auto;display:flex;flex-direction:column;gap:0;font-size:0.75rem;background:#f5f6fa;}
		/* A4-sized document inside modal - matching leave details modal exactly */
		.a4-sheet{position:relative;width:190mm;min-height:auto;margin:0 auto;background:#fff;border:none;border-radius:0;box-shadow:0 2px 8px rgba(0,0,0,0.06);padding:2mm 2mm 18mm;box-sizing:border-box;color:#111827;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4;}
		.a4-header{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:0;page-break-inside:avoid;}
		.company-block{display:flex;flex-direction:column;align-items:flex-start;gap:8px;}
		.a4-logo{width:100px;height:100px;border-radius:8px;object-fit:contain;background:#fff;border:none;display:block;}
		.a4-company h1{margin:0;font-size:1.1rem;line-height:1.2;font-weight:700;}
		.a4-company .doc-title{font-size:.9rem;font-weight:700;margin:2px 0 0;color:#111827;text-align:left;}
		.divider{height:1px;background:#e5e7eb;margin:12px 0 18px;border-radius:1px;}
		.a4-divider{height:1px;background:#e5e7eb;margin:8px 0;}
		.docmeta-row{display:flex;gap:6px;align-items:center;margin:6px 0 12px;font-size:.72rem;color:#111827;}
		.docmeta-label{font-size:.58rem;font-weight:700;color:#6b7280;}
		.docmeta-value{font-size:.72rem;color:#111827;}
		/* Tables - matching leave modal approval table design */
		.a4-info-table{width:100%;border-collapse:collapse;font-size:.66rem;}
		.a4-info-table th{background:var(--primary-color, #2c3e50);font-weight:600;text-transform:none;font-size:.58rem;letter-spacing:.01em;color:#ffffff;padding:6px;border:1px solid var(--primary-color, #2c3e50);text-align:left;}
		.a4-info-table td{padding:6px;border:1px solid #e5e7eb;vertical-align:top;background:#fff;color:#111827;}
		.a4-info-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;}
		.a4-info-item{display:grid;grid-template-columns:max-content 1fr;column-gap:8px;row-gap:2px;}
		.a4-info-item label{font-size:.58rem;font-weight:700;color:#6b7280;}
		.a4-info-item label::after{content:':';margin-left:4px;color:#9ca3af;}
		.a4-info-item span{font-size:.72rem;color:#111827;}
		/* Sections - matching leave modal design */
		.a4-section{margin:4px 0;page-break-inside:avoid;}
		.a4-section-title{font-size:.75rem;margin:0 0 8px;display:flex;align-items:center;gap:8px;font-weight:600;color:#fff;background:var(--primary-color, #2c3e50);padding:6px 10px;border-radius:0;}
		.a4-section-title i{font-size:.8rem;color:#fff;}
		.a4-section-title .section-text{flex:1;}
		/* Status chips - matching leave modal */
		.status-chip{display:inline-block;font-size:.55rem;font-weight:600;letter-spacing:.02em;padding:2px 8px;border-radius:4px;}
		.status-chip.approved{color:#166534;background:#dcfce7;} .status-chip.declined,.status-chip.rejected{color:#991b1b;background:#fee2e2;} .status-chip.pending{color:#92400e;background:#fef3c7;} .status-chip.submitted{color:#1d4ed8;background:#dbeafe;}
		/* Signature and approver styling - matching leave modal */
		.sig-img{max-width:150px;max-height:75px;object-fit:contain;display:block;}
		.sig-stack{display:flex;flex-direction:column;gap:4px;}
		.approver-job{font-size:.55rem;color:#6b7280;display:inline-block;}
		.approver-fullname{font-size:.58rem;color:#1f2937;display:inline-block;font-weight:600;}
		.modal-footer{padding:12px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:.5rem;background:#fff;border-radius:0 0 12px 12px;}
		.btn-small{padding:.4rem .7rem;font-size:.6rem;border:none;border-radius:6px;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:.4rem;}
		.btn-outline{background:#fff;border:1px solid #d1d5db;color:#374151;}
		.btn-outline:hover{background:#f3f4f6;}
		.btn-primary{background:#2563eb;color:#fff;}
		.btn-primary:hover{background:#1d4ed8;}
		/* Status pills */
		.status-pill{display:inline-flex;align-items:center;gap:.3rem;padding:.28rem .55rem;border-radius:20px;font-size:.55rem;font-weight:600;letter-spacing:.4px;background:#f0f2f5;color:#444;cursor:pointer;user-select:none;border:1px solid transparent;}
		.status-pill.active{background:#1d4ed8;color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.12);} .status-pill[data-status="updated"].active{background:#6d28d9;} .status-pill[data-status="approved"].active{background:#1e8449;} .status-pill[data-status="rejected"].active{background:#c0392b;}
		.status-pill[data-status="updated"]{background:#f3e8ff;color:#6d28d9;} .status-pill[data-status="approved"]{background:#e6f9ef;color:#1e8449;} .status-pill[data-status="rejected"]{background:#ffe7e6;color:#c0392b;} .status-pill[data-status="submitted"]{background:#e6f0fe;color:#1d4ed8;}
		.btn-export{background:#e6f5ff;color:#1d6fd8;} .btn-export:hover{background:#d4ecff;}
		.btn-clear{background:#f0f2f5;color:#333;} .btn-clear:hover{background:#e4e6e8;}
		/* Responsive */
		@media (max-width:900px){ .sidebar{position:fixed;z-index:1500;} .main-content{margin-left:0;width:100%;} .top-nav{left:.5rem;} .sidebar.collapsed{transform:translateX(-100%);} }

		/* Settings Tab Styles */
		.settings-section{border:1px solid #e5e7eb;border-radius:8px;margin-bottom:1rem;overflow:hidden;}
		.settings-section h3{font-size:.9rem;font-weight:600;color:#374151;padding:.8rem 1rem;margin:0;cursor:pointer;background:#f9fafb;display:flex;align-items:center;gap:8px;justify-content:space-between;transition:background .2s;}
		.settings-section h3:hover{background:#f3f4f6;}
		.settings-section h3 .toggle-icon{font-size:.7rem;color:#9ca3af;transition:transform .2s;}
		.settings-section.collapsed h3 .toggle-icon{transform:rotate(-90deg);}
		.settings-section-content{padding:1rem;border-top:1px solid #e5e7eb;}
		.settings-section.collapsed .settings-section-content{display:none;}
		.access-control-table{width:100%;border-collapse:collapse;font-size:.75rem;}
		.access-control-table th,.access-control-table td{padding:8px 10px;text-align:left;border-bottom:1px solid #e5e7eb;}
		.access-control-table th{background:#f9fafb;font-weight:600;color:#374151;font-size:.7rem;text-transform:uppercase;letter-spacing:.02em;}
		.access-control-table tbody tr:hover{background:#f9fafb;}
		.access-control-table input[type="checkbox"]{width:16px;height:16px;cursor:pointer;}
		.ac-add-btn{background:var(--primary-color);color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:.75rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
		.ac-add-btn:hover{opacity:.9;}
		.ac-modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:3000;}
		.ac-modal-content{background:#fff;border-radius:12px;width:100%;max-width:450px;box-shadow:0 10px 40px rgba(0,0,0,.2);}
		.ac-modal-header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;}
		.ac-modal-header h3{margin:0;font-size:1rem;color:#111827;display:flex;align-items:center;gap:8px;}
		.ac-modal-close{background:none;border:none;font-size:1.4rem;color:#6b7280;cursor:pointer;}
		.ac-modal-body{padding:20px;}
		.ac-modal-body .form-group{margin-bottom:16px;}
		.ac-modal-body .form-group label{display:block;font-size:.8rem;font-weight:600;color:#374151;margin-bottom:6px;}
		.ac-modal-body .checkbox-group{display:flex;flex-direction:column;gap:8px;}
		.ac-modal-body .checkbox-item{display:flex;align-items:center;gap:8px;font-size:.8rem;color:#374151;}
		.ac-modal-body .checkbox-item input{width:16px;height:16px;}
		.area-chip{transition:all 0.2s ease;}
		.area-chip:hover{border-color:#6366f1 !important;}
		.ac-modal-footer{padding:16px 20px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:10px;}
		.ac-modal-footer .btn{padding:8px 16px;border-radius:6px;font-size:.8rem;font-weight:600;cursor:pointer;}
		.ac-modal-footer .btn-cancel{background:#f3f4f6;border:1px solid #d1d5db;color:#374151;}
		.ac-modal-footer .btn-save{background:var(--primary-color);border:none;color:#fff;}
		.ac-user-autocomplete{position:relative;}
		.ac-user-autocomplete input{width:100%;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:.85rem;}
		.ac-user-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #d1d5db;border-radius:6px;max-height:200px;overflow-y:auto;display:none;z-index:10;box-shadow:0 4px 12px rgba(0,0,0,.1);}
		.ac-user-dropdown .item{padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:.8rem;}
		.ac-user-dropdown .item:hover{background:#f3f4f6;}
		.delete-btn{background:#fee2e2;color:#dc2626;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:.7rem;}
		.delete-btn:hover{background:#fecaca;}

		/* Approval Flow Styles */
		.approval-flow-section {
			background: #f8f9fa;
			border-radius: 8px;
			padding: 1.5rem;
			margin-bottom: 1.5rem;
		}

		.approval-flow-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}


		.approval-flow-title {
			color: #007bff;
			font-weight: 700;
			margin: 0;
			font-size: 1rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.approval-flow-status {
			font-size: 0.8rem;
			padding: 0.25rem 0.75rem;
			border-radius: 12px;
			font-weight: 600;
			text-transform: uppercase;
		}

		.approval-flow-status.enabled {
			background: #d4edda;
			color: #155724;
		}

		.approval-flow-status.disabled {
			background: #f8d7da;
			color: #721c24;
		}

		.approval-flow-status.pending {
			background: #fff3cd;
			color: #856404;
		}

		.approval-flow-status.approved {
			background: #d4edda;
			color: #155724;
		}

		.approval-flow-status.rejected {
			background: #f8d7da;
			color: #721c24;
		}

		.approval-stages {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}

		.approval-stage {
			display: flex;
			align-items: center;
			gap: 1rem;
			padding: 1rem;
			background: white;
			border-radius: 8px;
			border: 1px solid #e9ecef;
			position: relative;
		}

		.approval-stage:not(:last-child)::after {
			content: '';
			position: absolute;
			bottom: -0.5rem;
			left: 25px;
			width: 2px;
			height: 0.5rem;
			background: #dee2e6;
		}

		.stage-number {
			width: 35px;
			height: 35px;
			background: #007bff;
			color: white;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 600;
			font-size: 0.9rem;
			flex-shrink: 0;
		}

		.stage-number.completed {
			background: #28a745;
		}

		.stage-number.pending {
			background: #ffc107;
			color: #000;
		}

		.stage-number.rejected {
			background: #dc3545;
		}

		.stage-info {
			flex: 1;
		}

		.stage-title {
			font-weight: 600;
			color: #495057;
			margin-bottom: 0.25rem;
			font-size: 0.9rem;
		}

		.approver-title {
			font-size: 0.8rem;
			color: #6c757d;
			font-style: italic;
			margin-bottom: 0.25rem;
		}

		.approver-info {
			margin-bottom: 0.25rem;
		}

		.approver-name {
			color: #007bff;
			font-weight: 500;
			font-size: 0.85rem;
		}

		.stage-timestamp {
			color: #6c757d;
			font-size: 0.75rem;
		}

		.stage-comments {
			margin-top: 0.5rem;
			padding: 0.5rem;
			background: #f8f9fa;
			border-radius: 4px;
			font-size: 0.8rem;
			color: #495057;
		}

		/* Sequential Approval - Locked State */
		.approval-stage.locked {
			opacity: 0.6;
		}

		.approval-stage.locked .stage-number {
			background: #e9ecef;
			color: #6c757d;
			border-color: #dee2e6;
		}

		.approval-stage.locked .stage-status-text {
			color: #6c757d;
			font-style: italic;
		}

		.stage-number.locked {
			background: #e9ecef !important;
			color: #6c757d !important;
			border-color: #dee2e6 !important;
		}

		.stage-status-text.locked {
			color: #6c757d !important;
			font-weight: normal !important;
		}

		/* Approval History Display Styles */
		.actual-approver-info {
			margin-top: 0.5rem !important;
			padding: 0.5rem !important;
			background: #f8f9fa !important;
			border-radius: 4px !important;
			border-left: 3px solid #28a745 !important;
			font-size: 0.85rem !important;
		}

		.actual-approver-info.rejected {
			border-left-color: #dc3545 !important;
		}

		.actual-approver-info > div:first-child {
			font-weight: 600;
			color: #28a745;
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		.actual-approver-info.rejected > div:first-child {
			color: #dc3545;
		}

		.actual-approver-info .fas {
			font-size: 0.8rem;
		}

		.actual-approver-info div[style*="color: #666"] {
			font-size: 0.8rem !important;
			color: #666 !important;
			margin-top: 0.25rem !important;
		}

		.actual-approver-info div[style*="color: #999"] {
			font-size: 0.75rem !important;
			color: #999 !important;
			margin-top: 0.25rem !important;
		}

		.actual-approver-info div[style*="margin-top: 0.5rem"] {
			margin-top: 0.5rem !important;
			padding: 0.5rem !important;
			background: #d4edda !important;
			border-radius: 3px !important;
			font-size: 0.8rem !important;
		}

		.actual-approver-info.rejected div[style*="margin-top: 0.5rem"] {
			background: #f8d7da !important;
		}

		.stage-comments {
			margin-top: 0.5rem;
			padding: 0.5rem;
			background: #f8f9fa;
			border-radius: 4px;
			font-size: 0.8rem;
			color: #495057;
		}

		.stage-comments strong {
			color: #333;
		}

		.no-approval-flow {
			text-align: center;
			padding: 2rem;
			color: #6c757d;
		}

		.no-approval-flow i {
			font-size: 2rem;
			margin-bottom: 0.5rem;
			color: #dee2e6;
		}

		.approval-flow-loading {
			text-align: center;
			padding: 1rem;
			color: #6c757d;
		}

		.approval-flow-error {
			text-align: center;
			padding: 1rem;
			color: #dc3545;
			background: #f8d7da;
			border-radius: 4px;
		}

		/* Modal Footer Action Buttons */
		   .modal-footer {
			   padding: 1rem 1.5rem;
			   border-top: 1px solid rgba(0, 0, 0, 0.08);
			   display: flex;
			   gap: 0.85rem;
			   align-items: center;
			   flex-wrap: wrap;
			   justify-content: flex-end;
			   background: rgba(255, 255, 255, 0.95);
			   position: sticky;
			   bottom: 0;
			   z-index: 2;
			   box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.03);
		   }

		   .modal-footer .btn {
			   padding: 0.4rem;
			   border-radius: 6px;
			   width: 2.25rem;
			   height: 2.25rem;
			   font-size: 0.875rem;
			   font-weight: 500;
			   display: inline-flex;
			   align-items: center;
			   justify-content: center;
			   gap: 0.375rem;
			   transition: all 0.2s ease;
			   border: none;
			   cursor: pointer;
			   min-width: 2.5rem;
			   min-height: 2.5rem;
			   background: transparent;
			   color: inherit;
			   box-shadow: none;
		   }

		   .modal-footer .btn i {
			   font-size: 0.875rem;
		   }

		   .modal-footer .btn-secondary,
		   .modal-footer .btn-warning,
		   .modal-footer .btn-success,
		   .modal-footer .btn-danger,
		   .modal-footer .btn-info,
		   .modal-footer .btn-primary {
			   background: transparent !important;
			   color: inherit;
			   border: none;
			   box-shadow: none;
		   }

		   .modal-footer .btn-secondary:hover,
		   .modal-footer .btn-warning:hover,
		   .modal-footer .btn-success:hover,
		   .modal-footer .btn-danger:hover,
		   .modal-footer .btn-info:hover,
		   .modal-footer .btn-primary:hover {
			   background: #f3f4f6 !important;
			   color: #2563eb;
			   border: none;
			   transform: translateY(-1px);
			   box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
		   }
	</style>
</head>
<body>
	<div class="app-container">
		<!-- Sidebar: align exactly with access.html menu structure -->
		<nav class="sidebar menu-loading" id="sideNav">
			<div class="logo">
				<h2>Dreamex Datalab</h2>
			</div>
			<ul class="menu" id="roleBasedMenu">
				<li class="menu-item" data-feature="home_view" data-requires-permission="home_view">
					<a href="index.html"><i class="fas fa-home"></i> Home</a>
				</li>
				<li class="menu-dropdown" data-feature="health_view" data-requires-permission="health_view">
					<a href="#"><i class="fas fa-medkit"></i> Health</a>
					<ul class="submenu">
						<li data-feature="health_assessment_view" data-requires-permission="health_assessment_view"><a href="health-assessment.html">Assessment</a></li>
						<li data-feature="health_consultation_view" data-requires-permission="health_consultation_view"><a href="health-consultation.html">Consultation</a></li>
						<li data-feature="medical_folder_view" data-requires-permission="medical_folder_view"><a href="medical-folder.html">Medical Folder</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="safety_view" data-requires-permission="safety_view">
					<a href="#"><i class="fas fa-shield-alt"></i> Safety</a>
					<ul class="submenu">
						<li data-feature="training_view" data-requires-permission="training_view"><a href="trainingboard.html">Training</a></li>
						<li data-feature="risk_view" data-requires-permission="risk_view"><a href="riskboard.html">Risk Management</a></li>
						<li data-feature="jsa_view" data-requires-permission="jsa_view"><a href="jsaboard.html">Job Safety Analysis</a></li>
						<li data-feature="ptw_view" data-requires-permission="ptw_view"><a href="ptwboard.html">Permit to Work</a></li>
						<li data-feature="incident_view" data-requires-permission="incident_view"><a href="incidentboard.html">Incident Reports</a></li>
						<li data-feature="inspection_view" data-requires-permission="inspection_view"><a href="inspectionboard.html">Inspection</a></li>
						<li data-feature="audit_view" data-requires-permission="audit_view"><a href="auditboard.html">Audit</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="fuel_management" data-requires-permission="fuel_management">
					<a href="#"><i class="fas fa-gas-pump"></i> Fuel Management</a>
					<ul class="submenu">
						<li data-feature="vessel_offloading" data-requires-permission="vessel_offloading"><a href="vessel-offloading.html">Vessel Offloading</a></li>
						<li data-feature="fuel_storage" data-requires-permission="fuel_storage"><a href="fuelstor.html">Fuel Storage Status</a></li>
						<li data-feature="tank_transfer" data-requires-permission="tank_transfer"><a href="fueltrans.html">Tank-to-Tank Transfer</a></li>
						<li data-feature="truck_loading" data-requires-permission="truck_loading"><a href="fuel-truck-loading.html">Fuel Truck Loading</a></li>
						<li data-feature="quality_analysis" data-requires-permission="quality_analysis"><a href="fuel-quality-analysis.html">Fuel Quality Analysis</a></li>
							<li data-feature="fuel_distribution" data-requires-permission="fuel_distribution"><a href="fueldist.html">Fuel Distribution</a></li>
						<li data-feature="fuel_consumption_analysis" data-requires-permission="fuel_consumption_analysis"><a href="fuelanalys.html">Consumption Analysis</a></li>
						<li data-feature="fuel_daily_report" data-requires-permission="fuel_daily_report"><a href="fueldaily.html">Daily Fuel Report</a></li>
					</ul>
				</li>
				<!-- Workspaces: Catering -->
				<li class="menu-dropdown" data-feature="catering_view" data-requires-permission="catering_view">
					<a href="#"><i class="fas fa-utensils"></i> Workspaces â€” Catering</a>
					<ul class="submenu">
						<li data-feature="catering_manage_types" data-requires-permission="catering_manage_types"><a href="catering-meal-types.html"><i class="fas fa-list"></i> Meal Types</a></li>
						<li data-feature="catering_assign" data-requires-permission="catering_assign"><a href="catering-eligibility.html"><i class="fas fa-user-check"></i> Eligibility & Assign</a></li>
						<li data-feature="catering_consumption_manual" data-requires-permission="catering_consumption_manual"><a href="catering-consumption.html"><i class="fas fa-keyboard"></i> Consumption (Manual)</a></li>
						<li data-feature="catering_consumption_nfc" data-requires-permission="catering_consumption_nfc"><a href="catering-consumption.html#nfc"><i class="fas fa-id-card"></i> Consumption (NFC)</a></li>
						<li data-feature="catering_reports" data-requires-permission="catering_reports"><a href="catering-reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="environment_view" data-requires-permission="environment_view">
					<a href="#"><i class="fas fa-leaf"></i> Environment</a>
					<ul class="submenu">
						<li data-feature="water_view" data-requires-permission="water_view"><a href="waterboard.html">Water Quality</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="security_view" data-requires-permission="security_view">
					<a href="#"><i class="fas fa-lock"></i> Security</a>
					<ul class="submenu">
						<li data-feature="access_view" data-requires-permission="access_view"><a href="access.html">Gate Pass</a></li>
						<li data-feature="access_daily_view" data-requires-permission="access_daily_view"><a href="accessdaily.html">Daily Gate Pass Control</a></li>
						<li data-feature="removal_view" data-requires-permission="removal_view"><a href="removalboard.html">Property Removal</a></li>
						<li data-feature="security_level_evaluation_view" data-requires-permission="security_level_evaluation_view"><a href="seclevel.html">Security Level Evaluation</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="logistics_view" data-requires-permission="logistics_view">
					<a href="#"><i class="fas fa-truck"></i> Logistics</a>
					<ul class="submenu">
						<li data-feature="fleet_view" data-requires-permission="fleet_view"><a href="fleet.html">Fleet Management</a></li>
						<li data-feature="travel_view" data-requires-permission="travel_view"><a href="travel.html">Travel Requests</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="accommodation_view" data-requires-permission="accommodation_view">
					<a href="#"><i class="fas fa-bed"></i> Accommodation</a>
					<ul class="submenu">
						<li data-feature="camp_view" data-requires-permission="camp_view"><a href="camp.html">Camp Management</a></li>
						<li data-feature="camp_settings_view" data-requires-permission="camp_settings_view"><a href="campset.html">Camp Settings</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="hr_view" data-requires-permission="hr_view">
					<a href="#"><i class="fas fa-users"></i> HR</a>
					<ul class="submenu">
						<li data-feature="human_hr_view" data-requires-permission="human_hr_view"><a href="human-hr.html"><i class="fas fa-user-tie"></i> Human HR</a></li>
						<li data-feature="staff_management_view" data-requires-permission="staff_management_view"><a href="staff.html">Staffing</a></li>
						<li data-feature="authority_to_recruit_view" data-requires-permission="authority_to_recruit_view"><a href="recruit.html">Authority to Recruit</a></li>
						<li data-feature="job_advertising_view" data-requires-permission="job_advertising_view"><a href="jobpost.html">Job Advertising</a></li>
						<li data-feature="screening_view" data-requires-permission="screening_view"><a href="jobscreen.html">Screening</a></li>
						<li data-feature="interview_view" data-requires-permission="interview_view"><a href="interview.html">Interview</a></li>
						<li data-feature="offer_view" data-requires-permission="offer_view"><a href="offer.html">Offer Management</a></li>
						<li data-feature="contract_view" data-requires-permission="contract_view"><a href="contract.html">Contract Management</a></li>
						<li data-feature="onboarding_view" data-requires-permission="onboarding_view"><a href="onboard.html">Onboarding</a></li>
						<li data-feature="chart_view" data-requires-permission="chart_view"><a href="chart.html">Chart Setup</a></li>
						<li data-feature="chartboard_view" data-requires-permission="chartboard_view"><a href="chartboard.html">Org Chart</a></li>
						<li data-feature="kpi_dashboard_view" data-requires-permission="kpi_dashboard_view"><a href="kpi.html">KPI</a></li>
						<li data-feature="action_plan_view" data-requires-permission="action_plan_view"><a href="actionplan.html"><i class="fas fa-tasks"></i> Action Plan Board</a></li>
					</ul>
				</li>
				<li class="menu-dropdown" data-feature="project_management_section">
					<a href="#"><i class="fas fa-project-diagram"></i> Project Management</a>
					<ul class="submenu">
						<li data-feature="project_dashboard_view" data-requires-permission="project_dashboard_view"><a href="project-dashboard.html">Project Dashboard</a></li>
						<li data-feature="project_create_view" data-requires-permission="project_create_view"><a href="project-create.html">Create Project</a></li>
						<li data-feature="project_list_view" data-requires-permission="project_list_view"><a href="project-list.html">Project List</a></li>
						<li data-feature="project_reports_view" data-requires-permission="project_reports_view"><a href="project-reports.html">Project Reports</a></li>
					</ul>
				</li>
				<li data-feature="communication_view" data-requires-permission="communication_view"><a href="info.html"><i class="fas fa-comments"></i> Communication</a></li>
				<li class="menu-dropdown" data-feature="settings_view" data-requires-permission="settings_view">
					<a href="#"><i class="fas fa-cog"></i> Settings</a>
					<ul class="submenu">
						<li data-feature="account_settings_view" data-requires-permission="account_settings_view"><a href="account.html">Account Settings</a></li>
						<li data-feature="company_management_view" data-requires-permission="company_management_view"><a href="companymanagement.html">Company Management</a></li>
						<li data-feature="approval_settings_view" data-requires-permission="approval_settings_view"><a href="approval-settings.html">Approval Flow Settings</a></li>
						<li data-feature="field_setup_view" data-requires-permission="field_setup_view"><a href="fieldsetup.html">Field Setup</a></li>
						<li data-feature="preferences_view" data-requires-permission="preferences_view"><a href="preferences.html">Preferences</a></li>
						<li data-feature="notification_settings_view" data-requires-permission="notification_settings_view"><a href="notification-settings.html">Notification Settings</a></li>
						<li data-feature="audit_log_view" data-requires-permission="audit_log_view"><a href="auditlog.html"><i class="fas fa-history"></i> Audit Log</a></li>
						<li data-feature="user_management_view" data-requires-permission="user_management_view"><a href="users.html">User & Role Management</a></li>
						<li data-feature="role_permissions_view" data-requires-permission="role_permissions_view"><a href="roles.html">Role Permissions</a></li>
					</ul>
				</li>
			</ul>
		</nav>
		<!-- Main Content -->
		<main class="main-content">
			<header class="top-nav">
				<div class="top-nav-left">
					<button id="sidebarToggle" class="sidebar-toggle-btn" title="Toggle menu"><i class="fas fa-bars"></i></button>
					<img id="headerCompanyLogo" alt="Company Logo">
					<span id="headerCompanyName"></span>
				</div>
				<div class="top-nav-right">
					<div class="notifications">
						<button id="notificationBtn" class="notification-btn" aria-label="Notifications"><i class="fas fa-bell"></i><span class="notification-badge" style="display:none;">0</span></button>
						<div class="notification-dropdown">
							<div class="notification-header">
								<h3><i class="fas fa-bell" style="margin-right: 6px; color: #3498db;"></i>Notifications</h3>
								<div>
									<button class="mark-all-read">Mark all as read</button>
									<button class="clear-all-notifications">Clear all</button>
								</div>
							</div>
							<div class="notification-list" id="notificationList">
								<!-- Empty state -->
								<div class="notification-empty" id="notificationEmpty">
									<i class="fas fa-bell-slash"></i>
									<div class="notification-empty-title">No notifications</div>
									<div class="notification-empty-message">You're all caught up!</div>
								</div>
							</div>
						</div>
					</div>
					<div class="user-profile">
						<button id="userProfileBtn" class="profile-btn" aria-label="Profile">
							<img id="userAvatarImg" src="" alt="User Avatar" style="display: none;">
							<div id="userInitials" class="avatar-initials">U</div>
						</button>
						<div class="profile-dropdown"><ul></ul></div>
					</div>
				</div>
			</header>
			<div style="padding-top:3.4rem;"></div>
			<div class="page-header">
				<div style="display: flex; align-items: center; gap: 0.6rem;">
					<i class="fas fa-lock"></i>
					<span>Gate Pass Requests Board</span>
				</div>
				<button type="button" class="btn-add-new" onclick="window.location.href='access.html'" title="Add New Gate Pass Request">
					<i class="fas fa-plus"></i>
				</button>
			</div>
			<!-- Tab Navigation -->
			<div class="tab-nav" style="display:flex;align-items:center;gap:10px;">
				<div style="display:flex;gap:0;">
					<button class="tab-btn active" data-tab="boardTab" style="display:none;"><i class="fas fa-table"></i> Board</button>
					<button class="tab-btn" data-tab="settingsTab" style="display:none;"><i class="fas fa-cog"></i> Settings</button>
				</div>
			</div>

			<!-- Board Tab Content -->
			<div class="tab-content active" id="boardTab">
			<!-- Table -->
			<section class="board-card">
				<div id="boardSummary" style="font-size:.6rem;font-weight:600;color:#555;display:flex;flex-wrap:wrap;gap:1rem;padding:.15rem .1rem .5rem .1rem;"></div>
				<!-- Batch Action Bar -->
				<div class="batch-action-bar" id="batchActionBar">
					<span class="selected-count"><span id="selectedCount">0</span> selected</span>
					<button class="batch-btn batch-btn-delete" onclick="window.accessBoardManager?.batchDelete()"><i class="fas fa-trash"></i> Delete Selected</button>
					<button class="batch-btn batch-btn-cancel" onclick="window.accessBoardManager?.clearSelection()"><i class="fas fa-times"></i> Cancel</button>
				</div>
				<div class="table-wrapper">
						<table aria-label="Gate Pass Requests Table">
						<thead>
							<tr>
								<th style="width:30px;text-align:center;display:none;"><input type="checkbox" class="batch-checkbox" id="selectAllCheckbox" title="Select all" onclick="window.accessBoardManager?.toggleSelectAll(this)"></th>
								<th>Ref #</th>
								<th class="column-filter-header" data-column="requester" onclick="window.accessBoardManager?.toggleColumnFilter(event, 'requester')">Requester
									<div class="column-filter-dropdown" id="filter-requester"></div>
								</th>
								<th class="column-filter-header" data-column="approver" onclick="window.accessBoardManager?.toggleColumnFilter(event, 'approver')">Approver
									<div class="column-filter-dropdown" id="filter-approver"></div>
								</th>
								<th class="column-filter-header" data-column="department" onclick="window.accessBoardManager?.toggleColumnFilter(event, 'department')">Department
									<div class="column-filter-dropdown" id="filter-department"></div>
								</th>
								<th class="column-filter-header" data-column="company" onclick="window.accessBoardManager?.toggleColumnFilter(event, 'company')">Company
									<div class="column-filter-dropdown" id="filter-company"></div>
								</th>
								<th class="column-filter-header" data-column="area" onclick="window.accessBoardManager?.toggleColumnFilter(event, 'area')">Area
									<div class="column-filter-dropdown" id="filter-area"></div>
								</th>
								<th>Start</th>
								<th>End</th>
								<th class="column-filter-header" data-column="status" onclick="window.accessBoardManager?.toggleColumnFilter(event, 'status')">Status
									<div class="column-filter-dropdown" id="filter-status"></div>
								</th>
								<th>Property Removal</th>
								<th>To be Returned</th>
								<th>Actions</th>
							</tr>
						</thead>
							<tbody id="accessTableBody">
								<tr><td colspan="13" class="empty-state">Loading gate pass requests...</td></tr>
						</tbody>
					</table>
				</div>
			</section>
				</div>

				<!-- Settings Tab Content -->
				<div class="tab-content" id="settingsTab">
					<div class="card" style="padding:1.2rem">
						<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid #e5e7eb;">
							<h2 style="margin:0;color:var(--primary-color);font-size:1.2rem;display:flex;align-items:center;gap:8px;">
								<i class="fas fa-cog"></i> Settings
							</h2>
						</div>

						<!-- Access Control Section -->
						<div class="settings-section">
							<h3 onclick="toggleSettingsSection(this)"><i class="fas fa-user-shield"></i> Access Control <i class="fas fa-chevron-down toggle-icon"></i></h3>
							<div class="settings-section-content">
								<p style="font-size:.75rem;color:#6b7280;margin-bottom:.8rem">Control which users can view all gate pass requests (regardless of creator) and access the Settings tab.</p>
								<div style="margin-bottom:.8rem">
									<button type="button" class="ac-add-btn" onclick="openAccessControlModal()"><i class="fas fa-plus"></i> Add User</button>
								</div>
								<div style="overflow-x:auto">
									<table class="access-control-table" id="accessControlTable">
										<thead>
											<tr>
												<th>User</th>
												<th>Email</th>
												<th>Job Title</th>
												<th style="text-align:center">View All Requests</th>
												<th style="display:none;">Allowed Areas</th>
												<th style="display:none;text-align:center">Settings Tab</th>
												<th style="text-align:center">Actions</th>
											</tr>
										</thead>
										<tbody id="accessControlTableBody">
											<tr><td colspan="5" style="text-align:center;color:#9ca3af">Loading...</td></tr>
										</tbody>
									</table>
								</div>
							</div>
						</div>
					</div>
				</div>
		</main>
	</div>

	<!-- Access Control Modal -->
	<div class="ac-modal" id="accessControlModal" style="display:none;">
		<div class="ac-modal-content">
			<div class="ac-modal-header">
				<h3><i class="fas fa-user-shield"></i> <span id="acModalTitle">Add User Access</span></h3>
				<button class="ac-modal-close" onclick="closeAccessControlModal()">&times;</button>
			</div>
			<div class="ac-modal-body">
				<div class="form-group" id="acUserSelectGroup">
					<label>Select User</label>
					<div class="ac-user-autocomplete">
						<input id="acUserInput" type="text" placeholder="Type to search employee..." autocomplete="off" />
						<input id="acUserId" type="hidden" />
						<div id="acUserDropdown" class="ac-user-dropdown"></div>
					</div>
				</div>
				<div class="form-group" id="acUserDisplayGroup" style="display:none;">
					<label>User</label>
					<div id="acUserDisplay" style="padding:10px;background:#f3f4f6;border-radius:8px;font-size:.85rem;color:#111827;"></div>
				</div>
				<div class="form-group">
					<label>Permissions</label>
					<div class="checkbox-group">
						<label class="checkbox-item">
							<input type="checkbox" id="acViewAll" checked>
							View All Requests (regardless of creator)
						</label>
						<label class="checkbox-item">
							<input type="checkbox" id="acSettingsTab">
							Settings Tab Access
						</label>
						<label class="checkbox-item">
							<input type="checkbox" id="acBatchActions">
							Batch Actions (select rows)
						</label>
						<label class="checkbox-item">
							<input type="checkbox" id="acReleaseButton">
							Release Button (release gate pass for approval)
						</label>
					</div>
				</div>
				<div class="form-group" id="acAreasGroup">
					<label>Restrict to Specific Areas <span style="font-weight:normal;color:#6b7280;font-size:.75rem;">(leave empty for all areas)</span></label>
					<div id="acAreasContainer" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;"></div>
				</div>
			</div>
			<div class="ac-modal-footer">
				<button class="btn btn-cancel" onclick="closeAccessControlModal()">Cancel</button>
				<button class="btn btn-save" id="acSaveBtn" onclick="saveAccessControl()">Add</button>
			</div>
		</div>
	</div>

	<!-- Edit Areas Modal -->
	<div id="editAreasModal" class="ac-modal" style="display:none;">
		<div class="ac-modal-content" style="max-width:500px;">
			<div class="ac-modal-header">
				<h3><i class="fas fa-map-marker-alt" style="color:#6366f1;"></i> Edit Allowed Areas</h3>
				<button class="ac-modal-close" onclick="closeEditAreasModal()">&times;</button>
			</div>
			<div class="ac-modal-body">
				<div style="margin-bottom:16px;padding:10px;background:#f3f4f6;border-radius:8px;">
					<span style="font-size:.75rem;color:#6b7280;">Editing areas for:</span>
					<strong id="editAreasUserName" style="display:block;font-size:.85rem;color:#111827;margin-top:2px;">User</strong>
				</div>
				<div class="form-group">
					<label>Allowed Areas <span style="font-weight:normal;color:#6b7280;font-size:.75rem;">(leave empty for all areas)</span></label>
					<div id="editAreasContainer" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;"></div>
					<div style="margin-top:8px;display:flex;gap:6px;">
						<input type="text" id="editNewAreaInput" placeholder="Add custom area..." style="flex:1;padding:6px 10px;border:1px solid #d1d5db;border-radius:6px;font-size:.8rem;">
						<button type="button" onclick="addCustomAreaForEdit()" style="padding:6px 12px;background:var(--primary-color);color:#fff;border:none;border-radius:6px;font-size:.75rem;cursor:pointer;"><i class="fas fa-plus"></i> Add</button>
					</div>
				</div>
			</div>
			<div class="ac-modal-footer">
				<button class="btn btn-cancel" onclick="closeEditAreasModal()">Cancel</button>
				<button class="btn btn-save" onclick="saveEditedAreas()">Save</button>
			</div>
		</div>
	</div>

		<!-- Access Details Modal -->
		<div id="accessDetailsModal" class="modal-backdrop hidden" aria-hidden="true" role="dialog" aria-modal="true">
			<div class="modal-panel" role="document">
				<div class="modal-header">
					<div class="modal-title"><i class="fas fa-id-badge"></i><span id="modalTitle">Gate Pass Request</span></div>
					<button class="modal-close" type="button" aria-label="Close" id="modalCloseBtn"><i class="fas fa-times"></i></button>
				</div>
				<div class="modal-body" id="modalBody">
					<!-- dynamic content -->
				</div>
				<div class="modal-footer">
					<button type="button" class="btn-small btn-outline" id="modalCloseFooter">Close</button>
					<button type="button" class="btn-small btn-primary" id="modalEditBtn" style="display:none;"><i class="fas fa-edit"></i> Edit</button>
				</div>
			</div>
		</div>

	<!-- Utility: Sidebar persistence -->
	<script>
		function toggleSidebar(){
			const sb=document.querySelector('.sidebar');
			const mc=document.querySelector('.main-content');
			const top=document.querySelector('.top-nav');
			if(!sb||!mc)return;
			const collapsed=sb.classList.toggle('collapsed');
			mc.classList.toggle('sidebar-collapsed',collapsed);
			if(top){ top.style.left= collapsed? '.5rem': 'calc(var(--sidebar-width) + .5rem)'; }
			localStorage.setItem('sidebarCollapsed',collapsed);
		}
		function restoreSidebarState(){
			const collapsed=localStorage.getItem('sidebarCollapsed')==='true';
			const sb=document.querySelector('.sidebar');
			const mc=document.querySelector('.main-content');
			const top=document.querySelector('.top-nav');
			if(collapsed && sb && mc){ sb.classList.add('collapsed'); mc.classList.add('sidebar-collapsed'); if(top){top.style.left='.5rem';} }
		}
		document.addEventListener('DOMContentLoaded',()=>{
			restoreSidebarState();
			document.getElementById('sidebarToggle')?.addEventListener('click',toggleSidebar);
		});

		// ===== SETTINGS TAB FUNCTIONS =====
		function toggleSettingsSection(header) {
			const section = header.parentElement;
			section.classList.toggle('collapsed');
		}

		// ===== ACCESS CONTROL FUNCTIONS =====
		let accessControlCache = { users: {}, perms: {} };

		async function loadAccessControl() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			try {
				const [usersSnap, permsSnap] = await Promise.all([
					firebase.database().ref(`companies/${user.companyId}/users`).once('value'),
					firebase.database().ref(`companies/${user.companyId}/accessSettings/accessControl`).once('value')
				]);
				accessControlCache.users = usersSnap.val() || {};
				accessControlCache.perms = permsSnap.val() || {};
				renderAccessControlTable(accessControlCache.users, accessControlCache.perms);
			} catch (error) {
				console.error('Error loading access control:', error);
			}
		}

		function renderAccessControlTable(users, perms) {
			const tbody = document.getElementById('accessControlTableBody');
			if (!tbody) return;

			const permUserIds = Object.keys(perms || {});

			if (permUserIds.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#9ca3af">No users configured. Click "Add User" to add access control.</td></tr>';
				return;
			}

			tbody.innerHTML = permUserIds.map(uid => {
				const u = users[uid] || {};
				const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
				const email = (u.accountType === 'without-account' || u.reportingOnly === true) ? '-' : (u.email || '-');
				const jobTitle = u.jobTitle || u.position || '-';
				const p = perms[uid] || {};
				const allowedAreas = p.allowedAreas || [];
				const areasDisplay = allowedAreas.length > 0 
					? allowedAreas.map(a => `<span style="background:#e0e7ff;color:#3730a3;padding:2px 6px;border-radius:4px;font-size:.7rem;margin:1px;">${escapeHtmlAC(a)}</span>`).join(' ')
					: '<span style="color:#9ca3af;font-size:.75rem;">All areas</span>';

				return `
					<tr onclick="openAccessControlModal('${uid}')" style="cursor:pointer;" title="Click to edit">
						<td>${escapeHtmlAC(name)}</td>
						<td>${escapeHtmlAC(email)}</td>
						<td>${escapeHtmlAC(jobTitle)}</td>
						<td style="text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="viewAll" ${p.canViewAll ? 'checked' : ''} onchange="updateAccessPerm(this)"></td>
						<td style="display:none;max-width:200px;" onclick="event.stopPropagation();">
							<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
								${areasDisplay}
							</div>
						</td>
						<td style="display:none;text-align:center" onclick="event.stopPropagation();"><input type="checkbox" data-uid="${uid}" data-perm="settings" ${p.canSeeSettingsTab ? 'checked' : ''} onchange="updateAccessPerm(this)"></td>
						<td style="text-align:center" onclick="event.stopPropagation();"><button class="delete-btn" onclick="removeAccessUser('${uid}')" title="Remove user"><i class="fas fa-trash"></i></button></td>
					</tr>
				`;
			}).join('');
		}

		function escapeHtmlAC(str) {
			if (!str) return '';
			return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c] || c));
		}

		async function updateAccessPerm(checkbox) {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			const uid = checkbox.dataset.uid;
			const perm = checkbox.dataset.perm;
			const update = {};

			if (perm === 'viewAll') update.canViewAll = checkbox.checked;
			if (perm === 'settings') update.canSeeSettingsTab = checkbox.checked;

			try {
				await firebase.database().ref(`companies/${user.companyId}/accessSettings/accessControl/${uid}`).update(update);
				
				// Update local cache
				if (!accessControlCache.perms[uid]) accessControlCache.perms[uid] = {};
				Object.assign(accessControlCache.perms[uid], update);
				
				// Apply changes immediately if it's the current user
				if (uid === user.id || uid === user.uid) {
					applyAccessTabVisibility();
				}

				window.notificationManager?.addNotification({ type: 'success', message: 'Access updated' });
			} catch (error) {
				console.error('Failed to update access:', error);
				window.notificationManager?.addNotification({ type: 'error', message: 'Failed to update access' });
				checkbox.checked = !checkbox.checked;
			}
		}

		async function removeAccessUser(uid) {
			if (!confirm('Remove this user from access control?')) return;

			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			try {
				await firebase.database().ref(`companies/${user.companyId}/accessSettings/accessControl/${uid}`).remove();
				loadAccessControl();
				window.notificationManager?.addNotification({ type: 'success', message: 'User removed from access control' });
			} catch (error) {
				console.error('Failed to remove user:', error);
				window.notificationManager?.addNotification({ type: 'error', message: 'Failed to remove user' });
			}
		}

		// Track if we're in edit mode
		let editingAccessControlUid = null;

		function openAccessControlModal(editUid = null) {
			editingAccessControlUid = editUid;
			
			const modal = document.getElementById('accessControlModal');
			const input = document.getElementById('acUserInput');
			const hidden = document.getElementById('acUserId');
			const dropdown = document.getElementById('acUserDropdown');
			const modalTitle = document.getElementById('acModalTitle');
			const saveBtn = document.getElementById('acSaveBtn');
			const userSelectGroup = document.getElementById('acUserSelectGroup');
			const userDisplayGroup = document.getElementById('acUserDisplayGroup');
			const userDisplay = document.getElementById('acUserDisplay');

			if (input) input.value = '';
			if (hidden) hidden.value = '';
			if (dropdown) dropdown.innerHTML = '';

			const { users, perms } = accessControlCache;
			
			if (editUid) {
				// Edit mode
				const u = users[editUid] || {};
				const p = perms[editUid] || {};
				const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || '(No name)';
				const jobTitle = u.jobTitle || u.position || '';
				
				if (modalTitle) modalTitle.textContent = 'Edit User Access';
				if (saveBtn) saveBtn.textContent = 'Save';
				if (userSelectGroup) userSelectGroup.style.display = 'none';
				if (userDisplayGroup) userDisplayGroup.style.display = 'block';
				if (userDisplay) userDisplay.innerHTML = `<strong>${escapeHtmlAC(name)}</strong>${jobTitle ? `<br><span style="font-size:.75rem;color:#6b7280;">${escapeHtmlAC(jobTitle)}</span>` : ''}`;
				if (hidden) hidden.value = editUid;
				
				// Set current permissions
				document.getElementById('acViewAll').checked = p.canViewAll === true;
				document.getElementById('acSettingsTab').checked = p.canSeeSettingsTab === true;
				document.getElementById('acBatchActions').checked = p.canSeeBatchActions === true;
				document.getElementById('acReleaseButton').checked = p.canSeeReleaseButton === true;
				
				// Populate area checkboxes with current selections
				populateAreaCheckboxes(p.allowedAreas || []);
			} else {
				// Add mode
				if (modalTitle) modalTitle.textContent = 'Add User Access';
				if (saveBtn) saveBtn.textContent = 'Add';
				if (userSelectGroup) userSelectGroup.style.display = 'block';
				if (userDisplayGroup) userDisplayGroup.style.display = 'none';
				
				document.getElementById('acViewAll').checked = true;
				document.getElementById('acSettingsTab').checked = false;
				document.getElementById('acBatchActions').checked = false;
				document.getElementById('acReleaseButton').checked = false;
				
				// Populate area checkboxes (empty selection)
				populateAreaCheckboxes([]);
			}
			
			const existingUids = new Set(Object.keys(perms || {}));
			const baseList = Object.entries(users || {}).filter(([uid]) => !existingUids.has(uid)).map(([uid, u]) => {
				const name = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || u.email || uid;
				const jobTitle = u.jobTitle || u.position || '';
				return { uid, name, jobTitle };
			});

			function renderList(items) {
				if (!dropdown) return;
				if (!items || items.length === 0) {
					dropdown.innerHTML = '<div class="item" style="color:#9ca3af;">No users found</div>';
					dropdown.style.display = 'block';
					return;
				}
				dropdown.innerHTML = items.slice(0, 50).map(it => {
					const right = it.jobTitle ? `<span style="color:#6b7280;font-size:.75rem;">${escapeHtmlAC(it.jobTitle)}</span>` : '';
					return `<div class="item" data-uid="${it.uid}"><span>${escapeHtmlAC(it.name)}</span>${right}</div>`;
				}).join('');
				dropdown.style.display = 'block';
			}

			function filterList(q) {
				const qq = (q || '').trim().toLowerCase();
				if (!qq) { renderList(baseList); return; }
				const res = baseList.filter(it =>
					it.name.toLowerCase().includes(qq) || (it.jobTitle || '').toLowerCase().includes(qq)
				);
				renderList(res);
			}

			if (input && !input._acBound) {
				input._acBound = true;
				input.addEventListener('input', () => filterList(input.value));
				input.addEventListener('focus', () => filterList(input.value));
				document.addEventListener('click', (e) => {
					if (!dropdown) return;
					const container = dropdown.parentElement;
					if (!container.contains(e.target)) dropdown.style.display = 'none';
				});
				if (dropdown) {
					dropdown.addEventListener('click', (e) => {
						const item = e.target.closest('.item');
						if (!item) return;
						const uid = item.getAttribute('data-uid');
						const name = item.querySelector('span')?.textContent || '';
						if (hidden) hidden.value = uid;
						if (input) input.value = name;
						dropdown.style.display = 'none';
					});
				}
			}

			modal.style.display = 'flex';
		}

		// Global variable to track selected areas in modal
		let selectedAreasInModal = new Set();

		function populateAreaCheckboxes(initialSelected = []) {
			const container = document.getElementById('acAreasContainer');
			if (!container) return;

			// Get unique areas from existing requests (check both request-level and visitors)
			const uniqueAreas = new Set();
			const allRequests = window.accessBoardManager?.allRequests || [];
			allRequests.forEach(r => {
				if (r.area) uniqueAreas.add(r.area);
				// Also check visitor areas
				if (Array.isArray(r.visitors)) {
					r.visitors.forEach(v => {
						if (v.area) uniqueAreas.add(v.area);
					});
				}
			});
			
			// Also add any initially selected areas (in case they're not in current requests)
			initialSelected.forEach(a => uniqueAreas.add(a));

			selectedAreasInModal.clear();
			initialSelected.forEach(a => selectedAreasInModal.add(a));
			
			// Sort areas alphabetically
			const sortedAreas = Array.from(uniqueAreas).sort((a, b) => a.localeCompare(b));
			
			if (sortedAreas.length === 0) {
				container.innerHTML = '<span style="color:#9ca3af;font-size:.75rem;">No areas found in existing requests. Add custom areas below.</span>';
				return;
			}

			container.innerHTML = sortedAreas.map(area => {
				const isSelected = initialSelected.some(a => a.toLowerCase() === area.toLowerCase());
				return `
				<label class="area-chip" style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid ${isSelected ? '#6366f1' : '#d1d5db'};border-radius:20px;font-size:.75rem;cursor:pointer;background:${isSelected ? '#e0e7ff' : '#fff'};transition:all 0.2s;">
					<input type="checkbox" value="${escapeHtmlAC(area)}" onchange="toggleAreaSelection(this)" style="margin:0;" ${isSelected ? 'checked' : ''}>
					${escapeHtmlAC(area)}
				</label>
			`;
			}).join('');
		}

		function toggleAreaSelection(checkbox) {
			if (checkbox.checked) {
				selectedAreasInModal.add(checkbox.value);
				checkbox.parentElement.style.background = '#e0e7ff';
				checkbox.parentElement.style.borderColor = '#6366f1';
			} else {
				selectedAreasInModal.delete(checkbox.value);
				checkbox.parentElement.style.background = '#fff';
				checkbox.parentElement.style.borderColor = '#d1d5db';
			}
		}

		function addCustomArea() {
			const input = document.getElementById('acNewAreaInput');
			if (!input) return;
			
			const area = input.value.trim();
			if (!area) {
				alert('Please enter an area name');
				return;
			}

			// Check if already exists
			const container = document.getElementById('acAreasContainer');
			const existingInputs = container.querySelectorAll('input[type="checkbox"]');
			for (const cb of existingInputs) {
				if (cb.value.toLowerCase() === area.toLowerCase()) {
					alert('This area already exists');
					input.value = '';
					return;
				}
			}

			// Clear the "no areas found" message if present
			if (container.querySelector('span')) {
				container.innerHTML = '';
			}

			// Add new area chip
			const label = document.createElement('label');
			label.className = 'area-chip';
			label.style.cssText = 'display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid #6366f1;border-radius:20px;font-size:.75rem;cursor:pointer;background:#e0e7ff;transition:all 0.2s;';
			label.innerHTML = `<input type="checkbox" value="${escapeHtmlAC(area)}" onchange="toggleAreaSelection(this)" style="margin:0;" checked>${escapeHtmlAC(area)}`;
			container.appendChild(label);

			selectedAreasInModal.add(area);
			input.value = '';
		}

		// Edit allowed areas for an existing user
		let editingAreasForUid = null;
		
		function editUserAreas(uid) {
			editingAreasForUid = uid;
			const { users, perms } = accessControlCache;
			const u = users[uid] || {};
			const p = perms[uid] || {};
			const currentAreas = p.allowedAreas || [];
			const userName = u.name || `${u.firstName || ''} ${u.lastName || ''}`.trim() || 'User';
			
			// Update modal title
			document.getElementById('editAreasUserName').textContent = userName;
			
			// Populate area checkboxes
			const container = document.getElementById('editAreasContainer');
			if (!container) return;

			// Get unique areas from existing requests (check both request-level and visitors)
			const uniqueAreas = new Set();
			const allRequests = window.accessBoardManager?.allRequests || [];
			allRequests.forEach(r => {
				if (r.area) uniqueAreas.add(r.area);
				// Also check visitor areas
				if (Array.isArray(r.visitors)) {
					r.visitors.forEach(v => {
						if (v.area) uniqueAreas.add(v.area);
					});
				}
			});
			
			// Also add any areas the user already has (in case they're not in current requests)
			currentAreas.forEach(a => uniqueAreas.add(a));

			selectedAreasInModal.clear();
			currentAreas.forEach(a => selectedAreasInModal.add(a));
			
			// Sort areas alphabetically
			const sortedAreas = Array.from(uniqueAreas).sort((a, b) => a.localeCompare(b));
			
			if (sortedAreas.length === 0) {
				container.innerHTML = '<span style="color:#9ca3af;font-size:.75rem;">No areas found. Add custom areas below.</span>';
			} else {
				container.innerHTML = sortedAreas.map(area => {
					const isSelected = currentAreas.some(a => a.toLowerCase() === area.toLowerCase());
					return `
						<label class="area-chip" style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid ${isSelected ? '#6366f1' : '#d1d5db'};border-radius:20px;font-size:.75rem;cursor:pointer;background:${isSelected ? '#e0e7ff' : '#fff'};transition:all 0.2s;">
							<input type="checkbox" value="${escapeHtmlAC(area)}" onchange="toggleAreaSelection(this)" style="margin:0;" ${isSelected ? 'checked' : ''}>
							${escapeHtmlAC(area)}
						</label>
					`;
				}).join('');
			}

			document.getElementById('editAreasModal').style.display = 'flex';
		}

		function closeEditAreasModal() {
			document.getElementById('editAreasModal').style.display = 'none';
			editingAreasForUid = null;
		}

		function addCustomAreaForEdit() {
			const input = document.getElementById('editNewAreaInput');
			if (!input) return;
			
			const area = input.value.trim();
			if (!area) {
				alert('Please enter an area name');
				return;
			}

			const container = document.getElementById('editAreasContainer');
			const existingInputs = container.querySelectorAll('input[type="checkbox"]');
			for (const cb of existingInputs) {
				if (cb.value.toLowerCase() === area.toLowerCase()) {
					alert('This area already exists');
					input.value = '';
					return;
				}
			}

			// Clear the "no areas found" message if present
			const noAreasSpan = container.querySelector('span');
			if (noAreasSpan && noAreasSpan.textContent.includes('No areas')) {
				container.innerHTML = '';
			}

			const label = document.createElement('label');
			label.className = 'area-chip';
			label.style.cssText = 'display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid #6366f1;border-radius:20px;font-size:.75rem;cursor:pointer;background:#e0e7ff;transition:all 0.2s;';
			label.innerHTML = `<input type="checkbox" value="${escapeHtmlAC(area)}" onchange="toggleAreaSelection(this)" style="margin:0;" checked>${escapeHtmlAC(area)}`;
			container.appendChild(label);

			selectedAreasInModal.add(area);
			input.value = '';
		}

		async function saveEditedAreas() {
			if (!editingAreasForUid) return;
			
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			const allowedAreas = Array.from(selectedAreasInModal);
			
			try {
				const update = {};
				if (allowedAreas.length > 0) {
					update.allowedAreas = allowedAreas;
				} else {
					// Remove allowed areas (user sees all areas)
					update.allowedAreas = null;
				}
				
				await firebase.database().ref(`companies/${user.companyId}/accessSettings/accessControl/${editingAreasForUid}`).update(update);
				
				// Update local cache
				if (accessControlCache.perms[editingAreasForUid]) {
					if (allowedAreas.length > 0) {
						accessControlCache.perms[editingAreasForUid].allowedAreas = allowedAreas;
					} else {
						delete accessControlCache.perms[editingAreasForUid].allowedAreas;
					}
				}
				
				closeEditAreasModal();
				loadAccessControl();
				window.notificationManager?.addNotification({ type: 'success', message: 'Allowed areas updated' });
			} catch (error) {
				console.error('Failed to update areas:', error);
				window.notificationManager?.addNotification({ type: 'error', message: 'Failed to update areas' });
			}
		}

		function closeAccessControlModal() {
			document.getElementById('accessControlModal').style.display = 'none';
			editingAccessControlUid = null;
		}

		async function saveAccessControl() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return;

			const uid = (document.getElementById('acUserId')?.value || '').trim();
			if (!uid) {
				alert('Please select a user');
				return;
			}

			const canViewAll = document.getElementById('acViewAll').checked;
			const canSeeSettingsTab = document.getElementById('acSettingsTab').checked;
			const canSeeBatchActions = document.getElementById('acBatchActions').checked;
			const canSeeReleaseButton = document.getElementById('acReleaseButton').checked;
			const allowedAreas = Array.from(selectedAreasInModal);
			const isEditMode = editingAccessControlUid !== null;

			try {
				const data = {
					canViewAll,
					canSeeSettingsTab,
					canSeeBatchActions,
					canSeeReleaseButton
				};
				
				// Only save allowedAreas if there are any selected
				if (allowedAreas.length > 0) {
					data.allowedAreas = allowedAreas;
				}

				await firebase.database().ref(`companies/${user.companyId}/accessSettings/accessControl/${uid}`).set(data);

				closeAccessControlModal();
				loadAccessControl();
				window.notificationManager?.addNotification({ type: 'success', message: isEditMode ? 'User access updated' : 'User added to access control' });
			} catch (error) {
				console.error('Failed to save access control:', error);
				window.notificationManager?.addNotification({ type: 'error', message: isEditMode ? 'Failed to update user' : 'Failed to add user' });
			}
		}

		async function applyAccessTabVisibility() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) {
				const boardBtn = document.querySelector('.tab-btn[data-tab="boardTab"]');
				const settingsBtn = document.querySelector('.tab-btn[data-tab="settingsTab"]');
				if (boardBtn) {
					boardBtn.style.display = '';
					boardBtn.classList.add('tab-authorized');
				}
				if (settingsBtn) settingsBtn.style.display = 'none'; // Hide by default
				// Hide batch actions by default
				applyBatchActionsVisibility(false);
				return;
			}

			try {
				const snap = await firebase.database().ref(`companies/${user.companyId}/accessSettings/accessControl/${user.id || user.uid}`).once('value');
				const p = snap.val();

				const boardBtn = document.querySelector('.tab-btn[data-tab="boardTab"]');
				const settingsBtn = document.querySelector('.tab-btn[data-tab="settingsTab"]');
				const settingsTab = document.getElementById('settingsTab');

				// Board tab - always visible
				if (boardBtn) {
					boardBtn.style.display = '';
					boardBtn.classList.add('tab-authorized');
				}

				// Settings tab - default HIDE unless explicitly allowed (canSeeSettingsTab === true)
				// If no permission record exists (p is null), hide the tab by default
				const allowSettings = p && p.canSeeSettingsTab === true;
				if (settingsBtn) {
					if (allowSettings) {
						settingsBtn.style.display = '';
						settingsBtn.classList.add('tab-authorized');
					} else {
						settingsBtn.style.display = 'none';
						settingsBtn.classList.remove('tab-authorized');
					}
				}
				if (settingsTab && !allowSettings) settingsTab.classList.remove('active');

				// Batch actions - default HIDE unless explicitly allowed (canSeeBatchActions === true)
				const allowBatch = p && p.canSeeBatchActions === true;
				applyBatchActionsVisibility(allowBatch);

				// Store release button permission globally for modal button checks
				window._canSeeReleaseButton = p && p.canSeeReleaseButton === true;

				// Store release button permission globally for modal button checks
				window._canSeeReleaseButton = p && p.canSeeReleaseButton === true;

				// If current active tab is hidden, switch to board
				const activeTab = document.querySelector('.tab-btn.active');
				if (activeTab && activeTab.style.display === 'none') {
					const boardTabBtn = document.querySelector('.tab-btn[data-tab="boardTab"]');
					if (boardTabBtn) boardTabBtn.click();
				}
			} catch (error) {
				console.error('Error applying tab visibility:', error);
				const boardBtn = document.querySelector('.tab-btn[data-tab="boardTab"]');
				const settingsBtn = document.querySelector('.tab-btn[data-tab="settingsTab"]');
				if (boardBtn) {
					boardBtn.style.display = '';
					boardBtn.classList.add('tab-authorized');
				}
				if (settingsBtn) settingsBtn.style.display = 'none'; // Hide by default on error
				applyBatchActionsVisibility(false); // Hide batch actions on error
			}
		}

		// Show/hide batch actions checkbox column
		function applyBatchActionsVisibility(show) {
			// Store permission for render function
			window._canSeeBatchActions = show;
			
			// Header checkbox column
			const headerCheckbox = document.getElementById('selectAllCheckbox');
			const headerTh = headerCheckbox?.closest('th');
			if (headerTh) headerTh.style.display = show ? '' : 'none';
			
			// All row checkboxes
			document.querySelectorAll('#accessTableBody .row-checkbox').forEach(cb => {
				const td = cb.closest('td');
				if (td) td.style.display = show ? '' : 'none';
			});
			
			// Hide batch action bar if no permission
			const batchBar = document.getElementById('batchActionBar');
			if (batchBar && !show) {
				batchBar.classList.remove('show');
			}
		}

		async function checkUserCanViewAll() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return false;
			
			try {
				const snap = await firebase.database().ref(`companies/${user.companyId}/accessSettings/accessControl/${user.id || user.uid}`).once('value');
				const p = snap.val() || {};
				return p.canViewAll === true;
			} catch (error) {
				console.error('Error checking view all permission:', error);
				return false;
			}
		}

		async function getUserAccessControlSettings() {
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) return null;
			
			try {
				const snap = await firebase.database().ref(`companies/${user.companyId}/accessSettings/accessControl/${user.id || user.uid}`).once('value');
				return snap.val() || {};
			} catch (error) {
				console.error('Error getting access control settings:', error);
				return {};
			}
		}
		// ===== END ACCESS CONTROL FUNCTIONS =====
	</script>
	<!-- Core Logic -->
	<script>
	/**************** Firebase Initialization ****************/ (function(){ const firebaseConfig={ apiKey:"AIzaSyCUTmTn0rRBb0M-UkQJxnUMrWqXYU_BgIc", authDomain:"users-8be65.firebaseapp.com", databaseURL:"https://users-8be65-default-rtdb.firebaseio.com", projectId:"users-8be65", storageBucket:"users-8be65.firebasestorage.app", messagingSenderId:"829083030831", appId:"1:829083030831:web:36a370e62691e560bc3dda" }; if(!window.firebase?.apps?.length){ firebase.initializeApp(firebaseConfig); console.log('âœ… Firebase initialized (accessboard)'); } window.db=firebase.database(); window.auth=firebase.auth(); window.storage=firebase.storage(); })();

	/**************** Notification Manager (Firebase-backed) ****************/
    class NotificationManager{
      constructor(){
        this.db = firebase.database();
        this.notifications = [];
        this.settings = this.loadSettings();
        this.userId = null;
        this.fbRef = null;
        this.initialize();
      }
      initialize(){
        if(document.readyState==='loading'){
          document.addEventListener('DOMContentLoaded',()=>this.setup());
        } else { this.setup(); }
      }
      setup(){
        this.bindUI();
        this.tryAttachFirebase();
        this.startBadgeTimer();
        document.addEventListener('storage',e=>{ if(e.key==='currentUser'){ this.tryAttachFirebase(true); }});
      }
      bindUI(){
        const btn=document.getElementById('notificationBtn'); if(btn){btn.onclick=()=>{document.querySelector('.notification-dropdown')?.classList.toggle('show');};}
        const mark=document.querySelector('.mark-all-read'); if(mark){mark.onclick=()=>this.markAllAsRead();}
        document.addEventListener('click',e=>{ if(!e.target.closest('.notifications')) document.querySelector('.notification-dropdown')?.classList.remove('show'); });
      }
      loadSettings(){ const d={emailNotifications:true,notifySubmitter:true,notifyApprovers:true,notifyOnComplete:true,systemUpdates:true,securityAlerts:true,notificationDisplay:'30',showReadNotifications:true}; try{return JSON.parse(localStorage.getItem('notificationSettings'))||d;}catch{return d;} }
      tryAttachFirebase(force=false){
        const uid = window.authManager?.currentUser?.uid || firebase.auth().currentUser?.uid;
        if(!uid){ this.renderNotifications(); this.updateNotificationBadge(); return; }
        if(this.userId===uid && !force){ return; }
        this.userId = uid;
        if(this.fbRef){ this.fbRef.off(); }
        this.fbRef = this.db.ref(`notifications/${uid}`);
        this.fbRef.on('value', snap=>{
          const list=[]; if(snap.exists()){
            snap.forEach(cs=>{ const v=cs.val(); if(v){ list.push(v); }});
          }
          // Sort by timestamp desc
          list.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));
          this.notifications = list;
          this.renderNotifications();
          this.updateNotificationBadge();
        });
      } markAllAsRead(){ if(!this.userId){ return; } const updates={}; this.notifications.forEach(n=>{ if(!n.read){ updates[`notifications/${this.userId}/${n.id}/read`]=true; }}); if(Object.keys(updates).length){ this.db.ref().update(updates).catch(()=>{}); } }
      updateNotificationBadge(){ const badge=document.querySelector('.notification-badge'); if(!badge) return; const unread=this.notifications.filter(n=>!n.read).length; if(unread<=0){ badge.style.display='none'; badge.textContent=''; } else { badge.style.display='inline-block'; badge.textContent = unread>99? '99+': String(unread); } }
      renderNotifications(){ const list=document.querySelector('.notification-list'); if(!list) return; list.innerHTML=''; const days=parseInt(this.settings.notificationDisplay); const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-days);
        const filtered=this.notifications.filter(n=>{ const ts=n.timestamp? new Date(n.timestamp): null; const inRange = ts? (ts>cutoff): true; return inRange && (this.settings.showReadNotifications || !n.read); });
        if(filtered.length===0){ list.innerHTML='<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>'; return; }
        filtered.slice(0,50).forEach(n=>{
          const el=document.createElement('div'); el.className='notification-item '+(n.read?'read':'unread'); const date=n.timestamp? new Date(n.timestamp): new Date(); const timeAgo=this.getTimeAgo(date);
          const title = n.title || (n.type || 'Notification');
          el.innerHTML=`
            <div class="notification-icon ${this.getNotificationIconClass(n.type)}">
              <i class="fas ${this.getNotificationIcon(n.type)}"></i>
            </div>
            <div class="notification-content">
              <div class="notification-title">${this.escapeHtml(title)}</div>
              <div class="notification-message">${this.escapeHtml(n.message||'')}</div>
              <div class="notification-time">${timeAgo}</div>
            </div>
            <div class="notification-actions">
              ${!n.read ? '<button class="mark-read-btn" title="Mark as read"><i class="fas fa-check"></i></button>' : ''}
              <button class="delete-notification-btn" title="Delete"><i class="fas fa-trash"></i></button>
            </div>`;
          const markReadBtn = el.querySelector('.mark-read-btn');
          const deleteBtn = el.querySelector('.delete-notification-btn');
          if(markReadBtn){ markReadBtn.onclick=(e)=>{ e.stopPropagation(); this.setRead(n.id,true); }; }
          if(deleteBtn){ deleteBtn.onclick=(e)=>{ e.stopPropagation(); this.deleteNotification(n.id); }; }
          el.onclick=()=>{ if(!n.read){ this.setRead(n.id,true);} if(n.link) location.href=n.link; };
          list.appendChild(el);
        });
      }
        
        getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return Math.floor(diffInSeconds / 60) + 'm ago';
            if (diffInSeconds < 86400) return Math.floor(diffInSeconds / 3600) + 'h ago';
            if (diffInSeconds < 604800) return Math.floor(diffInSeconds / 86400) + 'd ago';
            return date.toLocaleDateString();
		}
        
		getNotificationIconClass(type) {
            switch ((type || '').toLowerCase()) {
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'error': return 'error';
                case 'info': return 'info';
                default: return 'info';
            }
		}

		getNotificationIcon(type) {
            switch ((type || '').toLowerCase()) {
                case 'success': return 'fa-check-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'error': return 'fa-exclamation-circle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-bell';
            }
		}
		escapeHtml(str){ if(str===undefined||str===null) return ''; return String(str).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
		startBadgeTimer(){ setInterval(()=>this.updateNotificationBadge(),30000); }
		setRead(id,val){ if(!this.userId||!id) return; this.db.ref(`notifications/${this.userId}/${id}/read`).set(!!val).catch(()=>{}); }
		deleteNotification(id){ if(!this.userId||!id) return; this.db.ref(`notifications/${this.userId}/${id}`).remove().catch(()=>{}); }
		async createNotification(recipientUserId,data){ try{ const id=data?.id||Date.now().toString(); const payload={ id, title:data?.title||'Notification', message:data?.message||'', type:data?.type||'info', read:false, timestamp:Date.now(), createdAt:new Date().toISOString(), createdBy: window.authManager?.currentUser?.uid || firebase.auth().currentUser?.uid || 'system', createdByName: window.authManager?.getUserDisplayName?.() || 'System', companyId: window.authManager?.currentUser?.companyId || null, relatedData: data?.relatedData||null, link: data?.link||'' }; await this.db.ref(`notifications/${recipientUserId}/${id}`).set(payload); return true; }catch(e){ console.error('createNotification failed',e); return false; } }
	  }
	  window.notificationManager=new NotificationManager();

	/**************** AuthManager (adapted from access.html) ****************/ class AuthManager{ constructor(){ this.currentUser=this.getCurrentUser(); this.currentCompany=null; console.log('ðŸ” AuthManager(init) accessboard'); this.initializeAuth(); }
		getCurrentUser(){ try{return JSON.parse(localStorage.getItem('currentUser')||'null');}catch{return null;} }
		setCurrentUser(u){ localStorage.setItem('currentUser',JSON.stringify(u)); localStorage.setItem('user',JSON.stringify(u)); this.currentUser=u; }
		async logout(){ try{ await firebase.auth().signOut(); }catch(e){ console.warn('Logout error',e);} ['currentUser','user'].forEach(k=>{localStorage.removeItem(k);sessionStorage.removeItem(k);}); location.href='index.html'; }
		initializeAuth(){ 
			if(!this.currentUser){ 
				console.warn('No user -> redirect login'); 
				location.href='login.html'; 
				return; 
			} 
			console.log('âœ… User:',this.currentUser.email); 
			
			// Test Firebase Storage
			this.testFirebaseStorage();
			
			// Initialize approval configuration
			this.initializeApprovalConfiguration();
			
			this.loadUserRole(this.currentUser); 
			this.loadUserCompany(); 
			this.updateUIForAuthenticatedUser(); 
			this.updateMenuVisibility(); 
			this.bindProfileDropdown(); 
		}
		bindProfileDropdown(){ const btn=document.getElementById('userProfileBtn'); const dd=document.querySelector('.profile-dropdown'); if(btn && dd){ btn.addEventListener('click',e=>{e.stopPropagation(); dd.classList.toggle('show');}); document.addEventListener('click',e=>{ if(!btn.contains(e.target)) dd.classList.remove('show');}); const logoutLink=dd.querySelector('a[href="#"]:has(.fa-sign-out-alt)')||dd.querySelector('.fa-sign-out-alt')?.closest('a'); if(logoutLink){ logoutLink.addEventListener('click',e=>{e.preventDefault(); this.logout();}); } } }
		resetMenuVisibility(){ document.querySelectorAll('[data-feature]').forEach(i=>i.classList.remove('menu-visible')); document.querySelectorAll('.menu-dropdown').forEach(d=>d.classList.remove('menu-visible')); }
		async updateMenuVisibility(){ 
			console.log('ðŸŽ¯ Starting feature-based menu authorization for accessboard.html...');
			const sidebar=document.querySelector('.sidebar'); 
			if(!this.currentUser){ 
				this.resetMenuVisibility(); 
				sidebar?.classList.remove('menu-loading');
				return; 
			} 
			const companyId=this.currentUser.companyId; 
			const userRole=this.currentUser.role; 
			console.log('ðŸ‘¤ User:', this.currentUser.email, 'Company ID:', companyId, 'Role:', userRole);
			if(!companyId){ 
				this.resetMenuVisibility(); 
				sidebar?.classList.remove('menu-loading');
				return; 
			} 
			// STEP 1: Apply company feature-based authorization
			console.log('ðŸ¢ STEP 1: Applying company feature authorization...');
			const authorizedPages = await this.applyFeatureBasedMenuVisibility(companyId);
			
			// STEP 2: Filter by user role permissions within authorized features
			if (userRole && authorizedPages && authorizedPages.length > 0) {
				console.log('ðŸ‘¤ STEP 2: Applying role-based filtering within authorized features...');
				await this.applyRoleBasedFiltering(companyId, userRole, authorizedPages);
			} else {
				console.log('âš ï¸ STEP 2: Skipping role-based filtering (no role found or no authorized pages)');
				sidebar?.classList.remove('menu-loading');
			}
			// Note: Global approver visibility is handled in AccessBoardManager.load().
		}
		async applyFeatureBasedMenuVisibility(companyId){ 
			try{ 
				console.log('ðŸ”§ Applying feature-based menu visibility for company:', companyId);
				const database=firebase.database(); 
				const featuresSnapshot=await database.ref('/platformFeatures').once('value'); 
				if(!featuresSnapshot.exists()){ 
					console.log('âš ï¸ No platform features found');
					this.resetMenuVisibility(); 
					return [];
				} 
				const featuresData=featuresSnapshot.val(); 
				const companySnapshot=await database.ref(`/companies/${companyId}`).once('value'); 
				const companyData=companySnapshot.val(); 
				if(!companyData){ 
					console.error('âŒ Company data not found');
					this.resetMenuVisibility(); 
					return [];
				} 
				const subscribed=companyData.selectedFeatures||[]; 
				console.log('ðŸ¢ Company subscribed features:', subscribed);
				if (subscribed.length === 0) {
					console.log('âš ï¸ Company has no subscribed features');
					this.resetMenuVisibility();
					return [];
				}
				const authorizedPages=[]; 
				subscribed.forEach(fid=>{
					const f=featuresData[fid]; 
					if(f && f.status==='active' && f.authorizedPages) {
						console.log(`ðŸ“¦ Adding pages from feature "${f.name}":`, f.authorizedPages);
						authorizedPages.push(...f.authorizedPages);
					} else {
						console.log(`âš ï¸ Feature ${fid} not found or inactive`);
					}
				}); 
				console.log('ðŸ” All authorized pages from company features:', authorizedPages);
				const authorizedFeatures=new Set(); 
				authorizedPages.forEach(p=>{ 
					if(p.feature) authorizedFeatures.add(p.feature); 
				}); 
				console.log('ðŸŽ¯ Authorized features for accessboard.html:', Array.from(authorizedFeatures));
				this.resetMenuVisibility(); 
				let visibleCount = 0;
				document.querySelectorAll('#roleBasedMenu li[data-feature]').forEach(item=>{ 
					const feature=item.getAttribute('data-feature'); 
					const isDropdownContainer = item.classList.contains('menu-dropdown');
					
					if (isDropdownContainer) {
						return; // Handle dropdowns separately after all items are processed
					}
					
					if(authorizedFeatures.has(feature)){ 
						item.classList.add('menu-visible'); 
						visibleCount++;
						console.log(`âœ… Feature authorized - showing menu item: ${feature}`);
					} else {
						console.log(`âŒ Feature not authorized - hiding menu item: ${feature}`);
					}
				}); 
				// Handle dropdown menus - show if they have visible children
				document.querySelectorAll('#roleBasedMenu li.menu-dropdown').forEach(drop=>{ 
					const feature=drop.getAttribute('data-feature'); 
					const hasVisible=[...drop.querySelectorAll('.submenu li[data-feature]')].some(li=>li.classList.contains('menu-visible')); 
					if(hasVisible || authorizedFeatures.has(feature)) {
						drop.classList.add('menu-visible'); 
						console.log(`âœ… Showing dropdown menu: ${feature} (has visible children or directly authorized)`);
					} else {
						console.log(`âŒ Hiding dropdown menu: ${feature} (no visible children and not authorized)`);
					}
				}); 
				console.log(`ðŸŽ¯ Company feature authorization completed - ${visibleCount} items initially visible`);
				// Return authorized pages for role-based filtering
				return authorizedPages;
			}catch(e){ 
				console.error('âŒ Error applying feature-based menu visibility:', e); 
				this.resetMenuVisibility(); 
				return [];
			} 
		}
		
		// Apply role-based filtering within company authorized features
		async applyRoleBasedFiltering(companyId, userRole, authorizedPages) {
			try {
				console.log('ðŸ‘¤ Applying role-based filtering for role:', userRole);
				
				// Get user role permissions from company
				const database = firebase.database();
				const permissionsRef = database.ref(`companies/${companyId}/roles/${userRole}/permissions`);
				const permissionsSnapshot = await permissionsRef.once('value');
				
				if (!permissionsSnapshot.exists()) {
					console.log(`âš ï¸ No permissions found for role ${userRole} in company ${companyId}`);
					
					// CRITICAL: If user is administrator but no permissions found, provide full access as fallback
					if (userRole === 'administrator') {
						console.log('ðŸ”‘ ADMINISTRATOR FALLBACK - Skipping role filtering (keeping all company features visible)');
						this.showSidebarAfterAuth();
						return;
					}
					
					// For other roles without permissions, hide all items with permission requirements
					console.log('âŒ No valid permissions found - filtering out items requiring permissions');
					this.hideItemsRequiringPermissions();
					this.showSidebarAfterAuth();
					return;
				}
				
				const permissions = permissionsSnapshot.val();
				console.log('âœ… Loaded role permissions:', permissions);
				
				// Apply permission-based filtering
				this.filterMenuByPermissions(permissions);
				
			} catch (error) {
				console.error('âŒ Error applying role-based filtering:', error);
				// Don't hide everything on error - keep company features visible
				this.showSidebarAfterAuth();
			}
		}

		// Filter currently visible menu items by role permissions
		filterMenuByPermissions(permissions) {
			console.log('ðŸ” Filtering visible menu items by role permissions...');
			
			if (!permissions) {
				console.log('âš ï¸ No permissions object provided');
				this.hideItemsRequiringPermissions();
				this.showSidebarAfterAuth();
				return;
			}
			
			// Only check items that are already visible from company features
			const visibleMenuItems = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			console.log(`ðŸŽ¯ Found ${visibleMenuItems.length} visible menu items requiring permissions to check`);
			
			let hiddenCount = 0;
			
			visibleMenuItems.forEach(item => {
				const requiresPermission = item.getAttribute('data-requires-permission');
				const feature = item.getAttribute('data-feature');
				
				if (requiresPermission) {
					const hasPermission = permissions[requiresPermission];
					const hasViewPermission = hasPermission === true || 
											 (hasPermission && hasPermission.view === true);
					
					if (!hasViewPermission) {
						item.classList.remove('menu-visible');
						hiddenCount++;
						console.log(`âŒ Hiding menu item (no permission): ${feature} (requires: ${requiresPermission})`);
					} else {
						console.log(`âœ… Keeping menu item visible: ${feature} (has permission: ${requiresPermission})`);
					}
				}
			});
			
			// Re-check dropdown menus after permission filtering
			const dropdownMenus = document.querySelectorAll('#roleBasedMenu li.menu-dropdown');
			dropdownMenus.forEach(dropdown => {
				const submenuItems = dropdown.querySelectorAll('.submenu li.menu-visible');
				const dropdownFeature = dropdown.getAttribute('data-feature');
				
				if (submenuItems.length === 0) {
					dropdown.classList.remove('menu-visible');
					console.log(`âŒ Hiding dropdown (no visible children): ${dropdownFeature}`);
				} else {
					console.log(`âœ… Keeping dropdown visible (has ${submenuItems.length} visible children): ${dropdownFeature}`);
				}
			});
			
			console.log(`ðŸŽ¯ Role-based filtering completed - ${hiddenCount} items hidden due to lack of permissions`);
			
			// Show sidebar after all filtering is complete
			this.showSidebarAfterAuth();
		}

		// Hide menu items that require permissions (for users without role permissions)
		hideItemsRequiringPermissions() {
			console.log('ðŸ”’ Hiding all menu items that require permissions...');
			
			const itemsRequiringPermissions = document.querySelectorAll('#roleBasedMenu li.menu-visible[data-requires-permission]');
			let hiddenCount = 0;
			
			itemsRequiringPermissions.forEach(item => {
				const feature = item.getAttribute('data-feature');
				const requiresPermission = item.getAttribute('data-requires-permission');
				
				item.classList.remove('menu-visible');
				hiddenCount++;
				console.log(`âŒ Hiding menu item (requires permission): ${feature} (${requiresPermission})`);
			});
			
			console.log(`ðŸ”’ Hidden ${hiddenCount} items requiring permissions`);
		}

		// Show sidebar and remove loading state after authentication and filtering
		showSidebarAfterAuth() {
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
				console.log('âœ… Sidebar loading state removed - menu authorization complete');
			}
		}

		// Emergency fallback menu (basic items only)
		showBasicMenu() {
			console.log('ðŸš¨ Showing basic emergency menu - authorization system failed');
			this.resetMenuVisibility();
			
			// Show only essential menu items
			const essentialItems = [
				'[data-feature="home_view"]',
				'[data-feature="communication_view"]',
				'[data-feature="settings_view"]',
				'[data-feature="account_settings_view"]'
			];
			
			essentialItems.forEach(selector => {
				const item = document.querySelector(`#roleBasedMenu li${selector}`);
				if (item) {
					item.classList.add('menu-visible');
					// Also show parent dropdown if needed
					const parentDropdown = item.closest('.menu-dropdown');
					if (parentDropdown) {
						parentDropdown.classList.add('menu-visible');
					}
				}
			});
			
			const sidebar = document.querySelector('.sidebar');
			if (sidebar) {
				sidebar.classList.remove('menu-loading');
			}
			
			console.log('ðŸš¨ Basic emergency menu displayed');
		}
		
		async loadUserRole(user){ if(user.role||!user.uid) return; try{ const snap=await firebase.database().ref(`users/${user.uid}`).once('value'); if(snap.exists()){ user.role=snap.val().role||'user'; this.setCurrentUser(user);} }catch(e){ console.warn('Role load error',e);} }
		async loadUserCompany(){ 
			if(!this.currentUser) return; 
			try{ 
				const snap=await firebase.database().ref('companies').once('value'); 
				if(!snap.exists()) { 
					this.resetMenuVisibility(); 
					return;
				} 
				const companies=snap.val(); 
				for(const [cid,comp] of Object.entries(companies)){ 
					if(comp.status!=='active') continue; 
					if(comp.users){ 
						for(const [uid,u] of Object.entries(comp.users)){ 
							if(u.authUid===this.currentUser.uid || uid===this.currentUser.uid){ 
								this.currentUser.companyId=cid; 
								this.currentUser.companyName=comp.companyName; 
								this.currentUser.role=u.role || u.userRole || 'user'; // Set user role from company user record
								this.currentCompany=comp; 
								this.setCurrentUser(this.currentUser); 
								console.log('âœ… Found user in company:', cid, 'with role:', this.currentUser.role);
								this.updateCompanyBranding(); 
								await this.updateMenuVisibility(); 
								return; 
							}
						}
					} 
				} 
				this.resetMenuVisibility(); 
			}catch(e){ 
				console.error('Company load error',e); 
				this.resetMenuVisibility(); 
			} 
		}
		updateCompanyBranding(){ if(!this.currentCompany){ this.showFallbackBranding(); return;} const logoEl=document.getElementById('headerCompanyLogo'); const nameEl=document.getElementById('headerCompanyName'); if(nameEl) nameEl.textContent=this.currentCompany.companyName||''; const logoUrl=this.currentCompany.logo||this.currentCompany.logoUrl; if(logoEl){ if(logoUrl){ logoEl.src=logoUrl; logoEl.classList.add('visible'); } else { const svg=this.generateCompanyInitialsSVG(this.getCompanyInitials(this.currentCompany.companyName||'')); logoEl.src=svg; logoEl.classList.add('visible'); }} if(this.currentCompany.branding){ const root=document.documentElement; if(this.currentCompany.branding.primaryColor) root.style.setProperty('--primary-color',this.currentCompany.branding.primaryColor); if(this.currentCompany.branding.secondaryColor) root.style.setProperty('--secondary-color',this.currentCompany.branding.secondaryColor); }}
		showFallbackBranding(){ const logoEl=document.getElementById('headerCompanyLogo'); if(logoEl){ const svg=this.generateCompanyInitialsSVG('DX'); logoEl.src=svg; logoEl.classList.add('visible'); }} getCompanyInitials(name){ if(!name) return 'CO'; const parts=name.trim().split(/\s+/); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return (parts[0][0]+parts[1][0]).toUpperCase(); }
		generateCompanyInitialsSVG(initials){ const svg=`<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg"><rect width="44" height="44" rx="6" fill="#f0f3f6"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="14">${initials}</text></svg>`; return 'data:image/svg+xml;base64,'+btoa(svg); }
		getUserDisplayName(){ if(!this.currentUser) return 'User'; const n=v=> typeof v==='string'? v.trim().replace(/\s+/g,' '):''; const cand=[this.currentUser.displayName,this.currentUser.name,this.currentUser.username]; for(const c of cand){const cleaned=n(c); if(cleaned) return cleaned;} if(this.currentUser.email) return n(this.currentUser.email.split('@')[0])||'User'; return 'User'; }
		// Debug method to test Firebase Storage
		async testFirebaseStorage() {
			console.log('ðŸ§ª Testing Firebase Storage...');
			
			// Check if Firebase Storage is initialized
			try {
				const storage = firebase.storage();
				console.log('âœ… Firebase Storage initialized:', storage);
				
				// Check bucket name
				const bucket = storage.app.options.storageBucket;
				console.log('ðŸª£ Storage bucket:', bucket);
				
				// Test reference creation
				const testRef = storage.ref('test');
				console.log('âœ… Can create storage reference:', testRef);
				
				// Get company ID for testing
				const companyId = this.currentUser?.companyId || 'default';
				console.log('ðŸ¢ Testing with company ID:', companyId);
				
				// Test listing files in company-scoped avatars directory
				try {
					const companyAvatarsRef = storage.ref(`companies/${companyId}/avatars`);
					const list = await companyAvatarsRef.listAll();
					console.log(`ðŸ“ Items in companies/${companyId}/avatars folder:`, list.items.length);
					list.items.forEach(item => {
						console.log('  ðŸ“„', item.fullPath);
					});
				} catch(listError) {
					console.log(`ðŸ“ No company avatars folder or permission issue:`, listError.message);
				}
				
				// Also test global avatars directory as fallback
				try {
					const globalAvatarsRef = storage.ref('avatars');
					const globalList = await globalAvatarsRef.listAll();
					console.log('ðŸ“ Items in global avatars folder:', globalList.items.length);
					globalList.items.forEach(item => {
						console.log('  ðŸ“„', item.fullPath);
					});
				} catch(listError) {
					console.log('ðŸ“ No global avatars folder or permission issue:', listError.message);
				}
				
			} catch(error) {
				console.error('âŒ Firebase Storage error:', error);
			}
		}

		// Initialize default approval configuration for access requests
		async initializeApprovalConfiguration() {
			if (!this.currentUser?.companyId) return;
			
			try {
				const approvalFlowRef = firebase.database().ref(`companies/${this.currentUser.companyId}/approvalFlows/access`);
				const snapshot = await approvalFlowRef.once('value');
				
				if (!snapshot.exists()) {
					console.log('ðŸ”§ Creating default approval configuration for access requests...');
					
					// Define default approval roles - can be customized per company
					const defaultRoles = [
						{ key: "supervisor", text: "Supervisor", function: "function_supervisor" },
						{ key: "manager", text: "Manager", function: "function_manager" },
						{ key: "admin", text: "Administrator", function: "function_admin" },
						{ key: "hr", text: "HR Manager", function: "function_hr" }
					];
					
					const defaultApprovalConfig = {
						enabled: true,
						approvalOrder: "sequential",
						selectedRoles: {
							level1: [{
								value: defaultRoles[0].function,
								text: defaultRoles[0].text,
								updatedAt: Date.now()
							}],
							level2: [{
								value: defaultRoles[1].function,
								text: defaultRoles[1].text,
								updatedAt: Date.now()
							}]
						},
						levels: [
							{
								level: 1,
								approverType: "function",
								value: defaultRoles[0].function
							},
							{
								level: 2,
								approverType: "function",
								value: defaultRoles[1].function
							}
						],
						availableRoles: defaultRoles, // Store available roles for customization
						companyId: this.currentUser.companyId,
						companyName: this.currentUser.companyName,
						lastModifiedAt: new Date().toISOString()
					};
					
					await approvalFlowRef.set(defaultApprovalConfig);
					console.log('âœ… Default approval configuration created for access requests');
				} else {
					console.log('âœ… Approval configuration already exists for access requests');
				}
			} catch (error) {
				console.error('âŒ Error initializing approval configuration:', error);
			}
		}

		getUserInitials(){ const dn=this.getUserDisplayName(); const parts=dn.split(' ').filter(Boolean); if(parts.length===1) return parts[0].substring(0,2).toUpperCase(); return parts.slice(0,2).map(p=>p[0]).join('').toUpperCase(); }
		async getUserAvatarUrl(){ 
			if(!this.currentUser) {
				console.log('getUserAvatarUrl: No current user');
				return null; 
			}
			
			// Get company ID for scoped path
			const companyId = this.currentUser.companyId || 'default';
			console.log('ðŸ¢ Using company ID for avatar path:', companyId);
			
			try{ 
				// Try company-scoped paths first, then fallback to global paths
				const possiblePaths = [
					// Company-scoped paths (preferred)
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.png`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/profile.jpeg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.jpg`,
					`companies/${companyId}/avatars/${this.currentUser.uid}/avatar.png`,
					// Global fallback paths
					`avatars/${this.currentUser.uid}/profile.jpg`,
					`avatars/${this.currentUser.uid}/profile.png`,
					`avatars/${this.currentUser.uid}/avatar.jpg`,
					`avatars/${this.currentUser.uid}/avatar.png`,
					`profiles/${this.currentUser.uid}/profile.jpg`,
					`profiles/${this.currentUser.uid}/profile.png`
				];
				
				for(const path of possiblePaths) {
					try {
						const ref = firebase.storage().ref(path);
						const url = await ref.getDownloadURL();
						console.log(`âœ… Found profile picture at: ${path}`);
						return url;
					} catch(err) {
						console.log(`âŒ No profile picture at: ${path}`);
						continue;
					}
				}
				
				console.log('No profile picture found in any path');
				return null;
			} catch(error) { 
				console.error('Error getting user avatar:', error);
				return null; 
			}
		}
		generateInitialsAvatar(name,img){ const initials=this.getUserInitials(); const colors=['#3498db','#e74c3c','#2ecc71','#f39c12','#9b59b6','#1abc9c']; const bg=colors[name.length%colors.length]; const svg=`<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><circle cx="20" cy="20" r="20" fill="${bg}"/><text x="20" y="25" text-anchor="middle" fill="white" font-size="14" font-weight="600" font-family="Arial, sans-serif">${initials}</text></svg>`; img.src='data:image/svg+xml;base64,'+btoa(svg); img.alt=name+' Avatar'; }
		async updateUIForAuthenticatedUser(){ 
			console.log('ðŸ”„ updateUIForAuthenticatedUser called');
			const btn=document.getElementById('userProfileBtn'); 
			const list=document.querySelector('.profile-dropdown ul'); 
			const userAvatarImg=document.getElementById('userAvatarImg');
			const userInitials=document.getElementById('userInitials');
			
			if(!btn||!list||!this.currentUser) {
				console.log('âŒ Missing elements:', {btn: !!btn, list: !!list, user: !!this.currentUser});
				return; 
			}
			
			const displayName=this.getUserDisplayName(); 
			const email=this.currentUser.email||''; 
			console.log('ðŸ‘¤ User info:', {displayName, email, uid: this.currentUser.uid});
			
			// Set user initials first as fallback
			if(userInitials) {
				userInitials.textContent = this.getUserInitials();
			}
			
			// Try to get avatar URL with detailed logging
			let avatarUrl = null;
			try {
				avatarUrl = await this.getUserAvatarUrl();
				console.log('ðŸ–¼ï¸ Avatar URL result:', avatarUrl);
			} catch(error) {
				console.error('âŒ Error getting avatar URL:', error);
			}
			
			// Update header avatar display
			if(avatarUrl && userAvatarImg) { 
				console.log('âœ… Setting avatar image:', avatarUrl);
				userAvatarImg.src = avatarUrl; 
				userAvatarImg.alt = displayName + ' Avatar';
				userAvatarImg.style.display = 'block';
				if(userInitials) userInitials.style.display = 'none';
				
				// Handle image load error
				userAvatarImg.onerror = () => {
					console.log('âŒ Avatar image failed to load, showing initials');
					userAvatarImg.style.display = 'none';
					if(userInitials) userInitials.style.display = 'flex';
				};
			} else { 
				console.log('ðŸ”¤ No avatar URL, showing initials');
				if(userAvatarImg) userAvatarImg.style.display = 'none';
				if(userInitials) userInitials.style.display = 'flex';
			}
			
			// Update dropdown content
			const avatarHtml= avatarUrl? `<img src="${avatarUrl}" alt="${displayName} Avatar" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">` : `<div style="width:32px;height:32px;border-radius:50%;background:#3498db;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:12px;">${this.getUserInitials()}</div>`; 
			list.innerHTML=`<li style="border-bottom:1px solid #eee;padding:12px 16px;background:#f8f9fa;"><div style="display:flex;align-items:center;gap:12px;">${avatarHtml}<div><div style="font-weight:600;color:#333;font-size:14px;margin-bottom:2px;">${displayName}</div><div style="color:#666;font-size:12px;">${email}</div></div></div></li><li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li><li><a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`; 
			list.querySelector('#logoutLink')?.addEventListener('click',e=>{e.preventDefault(); this.logout();}); 
		}
	}
	window.authManager=new AuthManager();

	/**************** AccessBoard Manager ****************/ class AccessBoardManager{ constructor(){ this.allRequests=[]; // master source
		   this.companyUsersCache = null; // { [uid]: userObj }
		   this.companyUsersCompanyId = null;
		   this.companyUsersLoadedAt = 0;
		   this.accessRequests=this.allRequests; // legacy alias for older code segments
			   this.userFilteredRequests = []; // Only requests created by or assigned as approver to current user
			   this.selectedIds = new Set(); // For batch selection
			   this.columnFilters = {}; // For column header filters
		this.filtered=[]; this.statusPillFilter=''; this.dom={ tbody:document.getElementById('accessTableBody'), search:document.getElementById('searchInput'), status:document.getElementById('statusFilter'), pills:document.getElementById('statusPills'), summary:document.getElementById('boardSummary'), clearBtn:document.getElementById('clearFiltersBtn'), exportBtn:document.getElementById('exportCsvBtn'), batchBar:document.getElementById('batchActionBar'), selectedCount:document.getElementById('selectedCount'), selectAllCb:document.getElementById('selectAllCheckbox') }; this.modal={ root:document.getElementById('accessDetailsModal'), body:document.getElementById('modalBody'), title:document.getElementById('modalTitle'), close:document.getElementById('modalCloseBtn'), closeFooter:document.getElementById('modalCloseFooter'), edit:document.getElementById('modalEditBtn') }; this.attachEvents(); this.renderStatusPills(); this.attachModalHandlers(); this.waitForCompanyThenLoad(); this.initAccessControl(); }
		attachEvents(){ const debounce=(fn,d=250)=>{let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),d);};}; const apply=()=>this.applyFilters(); ['search','status'].forEach(k=>{ if(this.dom[k]) this.dom[k].addEventListener('input',debounce(apply,180)); }); const showAll=document.getElementById('showAllToggle'); if(showAll){ showAll.addEventListener('change',apply);} this.dom.clearBtn?.addEventListener('click',()=>this.clearFilters()); this.dom.exportBtn?.addEventListener('click',()=>this.exportCsv());
			// Close column filter dropdowns when clicking outside
			document.addEventListener('click', (e) => {
				if (!e.target.closest('.column-filter-header')) {
					document.querySelectorAll('.column-filter-dropdown.show').forEach(d => d.classList.remove('show'));
				}
			});
			// Tabs
			document.querySelectorAll('.tab-btn').forEach(btn=>{
				btn.addEventListener('click',()=> this.switchTab(btn.dataset.tab));
			});
		}
		renderStatusPills(){ if(!this.dom.pills) return; this.dom.pills.innerHTML = ""; }
		clearFilters(){ if(this.dom.search) this.dom.search.value=''; if(this.dom.status) this.dom.status.value=''; this.statusPillFilter=''; this.columnFilters = {}; this.updateColumnFilterIcons(); this.dom.pills?.querySelectorAll('.status-pill').forEach(p=>p.classList.remove('active')); this.applyFilters(); }
		
		// Column Filter Methods
		toggleColumnFilter(event, columnName) {
			event.stopPropagation();
			const dropdown = document.getElementById(`filter-${columnName}`);
			if (!dropdown) return;
			
			// Close all other dropdowns first
			document.querySelectorAll('.column-filter-dropdown.show').forEach(d => {
				if (d.id !== `filter-${columnName}`) d.classList.remove('show');
			});
			
			const isOpen = dropdown.classList.contains('show');
			if (isOpen) {
				dropdown.classList.remove('show');
			} else {
				this.populateColumnFilter(columnName);
				dropdown.classList.add('show');
			}
		}
		
		populateColumnFilter(columnName) {
			const dropdown = document.getElementById(`filter-${columnName}`);
			if (!dropdown) return;
			
			// Get unique values from allRequests based on column
			const values = new Set();
			const sourceList = this.allRequests || [];
			
			sourceList.forEach(r => {
				let val = '';
				switch(columnName) {
					case 'requester':
						val = r.requesterName || '';
						break;
					case 'approver':
						val = r.requesterLineManager || this.getApproverDisplayName(r) || '';
						break;
					case 'department':
						val = r.departmentName || '';
						break;
					case 'company':
						val = r.companyName || '';
						break;
					case 'area':
						val = r.visitors?.[0]?.area || r.area || '';
						break;
					case 'status':
						// Use displayStatus logic
						val = (r.isReleased === true && r.status !== 'approved' && r.status !== 'rejected') ? 'released' : (r.status || '');
						break;
				}
				if (val) values.add(val);
			});
			
			const sortedValues = [...values].sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
			const currentFilter = this.columnFilters[columnName] || '';
			
			let html = `<input type="text" class="filter-search" placeholder="Search..." oninput="window.accessBoardManager?.filterColumnOptions(event, '${columnName}')">`;
			html += `<div class="filter-options-list">`;
			sortedValues.forEach(val => {
				const selected = currentFilter === val ? 'selected' : '';
				html += `<div class="filter-option ${selected}" data-value="${this.escape(val)}" onclick="window.accessBoardManager?.applyColumnFilter('${columnName}', '${this.escape(val).replace(/'/g, "\\'")}')">${this.escape(val)}</div>`;
			});
			html += `</div>`;
			if (currentFilter) {
				html += `<div class="filter-clear" onclick="window.accessBoardManager?.clearColumnFilter('${columnName}')"><i class="fas fa-times"></i> Clear filter</div>`;
			}
			
			dropdown.innerHTML = html;
		}
		
		filterColumnOptions(event, columnName) {
			const searchVal = (event.target.value || '').toLowerCase();
			const dropdown = document.getElementById(`filter-${columnName}`);
			if (!dropdown) return;
			
			dropdown.querySelectorAll('.filter-option').forEach(opt => {
				const text = (opt.textContent || '').toLowerCase();
				opt.style.display = text.includes(searchVal) ? '' : 'none';
			});
		}
		
		applyColumnFilter(columnName, value) {
			this.columnFilters[columnName] = value;
			this.updateColumnFilterIcons();
			
			// Close dropdown
			const dropdown = document.getElementById(`filter-${columnName}`);
			if (dropdown) dropdown.classList.remove('show');
			
			this.applyFilters();
		}
		
		clearColumnFilter(columnName) {
			delete this.columnFilters[columnName];
			this.updateColumnFilterIcons();
			
			// Close dropdown
			const dropdown = document.getElementById(`filter-${columnName}`);
			if (dropdown) dropdown.classList.remove('show');
			
			this.applyFilters();
		}
		
		updateColumnFilterIcons() {
			// Update filter icons to show active state
			document.querySelectorAll('.column-filter-header').forEach(header => {
				const col = header.dataset.column;
				if (this.columnFilters[col]) {
					header.classList.add('filter-active');
				} else {
					header.classList.remove('filter-active');
				}
			});
		}
		
		initAccessControl(){ 
			// Wait for auth to be ready, then load access control and apply tab visibility
			const int = setInterval(() => {
				const companyId = window.authManager?.currentUser?.companyId;
				if (companyId) {
					clearInterval(int);
					loadAccessControl();
					applyAccessTabVisibility();
				}
			}, 400);
			setTimeout(() => clearInterval(int), 15000);
		}
		waitForCompanyThenLoad(){ const int=setInterval(()=>{ const companyId=window.authManager?.currentUser?.companyId; if(companyId){ clearInterval(int); this.load(companyId); } },400); setTimeout(()=>clearInterval(int),15000); }
	       async load(companyId){
		       console.log('ðŸ“¡ Listening for access requests for company',companyId);
		       firebase.database().ref(`companies/${companyId}/access`).on('value',async snap=>{
			       const data=snap.val()||{};
			       this.allRequests=Object.entries(data).map(([id,v])=>({...v,id})).sort((a,b)=> new Date(b.createdAt||0)-new Date(a.createdAt||0));
			       this.accessRequests=this.allRequests; // keep alias in sync
			       // Preload company users for identity lookups (employeeId, names)
			       try { await this.ensureCompanyUsersLoaded(); } catch(e) { console.warn('Company users prefetch failed', e); }
			       // Determine if user can view ALL requests (only based on canViewAll setting)
			       const currentUser = window.authManager?.currentUser;
			       let canViewAll = false;
				   if (currentUser) {
				       const userId = currentUser.uid;
				       const userRole = (currentUser.role || '').toLowerCase();
					   const userEmail = (currentUser.email || '').toLowerCase().trim();
					   
					   // ONLY check canViewAll permission - ignore roles and other permissions for "view all" access
					   let userAccessSettings = {};
					   try {
						   userAccessSettings = await getUserAccessControlSettings() || {};
						   const canViewAllPerm = userAccessSettings.canViewAll === true;
						   if (canViewAllPerm) {
							   canViewAll = true;
						   }
					   } catch(e) { 
						   console.warn('canViewAll check failed', e); 
					   }
					   
					   // URL override to show all (e.g., accessboard.html?all=1)
					   try { 
						   const qp = new URLSearchParams(location.search); 
						   if (qp.get('all')==='1' || qp.get('showAll')==='1') { 
							   canViewAll = true; 
						   } 
					   } catch(_e) {}
					   
					   if (canViewAll) {
						   // User can see all requests - but may be restricted by allowed areas
						   const allowedAreas = userAccessSettings.allowedAreas || [];
						   if (allowedAreas.length > 0) {
							   // Filter by allowed areas, BUT always include requests created by current user
							   this.userFilteredRequests = this.allRequests.filter(r => {
								   // Always show requests created by the logged-in user (regardless of area)
								   const isCreator = (
									   r.userId === userId ||
									   r.createdBy === userId ||
									   r.createdByUid === userId ||
									   r.createdById === userId ||
									   r.ownerId === userId ||
									   r.owner === userId ||
									   r.requesterUserId === userId ||
									   r.requesterUid === userId ||
									   r.employeeUserId === userId ||
									   (typeof r.createdBy === 'string' && r.createdBy.toLowerCase() === userEmail) ||
									   (typeof r.createdByEmail === 'string' && r.createdByEmail.toLowerCase() === userEmail) ||
									   (typeof r.requesterEmail === 'string' && r.requesterEmail.toLowerCase() === userEmail) ||
									   (typeof r.requester === 'string' && r.requester.toLowerCase() === userEmail)
								   );
								   if (isCreator) return true;
								   
								   // For requests by others, apply area restriction
								   let requestArea = (r.area || '').toLowerCase().trim();
								   if (!requestArea && Array.isArray(r.visitors) && r.visitors.length > 0) {
									   requestArea = (r.visitors[0].area || '').toLowerCase().trim();
								   }
								   return allowedAreas.some(a => a.toLowerCase().trim() === requestArea);
							   });
						   } else {
							   // No area restriction - show all
							   this.userFilteredRequests = this.allRequests;
						   }
						   // Expose Show All toggle for authorized users
						   const showAllGroup = document.getElementById('showAllGroup');
						   if (showAllGroup) showAllGroup.style.display = 'flex';
						   // Load approval flow config for approver display name resolution
						   try {
							   const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
							   const approvalSnapshot = await approvalFlowRef.once('value');
							   this._approvalFlowConfig = approvalSnapshot.val();
					   	   } catch (e) { console.warn('Failed to load approval config for rendering:', e); }
				       } else {
					       // Regular user: only requests created by or assigned as approver to current user
					       let createdByUser = this.allRequests.filter(r => {
						       const email = userEmail;
						       return (
							       r.userId === userId ||
							       r.createdBy === userId ||
							       r.createdByUid === userId ||
							       r.createdById === userId ||
							       r.ownerId === userId ||
							       r.owner === userId ||
							       r.requesterUserId === userId ||
							       r.requesterUid === userId ||
							       r.employeeUserId === userId ||
							       // Legacy/email-based creator fields
							       (typeof r.createdBy === 'string' && r.createdBy.toLowerCase() === email) ||
							       (typeof r.createdByEmail === 'string' && r.createdByEmail.toLowerCase() === email) ||
							       (typeof r.requesterEmail === 'string' && r.requesterEmail.toLowerCase() === email) ||
							       (typeof r.requester === 'string' && r.requester.toLowerCase() === email)
						       );
					       });
						   // Get current user's name for name-based approver matching
					   const userName = (currentUser.name || currentUser.displayName || currentUser.fullName || '').trim().toLowerCase();
					   let assignedToUser = this.allRequests.filter(r => {
						       if (Array.isArray(r.approvalHistory)) {
									   if (r.approvalHistory.some(h => h && (h.approverId === userId || h.approvedBy === userId || (h.approverEmail && String(h.approverEmail).toLowerCase().trim() === userEmail) || (h.approverName && userName && String(h.approverName).toLowerCase().trim() === userName)))) return true;
						       }
						       if (r.selectedRoles && typeof r.selectedRoles === 'object') {
							       for (const levelKey of Object.keys(r.selectedRoles)) {
								       const levelArr = r.selectedRoles[levelKey];
								       if (Array.isArray(levelArr)) {
									       for (const approver of levelArr) {
										       const aVal = (approver && (approver.value || approver.uid || approver.id || approver.userId)) || '';
												   const aEmail = (approver && (approver.email || approver.userEmail)) ? String(approver.email || approver.userEmail).toLowerCase().trim() : '';
												   const aName = (approver && (approver.name || approver.text || approver.displayName)) ? String(approver.name || approver.text || approver.displayName).toLowerCase().trim() : '';
										       if (aVal === userId || (aEmail && aEmail === userEmail) || (aName && userName && aName === userName)) return true;
									       }
								       }
							       }
						       }
						       return false;
					       });
					       
					       // CRITICAL FIX: Check if user is eligible to approve any request based on approval flow configuration
					       let approvalFlowAssignedRequests = [];
					       try {
						       const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
						       const approvalSnapshot = await approvalFlowRef.once('value');
						       const approvalConfig = approvalSnapshot.val();
						       
						       // Store approval flow config for later use in rendering
						       this._approvalFlowConfig = approvalConfig;
						       
						       if (approvalConfig && approvalConfig.enabled && Array.isArray(approvalConfig.levels)) {
							       for (const request of this.allRequests) {
								       try {
									       for (const level of approvalConfig.levels) {
										       const canApproveAtLevel = await this.checkApprovalPermissionForLevel(level, currentUser, request);
										       if (canApproveAtLevel) {
											       approvalFlowAssignedRequests.push(request);
											       break;
										       }
									       }
								       } catch (e) { /* skip request on error */ }
							       }
						       }
						       
						       // Check per-request selectedRoles for approval assignments
						       for (const request of this.allRequests) {
							       if (request.selectedRoles && typeof request.selectedRoles === 'object') {
								       let foundInThisRequest = false;
								       for (const levelKey of Object.keys(request.selectedRoles)) {
									       const levelArr = request.selectedRoles[levelKey];
									       if (Array.isArray(levelArr)) {
										       for (const approver of levelArr) {
											       const aVal = (approver && (approver.value || approver.uid || approver.id || approver.userId)) || '';
											       const aEmail = (approver && (approver.email || approver.userEmail)) ? String(approver.email || approver.userEmail).toLowerCase().trim() : '';
											       const aName = (approver && (approver.name || approver.text || approver.displayName)) ? String(approver.name || approver.text || approver.displayName).toLowerCase().trim() : '';
											       
											       if (aVal === userId || (aEmail && aEmail === userEmail) || (aName && userName && aName === userName)) {
												       if (!approvalFlowAssignedRequests.find(r => r.id === request.id)) {
													       approvalFlowAssignedRequests.push(request);
												       }
												       foundInThisRequest = true;
												       break;
											       }
										       }
										       if (foundInThisRequest) break;
									       }
								       }
							       }
						       }
					       } catch (e) {
						       console.error('âŒ Error loading approval flow for visibility check:', e);
					       }
					       
					       // Combine all assigned requests (remove duplicates)
					       const allAssignedMap = {};
					       [...assignedToUser, ...approvalFlowAssignedRequests].forEach(r => { allAssignedMap[r.id] = r; });
					       assignedToUser = Object.values(allAssignedMap);
					       
					       const userReqMap = {};
					       [...createdByUser, ...assignedToUser].forEach(r => { userReqMap[r.id] = r; });
					       let filteredRequests = Object.values(userReqMap);
					       
					       // Apply area filtering if user has allowed areas set
					       const allowedAreas = userAccessSettings.allowedAreas || [];
					       if (allowedAreas.length > 0) {
						       filteredRequests = filteredRequests.filter(r => {
							       let requestArea = (r.area || '').toLowerCase().trim();
							       if (!requestArea && Array.isArray(r.visitors) && r.visitors.length > 0) {
								       requestArea = (r.visitors[0].area || '').toLowerCase().trim();
							       }
							       return allowedAreas.some(a => a.toLowerCase().trim() === requestArea);
						       });
					       }
					       
					       this.userFilteredRequests = filteredRequests;
				       }
			       } else {
				       this.userFilteredRequests = [];
			       }
			       // Resolve requester names (replace emails with full names where possible)
			       try{
				       await this.resolveRequesterNames();
			       } catch(e){ /* silently fail */ }
			       this.applyFilters();
			       // Load approver info from approval flow config (async, will re-render when done)
			       this.loadApproverInfoForRecords().catch(e => {});
		       });
	       }

		// Try to replace requester email/identifiers with full display names when available
		async resolveRequesterNames(){
			if(!Array.isArray(this.allRequests) || this.allRequests.length===0) return;
			
			// Pre-load all users cache once for batch resolution
			if(this._usersCacheAll === null || this._usersCacheAll === undefined) {
				try {
					const usnap = await firebase.database().ref('users').once('value');
					this._usersCacheAll = usnap.exists() ? usnap.val() : {};
				} catch(e) { this._usersCacheAll = {}; }
			}
			
			// Process all records synchronously using cached data (no async per-record)
			for (const rec of this.allRequests) {
				try {
					// If requesterName already looks like a proper name (no @), just compute employee ID
					if(rec.requesterName && typeof rec.requesterName==='string' && rec.requesterName.indexOf('@')===-1){
						this.getRequesterEmployeeIdSync(rec);
						continue;
					}
					
					// Prefer explicit userId fields - look up from cache
					const uid = rec.userId || rec.requesterUserId || rec.requesterUid || rec.employeeUserId || rec.requesterEmployeeId;
					if(uid && this._usersCacheAll && this._usersCacheAll[uid]){
						const u = this._usersCacheAll[uid];
						rec.requesterName = u.displayName || u.name || u.username || u.email || rec.requesterName;
						this.getRequesterEmployeeIdSync(rec);
						continue;
					}
					
					// If requesterName is an email, try to lookup user by email from cached users list
					const maybeEmail = (rec.requesterName && rec.requesterName.includes('@')) ? rec.requesterName : (rec.requesterEmail || rec.requester);
					if(maybeEmail && typeof maybeEmail==='string' && maybeEmail.includes('@')){
						const emailLower = maybeEmail.toLowerCase();
						let found = false;
						for(const [k,u] of Object.entries(this._usersCacheAll||{})){
							if(u && u.email && u.email.toLowerCase()===emailLower){
								rec.requesterName = u.displayName || u.name || u.username || u.email;
								this.getRequesterEmployeeIdSync(rec);
								found = true;
								break;
							}
						}
						if (!found) {
							// fallback: infer from email local-part
							const inferred = maybeEmail.split('@')[0].replace(/[._]/g,' ').split(' ').map(w=> w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
							rec.requesterName = inferred || rec.requesterName;
							this.getRequesterEmployeeIdSync(rec);
						}
					}
				}catch(e){ /* skip on error */ }
			}
		}
		
		// Synchronous version of getRequesterEmployeeId using cached company users
		getRequesterEmployeeIdSync(rec){
			try{
				if(rec && rec._displayEmployeeId) return rec._displayEmployeeId;
				const companyUsers = this.companyUsersCache || {};
				const uid = rec?.userId || rec?.requesterUserId || rec?.requesterUid || rec?.employeeUserId || rec?.requesterEmployeeId;
				let code = '';
				if(uid && companyUsers && companyUsers[uid]){
					const u = companyUsers[uid] || {};
					code = u.employeeId || u.employeeCode || u.empCode || u.code || '';
				}
				// fallback by email match if no uid hit
				if(!code){
					const email = (rec?.requesterEmail || rec?.requester || '').toLowerCase();
					if(email && companyUsers){
						for(const k in companyUsers){
							const u = companyUsers[k];
							const uEmail = String(u?.email||'').toLowerCase();
							if(uEmail && uEmail===email){ code = u.employeeId || u.employeeCode || u.empCode || u.code || ''; if(code) break; }
						}
					}
				}
				// Final fallback to any existing field in the record
				code = code || rec?.employeeCode || rec?.empCode || rec?.employee_id || rec?.employeeId || rec?.requesterEmployeeId || '';
				rec._displayEmployeeId = code;
				return code;
			}catch(e){ return rec?.employeeId || rec?.requesterEmployeeId || ''; }
		}

		// ===== Company users directory helpers =====
		async ensureCompanyUsersLoaded(){
			try{
				const companyId = window.authManager?.currentUser?.companyId;
				const now = Date.now();
				if(!companyId) return {};
				if(this.companyUsersCache && this.companyUsersCompanyId===companyId && (now - this.companyUsersLoadedAt) < 5*60*1000){
					return this.companyUsersCache;
				}
				const usersSnapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
				this.companyUsersCache = usersSnapshot.val() || {};
				this.companyUsersCompanyId = companyId;
				this.companyUsersLoadedAt = now;
				return this.companyUsersCache;
			}catch(e){ console.warn('ensureCompanyUsersLoaded failed', e); return this.companyUsersCache||{}; }
		}
		// Return a nice employee code/id for the requester, based on company users directory
		async getRequesterEmployeeId(rec){
			try{
				if(rec && rec._displayEmployeeId) return rec._displayEmployeeId;
				const companyUsers = await this.ensureCompanyUsersLoaded();
				const uid = rec?.userId || rec?.requesterUserId || rec?.requesterUid || rec?.employeeUserId || rec?.requesterEmployeeId;
				let code = '';
				if(uid && companyUsers && companyUsers[uid]){
					const u = companyUsers[uid] || {};
					code = u.employeeId || u.employeeCode || u.empCode || u.code || '';
				}
				// fallback by email match if no uid hit
				if(!code){
					const email = (rec?.requesterEmail || rec?.requester || '').toLowerCase();
					if(email && companyUsers){
						for(const k in companyUsers){
							const u = companyUsers[k];
							const uEmail = String(u?.email||'').toLowerCase();
							if(uEmail && uEmail===email){ code = u.employeeId || u.employeeCode || u.empCode || u.code || ''; if(code) break; }
						}
					}
				}
				// Final fallback to any existing field in the record that looks like a non-UID code
				code = code || rec?.employeeCode || rec?.empCode || rec?.employee_id || '';
				// if still empty, use stored employeeId (may be UID), or requesterEmployeeId
				code = code || rec?.employeeId || rec?.requesterEmployeeId || '';
				rec._displayEmployeeId = code;
				return code;
			}catch(e){ return rec?.employeeId || rec?.requesterEmployeeId || ''; }
		}

		// Determine if a user is a global approver for Access requests based on approval settings
		async isUserGlobalAccessApprover(companyId, user){
			try{
				if(!companyId || !user) return false;
				const uid = user.uid;
				const email = String(user.email||'').toLowerCase().trim();
				const role = String(user.role||'').toLowerCase();
				// Load approval flow config
				const ref = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
				const snap = await ref.once('value');
				if(!snap.exists()) return false;
				const cfg = snap.val()||{};
				if(cfg.enabled===false) return false;
				// Build a list of approver entries from selectedRoles and/or levels
				const entries = [];
				const pushArr = (arr)=>{ if(Array.isArray(arr)){ for(const a of arr){ if(a) entries.push(a); } } };
				if(cfg.selectedRoles && typeof cfg.selectedRoles==='object'){
					for(const k of Object.keys(cfg.selectedRoles)) pushArr(cfg.selectedRoles[k]);
				}
				if(Array.isArray(cfg.levels)) pushArr(cfg.levels);
				if(entries.length===0) return false;
				// Prepare company users for role/function resolution
				let companyUsers = await this.ensureCompanyUsersLoaded(); companyUsers = companyUsers||{};
				const matchesUser = (entry)=>{
					try{
						const v = String(entry.value || entry.uid || entry.userId || entry.id || '').trim();
						const e = String(entry.email || entry.userEmail || '').toLowerCase().trim();
						if(v && (v===uid)) return true;
						if(e && email && e===email) return true;
						// function_* role tokens mapping
						const valLower = v.toLowerCase();
						if(valLower.startsWith('function_')){
							const token = valLower.replace(/^function_/, ''); // e.g., 'manager'
							// match user's role contains token
							if(role && role.includes(token)) return true;
							// or any company user record with this uid has role containing token
							const uRec = companyUsers[uid];
							const uRole = String(uRec?.role || uRec?.userRole || '').toLowerCase();
							if(uRole && uRole.includes(token)) return true;
						}
						return false;
					}catch(_e){ return false; }
				};
				for(const entry of entries){ if(matchesUser(entry)) return true; }
				return false;
			}catch(e){ console.warn('isUserGlobalAccessApprover error', e); return false; }
		}
	       applyFilters(){
		       // Use all requests when Show All is enabled (for authorized users); otherwise userFilteredRequests
		       const showAll = document.getElementById('showAllToggle')?.checked === true;
		       const baseList = showAll ? (this.allRequests || []) : (Array.isArray(this.userFilteredRequests) && this.userFilteredRequests.length > 0 ? this.userFilteredRequests : []);
		       const q=(this.dom.search?.value||'').toLowerCase();
		       const s=(this.dom.status?.value||'');
		       const pill=this.statusPillFilter;
		       const colFilters = this.columnFilters || {};
			   this.filtered=baseList.filter(r=>{
				   const toBeRet = (r.toBeReturned===true||String(r.toBeReturned).toLowerCase()==='yes')?'yes':((r.toBeReturned===false||String(r.toBeReturned).toLowerCase()==='no')?'no':'');
				   const text=[r.referenceNumber,r.requesterName,r.departmentName,r.companyName,r.area,r.propertyRemoval,toBeRet].join(' ').toLowerCase();
			       const matchQ= !q || text.includes(q);
			       const statusVal=(r.status||'').toLowerCase();
			       const displayStatus = (r.isReleased === true && r.status !== 'approved' && r.status !== 'rejected') ? 'released' : (r.status || '');
			       const matchS= !s || statusVal===s;
			       const matchPill= !pill || statusVal===pill;
			       
			       // Column filters
			       let matchCol = true;
			       if (colFilters.requester && (r.requesterName || '') !== colFilters.requester) matchCol = false;
			       if (colFilters.approver) {
			           const approverVal = r.requesterLineManager || this.getApproverDisplayName(r) || '';
			           if (approverVal !== colFilters.approver) matchCol = false;
			       }
			       if (colFilters.department && (r.departmentName || '') !== colFilters.department) matchCol = false;
			       if (colFilters.company && (r.companyName || '') !== colFilters.company) matchCol = false;
			       if (colFilters.area) {
			           const areaVal = r.visitors?.[0]?.area || r.area || '';
			           if (areaVal !== colFilters.area) matchCol = false;
			       }
			       if (colFilters.status && displayStatus.toLowerCase() !== colFilters.status.toLowerCase()) matchCol = false;
			       
			       return matchQ && matchS && matchPill && matchCol;
		       });
		       this.render();
		       this.renderSummary();
	       }
		fmtDate(dt){ if(!dt) return ''; const d=new Date(dt); if(isNaN(d)) return dt; return d.toLocaleDateString()+" "+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
		statusBadge(val){ const v=(val||'').toLowerCase(); if(v==='submitted') return `<span class="badge badge-status-submitted">SUBMITTED</span>`; if(v==='updated') return `<span class="badge badge-status-updated">UPDATED</span>`; if(v==='released') return `<span class="badge badge-status-released" style="background:#0ea5e9;color:#fff;">RELEASED</span>`; if(v==='approved') return `<span class="badge badge-status-approved">APPROVED</span>`; if(v==='rejected') return `<span class="badge badge-status-rejected">REJECTED</span>`; if(v==='pending_approval'||v==='pending') return `<span class="badge badge-status-updated">PENDING</span>`; return ''; }
		
		// Get approver display name: show the line manager name that was saved during request submission
		getApproverDisplayName(record) {
			try {
				// First try to get the line manager name that was saved when the request was submitted
				if (record.requesterLineManager) {
					return this.escape(record.requesterLineManager);
				}
				
				// Fallback to trying to resolve from company data if not saved in request
				const companyUsers = this.companyUsersCache || {};
				const submitterUid = record.submittedBy || record.createdBy || record.userId;
				
				if (!submitterUid) return '';
				
				const submitter = companyUsers[submitterUid];
				
				if (submitter) {
					// Prefer the explicit line manager name saved by companymanagement.html
					let lmName = submitter.lineManager || submitter.lineManagerName || '';
					
					// If only ID is stored or name is empty, resolve ID to name
					if ((!lmName || /^(uid_|[A-Za-z0-9_-]{15,})$/.test(String(lmName).trim())) && submitter.lineManagerId && companyUsers[submitter.lineManagerId]) {
						const manager = companyUsers[submitter.lineManagerId];
						lmName = manager?.name || manager?.displayName || manager?.fullName || '';
					}
					
					// Clean formatting like "Name (Dept - Title)"
					if (lmName) {
						const nameOnly = lmName.match(/^([^()\-]+?)(?:\s*\([^)]*\))?(?:\s*-\s*.*)?$/);
						return this.escape((nameOnly ? nameOnly[1] : lmName).trim());
					}
				}
				return '';
			} catch (e) {
				return '';
			}
		}
		
		// Get approver display with job title for table column (from approval flow config)
		getApproverWithTitle(record) {
			// Helper: Format job title - convert hyphenated values to title case (e.g., 'hse-manager' -> 'HSE Manager')
			const formatJobTitle = (value) => {
				if (!value || value === '-') return '';
				return value.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
			};
			
			try {
				// First try to get from cached approval flow data
				const approverInfo = this._approverCache?.[record.id];
				if (approverInfo) {
					const formattedTitle = formatJobTitle(approverInfo.title);
					if (formattedTitle) {
						return `<span class="approver-name">${this.escape(approverInfo.name)}</span><br><span class="approver-title" style="font-size:.65rem;color:#6b7280;">${this.escape(formattedTitle)}</span>`;
					}
					return this.escape(approverInfo.name);
				}
				
				// Try to resolve directly from company users if cache is missing
				const companyUsers = this.companyUsersCache || {};
				const submitterUid = record.submittedBy || record.createdBy || record.userId;
				const submitter = submitterUid ? companyUsers[submitterUid] : null;
				
				if (submitter && submitter.lineManagerId && companyUsers[submitter.lineManagerId]) {
					const manager = companyUsers[submitter.lineManagerId];
					const managerName = manager.name || manager.displayName || manager.fullName || '';
					const rawTitle = (manager.jobTitle || manager.title || manager.jobTitleName || manager.position || manager.designation || '').trim();
					const managerTitle = formatJobTitle(rawTitle);
					
					if (managerName && managerTitle) {
						return `<span class="approver-name">${this.escape(managerName)}</span><br><span class="approver-title" style="font-size:.65rem;color:#6b7280;">${this.escape(managerTitle)}</span>`;
					} else if (managerName) {
						return this.escape(managerName);
					}
				}
				
				// Fallback to line manager name without title while loading
				const name = this.getApproverDisplayName(record);
				return name ? this.escape(name) : '';
			} catch (e) {
				return this.getApproverDisplayName(record);
			}
		}
		
		// Load approver info from approval flow configuration
		async loadApproverInfoForRecords() {
			try {
				const companyId = window.authManager?.currentUser?.companyId;
				if (!companyId) return;
				
				// Fetch approval flow config
				const configSnap = await firebase.database().ref(`companies/${companyId}/approvalFlows/access`).once('value');
				const config = configSnap.val();
				
				if (!config || !config.enabled) return;
				
				// Check for both selectedRoles and levels structures
				let approverLevels = [];
				if (config.selectedRoles && typeof config.selectedRoles === 'object') {
					const levelKeys = Object.keys(config.selectedRoles).sort();
					if (levelKeys.length > 0) {
						const firstLevelConfig = config.selectedRoles[levelKeys[0]];
						if (Array.isArray(firstLevelConfig) && firstLevelConfig.length > 0) {
							approverLevels = [{ level: 1, config: firstLevelConfig[0] }];
						}
					}
				} else if (Array.isArray(config.levels) && config.levels.length > 0) {
					approverLevels = config.levels.map((level, index) => ({
						level: index + 1,
						config: level
					}));
				}
				
				if (approverLevels.length === 0) return;
				
				// Ensure company users are loaded
				await this.ensureCompanyUsersLoaded();
				const companyUsers = this.companyUsersCache || {};
				
				// Initialize cache
				this._approverCache = this._approverCache || {};
				
				// Use first approver level
				const firstLevel = approverLevels[0];
				const approverConfig = firstLevel.config;
				const approverId = approverConfig.value || approverConfig.uid || approverConfig.approver;
				console.log('ðŸŽ¯ First level approver config:', approverConfig, 'ID:', approverId);
				
				// Process each record
				for (const record of (this.allRequests || [])) {
					let approverName = '';
					let approverTitle = '';
					
					// Check if this is a level-based approver (L+1, L+2, etc.)
					if (approverId && approverId.startsWith && approverId.startsWith('L+')) {
						// For L+1, get the submitter's line manager
						if (approverId === 'L+1') {
							approverName = this.getApproverDisplayName(record);
							
							// Get line manager's job title
							if (record.requesterLineManagerTitle) {
								approverTitle = String(record.requesterLineManagerTitle).trim();
							} else {
								const submitterUid = record.submittedBy || record.createdBy || record.userId;
								const submitter = submitterUid ? companyUsers[submitterUid] : null;
								if (submitter && submitter.lineManagerId && companyUsers[submitter.lineManagerId]) {
									const manager = companyUsers[submitter.lineManagerId];
									approverTitle = (manager?.jobTitle || manager?.title || manager?.jobTitleName || manager?.position || manager?.designation || '').trim();
								}
							}
						} else {
							approverName = `Line Manager (${approverId})`;
						}
					} else if (approverId && companyUsers[approverId]) {
						// Specific user assigned as approver
						const approverData = companyUsers[approverId];
						// Use actual user name
						approverName = approverData.name || approverData.displayName || approverData.fullName || '';
						// Prefer company directory job title; fallback to dropdown label only if missing
						approverTitle = (approverData.jobTitle || approverData.title || approverData.jobTitleName || approverData.position || approverData.designation || '').trim();
						if (!approverTitle) {
							const cfgText = (approverConfig.text || '').trim();
							// Avoid using a config text that equals the name
							if (cfgText && cfgText.toLowerCase() !== (approverName || '').trim().toLowerCase()) {
								approverTitle = cfgText;
							}
						}
					} else {
						// Fallback: use a generic name and prefer dropdown text as job title
						approverName = 'Approver';
						approverTitle = (approverConfig.text || '').trim();
					
						// Try to find user by email or value to refine name/title
						if (approverConfig.email) {
							for (const uid in companyUsers) {
								const u = companyUsers[uid];
								if (u && String(u.email || '').toLowerCase() === String(approverConfig.email).toLowerCase()) {
									approverName = u.name || u.displayName || u.fullName || approverName;
									approverTitle = approverTitle || (u.jobTitle || u.title || u.jobTitleName || u.position || u.designation || '').trim();
									break;
								}
							}
						} else if (approverConfig.value && companyUsers[approverConfig.value]) {
							const u = companyUsers[approverConfig.value];
							approverName = u.name || u.displayName || u.fullName || approverName;
							approverTitle = approverTitle || (u.jobTitle || u.title || u.jobTitleName || u.position || u.designation || '').trim();
						}
					}
					
					this._approverCache[record.id] = { name: approverName, title: approverTitle };
				}
				
				// Re-render to show updated approver info
				this.render();
			} catch (e) {
				console.error('âŒ Error loading approver info:', e);
			}
		}
		
		canEdit(record){ const cu=window.authManager?.currentUser; if(!cu) return false; if(cu.role && ['admin','superadmin','company_admin','hr_manager'].some(r=> (cu.role||'').toLowerCase().includes(r))) return true; return record.userId===cu.uid; }
		
		// Check if current user can release the gate pass (creator/requester)
		canRelease(record) {
			const cu = window.authManager?.currentUser;
			if (!cu) return false;
			
			const userId = cu.uid || cu.id;
			const userEmail = (cu.email || '').toLowerCase().trim();
			
			// Only the creator/requester can release
			const isCreator = (
				record.userId === userId ||
				record.createdBy === userId ||
				record.createdByUid === userId ||
				record.createdById === userId ||
				record.ownerId === userId ||
				record.owner === userId ||
				record.requesterUserId === userId ||
				record.requesterUid === userId ||
				record.employeeUserId === userId ||
				(typeof record.createdBy === 'string' && record.createdBy.toLowerCase() === userEmail) ||
				(typeof record.createdByEmail === 'string' && record.createdByEmail.toLowerCase() === userEmail) ||
				(typeof record.requesterEmail === 'string' && record.requesterEmail.toLowerCase() === userEmail) ||
				(typeof record.requester === 'string' && record.requester.toLowerCase() === userEmail)
			);
			
			return isCreator;
		}
		
		// Release gate pass for approval
		async releaseAccessRequest(id) {
			const rec = this.allRequests.find(r => r.id === id);
			if (!rec) return;
			
			if (!confirm('Are you sure you want to release this gate pass for approval?')) return;
			
			const cu = window.authManager?.currentUser;
			if (!cu || !cu.companyId) return;
			
			try {
				await firebase.database().ref(`companies/${cu.companyId}/access/${id}`).update({
					isReleased: true,
					status: 'released',
					releasedAt: new Date().toISOString(),
					releasedBy: cu.uid,
					releasedByName: cu.name || cu.displayName || cu.email
				});
				
				// Update local record
				rec.isReleased = true;
				rec.status = 'released';
				rec.releasedAt = new Date().toISOString();
				rec.releasedBy = cu.uid;
				
				window.notificationManager?.addNotification({
					type: 'success',
					message: 'Gate pass released for approval'
				});
				
				// Refresh modal buttons
				await this.updateModalActionButtons(rec);
				
			} catch (error) {
				console.error('Error releasing gate pass:', error);
				window.notificationManager?.addNotification({
					type: 'error',
					message: 'Failed to release gate pass'
				});
			}
		}
		
		// Batch selection methods
		updateSelection(checkbox) {
			const id = checkbox.dataset.id;
			const row = checkbox.closest('tr');
			if (checkbox.checked) {
				this.selectedIds.add(id);
				row?.classList.add('selected');
			} else {
				this.selectedIds.delete(id);
				row?.classList.remove('selected');
			}
			this.updateBatchUI();
		}
		
		toggleSelectAll(checkbox) {
			const rowCheckboxes = this.dom.tbody?.querySelectorAll('.row-checkbox') || [];
			rowCheckboxes.forEach(cb => {
				cb.checked = checkbox.checked;
				const id = cb.dataset.id;
				const row = cb.closest('tr');
				if (checkbox.checked) {
					this.selectedIds.add(id);
					row?.classList.add('selected');
				} else {
					this.selectedIds.delete(id);
					row?.classList.remove('selected');
				}
			});
			this.updateBatchUI();
		}
		
		clearSelection() {
			this.selectedIds.clear();
			if (this.dom.selectAllCb) this.dom.selectAllCb.checked = false;
			this.dom.tbody?.querySelectorAll('.row-checkbox').forEach(cb => {
				cb.checked = false;
				cb.closest('tr')?.classList.remove('selected');
			});
			this.updateBatchUI();
		}
		
		updateBatchUI() {
			const count = this.selectedIds.size;
			if (this.dom.selectedCount) this.dom.selectedCount.textContent = count;
			if (this.dom.batchBar) {
				this.dom.batchBar.classList.toggle('visible', count > 0);
			}
			// Update select all checkbox state
			const rowCheckboxes = this.dom.tbody?.querySelectorAll('.row-checkbox') || [];
			const allChecked = rowCheckboxes.length > 0 && Array.from(rowCheckboxes).every(cb => cb.checked);
			const someChecked = Array.from(rowCheckboxes).some(cb => cb.checked);
			if (this.dom.selectAllCb) {
				this.dom.selectAllCb.checked = allChecked;
				this.dom.selectAllCb.indeterminate = someChecked && !allChecked;
			}
		}
		
		async batchDelete() {
			const count = this.selectedIds.size;
			if (count === 0) return;
			
			if (!confirm(`Are you sure you want to delete ${count} gate pass request(s)? This action cannot be undone.`)) {
				return;
			}
			
			const user = window.authManager?.currentUser;
			if (!user || !user.companyId) {
				window.notificationManager?.addNotification({ type: 'error', message: 'Not authenticated' });
				return;
			}
			
			try {
				const deletePromises = Array.from(this.selectedIds).map(id => 
					firebase.database().ref(`companies/${user.companyId}/access/${id}`).remove()
				);
				
				await Promise.all(deletePromises);
				
				window.notificationManager?.addNotification({ 
					type: 'success', 
					message: `Successfully deleted ${count} request(s)` 
				});
				
				this.clearSelection();
			} catch (error) {
				console.error('Batch delete error:', error);
				window.notificationManager?.addNotification({ 
					type: 'error', 
					message: 'Failed to delete some requests' 
				});
			}
		}
		
		exportCsv(){ if(this.filtered.length===0){ window.notificationManager?.addNotification({type:'Export',message:'No rows to export.'}); return; } const headers=['Ref','Requester','Approver','Department','Company','Area','Start','End','Status','Property Removal','To be Returned','Visitors','Equipment']; const lines=[headers.join(',')]; this.filtered.forEach(r=>{ const toBeRet = (r.toBeReturned===true||String(r.toBeReturned).toLowerCase()==='yes')?'Yes':((r.toBeReturned===false||String(r.toBeReturned).toLowerCase()==='no')?'No':''); let pStartTs=null,pEndTs=null; let exportArea = r.area || ''; if(!exportArea && Array.isArray(r.visitors) && r.visitors.length > 0) { exportArea = r.visitors[0].area || ''; } if(Array.isArray(r.visitors)&&r.visitors.length){ for(const p of r.visitors){ const s=new Date(p.startDateTime||p.startDate||p.start); const e=new Date(p.endDateTime||p.endDate||p.end); if(!isNaN(s)) pStartTs=(pStartTs===null||s<pStartTs)?s:pStartTs; if(!isNaN(e)) pEndTs=(pEndTs===null||e>pEndTs)?e:pEndTs; } } const startDisp = pStartTs? this.fmtDate(pStartTs) : this.fmtDate(r.startDateTime||r.startDate||r.start); const endDisp = pEndTs? this.fmtDate(pEndTs) : this.fmtDate(r.endDateTime||r.endDate||r.end); const approverName = this.getApproverDisplayName(r).replace(/(<([^>]+)>)/gi, ''); const row=[r.referenceNumber||r.id,r.requesterName||'',approverName,r.departmentName||'',r.companyName||'',exportArea,startDisp,endDisp,(r.status||'').toUpperCase(),r.propertyRemoval||'',toBeRet,(r.visitors||[]).length,(r.equipment||[]).length]; lines.push(row.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')); }); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='gate_pass_requests.csv'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },500); }
			   renderSummary(){ if(!this.dom.summary) return; this.dom.summary.innerHTML = ""; }
		render(){ const tb=this.dom.tbody; if(!tb) return; tb.innerHTML=''; this.clearSelection(); if(this.filtered.length===0){ tb.innerHTML='<tr><td colspan="13" class="empty-state">No gate pass requests found.</td></tr>'; return; } const rows=this.filtered.map(r=>{ const editAllowed=this.canEdit(r); const toBeRet = (r.toBeReturned===true||String(r.toBeReturned).toLowerCase()==='yes')?'Yes':((r.toBeReturned===false||String(r.toBeReturned).toLowerCase()==='no')?'No':'');
			// Derive People-level start and end if available
			let pStartTs = null, pEndTs = null;
			// Get area from first visitor if not at request level
			let displayArea = r.area || '';
			if (!displayArea && Array.isArray(r.visitors) && r.visitors.length > 0) {
				displayArea = r.visitors[0].area || '';
			}
			if(Array.isArray(r.visitors) && r.visitors.length){
				for(const p of r.visitors){
					const s = new Date(p.startDateTime || p.startDate || p.start);
					const e = new Date(p.endDateTime || p.endDate || p.end);
					if(!isNaN(s)) pStartTs = (pStartTs===null || s < pStartTs)? s : pStartTs;
					if(!isNaN(e)) pEndTs = (pEndTs===null || e > pEndTs)? e : pEndTs;
				}
			}
			const startDisp = pStartTs? this.fmtDate(pStartTs) : this.fmtDate(r.startDateTime || r.startDate || r.start);
			const endDisp = pEndTs? this.fmtDate(pEndTs) : this.fmtDate(r.endDateTime || r.endDate || r.end);
			// Get approver name with job title (resolve L+1 to line manager name)
			const approverDisplay = this.getApproverWithTitle(r);
			// Check batch actions visibility
			const showBatch = window._canSeeBatchActions === true;
			const batchTd = showBatch ? `<td style="text-align:center;" onclick="event.stopPropagation();"><input type="checkbox" class="batch-checkbox row-checkbox" data-id="${r.id}" onchange="window.accessBoardManager?.updateSelection(this)"></td>` : `<td style="display:none;text-align:center;" onclick="event.stopPropagation();"><input type="checkbox" class="batch-checkbox row-checkbox" data-id="${r.id}" onchange="window.accessBoardManager?.updateSelection(this)"></td>`;
			// Determine display status - if isReleased is true, show 'released' regardless of stored status
			const displayStatus = (r.isReleased === true && r.status !== 'approved' && r.status !== 'rejected') ? 'released' : r.status;
			return `<tr data-id="${r.id}" class="clickable-row">${batchTd}<td><a href="#" class="ref-link" data-id="${r.id}" onclick="event.stopPropagation();" style="text-decoration:none;color:#1d6fbf;font-weight:600;">${r.referenceNumber||r.id}</a></td><td>${r.requesterName||''}</td><td>${approverDisplay}</td><td>${r.departmentName||''}</td><td>${r.companyName||''}</td><td>${displayArea}</td><td>${startDisp||''}</td><td>${endDisp||''}</td><td>${this.statusBadge(displayStatus)}</td><td>${this.escape?.(r.propertyRemoval||'')|| (r.propertyRemoval||'')}</td><td>${toBeRet}</td><td class="actions"><button class="btn btn-view" title="View" onclick="event.stopPropagation(); location.href='access.html?id=${r.id}'"><i class="fas fa-eye"></i></button>${ editAllowed? `<button class="btn btn-edit" title="Edit" onclick="event.stopPropagation(); location.href='access.html?id=${r.id}'"><i class="fas fa-edit"></i></button>`:''}</td></tr>`; }).join(''); tb.innerHTML=rows; this.bindRowClicks();
			// Bind reference link to preview
			tb.querySelectorAll('.ref-link').forEach(a=>{
				a.addEventListener('click',(e)=>{ e.preventDefault(); const id=a.getAttribute('data-id'); this.showPreviewFor(id); });
			});
		}

		attachModalHandlers(){ if(!this.modal.root) return; if(this._modalHandlersAttached) return; const m=this.modal; const hide=()=>{ m.root.classList.add('hidden'); m.root.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }; m.close?.addEventListener('click',hide); m.closeFooter?.addEventListener('click',hide); m.root.addEventListener('click',e=>{ if(e.target===m.root) hide(); }); document.addEventListener('keydown',e=>{ if(e.key==='Escape' && !m.root.classList.contains('hidden')) hide(); }); this._modalHandlersAttached=true; }
		bindRowClicks(){ 
			if(!this.modal.root) return; 
			this.dom.tbody?.querySelectorAll('tr[data-id]').forEach(tr=>{
				tr.addEventListener('click', async ()=>{
					const id=tr.getAttribute('data-id');
					await this.openModal(id);
				});
			});
		}
		
		async openModal(id){
			const rec=this.allRequests.find(r=>r.id===id);
			if(!rec) return;
			// Resolve employee ID for display
			try { await this.ensureCompanyUsersLoaded(); await this.getRequesterEmployeeId(rec); } catch(_e) {}
			
			const m=this.modal;
			
			if(m.title) m.title.textContent=`Gate Pass Request ${rec.referenceNumber||rec.id}`;
			if(m.body) m.body.innerHTML=this.buildModalContent(rec);
			
			if(m.edit){
				const can=this.canEdit(rec);
				m.edit.style.display= can? 'inline-flex':'none';
				m.edit.onclick=()=>{
					location.href=`access.html?id=${rec.id}`;
				};
			}
			
			// Show loading state for buttons first
			const modalFooter = m.root?.querySelector('.modal-footer');
			if (modalFooter) {
				modalFooter.innerHTML = `
					<button type="button" class="btn btn-secondary" disabled>
						<i class="fas fa-spinner fa-spin"></i> Loading...
					</button>
				`;
			}
			
			// Show modal first
			m.root.classList.remove('hidden');
			m.root.removeAttribute('aria-hidden');
			document.body.style.overflow='hidden';
			
			// Then load buttons asynchronously
			await this.updateModalActionButtons(rec);
		}

		// ===== Tab Logic =====
		switchTab(tabId){
			document.querySelectorAll('.tab-btn').forEach(b=> b.classList.toggle('active', b.dataset.tab===tabId));
			document.querySelectorAll('.tab-content').forEach(p=> p.classList.toggle('active', p.id===tabId));
		}

		// Dynamically load a script if not present
		_loadScriptOnce(src){ return new Promise((resolve,reject)=>{ if(document.querySelector(`script[src="${src}"]`)){ resolve(); return; } const s=document.createElement('script'); s.src=src; s.onload=()=>resolve(); s.onerror=()=>reject(new Error('Failed to load '+src)); document.head.appendChild(s); }); }

		// Export the Gate Pass modal A4 sheet as PDF (same display as leave details modal)
		async exportModalA4AsPdf(rec){
			try{
				// Allow passing an ID string; resolve to record
				if (rec && typeof rec === 'string') {
					const found = this.allRequests?.find(r=>r.id===rec);
					if (found) rec = found; else rec = { id: rec };
				}
				const originalContainer = this.modal.root?.querySelector('.a4-sheet');
				if(!originalContainer){ alert('Nothing to export'); return; }
				
				// Wait for approval flow to finish loading (check if still showing loading spinner)
				const approvalContent = originalContainer.querySelector('#approvalFlowContent');
				if (approvalContent && approvalContent.classList.contains('approval-flow-loading')) {
					console.log('ðŸ”„ Waiting for approval flow to load...');
					// Wait up to 5 seconds for approval flow to load
					let attempts = 0;
					while (approvalContent.classList.contains('approval-flow-loading') && attempts < 50) {
						await new Promise(resolve => setTimeout(resolve, 100));
						attempts++;
					}
					if (attempts >= 50) {
						console.warn('âš ï¸ Approval flow still loading after 5 seconds, proceeding with export');
					} else {
						console.log('âœ… Approval flow loaded, proceeding with export');
					}
				}
				
				// Ensure libs
				if(!window.jspdf){ await this._loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'); }
				if(!window.html2canvas){ await this._loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'); }

				// Clone the container to a fixed off-screen element for proper rendering
				const clone = originalContainer.cloneNode(true);
				clone.style.cssText = `
					position: fixed !important;
					left: 0 !important;
					top: 0 !important;
					width: 794px !important;
					min-height: auto !important;
					padding: 20px !important;
					margin: 0 !important;
					background: #ffffff !important;
					box-shadow: none !important;
					border: none !important;
					border-radius: 0 !important;
					z-index: 99999 !important;
					transform: none !important;
					opacity: 1 !important;
					visibility: visible !important;
					overflow: visible !important;
				`;
				
				// Remove any hidden/collapsed elements and ensure all text is visible
				clone.querySelectorAll('*').forEach(el => {
					const style = window.getComputedStyle(el);
					if (style.display === 'none' || style.visibility === 'hidden' || style.opacity === '0') {
						el.style.display = el.tagName === 'SPAN' ? 'inline' : 'block';
						el.style.visibility = 'visible';
						el.style.opacity = '1';
					}
				});
				
				document.body.appendChild(clone);
				
				// Wait for fonts and images to load
				await document.fonts?.ready;
				await new Promise(resolve => setTimeout(resolve, 200));
				
				// Debug: log content before capture
				console.log('ðŸ“„ Content to capture:', clone.innerText.substring(0, 200), '...');
				console.log('ðŸ“ Clone dimensions:', clone.scrollWidth, 'x', clone.scrollHeight);
				
				// Inline images to avoid CORS/taint issues
				const imgs = Array.from(clone.querySelectorAll('img'));
				const toDataUrl = async (url)=>{
					try {
						const res = await fetch(url, {mode:'cors', credentials:'omit'});
						const blob = await res.blob();
						return await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(blob); });
					} catch(e) { return null; }
				};
				for(const img of imgs){
					try{
						const src = img.getAttribute('src')||'';
						if(!src || src.startsWith('data:')) continue;
						const dataUrl = await toDataUrl(src);
						if(dataUrl) img.setAttribute('src', dataUrl);
					}catch(e){ /* skip image on failure */ }
				}

				// Render cloned container to canvas at high quality
				let canvas = await window.html2canvas(clone, { 
					scale: 2, 
					backgroundColor: '#ffffff', 
					useCORS: true, 
					allowTaint: true, 
					logging: true,
					width: 794,
					height: clone.scrollHeight,
					windowWidth: 794,
					windowHeight: clone.scrollHeight,
					x: 0,
					y: 0,
					scrollX: 0,
					scrollY: 0
				});

				// If canvas is unexpectedly empty or tiny, try fallback capture strategies
				try {
					const tooSmall = !canvas || canvas.width < 10 || canvas.height < 10;
					let allWhite = false;
					if (!tooSmall) {
						const ctx = canvas.getContext('2d');
						const sample = ctx.getImageData(Math.min(1, canvas.width-1), Math.min(1, canvas.height-1), 1, 1).data;
						// Check if sample pixel is fully white and opaque
						allWhite = (sample[0] === 255 && sample[1] === 255 && sample[2] === 255 && sample[3] === 255);
					}
					if (tooSmall || allWhite) {
						console.warn('âš ï¸ Primary capture looked blank; trying modal-body fallback');
						const modalBody = this.modal.root?.querySelector('.modal-body');
						if (modalBody) {
							canvas = await window.html2canvas(modalBody, {
								scale: 2,
								backgroundColor: '#ffffff',
								useCORS: true,
								allowTaint: true,
								logging: true,
								windowWidth: modalBody.scrollWidth,
								windowHeight: modalBody.scrollHeight
							});
						}
					}
					// If still problematic, rebuild content into a temporary container and capture
					if (!canvas || canvas.width < 10 || canvas.height < 10) {
						console.warn('âš ï¸ Modal-body fallback failed; rebuilding A4 content for capture');
						const temp = document.createElement('div');
						temp.style.cssText = 'position:fixed;left:0;top:0;width:794px;background:#fff;z-index:99999;padding:20px;';
						temp.innerHTML = this.buildModalContent(rec);
						document.body.appendChild(temp);
						const a4temp = temp.querySelector('.a4-sheet') || temp;
						canvas = await window.html2canvas(a4temp, {
							scale: 2,
							backgroundColor: '#ffffff',
							useCORS: true,
							allowTaint: true,
							logging: true,
							width: 794,
							windowWidth: 794
						});
						document.body.removeChild(temp);
					}
				} catch(e) {
					console.warn('âš ï¸ Fallback capture encountered an error:', e);
				}
				
				// Remove the clone
				document.body.removeChild(clone);

				const imgData = canvas.toDataURL('image/png');
				const pdf = new window.jspdf.jsPDF({ unit: 'pt', format: 'a4', orientation: 'portrait' });
				const pageWidth = pdf.internal.pageSize.getWidth();  // 595.28pt
				const pageHeight = pdf.internal.pageSize.getHeight(); // 841.89pt
				const margin = 20;
				const imgWidth = pageWidth - margin * 2;
				const imgHeight = (canvas.height * imgWidth) / canvas.width;
				const pageContentHeight = pageHeight - margin * 2;

				console.log('ðŸ“ PDF dimensions:', { imgHeight, pageContentHeight, canvasHeight: canvas.height });

				// Force single page to avoid empty pages - scale content if needed
				let finalImgWidth = imgWidth;
				let finalImgHeight = imgHeight;
				
				// If content is too tall for one page, scale it down proportionally
				if (imgHeight > pageContentHeight) {
					const scaleFactor = pageContentHeight / imgHeight;
					finalImgHeight = pageContentHeight;
					finalImgWidth = imgWidth * scaleFactor;
					console.log('ðŸ“ Content scaled down:', { scaleFactor, finalImgWidth, finalImgHeight });
				}
				
				// Center horizontally if scaled
				const xOffset = margin + (imgWidth - finalImgWidth) / 2;
				pdf.addImage(imgData, 'PNG', xOffset, margin, finalImgWidth, finalImgHeight);

				const filename = `gate_pass_${rec?.referenceNumber || rec?.id || 'modal'}.pdf`;
				pdf.save(filename);
				console.log('âœ… PDF exported successfully:', filename);
			} catch(err){
				console.error('Export modal PDF failed', err);
				alert('Failed to export PDF: ' + (err.message||err));
			}
		}
		buildModalContent(rec){ 
			const esc=s=>this.escape(s); 
			const visitors=Array.isArray(rec.visitors)? rec.visitors:[]; 
			const equipment=Array.isArray(rec.equipment)? rec.equipment:[]; 
			const attList=arr=>{ 
				if(!arr||arr.length===0) return '<span style="opacity:.6;">None</span>'; 
				const iconFor=(nameOrUrl)=>{ 
					const n=String(nameOrUrl||''); 
					const m=n.match(/\.([a-zA-Z0-9]+)(?:\?|#|$)/); 
					const ext=(m&&m[1]||'').toLowerCase(); 
					let cls='fa-file', color='#6b7280'; 
					if(['png','jpg','jpeg','gif','bmp','webp','svg'].includes(ext)){ cls='fa-file-image'; color='#3b82f6'; } 
					else if(['pdf'].includes(ext)){ cls='fa-file-pdf'; color='#ef4444'; } 
					else if(['doc','docx'].includes(ext)){ cls='fa-file-word'; color='#2563eb'; } 
					else if(['xls','xlsx','csv'].includes(ext)){ cls='fa-file-excel'; color='#16a34a'; } 
					else if(['ppt','pptx'].includes(ext)){ cls='fa-file-powerpoint'; color='#f97316'; } 
					else if(['zip','rar','7z','tar','gz','bz2'].includes(ext)){ cls='fa-file-archive'; color='#a16207'; } 
					else if(['txt','md','log','rtf'].includes(ext)){ cls='fa-file-alt'; color='#6b7280'; } 
					return { cls, color }; 
				}; 
				return `<div class="attachments">${arr.map(a=>{ 
					const nm = a.name||'file'; 
					const sz = (typeof a.size==='number'?a.size:parseInt(a.size)||0); 
					const hint = `${esc(nm)}${ sz? ` (${this.humanSize(sz)})`:''}`; 
					const {cls,color}=iconFor(a.name||a.url||''); 
					return `<a class="attachment-chip" href="${a.url||'#'}" target="_blank" rel="noopener" title="${hint}" style="display:inline-block;margin-right:6px;"><i class="fas ${cls}" style="color:${color};font-size:16px;"></i></a>`; 
				}).join('')}</div>`; 
			}; 
			
			const visitorRows= visitors.map((v,i)=>{ 
				const vatts= Array.isArray(v.attachments)? v.attachments : (v.attachment? [v.attachment]: []); 
				const s = this.fmtDate(v.startDateTime||v.startDate||v.start) || '-'; 
				const e = this.fmtDate(v.endDateTime||v.endDate||v.end) || '-'; 
				const rng = (s==='-'&&e==='-')? '-' : `${s} â€” ${e}`; 
				return `<tr><td>${i+1}</td><td>${esc(v.name||'')}</td><td>${esc(v.identification||v.idNumber||v.visitorId||v.id||'')}</td><td>${esc(v.company||'')}</td><td>${esc(v.area||'')}</td><td>${esc(rng)}</td><td>${vatts.length? attList(vatts):'<span style="opacity:.5;">-</span>'}</td></tr>`; 
			}).join(''); 
			
			const equipRows= equipment.map((e,i)=>{ 
				return `<tr><td>${i+1}</td><td>${esc(e.name||e.item||'')}</td><td>${esc(e.description||'')}</td></tr>`; 
			}).join(''); 
			
			const toBeRetDisp = (rec.toBeReturned===true||String(rec.toBeReturned).toLowerCase()==='yes')?'Yes':((rec.toBeReturned===false||String(rec.toBeReturned).toLowerCase()==='no')?'No':'-');
			const statusClass = (rec.status||'').toLowerCase().replace(/[^a-z]/g,'');

			// Resolve line manager name and job title for requester info
			const lineManagerName = this.getApproverDisplayName(rec) || '';
			let lineManagerTitle = '';
			if (rec.requesterLineManagerTitle) {
				lineManagerTitle = esc(String(rec.requesterLineManagerTitle).trim());
			} else {
				try {
					const companyUsers = this.companyUsersCache || {};
					const submitterUid = rec.submittedBy || rec.createdBy || rec.userId;
					const submitter = submitterUid ? companyUsers[submitterUid] : null;
					if (submitter && submitter.lineManagerId && companyUsers[submitter.lineManagerId]) {
						const manager = companyUsers[submitter.lineManagerId];
						const titleRaw = (manager?.jobTitle || manager?.title || manager?.jobTitleName || manager?.position || manager?.designation || manager?.role || '').trim();
						lineManagerTitle = titleRaw ? esc(titleRaw) : '';
					}
				} catch(_e) { /* ignore */ }
			}
			const lineManagerDisplay = lineManagerTitle ? `${lineManagerName} â€” ${lineManagerTitle}` : (lineManagerName || '-');
			
			// Get company info for header - use currentCompany for logo
			const companyName = window.authManager?.currentCompany?.companyName || window.authManager?.currentUser?.companyName || 'Company';
			const companyLogo = window.authManager?.currentCompany?.logo || window.authManager?.currentCompany?.logoUrl || '';
			const logoInitials = companyName.split(' ').filter(w=>w).map(w=>w[0]).join('').substring(0,2).toUpperCase() || 'CO';
			
			// Generate SVG initials if no logo available (same as AuthManager)
			const generateInitialsSVG = (initials) => {
				const svg = `<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><rect width="100" height="100" rx="8" fill="#f8fafc"/><text x="50%" y="52%" dominant-baseline="middle" text-anchor="middle" fill="#495057" font-family="Inter,Arial,sans-serif" font-weight="600" font-size="32">${initials}</text></svg>`;
				return 'data:image/svg+xml;base64,' + btoa(svg);
			};
			const logoSrc = companyLogo || generateInitialsSVG(logoInitials);
			
			return `
<div class="a4-sheet printable">
	<div class="a4-header">
		<div class="company-block">
			<img src="${logoSrc}" class="a4-logo" alt="Company Logo" onerror="this.src='${generateInitialsSVG(logoInitials)}';" />
			<div class="a4-company">
				<h1>${esc(companyName)}</h1>
				<h2 class="doc-title">Gate Pass Request</h2>
			</div>
		</div>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title requester-section"><i class="fas fa-user-circle"></i><span class="section-text">Requester Information</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<tbody>
				<tr>
					<td style="width:50%;" colspan="2"><strong>Name:</strong> ${esc(rec.requesterName||'-')}</td>
					<td style="width:50%;" colspan="2"><strong>Employee ID:</strong> ${esc(rec._displayEmployeeId||'-')}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Department:</strong> ${esc(rec.departmentName||'-')}</td>
					<td colspan="2"><strong>Phone:</strong> ${esc(rec.contactPhone||'-')}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Company:</strong> ${esc(rec.companyName||'-')}</td>
					<td colspan="2"><strong>Line Manager:</strong> ${lineManagerDisplay}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Property Removal:</strong> ${esc(rec.propertyRemoval||'-')}</td>
					<td colspan="2"><strong>To be Returned:</strong> ${toBeRetDisp}</td>
				</tr>
				<tr>
					<td colspan="2"><strong>Created:</strong> ${esc(this.fmtDate(rec.createdAt)||'-')}</td>
					<td colspan="2"><strong>Status:</strong> ${this.statusBadge((rec.isReleased === true && rec.status !== 'approved' && rec.status !== 'rejected') ? 'released' : rec.status)}</td>
				</tr>
				${rec.isReleased ? `<tr>
					<td colspan="2"><strong>Released By:</strong> ${esc(rec.releasedByName || '-')}</td>
					<td colspan="2"><strong>Released At:</strong> ${esc(this.fmtDate(rec.releasedAt) || '-')}</td>
				</tr>` : ''}
			</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title visitors-section"><i class="fas fa-users"></i><span class="section-text">People / Visitors</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<thead><tr><th>#</th><th>Name</th><th>ID</th><th>Company</th><th>Area</th><th>Dates</th><th>Files</th></tr></thead>
			<tbody>${visitorRows||'<tr><td colspan="7" style="text-align:center;opacity:.6;">No visitors</td></tr>'}</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title equipment-section"><i class="fas fa-toolbox"></i><span class="section-text">Equipment</span></div>
		<table class="a4-info-table" style="margin-top:8px;">
			<thead><tr><th>#</th><th>Name</th><th>Description</th></tr></thead>
			<tbody>${equipRows||'<tr><td colspan="3" style="text-align:center;opacity:.6;">No equipment</td></tr>'}</tbody>
		</table>
	</div>
	
	<div class="a4-section">
		<div class="a4-section-title purpose-section"><i class="fas fa-clipboard"></i><span class="section-text">Purpose</span></div>
		<div style="background:#f9fafb;border:1px solid #d1d5db;padding:10px 12px;min-height:40px;font-size:.74rem;line-height:1.5;color:#374151;margin-top:8px;">${esc(rec.purpose|| rec.reason || '')||'<span style="opacity:.6;">Not specified</span>'}</div>
	</div>
	
	${this.buildApprovalFlowSection(rec)}
</div>
`; }
		buildApprovalFlowSection(rec){
			console.log('ðŸ”„ Building approval flow section for:', rec.id);
			
			// Always load approval flow configuration asynchronously
			// Use setTimeout to ensure DOM is ready
			setTimeout(() => {
				this.loadApprovalFlowAsync(rec);
			}, 100);
			
			return `
<div class="a4-section">
	<div class="a4-section-title approval-section"><i class="fas fa-stamp"></i><span class="section-text">Approval Flow & History</span></div>
	<div id="approvalFlowContent" class="approval-flow-loading" style="padding:10px;text-align:center;color:#6b7280;margin-top:8px;">
		<i class="fas fa-spinner fa-spin"></i> Loading approval configuration...
	</div>
</div>`;
		}
		
		async loadApprovalFlowAsync(rec) {
			console.log('ðŸ”„ Loading approval flow for request:', rec.id);
			
			try {
				const companyId = window.authManager?.currentUser?.companyId;
				console.log('ðŸ¢ Company ID:', companyId);
				
				if (!companyId) {
					console.error('âŒ No company context available');
					this.updateApprovalFlowContent(`
						<div class="no-approval-flow">
							<i class="fas fa-exclamation-triangle"></i>
							<h4>No Company Context</h4>
							<p>Unable to load approval flow - no company context available.</p>
						</div>`);
					return;
				}
				
				// Fetch approval flow configuration from Firebase
				console.log('ðŸ“¡ Fetching approval flow config from:', `companies/${companyId}/approvalFlows/access`);
				const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
				const snapshot = await approvalFlowRef.once('value');
				const config = snapshot.val();
				
				console.log('ðŸ“‹ Approval flow config:', config);
				
				if (!config) {
					console.log('ðŸ“‹ No approval flow configuration found');
					this.updateApprovalFlowContent(`
						<div class="no-approval-flow">
							<i class="fas fa-info-circle"></i>
							<h4>No Approval Flow Configured</h4>
							<p>Access request approval flow is not configured for this company.</p>
						</div>`);
					return;
				}
				
				if (!config.enabled) {
					console.log('ðŸ“‹ Approval flow is disabled');
					this.updateApprovalFlowContent(`
						<div class="no-approval-flow">
							<i class="fas fa-info-circle"></i>
							<h4>Approval Flow Disabled</h4>
							<p>Access request approval flow is currently disabled.</p>
						</div>`);
					return;
				}
				
				// Generate approval flow HTML with actual configuration
				console.log('ðŸŽ¨ Generating approval flow HTML');
				const approvalHTML = await this.generateApprovalFlowHTML(rec, config, { showTable: true });
				this.updateApprovalFlowContent(approvalHTML);
				console.log('âœ… Approval flow loaded successfully');
				
			} catch (error) {
				console.error('âŒ Error loading approval flow:', error);
				this.updateApprovalFlowContent(`
					<div class="approval-flow-error">
						<i class="fas fa-exclamation-triangle"></i>
						<h4>Failed to Load Approval Flow</h4>
						<p>Error: ${error.message || 'Unknown error occurred'}</p>
					</div>`);
			}
		}
		
		updateApprovalFlowContent(html) {
			console.log('ðŸ”„ Updating approval flow content');
			const container = document.getElementById('approvalFlowContent');
			if (container) {
				container.innerHTML = html;
				container.className = ''; // Remove loading class
				console.log('âœ… Approval flow content updated');
			} else {
				console.error('âŒ Could not find approvalFlowContent container');
			}
		}
		
		async generateApprovalFlowHTML(rec, config, options = {}) {
			console.log('ðŸŽ¨ Generating approval flow HTML for:', rec.id);
			console.log('ðŸ“‹ Config:', config);
			
			try {
				const status = rec.status || rec.approvalStatus;
				const approvalHistory = rec.approvalHistory || [];
				const companyId = window.authManager?.currentUser?.companyId;
				
				// Determine overall approval status
				let flowStatus = 'pending';
				let flowStatusText = 'Pending';
				let flowStatusClass = 'pending';
				
				if (status === 'approved') {
					flowStatus = 'approved';
					flowStatusText = 'Approved';
					flowStatusClass = 'approved';
				} else if (status === 'rejected') {
					flowStatus = 'rejected';
					flowStatusText = 'Rejected';
					flowStatusClass = 'rejected';
				}
				
				// Fetch company users to resolve approver names
				let companyUsers = {};
				try {
					if (companyId) {
						console.log('ðŸ‘¥ Fetching company users from:', `companies/${companyId}/users`);
						const usersSnapshot = await firebase.database().ref(`companies/${companyId}/users`).once('value');
						companyUsers = usersSnapshot.val() || {};
						console.log('ðŸ¢ Fetched company users for approval flow:', Object.keys(companyUsers).length);
					}
				} catch (error) {
					console.error('Error fetching company users:', error);
				}

				// Helpers to resolve approver display (prefer full name + job title over raw email)
				const findUserByEmail = (email) => {
					if (!email) return null;
					const target = String(email).toLowerCase();
					for (const uid in companyUsers) {
						const u = companyUsers[uid];
						if (u && String(u.email || '').toLowerCase() === target) {
							return { uid, ...u };
						}
					}
					return null;
				};
				const findUserByName = (name) => {
					if (!name) return null;
					const target = String(name).trim().toLowerCase();
					for (const uid in companyUsers) {
						const u = companyUsers[uid];
						const n = (u?.name || u?.displayName || u?.fullName || '').trim().toLowerCase();
						if (n && n === target) {
							return { uid, ...u };
						}
					}
					return null;
				};
				const resolveApproverFromHistory = (h) => {
					let user = null;
					if (h && (h.approverId || h.approvedBy)) {
						user = companyUsers[h.approverId || h.approvedBy] || null;
					}
					if (!user && h && h.approverEmail) {
						user = findUserByEmail(h.approverEmail);
					}
					const name = (user?.name || user?.displayName || h?.approverName || '').trim() || 'Approver';
					let title = (user?.jobTitle || user?.title || user?.jobTitleName || user?.position || user?.designation || '').trim();
					// Format job title - convert hyphenated values to title case
					title = formatJobTitle(title);
					// IMPORTANT: Don't use title if it's the same as the name
					if (title && title.toLowerCase() === name.toLowerCase()) {
						title = '';
					}
					return { user, name, title, display: title ? `${name} â€” ${title}` : name };
				};
				// Helper: Format job title - convert hyphenated values to title case (e.g., 'hse-manager' -> 'HSE Manager')
				const formatJobTitle = (value) => {
					if (!value || value === '-') return '';
					return value.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
				};
				
				// Helper: best-effort job title resolver from company management user record
				const getUserJobTitle = (u) => {
					// NOTE: Exclude 'role' as it sometimes contains the user's name, not their job title
					const rawTitle = (u?.jobTitle || u?.title || u?.jobTitleName || u?.position || u?.designation || '').trim();
					return formatJobTitle(rawTitle);
				};
				
				// Build approval stages from configuration
				let stagesHTML = '';
				const isSequential = config.approvalOrder === 'sequential';
				
				if (config.selectedRoles && typeof config.selectedRoles === 'object') {
					const levelKeys = Object.keys(config.selectedRoles).sort();
					console.log('ðŸ“Š Processing approval levels:', levelKeys);
					
					for (let i = 0; i < levelKeys.length; i++) {
						const levelKey = levelKeys[i];
						const levelNumber = i + 1;
						const levelConfig = config.selectedRoles[levelKey];
						
						console.log(`ðŸ“‹ Processing level ${levelNumber}:`, levelConfig);
						
						// Find approval record for this level
						const approvalRecord = approvalHistory.find(h => 
							h.level === levelKey || 
							h.level === levelNumber || 
							h.approvalLevel === levelNumber
						);
						
						// For sequential approval, check if this level is available
						let isLevelAvailable = true;
						let isLevelLocked = false;
						
						if (isSequential) {
							// Check if all previous levels are approved
							for (let j = 0; j < i; j++) {
								const prevLevelKey = levelKeys[j];
								const prevLevelNumber = j + 1;
								const prevApprovalRecord = approvalHistory.find(h => 
									h.level === prevLevelKey || 
									h.level === prevLevelNumber || 
									h.approvalLevel === prevLevelNumber
								);
								
								if (!prevApprovalRecord || prevApprovalRecord.status !== 'approved') {
									isLevelAvailable = false;
									isLevelLocked = true;
									break;
								}
							}
						}
						
						// Determine stage status
						let stageClass = 'pending';
						let statusText = 'Pending';
						let numberClass = 'pending';
						let iconHTML = levelNumber;
						let approverName = 'Unknown Approver';
						let approverTitle = '';
						let timestamp = '';
						let comments = '';
						
						// Handle locked state for sequential approval
						if (isSequential && isLevelLocked && !approvalRecord) {
							stageClass = 'locked';
							statusText = 'Locked - Waiting for Previous Level';
							numberClass = 'locked';
							iconHTML = '<i class="fas fa-lock"></i>';
						}
						
						// Get approver information from company users
						if (Array.isArray(levelConfig) && levelConfig.length > 0) {
							const approverConfig = levelConfig[0];
							const approverId = approverConfig.value || approverConfig.uid;
							
							console.log(`ðŸ‘¤ Resolving approver ${approverId} for level ${levelNumber}`);
							
							// Check if this is a level-based approver (L+1, L+2, etc.)
							if (approverId && approverId.startsWith && approverId.startsWith('L+')) {
								// For L+1, get the submitter's line manager name using same logic as getApproverDisplayName
								if (approverId === 'L+1') {
									// Use the existing getApproverDisplayName method to get consistent results
									const lineManagerDisplayName = this.getApproverDisplayName(rec);
									if (lineManagerDisplayName && lineManagerDisplayName !== '') {
										approverName = lineManagerDisplayName;
									} else {
										approverName = `Line Manager (L+1)`;
									}
									
									// Get line manager's job title from company management data (prefer actual user record)
									const submitterUid = rec.submittedBy || rec.createdBy || rec.userId;
									if (submitterUid && companyUsers[submitterUid]) {
										const submitter = companyUsers[submitterUid];
										const manager = (submitter.lineManagerId && companyUsers[submitter.lineManagerId]) ? companyUsers[submitter.lineManagerId] : null;
										const savedTitle = (rec.requesterLineManagerTitle || '').trim();
										const managerTitle = savedTitle || getUserJobTitle(manager);
										// ONLY use actual job title from user record, NOT config.text (it's usually the name)
										if (managerTitle && managerTitle.toLowerCase() !== (approverName || '').toLowerCase()) {
											approverTitle = managerTitle;
										} else {
											approverTitle = 'Line Manager';
										}
										if (managerTitle && !savedTitle) console.log(`âœ… Got line manager job title from company data: ${managerTitle}`);
									} else {
										approverTitle = 'Line Manager';
									}
								} else {
									approverName = `Line Manager (${approverId})`;
									approverTitle = 'Line Manager';
								}
							} else if (approverId && companyUsers[approverId]) {
								const approverData = companyUsers[approverId];
								approverName = approverData.name || approverData.displayName || approverConfig.text || 'Unknown Approver';
								const rawTitleCandidate = (approverData.jobTitle || approverData.position || approverData.designation || '').trim();
								const titleCandidate = formatJobTitle(rawTitleCandidate);
								// Only use title if it's different from the name
								approverTitle = (titleCandidate && titleCandidate.toLowerCase() !== (approverName || '').toLowerCase()) ? titleCandidate : '';
								console.log(`âœ… Resolved approver: ${approverName} (${approverTitle})`);
							} else {
								// Fallback to config text/email if user not found; try resolving by email or name for title
								approverName = approverConfig.text || approverConfig.value || 'Unknown Approver';
								approverTitle = ''; // Start with empty title
								let resolved = null;
								if (approverConfig.email) {
									resolved = findUserByEmail(approverConfig.email);
								}
								if (!resolved && approverName) {
									resolved = findUserByName(approverName);
								}
								if (resolved) {
									const rawResolvedTitle = (resolved.jobTitle || resolved.title || resolved.jobTitleName || resolved.position || resolved.designation || '').trim();
									const resolvedTitle = formatJobTitle(rawResolvedTitle);
									// Only use title if it's different from the name
									if (resolvedTitle && resolvedTitle.toLowerCase() !== (approverName || '').toLowerCase()) {
										approverTitle = resolvedTitle;
									}
								}
							}
						}
						
						if (approvalRecord) {
							if (approvalRecord.status === 'approved') {
								stageClass = 'completed';
								statusText = 'Approved';
								numberClass = 'completed';
								iconHTML = '<i class="fas fa-check"></i>';
								// Prefer resolved directory info over raw email/name, but keep company job title if already set
								{ const r = resolveApproverFromHistory(approvalRecord); approverName = r.name || approverName; if (!approverTitle) approverTitle = r.title || approverTitle; }
								timestamp = approvalRecord.approvedAt || approvalRecord.timestamp;
								comments = approvalRecord.comments;
							} else if (approvalRecord.status === 'rejected') {
								stageClass = 'rejected';
								statusText = 'Rejected';
								numberClass = 'rejected';
								iconHTML = '<i class="fas fa-times"></i>';
								{ const r = resolveApproverFromHistory(approvalRecord); approverName = r.name || approverName; if (!approverTitle) approverTitle = r.title || approverTitle; }
								timestamp = approvalRecord.rejectedAt || approvalRecord.timestamp;
								comments = approvalRecord.reason || approvalRecord.comments;
							}
						}

						// Ensure a non-empty title for display
						if (!approverTitle) approverTitle = 'Approver';
						
						stagesHTML += `
							<div class="approval-stage ${stageClass}">
								<div class="stage-number ${numberClass}">${iconHTML}</div>
								<div class="stage-info">
									<div class="stage-title">Level ${levelNumber} - ${approverName}${approverTitle ? ` â€” ${this.escape(approverTitle)}` : ''}</div>
									<div class="approver-info">
										${(!options.hideActual && approverTitle) ? `<div class="approver-title">${this.escape(approverTitle)}</div>` : ''}
										<div class="stage-status-text ${stageClass}">${statusText}</div>
									</div>
									${timestamp ? `<div class="stage-timestamp"><i class="fas fa-clock"></i> ${this.fmtDate(timestamp)}</div>` : ''}
									${comments ? `<div class="stage-comments"><strong>Comments:</strong> ${this.escape(comments)}</div>` : ''}
									${!options.compact && !options.hideActual && approvalRecord && (approvalRecord.status === 'approved' || approvalRecord.status === 'rejected') ? 
										`<div class="actual-approver-info" style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; border-left: 3px solid ${approvalRecord.status === 'approved' ? '#28a745' : '#dc3545'};">
											<div style="font-weight: 600; color: ${approvalRecord.status === 'approved' ? '#28a745' : '#dc3545'};">
												<i class="fas fa-${approvalRecord.status === 'approved' ? 'check' : 'times'}"></i> 
												${approvalRecord.status === 'approved' ? 'Approved' : 'Rejected'} by: ${(() => { const r = resolveApproverFromHistory(approvalRecord); return this.escape(r.display); })()}
											</div>
											<div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
												<i class="fas fa-clock"></i> ${this.fmtDate(approvalRecord.approvedAt || approvalRecord.rejectedAt || approvalRecord.timestamp)}
											</div>
											${approvalRecord.approverId || approvalRecord.approvedBy ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">ID: ${this.escape(approvalRecord.approverId || approvalRecord.approvedBy)}</div>` : ''}
											${approvalRecord.comments || approvalRecord.reason ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: ${approvalRecord.status === 'approved' ? '#d4edda' : '#f8d7da'}; border-radius: 3px;"><strong>Comments:</strong> ${this.escape(approvalRecord.comments || approvalRecord.reason)}</div>` : ''}
										</div>` : ''}
								</div>
							</div>`;
					}
				} else {
					console.log('âš ï¸ No selectedRoles found in config');
				}
			
				if (!stagesHTML) {
					stagesHTML = `
						<div class="approval-stage">
							<div class="stage-number pending">1</div>
							<div class="stage-info">
								<div class="stage-title">Review Stage</div>
								<div class="stage-status-text pending">Pending Review</div>
							</div>
						</div>`;
				}
				
				console.log('ðŸŽ¨ Generated approval flow HTML successfully');
				
				if(options.compact){
					// Minimal list representation without header title text
					const listItems = (rec.approvalHistory||[]).map((h,i)=>{
						const st = (h.status||'pending').toLowerCase();
						const r = resolveApproverFromHistory(h);
						const who = this.escape(r.display);
						const when = this.fmtDate(h.approvedAt || h.rejectedAt || h.timestamp) || '';
						return `<li><span class="status ${st}">${st.charAt(0).toUpperCase()+st.slice(1)}</span> by ${who}${when? ` â€” ${when}`:''}</li>`;
					}).join('') || '<li><span class="status pending">Pending</span></li>';
					return `<div class="approval-flow-simple"><ul class="approval-list">${listItems}</ul></div>`;
				}
				
				// Always show table format for modal (when showTable is true) or for A4 print format
				if (options.showTable || !options.compact) {
					// Build A4 table format for approval flow
					const approvalRows = [];
				if (config.selectedRoles && typeof config.selectedRoles === 'object') {
					const levelKeys = Object.keys(config.selectedRoles).sort();
					for (let i = 0; i < levelKeys.length; i++) {
						const levelKey = levelKeys[i];
						const levelNumber = i + 1;
						const levelConfig = config.selectedRoles[levelKey];
						const approvalRecord = approvalHistory.find(h => 
							h.level === levelKey || h.level === levelNumber || h.approvalLevel === levelNumber
						);
						
						let approverName = 'Unknown Approver';
						let approverTitle = '';
						let statusText = 'Pending';
						let statusClass = 'pending';
						let timestamp = '-';
						let signature = '-';
						
						// Get approver info
						if (Array.isArray(levelConfig) && levelConfig.length > 0) {
							const approverConfig = levelConfig[0];
							const approverId = approverConfig.value || approverConfig.uid;
							
							// Check if this is a level-based approver (L+1, L+2, etc.)
							if (approverId && approverId.startsWith && approverId.startsWith('L+')) {
								// For L+1, get the submitter's line manager name using same logic as getApproverDisplayName
								if (approverId === 'L+1') {
									// Use the existing getApproverDisplayName method to get consistent results
									const lineManagerDisplayName = this.getApproverDisplayName(rec);
									if (lineManagerDisplayName && lineManagerDisplayName !== '') {
										approverName = lineManagerDisplayName;
									} else {
										approverName = `Line Manager (L+1)`;
									}
									
									// Get line manager's job title from company management data
									const submitterUid = rec.submittedBy || rec.createdBy || rec.userId;
									if (submitterUid && companyUsers[submitterUid]) {
										const submitter = companyUsers[submitterUid];
										if (submitter.lineManagerId && companyUsers[submitter.lineManagerId]) {
											const manager = companyUsers[submitter.lineManagerId];
												const savedTitle = (rec.requesterLineManagerTitle || '').trim();
												const managerTitle = savedTitle || getUserJobTitle(manager);
												approverTitle = managerTitle || 'Line Manager';
										} else {
											approverTitle = 'Line Manager';
										}
									} else {
										approverTitle = 'Line Manager';
									}
								} else {
									approverName = `Line Manager (${approverId})`;
									approverTitle = 'Line Manager';
								}
							} else if (approverId && companyUsers[approverId]) {
								const approverData = companyUsers[approverId];
								approverName = approverData.name || approverData.displayName || approverConfig.text || 'Unknown';
								// Prefer company directory job title first - ONLY use actual job title fields
								const rawTitleFromUser = (approverData.jobTitle || approverData.title || approverData.jobTitleName || approverData.position || approverData.designation || '').trim();
								const titleFromUser = formatJobTitle(rawTitleFromUser);
								// IMPORTANT: Only set title if it exists and is NOT the same as the name
								if (titleFromUser && titleFromUser.toLowerCase() !== (approverName || '').toLowerCase()) {
									approverTitle = titleFromUser;
								} else {
									// No job title found - leave empty, do NOT use config.text (it's often the name)
									approverTitle = '';
								}
							} else {
								// Approver not found in companyUsers - try to resolve by email/name
								approverName = approverConfig.text || approverConfig.value || 'Unknown';
								approverTitle = ''; // Start with empty title
								
								// Try resolving user by email or name to get their job title
								let resolved = null;
								if (approverConfig.email) {
									resolved = findUserByEmail(approverConfig.email);
								}
								if (!resolved && approverName) {
									resolved = findUserByName(approverName);
								}
								if (resolved) {
									const rawResolvedTitle = (resolved.jobTitle || resolved.title || resolved.jobTitleName || resolved.position || resolved.designation || '').trim();
									const resolvedTitle = formatJobTitle(rawResolvedTitle);
									// Only use title if it's different from the name
									if (resolvedTitle && resolvedTitle.toLowerCase() !== (approverName || '').toLowerCase()) {
										approverTitle = resolvedTitle;
									}
								}
							}
						}
						
						if (approvalRecord) {
							if (approvalRecord.status === 'approved') {
								statusText = 'Approved';
								statusClass = 'approved';
										const r = resolveApproverFromHistory(approvalRecord);
										approverName = r.name || approverName;
										if (!approverTitle) approverTitle = r.title || approverTitle;
								timestamp = this.fmtDate(approvalRecord.approvedAt || approvalRecord.timestamp) || '-';
								
								// Get signature from user's signatureUrl in companyUsers
								const approverUserId = approvalRecord.approvedBy || approvalRecord.approverId || approvalRecord.userId || '';
								let signatureUrl = approvalRecord.signature || '';
								if (!signatureUrl && approverUserId && companyUsers[approverUserId]) {
									signatureUrl = companyUsers[approverUserId].signatureUrl || '';
								}
								// Fallback: try to find by name
								if (!signatureUrl && approverName) {
									const nameLower = approverName.toLowerCase();
									for (const [uid, userData] of Object.entries(companyUsers)) {
										const userName = (userData.name || userData.displayName || userData.fullName || '').toLowerCase();
										if (userName === nameLower && userData.signatureUrl) {
											signatureUrl = userData.signatureUrl;
											break;
										}
									}
								}
								// Only show signature image if URL is valid and not empty
								signature = (signatureUrl && signatureUrl.trim() && !signatureUrl.includes('undefined')) 
									? `<img src="${signatureUrl}" class="sig-img" style="max-width:100px;max-height:40px;" alt="${approverName} signature" onerror="this.style.display='none';"/>` 
									: '<span style="color:#10b981;"><i class="fas fa-check-circle"></i></span>';
							} else if (approvalRecord.status === 'rejected') {
								statusText = 'Rejected';
								statusClass = 'rejected';
										const r = resolveApproverFromHistory(approvalRecord);
										approverName = r.name || approverName;
										if (!approverTitle) approverTitle = r.title || approverTitle;
								timestamp = this.fmtDate(approvalRecord.rejectedAt || approvalRecord.timestamp) || '-';
								signature = '<span style="color:#ef4444;"><i class="fas fa-times-circle"></i></span>';
							}
						}

						// Ensure a non-empty title for display
						if (!approverTitle) approverTitle = 'Approver';
						
						approvalRows.push(`
							<tr>
								<td style="text-align:left;">
									<span class="approver-fullname">${this.escape(approverName)}</span><br>
									<span class="approver-job">${this.escape(approverTitle)}</span>
								</td>
								<td><span class="status-chip ${statusClass}">${statusText}</span></td>
								<td>${timestamp}</td>
								<td style="text-align:center;">${signature}</td>
							</tr>
						`);
					}
				}
				
				if (approvalRows.length === 0) {
					approvalRows.push(`<tr><td colspan="4" style="text-align:center;color:#6b7280;">No approval flow configured</td></tr>`);
				}

				console.log('ðŸ”§ Returning approval table with signature column, rows:', approvalRows.length);
				return `
					<table class="a4-info-table" style="width:100%;">
						<thead>
							<tr>
								<th style="text-align:left;width:40%;">Approver(s)</th>
								<th style="width:20%;text-align:center;">Status</th>
								<th style="width:25%;text-align:center;">Timestamp</th>
								<th style="width:15%;text-align:center;">Signature</th>
							</tr>
						</thead>
						<tbody>
							${approvalRows.join('')}
						</tbody>
					</table>`;
				}
				
				// Fallback to stage layout if table not requested
				return `<div class="approval-flow-stages">${stagesHTML}</div>`;
			} catch (error) {
				console.error('âŒ Error in generateApprovalFlowHTML:', error);
				return `
					<div class="approval-flow-error">
						<i class="fas fa-exclamation-triangle"></i>
						<h4>Error Generating Approval Flow</h4>
						<p>Error: ${error.message || 'Unknown error occurred'}</p>
					</div>`;
			}
		}
		async updateModalActionButtons(rec) {
			const modalFooter = this.modal.root?.querySelector('.modal-footer');
			if (!modalFooter) return;
			
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) return;
			
			const status = rec.status || 'submitted';
			const isApproved = status === 'approved';
			const isRejected = status === 'rejected';
			const isSubmitted = status === 'submitted';
			const isUpdated = status === 'updated';
			const isPendingApproval = status === 'pending_approval';
			const isReleased = rec.isReleased === true || status === 'released';
			const hasAnyApproval = Array.isArray(rec.approvalHistory) && rec.approvalHistory.some(h => h && (h.status === 'approved' || h.status === 'rejected'));
			
			// Check permissions
			const canEdit = this.canEdit(rec);
			const canApprove = await this.canApproveAsync(rec); // Use async approval check
			const canDelete = this.canDelete(rec);
			const canExport = true; // Basic export permission for all
			const canRelease = this.canRelease(rec); // Check if user can release the gate pass
			
			// Debug information
			console.log('Modal Action Buttons Debug:', {
				recordId: rec.id,
				recordStatus: status,
				currentUserRole: currentUser?.role,
				canEdit,
				canApprove,
				canDelete,
				canRelease,
				isSubmitted,
				isUpdated,
				isPendingApproval,
				isApproved,
				isRejected,
				isReleased
			});
			
			let buttons = `
				<button type="button" class="btn btn-secondary" id="modalCloseFooter" title="Close">
					<i class="fas fa-times"></i>
				</button>
			`;
			
			// Edit button - hide once any approval action has occurred
			if (canEdit && !isApproved && !isRejected && !hasAnyApproval) {
				buttons += `
					<button type="button" class="btn btn-primary" onclick="window.accessBoardManager.editAccessRequest('${rec.id}')" title="Edit Request">
						<i class="fas fa-edit"></i>
					</button>
				`;
			}
			
			// Delete button - hide once any approval action has occurred
			if (canDelete && !isApproved && !hasAnyApproval) {
				buttons += `
					<button type="button" class="btn btn-danger" onclick="window.accessBoardManager.deleteAccessRequest('${rec.id}')" title="Delete Request">
						<i class="fas fa-trash"></i>
					</button>
				`;
			}
			
			// Release button - show if user can release AND has permission AND gate pass is not yet released
			if (canRelease && window._canSeeReleaseButton === true && !isReleased && !isApproved && !isRejected) {
				buttons += `
					<button type="button" class="btn btn-info" onclick="window.accessBoardManager.releaseAccessRequest('${rec.id}')" title="Release for Approval" style="background:#0ea5e9;border-color:#0ea5e9;">
						<i class="fas fa-paper-plane"></i> Release
					</button>
				`;
			}
			
			// Approve button - show if user can approve AND request is released AND request is pending
			if (canApprove && isReleased && (isSubmitted || isUpdated || isPendingApproval || status === 'released')) {
				console.log('âœ… Adding Approve button for record:', rec.id);
				   buttons += `
					   <button type="button" class="btn btn-success" onclick="window.accessBoardManager.approveAccessRequest('${rec.id}')" title="Approve Request">
						   <i class="fas fa-check"></i>
					   </button>
				   `;
			} else {
				console.log('âŒ NOT adding Approve button:', { canApprove, isReleased, isSubmitted, isUpdated, status });
			}
			
			// Decline button - show if user can approve AND request is released AND request is pending
			if (canApprove && isReleased && (isSubmitted || isUpdated || isPendingApproval || status === 'released')) {
				console.log('âœ… Adding Decline button for record:', rec.id);
				   buttons += `
					   <button type="button" class="btn btn-warning" onclick="window.accessBoardManager.declineAccessRequest('${rec.id}')" title="Decline Request">
						   <i class="fas fa-times"></i>
					   </button>
				   `;
			} else {
				console.log('âŒ NOT adding Decline button:', { canApprove, isReleased, isSubmitted, isUpdated, status });
			}
			
			// Export/Print buttons - always show
			if (canExport) {
				buttons += `
					<button type="button" class="btn btn-secondary" onclick="event.stopPropagation(); window.print();" title="Print">
						<i class="fas fa-print"></i>
					</button>
				`;
			}
			
			modalFooter.innerHTML = buttons;
			
			// Re-attach close handler
			const closeBtn = modalFooter.querySelector('#modalCloseFooter');
			if (closeBtn) {
				closeBtn.addEventListener('click', () => {
					this.modal.root.classList.add('hidden');
					this.modal.root.setAttribute('aria-hidden', 'true');
					document.body.style.overflow = '';
				});
			}
		}
		canApprove(rec) {
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) return false;
			
			// For now, return false as we'll load the configuration asynchronously
			// This will be replaced by async approval check
			return false;
		}
		
		// New async method to check approval permissions based on configuration
		async canApproveAsync(rec) {
			console.log('ðŸ” canApproveAsync called for record:', rec.id);
			
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) {
				console.log('âŒ No current user found');
				return false;
			}
			
			console.log('ðŸ‘¤ Current user:', currentUser.email, 'Company:', currentUser.companyId);
			
			try {
				// Get approval flow configuration for access requests
				const approvalFlowRef = firebase.database().ref(`companies/${currentUser.companyId}/approvalFlows/access`);
				const snapshot = await approvalFlowRef.once('value');
				const approvalConfig = snapshot.val();
				
				console.log('ðŸ” Checking approval permissions for user:', currentUser.uid);
				console.log('ðŸ“‹ Approval config:', approvalConfig);
				
				if (!approvalConfig || !approvalConfig.enabled) {
					console.log('âŒ No approval configuration found or disabled');
					return false;
				}
				
				const isSequential = approvalConfig.approvalOrder === 'sequential';
				const levels = approvalConfig.levels || [];
				
				// Sort levels by level number to ensure proper order
				const sortedLevels = levels.sort((a, b) => (a.level || 0) - (b.level || 0));
				
				console.log(`ðŸ“Š Approval flow type: ${isSequential ? 'Sequential' : 'Parallel'}`);
				console.log('ðŸ“‹ Sorted approval levels:', sortedLevels.map(l => `Level ${l.level}: ${l.approverType}=${l.value}`));
				
				// Get current approval history from the request
				const approvalHistory = rec.approvalHistory || [];
				console.log('ðŸ“ Current approval history:', approvalHistory);
				
				for (const level of sortedLevels) {
					const canApproveAtLevel = await this.checkApprovalPermissionForLevel(level, currentUser, rec);
					console.log(`ðŸ” Can approve at level ${level.level}:`, canApproveAtLevel);
					
					if (canApproveAtLevel) {
						console.log(`ðŸ” User has permission for level ${level.level}`);
						
						if (isSequential) {
							// For sequential approval, check if this is the next level to approve
							const canApproveSequentially = await this.canApproveAtLevelSequentially(level, sortedLevels, approvalHistory, rec);
							if (canApproveSequentially) {
								console.log(`âœ… User can approve at level ${level.level} (sequential approval)`);
								return true;
							} else {
								console.log(`â³ Level ${level.level} is locked - waiting for previous levels to complete`);
							}
						} else {
							// For parallel approval, user can approve if they have permission and level hasn't been approved yet
							const hasBeenApproved = this.hasLevelBeenApproved(level.level, approvalHistory);
							if (!hasBeenApproved) {
								console.log(`âœ… User can approve at level ${level.level} (parallel approval)`);
								return true;
							} else {
								console.log(`âœ… Level ${level.level} already approved (parallel approval)`);
							}
						}
					}
				}
				
				console.log('âŒ User cannot approve at any level or all levels completed');
				return false;
				
			} catch (error) {
				console.error('Error checking approval permissions:', error);
				return false;
			}
		}
		
		// Check if user can approve at a level in sequential approval flow
		async canApproveAtLevelSequentially(targetLevel, sortedLevels, approvalHistory, rec) {
			const targetLevelNum = targetLevel.level || 0;
			
			// Check if all previous levels have been approved
			for (const level of sortedLevels) {
				const levelNum = level.level || 0;
				
				if (levelNum >= targetLevelNum) {
					// We've reached or passed the target level
					break;
				}
				
				// Check if this previous level has been approved
				const hasBeenApproved = this.hasLevelBeenApproved(levelNum, approvalHistory);
				if (!hasBeenApproved) {
					console.log(`â³ Cannot approve level ${targetLevelNum} - level ${levelNum} not yet approved`);
					return false;
				}
			}
			
			// Check if target level has already been approved
			const targetAlreadyApproved = this.hasLevelBeenApproved(targetLevelNum, approvalHistory);
			if (targetAlreadyApproved) {
				console.log(`âœ… Level ${targetLevelNum} already approved`);
				return false;
			}
			
			console.log(`âœ… All previous levels approved - can approve level ${targetLevelNum}`);
			return true;
		}
		
		// Check if a specific level has been approved in the approval history
		hasLevelBeenApproved(levelNum, approvalHistory) {
			return approvalHistory.some(entry => 
				(entry.level === levelNum || entry.approvalLevel === levelNum) && 
				entry.status === 'approved'
			);
		}
		
		// Check if user can approve at a specific level
		async checkApprovalPermissionForLevel(level, currentUser, rec) {
			const approverType = level.approverType;
			const approverValue = level.value;
			const userRole = (currentUser.role || '').toLowerCase();
			
			console.log(`ðŸ” Checking approval permission - Type: ${approverType}, Value: ${approverValue}, User Role: ${userRole}`);
			
			switch (approverType) {
				case 'function':
					// Check if user has the required function/role
					const requiredFunction = approverValue.replace('function_', '');
					const hasFunction = userRole.includes(requiredFunction) || 
						   ['admin', 'superadmin', 'company_admin'].some(r => userRole.includes(r));
					
					console.log(`ðŸ“‹ Function check - Required: ${requiredFunction}, Has permission: ${hasFunction}`);
					return hasFunction;
				
				case 'name':
					// Check if user is specifically named as approver (by UID, email, or actual name)
					const userId = approverValue.replace('user_', '');
					const currentUserName = (currentUser.name || currentUser.displayName || currentUser.fullName || '').trim().toLowerCase();
					const approverValueLower = String(approverValue || '').trim().toLowerCase();
					
					const isNamedApprover = currentUser.uid === userId || 
											currentUser.email === userId ||
											currentUser.email === approverValue ||
											(currentUserName && (currentUserName === approverValueLower || currentUserName === userId.toLowerCase()));
					
					console.log(`ðŸ‘¤ Name check - Required: ${approverValue}, User ID: ${currentUser.uid}, User Name: ${currentUserName}, Is named: ${isNamedApprover}`);
					return isNamedApprover;
				
				case 'level':
					// Enforce organizational hierarchy rules (e.g., L+1)
					try {
						const levelToken = String(approverValue || '').trim().toUpperCase();
						console.log(`ðŸ—ï¸ Level approval check - Token: ${levelToken}, Request ID: ${rec?.id}, Submitter: ${rec?.userId}`);
						
						// Strict L+1 rule: only the submitter's direct line manager can approve
						if (levelToken === 'L+1' || levelToken === 'L1') {
							const companyId = window.authManager?.currentUser?.companyId;
							if (!companyId) { 
								console.warn('âš ï¸ No company context for L+1 check'); 
								return false; 
							}
							
							console.log('ðŸ“Š L+1 Check - Company ID:', companyId);
							
							// Load company users cache
							const companyUsers = await this.ensureCompanyUsersLoaded();
							console.log('ðŸ‘¥ Company users loaded:', Object.keys(companyUsers).length, 'users');
							
							// Resolve the submitter (requester) UID
							const submitterUid = rec?.userId || rec?.requesterUserId || rec?.requesterUid || rec?.employeeUserId || null;
							console.log('ðŸ” Looking for submitter UID:', submitterUid);
							
							let submitter = (submitterUid && companyUsers[submitterUid]) ? companyUsers[submitterUid] : null;
							console.log('ðŸ‘¤ Found submitter by UID:', submitter ? 'YES' : 'NO');
							
							if (!submitter) {
								// Fallback by email if available
								const requesterEmail = String(rec?.requesterEmail || rec?.createdByEmail || rec?.createdBy || '').toLowerCase().trim();
								console.log('ðŸ“§ Trying email fallback for:', requesterEmail);
								
								if (requesterEmail) {
									for (const uid in companyUsers) {
										const u = companyUsers[uid] || {};
										if (String(u.email || '').toLowerCase().trim() === requesterEmail) { 
											submitter = u; 
											console.log('âœ… Found submitter by email:', uid);
											break; 
										}
									}
								}
							}
							
							if (!submitter) { 
								console.warn('âš ï¸ Could not resolve submitter for L+1 check - submitterUid:', submitterUid, 'emails checked'); 
								return false; 
							}
							
							console.log('ðŸ‘¤ Submitter found:', {
								uid: submitterUid,
								email: submitter.email,
								lineManagerId: submitter.lineManagerId,
								lineManager: submitter.lineManager,
								lineManagerName: submitter.lineManagerName
							});
							
							// Determine submitter's line manager UID
							let managerUid = submitter.lineManagerId || null;
							console.log('ðŸ” Line manager ID from lineManagerId:', managerUid);
							
							if (!managerUid) {
								const lmRaw = submitter.lineManager || submitter.lineManagerName || '';
								console.log('ðŸ” Trying line manager name/fallback:', lmRaw);
								
								if (lmRaw) {
									// If lmRaw directly matches a UID in companyUsers, use it
									if (companyUsers[lmRaw]) {
										managerUid = lmRaw;
										console.log('âœ… Found manager by direct UID match:', managerUid);
									} else {
										// Try to resolve by matching name or email
										const lmText = String(lmRaw).trim().toLowerCase();
										console.log('ðŸ” Searching for manager by name/email:', lmText);
										
										for (const uid in companyUsers) {
											const u = companyUsers[uid] || {};
											const fullName = String(u.fullName || '').toLowerCase();
											const displayName = String(u.displayName || '').toLowerCase();
											const name = String(u.name || '').toLowerCase();
											const email = String(u.email || '').toLowerCase();
											
											if (lmText && (fullName === lmText || displayName === lmText || name === lmText || email === lmText)) {
												managerUid = uid; 
												console.log('âœ… Found manager by name/email match:', uid, 'matched:', lmText);
												break;
											}
										}
										
										if (!managerUid) {
											console.log('âŒ Could not resolve manager name/email:', lmText);
										}
									}
								}
							}
							
							if (!managerUid) { 
								console.warn('âš ï¸ No line manager found for submitter (L+1) - submitter:', submitterUid, 'lineManagerId:', submitter.lineManagerId, 'lineManager:', submitter.lineManager); 
								return false; 
							}
							
							const isLineManager = currentUser.uid === managerUid;
							console.log(`ðŸ“Š L+1 FINAL CHECK - Submitter: ${submitterUid}, Manager UID: ${managerUid}, Current User: ${currentUser.uid}, Is Line Manager: ${isLineManager}`);
							return isLineManager; // Strict: only the direct line manager can approve
						}
						// For other level tokens (e.g., L+2), no generic fallback implemented yet
						console.warn(`âš ï¸ Level token '${approverValue}' not explicitly handled; denying by default.`);
						return false;
					} catch (e) {
						console.error('âŒ Level-based permission check failed:', e);
						return false;
					}
				
				default:
					console.log(`â“ Unknown approver type: ${approverType}`);
					return false;
			}
		}
		canDelete(rec) {
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) return false;
			
			// Check if user is the submitter or has admin permissions
			if (rec.userId === currentUser.uid) return true;
			
			const role = (currentUser.role || '').toLowerCase();
			if (['admin', 'superadmin', 'company_admin'].some(r => role.includes(r))) {
				return true;
			}
			
			return false;
		}
		editAccessRequest(id) {
			location.href = `access.html?id=${id}`;
		}
		deleteAccessRequest(id) {
			if (!confirm('Are you sure you want to delete this access request? This action cannot be undone.')) {
				return;
			}
			
			const currentUser = window.authManager?.currentUser;
			if (!currentUser?.companyId) {
				alert('No company context available');
				return;
			}
			
			// Delete from Firebase
			firebase.database().ref(`companies/${currentUser.companyId}/access/${id}`).remove()
				.then(async () => {
					await window.notificationManager?.createNotification(currentUser.uid, {
						title: 'Access Request Deleted',
						message: 'Access request deleted successfully',
						type: 'info'
					});
					
					// Close modal and refresh data
					this.modal.root.classList.add('hidden');
					this.modal.root.setAttribute('aria-hidden', 'true');
					document.body.style.overflow = '';
				})
				.catch(error => {
					console.error('Error deleting access request:', error);
					alert('Failed to delete access request');
				});
		}
		async approveAccessRequest(id) {
				console.log('ðŸŽ¯ approveAccessRequest invoked (button click) with ID:', id, 'this.accessRequests length:', (this.accessRequests||[]).length, 'allRequests length:', (this.allRequests||[]).length);
			
			const reason = prompt('Enter approval comments (optional):') || '';
			console.log('ðŸ“ Approval reason:', reason);
			
			// Get the current access request to check approval flow (fallback to allRequests)
			const rec = (this.accessRequests||[]).find(req => req.id === id) || (this.allRequests||[]).find(r=>r.id===id);
			if (!rec) {
				console.error('Access request not found for approval');
				alert('Access request not found');
				return;
			}
			
			console.log('ðŸ“‹ Found access request:', rec);
			
			try {
				// Add approval to history
				const currentUser = firebase.auth().currentUser;
				if (!currentUser) {
					console.error('No current user found');
					alert('No user session found. Please log in again.');
					return;
				}
				
				console.log('ðŸ‘¤ Current user:', currentUser.email);

					// Determine current approval level correctly (pass id, not object)
					let currentLevel = 1;
					try {
						currentLevel = await this.getCurrentApprovalLevel(id);
						console.log('ðŸ“Š Computed current approval level:', currentLevel);
					} catch(levelErr) {
						console.warn('âš ï¸ Could not compute current approval level, defaulting to 1:', levelErr.message);
					}
				
				const approvalEntry = {
					approverId: currentUser.uid,
					approverName: currentUser.displayName || currentUser.email,
					status: 'approved',
					timestamp: new Date().toISOString(),
					comments: reason,
						level: currentLevel,
						approvalLevel: currentLevel
				};
				
				console.log('ðŸ“ Created approval entry:', approvalEntry);
				
				// Update approval history
				const updatedHistory = [...(rec.approvalHistory || []), approvalEntry];
				console.log('ðŸ“Š Updated history:', updatedHistory);
				
					// Check if all approval levels are complete (provide companyId & history in updateData shape)
					const companyId = window.authManager?.currentUser?.companyId;
					const isComplete = await this.checkIfApprovalComplete(rec, { approvalHistory: updatedHistory }, companyId);
					const finalStatus = isComplete ? 'approved' : 'pending_approval';
				
				console.log(`ðŸŽ¯ Approval Status: ${finalStatus}, Complete: ${isComplete}`);
				
				// Update the request with new approval and status
				this.updateAccessRequestStatus(id, finalStatus, reason, updatedHistory);
				// Emit notifications (requester and approver)
				try{
				  const requesterUid = rec.userId;
				  const refNum = rec.referenceNumber || rec.id;
				  if(requesterUid){
				    await window.notificationManager?.createNotification(requesterUid, {
				      title: finalStatus==='approved'? 'Access Request Approved' : 'Approval Progress',
				      message: finalStatus==='approved'? `Your access request ${refNum} was fully approved.` : `Your access request ${refNum} advanced in approval.`,
				      type: finalStatus==='approved'? 'success':'info',
				      relatedData: { requestId: rec.id, status: finalStatus },
				      link: `access.html?id=${rec.id}`
				    });
				  }
				  const approverUid = firebase.auth().currentUser?.uid;
				  if(approverUid){
				    await window.notificationManager?.createNotification(approverUid, {
				      title: 'Approval Recorded',
				      message: `You approved access request ${refNum}.`,
				      type: 'success',
				      relatedData: { requestId: rec.id, status: finalStatus },
				      link: `access.html?id=${rec.id}`
				    });
				  }
				}catch(_e){}
				
			} catch (error) {
				console.error('Error processing approval:', error);
				alert('Failed to process approval: ' + error.message);
			}
		}
		async declineAccessRequest(id) {
			console.log('âŒ declineAccessRequest called with ID:', id);
			
			const reason = prompt('Enter decline reason:');
			if (!reason || reason.trim() === '') {
				alert('Decline reason is required');
				return;
			}
			
			console.log('ðŸ“ Decline reason:', reason);
			
			try {
				// Build rejection history so UI updates instantly
				const rec = (this.accessRequests||this.allRequests||[]).find(r => r.id === id);
				let currentLevel = 1;
				try { currentLevel = await this.getCurrentApprovalLevel(id); } catch(e) { console.warn('âš ï¸ getCurrentApprovalLevel failed for rejection, defaulting to 1'); }
				const curUser = firebase.auth().currentUser;
				const rejectionEntry = {
					approverId: curUser?.uid,
					approverName: curUser?.displayName || curUser?.email,
					status: 'rejected',
					timestamp: new Date().toISOString(),
					reason: reason,
					comments: reason,
					level: currentLevel,
					approvalLevel: currentLevel
				};
				const updatedHistory = [...(rec?.approvalHistory || []), rejectionEntry];
				this.updateAccessRequestStatus(id, 'rejected', reason, updatedHistory);

				// Emit notifications for decline
				try{
				  const requesterUid = rec?.userId;
				  const refNum = rec?.referenceNumber || id;
				  if(requesterUid){
				    await window.notificationManager?.createNotification(requesterUid, {
				      title: 'Access Request Declined',
				      message: `Your access request ${refNum} was declined. Reason: ${reason}`,
				      type: 'warning',
				      relatedData: { requestId: id, status: 'rejected' },
				      link: `access.html?id=${id}`
				    });
				  }
				  const approverUid = firebase.auth().currentUser?.uid;
				  if(approverUid){
				    await window.notificationManager?.createNotification(approverUid, {
				      title: 'Decline Recorded',
				      message: `You declined access request ${refNum}.`,
				      type: 'info',
				      relatedData: { requestId: id, status: 'rejected' },
				      link: `access.html?id=${id}`
				    });
				  }
				}catch(_e){}
			} catch (error) {
				console.error('Error processing decline:', error);
				alert('Failed to process decline: ' + error.message);
			}
		}
		updateAccessRequestStatus(id, status, reason, providedHistory = null) {
			console.log('ðŸ”„ updateAccessRequestStatus called:', { id, status, reason, hasProvidedHistory: !!providedHistory });
			
			const currentUser = window.authManager?.currentUser;
			if (!currentUser?.companyId) {
				console.error('No company context available');
				alert('No company context available');
				return;
			}
			
			console.log('ðŸ¢ Company ID:', currentUser.companyId);
			console.log('ðŸ‘¤ Current user:', currentUser.email);
			
			const timestamp = new Date().toISOString();
			const updateData = {
				status: status,
				[status === 'approved' ? 'approvedAt' : 'rejectedAt']: timestamp,
				[status === 'approved' ? 'approvedBy' : 'rejectedBy']: currentUser.uid,
				[status === 'approved' ? 'approvalComments' : 'rejectionReason']: reason
			};
			
			console.log('ðŸ“Š Update data prepared:', updateData);
			
			// Use provided history if available (from approveAccessRequest), otherwise create new entry
			if (providedHistory) {
				console.log('ðŸ“ Using provided history');
				updateData.approvalHistory = providedHistory;
				
				// Set final status directly for approved requests
				if (status === 'approved') {
					updateData.finalApprovedAt = timestamp;
					updateData.finalApprovedBy = currentUser.uid;
					console.log('ðŸŽ‰ All approval levels completed - request fully approved');
				}
				
				// Update in Firebase
				const firebasePath = `companies/${currentUser.companyId}/access/${id}`;
				console.log('ðŸ”¥ Firebase update path:', firebasePath);
				
				const accessRef = firebase.database().ref(firebasePath);
				accessRef.update(updateData).then(() => {
					console.log('âœ… Firebase update successful');
					console.log(`âœ… Access request ${status === 'approved' ? 'approved' : 'declined'} successfully`);
					// Update local record to reflect new state immediately
					const localRec = (this.accessRequests||this.allRequests||[]).find(r => r.id === id);
					if (localRec) {
						localRec.status = updateData.status;
						localRec.approvalHistory = updateData.approvalHistory;
						this.loadApprovalFlowAsync(localRec);
						this.updateModalActionButtons(localRec);
					}
					this.loadAccessRequests();
				}).catch(error => {
					console.error(`Error ${status === 'approved' ? 'approving' : 'declining'} access request:`, error);
					alert(`Failed to ${status === 'approved' ? 'approve' : 'decline'} access request: ${error.message}`);
				});
			} else {
				// Legacy path for rejection and simple approvals
				this.getCurrentApprovalLevel(id).then(approvalLevel => {
					// Add to approval history with level information
					const historyEntry = {
						status: status,
						timestamp: timestamp,
						approverName: currentUser.name || currentUser.email,
						approverId: currentUser.uid,
						comments: reason,
						level: approvalLevel,
						approvalLevel: approvalLevel
					};
					
					console.log(`ðŸ“ Recording ${status} at level ${approvalLevel}:`, historyEntry);
					
					// Update in Firebase
					const accessRef = firebase.database().ref(`companies/${currentUser.companyId}/access/${id}`);
					accessRef.once('value').then(snapshot => {
						const currentData = snapshot.val() || {};
						const approvalHistory = currentData.approvalHistory || [];
						approvalHistory.push(historyEntry);
						
						updateData.approvalHistory = approvalHistory;
						
						// Check if this completes the approval process
						return this.checkIfApprovalComplete(currentData, updateData, currentUser.companyId).then(isComplete => {
							if (isComplete && status === 'approved') {
								updateData.status = 'approved';
								updateData.finalApprovedAt = timestamp;
								updateData.finalApprovedBy = currentUser.uid;
								console.log('ðŸŽ‰ All approval levels completed - request fully approved');
							} else if (status === 'approved') {
								updateData.status = 'pending_approval';
								console.log('â³ Partial approval completed - waiting for remaining levels');
							}
							
							return accessRef.update(updateData);
						});
					}).then(() => {
						console.log(`âœ… Access request ${status === 'approved' ? 'approved' : 'declined'} successfully`);
						const localRec = (this.accessRequests||this.allRequests||[]).find(r => r.id === id);
						if (localRec) {
							localRec.status = updateData.status;
							localRec.approvalHistory = updateData.approvalHistory;
							this.loadApprovalFlowAsync(localRec);
							this.updateModalActionButtons(localRec);
						}
					}).catch(error => {
						console.error(`Error ${status === 'approved' ? 'approving' : 'declining'} access request:`, error);
						alert(`Failed to ${status === 'approved' ? 'approve' : 'decline'} access request`);
					});
				}).catch(error => {
					console.error('Error determining approval level:', error);
					alert('Failed to determine approval level');
				});
			}
		}
		
		// Get the approval level that the current user should approve at
		async getCurrentApprovalLevel(requestId) {
			const currentUser = window.authManager?.currentUser;
			if (!currentUser) throw new Error('No current user');
			
			// Get the request data
			const rec = this.allRequests.find(r => r.id === requestId);
			if (!rec) throw new Error('Request not found');
			
			// Get approval flow configuration
			const approvalFlowRef = firebase.database().ref(`companies/${currentUser.companyId}/approvalFlows/access`);
			const snapshot = await approvalFlowRef.once('value');
			const approvalConfig = snapshot.val();
			
			if (!approvalConfig || !approvalConfig.enabled) {
				throw new Error('No approval configuration found');
			}
			
			const levels = approvalConfig.levels || [];
			
			// Find which level the current user can approve at
			for (const level of levels) {
				const canApproveAtLevel = await this.checkApprovalPermissionForLevel(level, currentUser, rec);
				if (canApproveAtLevel) {
					// For sequential approval, make sure this is the correct level
					if (approvalConfig.approvalOrder === 'sequential') {
						const canApproveSequentially = await this.canApproveAtLevelSequentially(level, levels, rec.approvalHistory || [], rec);
						if (canApproveSequentially) {
							return level.level || 1;
						}
					} else {
						// For parallel approval, return the level if not already approved
						const hasBeenApproved = this.hasLevelBeenApproved(level.level, rec.approvalHistory || []);
						if (!hasBeenApproved) {
							return level.level || 1;
						}
					}
				}
			}
			
			throw new Error('User cannot approve at any level');
		}
		
		// Check if all required approval levels have been completed
		async checkIfApprovalComplete(currentData, updateData, companyId) {
			try {
				// Get approval flow configuration
				const approvalFlowRef = firebase.database().ref(`companies/${companyId}/approvalFlows/access`);
				const snapshot = await approvalFlowRef.once('value');
				const approvalConfig = snapshot.val();
				
				if (!approvalConfig || !approvalConfig.enabled) {
					return true; // If no config, consider complete
				}
				
				const levels = approvalConfig.levels || [];
				const approvalHistory = updateData.approvalHistory || [];
				
				// Check if all levels have been approved
				for (const level of levels) {
					const hasBeenApproved = this.hasLevelBeenApproved(level.level, approvalHistory);
					if (!hasBeenApproved) {
						console.log(`â³ Level ${level.level} not yet approved`);
						return false;
					}
				}
				
				console.log('âœ… All approval levels completed');
				return true;
				
			} catch (error) {
				console.error('Error checking approval completion:', error);
				return true; // Default to complete on error
			}
		}
		
		exportAccessRequest(id) {
			console.log('ðŸ”¥ PDF Export clicked for ID:', id);
			const rec = this.allRequests.find(r => r.id === id);
			if (!rec) {
				console.error('âŒ Record not found for PDF export:', id);
				alert('Record not found');
				return;
			}
			console.log('ðŸ“‹ Record found for PDF:', rec);
			
			// Capture context for helper methods
			const self = this;
			
			// Load jsPDF dynamically if not present
			const generatePdf = async () => {
				try {
					// Ensure company users are loaded and requester employee code is resolved
					try { await this.ensureCompanyUsersLoaded(); await this.getRequesterEmployeeId(rec); } catch(_e) {}
					console.log('ðŸ“„ Starting PDF generation...');
					const doc = new window.jspdf.jsPDF({ unit: 'pt', format: 'a4' });
					const lineHeight = 14;
					let y = 40;
					const left = 40;
					const maxWidth = 515;
					const pageBottom = 780;

					// Try to embed company logo (from header branding)
					const getHeaderLogoSrc = () => { const el = document.getElementById('headerCompanyLogo'); return (el && el.src) ? el.src : ''; };
					const fetchAsDataURL = async (src) => { if(!src) return null; if(src.startsWith('data:')) return src; const res = await fetch(src, {mode:'cors', credentials:'omit'}); if(!res.ok) return null; const blob = await res.blob(); return await new Promise((resolve)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.readAsDataURL(blob); }); };
					const rasterizeSvgIfNeeded = async (dataUrl) => { if(!dataUrl || !dataUrl.startsWith('data:image/svg')) return dataUrl; return await new Promise(resolve=>{ const img=new Image(); img.onload=()=>{ try{ const size=52; const c=document.createElement('canvas'); c.width=size; c.height=size; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,size,size); resolve(c.toDataURL('image/png')); }catch(e){ resolve(dataUrl); } }; img.onerror=()=>resolve(dataUrl); img.src=dataUrl; }); };
					try{
						let logoSrc = getHeaderLogoSrc();
						if(logoSrc){
							let dataUrl = await fetchAsDataURL(logoSrc);
							dataUrl = await rasterizeSvgIfNeeded(dataUrl);
							if(dataUrl){
								const typeHeader = dataUrl.substring(5, dataUrl.indexOf(';')) || 'image/png';
								const imgType = /png/i.test(typeHeader)? 'PNG' : 'JPEG';
								doc.addImage(dataUrl, imgType, left, y-10, 48, 48);
							}
						}
					}catch(e){ console.warn('Logo embed skipped:', e); }
					
					// Helper to format dates safely
					const formatDate = (dateStr) => {
						if (!dateStr) return '';
						try {
							return self.fmtDate ? self.fmtDate(dateStr) : new Date(dateStr).toLocaleDateString();
						} catch (e) {
							return String(dateStr);
						}
					};
					
					// Helper to format file sizes safely
					const formatSize = (bytes) => {
						if (!bytes) return '';
						try {
							return self.humanSize ? self.humanSize(bytes) : `${bytes} bytes`;
						} catch (e) {
							return String(bytes);
						}
					};
					
					// Add a line of text with safe option normalization and coordinate guards
					const addLine = (text, opts) => {
						// Normalize options: support being called with undefined/null or wrong types
						const o = (opts && typeof opts === 'object') ? opts : {};
						const isBold = !!o.bold;
						const gap = Number.isFinite(o.gap) ? Number(o.gap) : 0;
						// Ensure y is always a finite number
						if (!Number.isFinite(y)) { y = 40; }
						doc.setFont('helvetica', isBold ? 'bold' : 'normal');
						const lines = doc.splitTextToSize(String(text ?? ''), maxWidth);
						lines.forEach(l => {
							if (y > pageBottom) { doc.addPage(); y = 40; }
							// Guard coordinates before drawing
							const yy = Number.isFinite(y) ? y : 40;
							doc.text(String(l), left, yy);
							y = yy + lineHeight;
						});
						// Advance by gap if valid
						if (gap) {
							y += gap;
						}
					};
					const addSection = (title) => {
						if (y > pageBottom) { doc.addPage(); y = 40; }
						if (!Number.isFinite(y)) { y = 40; }
						doc.setFontSize(11);
						doc.setFont('helvetica','bold');
						doc.text(String(title ?? ''), left, y);
						y += lineHeight;
						doc.setFontSize(10);
						doc.setDrawColor(200);
						doc.line(left, y-8, left+515, y-8);
						y += 2;
					};
					
					// Header
					doc.setFontSize(16); doc.setFont('helvetica','bold'); doc.text('Gate Pass Request Report', left + 58, y + 10); y+= lineHeight*1.5; doc.setFontSize(10);
					addLine(`Generated: ${new Date().toLocaleString()}`); y += 4;
					doc.setDrawColor(60); doc.line(left, y, left+515, y); y += lineHeight;
					
					// Core details
					addSection('Basic Details');
					addLine(`Reference: ${rec.referenceNumber || rec.id}`, {bold:true});
					addLine(`Requester: ${rec.requesterName || ''}`);
					addLine(`Employee ID: ${rec._displayEmployeeId || rec.employeeId || rec.requesterEmployeeId || ''}`);
					addLine(`Department: ${rec.departmentName || ''}`);
					addLine(`Company: ${rec.companyName || ''}`);
					addLine(`Contact Phone: ${rec.contactPhone || ''}`);
					addLine(`Status: ${(rec.status || '').toUpperCase()}`);
					addLine(`Created: ${formatDate(rec.createdAt)}`);
					addLine(`Updated: ${formatDate(rec.updatedAt)}`);
					addLine(`Area: ${rec.area || ''}`);
					addLine(`Start: ${formatDate(rec.startDateTime)}`);
					addLine(`End: ${formatDate(rec.endDateTime)}`);
					
					// New fields
					const toBeRetDisp = (rec.toBeReturned===true||String(rec.toBeReturned).toLowerCase()==='yes')?'Yes':((rec.toBeReturned===false||String(rec.toBeReturned).toLowerCase()==='no')?'No':''); 
					addLine(`Property Removal: ${rec.propertyRemoval || ''}`);
					addLine(`To be Returned: ${toBeRetDisp}`);
					
					// Purpose
					addSection('Purpose');
					addLine((rec.purpose || rec.reason || 'None'), {gap: lineHeight/2});
					
					// People
					if (Array.isArray(rec.visitors) && rec.visitors.length){
						addSection('People');
						rec.visitors.forEach((v,i)=>{
							const area = v.area || '';
							const vStart = formatDate(v.startDateTime || v.startDate || v.start);
							const vEnd = formatDate(v.endDateTime || v.endDate || v.end) || '-';
							addLine(`${i+1}. ${v.name||''}` , {bold:true});
							addLine(`   ID: ${v.identification||v.idNumber||v.visitorId||v.id||''}`);
							addLine(`   Company: ${v.company||''}`);
							addLine(`   Area: ${area}`);
							addLine(`   Start: ${vStart}`);
							addLine(`   End: ${vEnd}`);
							// attachments per person
							const vatts = Array.isArray(v.attachments)? v.attachments : (v.attachment? [v.attachment]: []);
							if (vatts.length){
								addLine('   Files:', {bold:true});
								vatts.forEach(a=> addLine(`      - ${a.name || 'file'}${a.size? ` (${formatSize(typeof a.size==='number'?a.size:parseInt(a.size)||0)})`:''}`));
							}
							y += 2;
						});
					}
					
					// Equipment
					if (Array.isArray(rec.equipment) && rec.equipment.length){
						addSection('Equipment');
						rec.equipment.forEach((e,i)=> addLine(`${i+1}. ${e.name||e.item||''}${e.description? ' - '+e.description: ''}`));
					}
					
					// General Attachments
					if (Array.isArray(rec.generalAttachments) && rec.generalAttachments.length){
						addSection('General Attachments');
						rec.generalAttachments.forEach((a,i)=> addLine(`${i+1}. ${a.name || 'file'}${a.size? ` (${formatSize(typeof a.size==='number'?a.size:parseInt(a.size)||0)})`:''}`));
					}
					
					// Approval History
					if (Array.isArray(rec.approvalHistory) && rec.approvalHistory.length){
						addSection('Approval History');
						rec.approvalHistory.forEach((h,i)=>{
							addLine(`${i+1}. Level ${h.level||h.approvalLevel||'?'} - ${(h.status||'').toUpperCase()} by ${h.approverName||'Unknown'} @ ${formatDate(h.timestamp||h.approvedAt||h.rejectedAt)}${h.comments? ' | '+h.comments:''}`);
						});
					}
					
					// Footer
					if (y > pageBottom) { doc.addPage(); y=40; }
					const yFooter = Number.isFinite(y) ? y + 10 : 50;
					doc.setFontSize(8);
					doc.text('End of Report', left, yFooter);
					
					const filename = `gate_pass_${rec.referenceNumber || rec.id}.pdf`;
					console.log('ðŸ’¾ Saving PDF as:', filename);
					doc.save(filename);
					console.log('âœ… PDF generated successfully');
				} catch (error) {
					console.error('âŒ Error generating PDF:', error);
					alert('Error generating PDF: ' + error.message);
				}
			};
			
			if (!window.jspdf) {
				console.log('ðŸ“¦ Loading jsPDF library...');
				const script = document.createElement('script');
				script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
				script.onload = () => { 
					console.log('âœ… jsPDF loaded successfully');
					generatePdf(); 
				};
				script.onerror = () => { 
					console.error('âŒ Failed to load jsPDF library');
					alert('Failed to load PDF library'); 
				};
				document.head.appendChild(script);
			} else {
				console.log('âœ… jsPDF already loaded');
				generatePdf();
			}
		}
		escape(str){ if(str===undefined||str===null) return ''; return String(str).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','"':'&quot;','\'':'&#39;'}[c]||c)); }
		humanSize(bytes){ if(typeof bytes!=='number') return ''; if(bytes<1024) return bytes+' B'; if(bytes<1024*1024) return (bytes/1024).toFixed(1)+' KB'; return (bytes/1024/1024).toFixed(2)+' MB'; }
	}
	document.addEventListener('DOMContentLoaded',()=>{ window.accessBoardManager=new AccessBoardManager(); });
	</script>
</body>
</html>
